<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Rasfahi Judge System (Pro V3 Ultimate - Auto Gen)</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL THEME --- */
        :root {
            --gold: #D4AF37;
            --dark: #050505;
            --panel: #111;
            --border: #333;
            --text: #e0e0e0;
            --highlight: #002244;
        }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: 'Noto Sans Thaana', 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        * { box-sizing: border-box; outline: none; user-select: none; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 420px; background: var(--panel); border-left: 3px solid var(--gold); 
            display: flex; flex-direction: column; padding: 10px; overflow-y: auto; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.5); z-index: 10;
        }
        .panel-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 12px; margin-bottom: 12px; border-radius: 6px; }
        
        h2 { color: var(--gold); font-size: 15px; margin: 0 0 10px 0; border-bottom: 1px dashed #444; padding-bottom: 5px; }
        label { display: block; color: #aaa; font-size: 11px; margin-top: 8px; margin-bottom: 2px; }
        
        input, select, button { width: 100%; padding: 8px; margin-bottom: 5px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 13px; }
        button { cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        button:hover { border-color: var(--gold); background: #333; }
        
        .btn-green { background: #004d00; border-color: #006400; }
        .btn-blue { background: #00264d; border-color: #004080; }
        .btn-red { background: #4d0000; border-color: #800000; }
        .btn-gold { background: linear-gradient(to bottom, #D4AF37, #8a6e15); color: #000; }

        /* --- MAIN VIEW --- */
        .main-view { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .top-header { 
            height: 60px; background: #0b1016; border-bottom: 1px solid var(--gold); 
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .status-badge { background: #222; padding: 5px 15px; border: 1px solid var(--gold); color: var(--gold); border-radius: 20px; font-weight: bold; }

        /* GRID STYLES */
        #gridContainer { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 40px; 
            max-width: 900px; margin: 0 auto; width: 100%; overflow-y: auto;
        }
        .grid-box { 
            aspect-ratio: 1.2; background: #1a1a1a; border: 2px solid #333; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 24px; font-weight: bold; cursor: pointer; color: #555;
            transition: all 0.2s; border-radius: 8px;
        }
        .grid-box:hover { border-color: var(--gold); color: #fff; background: #222; transform: scale(1.05); }
        .grid-box.taken { background: #220000; border-color: #500; color: #500; pointer-events: none; }
        .grid-box.selected { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        /* PREVIEW AREA */
        #previewArea { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #previewImg { max-height: 70vh; max-width: 90%; border: 5px solid #333; box-shadow: 0 0 30px #000; display:none; }
        #previewText { 
            display:none; color: #fff; font-family: 'Amiri', serif; font-size: 40px; line-height: 1.8; 
            max-width: 80%; padding: 20px; border: 2px solid var(--gold); background: rgba(0,0,0,0.5); 
            border-radius: 10px; text-shadow: 0 2px 4px #000; direction: rtl;
        }
        #qDetails { margin-top: 15px; font-size: 18px; color: #aaa; }

        /* TABS within Sidebar */
        .tab-content { display: none; padding: 10px; border: 1px solid #333; background: #1a1a1a; margin-top: 5px; }
        .tab-content.active { display: block; }
        .tab-btn { background: #333; color: #aaa; border: none; padding: 5px; width: auto; font-size: 11px; margin-right: 2px; }
        .tab-btn.active { background: var(--gold); color: #000; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="text-align:center; padding:10px; border-bottom:2px solid var(--gold); margin-bottom:10px;">
        <h1 style="color:var(--gold); margin:0; font-size:20px;">RASFAHI JUDGE PRO</h1>
        <small style="color:#aaa;">V3 Ultimate + Auto Generator</small>
    </div>

    <div class="panel-box">
        <h2>1. ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ (Database Setup)</h2>
        
        <label style="color:var(--gold);">‚òÖ Question Mode:</label>
        <select id="qMode" onchange="toggleMode()">
            <option value="image">Image Mode (ﬁäﬁÆﬁìﬁØ ﬁêﬁ™ﬁàﬁßﬁçﬁ™)</option>
            <option value="text">Text Mode (ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™)</option>
        </select>

        <hr style="border-color:#333; margin:8px 0;">

        <div id="imgInputs">
            <label>1. Questions CSV (For Images):</label>
            <input type="file" id="csvFileImg" accept=".csv" onchange="loadCSV(this, 'image')">
            <label>2. Images Folder:</label>
            <input type="file" id="imgFolder" webkitdirectory directory multiple onchange="loadImages(this)">
        </div>

        <div id="textInputs" style="display:none;">
            <div style="margin-bottom: 10px;">
                <button class="tab-btn active" onclick="switchTextTab('auto')">Auto-Gen (Quran File)</button>
                <button class="tab-btn" onclick="switchTextTab('manual')">Manual CSV</button>
            </div>

            <div id="tab-auto" class="tab-content active">
                <label style="color:#81c784;">1. Quran Text File (quran-uthmani.txt):</label>
                <input type="file" id="quranRawFile" accept=".txt">
                
                <div style="display:flex; gap:5px;">
                    <div style="flex:1">
                        <label>Min Verses:</label>
                        <input type="number" id="genMin" value="5">
                    </div>
                    <div style="flex:1">
                        <label>Max Verses:</label>
                        <input type="number" id="genMax" value="8">
                    </div>
                </div>
                <label>Total Questions to Generate:</label>
                <input type="number" id="genTotal" value="2500">
                
                <button class="btn-gold" onclick="processQuranRawFile()">‚ö° Generate & Load</button>
            </div>

            <div id="tab-manual" class="tab-content">
                <label>Upload Pre-made CSV:</label>
                <input type="file" id="csvFileText" accept=".csv" onchange="loadCSV(this, 'text')">
                <small style="color:#888;">Format: ID, ArabicText, Surah, Ayah, Branch, Group</small>
            </div>
        </div>

        <div id="dbStatus" style="font-size:11px; color:#00e676; margin-top:5px;">System Idle.</div>
    </div>

    <div class="panel-box">
        <h2>2. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ & ﬁêﬁ®ﬁçﬁ¶ﬁÑﬁ¶ﬁêﬁ∞ (Selection)</h2>
        
        <label>Student Name (ﬁÇﬁ¶ﬁÇﬁ∞):</label>
        <input type="text" id="stdName" placeholder="ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞">
        
        <div style="display:flex; gap:5px;">
            <div style="flex:1">
                <label>Branch (ﬁéﬁÆﬁäﬁ®):</label>
                <select id="stdBranch" onchange="filterQuestions()">
                    <option value="All">All Branches</option>
                    <option value="Balaiygen">ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞</option>
                    <option value="Nubalai">ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®</option>
                    <option value="Hifz">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ™</option>
                </select>
            </div>
            <div style="flex:1">
                <label>Age (ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™):</label>
                <select id="stdGroup" onchange="filterQuestions()">
                    <option value="All">All Ages</option>
                    <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="Under 21">21 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                    <option value="General">ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™ (General)</option>
                </select>
            </div>
        </div>

        <div style="background:#000; padding:8px; border:1px dashed #444; margin-top:10px;">
            <label style="color:var(--gold);">‚òÖ Syllabus Scope (Range):</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="scopeStart" placeholder="Start ID" onchange="filterQuestions()">
                <input type="number" id="scopeEnd" placeholder="End ID" onchange="filterQuestions()">
            </div>
            <small style="color:#666;">Filter questions by ID number (e.g. 1 - 10)</small>
        </div>

        <button class="btn-blue" style="margin-top:10px;" onclick="startNewStudent()">üë§ Start New Student</button>
    </div>

    <div class="panel-box">
        <h2>3. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Grid)</h2>
        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:11px; margin-bottom:5px;">
            <span id="poolCount">Pool: 0</span>
            <span id="activeQCount">Selected: 0</span>
        </div>
        <button class="btn-green" onclick="shuffleGrid()">üîÑ Shuffle Grid (Apply Filters)</button>
        <button class="btn-blue" onclick="sendToScreen()">‚ñ∂ Send to Screens</button>
    </div>

    <div class="panel-box">
        <h2>4. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Windows)</h2>
        <div style="display:flex; gap:5px;">
            <button onclick="openStudentWindow()">üéì Student View</button>
            <button onclick="openJudgeWindow()">‚öñÔ∏è Judge View</button>
        </div>
        <button class="btn-red" onclick="resetAll()">‚ö†Ô∏è Reset System</button>
    </div>

    <div class="panel-box">
        <h2>5. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß (Results)</h2>
        <div id="judgeStatus" style="background:#000; padding:5px; font-size:12px; color:#aaa; border:1px solid #333; margin-bottom:5px;">
            Waiting for scores...
        </div>
        <button class="btn-green" onclick="saveFinalScore()">üíæ Save Result</button>
        <button class="btn-blue" onclick="exportResults()">üì• Export CSV</button>
    </div>
</div>

<div class="main-view">
    <div class="top-header">
        <div style="font-weight:bold; color:#fff;">LIVE MONITOR</div>
        <div id="sessionInfo" style="color:#aaa; font-size:14px;">No Active Session</div>
        <div class="status-badge" id="appStatus">IDLE</div>
    </div>

    <div id="gridContainer"></div>

    <div id="previewArea">
        <h1 id="qDetails">Question Preview</h1>
        <img id="previewImg" src="">
        <div id="previewText"></div>

        <button onclick="nextQuestion()" style="width:200px; margin-top:20px; font-size:18px;" class="btn-green">Next Question ‚è©</button>
    </div>
</div>

<script>
    // --- APP STATE ---
    const state = {
        mode: 'image', // 'image' or 'text'
        
        // Data Pools
        imagePool: [],    // Questions for Image Mode
        textPool: [],     // Questions for Text Mode
        filteredPool: [], // Currently active pool
        
        images: {},       // Blob URLs for images
        
        // Session Data
        gridMapping: {},    
        takenBoxes: [],     
        selectedQIDs: [],   
        activeQIndex: -1,   
        
        // Student Data
        student: { name: "", id: "", branch: "", group: "" },
        
        // Windows
        winStudent: null,
        winJudges: [],
        
        // Results
        liveScores: {},
        savedResults: []
    };

    // --- CONSTANTS FOR GENERATOR ---
    const suraNames = [
        "Al-Fatiha", "Al-Baqarah", "Ali 'Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
        "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha",
        "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
        "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
        "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
        "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
        "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
        "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa",
        "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
        "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat",
        "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
        "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
    ];

    // --- 1. SETUP & MODE ---
    function toggleMode() {
        state.mode = document.getElementById('qMode').value;
        const isImg = state.mode === 'image';
        
        document.getElementById('imgInputs').style.display = isImg ? 'block' : 'none';
        document.getElementById('textInputs').style.display = isImg ? 'none' : 'block';
        
        document.getElementById('dbStatus').innerText = `Switched to ${state.mode.toUpperCase()} Mode.`;
        filterQuestions(); 
    }

    function switchTextTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if (tab === 'auto') {
            document.querySelector('#textInputs button:nth-child(1)').classList.add('active');
            document.getElementById('tab-auto').classList.add('active');
        } else {
            document.querySelector('#textInputs button:nth-child(2)').classList.add('active');
            document.getElementById('tab-manual').classList.add('active');
        }
    }

    // --- CSV LOADER (Manual) ---
    function loadCSV(input, type) {
        const r = new FileReader();
        r.onload = e => {
            const rows = e.target.result.split('\n');
            const tempPool = [];
            
            rows.slice(1).forEach(row => {
                const c = row.split(',');
                if(c.length > 1) {
                    const obj = {
                        id: c[0].trim(),
                        type: type,
                        content: c[1].trim(), 
                        surah: c[2] ? c[2].trim() : "",
                        ayah: c[3] ? c[3].trim() : "",
                        branch: c[4] ? c[4].trim() : "All",
                        group: c[5] ? c[5].trim() : "All",
                        numID: parseInt(c[0].replace(/\D/g, '')) || 0
                    };
                    tempPool.push(obj);
                }
            });

            if(type === 'image') state.imagePool = tempPool;
            else state.textPool = tempPool;

            document.getElementById('dbStatus').innerText = `${type.toUpperCase()} Data Loaded: ${tempPool.length} records.`;
            filterQuestions();
        };
        r.readAsText(input.files[0]);
    }

    // --- QURAN GENERATOR (Auto) ---
    function processQuranRawFile() {
        const fileInput = document.getElementById('quranRawFile');
        if (!fileInput.files.length) {
            alert("Please select the 'quran-uthmani.txt' file first!");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            generateQuestionsFromRaw(content);
        };
        reader.readAsText(fileInput.files[0]);
    }

    function generateQuestionsFromRaw(text) {
        const lines = text.split('\n');
        const quranData = [];
        
        // Parse raw text
        lines.forEach(line => {
            const parts = line.split('|');
            if (parts.length >= 3) {
                quranData.push({
                    sura: parseInt(parts[0]),
                    ayah: parseInt(parts[1]),
                    text: parts.slice(2).join('|').trim()
                });
            }
        });

        if (quranData.length === 0) {
            alert("Invalid File Format. Ensure it is Standard Tanzil/Uthmani Text.");
            return;
        }

        const minV = parseInt(document.getElementById('genMin').value);
        const maxV = parseInt(document.getElementById('genMax').value);
        const targetCount = parseInt(document.getElementById('genTotal').value);
        
        const newPool = [];
        const totalVerses = quranData.length;

        for (let i = 0; i < targetCount; i++) {
            const qLength = Math.floor(Math.random() * (maxV - minV + 1)) + minV;
            const startIndex = Math.floor(Math.random() * (totalVerses - qLength));
            
            let passageArr = [];
            let startVerseObj = quranData[startIndex];
            let endVerseObj = quranData[startIndex + qLength - 1];

            for (let j = 0; j < qLength; j++) {
                passageArr.push(quranData[startIndex + j].text + " (" + quranData[startIndex + j].ayah + ")");
            }
            
            // Format for Rasfahi System
            newPool.push({
                id: (i + 1).toString(),
                type: 'text',
                content: passageArr.join(" "), // Full text for display
                surah: suraNames[startVerseObj.sura - 1] || "Sura " + startVerseObj.sura,
                ayah: startVerseObj.ayah + " - " + endVerseObj.ayah,
                branch: "All",
                group: "All",
                numID: i + 1
            });
        }

        state.textPool = newPool;
        document.getElementById('dbStatus').innerText = `Generated & Loaded ${newPool.length} Questions from Quran!`;
        filterQuestions();
    }

    function loadImages(input) {
        let c = 0;
        for(let f of input.files) {
            state.images[f.name.toLowerCase()] = URL.createObjectURL(f);
            c++;
        }
        document.getElementById('dbStatus').innerText += ` | Images: ${c}`;
    }

    // --- 2. FILTER & GRID LOGIC ---
    function filterQuestions() {
        const branch = document.getElementById('stdBranch').value;
        const group = document.getElementById('stdGroup').value;
        const start = parseInt(document.getElementById('scopeStart').value);
        const end = parseInt(document.getElementById('scopeEnd').value);

        // Select Source Pool
        const source = state.mode === 'image' ? state.imagePool : state.textPool;

        // Filter Logic
        state.filteredPool = source.filter(q => {
            // 1. Branch/Age Match
            const bMatch = (branch === "All") || (q.branch === branch) || (q.branch === "All");
            const gMatch = (group === "All") || (q.group === group) || (q.group === "All");
            
            // 2. Syllabus Range Match (If entered)
            let rangeMatch = true;
            if(!isNaN(start) && !isNaN(end)) {
                rangeMatch = (q.numID >= start && q.numID <= end);
            }

            return bMatch && gMatch && rangeMatch;
        });

        document.getElementById('poolCount').innerText = `Pool: ${state.filteredPool.length}`;
        shuffleGrid(); 
    }

    function shuffleGrid() {
        if(state.filteredPool.length === 0) {
            document.getElementById('gridContainer').innerHTML = "<h3 style='color:red; text-align:center;'>No questions found for this filter/range!</h3>";
            return;
        }

        state.gridMapping = {};
        state.takenBoxes = [];
        let poolCopy = [...state.filteredPool];

        // Randomly fill 20 boxes
        for(let i=1; i<=20; i++) {
            if(poolCopy.length === 0) poolCopy = [...state.filteredPool]; // Refill if ran out
            const r = Math.floor(Math.random() * poolCopy.length);
            state.gridMapping[i] = poolCopy[r];
            poolCopy.splice(r, 1);
        }

        renderGrid();
        syncWindows();
    }

    function renderGrid() {
        const c = document.getElementById('gridContainer');
        c.innerHTML = '';
        document.getElementById('gridContainer').style.display = 'grid';
        document.getElementById('previewArea').style.display = 'none';
        document.getElementById('appStatus').innerText = "SELECTION";

        for(let i=1; i<=20; i++) {
            const d = document.createElement('div');
            d.className = `grid-box ${state.takenBoxes.includes(i) ? 'taken' : ''}`;
            if(state.selectedQIDs.includes(state.gridMapping[i])) d.classList.add('selected');
            
            d.innerText = i;
            d.onclick = () => selectBox(i);
            c.appendChild(d);
        }
    }

    function selectBox(num) {
        if(state.takenBoxes.includes(num)) return;
        
        const q = state.gridMapping[num];
        state.takenBoxes.push(num);
        state.selectedQIDs.push(q);
        
        document.getElementById('activeQCount').innerText = `Selected: ${state.selectedQIDs.length}`;
        renderGrid();
        syncWindows();
    }

    // --- 3. SESSION MANAGEMENT ---
    function startNewStudent() {
        state.student = {
            name: document.getElementById('stdName').value,
            id: "",
            branch: document.getElementById('stdBranch').value,
            group: document.getElementById('stdGroup').value
        };
        
        if(!state.student.name) return alert("Enter Student Name!");

        state.selectedQIDs = [];
        state.activeQIndex = -1;
        state.liveScores = {};
        state.takenBoxes = [];
        
        document.getElementById('sessionInfo').innerText = `${state.student.name} | ${state.mode.toUpperCase()} MODE`;
        document.getElementById('judgeStatus').innerText = "Waiting for scores...";
        
        filterQuestions(); // Reshuffle with current settings
        syncWindows();
    }

    function sendToScreen() {
        if(state.selectedQIDs.length === 0) return alert("No questions selected!");
        state.activeQIndex = 0;
        updateView();
        syncWindows();
    }

    function nextQuestion() {
        if(state.activeQIndex < state.selectedQIDs.length - 1) {
            state.activeQIndex++;
            updateView();
            syncWindows();
        } else {
            alert("All questions finished!");
            document.getElementById('appStatus').innerText = "FINISHED";
            syncWindows();
        }
    }

    function updateView() {
        document.getElementById('gridContainer').style.display = 'none';
        document.getElementById('previewArea').style.display = 'flex';
        document.getElementById('appStatus').innerText = "READING";

        const q = state.selectedQIDs[state.activeQIndex];
        const pImg = document.getElementById('previewImg');
        const pTxt = document.getElementById('previewText');

        if(q.type === 'image') {
            pImg.style.display = 'block';
            pTxt.style.display = 'none';
            pImg.src = state.images[q.content.toLowerCase()] || "";
        } else {
            pImg.style.display = 'none';
            pTxt.style.display = 'block';
            pTxt.innerHTML = q.content; // Arabic Text
        }
        
        document.getElementById('qDetails').innerText = `Surah: ${q.surah} | Ayah: ${q.ayah}`;
    }

    // --- 4. JUDGING & RESULTS ---
    window.submitJudgeScore = function(jID, score) {
        state.liveScores[jID] = score;
        updateScoreBoard();
    }

    function updateScoreBoard() {
        let txt = "";
        let total = 0, c = 0;
        for(let j in state.liveScores) {
            txt += `${j}: ${state.liveScores[j]} | `;
            total += parseFloat(state.liveScores[j]);
            c++;
        }
        const avg = c > 0 ? (total/c).toFixed(2) : 0;
        document.getElementById('judgeStatus').innerHTML = `<span style="color:#00e676; font-size:14px;">${txt} AVG: ${avg}</span>`;
    }

    function saveFinalScore() {
        let total = 0, c = 0;
        for(let j in state.liveScores) { total += parseFloat(state.liveScores[j]); c++; }
        const avg = c > 0 ? (total/c).toFixed(2) : 0;

        state.savedResults.push({
            ...state.student,
            final: avg,
            mode: state.mode,
            details: {...state.liveScores}
        });
        alert(`Saved! Score: ${avg}`);
    }

    function exportResults() {
        let csv = "Name,ID,Branch,Group,Mode,FinalScore\n";
        state.savedResults.forEach(r => {
            csv += `"${r.name}","${r.id}","${r.branch}","${r.group}","${r.mode}","${r.final}"\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Rasfahi_Ultimate_Results.csv";
        a.click();
    }
    
    function resetAll() {
        if(confirm("Reset System?")) location.reload();
    }

    // --- 5. WINDOW SYNCING ---
    function syncWindows() {
        const q = (state.activeQIndex > -1) ? state.selectedQIDs[state.activeQIndex] : null;
        let displayContent = null;
        
        // Prepare content based on mode
        if(q) {
            if(q.type === 'image') displayContent = state.images[q.content.toLowerCase()];
            else displayContent = q.content; // Text
        }

        const packet = {
            student: state.student,
            phase: document.getElementById('appStatus').innerText, 
            boxes: state.takenBoxes,
            activeQ: q,
            contentType: q ? q.type : null,
            content: displayContent
        };

        if(state.winStudent && !state.winStudent.closed) state.winStudent.update(packet);
        state.winJudges.forEach(w => { if(w && !w.closed) w.update(packet); });
    }

    // --- TEMPLATES ---
    
    // 1. STUDENT SCREEN
    function openStudentWindow() {
        const w = window.open("", "Student", "width=1280,height=720");
        w.document.write(`
            <html><head><title>Student Screen</title>
            <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap" rel="stylesheet">
            <style>
                body { background:#000; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; margin:0; }
                .grid { display:grid; grid-template-columns:repeat(5,1fr); gap:15px; width:80%; }
                .box { background:#111; border:2px solid #333; height:120px; color:#444; display:flex; justify-content:center; align-items:center; font-size:40px; border-radius:10px; }
                .box.taken { opacity:0.1; }
                
                #qImage { max-height:95vh; max-width:95vw; border:5px solid #D4AF37; display:none; }
                #qText { 
                    display:none; color:#fff; font-family:'Amiri', serif; font-size:60px; 
                    line-height:2; text-align:center; max-width:90%; 
                    text-shadow: 0 0 10px rgba(255,255,255,0.3); direction:rtl; 
                }
            </style></head><body>
                
                <div id="grid" class="grid"></div>
                <img id="qImage">
                <div id="qText"></div>

                <script>
                    const g = document.getElementById('grid');
                    for(let i=1; i<=20; i++) {
                        let b = document.createElement('div'); b.className='box'; b.id='b'+i; b.innerText=i; g.appendChild(b);
                    }

                    window.update = function(d) {
                        const imgEl = document.getElementById('qImage');
                        const txtEl = document.getElementById('qText');
                        const gridEl = document.getElementById('grid');

                        if(d.phase === 'SELECTION') {
                            imgEl.style.display = 'none';
                            txtEl.style.display = 'none';
                            gridEl.style.display = 'grid';
                            for(let i=1; i<=20; i++) {
                                let b = document.getElementById('b'+i);
                                if(d.boxes.includes(i)) b.classList.add('taken');
                                else b.classList.remove('taken');
                            }
                        } else if(d.phase === 'READING' && d.content) {
                            gridEl.style.display = 'none';
                            if(d.contentType === 'image') {
                                imgEl.src = d.content;
                                imgEl.style.display = 'block';
                                txtEl.style.display = 'none';
                            } else {
                                txtEl.innerHTML = d.content;
                                txtEl.style.display = 'block';
                                imgEl.style.display = 'none';
                            }
                        }
                    }
                <\/script>
            </body></html>
        `);
        state.winStudent = w;
    }

    // 2. JUDGE SCREEN
    function openJudgeWindow() {
        const id = "Judge_" + (state.winJudges.length + 1);
        const w = window.open("", id, "width=900,height=900");
        w.document.write(`
            <html><head><style>
                body { font-family:sans-serif; padding:20px; background:#f4f4f4; text-align:center; }
                .info { background:#333; color:#fff; padding:15px; border-radius:5px; margin-bottom:20px; }
                table { width:100%; border-collapse:collapse; background:#fff; }
                th { background:#004d00; color:#fff; padding:10px; }
                td { border:1px solid #ccc; padding:10px; }
                .btn { padding:5px 10px; margin:2px; cursor:pointer; border:1px solid #ccc; background:#eee; }
                .submit { width:100%; padding:20px; background:#004d00; color:#fff; font-size:24px; margin-top:20px; cursor:pointer; border:none; }
            </style></head><body>
                <h1>${id}</h1>
                <div class="info" id="info">Waiting for student...</div>
                <div id="rubric"></div>
                <h2 id="total">Total: 0</h2>
                <button class="submit" onclick="submit()">Submit Score</button>

                <script>
                    let scores = {0:{m:40,d:0}, 1:{m:30,d:0}, 2:{m:20,d:0}, 3:{m:10,d:0}};
                    const cats = ["Thilawa (40)", "Tajweed (30)", "Fasaha (20)", "Sifa (10)"];

                    let html = '<table><tr><th>Category</th><th>Max</th><th>Deduct</th><th>Score</th></tr>';
                    cats.forEach((c, i) => {
                        html += \`<tr><td>\${c}</td><td>\${scores[i].m}</td>
                        <td><button class="btn" onclick="sub(\${i}, 0.5)">-0.5</button><button class="btn" onclick="sub(\${i}, 1)">-1</button><button class="btn" onclick="rst(\${i})">R</button></td>
                        <td id="s_\${i}" style="font-weight:bold; font-size:18px;">\${scores[i].m}</td></tr>\`;
                    });
                    html += '</table>';
                    document.getElementById('rubric').innerHTML = html;

                    window.update = function(d) {
                        document.getElementById('info').innerHTML = d.student.name ? \`\${d.student.name} <br> \${d.student.branch}\` : "Waiting...";
                    }
                    window.sub = function(i, v) { scores[i].d += v; if(scores[i].d > scores[i].m) scores[i].d = scores[i].m; renderRow(i); }
                    window.rst = function(i) { scores[i].d = 0; renderRow(i); }
                    function renderRow(i) { document.getElementById('s_'+i).innerText = scores[i].m - scores[i].d; calc(); }
                    function calc() { let t=0; for(let k in scores) t+=(scores[k].m-scores[k].d); document.getElementById('total').innerText="Total: "+t; }
                    function submit() {
                        let t = document.getElementById('total').innerText.split(': ')[1];
                        window.opener.submitJudgeScore("${id}", t);
                        document.querySelector('.submit').innerText = "Submitted!";
                        document.querySelector('.submit').disabled = true;
                    }
                <\/script>
            </body></html>
        `);
        state.winJudges.push(w);
    }
</script>
</body>
</html>
