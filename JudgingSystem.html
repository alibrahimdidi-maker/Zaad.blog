<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Judging System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom Fonts & Styles */
        :root {
            --primary-color: #0f766e; /* Teal 700 */
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-thaana { font-family: 'Noto Sans Thaana', sans-serif; line-height: 1.8; }
        .font-arabic { font-family: 'Amiri', serif; }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            .page-break { page-break-after: always; }
        }
        .print-only { display: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        
        /* Tab Active State */
        .tab-active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-thaana text-gray-800 transition-all duration-300">

    <nav class="bg-white shadow-md no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-scale-balanced text-teal-700 text-2xl ml-3"></i>
                    <h1 class="text-xl font-bold text-teal-800" id="nav-title">Judging System Pro</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <select id="lang-select" onchange="changeLanguage()" class="border rounded p-1 text-sm">
                        <option value="dv">ދިވެހި</option>
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                    <button onclick="toggleDisplayWindow()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        <i class="fa-solid fa-desktop"></i> <span data-t="openDisplay">Display</span>
                    </button>
                    <button onclick="saveData()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        <i class="fa-solid fa-save"></i> <span data-t="save">Save</span>
                    </button>
                </div>
            </div>
            <div class="flex space-x-8 space-x-reverse border-t overflow-x-auto">
                <button onclick="switchTab('setup')" class="tab-btn py-3 px-2 tab-active" id="tab-setup" data-t="setup">Setup</button>
                <button onclick="switchTab('registration')" class="tab-btn py-3 px-2" id="tab-reg" data-t="registration">Registration</button>
                <button onclick="switchTab('judging')" class="tab-btn py-3 px-2" id="tab-judge" data-t="judging">Judging</button>
                <button onclick="switchTab('results')" class="tab-btn py-3 px-2" id="tab-results" data-t="results">Results</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full p-4 no-print">
        
        <section id="setup-view" class="view-section">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-xl font-bold mb-4 border-b pb-2" data-t="compDetails">Competition Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="comp-name" placeholder="Competition Name" class="border p-2 rounded w-full">
                    <select id="comp-type" class="border p-2 rounded w-full">
                        <option value="quran">Quran Competition</option>
                        <option value="madhaha">Madhaha</option>
                        <option value="speech">Speech</option>
                        <option value="quiz">Quiz</option>
                        <option value="general">General</option>
                    </select>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" data-t="criteriaSetup">Judging Criteria Setup</h2>
                    <button onclick="addCriteriaRow()" class="bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700">+ Add</button>
                </div>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-200 text-right">
                            <th class="p-2 border">Criteria Name</th>
                            <th class="p-2 border w-24">Max Marks</th>
                            <th class="p-2 border w-20">Action</th>
                        </tr>
                    </thead>
                    <tbody id="criteria-list">
                        </tbody>
                    <tfoot>
                        <tr class="bg-gray-100 font-bold">
                            <td class="p-2 text-right">Total</td>
                            <td class="p-2 text-center" id="total-max-marks">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <div class="mt-4 text-sm text-gray-600">
                    <p>* Rubric: Each criteria will have a 5-level deduction system automatically generated.</p>
                </div>
            </div>
        </section>

        <section id="registration-view" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-xl font-bold mb-4" data-t="addParticipant">Add Participant</h2>
                <form id="reg-form" onsubmit="event.preventDefault(); addParticipant();" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="p-name" placeholder="Student Name" required class="border p-2 rounded">
                    <input type="text" id="p-id" placeholder="ID/Index Number" required class="border p-2 rounded">
                    <input type="text" id="p-parent" placeholder="Parent Name" class="border p-2 rounded">
                    <input type="text" id="p-class" placeholder="Class/Branch" class="border p-2 rounded">
                    <select id="p-age-group" class="border p-2 rounded">
                        <option value="Key Stage 1">Key Stage 1 (Age 6-9)</option>
                        <option value="Key Stage 2">Key Stage 2 (Age 10-12)</option>
                        <option value="Key Stage 3">Key Stage 3 (Age 13-16)</option>
                    </select>
                    
                    <div class="col-span-1 md:col-span-3 grid grid-cols-4 gap-2 bg-teal-50 p-2 rounded border border-teal-200">
                        <input type="text" id="q-surah" placeholder="Surah Name" class="border p-2 rounded">
                        <input type="number" id="q-verse-start" placeholder="Start Verse" class="border p-2 rounded">
                        <input type="number" id="q-verse-end" placeholder="End Verse" class="border p-2 rounded">
                        <select id="p-session" class="border p-2 rounded">
                            <option value="1">Session 1</option>
                            <option value="2">Session 2</option>
                        </select>
                    </div>

                    <button type="submit" class="bg-blue-600 text-white p-2 rounded col-span-1 md:col-span-3 hover:bg-blue-700" data-t="registerBtn">Register Student</button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold" data-t="masterSheet">Master Sheet</h2>
                    <div>
                        <button onclick="exportJSON()" class="text-sm bg-gray-600 text-white px-2 py-1 rounded">Backup Data</button>
                        <input type="file" id="import-file" class="hidden" onchange="importJSON(this)">
                        <button onclick="document.getElementById('import-file').click()" class="text-sm bg-gray-600 text-white px-2 py-1 rounded">Restore</button>
                    </div>
                </div>
                <table class="w-full text-sm text-right border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 border">ID</th>
                            <th class="p-2 border">Name</th>
                            <th class="p-2 border">Class</th>
                            <th class="p-2 border">Surah/Topic</th>
                            <th class="p-2 border">Status</th>
                            <th class="p-2 border">Action</th>
                        </tr>
                    </thead>
                    <tbody id="participants-list"></tbody>
                </table>
            </div>
        </section>

        <section id="judging-view" class="view-section hidden">
            <div class="bg-white p-4 rounded shadow mb-4 flex flex-wrap gap-4 items-center">
                <div class="w-full md:w-1/3">
                    <label class="block text-sm font-bold mb-1" data-t="selectStudent">Select Student to Judge</label>
                    <select id="judge-student-select" onchange="loadStudentForJudging()" class="w-full border p-2 rounded bg-yellow-50">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="flex-grow text-center bg-teal-50 p-2 rounded border border-teal-200">
                    <h3 id="active-student-display" class="font-bold text-lg">No Student Selected</h3>
                    <p id="active-details-display" class="text-sm text-gray-600">-</p>
                </div>
                <button onclick="updateDisplayScreen()" class="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700">
                    <i class="fa-solid fa-tv"></i> Update Screen
                </button>
            </div>

            <div class="mb-4 overflow-x-auto">
                <div class="flex space-x-2 space-x-reverse" id="judge-tabs-container">
                    </div>
            </div>

            <div id="scoring-area" class="bg-white p-6 rounded shadow hidden">
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 class="font-bold text-lg"><span id="current-judge-label">Judge 1</span> Score Sheet</h3>
                    <span class="text-2xl font-bold text-teal-700" id="current-total-score">0.0</span>
                </div>

                <div id="rubric-container" class="space-y-6">
                    </div>

                <div class="mt-6 border-t pt-4">
                    <label class="block font-bold mb-2" data-t="comments">Comments</label>
                    <textarea id="judge-comment" class="w-full border p-2 rounded h-20" placeholder="Write comments here..."></textarea>
                </div>

                <div class="mt-4 flex justify-end gap-2">
                    <button onclick="saveJudgeScore()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">
                        <i class="fa-solid fa-check"></i> Save Score
                    </button>
                </div>
            </div>
        </section>

        <section id="results-view" class="view-section hidden">
            <div class="bg-white p-6 rounded shadow">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold" data-t="finalResults">Final Results</h2>
                    <button onclick="printResults()" class="bg-gray-800 text-white px-3 py-1 rounded">
                        <i class="fa-solid fa-print"></i> Print Report
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right border" id="results-table">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-2">Rank</th>
                                <th class="p-2">ID</th>
                                <th class="p-2">Name</th>
                                <th class="p-2">Class</th>
                                <th class="p-2 text-center">Avg/Total</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="display-template" style="display:none;">
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <title>Display Screen</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { background: #000; color: white; font-family: 'Noto Sans Thaana', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
                .card { background: #111827; border: 2px solid #0f766e; border-radius: 20px; padding: 40px; text-align: center; width: 90%; max-width: 1000px; box-shadow: 0 0 50px rgba(15, 118, 110, 0.5); }
                h1 { font-size: 4rem; margin-bottom: 20px; color: #2dd4bf; }
                h2 { font-size: 2.5rem; margin-bottom: 30px; }
                .info-box { font-size: 1.8rem; margin: 10px 0; color: #d1d5db; }
                .grid-score { font-size: 5rem; font-weight: bold; color: #facc15; margin-top: 30px; display: none; }
            </style>
        </head>
        <body>
            <div class="card">
                <h2 id="disp-event">Competition 2026</h2>
                <h1 id="disp-name">Waiting...</h1>
                <div class="info-box" id="disp-details"></div>
                <div class="info-box" id="disp-quran"></div>
                <div id="disp-score" class="grid-score"></div>
            </div>
            <script>
                // Listen to parent window updates
                window.addEventListener('storage', (e) => {
                    if (e.key === 'judging_display_data') {
                        const data = JSON.parse(e.newValue);
                        document.getElementById('disp-event').innerText = data.event || '';
                        document.getElementById('disp-name').innerText = data.name || '';
                        document.getElementById('disp-details').innerText = data.details || '';
                        document.getElementById('disp-quran').innerText = data.quran || '';
                        
                        const scoreEl = document.getElementById('disp-score');
                        if(data.showScore) {
                            scoreEl.style.display = 'block';
                            scoreEl.innerText = data.score + "%";
                        } else {
                            scoreEl.style.display = 'none';
                        }
                    }
                });
            </script>
        </body>
        </html>
    </div>

    <script>
        // --- 1. STATE MANAGEMENT ---
        let appData = {
            config: {
                name: "Quran Competition",
                judgesCount: 3,
                maxScore: 100
            },
            criteria: [
                { id: 1, name: "Tajweed / Sound", max: 40 },
                { id: 2, name: "Hifz / Fluency", max: 40 },
                { id: 3, name: "Voice / Tone", max: 20 }
            ],
            participants: [], // Array of student objects
            scores: {} // Map: studentID -> { judge1: {c1: 10, c2: 5}, judge2: ... }
        };

        const translations = {
            dv: {
                setup: "ސެޓަޕް", registration: "ރެޖިސްޓްރޭޝަން", judging: "ޖަޖިންގ", results: "ނަތީޖާ",
                compDetails: "މުބާރާތުގެ ތަފްޞީލް", criteriaSetup: "މާކްސްދޭ މިންގަނޑު",
                addParticipant: "ބައިވެރިއެއް އިތުރުކުރައްވާ", registerBtn: "ރެޖިސްޓަރ ކުރައްވާ",
                masterSheet: "މާސްޓަރ ޝީޓް", selectStudent: "ޖަޖްކުރުމަށް ދަރިވަރަކު ނަގާ",
                comments: "ކޮމެންޓް", finalResults: "ޖުމްލަ ނަތީޖާ",
                openDisplay: "ޑިސްޕްލޭ", save: "ސޭވް"
            },
            en: {
                setup: "Setup", registration: "Registration", judging: "Judging", results: "Results",
                compDetails: "Competition Details", criteriaSetup: "Criteria Setup",
                addParticipant: "Add Participant", registerBtn: "Register",
                masterSheet: "Master Sheet", selectStudent: "Select Student",
                comments: "Comments", finalResults: "Final Results",
                openDisplay: "Display", save: "Save"
            },
            ar: {
                setup: "إعداد", registration: "تسجيل", judging: "تحكيم", results: "النتائج",
                compDetails: "تفاصيل المسابقة", criteriaSetup: "معايير التحكيم",
                addParticipant: "إضافة مشارك", registerBtn: "تسجيل",
                masterSheet: "القائمة الرئيسية", selectStudent: "اختر الطالب",
                comments: "ملاحظات", finalResults: "النتائج النهائية",
                openDisplay: "شاشة العرض", save: "حفظ"
            }
        };

        // --- 2. INITIALIZATION ---
        window.onload = function() {
            loadFromLocal();
            renderCriteria();
            renderParticipants();
            setupJudgeTabs();
            changeLanguage();
        };

        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName + '-view').classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
            // Fix for tab button ID matching
            let btnId = 'tab-' + (tabName === 'registration' ? 'reg' : (tabName === 'judging' ? 'judge' : tabName));
            document.getElementById(btnId).classList.add('tab-active');

            if(tabName === 'judging') populateStudentSelect();
            if(tabName === 'results') calculateResults();
        }

        function changeLanguage() {
            const lang = document.getElementById('lang-select').value;
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
            document.body.classList.toggle('font-thaana', lang === 'dv');
            document.body.classList.toggle('font-arabic', lang === 'ar');

            const t = translations[lang];
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if(t[key]) el.innerText = t[key];
            });
        }

        // --- 3. SETUP LOGIC ---
        function renderCriteria() {
            const tbody = document.getElementById('criteria-list');
            tbody.innerHTML = '';
            let total = 0;
            appData.criteria.forEach((c, index) => {
                total += parseInt(c.max);
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2"><input type="text" value="${c.name}" onchange="updateCriteria(${index}, 'name', this.value)" class="w-full border p-1 rounded"></td>
                        <td class="p-2"><input type="number" value="${c.max}" onchange="updateCriteria(${index}, 'max', this.value)" class="w-full border p-1 rounded text-center"></td>
                        <td class="p-2 text-center"><button onclick="removeCriteria(${index})" class="text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
            });
            document.getElementById('total-max-marks').innerText = total;
        }

        function addCriteriaRow() {
            appData.criteria.push({ id: Date.now(), name: "New Criteria", max: 10 });
            renderCriteria();
        }

        function updateCriteria(index, field, value) {
            appData.criteria[index][field] = value;
            if(field === 'max') renderCriteria(); // Update total
        }

        function removeCriteria(index) {
            appData.criteria.splice(index, 1);
            renderCriteria();
        }

        // --- 4. REGISTRATION LOGIC ---
        function addParticipant() {
            const p = {
                id: document.getElementById('p-id').value,
                name: document.getElementById('p-name').value,
                parent: document.getElementById('p-parent').value,
                class: document.getElementById('p-class').value,
                ageGroup: document.getElementById('p-age-group').value,
                surah: document.getElementById('q-surah').value,
                verseStart: document.getElementById('q-verse-start').value,
                verseEnd: document.getElementById('q-verse-end').value,
                session: document.getElementById('p-session').value,
                status: 'Pending'
            };
            appData.participants.push(p);
            renderParticipants();
            document.getElementById('reg-form').reset();
            saveData();
            alert('Student Added');
        }

        function renderParticipants() {
            const tbody = document.getElementById('participants-list');
            tbody.innerHTML = '';
            appData.participants.forEach((p, index) => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2 border">${p.id}</td>
                        <td class="p-2 border font-bold">${p.name}</td>
                        <td class="p-2 border">${p.class}</td>
                        <td class="p-2 border text-xs">${p.surah || '-'} (${p.verseStart || ''}-${p.verseEnd || ''})</td>
                        <td class="p-2 border"><span class="px-2 rounded text-xs text-white ${p.status === 'Completed' ? 'bg-green-500' : 'bg-yellow-500'}">${p.status}</span></td>
                        <td class="p-2 border text-center">
                            <button onclick="deleteParticipant(${index})" class="text-red-500"><i class="fa-solid fa-times"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function deleteParticipant(index) {
            if(confirm("Are you sure?")) {
                appData.participants.splice(index, 1);
                renderParticipants();
                saveData();
            }
        }

        // --- 5. JUDGING LOGIC ---
        let currentStudentId = null;
        let currentJudgeIndex = 0; // 0 to 9 (Judge 1 to 10)

        function setupJudgeTabs() {
            const container = document.getElementById('judge-tabs-container');
            container.innerHTML = '';
            // Allow up to 10 judges (configurable, but hardcoded loop for UI)
            for(let i=0; i<5; i++) { // Default 5 judges shown
                const activeClass = i === 0 ? 'bg-teal-600 text-white' : 'bg-gray-200 text-gray-700';
                container.innerHTML += `
                    <button onclick="selectJudge(${i})" id="btn-judge-${i}" class="px-4 py-2 rounded font-bold whitespace-nowrap ${activeClass}">
                        Judge ${i+1}
                    </button>
                `;
            }
        }

        function selectJudge(index) {
            currentJudgeIndex = index;
            document.querySelectorAll('#judge-tabs-container button').forEach(b => {
                b.className = 'px-4 py-2 rounded font-bold whitespace-nowrap bg-gray-200 text-gray-700';
            });
            document.getElementById(`btn-judge-${index}`).className = 'px-4 py-2 rounded font-bold whitespace-nowrap bg-teal-600 text-white';
            document.getElementById('current-judge-label').innerText = `Judge ${index+1}`;
            
            if(currentStudentId) loadScoreSheet();
        }

        function populateStudentSelect() {
            const select = document.getElementById('judge-student-select');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            appData.participants.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.id} - ${p.name}</option>`;
            });
        }

        function loadStudentForJudging() {
            const id = document.getElementById('judge-student-select').value;
            currentStudentId = id;
            if(!id) {
                document.getElementById('scoring-area').classList.add('hidden');
                return;
            }

            const p = appData.participants.find(x => x.id === id);
            document.getElementById('active-student-display').innerText = p.name;
            document.getElementById('active-details-display').innerText = `${p.surah || ''} : Ayah ${p.verseStart || ''} - ${p.verseEnd || ''}`;
            document.getElementById('scoring-area').classList.remove('hidden');
            
            loadScoreSheet();
            updateDisplayScreen(false); // Update screen but don't show score
        }

        function loadScoreSheet() {
            const container = document.getElementById('rubric-container');
            container.innerHTML = '';
            
            // Initialize score structure if not exists
            if(!appData.scores[currentStudentId]) appData.scores[currentStudentId] = {};
            if(!appData.scores[currentStudentId][`judge${currentJudgeIndex}`]) {
                appData.scores[currentStudentId][`judge${currentJudgeIndex}`] = { details: {}, total: 0, comments: "" };
            }

            const currentScoreObj = appData.scores[currentStudentId][`judge${currentJudgeIndex}`];
            document.getElementById('judge-comment').value = currentScoreObj.comments || "";

            appData.criteria.forEach((c, cIdx) => {
                const savedScore = currentScoreObj.details[c.id] !== undefined ? currentScoreObj.details[c.id] : parseInt(c.max);
                
                // Rubric Logic: 5 buttons (Full, -10%, -25%, -50%, 0)
                // Simplified for this demo: Slider + Deduction Buttons
                container.innerHTML += `
                    <div class="border p-4 rounded bg-gray-50">
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-lg">${c.name}</label>
                            <span class="font-bold text-teal-700"><span id="score-disp-${c.id}">${savedScore}</span> / ${c.max}</span>
                        </div>
                        
                        <div class="flex gap-2 mb-2 flex-wrap">
                            <button onclick="setScore(${c.id}, ${c.max}, ${c.max})" class="text-xs bg-green-100 hover:bg-green-200 border border-green-300 px-2 py-1 rounded">Full</button>
                            <button onclick="deductScore(${c.id}, 0.5)" class="text-xs bg-yellow-100 hover:bg-yellow-200 border border-yellow-300 px-2 py-1 rounded">-0.5</button>
                            <button onclick="deductScore(${c.id}, 1)" class="text-xs bg-orange-100 hover:bg-orange-200 border border-orange-300 px-2 py-1 rounded">-1.0</button>
                             <button onclick="deductScore(${c.id}, 2)" class="text-xs bg-red-100 hover:bg-red-200 border border-red-300 px-2 py-1 rounded">-2.0</button>
                        </div>
                        <input type="range" id="range-${c.id}" min="0" max="${c.max}" step="0.5" value="${savedScore}" 
                            oninput="manualScoreChange(${c.id}, this.value)" class="w-full">
                    </div>
                `;
            });
            calculateTotalDisplay();
        }

        function setScore(cId, val) {
            document.getElementById(`range-${cId}`).value = val;
            manualScoreChange(cId, val);
        }

        function deductScore(cId, amount) {
            let el = document.getElementById(`range-${cId}`);
            let val = parseFloat(el.value) - amount;
            if(val < 0) val = 0;
            el.value = val;
            manualScoreChange(cId, val);
        }

        function manualScoreChange(cId, val) {
            document.getElementById(`score-disp-${cId}`).innerText = val;
            
            // Save temporarily to memory
            const scoreObj = appData.scores[currentStudentId][`judge${currentJudgeIndex}`];
            scoreObj.details[cId] = parseFloat(val);
            calculateTotalDisplay();
        }

        function calculateTotalDisplay() {
            const scoreObj = appData.scores[currentStudentId][`judge${currentJudgeIndex}`];
            let total = 0;
            appData.criteria.forEach(c => {
                const s = scoreObj.details[c.id];
                total += (s !== undefined) ? s : parseInt(c.max);
            });
            scoreObj.total = total;
            document.getElementById('current-total-score').innerText = total.toFixed(1);
        }

        function saveJudgeScore() {
            const scoreObj = appData.scores[currentStudentId][`judge${currentJudgeIndex}`];
            scoreObj.comments = document.getElementById('judge-comment').value;
            
            // Mark student as active/judged
            const p = appData.participants.find(x => x.id === currentStudentId);
            p.status = 'In Progress';
            
            saveData();
            alert('Score Saved for Judge ' + (currentJudgeIndex + 1));
        }

        // --- 6. DISPLAY / PROJECTOR ---
        function toggleDisplayWindow() {
            const content = document.getElementById('display-template').innerHTML;
            const win = window.open("", "DisplayWindow", "width=800,height=600");
            win.document.write(content);
            win.document.close();
        }

        function updateDisplayScreen(showScore = false) {
            if(!currentStudentId) return;
            const p = appData.participants.find(x => x.id === currentStudentId);
            
            // Calculate Average or Total if requested
            let displayScore = 0;
            if(showScore) {
                // Simple average logic for demo
                let sum = 0, count = 0;
                for(let j=0; j<5; j++) {
                    if(appData.scores[p.id] && appData.scores[p.id][`judge${j}`]) {
                        sum += appData.scores[p.id][`judge${j}`].total;
                        count++;
                    }
                }
                displayScore = count > 0 ? (sum / count).toFixed(2) : 0;
            }

            const data = {
                event: document.getElementById('comp-name').value || "Quran Competition",
                name: p.name,
                details: `${p.class} | ${p.ageGroup}`,
                quran: p.surah ? `${p.surah} (Ayah: ${p.verseStart}-${p.verseEnd})` : '',
                showScore: showScore,
                score: displayScore
            };
            
            localStorage.setItem('judging_display_data', JSON.stringify(data));
        }

        // --- 7. RESULTS & REPORTS ---
        function calculateResults() {
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';
            
            // Build table header dynamically
            const theadRow = document.querySelector('#results-table thead tr');
            // Reset to base cols
            theadRow.innerHTML = `<th class="p-2">Rank</th><th class="p-2">ID</th><th class="p-2">Name</th><th class="p-2">Class</th>`;
            for(let i=0; i<5; i++) {
                theadRow.innerHTML += `<th class="p-2 text-center text-xs">J${i+1}</th>`;
            }
            theadRow.innerHTML += `<th class="p-2 text-center font-bold">Total</th>`;

            // Process Scores
            let results = appData.participants.map(p => {
                let jScores = [];
                let grandTotal = 0;
                let jCount = 0;
                
                for(let i=0; i<5; i++) {
                    const s = appData.scores[p.id] && appData.scores[p.id][`judge${i}`] ? appData.scores[p.id][`judge${i}`].total : 0;
                    jScores.push(s);
                    if(s > 0) { grandTotal += s; jCount++; }
                }
                
                // Logic: Average or Sum? Let's use Average for grid
                let finalScore = jCount > 0 ? (grandTotal / jCount) : 0;
                
                return { ...p, jScores, finalScore };
            });

            // Sort by score
            results.sort((a, b) => b.finalScore - a.finalScore);

            results.forEach((r, idx) => {
                let rowHtml = `
                    <tr class="border-b ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <td class="p-2 font-bold">${idx + 1}</td>
                        <td class="p-2">${r.id}</td>
                        <td class="p-2 font-bold">${r.name}</td>
                        <td class="p-2">${r.class}</td>
                `;
                r.jScores.forEach(s => {
                    rowHtml += `<td class="p-2 text-center text-gray-600 text-xs">${s > 0 ? s : '-'}</td>`;
                });
                rowHtml += `<td class="p-2 text-center font-bold text-teal-700">${r.finalScore.toFixed(2)}</td></tr>`;
                tbody.innerHTML += rowHtml;
            });
        }

        function printResults() {
            window.print();
        }

        // --- 8. DATA PERSISTENCE ---
        function saveData() {
            localStorage.setItem('competitionData', JSON.stringify(appData));
            // Also notify display
        }

        function loadFromLocal() {
            const data = localStorage.getItem('competitionData');
            if(data) {
                appData = JSON.parse(data);
                // Refresh criteria names in setup
                document.getElementById('comp-name').value = appData.config.name || "";
            }
        }

        function exportJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "competition_backup_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importJSON(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                appData = JSON.parse(e.target.result);
                saveData();
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
