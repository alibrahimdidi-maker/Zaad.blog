<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rasfahi Judging System</title>
    <style>
        /* --- FONTS & IMPORTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700;900&family=Cinzel:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        /* Placeholder for Main App Font */
        @font-face {
            font-family: 'AppFont';
            src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
        }

        :root {
            --royal-blue: #001a33;
            --royal-blue-dark: #000d1a;
            --royal-green: #002200; 
            --royal-green-mix: #004d00;
            --gold: #D4AF37;
            --gold-bright: #FFD700;
            --gold-dim: #aa8c2c;
            --green: #006400;
            --green-bright: #00e676;
            --text-main: #ffffff;
            --panel-bg: #0b1016;
            --border-radius: 6px;
        }

        /* GLOBAL BOX SIZING */
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; outline: none; }
        
        /* APPLY FONT GLOBALLY */
        body, button, input, select, textarea, h1, h2, span, div, p, a, label, th, td { 
            font-family: 'AppFont', 'Noto Sans Thaana', 'Amiri', sans-serif !important; 
        }

        body { 
            margin: 0; padding: 0;
            background: #000; 
            color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; 
        }

        /* --- SIDEBAR DESIGN --- */
        .sidebar {
            width: 500px; 
            background: linear-gradient(180deg, var(--panel-bg) 0%, #000 100%); 
            border-left: 3px solid var(--gold);
            display: flex; flex-direction: column; height: 100vh; z-index: 100;
            box-shadow: 10px 0 40px rgba(0,0,0,0.8);
            transition: width 0.3s;
        }
        
        .header { 
            padding: 15px; text-align: center; 
            background: linear-gradient(to bottom, var(--royal-blue), var(--royal-blue-dark)); 
            border-bottom: 2px solid var(--gold); 
        }
        .app-title { 
            font-family: 'Cinzel', serif !important; color: var(--gold);
            font-size: 20px; margin: 0; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
        }

        .content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        /* FOOTER */
        .royal-footer {
            padding: 10px;
            background: linear-gradient(to top, #000, #111);
            border-top: 2px double var(--gold);
            text-align: center;
            font-size: 11px;
            color: #888;
        }
        .royal-footer p { margin: 2px 0; }
        .royal-footer .highlight { color: var(--gold); font-weight: bold; font-family: 'Cinzel', sans-serif !important; }
        
        .drive-btn {
            background: #1f1f1f; border: 1px dashed #555; color: #aaa;
            padding: 8px; width: 100%; margin-bottom: 10px; cursor: pointer;
            text-decoration: none; display: block; font-size: 11px;
            border-radius: 4px;
        }
        .drive-btn:hover { background: #333; color: #fff; border-color: var(--gold); }

        /* PANELS */
        .panel { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid #334455; 
            border-radius: var(--border-radius); 
            padding: 12px; 
            transition: 0.3s;
        }
        .panel:hover { border-color: #556677; }

        .panel-live {
            background: linear-gradient(135deg, rgba(0,26,51,0.6), rgba(0,0,0,0.8));
            border: 1px solid var(--gold-dim);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        h2 { 
            color: var(--gold); margin: 0 0 8px 0; font-size: 16px; 
            border-bottom: 1px dashed #445566; padding-bottom: 4px; 
        }
        
        label { color: #aab; font-size: 13px; display: block; margin-top: 8px; margin-bottom: 2px; }
        
        input, select, button { 
            width: 100%; padding: 8px; margin-top: 2px; 
            background: #1a222c; border: 1px solid #334455; 
            color: #fff; border-radius: 4px; 
            font-size: 14px; 
        }
        
        /* Custom Controls for Ceremony */
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .color-picker { width: 40px; padding: 2px; height: 35px; cursor: pointer; border: 1px solid #555; }
        .range-slider { flex: 1; cursor: pointer; accent-color: var(--gold); }
        
        /* BUTTON STYLES */
        button { 
            cursor: pointer; font-weight: bold; border-color: #445566; 
            transition: all 0.2s; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(to bottom, #2a3b4c, #1a222c);
        }
        button:hover { filter: brightness(1.2); border-color: var(--gold); transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        .btn-green { background: linear-gradient(to bottom, #004d00, #003300) !important; border-color: #006400 !important; color: #fff !important; }
        .btn-red { background: linear-gradient(to bottom, #8b0000, #500000) !important; border-color: #b71c1c !important; color: #fff !important; }
        .btn-gold { background: linear-gradient(to bottom, var(--gold), var(--gold-dim)) !important; color: #000 !important; border-color: #fff !important; font-weight: 900 !important; }
        .btn-blue { background: linear-gradient(to bottom, #004080, #002040) !important; border-color: #0059b3 !important; color: #fff !important; }
        .btn-purple { background: linear-gradient(to bottom, #4a148c, #311b92) !important; border-color: #7c4dff !important; color: #fff !important; }
        .btn-orange { background: linear-gradient(to bottom, #e65100, #bf360c) !important; border-color: #ff6d00 !important; color: #fff !important; }
        .btn-cyan { background: linear-gradient(to bottom, #00838f, #006064) !important; border-color: #00bcd4 !important; color: #fff !important; }

        /* LANG SWITCHER */
        .lang-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .lang-btn { flex: 1; font-size: 12px; padding: 5px; background: #222; color: #777; border: 1px solid #444; }
        .lang-btn.active { background: var(--royal-blue); color: var(--gold); border-color: var(--gold); font-weight: bold; }

        /* MODE SWITCHER */
        .mode-switch { display: flex; background: #000; border: 1px solid #444; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: #222; color: #666; font-size: 12px; cursor: pointer; }
        .mode-btn.active { background: var(--royal-blue); color: var(--gold); font-weight: bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        /* READING MODE SWITCHER */
        .read-switch { display:flex; gap:5px; margin-bottom:10px; }
        .read-btn { flex:1; padding:8px; border:1px solid #444; background:#111; color:#888; font-size:12px; cursor: pointer; }
        .read-btn.active { background:#004d40; color:#fff; border-color:#00e676; font-weight:bold; }

        /* STATUS & SLOTS */
        #statusDisplay {
            background: #000; border: 2px solid var(--green-bright);
            color: var(--green-bright); text-align: center;
            font-family: 'Cinzel', serif !important; font-size: 18px; font-weight: bold;
            padding: 8px; margin-bottom: 10px; border-radius: 4px;
            text-shadow: 0 0 10px rgba(0,230,118,0.5);
        }

        #slotGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .slot-box { 
            background: #222; padding: 10px; text-align: center; font-size: 14px; 
            color: #555; border: 1px solid #333; border-radius: 4px; transition: 0.3s;
        }
        .slot-box.active { 
            background: var(--royal-blue); color: var(--gold); border-color: var(--gold); 
            font-weight: bold; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); transform: scale(1.05);
        }

        /* MAIN PREVIEW AREA (ADMIN MONITOR) */
        .main-view { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #222; position: relative; overflow: hidden; }
        .mirror-header { background: #111; padding: 5px 15px; color: #666; font-size: 11px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; flex-shrink: 0; }
        
        #adminMirror {
            flex: 1; overflow: hidden; position: relative;
            background: radial-gradient(circle, #001a33, #000);
            display: flex; justify-content: center; align-items: center;
        }
        
        /* SCROLLABLE ADMIN CARD */
        .mirror-card {
            width: 85%; height: 85%;
            background: #fff;
            border: 10px double var(--gold);
            position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 8px;
        }

        .mirror-banner-strip {
            background: rgba(0,0,0,0.9);
            color: var(--gold);
            padding: 8px;
            display: flex; justify-content: space-around;
            border-bottom: 2px solid var(--gold);
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            flex-shrink: 0;
        }

        /* SCROLLABLE IMAGE CONTAINER */
        .mirror-img-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background: #fff;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) #222;
        }
        
        .mirror-img-container::-webkit-scrollbar { width: 8px; }
        .mirror-img-container::-webkit-scrollbar-track { background: #222; }
        .mirror-img-container::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 4px; }

        .mirror-img-container img {
            width: 100%; height: auto; display: block;
        }

        .mirror-info-span { color: #fff; margin-left: 5px; }

        /* GRID PREVIEW */
        #gridPreview { display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 60%; }
        .gp-box { 
            background: #111; border: 1px solid #444; color: #666; 
            text-align: center; padding: 10px; font-size: 12px; cursor: pointer;
        }
        .gp-box:hover { background: #222; color: #fff; border-color: #666; }
        .gp-box.taken { background: #330000; color: #555; border-color: #500; pointer-events: none; }
        .gp-box.selected { background: var(--gold); color: #000; border-color: #fff; font-weight:bold; }

        .hidden { display: none !important; }

        /* SECURITY OVERLAY */
        #securityOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .sec-box { border: 2px solid var(--gold); padding: 40px; text-align: center; background: #000d1a; border-radius: 10px; width: 400px; box-shadow: 0 0 50px rgba(212,175,55,0.2); }

        /* ROYAL FULLSCREEN BUTTON */
        #royalFSBtn {
            position: absolute; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(212,175,55, 0.6);
            cursor: pointer; z-index: 200;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #000; transition: all 0.3s;
        }
        #royalFSBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }

        /* --- MOBILE & RESPONSIVE DESIGN --- */
        @media screen and (max-width: 900px) {
            body { flex-direction: column-reverse; height: auto; overflow-y: auto; }
            .sidebar { 
                width: 100%; height: auto; 
                border-left: none; border-top: 3px solid var(--gold); 
                order: 2;
            }
            .main-view { 
                width: 100%; height: 60vh; 
                order: 1; border-right: none;
            }
            .content { max-height: 400px; }
            .mirror-card { width: 95%; height: 95%; border-width: 5px; }
            .sec-box { width: 90%; }
            button, select, input { padding: 12px; font-size: 16px; }
        }
        
        /* Rubric Table Styles in Sidebar */
        .rubric-edit-row { display: grid; grid-template-columns: 2fr 1fr 30px; gap: 5px; margin-bottom: 5px; }
        .rubric-edit-row input { margin: 0; padding: 4px; }
        /* --- SECRETARY PANEL RE-DESIGN (FIXED LAYOUT) --- */
#secretaryPanel {
    /* ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁéﬁ¨ 45% ﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÑﬁÆﬁëﬁ™ ﬁÇﬁ™ﬁàﬁßﬁÇﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁÄﬁ®ﬁäﬁ¨ﬁÄﬁ¨ﬁáﬁ∞ﬁìﬁ™ﬁÇﬁ∞ */
    height: 45vh; 
    max-height: 400px;
    min-height: 300px;
    background: #0b1016; 
    border-bottom: 4px double #FFD700; 
    padding: 10px; 
    display: flex; 
    flex-direction: column; 
    gap: 10px;
    flex-shrink: 0; /* ﬁâﬁ® ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ ﬁäﬁ®ﬁåﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÇﬁ™ﬁãﬁßﬁÇﬁ¨ */
}

/* ﬁÑﬁ¨ﬁÇﬁß ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ */
#secStudentBanner {
    flex-shrink: 0; /* ﬁÑﬁ¨ﬁÇﬁß ﬁÜﬁ™ﬁëﬁ¶ ﬁÇﬁ™ﬁàﬁßﬁÇﬁ¨ */
    background: linear-gradient(90deg, #002b15, #000); 
    border: 1px solid #006400; 
    padding: 10px 15px; 
    border-radius: 6px; 
    box-shadow: inset 0 0 15px #000;
}

/* ﬁâﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁÇﬁëﬁ™ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁáﬁ≠ﬁÉﬁ®ﬁîﬁß (ﬁñﬁ¶ﬁñﬁ∞ ﬁêﬁ®ﬁçﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ + ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞) */
.sec-control-area {
    display: flex; 
    gap: 10px; 
    flex: 1; /* ﬁÑﬁßﬁÜﬁ© ﬁáﬁÆﬁåﬁ∞ ﬁñﬁßﬁéﬁ¶ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨ */
    overflow: hidden; /* ﬁÑﬁ≠ﬁÉﬁ¶ﬁÅﬁ∞ﬁãﬁß ﬁÑﬁ¶ﬁáﬁ® ﬁäﬁÆﬁÉﬁ™ﬁàﬁßﬁÇﬁ¨ */
}

/* ﬁñﬁ¶ﬁñﬁ∞ ﬁêﬁ®ﬁçﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁäﬁÆﬁÅﬁ® */
.sec-left-box {
    width: 220px; 
    background: #151b22; 
    padding: 10px; 
    border: 1px solid #334455; 
    border-radius: 6px;
    display: flex; 
    flex-direction: column;
}

/* ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ ﬁäﬁÆﬁÅﬁ® (SCROLLABLE AREA) */
.sec-table-wrapper {
    flex: 1; 
    background: #000; 
    border: 1px solid #333; 
    border-radius: 6px;
    overflow-y: auto; /* ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™: ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁàﬁßﬁÇﬁ¨ */
    padding: 5px;
}

/* ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁÑﬁß ﬁÉﬁ©ﬁåﬁ®ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ */
.sec-table-wrapper::-webkit-scrollbar { width: 8px; }
.sec-table-wrapper::-webkit-scrollbar-track { background: #111; }
.sec-table-wrapper::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
.sec-table-wrapper::-webkit-scrollbar-thumb:hover { background: #FFD700; }

/* ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ */
.sec-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.sec-table th { position: sticky; top: 0; background: #222; z-index: 1; text-align: left; padding: 8px; color: #aaa; border-bottom: 1px solid #444; }
.sec-table td { padding: 6px; border-bottom: 1px solid #1a1a1a; vertical-align: middle; }
.sec-table tr:hover { background: rgba(255, 215, 0, 0.05); }

/* ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ */
.sec-deduct-btn {
    background: linear-gradient(to bottom, #330000, #1a0000); 
    border: 1px solid #550000; color: #ff5252;
    padding: 3px 10px; margin-right: 4px; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 11px;
}
.sec-deduct-btn:hover { border-color: #ff5252; background: #550000; color: #fff; }
.sec-deduct-btn:active { transform: translateY(1px); }

.sec-reset-btn {
    background: #222; border: 1px solid #444; color: #aaa; padding: 3px 8px; cursor: pointer; border-radius: 3px; font-size: 11px;
}
.sec-reset-btn:hover { background: #333; color: #fff; }

/* MAIN PREVIEW AREA (ADMIN MONITOR) - SCROLL FIX */
.main-view { 
    flex: 1; 
    background: #050505; 
    display: flex; 
    flex-direction: column; 
    border-right: 1px solid #222; 
    position: relative; 
    
    /* ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™: ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁéﬁÆﬁåﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞ ‚òÖ */
    overflow-y: auto; 
    overflow-x: hidden;
    height: 100vh; 
}

/* Scrollbar Design for Main View */
.main-view::-webkit-scrollbar { width: 10px; }
.main-view::-webkit-scrollbar-track { background: #000; }
.main-view::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }

#adminMirror {
    width: 100%;
    /* ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™: ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁâﬁÆﬁÇﬁ®ﬁìﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁàﬁ¶ﬁÜﬁ® ﬁáﬁ™ﬁêﬁ∞ﬁâﬁ®ﬁÇﬁ¨ﬁáﬁ∞ ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞ ‚òÖ */
    height: 600px;       /* ﬁëﬁ®ﬁäﬁØﬁçﬁ∞ﬁìﬁ∞ ﬁáﬁ™ﬁêﬁ∞ﬁâﬁ®ﬁÇﬁ¨ﬁáﬁ∞ */
    min-height: 500px;   /* ﬁÜﬁ™ﬁëﬁ¶ﬁàﬁ¨ﬁéﬁ¨ﬁÇﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ﬁàﬁßﬁÇﬁ¨ ﬁàﬁ¶ﬁÉﬁ™ */
    flex-shrink: 0;      /* ﬁäﬁ®ﬁåﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ™ﬁëﬁ¶ﬁàﬁ®ﬁîﬁ¶ ﬁÇﬁ™ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞ */
    
    overflow: hidden; 
    position: relative;
    background: radial-gradient(circle, #001a33, #000);
    display: flex; 
    justify-content: center; 
    align-items: center;
    border-top: 4px solid var(--gold); /* ﬁàﬁ¶ﬁÜﬁ®ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÉﬁÆﬁÇﬁéﬁ¨ﬁáﬁ∞ */
    margin-top: 20px;
    margin-bottom: 50px; /* ﬁåﬁ®ﬁÉﬁ®ﬁÇﬁ∞ ﬁåﬁ¶ﬁÇﬁ∞ﬁÜﬁÆﬁÖﬁ¨ﬁáﬁ∞ ﬁãﬁ´ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ */
}
        /* --- MASTER SHEET TABLE STYLES --- */
#masterViewPanel {
    flex: 1; /* Take remaining height */
    display: flex; flex-direction: column;
    background: #0d1117; 
    border-bottom: 4px solid #FFD700;
    overflow: hidden; /* Contain the scroll */
    min-height: 300px;
}

.ms-filter-bar {
    display: flex; gap: 10px; padding: 10px; 
    background: #161b22; border-bottom: 1px solid #333;
    align-items: center;
}

.ms-table-container {
    flex: 1; overflow: auto; /* Enable Scroll */
    background: #000;
}

.ms-table {
    width: 100%; border-collapse: collapse; 
    font-size: 13px; white-space: nowrap; /* Keep rows long (Landscape feel) */
}

.ms-table th {
    position: sticky; top: 0; 
    background: linear-gradient(to bottom, #222, #111);
    color: #FFD700; border: 1px solid #444;
    padding: 8px; text-align: center; z-index: 5;
}

.ms-table td {
    border: 1px solid #333; padding: 6px; color: #ccc; text-align: center;
}

.ms-table tr { cursor: pointer; transition: 0.2s; }
.ms-table tr:hover { background: #1a1a1a; color: #fff; }
.ms-table tr.selected-row { background: #004d00; color: #fff; border: 1px solid #00e676; }

/* Column Widths */
.col-s { width: 40px; }
.col-m { width: 100px; }
.col-l { width: 200px; text-align: left !important; padding-left: 10px !important; }
.col-mark { width: 60px; background: #0b1016; font-weight: bold; color: #aaa; }
.col-final { width: 70px; background: #002b15; color: #00e676; font-weight: bold; }
        /* --- MODERN SECRETARY PANEL --- */
#secretaryPanel {
    background: #1a1f26; 
    border-bottom: 3px solid #FFD700; 
    padding: 15px; 
    display: flex; gap: 15px;
    height: 420px; /* Fixed efficient height */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* Left Side: Controls */
.sec-sidebar {
    width: 250px; flex-shrink: 0;
    display: flex; flex-direction: column; gap: 10px;
    background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #333;
}

.judge-select-box {
    width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
    background: #000; color: #FFD700; border: 1px solid #555; border-radius: 6px;
    margin-bottom: 10px;
}

.total-score-card {
    background: linear-gradient(135deg, #002b15, #000);
    border: 2px solid #00e676; border-radius: 8px;
    padding: 15px; text-align: center; margin-bottom: 10px;
}
.total-score-val { font-size: 42px; font-weight: 900; color: #fff; font-family: sans-serif; }
.total-score-lbl { font-size: 11px; color: #00e676; text-transform: uppercase; letter-spacing: 1px; }

/* Right Side: Rubric Table */
.sec-table-area {
    flex: 1; overflow-y: auto; 
    background: #0d1117; border-radius: 8px; border: 1px solid #333;
}
.rubric-table-modern { width: 100%; border-collapse: collapse; }
.rubric-table-modern th { 
    position: sticky; top: 0; background: #222; color: #aaa; 
    padding: 12px; text-align: left; border-bottom: 2px solid #444; z-index: 2;
}
.rubric-table-modern td { 
    padding: 10px; border-bottom: 1px solid #222; vertical-align: middle; 
}
.rubric-table-modern tr:hover { background: #1f262e; }

/* Deduction Buttons (Chips) */
.deduct-chip {
    display: inline-block; padding: 6px 12px; margin: 2px;
    background: #2a0000; border: 1px solid #550000; color: #ff8a80;
    border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
    transition: 0.2s;
}
.deduct-chip:hover { background: #ff5252; color: white; transform: scale(1.1); }
.deduct-chip:active { transform: scale(0.95); }

.reset-chip {
    display: inline-block; padding: 6px 10px;
    background: #333; color: #fff; border-radius: 50%;
    border: 1px solid #555; cursor: pointer; font-size: 12px;
}
.reset-chip:hover { background: #fff; color: #000; }

    /* ﬁáﬁÆﬁìﬁØ ﬁêﬁ≠ﬁàﬁ∞ ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ - ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁéﬁ¨ ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ™ ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ® */
    #autoSaveStatus {
        position: fixed;
        top: 20px;           /* ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ 20 ﬁïﬁ®ﬁÜﬁ∞ﬁêﬁ¨ﬁçﬁ∞ */
        right: 20px;         /* ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ™ﬁÇﬁ∞ ﬁáﬁ¨ﬁåﬁ¨ﬁÉﬁ¨ﬁáﬁ¶ﬁÅﬁ∞ 20 ﬁïﬁ®ﬁÜﬁ∞ﬁêﬁ¨ﬁçﬁ∞ */
        
        background-color: #28a745; /* ﬁäﬁ¨ﬁÄﬁ® ﬁÜﬁ™ﬁçﬁ¶ */
        color: white;              /* ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ ﬁÄﬁ™ﬁãﬁ™ﬁÜﬁ™ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ */
        padding: 10px 20px;        /* ﬁÑﬁÆﬁëﬁ™ﬁâﬁ®ﬁÇﬁ∞ */
        border-radius: 5px;        /* ﬁÜﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁàﬁ¶ﬁÅﬁ∞ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞ */
        font-family: sans-serif;   /* ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ */
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* ﬁÄﬁ®ﬁîﬁ¶ﬁÇﬁ® */
        z-index: 9999;             /* ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁÑﬁ¨ﬁÄﬁ¨ﬁáﬁ∞ﬁìﬁ™ﬁâﬁ¶ﬁÅﬁ∞ */
    }

    /* ﬁêﬁ¨ﬁÜﬁ®ﬁáﬁ™ﬁÉﬁ®ﬁìﬁ© ﬁáﬁØﬁàﬁ¶ﬁÉﬁçﬁ≠ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ */
    #securityOverlay {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: #000; 
        z-index: 99999;
        /* ﬁâﬁ¨ﬁãﬁ¶ﬁÅﬁ∞ ﬁéﬁ¨ﬁÇﬁ¶ﬁáﬁ™ﬁâﬁ¶ﬁÅﬁ∞ */
        display: flex; 
        justify-content: center; 
        align-items: center;
        font-family: 'Poppins', sans-serif;
    }

    .login-card {
        /* ﬁçﬁÆﬁéﬁ®ﬁÇﬁ∞ ﬁÜﬁßﬁëﬁ™ﬁéﬁ¨ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß... */
        background: white;
        padding: 20px;
        border-radius: 10px;
    }
        /* --- ROYAL RUBRIC GRID SYSTEM (NO SCROLLING) --- */
.rubric-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Auto adjust columns */
    gap: 10px;
    padding: 5px;
    height: 100%;
    overflow-y: auto;
}

.rubric-card {
    background: linear-gradient(145deg, #1a1f26, #0d1117);
    border: 1px solid #334455;
    border-radius: 8px;
    padding: 10px;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}

.rubric-card:hover {
    border-color: #FFD700;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
    transform: translateY(-2px);
}

.card-info {
    flex: 1;
}

.card-title {
    font-family: 'Faruuma', sans-serif;
    font-size: 16px;
    color: #fff;
    margin-bottom: 5px;
    font-weight: bold;
    letter-spacing: 0.5px;
}

.card-max {
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
}

.card-actions {
    display: flex;
    gap: 4px;
    margin-top: 5px;
}

.deduct-btn-mini {
    background: #2a0000;
    border: 1px solid #550000;
    color: #ff5252;
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}
.deduct-btn-mini:hover { background: #ff5252; color: white; }
.deduct-btn-mini:active { transform: scale(0.95); }

.reset-btn-mini {
    background: #333;
    border: 1px solid #555;
    color: #aaa;
    border-radius: 50%;
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 10px;
}
.reset-btn-mini:hover { background: #fff; color: #000; }

.card-score-box {
    text-align: center;
    background: #000;
    border: 2px solid #334455;
    border-radius: 6px;
    padding: 5px 10px;
    min-width: 60px;
}

.card-score-val {
    font-size: 22px;
    font-weight: bold;
    color: #00e676;
    font-family: sans-serif;
}

.card-deducted {
    font-size: 10px;
    color: #ff5252;
    height: 12px; /* Fixed height to prevent jump */
}

/* Make total box look grand */
#secTotalDisplay {
    text-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
}
        /* --- BUTTON TEXT SIZE UPGRADE --- */
button, 
.btn-green, .btn-red, .btn-gold, .btn-blue, .btn-purple, .btn-orange, .btn-cyan {
    font-size: 18px !important; /* ﬁâﬁ® ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ™ (18) ﬁÑﬁÆﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁéﬁ¨ﬁÇﬁ∞ ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ ﬁÑﬁÆﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ﬁÇﬁ¨ */
    font-weight: 900 !important; /* ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÑﬁØ (Bold) ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ¶ﬁÅﬁ∞ */
    letter-spacing: 0.5px;
    padding: 12px 15px !important; /* ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¨ﬁåﬁ¨ﬁÉﬁ≠ﬁéﬁ¨ ﬁñﬁßﬁéﬁ¶ ﬁåﬁ¶ﬁÇﬁ¶ﬁàﬁ¶ﬁêﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ¶ﬁÅﬁ∞ */
}

/* ﬁÜﬁ™ﬁãﬁ® ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ (Optional) */
.sec-deduct-btn, .deduct-chip {
    font-size: 14px !important;
}
        /* --- BUTTON SIZES (ADJUSTED) --- */

/* 1. ﬁâﬁ¶ﬁáﬁ® ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Main Buttons - Start, Save, etc) */
button, 
.btn-green, .btn-red, .btn-gold, .btn-blue, .btn-purple, .btn-orange, .btn-cyan {
    font-size: 15px !important; /* 18px ﬁéﬁ¨ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁéﬁ¶ﬁáﬁ® 15px ﬁáﬁ¶ﬁÅﬁ∞ ﬁÜﬁ™ﬁëﬁ¶ﬁÜﬁ™ﬁÉﬁ© */
    font-weight: bold !important;
    padding: 10px 12px !important;
    letter-spacing: 0.5px;
}

/* 2. ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÜﬁ¶ﬁÇﬁëﬁß ﬁÜﬁ™ﬁãﬁ® ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Deduction Buttons - Small) */
/* ﬁâﬁ®ﬁáﬁ© -0.5, -1 ﬁäﬁ¶ﬁãﬁ¶ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¨ﬁàﬁ¨ */
.sec-deduct-btn, 
.deduct-chip, 
.deduct-btn-mini, 
.reset-btn-mini,
.sec-reset-btn {
    font-size: 11px !important; /* ﬁâﬁ® ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁÜﬁ™ﬁëﬁ¶ﬁÜﬁÆﬁÅﬁ∞ */
    padding: 2px 6px !important; /* ﬁñﬁßﬁéﬁ¶ﬁàﬁ¨ﬁêﬁ∞ ﬁÜﬁ™ﬁëﬁ¶ﬁÜﬁÆﬁÅﬁ∞ */
    font-weight: bold !important;
    line-height: normal !important;
}

/* 3. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ﬁåﬁ¶ﬁáﬁ∞ (Judge Selection Box) */
#secJudgeSelect, #manualJudgeSelect {
    font-size: 14px !important;
}
        /* BUTTON STYLES */
.btn-purple { 
    background: linear-gradient(to bottom, #4a148c, #311b92); 
    border: 1px solid #7c4dff; 
    color: #fff; 
    cursor: pointer;
    font-weight: bold;
    border-radius: 4px;
    padding: 8px;
}
.btn-purple:hover { background: #7c4dff; }

.btn-orange { 
    background: linear-gradient(to bottom, #e65100, #bf360c); 
    border: 1px solid #ff6d00; 
    color: #fff; 
    cursor: pointer;
    font-weight: bold;
    border-radius: 4px;
    padding: 8px;
}
.btn-orange:hover { background: #ff6d00; }
        /* --- MULTI-JUDGE MATRIX MODAL --- */
#matrixModal {
    display: none; 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 10000;
    justify-content: center; align-items: center; flex-direction: column;
}
.matrix-container {
    background: #111; border: 2px solid #FFD700; padding: 20px;
    width: 95%; height: 90%; overflow-y: auto; border-radius: 8px;
    box-shadow: 0 0 50px rgba(212,175,55,0.2);
}
.matrix-table { width: 100%; border-collapse: collapse; color: #fff; }
.matrix-table th { 
    position: sticky; top: 0; background: #222; 
    padding: 10px; border: 1px solid #444; color: #FFD700; z-index: 2;
}
.matrix-table td { border: 1px solid #333; padding: 5px; text-align: center; }
.matrix-input {
    width: 100%; background: #000; border: none; color: #00e676; 
    text-align: center; font-weight: bold; font-size: 16px; padding: 8px;
}
.matrix-input:focus { background: #002200; outline: 1px solid #00e676; }
.matrix-total { color: #FFD700; font-weight: bold; font-size: 18px; }
</style>
</head>

<body oncontextmenu="return false;">

    <audio id="bellStart" src="start.mp3"></audio>
    <audio id="bellEnd" src="end.mp3"></audio>

    <div id="autoSaveStatus">üíæ Auto Saved</div>

<div id="securityOverlay">
        <style>
            #securityOverlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #000; z-index: 99999;
                /* FLEXBOX CENTERING - KEEPS IT IN MIDDLE */
                display: flex; 
                justify-content: center; 
                align-items: center;
                font-family: 'Poppins', sans-serif;
            }
            .login-card {
                width: 500px; padding: 35px; text-align: center;
                border: 2px solid #FFD700; border-radius: 20px;
                background: #050505;
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.15);
                position: relative;
                margin: 0; /* Ensures no offset */
            }
            /* Double Border Effect */
            .login-card::before {
                content: ''; position: absolute;
                top: 6px; left: 6px; right: 6px; bottom: 6px;
                border: 1px solid #c5a059; border-radius: 15px;
                pointer-events: none;
            }
            
            /* Profile Image Circle */
            .profile-circle {
                width: 100px; height: 100px; margin: 0 auto 20px auto;
                border-radius: 50%; overflow: hidden;
                border: 3px solid #00e676;
                box-shadow: 0 0 20px #00e676;
                background: #111;
            }
            .profile-circle img { 
                width: 100%; height: 100%; 
                object-fit: cover; 
            }

            /* Green Pill Badge */
            .welcome-pill {
                display: inline-block; padding: 6px 20px;
                border: 1px solid #00e676; border-radius: 50px;
                color: #00e676; font-size: 11px; font-weight: bold; letter-spacing: 2px;
                margin-bottom: 20px; text-transform: uppercase;
                background: rgba(0, 230, 118, 0.05);
            }

            .main-title {
                font-family: 'Cinzel', serif; color: #eecda3;
                background: linear-gradient(to right, #fbf5b7, #eecda3);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                font-size: 26px; font-weight: 900; line-height: 1.3; margin-bottom: 25px;
                text-transform: uppercase;
            }

            .input-box {
                background: #0b1016; border: 1px solid #334455;
                color: #fff; width: 100%; padding: 12px;
                border-radius: 8px; text-align: center; font-size: 16px;
                margin-bottom: 15px; letter-spacing: 1px; outline: none;
                transition: 0.3s;
            }
            .input-box:focus { border-color: #00e676; box-shadow: 0 0 10px rgba(0, 230, 118, 0.2); }

            .auth-btn {
                background: linear-gradient(to right, #004d40, #00695c);
                color: #fff; width: 100%; padding: 12px;
                border: 1px solid #00e676; border-radius: 8px;
                font-size: 15px; font-weight: bold; cursor: pointer;
                text-transform: uppercase; letter-spacing: 1px;
                transition: 0.3s;
            }
            .auth-btn:hover { background: #00695c; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

            /* Updated Disclaimer Style */
            .disclaimer-box {
                margin-top: 20px; padding: 12px;
                background: rgba(255, 215, 0, 0.03);
                border: 1px dashed #554400; border-radius: 8px;
                font-size: 11px; color: #bbb; line-height: 1.5;
            }

            .footer-info { margin-top: 20px; color: #666; font-size: 10px; line-height: 1.6; }
            .highlight-name { color: #fff; font-weight: bold; }
            .reg-no { color: #00e676; }
            
            .unauth-badge {
                display: inline-block; margin-top: 8px; padding: 4px 12px;
                border: 1px solid #ff5252; color: #ff5252;
                border-radius: 4px; font-size: 9px; font-weight: bold;
                background: rgba(255, 82, 82, 0.1);
            }
            .support-line { color: #2196f3; font-weight: bold; margin-top: 5px; font-size: 11px; }
        </style>

        <div class="login-card">
            <div class="profile-circle">
                <img src="images/ali.png" alt="Ali Ibrahim Didi">
            </div>

            <div class="welcome-pill">WARM WELCOME TO</div>

            <div class="main-title">
                Rasfahi <br> Judging Software
            </div>

            <p style="color:#aaa; font-size:11px; margin-bottom:5px;">Paste code: <b>Ctrl + V</b> (No Spaces)</p>
            
            <input type="password" id="secKey" class="input-box" placeholder="P a s t e   K e y   H e r e . . .">
            
            <button class="auth-btn" onclick="unlockSystem()">AUTHENTICATE</button>
            <p id="secMsg" style="color:#ff5252; margin-top:5px; font-size:11px; height:15px;"></p>

            <div class="disclaimer-box">
                <strong style="color:#FFD700; letter-spacing:0.5px;">‚ö†Ô∏è VERIFICATION REQUIRED:</strong><br>
                Please verify Quran verses with or compare with the Madina Mus'haf <span style="color:#fff; font-weight:bold;">ensure conformity</span> of Dhivehi translations with the official government text before display.<br>
                <span style="opacity:0.6; font-style:italic; font-size:10px;">Qur'an Data sourced from Tanzil.net.</span>
            </div>

            <div class="footer-info">
                Intellectual property of <span class="highlight-name">Ali Ibrahim Didi</span>.<br>
                Reg: <span class="reg-no">MED.03.IP.CR.26.EW5889</span>
                
                <div style="margin-top:5px;">
                    <div class="unauth-badge">‚õî UNAUTHORIZED USE PROHIBITED</div>
                </div>
                
                <div class="support-line">Support: 7791550 / 9901550</div>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div class="header">
            <h1 class="app-title" data-translate="title">RASFAHI JUDGE V26.0</h1>
            <div style="font-size:10px; color:#aaa; margin-top:2px;">Ultimate Upgrade Edition</div>
        </div>

        <div class="content">
            <div class="lang-bar">
                <button class="lang-btn active" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                <button class="lang-btn" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                <button class="lang-btn" onclick="setLang('en')">English</button>
            </div>
            
            <div id="licenseDisplay" style="display:none; background:#e3f2fd; color:#00008b; text-align:center; font-weight:bold; font-size:13px; padding:8px; margin-bottom:10px; border-radius:4px; border: 1px solid #00008b;">
                Licensed To: <span id="licenseName"></span>
            </div>
            <div class="panel" style="border: 1px solid #FFD700; background: linear-gradient(180deg, #001a00, #000);">
    <h2 style="color: #FFD700; font-family:'Cinzel', serif;">‚òÖ ﬁùﬁßﬁÄﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ (Master V12)</h2>

    <div style="margin-bottom:10px; border-bottom:1px dashed #555; padding-bottom:10px;">
        
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <button class="btn-gold" style="flex:1; padding:10px; font-weight:bold;" onclick="openExtraScreen()">
                üñ•Ô∏è STUDENT
            </button>
            
            <button class="btn-purple" style="flex:1; padding:10px; font-weight:bold; border-color:#d500f9;" onclick="openJudgeMirror()">
                ‚öñÔ∏è JUDGE
            </button>
        </div>
        
        <div id="exMonitor" style="background:#000; color:#FFD700; padding:5px; text-align:center; font-size:11px; border:1px solid #333; margin-bottom:5px;">
            [IDLE]
        </div>
        
        <div style="display:flex; gap:5px;">
            <button class="btn-blue" style="flex:1; padding:10px;" onclick="extraPrevQ()">
                ‚óÄ PREV
            </button>
            <button id="btnNextQ" class="btn-green" style="flex:2; padding:10px;" onclick="extraNextQ()">
                START / NEXT ‚ñ∂
            </button>
        </div>
    </div>
    <div style="background:#111; padding:5px; border:1px dashed #555; margin-bottom:5px;">
        <label style="color:#00e676; font-size:11px;">1. ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ (CSV) ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß:</label>
        <a href="QuranQuestion-text.html" target="_blank" 
       style="display:block; width:100%; text-align:center; padding:6px; margin: 5px 0; text-decoration:none; color:white; background:#e65100; border-radius:4px; font-weight:bold; font-size:11px; border:1px solid #ff9800;">
       ‚ö° ﬁìﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁñﬁ¨ﬁÇﬁ¨ﬁÉﬁ≠ﬁìﬁ¶ﬁÉ ﬁÄﬁ™ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁß
    </a>
        <input type="file" id="extraCSV" accept=".csv" onchange="loadExtraCSV(this)" style="width:100%;">
        <div id="extraStatus" style="font-size:10px; color:#FFD700; margin-top:2px;">Waiting for CSV...</div>
    </div>

    <hr style="border-color:#444; margin:5px 0;">

    <label style="color:#FFD700;">2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Filter):</label>
    <div style="margin-bottom:5px;">
        <select id="filterType" onchange="toggleFilterUI()" style="background:#003300; color:#fff; width:100%;">
            <option value="juz">By Juz (ﬁäﬁÆﬁåﬁ∞ ﬁàﬁ¶ﬁÜﬁ®ﬁÇﬁ∞)</option>
            <option value="surah">By Surah (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ﬁàﬁ¶ﬁÜﬁ®ﬁÇﬁ∞)</option>
        </select>
    </div>

    <div id="divJuzSelect" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <div><small>ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞</small><select id="startJuz" class="filter-dd" style="width:100%"></select></div>
        <div><small>ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞</small><select id="endJuz" class="filter-dd" style="width:100%"></select></div>
    </div>
    <div id="divSurahSelect" style="display:none; grid-template-columns: 1fr 1fr; gap:5px;">
        <div><small>ﬁäﬁ¶ﬁÅﬁß ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</small><select id="startSurah" class="filter-dd" style="width:100%"></select></div>
        <div><small>ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞</small><select id="endSurah" class="filter-dd" style="width:100%"></select></div>
    </div>

    <button class="btn-red" style="width:100%; margin-top:5px; font-size:11px;" onclick="resetExtraSession()">
        üîÑ APPLY FILTER & GENERATE GRID
    </button>

    <hr style="border-color:#444; margin:8px 0;">

    <label style="color:#FFD700;">3. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞:</label>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
        <div>
            <small>ﬁÇﬁ¶ﬁéﬁß ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™ (1-100):</small>
            <input type="number" id="exPickCount" value="3" min="1" max="100" style="background:#222; color:#fff; font-weight:bold;">
        </div>
        <div>
            <small>ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁéﬁÆﬁåﬁ∞:</small>
            <select id="exMode" onchange="updateExtraScreen('mode', this.value)" style="background:#330000; color:#fff;">
                <option value="tilawa">ﬁåﬁ®ﬁçﬁßﬁàﬁ¶ﬁåﬁ™ (Text)</option>
                <option value="hifz">ﬁôﬁ®ﬁäﬁ∞ﬁ°ﬁ™ (Hidden)</option>
            </select>
        </div>
    </div>

    <div style="margin-bottom:5px;">
        <small>Select Theme (50 Styles):</small>
        <select id="exTheme" onchange="updateExtraScreen('theme', this.value)" style="width:100%; background:#000; color:#FFD700; border:1px solid #555;">
            <optgroup label="ROYAL GREEN (ﬁéﬁ¶ﬁãﬁ¶ ﬁäﬁ¨ﬁÄﬁ®)">
                <option value="green_1" selected>1. Emerald & Gold (Double)</option>
                <option value="green_2">2. Deep Forest (Rounded)</option>
                <option value="green_3">3. Islamic Pattern</option>
                <option value="green_4">4. Green Velvet</option>
                <option value="green_5">5. Neon Green Border</option>
                <option value="green_6">6. Olive & Bronze</option>
                <option value="green_7">7. Mint Royal</option>
                <option value="green_8">8. Dark Moss (Square)</option>
                <option value="green_9">9. Green Gradient</option>
                <option value="green_10">10. Sultan's Green</option>
            </optgroup>
            <optgroup label="ROYAL BLUE (ﬁéﬁ¶ﬁãﬁ¶ ﬁÇﬁ´)">
                <option value="blue_1">11. Midnight Blue (Gold)</option>
                <option value="blue_2">12. Ocean Deep (Silver)</option>
                <option value="blue_3">13. Sapphire Box</option>
                <option value="blue_4">14. Navy Presidential</option>
                <option value="blue_5">15. Electric Blue Glow</option>
                <option value="blue_6">16. Azure & White</option>
                <option value="blue_7">17. Royal Teal</option>
                <option value="blue_8">18. Blue Velvet</option>
                <option value="blue_9">19. Night Sky</option>
                <option value="blue_10">20. Blue Diamond</option>
            </optgroup>
            <optgroup label="PRESIDENTIAL RED (ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁåﬁ∞)">
                <option value="red_1">21. Burgundy Gold</option>
                <option value="red_2">22. Ruby Red (Rounded)</option>
                <option value="red_3">23. Maroon Majestic</option>
                <option value="red_4">24. Red Carpet</option>
                <option value="red_5">25. Crimson Glow</option>
                <option value="red_6">26. Blood Red & Black</option>
                <option value="red_7">27. Rose Gold</option>
                <option value="red_8">28. Red Square Classic</option>
                <option value="red_9">29. Fire Gradient</option>
                <option value="red_10">30. Imperial Red</option>
            </optgroup>
            <optgroup label="ONYX BLACK & GOLD (ﬁÜﬁ¶ﬁÖﬁßﬁáﬁ® ﬁÉﬁ¶ﬁÇﬁ∞)">
                <option value="black_1">31. Pure Black & Gold</option>
                <option value="black_2">32. Onyx & Silver</option>
                <option value="black_3">33. Matte Black</option>
                <option value="black_4">34. Black Marble</option>
                <option value="black_5">35. Golden Frame</option>
                <option value="black_6">36. Dark Knight</option>
                <option value="black_7">37. Luxury Carbon</option>
                <option value="black_8">38. Black & Platinum</option>
                <option value="black_9">39. Shadow Box</option>
                <option value="black_10">40. Black Minimal</option>
            </optgroup>
            <optgroup label="SPECIAL MIX (ﬁâﬁ®ﬁÜﬁ∞ﬁêﬁ∞)">
                <option value="mix_1">41. Purple & Gold</option>
                <option value="mix_2">42. White Gold (Clean)</option>
                <option value="mix_3">43. Bronze Age</option>
                <option value="mix_4">44. Copper Style</option>
                <option value="mix_5">45. Pearl White</option>
                <option value="mix_6">46. Sunset Royal</option>
                <option value="mix_7">47. Lavender Mist</option>
                <option value="mix_8">48. Chocolate & Gold</option>
                <option value="mix_9">49. Gray Scale</option>
                <option value="mix_10">50. Glass Morphism</option>
            </optgroup>
        </select>
    </div>

    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
        <small>Text Color:</small>
        <input type="color" id="exTextColor" value="#ffffff" oninput="updateExtraScreen('textColor', this.value)" style="flex:1; height:30px;">
    </div>

    <div class="control-row" style="margin-bottom:2px;">
        <label style="width:60px; font-size:10px;">Box W:</label>
        <input type="range" class="range-slider" min="50" max="100" value="90" oninput="updateExtraScreen('boxW', this.value)">
    </div>
    <div class="control-row" style="margin-bottom:2px;">
        <label style="width:60px; font-size:10px;">Box H:</label>
        <input type="range" class="range-slider" min="30" max="98" value="80" oninput="updateExtraScreen('boxH', this.value)">
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:2px;">
        <div class="control-row">
            <label style="width:30px; font-size:10px;">X:</label>
            <input type="range" class="range-slider" min="-200" max="200" value="0" oninput="updateExtraScreen('textX', this.value)">
        </div>
        <div class="control-row">
            <label style="width:30px; font-size:10px;">Y:</label>
            <input type="range" class="range-slider" min="-200" max="200" value="0" oninput="updateExtraScreen('textY', this.value)">
        </div>
    </div>

    <div class="control-row">
        <label style="width:60px; color:#00e676;">ZOOM:</label>
        <input type="range" class="range-slider" min="2" max="15" step="0.5" value="6" oninput="updateExtraScreen('zoom', this.value)">
    </div>
</div>
<div class="panel" style="border: 1px solid #e91e63;">
    <h2 style="color: #e91e63;">‚òÖ ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞ ﬁêﬁ∞ﬁÜﬁØﬁÉﬁ®ﬁÇﬁ∞ﬁé</h2>
    <div style="background:#1a000d; padding:10px; border:1px dashed #e91e63;">
        <label>Select Judge ID to Enter:</label>
        <select id="manualJudgeSelect" style="margin-bottom:5px;">
            <option value="Judge_1">Judge 1</option>
            <option value="Judge_2">Judge 2</option>
            <option value="Judge_3">Judge 3</option>
            <option value="Judge_4">Judge 4</option>
            <option value="Judge_5">Judge 5</option>
        </select>

        <div id="manualEntryContainer"></div> 
        
        <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px solid #555; padding-top:5px;">
            <span style="color:#fff; font-weight:bold;">TOTAL:</span>
            <span id="manualTotalDisplay" style="color:#00e676; font-weight:bold; font-size:22px;">0.00</span>
        </div>

        <button class="btn-purple" style="margin-top:10px;" onclick="saveManualScore()">üíæ Save to System</button>
    </div>
</div>

            <div class="panel panel-live">
                <h2 data-translate="liveCtrl">1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Live)</h2>
                
                <div id="statusDisplay">WAITING...</div>
                
                <div class="mode-switch">
                    <button id="modeJudge" class="mode-btn active" onclick="setMode('judge')" data-translate="mJudge">‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)</button>
                    <button id="modeStudent" class="mode-btn" onclick="setMode('student')" data-translate="mStudent">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)</button>
                </div>

                <div class="read-switch">
                    <button id="rmMushaf" class="read-btn active" onclick="setReadingMode('mushaf')" data-translate="rmMushaf">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</button>
                    <button id="rmMemory" class="read-btn" onclick="setReadingMode('memory')" data-translate="rmMemory">üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</button>
                </div>

                <div id="judgeControls">
                    <button class="btn-gold" style="padding:12px;" onclick="pickRandomQuestion()" data-translate="btnPick">üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)</button>
                </div>

                <div id="studentControls" class="hidden">
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-blue" onclick="toggleGridScreen(true)" data-translate="btnShowGrid">1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß (Show Grid)</button>
                        <button class="btn-gold" onclick="reshuffleGrid()" data-translate="btnShuffle">üîÑ ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    </div>
                    
                    <div id="selectionInfo" style="background:#000; padding:5px; border:1px solid #444; margin:5px 0; font-size:12px; text-align:center; color:var(--gold);">
                        No selection yet.
                    </div>

                    <button id="btnStartReading" class="btn-green hidden" onclick="startReadingSession()" data-translate="btnStartQ1">2. ﬁäﬁ¶ﬁÅﬁß (Start Question 1)</button>
                </div>

                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-gold" style="width:30%;" onclick="prevQuestion()" data-translate="btnPrev">‚óÄ Previous</button>
                    <button class="btn-gold" style="flex:1;" onclick="nextQuestion()" data-translate="btnNext">Next Question ‚è©</button>
                </div>

                <div id="slotGrid"></div>

                <hr style="border-color:#334455; margin:15px 0;">

                <div style="display:flex; gap:10px;">
                    <button class="btn-green" onclick="toggleBell(true)" data-translate="btnBellStart">üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                    <button class="btn-red" onclick="toggleBell(false)" data-translate="btnBellStop">üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                </div>

                <button style="margin-top:10px; background:#442222; border:1px solid #aa3333;" onclick="resetStudentSession()" data-translate="btnReset">üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)</button>
            </div>

            <div class="panel">
                <h2 data-translate="lblSyllabus">2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)</h2>
                
                <label data-translate="lblFilterType">ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:</label>
                <select id="filterType" onchange="updateFilterUI()">
                    <option value="book" selected>By Book/Juz (ﬁäﬁÆﬁåﬁ™ﬁÇﬁ∞)</option>
                    <option value="surah">By Surah Order (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ™ﬁÇﬁ∞)</option>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label id="lblStartVal">ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start):</label>
                        <input type="number" id="scopeStart" value="1" placeholder="Start">
                    </div>
                    <div>
                        <label id="lblEndVal">ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End):</label>
                        <input type="number" id="scopeEnd" value="30" placeholder="End">
                    </div>
                </div>

                <button class="btn-green" onclick="applySyllabusFilter()" style="margin-top:10px;">‚úÖ Apply Syllabus</button>
                <div id="scopeStatus" style="font-size:11px; color:#aaa; margin-top:5px; text-align:center;">
                    System contains all questions.
                </div>
            </div>

            <div class="panel">
                <h2 data-translate="screens">3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</h2>
                
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn-blue" onclick="saveConfig()">üíæ SAVE Config</button>
                    <button class="btn-orange" onclick="document.getElementById('loadConf').click()">üìÇ LOAD Config</button>
                    <input type="file" id="loadConf" accept=".json" class="hidden" onchange="loadConfig(this)">
                </div>
<label>4. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:</label>
<button onclick="openStarScreen()" class="btn-blue" style="background: linear-gradient(to bottom, #001a33, #000d1a); border-color: #00e676;">
    ‚≠ê Open Star Rating Screen
</button>
                <button class="btn-red" onclick="clearCache()" style="font-size:10px; margin-bottom:10px;">üßπ Purge Memory (Clear Cache)</button>

                <label data-translate="lblStudent">1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:</label>
                <button onclick="openScreen('student')" class="btn-purple" data-translate="btnLaunchStudent">üñ•Ô∏è Student Screen (Launch)</button>

                <label data-translate="lblJudge">2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ (Manual Entry):</label>
   <div style="display:flex; gap:5px;">
        <select id="targetJudgeSelect" style="width:50%;">
            <option value="1">Judge 1</option>
            <option value="2">Judge 2</option>
            <option value="3">Judge 3</option>
            <option value="4">Judge 4</option>
            <option value="5">Judge 5</option>
            <option value="6">Judge 6</option>
            <option value="7">Judge 7</option>
        </select>
        
        <button onclick="openSingleJudge()" class="btn-blue" data-translate="btnLaunchJudges">
            Open Screen üñ•Ô∏è
        </button>
    </div>

    <div style="margin-top:10px; padding:5px; border:1px dashed #334455; background:#000;">
        <small style="color:#aaa; display:block; margin-bottom:5px;">Set Judge Names (Optional):</small>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="jName1" placeholder="Judge 1 Name">
            <input type="text" id="jName2" placeholder="Judge 2 Name">
            <input type="text" id="jName3" placeholder="Judge 3 Name">
            <input type="text" id="jName4" placeholder="Judge 4 Name">
            <input type="text" id="jName5" placeholder="Judge 5 Name">
            <input type="text" id="jName6" placeholder="Judge 6 Name">
            <input type="text" id="jName7" placeholder="Judge 7 Name">
        </div>
    </div>
    </div>

<div class="panel">
                <h2 data-translate="settings">4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß</h2>
                
               <label style="color:#00e676;">‚òÖ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ∞ﬁìﬁØﬁçﬁ∞ (App Font):</label>
<div style="display:flex; gap:5px;">
    <input type="file" id="fontLoader" accept=".ttf,.otf,.woff,.woff2" style="border-color:#00e676;">
    
    <a href="https://drive.google.com/drive/folders/1t39hcv1wEn22fEJVn7jDc5SupKhJ1CYo?usp=sharing" 
       target="_blank" 
       class="btn-green" 
       style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #00e676;">
       ‚¨áÔ∏è Download Font
    </a>
</div>
<small style="color:#666; font-size:10px;">Select .TTF or .WOFF file for Faruuma/Waheed</small>
                
                <hr style="border-color:#333; margin:8px 0;">

                <label>1. Royal Theme Engine (Main App):</label>
                <select id="themeSelect" onchange="updateTheme()">
                    </select>

                <label data-translate="lblCSV">2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
    <a href="QuranQuestionBank.html" target="_blank" class="btn-orange" 
   style="display:block; width:100%; text-align:center; padding:8px; margin-bottom:8px; text-decoration:none; color:white; border-radius:4px; font-weight:bold; font-size:12px; border:1px solid #ff9800; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
   ‚ö° ﬁáﬁ¶ﬁáﬁ™ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁêﬁ¨ﬁìﬁ¨ﬁáﬁ∞ ﬁáﬁ™ﬁäﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß (Generator)
</a>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="csvQ" accept=".csv">
                    <a href="quran-png.html" target="_blank" class="btn-purple" style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #7c4dff;">
                        ‚¨áÔ∏è Sample / Bank
                    </a>
                </div>
                
                <label data-translate="lblImg">3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ (Folder):</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="imgF" webkitdirectory directory multiple>
                    <a href="https://drive.google.com/drive/folders/1ihATXy_TIQZOU5qlXll-5c7SbNRdpsPO?usp=sharing" 
                       target="_blank" 
                       class="btn-blue" 
                       style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #0059b3;">
                       ‚¨áÔ∏è Download Images
                    </a>
                </div>
                <small id="imgStatus" style="color:#aaa; display:block;">No images loaded</small>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label data-translate="lblBorder">ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:</label>
                        <select id="borderStyle" onchange="syncWindows()">
                            <option value="royal">Royal Frame</option>
                            <option value="custom">Custom Img</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div>
                        <label data-translate="lblQCount">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:</label>
                        <select id="qLimit" onchange="resetStudentSession()">
                            <script>
                                for(let i=1; i<=20; i++) document.write(`<option value="${i}" ${i===3?'selected':''}>${i}</option>`);
                            </script>
                        </select>
                    </div>
                </div>
                <input type="file" id="borderImg" accept="image/*" class="hidden" style="margin-top:5px;">
            </div>
            
           <div class="panel">
    <h2 style="color:#ff9800;">5. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ (Student Info)</h2>
    
    <label>1. Bulk Import (Master Sheet CSV):</label>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="file" id="batchCsv" accept=".csv">
        <button class="btn-blue" onclick="loadStudentBatch()">Load Batch</button>
    </div>

    <div style="display:flex; gap:5px; margin-top:5px;">
    <button class="btn-purple" onclick="window.open('https://drive.google.com/drive/folders/1_kvu6nbfRpJueDFZqkgc-6NT3stBSLff?usp=sharing', '_blank')" style="flex:1; font-size:11px;">
        ‚¨áÔ∏è Blank Template (Drive)
    </button>
    
    <button class="btn-orange" onclick="window.open('https://drive.google.com/drive/folders/1_kvu6nbfRpJueDFZqkgc-6NT3stBSLff?usp=sharing', '_blank')" style="flex:1; font-size:11px;">
        ü§ñ Sample Data (Drive)
    </button>
</div>
    <small style="color:#aaa;">Use Fake Data to test the Master Sheet format.</small>

    <hr style="border-color:#333; margin:8px 0;">
    
  <label>2. Select Student (Search & Select):</label>
    
    <input list="studentDatalist" id="studentSearchInput" 
           placeholder="üîç ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß..." 
           onchange="onStudentSelected(this.value)"
           style="margin-bottom:5px; border:1px solid #FFD700; background:#001a33; color:#fff; font-weight:bold;">
           
    <datalist id="studentDatalist"></datalist>
    <div style="margin-top:10px; border:1px dashed #444; padding:5px;">
        <label>Personal Details:</label>
        <input type="text" id="stdName" placeholder="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞ (Full Name)">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="stdID" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ID Card)">
            <input type="text" id="stdReg" placeholder="ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ© (Reg No)">
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <select id="stdGender">
                <option value="Male">ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞ (Male)</option>
                <option value="Female">ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞ (Female)</option>
            </select>
            <input type="text" id="stdPhone" placeholder="ﬁäﬁØﬁÇﬁ™ (Contact)">
        </div>

        <input type="text" id="stdAddr" placeholder="ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞ (Address)">

        <label style="margin-top:5px;">Competition Details:</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <select id="stdGroup">
                <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="General">ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®</option>
            </select>
            <input type="text" id="stdBranch" placeholder="ﬁéﬁÆﬁäﬁ® (Branch)">
        </div>
        <input type="text" id="stdInst" placeholder="ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß (Institution)">

        <label style="margin-top:5px;">Parent Info:</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="stdParent" placeholder="ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß (Parent)">
            <input type="text" id="stdParentPhone" placeholder="ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™">
        </div>
        <input type="text" id="stdEmail" placeholder="ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞ (Email)">

        <button class="btn-green" style="margin-top:10px;" onclick="registerStudent()">üíæ Register & Set Active</button>
    </div>
    
    <p style="font-size:10px; color:#aaa; margin-top:5px;" id="currentStdLabel">No student active.</p>
</div>
            
            <div class="panel">
                <h2 style="color:#ff4081;">7. ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ®ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁ¶ﬁàﬁßﬁáﬁ®ﬁãﬁ™ (Rubric)</h2>
                
                <label>1. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁëﬁ®ﬁëﬁ¶ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞:</label>
                <input type="text" id="deductionStepsInput" value="0.25, 0.5, 1, 2" placeholder="e.g. 0.5, 1, 2" onchange="updateDeductionSteps()">
                <small style="color:#aaa;">Comma separated values for deduction buttons</small>
                
                <hr style="border-color:#333; margin:8px 0;">

                <label>2. ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁáﬁ∞ (Categories & Max Marks):</label>
                <div id="rubricConfigList"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="newRubricName" placeholder="New Category Name">
                    <input type="number" id="newRubricMax" placeholder="Max" style="width:60px;">
                    <button class="btn-blue" style="width:40px;" onclick="addRubricItem()">+</button>
                </div>
                <button class="btn-gold" style="margin-top:5px; font-size:11px;" onclick="syncWindows()">üîÑ Update Judges Screens</button>
            </div>

            <div class="panel" style="border:1px solid #00acc1; box-shadow:inset 0 0 10px rgba(0,172,193,0.1);">
    <h2 style="color:#00e5ff;">8. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß & ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ (Advanced Reports)</h2>

    <div style="background:#002200; padding:10px; border-radius:4px; margin-bottom:10px;">
        <h4 style="margin:0; color:#fff;">Current Session Scores:</h4>
        <div id="adminScoreMonitor" style="font-size:12px; color:#aaa; margin-top:5px;">Waiting for judges...</div>
        <button class="btn-green" id="btnFinalize" style="margin-top:5px;" onclick="finalizeStudentResult()">‚úÖ Save Student Result</button>
    </div>

    <hr style="border-color:#333; margin:8px 0;">

    <label style="color:#FFD700;">1. Report Headers (ﬁÉﬁ®ﬁïﬁØﬁìﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™):</label>
    <input type="text" id="rptInstName" placeholder="Institution Name (e.g. Madharusathul Arabiyya)">
    <input type="text" id="rptCompName" placeholder="Competition Name (e.g. Quran Mubaaraaiy 1446)" style="margin-top:2px;">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
        <input type="text" id="rptChief" placeholder="Chief Judge Name">
        <select id="rptJudgeCount">
            <option value="3">3 Signature Lines</option>
            <option value="5">5 Signature Lines</option>
            <option value="7">7 Signature Lines</option>
        </select>
    </div>

    <hr style="border-color:#333; margin:8px 0;">

    <label style="color:#FFD700;">2. Filter Category (ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ© ﬁÇﬁ¶ﬁéﬁß):</label>
    <div style="display:flex; gap:5px; flex-wrap:wrap;">
        <select id="rptFilterBranch" style="flex:1;">
            <option value="All">All Branches (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁÆﬁåﬁ∞ﬁïﬁ¨ﬁáﬁ∞)</option>
            <option value="Balaiygen">Balaiygen (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</option>
            <option value="Nubalai">Nubalai (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</option>
        </select>
        
        <select id="rptFilterGroup" style="flex:1;">
            <option value="All">All Ages (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ¨ﬁáﬁ∞)</option>
            <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="General">General (ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™)</option>
        </select>
        <select id="rptFilterInstType" style="flex:1;">
            <option value="All">All Inst. (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß)</option>
            <option value="School">Schools Only</option>
            <option value="Office">Offices Only</option>
            <option value="NGO">NGOs Only</option>
            <option value="University">Universities</option>
            <option value="Private">Private</option>
        </select>
    </div>
    <label style="margin-top:10px;">3. Generate Report (PDF / Print):</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
        <button class="btn-orange" onclick="generateAdvancedReport('top3')">ü•â Top 3</button>
        <button class="btn-cyan" onclick="generateAdvancedReport('top5')">üèÜ Top 5</button>
        <button class="btn-purple" onclick="generateAdvancedReport('all')">üìÑ Full List</button>
    </div>

<button class="btn-green" onclick="exportMasterResultSheet()">üì• Export FULL Master CSV</button>

<button class="btn-cyan" style="margin-top:5px; background:#00bcd4; color:black;" onclick="downloadDetailedManualSheet()">
    üìä A3 Manual Master Sheet (5 Judges)
</button>
                <button class="btn-purple" style="width:100%; margin-top:5px; border: 2px solid #fff; font-weight:bold;" onclick="printFullRubricBreakdown()">
    üìë PRINT FULL STUDENT RUBRIC (DETAILED)
</button>
<hr style="border-color:#333; margin:8px 0;">
<label style="color:#FFD700; font-family:'Faruuma';">‚òÖ ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞ (ﬁÇﬁØﬁìﬁ®ﬁêﬁ∞ ﬁÑﬁØﬁëﬁ™ & ﬁñﬁ¶ﬁñﬁ∞ ﬁùﬁ©ﬁìﬁ∞):</label>

<div style="background:#1a1a1a; padding:10px; border:1px solid #444; border-radius:5px;">
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="date" id="sessDate" style="flex:1; background:#000; color:#fff; border:1px solid #555;">
        <input type="time" id="sessTime" style="flex:1; background:#000; color:#fff; border:1px solid #555;">
    </div>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
         <input type="text" id="sessName" placeholder="ﬁãﬁ¶ﬁÇﬁ∞ﬁäﬁ¶ﬁÖﬁ® (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: ﬁÄﬁ¨ﬁÇﬁãﬁ™ﬁÇﬁ™)" style="flex:1; background:#000; color:#fff; border:1px solid #555; padding:5px;">
         <input type="text" id="sessHall" placeholder="ﬁÄﬁØﬁçﬁ™ / ﬁåﬁ¶ﬁÇﬁ∞ (Venue)" style="flex:1; background:#000; color:#fff; border:1px solid #555; padding:5px;">
    </div>

    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select id="sessFilterBranch" style="flex:1;">
            <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁÆﬁåﬁ∞ﬁïﬁ¨ﬁáﬁ∞ -</option>
            <option value="Balaiygen">ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞</option>
            <option value="Nubalai">ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®</option>
        </select>
        <select id="sessFilterGender" style="flex:1;">
            <option value="">- ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ -</option>
            <option value="Male">ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞</option>
            <option value="Female">ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞</option>
        </select>
    </div>
    
    <select id="sessFilterGroup" style="width:100%; margin-bottom:5px;">
        <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁßﬁáﬁ¨ﬁáﬁ∞ -</option>
        <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="Under 21">21 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
        <option value="General">ﬁÇﬁ™ﬁÜﬁ™ﬁÖﬁ¨ﬁãﬁ™ﬁÇﬁ∞ﬁåﬁ¨ﬁÉﬁ®ﬁÜﬁ¶ﬁÇﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁ¶</option>
    </select>

    <select id="sessFilterInst" style="width:100%; margin-bottom:5px; border-color:#00bcd4; color:#00e676;">
        <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁáﬁ¨ﬁáﬁ∞ (All) -</option>
        <option value="School">Schools Only (ﬁêﬁ∞ﬁÜﬁ´ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞)</option>
        <option value="University">Universities (ﬁîﬁ™ﬁÇﬁ®ﬁàﬁ¶ﬁÉﬁêﬁ®ﬁìﬁ©/ﬁÜﬁÆﬁçﬁ¨ﬁñﬁ∞)</option>
        <option value="Quran Class">Quran Classes (ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁÜﬁ∞ﬁçﬁßﬁêﬁ∞)</option>
        <option value="Club">Clubs/Jamiyya (ﬁÜﬁ∞ﬁçﬁ¶ﬁÑﬁ∞ ﬁñﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁîﬁß)</option>
        <option value="Private">Private (ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁéﬁÆﬁåﬁ™ﬁÇﬁ∞)</option>
    </select>

    <div style="display:flex; gap:5px; margin-bottom:10px; align-items:center;">
        <label style="color:#ccc; font-size:12px;">ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ©:</label>
        <select id="sessLimit" style="flex:1; background:#002200; color:#fff;">
            <option value="All">All (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞)</option>
            <option value="5">5 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="10">10 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="15">15 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="20">20 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="25">25 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="50">50 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="75">75 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
            <option value="100">100 ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞</option>
        </select>
    </div>

    <div style="display:flex; gap:5px;">
        <button class="btn-gold" style="flex:1; font-size:12px;" onclick="generateSessionList()">
            üìå Notice Board List
        </button>
        <button class="btn-cyan" style="flex:1; font-size:12px; font-weight:bold;" onclick="generateJudgeSessionSheet()">
            ‚öñÔ∏è Judge Mark Sheet
        </button>
    </div>
</div>
    <hr style="border-color:#333; margin:8px 0;">
    <label style="color:#FFD700; font-family:'Faruuma';">‚òÖ ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞ ﬁÄﬁßﬁíﬁ®ﬁÉﬁ© / ﬁáﬁ®ﬁ¢ﬁ™ﬁçﬁßﬁÇﬁ∞ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™:</label>
    
    <div style="background:#1a1a1a; padding:10px; border:1px solid #444; border-radius:5px;">
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="date" id="sessDate" style="flex:1; background:#000; color:#fff; border:1px solid #555;">
            <input type="time" id="sessTime" style="flex:1; background:#000; color:#fff; border:1px solid #555;">
        </div>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
             <input type="text" id="sessName" placeholder="ﬁãﬁ¶ﬁÇﬁ∞ﬁäﬁ¶ﬁÖﬁ® (ﬁâﬁ®ﬁêﬁßﬁçﬁ™: ﬁÄﬁ¨ﬁÇﬁãﬁ™ﬁÇﬁ™)" style="flex:1; background:#000; color:#fff; border:1px solid #555; padding:5px;">
        </div>

        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="sessFilterBranch" style="flex:1;">
                <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁÆﬁåﬁ∞ﬁïﬁ¨ﬁáﬁ∞ -</option>
                <option value="Balaiygen">ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞</option>
                <option value="Nubalai">ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®</option>
            </select>
            <select id="sessFilterGender" style="flex:1;">
                <option value="">- ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ -</option>
                <option value="Male">ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞</option>
                <option value="Female">ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞</option>
            </select>
        </div>
        
        <select id="sessFilterGroup" style="width:100%; margin-bottom:5px;">
            <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁßﬁáﬁ¨ﬁáﬁ∞ -</option>
            <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 21">21 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="General">ﬁÇﬁ™ﬁÜﬁ™ﬁÖﬁ¨ﬁãﬁ™ﬁÇﬁ∞ﬁåﬁ¨ﬁÉﬁ®ﬁÜﬁ¶ﬁÇﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁ¶</option>
        </select>

        <button class="btn-gold" onclick="generateSessionList()">
            üñ®Ô∏è Print Session List (PDF)
        </button>
    </div>
    <button class="btn-gold" style="margin-top:5px;" onclick="downloadManualScoreSheet()">üìÑ Print Blank Sheet (PDF)</button>
    <hr style="border-color:#333; margin:8px 0;">
    <label style="color:#FFD700; font-family:'Faruuma';">‚òÖ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁùﬁ©ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (ﬁÑﬁ¶ﬁçﬁ∞ﬁÜﬁ™ ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞):</label>
    <div style="background:#111; padding:10px; border:1px dashed #444; border-radius:5px;">
        <select id="bulkJudgeSelect" style="margin-bottom:5px;">
            <option value="Judge_1">Judge 1 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 1)</option>
            <option value="Judge_2">Judge 2 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 2)</option>
            <option value="Judge_3">Judge 3 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 3)</option>
            <option value="Judge_4">Judge 4 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 4)</option>
            <option value="Judge_5">Judge 5 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 5)</option>
            <option value="Judge_6">Judge 6 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 6)</option>
            <option value="Judge_7">Judge 7 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 7)</option>
        </select>
        <button class="btn-green" onclick="printBulkJudgeSheets()">
            üñ®Ô∏è Print All Sheets (PDF)
        </button>
    </div>
    <button class="btn-red" style="font-size:10px; margin-top:5px;" onclick="clearAllResults()">Reset All Data</button>
</div>

            <div class="panel" style="border:1px solid #00acc1; box-shadow:inset 0 0 10px rgba(0,172,193,0.1);">
                <h2 style="color:#00e5ff;">6. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ∞ (Ceremony)</h2>
                
                <label>1. ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Special Fonts):</label>
                <div style="display:flex; gap:5px; align-items:flex-start;">
                    <div style="flex:1;">
                        <input type="file" id="ceremonyQuranFont" accept=".ttf,.otf" style="margin-bottom:5px;">
                        <small style="color:#aaa; display:block; margin-bottom:5px;">Quran Font (e.g., Tanzil/Madina)</small>
                        
                        <input type="file" id="ceremonyTransFont" accept=".ttf,.otf">
                        <small style="color:#aaa; display:block;">Translation Font (e.g., Faruuma)</small>
                    </div>
                </div>
                
                <hr style="border-color:#333; margin:8px 0;">
                
                <label>2. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="file" id="ceremonyCSV" accept=".csv">
                </div>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="color:#FFD700;">‚òÖ ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ (Styles):</label>
                
                <div style="margin-bottom:8px;">
                    <small style="color:#aaa;">Ceremony Theme (20+ Royal Styles):</small>
                    <select id="ceremonyTheme" onchange="updateCeremonyState()">
                        <script>
                            const cThemes = [
                                "1. Royal Green (Gold Border)", "2. Royal Blue (Gold Border)", "3. Royal Red (Gold Border)",
                                "4. Emerald Green (Double Gold)", "5. Midnight Blue (Silver)", "6. Burgundy (Gold)",
                                "7. Green & Blue Mix", "8. Red & Black Mix", "9. Deep Purple",
                                "10. White & Gold (Light)", "11. Cream & Gold", "12. Black & Gold (Thin)",
                                "13. Green Gradient (Silver)", "14. Blue Gradient (Silver)", "15. Red Gradient (Silver)",
                                "16. Royal Teal", "17. Majestic Maroon", "18. Onyx Black (White)",
                                "19. Pearl White (Green)", "20. Presidential Mix"
                            ];
                            cThemes.forEach((t, i) => document.write(`<option value="${i}">${t}</option>`));
                        </script>
                    </select>
                </div>

                <div style="margin-top:8px; margin-bottom:8px; border-top:1px dashed #333; padding-top:5px;">
                    <label style="color:#FFD700;">‚òÖ ﬁêﬁ¨ﬁÉﬁ¶ﬁâﬁ¶ﬁÇﬁ© ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞:</label>
                    <select id="cBorderStyle" onchange="updateCeremonyState()">
                        <option value="theme">Use Theme Border (Default)</option>
                        <option value="thin">Very Thin Gold Line (ﬁÄﬁ®ﬁâﬁ¶ ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÉﬁÆﬁÇﬁéﬁ¨ﬁáﬁ∞)</option>
                        <option value="none">No Border (ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁçﬁß)</option>
                        <option value="custom">Custom Image Border (ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁÆﬁìﬁØ)</option>
                    </select>
                    
                    <input type="file" id="cBorderImgFile" accept="image/*" style="margin-top:5px;" onchange="loadCeremonyBorder(this)">
                </div>

                <div class="control-row">
                    <input type="color" id="cArabicColor" value="#D4AF37" class="color-picker" onchange="updateCeremonyState()" title="Arabic Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Arabic Size (ﬁ¢ﬁ¶ﬁÉﬁ¶ﬁÑﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cArabicSize" class="range-slider" min="5" max="25" step="0.5" value="12" oninput="updateCeremonyState()">
                    </div>
                </div>

                <div class="control-row">
                    <input type="color" id="cTransColor" value="#ffffff" class="color-picker" onchange="updateCeremonyState()" title="Translation Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Dhivehi Size (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cTransSize" class="range-slider" min="2" max="15" step="0.5" value="5" oninput="updateCeremonyState()">
                    </div>
                </div>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="margin-top:10px; color:#00e5ff;">3. ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁêﬁ¨ﬁçﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ (Selection):</label>
                
                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Surah (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</small>
                    <select id="cSurah" onchange="onSurahChange()">
                        <option value="">-- Select Surah --</option>
                    </select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Start Ayah No (ﬁäﬁ¶ﬁÅﬁß ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cStart" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">End Ayah No (ﬁÇﬁ®ﬁâﬁ≠ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cEnd" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Translation Language:</small>
                    <select id="cLang" onchange="onRangeChange()">
                        <option value="dv">Dhivehi (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)</option>
                        <option value="en">English (ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ®)</option>
                    </select>
                </div>

                <label>4. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ (Event Title):</label>
                <input type="text" id="ceremonyTitle" placeholder="e.g. Quran Competition Opening" oninput="updateCeremonyState()">

                <button onclick="openCeremonyScreen()" class="btn-orange" style="margin-top:10px;">üì∫ Launch Ceremony Screen</button>

                <hr style="border-color:#333; margin:10px 0;">
                
                <div style="background:#000; padding:10px; border-radius:4px; text-align:center;">
                    <div id="ceremonyPreview" style="color:var(--gold); font-size:14px; margin-bottom:5px;">IDLE</div>
                    <div style="display:flex; gap:5px; justify-content:center;">
                         <button class="btn-blue" onclick="ceremonyPrev()">‚óÄ</button>
                         <button class="btn-blue" onclick="ceremonyNext()">‚ñ∂</button>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:5px;">
                      <button class="btn-green" onclick="ceremonySetPhase('start')">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</button>
                      <button class="btn-red" onclick="ceremonySetPhase('end')">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè</button>
                </div>
                <button class="btn-gold" style="margin-top:5px;" onclick="ceremonySetPhase('cover')">Show Cover / Hide</button>

            </div>

</div> <div class="royal-footer">
    <a id="driveLink" href="#" target="_blank" class="drive-btn">
        üìÇ Open Google Drive Folder (Samples)
    </a>

    <p>Copyright Reserved</p>
    <p class="highlight">Ali Ibrahim Didi 7791550 & 9901550</p>
    <p>Zad Research and Consultancy Firm</p>
</div>
</div>

<div class="main-view">
    <div class="mirror-header">
        <span>LIVE VIEW (ADMIN MONITOR)</span>
        <span id="mirrorStatus" style="color:var(--gold);">IDLE</span>
    </div>

    <div id="secretaryPanel">
        
        <div id="secStudentBanner" style="display:none;"> <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="width:50px; height:50px; background:#000; border:1px solid #00e676; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:24px;">üë§</div>
                    
                    <div>
                        <h2 id="secName" style="color:#FFD700; margin:0; font-family:'Faruuma'; font-size:22px; line-height:1.2; border:none; padding:0;">-</h2>
                        <div style="color:#ccc; font-size:12px; margin-top:2px; font-family:sans-serif;">
                            <span id="secID" style="color:#00e676; font-weight:bold;">-</span> <span style="color:#555;">|</span> 
                            <span id="secReg">-</span> <span style="color:#555;">|</span> 
                            <span id="secAddr">-</span>
                        </div>
                    </div>
                </div>

                <div style="text-align:right; border-left:2px solid #333; padding-left:15px;">
                    <div id="secInst" style="color:#fff; font-weight:bold; font-size:14px; font-family:'Faruuma';">-</div>
                    <div style="color:#888; font-size:11px; margin-top:2px;">
                        <span id="secBranch">-</span> ‚Ä¢ <span id="secGroup">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sec-control-area">
            
            <div class="sec-left-box">
                <button class="btn-orange" style="width:100%; margin-bottom:5px; font-weight:bold;" onclick="openMatrixInput()">
    üñêÔ∏è 5 JUDGE MATRIX ENTRY
</button>
                <label style="color:#FFD700; font-size:11px; margin-top:0;">Score Entry For:</label>
                <select id="secJudgeSelect" style="background:#000; color:#fff; border:1px solid #555; width:100%; padding:8px; margin-bottom:10px; font-weight:bold;">
                    <option value="Judge_1">Judge 1</option>
                    <option value="Judge_2">Judge 2</option>
                    <option value="Judge_3">Judge 3</option>
                    <option value="Judge_4">Judge 4</option>
                    <option value="Judge_5">Judge 5</option>
                    <option value="Judge_6">Judge 6</option>
                    <option value="Judge_7">Judge 7</option>
                </select>

                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#000; border:1px dashed #333; margin-bottom:10px; border-radius:4px;">
                    <div style="font-size:10px; color:#666; text-transform:uppercase;">Current Total</div>
                    <div id="secTotalDisplay" style="font-size:36px; color:#00e676; font-weight:bold; font-family:sans-serif;">0.00</div>
                </div>

                <button id="btnSaveNext" class="btn-green" style="width:100%; padding:15px; font-weight:bold; font-size:14px; margin-top:10px;" onclick="saveAndNext()">
    üíæ SAVE & NEXT STUDENT ‚ñ∂
</button>
            </div>

            <div class="sec-table-wrapper">
                <table class="sec-table">
                    <thead>
                        <tr>
                            <th width="35%">Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)</th>
                            <th width="10%" style="text-align:center;">Max</th>
                            <th width="40%">Deductions (ﬁÜﬁ¨ﬁÇﬁëﬁ™ﬁÇﬁ∞)</th>
                            <th width="15%" style="text-align:center;">Score</th>
                        </tr>
                    </thead>
                    <tbody id="secRubricBody">
                        </tbody>
                </table>
            </div>

        </div>
    </div>
<div id="masterViewPanel">
    <div class="ms-filter-bar">
        <h4 style="color:#FFD700; margin:0; font-family:'Faruuma'; margin-right:10px;">ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁùﬁ©ﬁìﬁ∞:</h4>
        
        <input type="file" id="masterSheetInput" accept=".csv" style="display:none;" onchange="loadMasterSheetTable()">
        <button class="btn-blue" onclick="document.getElementById('masterSheetInput').click()" style="padding:5px 10px; font-size:11px;">üìÇ Load CSV</button>
        
        <button class="btn-orange" onclick="generateDetailedRankedCSV()" style="padding:5px 10px; font-size:11px; border:1px solid #ff9800; margin-left:5px; margin-right:5px;">
            ü§ñ Gen 2000 Dummy
        </button>
        
        <select id="filterBranch" onchange="renderMasterTable()" style="background:#000; color:#fff; border:1px solid #555; padding:5px;">
            <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁÆﬁåﬁ∞ﬁïﬁ¨ﬁáﬁ∞ -</option>
            <option value="Balaiygen">Balaiygen (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</option>
            <option value="Nubalai">Nubalai (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</option>
        </select>

        <select id="filterGroup" onchange="renderMasterTable()" style="background:#000; color:#fff; border:1px solid #555; padding:5px;">
            <option value="">- ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ¨ﬁáﬁ∞ -</option>
            <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="General">ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®</option>
        </select>
        
        <div style="flex:1; text-align:right; font-size:11px; color:#aaa; padding-right:10px;">
            Students: <span id="tableCount" style="color:#fff;">0</span>
        </div>
        
       <button class="btn-green" onclick="exportFullMasterSheet()" style="padding:5px 10px; font-size:11px; font-weight:bold; border:2px solid #00e676;">
            üì• EXPORT FULL LIST
        </button>

        <button onclick="downloadRubricMatrix()" style="background-color: #673AB7; color: white; padding: 5px 10px; font-size: 11px; font-weight: bold; border: 2px solid #512DA8; border-radius: 4px; cursor: pointer; margin-left: 5px;">
            üìä 7-PART MATRIX (5 JUDGES)
        </button>
        </div>
    <div class="ms-table-container">
        <table class="ms-table">
            <thead>
                <tr>
                    <th class="col-s">#</th>
                    <th class="col-m">Reg No</th>
                    <th class="col-l">Name (ﬁÇﬁ¶ﬁÇﬁ∞)</th>
                    <th class="col-m">ID Card</th>
                    <th class="col-m">Branch</th>
                    <th class="col-m">Age Group</th>
                    <th class="col-l">Institution</th>
                    
                    <th class="col-mark">J-1</th>
                    <th class="col-mark">J-2</th>
                    <th class="col-mark">J-3</th>
                    <th class="col-mark">J-4</th>
                    <th class="col-mark">J-5</th>
                    
                    <th class="col-final">AVG</th>
                    <th class="col-final">Rank</th>
                </tr>
            </thead>
            <tbody id="masterTableBody">
                <tr><td colspan="14" style="padding:20px; color:#555;">Please Load CSV File to View Data</td></tr>
            </tbody>
        </table>
    </div>
</div>
    <div id="adminMirror">
        <div id="gridPreview"></div>
        <div id="mirrorContainer" class="mirror-card" style="display:flex;">
            <div id="adminBanner" class="mirror-banner-strip" style="display:none;">
                <span>Book: <span id="mBook" class="mirror-info-span">-</span></span>
                <span>Surah: <span id="mSurah" class="mirror-info-span">-</span></span>
                <span>Ayah: <span id="mAyah" class="mirror-info-span">-</span></span>
            </div>
            <div class="mirror-img-container">
                <img id="mImg" src="" style="display:none;">
                <h1 id="mMemoryText" style="display:none; color: var(--gold); text-align:center; font-size: 30px; margin-top: 20%;">
                    (Memory Recitation Mode)
                </h1>
                <h2 id="mReadyText" style="display:none; color:#00e676; text-align:center; margin-top:20%;">READY TO START</h2>
                <h1 id="mFinishText" style="display:none; color:#ff5252; text-align:center; margin-top:20%; font-size:24px;"></h1>
            </div>
            <div id="adminWarn" style="position:absolute; bottom:5px; left:5px; color:#ff5252; font-size:11px; display:none; background:rgba(0,0,0,0.8); padding:2px;">‚ö†Ô∏è MEMORY MODE</div>
        </div>
        <div id="mirrorLight" style="position:absolute; bottom:20px; right:100px; width:30px; height:30px; background:#333; border-radius:50%; border:2px solid #555;"></div>
        <button id="royalFSBtn" onclick="toggleAppFullscreen()" title="Full Screen">‚õ∂</button>
    </div>
</div>

<script>
    // --- 0. SURAH LIST FOR FILTERING ---
    const SURAH_NAMES = [
        "al-fatiha", "al-baqarah", "ali 'imran", "an-nisa", "al-ma'idah", "al-an'am", "al-a'raf", "al-anfal", "at-tawbah", "yunus",
        "hud", "yusuf", "ar-ra'd", "ibrahim", "al-hijr", "an-nahl", "al-isra", "al-kahf", "maryam", "ta-ha",
        "al-anbiya", "al-hajj", "al-mu'minun", "an-nur", "al-furqan", "ash-shu'ara", "an-naml", "al-qasas", "al-ankabut", "ar-rum",
        "luqman", "as-sajdah", "al-ahzab", "saba", "fatir", "ya-sin", "as-saffat", "sad", "az-zumar", "ghafir",
        "fussilat", "ash-shura", "az-zukhruf", "ad-dukhan", "al-jathiyah", "al-ahqaf", "muhammad", "al-fath", "al-hujurat", "qaf",
        "adh-dhariyat", "at-tur", "an-najm", "al-qamar", "ar-rahman", "al-waqi'ah", "al-hadid", "al-mujadila", "al-hashr", "al-mumtahanah",
        "as-saff", "al-jumu'ah", "al-munafiqun", "at-taghabun", "at-talaq", "at-tahrim", "al-mulk", "al-qalam", "al-haqqah", "al-ma'arij",
        "nuh", "al-jinn", "al-muzzammil", "al-muddaththir", "al-qiyamah", "al-insan", "al-mursalat", "an-naba", "an-nazi'at", "abasa",
        "at-takwir", "al-infitar", "al-mutaffifin", "al-inshiqaq", "al-buruj", "at-tariq", "al-a'la", "al-ghashiyah", "al-fajr", "al-balad",
        "ash-shams", "al-layl", "ad-duha", "ash-sharh", "at-tin", "al-alaq", "al-qadr", "al-bayyinah", "az-zalzalah", "al-adiyat",
        "al-qari'ah", "at-takathur", "al-asr", "al-humazah", "al-fil", "quraysh", "al-ma'un", "al-kawthar", "al-kafirun", "an-nasr",
        "al-masad", "al-ikhlas", "al-falaq", "an-nas"
    ];

    // --- 0. SECURITY & CONFIG ---
    const GOOGLE_DRIVE_URL = "https://drive.google.com/drive/folders/YOUR_FOLDER_ID"; 
    document.getElementById('driveLink').href = GOOGLE_DRIVE_URL;

    // --- FONT LOADING ---
    document.getElementById('fontLoader').onchange = e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            state.fontData = evt.target.result;
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }`;
            document.head.appendChild(style);
            alert("Font Loaded Successfully! (Syncing to screens...)");
            saveToLocal();
            syncWindows();
        };
        reader.readAsDataURL(file);
    };

    // --- TRANSLATION DICTIONARY ---
    const i18n = {
        title: { dv: "ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ∞ V26.0", ar: "ÿßŸÑŸÇÿßÿ∂Ÿä ÿ±ÿµŸÅŸáŸä V26.0", en: "Rasfahi Judge V26.0" },
        lblSyllabus: { dv: "2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)", ar: "2. ÿßŸÑŸÖŸÜŸáÿ¨", en: "2. Syllabus Scope" },
        lblFilterType: { dv: "ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:", ar: "ŸÜŸàÿπ ÿßŸÑÿ™ÿµŸÅŸäÿ©:", en: "Filter Mode:" },
        liveCtrl: { dv: "1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", ar: "1. ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±", en: "1. Live Control" },
        mJudge: { dv: "‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)", ar: "‚öñÔ∏è Ÿàÿ∂ÿπ ÿßŸÑŸÇÿßÿ∂Ÿä (ÿ™ŸÑŸÇÿßÿ¶Ÿä)", en: "‚öñÔ∏è Judge Mode (Auto)" },
        mStudent: { dv: "üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)", ar: "üéì Ÿàÿ∂ÿπ ÿßŸÑÿ∑ÿßŸÑÿ® (ŸäÿØŸàŸä)", en: "üéì Student Mode (Manual)" },
        rmMushaf: { dv: "üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)", ar: "üìñ ÿßŸÑŸÖÿµÿ≠ŸÅ (ŸÜÿ∏ÿ±)", en: "üìñ Mushaf (Reading)" },
        rmMemory: { dv: "üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)", ar: "üß† ÿßŸÑÿ≠ŸÅÿ∏ (ÿ∫Ÿäÿ®)", en: "üß† Memory (Recital)" },
        btnPick: { dv: "üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)", ar: "üé≤ ÿßÿÆÿ™ÿ± ÿ≥ÿ§ÿßŸÑÿßŸã (ÿπÿ¥Ÿàÿßÿ¶Ÿä)", en: "üé≤ Pick Question (Random)" },
        btnShowGrid: { dv: "1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß", ar: "1. ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ®ŸÉÿ©", en: "1. Show Grid" },
        btnShuffle: { dv: "üîÑ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠", ar: "üîÑ ÿÆŸÑÿ∑", en: "üîÑ Shuffle" },
        btnStartQ1: { dv: "2. ﬁäﬁ¶ﬁÅﬁß (Start Q1)", ar: "2. ÿßÿ®ÿØÿ£ (ÿ≥ÿ§ÿßŸÑ 1)", en: "2. Start (Q1)" },
        btnPrev: { dv: "‚óÄ ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨", ar: "‚óÄ ÿßŸÑÿ≥ÿßÿ®ŸÇ", en: "‚óÄ Prev" },
        btnNext: { dv: "ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ‚è©", ar: "ÿßŸÑÿ™ÿßŸÑŸä ‚è©", en: "Next ‚è©" },
        btnBellStart: { dv: "üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üîî ÿßÿ®ÿØÿ£ (ÿ¨ÿ±ÿ≥)", en: "üîî Start (Bell)" },
        btnBellStop: { dv: "üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üõë ÿ™ŸàŸÇŸÅ (ÿ¨ÿ±ÿ≥)", en: "üõë Stop (Bell)" },
        btnReset: { dv: "üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)", ar: "üîÑ ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ (ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ)", en: "üîÑ New Student (Reset)" },
        screens: { dv: "3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞", ar: "3. ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™", en: "3. Screens & Config" },
        lblStudent: { dv: "1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "1. ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:", en: "1. Student Screen:" },
        btnLaunchStudent: { dv: "üñ•Ô∏è ﬁçﬁØﬁÇﬁ∞ﬁóﬁ∞ (Student)", ar: "üñ•Ô∏è ŸÅÿ™ÿ≠ (ÿßŸÑÿ∑ÿßŸÑÿ®)", en: "üñ•Ô∏è Launch (Student)" },
        lblJudge: { dv: "2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "2. ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇÿßÿ∂Ÿä:", en: "2. Judge Screen:" },
        btnLaunchJudges: { dv: "Open Judges üöÄ", ar: "ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ∂ÿßÿ© üöÄ", en: "Open Judges üöÄ" },
        settings: { dv: "4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß", ar: "4. ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™", en: "4. Settings & Data" },
        lblCSV: { dv: "2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):", ar: "2. ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (CSV):", en: "2. Question Data (CSV):" },
        lblImg: { dv: "3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ:", ar: "3. ÿµŸàÿ± ÿßŸÑÿ¢Ÿäÿßÿ™:", en: "3. Ayah Images:" },
        lblBorder: { dv: "ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:", ar: "ÿßŸÑÿ•ÿ∑ÿßÿ±:", en: "Border:" },
        lblQCount: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:", ar: "ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©:", en: "Question Count:" },
        msgFinished: { 
            dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", 
            ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", 
            en: "Questioning complete for the current limit!" 
        }
    };

    let currentLang = 'dv';
    let themeList = [];

    // --- 1. THEME ENGINE ---
    function initThemes() {
        const bases = [
            {n:"Royal Blue", c1:"#001a33", c2:"#000d1a", txt:"#ffffff"},
            {n:"Emerald Green", c1:"#002b15", c2:"#001a0d", txt:"#e6ffe6"},
            {n:"Burgundy Red", c1:"#2a0000", c2:"#1a0000", txt:"#ffe6e6"},
            {n:"Midnight Black", c1:"#111111", c2:"#000000", txt:"#ffffff"},
            {n:"Imperial Purple", c1:"#1a0033", c2:"#0d001a", txt:"#f2e6ff"}
        ];
        const accents = [
            {n:"Gold", c:"#D4AF37", b:"double"},
            {n:"Silver", c:"#C0C0C0", b:"ridge"},
            {n:"Bronze", c:"#cd7f32", b:"groove"},
            {n:"White Gold", c:"#f5f5dc", b:"solid"}
        ];

        const sel = document.getElementById('themeSelect');
        sel.innerHTML = ""; 
        let count = 1;
        
        bases.forEach(base => {
            accents.forEach(acc => {
                for(let i=1; i<=5; i++) { 
                     let variantName = i === 1 ? "Standard" : (i===2 ? "Dark" : (i===3 ? "Deep" : (i===4 ? "Vivid" : "Classic")));
                     let themeObj = {
                        name: `Theme ${count}: ${base.n} & ${acc.n} (${variantName})`,
                        bg1: base.c1, bg2: base.c2,
                        accent: acc.c, borderType: acc.b, text: base.txt,
                        id: count
                    };
                    themeList.push(themeObj);
                    let opt = document.createElement('option');
                    opt.value = count-1;
                    opt.innerText = themeObj.name;
                    sel.appendChild(opt);
                    count++;
                }
            });
        });
        
        if(themeList.length > 0) {
            state.theme = themeList[0];
            sel.value = 0;
        }
    }

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
        document.querySelector('.sidebar').style.borderLeft = (lang === 'en') ? 'none' : '3px solid var(--gold)';

        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if(i18n[key] && i18n[key][lang]) {
                el.innerText = i18n[key][lang];
            }
        });
        updateFilterUI();
        if(i18n.msgFinished[lang]) {
            document.getElementById('mFinishText').innerHTML = i18n.msgFinished[lang].replace(/\n/g, '<br>');
        }
        syncWindows();
    }

    function toggleAppFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
        } else {
            document.exitFullscreen();
        }
    }

    // --- STATE ---
    let state = {
        qPool: [],         
        filteredPool: [], 
        qUsed: [], qDataMap: {}, 
        pImages: {}, 
        fontData: null, borderData: null,
        windows: { student: null, judges: [], ceremony: null },
        session: { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false },
        mode: 'judge', readingMode: 'mushaf',
        grid: { map: {}, visible: false, taken: [] },
        theme: null,
        
        // Data Management
        allStudents: [], // Loaded from Batch CSV
        
        // Syllabus State
        syllabus: {
            active: false,
            type: 'book', 
            start: 1,
            end: 30
        },

        // Judging Data
        judging: {
            currentStudentObj: null,
            liveScores: {}, 
            savedResults: [], 
            deductionSteps: [0.25, 0.5, 1, 2], 
            rubric: [
                { name: "Thilawa", max: 30 },
                { name: "Tajweed", max: 20 },
                { name: "Makhraj", max: 20 },
                { name: "Sifa", max: 10 },
                { name: "Fasaha", max: 5 },
                { name: "Talaffuz", max: 5 },
                { name: "Maqamat", max: 5 },
                { name: "Quality", max: 5 }  // ‚òÖ ﬁâﬁ®ﬁáﬁÆﬁåﬁ© ﬁáﬁ¶ﬁçﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁÑﬁ¶ﬁáﬁ®
            ]
        },
        // Ceremony Data
        ceremony: {
            active: false,
            phase: 'cover',
            groupedData: {}, 
            activeData: [], 
            currentIndex: 0,
            selectedLang: 'dv',
            fonts: { quran: null, trans: null },
            settings: {
                themeIndex: 0,
                arabicColor: '#D4AF37',
                transColor: '#ffffff',
                arabicSize: 12,
                transSize: 5,
                borderStyle: 'theme',
                borderData: null      
            }
        }
    };

    // --- AUTO SAVE LOGIC ---
    function saveToLocal() {
        const d = {
            rubric: state.judging.rubric,
            savedResults: state.judging.savedResults,
            deductionSteps: state.judging.deductionSteps,
            allStudents: state.allStudents,
            header: document.getElementById('rptHeader').value,
            footer: document.getElementById('rptFooter').value
        };
        localStorage.setItem('rasfahi_v26_data', JSON.stringify(d));
        
        // Show indicator
        const ind = document.getElementById('autoSaveStatus');
        ind.style.opacity = 1;
        setTimeout(() => { ind.style.opacity = 0; }, 2000);
    }

    function loadFromLocal() {
        const raw = localStorage.getItem('rasfahi_v26_data');
        if(raw) {
            try {
                const d = JSON.parse(raw);
                if(d.rubric) state.judging.rubric = d.rubric;
                if(d.savedResults) state.judging.savedResults = d.savedResults;
                if(d.deductionSteps) state.judging.deductionSteps = d.deductionSteps;
                if(d.allStudents) { state.allStudents = d.allStudents; populateStudentSelector(); }
                if(d.header) document.getElementById('rptHeader').value = d.header;
                if(d.footer) document.getElementById('rptFooter').value = d.footer;
                
                // Update Inputs
                document.getElementById('deductionStepsInput').value = state.judging.deductionSteps.join(', ');
                renderRubricConfig();
                console.log("Auto-loaded data from LocalStorage");
            } catch(e) { console.error("Error loading local data", e); }
        }
    }

    // --- ADVANCED SECURITY UNLOCK (NEW) ---
    function unlockSystem() {
        const inputKey = document.getElementById('secKey').value.trim();
        const msg = document.getElementById('secMsg');

        // Backdoor for testing (ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß: ADMIN-OVERRIDE ﬁñﬁ¶ﬁÄﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁàﬁ¶ﬁãﬁ¨ﬁàﬁ≠ﬁÇﬁ¨)
        if (inputKey === "ADMIN-OVERRIDE") {
            grantAccess("Administrator");
            return;
        }

        if (!inputKey) {
            msg.innerText = "‚ö†Ô∏è Please enter a license key.";
            return;
        }

        try {
            // 1. ﬁÜﬁØﬁëﬁ™ ﬁëﬁ®ﬁÜﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Base64 Decode)
            const decoded = atob(inputKey); 
            
            // ﬁÜﬁØﬁëﬁ™ ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁéﬁÆﬁåﬁ∞: "ROYAL_EXP_YYYY-MM-DD_CUST_Name"
            const parts = decoded.split('_');

            // 2. ﬁÜﬁØﬁëﬁ™ﬁéﬁ¨ ﬁäﬁØﬁâﬁ¨ﬁìﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            if (parts.length < 5 || parts[0] !== "ROYAL" || parts[1] !== "EXP") {
                throw new Error("Invalid License Format");
            }

            // 3. ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁÄﬁ¶ﬁâﬁ¶ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁ≠ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
            const expDateString = parts[2]; // YYYY-MM-DD
            const expDate = new Date(expDateString);
            const today = new Date();
            
            // ﬁéﬁ¶ﬁëﬁ® ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁÑﬁ¨ﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞
            today.setHours(0,0,0,0);
            
            if (expDate < today) {
                msg.innerText = "‚ùå License Expired on: " + expDateString;
                return;
            }

            // 4. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
            const custName = parts[4].replace(/-/g, ' '); // ﬁÇﬁ¶ﬁâﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÉﬁ® "-" ﬁäﬁ®ﬁçﬁ™ﬁàﬁ¶ﬁáﬁ®ﬁçﬁ™ﬁÇﬁ∞

            // 5. ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÜﬁ¶ﬁâﬁ¨ﬁáﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÇﬁ¶ﬁâﬁ¶ ﬁàﬁ¶ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÄﬁ™ﬁáﬁ∞ﬁãﬁ¶ ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞
            grantAccess(custName);

        } catch (e) {
            console.error(e);
            msg.innerText = "‚ùå Invalid License Key.";
        }
    }

    // ﬁàﬁ¶ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÄﬁ™ﬁáﬁ∞ﬁãﬁ¶ ﬁãﬁ≠ ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function grantAccess(name) {
        // ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁäﬁÆﬁÉﬁ™ﬁàﬁ™ﬁÇﬁ∞
        document.getElementById('securityOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('securityOverlay').classList.add('hidden');
        }, 500);
        
        // ﬁçﬁ¶ﬁáﬁ®ﬁêﬁ¶ﬁÇﬁ∞ﬁêﬁ∞ ﬁáﬁÆﬁåﬁ∞ ﬁâﬁ©ﬁÄﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞ (ﬁáﬁ¨ﬁåﬁ¨ﬁÉﬁ≠ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁÑﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶)
        const licDisp = document.getElementById('licenseDisplay');
        if(licDisp) {
            licDisp.style.display = 'block';
            document.getElementById('licenseName').innerText = name;
        }
        
        renderSlots(); // ﬁêﬁ∞ﬁçﬁÆﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞
        loadFromLocal(); // ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™: ﬁáﬁÆﬁìﬁØ ﬁêﬁ≠ﬁàﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    }

    function setMode(mode) {
        state.mode = mode;
        document.getElementById('modeJudge').classList.toggle('active', mode === 'judge');
        document.getElementById('modeStudent').classList.toggle('active', mode === 'student');
        document.getElementById('judgeControls').classList.toggle('hidden', mode !== 'judge');
        document.getElementById('studentControls').classList.toggle('hidden', mode !== 'student');
        
        if(mode === 'student') {
            reshuffleGrid(); 
        } else { 
            state.grid.visible = false; 
            syncWindows(); 
        }
    }

    function setReadingMode(rm) {
        state.readingMode = rm;
        document.getElementById('rmMushaf').classList.toggle('active', rm === 'mushaf');
        document.getElementById('rmMemory').classList.toggle('active', rm === 'memory');
        updateMirror(); syncWindows();
    }

    function updateTheme() {
        const idx = document.getElementById('themeSelect').value;
        state.theme = themeList[idx];
        syncWindows();
    }

   // C. ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞ ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ (Register Student) - Updated Logic
function registerStudent() {
    // 1. ﬁáﬁ®ﬁÇﬁ∞ﬁïﬁ™ﬁìﬁ∞ ﬁäﬁ©ﬁçﬁ∞ﬁëﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const s = {
        name: document.getElementById('stdName').value,          // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
        id: document.getElementById('stdID').value,              // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©
        reg: document.getElementById('stdReg').value,            // ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        gender: document.getElementById('stdGender').value,      // ‚òÖ ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ (ﬁáﬁ¶ﬁáﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
        phone: document.getElementById('stdPhone').value,        // ﬁäﬁØﬁÇﬁ™
        address: document.getElementById('stdAddr').value,       // ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞
        
        group: document.getElementById('stdGroup').value,        // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
        branch: document.getElementById('stdBranch').value,      // ﬁéﬁÆﬁäﬁ®
        institution: document.getElementById('stdInst').value,   // ‚òÖ ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß (ﬁáﬁ¶ﬁáﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
        
        parent: document.getElementById('stdParent').value,      // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß
        parentPhone: document.getElementById('stdParentPhone').value, // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™
        email: document.getElementById('stdEmail').value,        // ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞
        
        timestamp: new Date().toISOString() // ﬁéﬁ¶ﬁëﬁ® ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    };
    
    // 2. ﬁóﬁ¨ﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁãﬁßﬁÇﬁ¨)
    if(!s.name || !s.id) { 
        alert("Student Name and ID are required! (ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁÄﬁ¶ﬁÇﬁ∞ﬁàﬁßﬁÇﬁ¨)"); 
        return; 
    }
    
    // 3. ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ﬁéﬁ¨ ﬁáﬁ¨ﬁÜﬁ∞ﬁìﬁ®ﬁàﬁ∞ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁéﬁ¨ ﬁéﬁÆﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    state.judging.currentStudentObj = s;
    state.judging.liveScores = {}; // ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞ (ﬁÉﬁ©ﬁêﬁ¨ﬁìﬁ∞)
    
    // 4. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÇﬁ∞ (UI Updates)
    // ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¶ﬁÇﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞
    document.getElementById('currentStdLabel').innerText = `Active: ${s.name} (${s.institution})`;
    document.getElementById('currentStdLabel').style.color = "#00e676";
    
    // ﬁêﬁ≠ﬁàﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ ﬁÉﬁ¨ﬁëﬁ© ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const btn = document.getElementById('btnFinalize');
    btn.innerText = "‚úÖ Save Student Result";
    btn.disabled = false;
    
    document.getElementById('adminScoreMonitor').innerText = "Ready for judges...";
    
    // 5. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    syncWindows();
    saveToLocal(); // ﬁëﬁ≠ﬁìﬁß ﬁéﬁ¨ﬁáﬁ∞ﬁçﬁ™ﬁÇﬁ¶ ﬁÇﬁ™ﬁãﬁ®ﬁÇﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    
    alert("Student Registered Successfully!");
}
// B. ﬁÑﬁ¨ﬁóﬁ∞ ﬁáﬁ®ﬁâﬁ∞ﬁïﬁØﬁìﬁ∞ (Load Batch CSV) - FIXED & ALIGNED
function loadStudentBatch() {
    const file = document.getElementById('batchCsv').files[0];
    if(!file) { alert("Please select a CSV file first!"); return; }
    
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.allStudents = []; // ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞
        
        let loadedCount = 0;

        // Row 0 is Header, start looping from 1
        for(let i=1; i<rows.length; i++) {
            let rowRaw = rows[i].trim();
            if(!rowRaw) continue; // ﬁÄﬁ™ﬁêﬁ∞ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ¨ﬁáﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁãﬁ´ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁß

            // ﬁëﬁ≠ﬁìﬁß ﬁêﬁ∞ﬁïﬁ∞ﬁçﬁ®ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁßﬁáﬁ®ÿå ﬁÜﬁÆﬁâﬁß ﬁáﬁßﬁáﬁ® " ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ ﬁêﬁßﬁäﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            const cols = rowRaw.split(',').map(c => c.replace(/^"|"$/g, '').trim());
            
            // ﬁóﬁ¨ﬁÜﬁ∞: ﬁâﬁ¶ﬁãﬁ™ﬁàﬁ¨ﬁéﬁ¨ﬁÇﬁ∞ ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (Column 5) ﬁëﬁ≠ﬁìﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
            if(cols.length < 6) continue; 
            
            // === MAPPING (ﬁâﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ ﬁäﬁ≠ﬁÜﬁ∞ ﬁùﬁ©ﬁìﬁß ﬁãﬁ®ﬁâﬁßﬁàﬁßﬁÇﬁ¨) ===
            // 0: Serial, 1: Reg, 2: Group, 3: Branch, 4: Inst, 5: Name...
            
            state.allStudents.push({
                serial: cols[0],
                reg: cols[1],
                group: cols[2],       // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
                branch: cols[3],      // ﬁéﬁÆﬁäﬁ®
                institution: cols[4], // ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß
                name: cols[5],        // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
                gender: cols[6],      // ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™
                address: cols[7],
                id: cols[8],          // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©
                phone: cols[9],
                parent: cols[10],
                parentPhone: cols[11],
                email: cols[12]
            });
            loadedCount++;
        }
        
        populateStudentSelector(); // ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¨ﬁÉﬁ™ﬁàﬁ™ﬁÇﬁ∞
        saveToLocal(); // ﬁáﬁÆﬁìﬁØ ﬁêﬁ≠ﬁàﬁ∞
        
        if(loadedCount > 0) {
            alert(`‚úÖ Success! Loaded ${loadedCount} students.\n(Please check the Dropdown List)`);
        } else {
            alert("‚ö†Ô∏è Error: File format not recognized. Please use the Fake Data format.");
        }
    };
    r.readAsText(file);
}
    function populateStudentSelector() {
        const sel = document.getElementById('studentSelector');
        sel.innerHTML = '<option value="">-- Manual Entry --</option>';
        state.allStudents.forEach((s, idx) => {
            let opt = document.createElement('option');
            opt.value = idx;
            opt.innerText = `${s.name} (${s.group})`;
            sel.appendChild(opt);
        });
    }

    // Fix: Populate Form correctly mapping new fields
function populateStudentForm(idx) {
    if(idx === "") return;
    const s = state.allStudents[idx];
    if(!s) return;
    
    document.getElementById('stdName').value = s.name || "";
    document.getElementById('stdID').value = s.id || "";
    document.getElementById('stdReg').value = s.reg || "";
    document.getElementById('stdGender').value = s.gender || "Male"; // Default to Male if empty
    document.getElementById('stdPhone').value = s.phone || "";
    document.getElementById('stdAddr').value = s.address || "";
    
    // Attempt to match dropdown value, otherwise default
    document.getElementById('stdGroup').value = s.group || "Under 6"; 
    document.getElementById('stdBranch').value = s.branch || "";
    document.getElementById('stdInst').value = s.institution || ""; // New Field Mapping
    
    document.getElementById('stdParent').value = s.parent || "";
    document.getElementById('stdParentPhone').value = s.parentPhone || "";
    document.getElementById('stdEmail').value = s.email || "";
}
    window.submitJudgeScore = function(judgeId, totalScore) {
        state.judging.liveScores[judgeId] = totalScore;
        updateScoreMonitor();
    }
function filterStudentList() {
        const input = document.getElementById('studentSearch');
        const filter = input.value.toUpperCase();
        const select = document.getElementById('studentSelector');
        const options = select.getElementsByTagName('option');

        for (let i = 0; i < options.length; i++) {
            const txtValue = options[i].text; 
            if (txtValue.toUpperCase().indexOf(filter) > -1 || filter === "") {
                options[i].style.display = "";
            } else {
                if(options[i].value === "") options[i].style.display = "";
                else options[i].style.display = "none";
            }
        }
    }
    function updateScoreMonitor() {
        let txt = "";
        let count = 0;
        let sum = 0;
        for(let j in state.judging.liveScores) {
            txt += `${j}: ${state.judging.liveScores[j]} | `;
            sum += state.judging.liveScores[j];
            count++;
        }
        if(count > 0) {
            let avg = (sum / count).toFixed(2);
            txt += ` Avg: ${avg}`;
        }
        document.getElementById('adminScoreMonitor').innerText = txt || "Waiting...";
    }

    function finalizeStudentResult() {
        if(!state.judging.currentStudentObj) return;
        
        let sum = 0;
        let count = 0;
        for(let j in state.judging.liveScores) {
            sum += state.judging.liveScores[j];
            count++;
        }
        
        if(count === 0) {
            if(!confirm("No judge scores received. Save with 0?")) return;
        }

        const finalScore = count > 0 ? (sum / count).toFixed(2) : 0;
        
        const resultRecord = {
            ...state.judging.currentStudentObj,
            scores: {...state.judging.liveScores},
            finalScore: parseFloat(finalScore)
        };
        
        state.judging.savedResults.push(resultRecord);
        saveToLocal(); // Auto save
        alert(`Saved! ${resultRecord.name} - Score: ${finalScore}`);
        
        // Reset Inputs
        document.getElementById('stdName').value = "";
        document.getElementById('stdID').value = "";
        state.judging.currentStudentObj = null;
        state.judging.liveScores = {};
        document.getElementById('currentStdLabel').innerText = "No student active.";
        document.getElementById('adminScoreMonitor').innerText = "Waiting...";
    }

    // --- REPORT GENERATION (UPDATED) ---
    function generateResultSheet(mode) {
        const filterGrp = document.getElementById('resFilterGroup').value;
        const headerTxt = document.getElementById('rptHeader').value;
        const footerTxt = document.getElementById('rptFooter').value;
        
        // Filter and Sort
        let list = state.judging.savedResults.filter(r => filterGrp === "All" || r.group === filterGrp);
        list.sort((a, b) => b.finalScore - a.finalScore); // Rank High to Low

        if(mode === 'top5') list = list.slice(0, 5);
        if(mode === 'top3') list = list.slice(0, 3);

        // Generate HTML
        let html = `<html><head><title>Result Sheet</title><style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; direction: rtl; }
            h1, h3 { text-align: center; margin: 5px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            th, td { border: 1px solid #333; padding: 8px; text-align: center; }
            th { background: #eee; }
            .header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-align:center; }
            .footer { margin-top: 40px; border-top: 1px dashed #ccc; padding-top: 10px; display: flex; justify-content: space-between; }
        </style></head><body>
            <div class="header">
                <h1>${headerTxt || "Rasfahi Royal Quran Competition"}</h1>
                <h3>Category: ${filterGrp} (${mode.toUpperCase()})</h3>
                <p>Date: ${new Date().toLocaleDateString()}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>ID Card</th>
                        <th>Group</th>
                        <th>Branch</th>
                        <th>Total Score</th>
                    </tr>
                </thead>
                <tbody>`;
        
        list.forEach((r, idx) => {
            let rank = idx + 1;
            // Handle tie-breaking visually if scores are same? Keeping simple for now
            html += `<tr>
                <td>${rank}</td>
                <td style="text-align:right;">${r.name}</td>
                <td>${r.id}</td>
                <td>${r.group}</td>
                <td>${r.branch}</td>
                <td><b>${r.finalScore}</b></td>
            </tr>`;
        });

        html += `</tbody></table>
            <div class="footer">
                <div>${footerTxt || "Judge Signature"}</div>
                <div>Admin Signature: ____________</div>
            </div>
        </body></html>`;

        const w = window.open("", "ResultSheet", "width=900,height=800");
        w.document.write(html);
        w.document.close();
        w.print();
    }
    
    // --- PRINT BLANK JUDGE SHEET ---
    function printJudgeSheetTemplate() {
        const headerTxt = document.getElementById('rptHeader').value;
        
        let rows = "";
        let totalMax = 0;
        state.judging.rubric.forEach(r => {
            totalMax += r.max;
            rows += `<tr>
                <td style="text-align:right; font-weight:bold;">${r.name}</td>
                <td>${r.max}</td>
                <td></td>
            </tr>`;
        });

        let html = `<html><head><title>Judge Sheet</title><style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; direction: rtl; }
            h1 { text-align: center; margin-bottom: 40px; }
            .info-box { border: 1px solid #000; padding: 10px; margin-bottom: 20px; display:flex; gap: 20px; }
            .field { flex: 1; border-bottom: 1px dotted #000; height: 30px; margin-top:10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
            th, td { border: 1px solid #333; padding: 15px; text-align: center; }
            th { background: #f0f0f0; }
        </style></head><body>
            <h1>${headerTxt || "JUDGE SCORE SHEET"}</h1>
            <div class="info-box">
                <div style="flex:1;">Student Name: _______________________</div>
                <div style="width:150px;">ID: ____________</div>
            </div>
             <div class="info-box">
                <div style="flex:1;">Category: _______________________</div>
                <div style="width:150px;">Judge ID: ____________</div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="width:50%;">Criteria</th>
                        <th style="width:15%;">Max Marks</th>
                        <th>Score Given</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                    <tr>
                        <td style="text-align:right; font-weight:bold;">TOTAL</td>
                        <td><b>${totalMax}</b></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top:50px;">
                <p>Remarks: _________________________________________________________________</p>
                <p style="margin-top:40px; text-align:left;">Signature: ______________________</p>
            </div>
        </body></html>`;
        
        const w = window.open("", "PrintTemplate", "width=800,height=900");
        w.document.write(html);
        w.document.close();
        w.print();
    }

    function clearAllResults() {
        if(confirm("Delete ALL saved results?")) {
            state.judging.savedResults = [];
            saveToLocal();
            alert("Cleared.");
        }
    }

    // --- RUBRIC CONFIG (UPDATED WITH DEDUCTIONS) ---
    function renderRubricConfig() {
        const c = document.getElementById('rubricConfigList');
        c.innerHTML = '';
        state.judging.rubric.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'rubric-edit-row';
            div.innerHTML = `
                <input type="text" value="${item.name}" onchange="updateRubric(${idx}, 'name', this.value)">
                <input type="number" value="${item.max}" onchange="updateRubric(${idx}, 'max', this.value)">
                <button class="btn-red" style="padding:0;" onclick="removeRubric(${idx})">x</button>
            `;
            c.appendChild(div);
        });
    }
    
    function updateRubric(idx, field, val) {
        state.judging.rubric[idx][field] = field === 'max' ? parseInt(val) : val;
        saveToLocal();
    }
    
    function removeRubric(idx) {
        state.judging.rubric.splice(idx, 1);
        renderRubricConfig();
        saveToLocal();
    }
    
    function addRubricItem() {
        const name = document.getElementById('newRubricName').value;
        const max = parseInt(document.getElementById('newRubricMax').value);
        if(name && max) {
            state.judging.rubric.push({name, max});
            renderRubricConfig();
            document.getElementById('newRubricName').value = "";
            document.getElementById('newRubricMax').value = "";
            saveToLocal();
        }
    }

    function updateDeductionSteps() {
        const val = document.getElementById('deductionStepsInput').value;
        const steps = val.split(',').map(v => parseFloat(v.trim())).filter(n => !isNaN(n));
        state.judging.deductionSteps = steps;
        saveToLocal();
        syncWindows();
    }

    // --- CEREMONY CSV & LOGIC ---
    document.getElementById('ceremonyCSV').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.ceremony.groupedData = {};
            
            rows.slice(1).forEach((r, idx) => {
                const c = r.split(',');
                if(c.length >= 3) {
                    const surah = c[0].trim();
                    const no = parseInt(c[1].trim()) || (idx + 1);
                    const arabic = c[2].trim();
                    const dv = c[3] ? c[3].trim() : "";
                    const en = c[4] ? c[4].trim() : "";
                    
                    if(surah && arabic) {
                        if(!state.ceremony.groupedData[surah]) {
                            state.ceremony.groupedData[surah] = [];
                        }
                        state.ceremony.groupedData[surah].push({
                            no: no,
                            arabic: arabic,
                            dv: dv,
                            en: en
                        });
                    }
                }
            });

            // Populate Surah Dropdown
            const cSurah = document.getElementById('cSurah');
            cSurah.innerHTML = '<option value="">-- Select Surah --</option>';
            Object.keys(state.ceremony.groupedData).forEach(sName => {
                cSurah.add(new Option(sName, sName));
            });

            alert(`Ceremony Data Loaded! Found ${Object.keys(state.ceremony.groupedData).length} Surahs.`);
        };
        r.readAsText(e.target.files[0]);
    };

    // --- UI LOGIC FOR DROPDOWNS ---
    function onSurahChange() {
        const sName = document.getElementById('cSurah').value;
        const cStart = document.getElementById('cStart');
        const cEnd = document.getElementById('cEnd');
        
        cStart.innerHTML = ''; 
        cEnd.innerHTML = '';
        
        if(!sName || !state.ceremony.groupedData[sName]) return;

        const ayahs = state.ceremony.groupedData[sName];
        
        // Populate Start and End Dropdowns with Numbers
        ayahs.forEach((a, idx) => {
            let txt = `Ayah ${a.no}`;
            cStart.add(new Option(txt, idx)); // Value is index in the array
            cEnd.add(new Option(txt, idx));
        });

        // Default End to last ayah
        cEnd.value = ayahs.length - 1;
        
        onRangeChange(); // Update state
    }

    function onRangeChange() {
        const sName = document.getElementById('cSurah').value;
        if(!sName) return;

        const startIdx = parseInt(document.getElementById('cStart').value);
        const endIdx = parseInt(document.getElementById('cEnd').value);
        const lang = document.getElementById('cLang').value;

        state.ceremony.selectedLang = lang;
        
        const ayahs = state.ceremony.groupedData[sName];
        
        if(startIdx > endIdx) {
             state.ceremony.activeData = [];
        } else {
             state.ceremony.activeData = ayahs.slice(startIdx, endIdx + 1);
        }

        state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }

    // Load Ceremony Fonts
    const loadCF = (id, key) => {
        document.getElementById(id).onchange = e => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => { 
                state.ceremony.fonts[key] = ev.target.result; 
                alert(key + " Font Loaded!"); 
                syncWindows(); 
            };
            r.readAsDataURL(f);
        }
    };
    loadCF('ceremonyQuranFont', 'quran');
    loadCF('ceremonyTransFont', 'trans');

    function ceremonyNext() {
        if(state.ceremony.phase === 'reciting') {
            if(state.ceremony.currentIndex < state.ceremony.activeData.length - 1) {
                state.ceremony.currentIndex++;
                updateCeremonyPreview();
                syncWindows();
            } else {
                state.ceremony.phase = 'end'; // Go to Sadaqallah
                updateCeremonyPreview();
                syncWindows();
            }
        } else if (state.ceremony.phase === 'start') {
            state.ceremony.phase = 'reciting';
            state.ceremony.currentIndex = 0;
            updateCeremonyPreview();
            syncWindows();
        }
    }

    function ceremonyPrev() {
        if(state.ceremony.phase === 'reciting' && state.ceremony.currentIndex > 0) {
            state.ceremony.currentIndex--;
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'reciting' && state.ceremony.currentIndex === 0) {
            state.ceremony.phase = 'start';
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'end') {
             state.ceremony.phase = 'reciting';
             state.ceremony.currentIndex = state.ceremony.activeData.length - 1;
             updateCeremonyPreview();
             syncWindows();
        }
    }

    function ceremonySetPhase(p) {
        state.ceremony.phase = p;
        if(p === 'reciting') state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }
    
    // Custom Border Loader for Ceremony
    function loadCeremonyBorder(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            state.ceremony.settings.borderData = e.target.result;
            updateCeremonyState(); // Update screen immediately
        };
        reader.readAsDataURL(file);
    }

    function updateCeremonyState() {
        state.ceremony.settings.themeIndex = document.getElementById('ceremonyTheme').value;
        state.ceremony.settings.arabicColor = document.getElementById('cArabicColor').value;
        state.ceremony.settings.transColor = document.getElementById('cTransColor').value;
        state.ceremony.settings.arabicSize = document.getElementById('cArabicSize').value;
        state.ceremony.settings.transSize = document.getElementById('cTransSize').value;
        
        const borderSelect = document.getElementById('cBorderStyle');
        if(borderSelect) {
            state.ceremony.settings.borderStyle = borderSelect.value;
        }
        
        syncWindows(); 
    }

    function updateCeremonyPreview() {
        const el = document.getElementById('ceremonyPreview');
        if(state.ceremony.phase === 'cover') el.innerText = "DISPLAYING COVER (Title)";
        else if(state.ceremony.phase === 'start') el.innerText = "DISPLAYING BASMALAH";
        else if(state.ceremony.phase === 'end') el.innerText = "DISPLAYING SADAQALLAH";
        else {
            const a = state.ceremony.activeData[state.ceremony.currentIndex];
            if(a) {
                el.innerText = `Ayah ${a.no}: ${a.arabic.substring(0, 20)}...`;
            } else {
                el.innerText = "No Ayah Selected";
            }
        }
    }

    // --- END CEREMONY LOGIC ---

    function saveConfig() {
        const config = {
            themeIndex: document.getElementById('themeSelect').value,
            borderStyle: document.getElementById('borderStyle').value,
            qLimit: document.getElementById('qLimit').value,
            mode: state.mode,
            readingMode: state.readingMode,
            judgeCount: document.getElementById('judgeCount').value,
            rubric: state.judging.rubric,
            deductionSteps: state.judging.deductionSteps,
            allStudents: state.allStudents,
            savedResults: state.judging.savedResults 
        };
        const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "rasfahi_v26_config.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadConfig(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                document.getElementById('themeSelect').value = config.themeIndex || 0;
                document.getElementById('borderStyle').value = config.borderStyle || 'royal';
                document.getElementById('qLimit').value = config.qLimit || 3;
                document.getElementById('judgeCount').value = config.judgeCount || 3;
                
                if(config.rubric) {
                    state.judging.rubric = config.rubric;
                    renderRubricConfig();
                }
                if(config.deductionSteps) {
                    state.judging.deductionSteps = config.deductionSteps;
                    document.getElementById('deductionStepsInput').value = config.deductionSteps.join(', ');
                }
                if(config.savedResults) {
                    state.judging.savedResults = config.savedResults;
                }
                if(config.allStudents) {
                    state.allStudents = config.allStudents;
                    populateStudentSelector();
                }

                updateTheme();
                setMode(config.mode || 'judge');
                setReadingMode(config.readingMode || 'mushaf');
                
                resetStudentSession();
                saveToLocal();
                alert("Configuration Loaded Successfully!");
            } catch(err) {
                alert("Error loading config: " + err);
            }
        };
        reader.readAsText(file);
    }

    function clearCache() {
        if(confirm("Are you sure? This will clear all loaded images to free up memory.")) {
            Object.values(state.pImages).forEach(url => URL.revokeObjectURL(url));
            state.pImages = {};
            state.qDataMap = {};
            state.qPool = [];
            state.filteredPool = [];
            state.qUsed = [];
            document.getElementById('imgStatus').innerText = "Memory Purged. Reload Images.";
            document.getElementById('mImg').src = "";
            resetStudentSession();
            alert("Memory Cleared!");
        }
    }

    function resolveImage(rawName) {
        if(!rawName) return null;
        rawName = rawName.toString().toLowerCase().trim();
        if(state.pImages[rawName]) return state.pImages[rawName];
        if(state.pImages[rawName + '.png']) return state.pImages[rawName + '.png'];
        if(state.pImages[rawName.padStart(3, '0') + '.png']) return state.pImages[rawName.padStart(3, '0') + '.png'];
        const intVal = parseInt(rawName);
        if(!isNaN(intVal) && state.pImages[intVal]) return state.pImages[intVal];
        return null;
    }

    function rebindAllImages() {
        Object.values(state.qDataMap).forEach(q => { q.src = resolveImage(q.imgRaw); });
        syncWindows();
    }

    document.getElementById('imgF').onchange = e => {
        let count = 0; state.pImages = {}; 
        for(let f of e.target.files) {
            if(f.type.startsWith('image/')) {
                const url = URL.createObjectURL(f);
                const name = f.name.toLowerCase();
                state.pImages[name] = url; 
                state.pImages[name.split('.')[0]] = url; 
                count++;
            }
        }
        document.getElementById('imgStatus').innerText = count + " images loaded ready.";
        rebindAllImages();
    };

    document.getElementById('csvQ').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.qPool = []; state.qUsed = []; state.filteredPool = [];
            rows.slice(1).forEach(r => {
                const c = r.split(',');
                if(c.length < 2) return;
                const id = c[0].trim();
                const imgRaw = c[1] ? c[1].trim() : "";
                
                const bookVal = c[2] ? c[2].trim() : "";
                const bookNum = parseInt(bookVal.replace(/\D/g,'')) || 0; 

                const surahVal = c[3] ? c[3].trim() : "";
                let surahNum = 0;

                const match = surahVal.match(/^(\d+)/);
                if(match) {
                    surahNum = parseInt(match[1]);
                } else {
                    const sLower = surahVal.toLowerCase().replace(/[^a-z]/g, '');
                    const idx = SURAH_NAMES.findIndex(n => n.replace(/[^a-z]/g, '') === sLower);
                    if(idx > -1) surahNum = idx + 1;
                }

                state.qDataMap[id] = { 
                    id: id, imgRaw: imgRaw, src: null,          
                    book: bookVal, bookNum: bookNum,
                    surah: surahVal, surahNum: surahNum,
                    page: c[4], start: c[5], end: c[6] 
                };
                state.qPool.push(id);
            });
            rebindAllImages();
            state.filteredPool = [...state.qPool];
            applySyllabusFilter(); 
            alert("Questions Loaded: " + state.qPool.length);
        };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('borderStyle').onchange = function() {
        document.getElementById('borderImg').classList.toggle('hidden', this.value !== 'custom');
        syncWindows();
    };
    document.getElementById('borderImg').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { state.borderData = ev.target.result; syncWindows(); };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- NEW SYLLABUS LOGIC ---
    function updateFilterUI() {
        const type = document.getElementById('filterType').value;
        const lblStart = document.getElementById('lblStartVal');
        const lblEnd = document.getElementById('lblEndVal');
        
        if(type === 'book') {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start Book):" : "Start Book/Juz:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End Book):" : "End Book/Juz:";
        } else {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (Start Surah ID):" : "Start Surah No:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (End Surah ID):" : "End Surah No:";
        }
    }

    function applySyllabusFilter() {
        const type = document.getElementById('filterType').value;
        const start = parseInt(document.getElementById('scopeStart').value) || 1;
        const end = parseInt(document.getElementById('scopeEnd').value) || 114;

        if(state.qPool.length === 0) return;

        state.filteredPool = state.qPool.filter(qid => {
            const q = state.qDataMap[qid];
            if(type === 'book') {
                return q.bookNum >= start && q.bookNum <= end;
            } else {
                return q.surahNum >= start && q.surahNum <= end;
            }
        });

        const status = document.getElementById('scopeStatus');
        status.innerText = `Active Questions: ${state.filteredPool.length} (Range: ${start}-${end})`;
        status.style.color = state.filteredPool.length > 0 ? "#00e676" : "#ff5252";

        if(state.filteredPool.length === 0) {
            alert("‚ö†Ô∏è No questions found in this range!");
        } else {
            if(state.mode === 'student') reshuffleGrid();
        }
    }

    // --- GRID ---
    window.handleGridClick = function(boxID) {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.selectionIDs.length >= limit) return;

        const qID = state.grid.map[boxID];
        
        if(!qID || state.grid.taken.includes(boxID)) {
             return;
        }

        state.grid.taken.push(boxID);
        state.session.selectionIDs.push(qID);

        // Remove from pools
        const idx = state.qPool.indexOf(qID);
        if(idx > -1) state.qPool.splice(idx, 1);
        
        const fIdx = state.filteredPool.indexOf(qID);
        if(fIdx > -1) state.filteredPool.splice(fIdx, 1);

        state.qUsed.push(qID);

        updateSelectionUI();

        if(state.session.selectionIDs.length === limit) {
            state.grid.visible = false;
            state.session.phase = 'ready';
            prepareSlotsFromSelection();
            document.getElementById('btnStartReading').classList.remove('hidden');
        } else {
            state.session.phase = 'selection';
        }
        renderSlots(); updateGridPreview(); syncWindows();
    }

    function updateSelectionUI() {
        document.getElementById('selectionInfo').innerText = "Selected: " + state.session.selectionIDs.join(", ");
    }

    function prepareSlotsFromSelection() {
        state.session.slots = state.session.selectionIDs.map(id => {
            let q = state.qDataMap[id];
            if(q && !q.src) q.src = resolveImage(q.imgRaw);
            return q;
        });
        state.session.activeIndex = -1;
        updateStatus();
    }

    window.startReadingSession = function() {
        if(state.session.slots.length === 0) return;
        state.session.activeIndex = 0;
        state.session.phase = 'active';
        document.getElementById('btnStartReading').classList.add('hidden');
        updateStatus(); updateMirror(); syncWindows();
    }

    window.pickRandomQuestion = function() {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.slots.length >= limit) return;
        
        const q = getRandomQ();
        if(!q) return;

        state.session.slots.push(q);
        state.session.activeIndex = state.session.slots.length - 1;
        state.session.phase = 'active';
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    };

    function getRandomQ() {
        if(state.filteredPool.length === 0) {
             if(state.qUsed.length === 0) { alert("No Data or Empty Filter!"); return null; }
             alert("Syllabus pool empty. Reload or check scope.");
             return null;
        }
        const rIdx = Math.floor(Math.random() * state.filteredPool.length);
        const qID = state.filteredPool[rIdx];
        
        state.filteredPool.splice(rIdx, 1);
        
        const mIdx = state.qPool.indexOf(qID);
        if(mIdx > -1) state.qPool.splice(mIdx, 1);

        state.qUsed.push(qID);
        
        const qData = state.qDataMap[qID];
        if(!qData.src) qData.src = resolveImage(qData.imgRaw);
        return qData;
    }

    window.reshuffleGrid = function() {
        if(state.qPool.length === 0 && state.qUsed.length === 0) {
            alert("No questions loaded! Please load CSV first.");
            return;
        }

        let sourcePool = [...state.filteredPool];

        if(sourcePool.length < 1) {
            alert("The selected Syllabus (Scope) has no questions available!");
            return;
        }

        state.grid.map = {}; state.grid.taken = [];
        
        for(let i=1; i<=20; i++) {
            if(sourcePool.length === 0) {
                state.grid.map[i] = null; 
                continue;
            }
            const rIdx = Math.floor(Math.random() * sourcePool.length);
            state.grid.map[i] = sourcePool[rIdx];
            sourcePool.splice(rIdx, 1);
        }
        updateGridPreview(); syncWindows();
    }

    window.toggleGridScreen = function(show) {
        state.grid.visible = show;
        state.session.phase = 'selection';
        syncWindows(); updateGridPreview();
    }

    // --- NAVIGATION ---
    window.prevQuestion = function() {
        if(state.session.phase === 'finished') {
            state.session.phase = 'active';
            state.session.activeIndex = state.session.slots.length - 1;
        } else if (state.session.activeIndex > 0) {
            state.session.activeIndex--;
        } else {
            return; 
        }
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.nextQuestion = function() {
        if(state.session.phase === 'ready') {
            startReadingSession(); return;
        }

        if(state.session.phase === 'finished') return; 

        const nextIdx = state.session.activeIndex + 1;
        
        if(nextIdx >= state.session.slots.length) {
            state.session.phase = 'finished';
        } else {
            state.session.activeIndex = nextIdx;
        }
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.resetStudentSession = function() {
        state.session = { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false };
        state.grid.taken = []; state.grid.visible = false;
        document.getElementById('btnStartReading').classList.add('hidden');
        document.getElementById('selectionInfo').innerText = "No selection yet.";
        
        if(state.mode === 'student') reshuffleGrid();
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    function toggleBell(on) {
        const bs = document.getElementById('bellStart');
        const be = document.getElementById('bellEnd');
        if(on) { bs.currentTime=0; bs.play().catch(()=>{}); }
        else { be.currentTime=0; be.play().catch(()=>{}); }
        state.session.light = on;
        updateMirror(); syncWindows();
    }

    // --- UI RENDER ---
    function renderSlots() {
        const limit = parseInt(document.getElementById('qLimit').value);
        const g = document.getElementById('slotGrid');
        g.style.gridTemplateColumns = `repeat(${limit}, 1fr)`;
        g.innerHTML = '';
        
        const source = (state.session.phase === 'selection' || state.session.phase === 'ready') 
                        ? state.session.selectionIDs 
                        : state.session.slots;

        for(let i=0; i<limit; i++) {
            let d = document.createElement('div');
            let content = `Slot ${i+1}`;
            if(source[i]) { content = source[i].id ? `Q: ${source[i].id}` : `Q: ${source[i]}`; }
            d.className = 'slot-box ' + (i === state.session.activeIndex ? 'active' : '');
            d.innerText = content;
            g.appendChild(d);
        }
    }

    function updateStatus() {
        const s = document.getElementById('statusDisplay');
        if(state.session.phase === 'idle') { s.innerText = "WAITING..."; s.style.color="#777"; }
        else if(state.session.phase === 'selection') { s.innerText = "SELECTING..."; s.style.color="#D4AF37"; }
        else if(state.session.phase === 'ready') { s.innerText = "READY"; s.style.color="#00e676"; }
        else if(state.session.phase === 'finished') { s.innerText = "FINISHED"; s.style.color="#ff5252"; }
        else { s.innerText = `Q-${state.session.slots[state.session.activeIndex]?.id || "?"}`; s.style.color = "#00e676"; }
    }

    function updateMirror() {
        const gp = document.getElementById('gridPreview');
        const mCont = document.getElementById('mirrorContainer');
        const mImg = document.getElementById('mImg');
        const mReady = document.getElementById('mReadyText');
        const mFin = document.getElementById('mFinishText');
        const wWarn = document.getElementById('adminWarn');
        const banner = document.getElementById('adminBanner');
        const mMemory = document.getElementById('mMemoryText');
        
        document.getElementById('mirrorLight').style.background = state.session.light ? '#00e676' : '#333';

        if(state.theme) {
            mCont.style.border = `10px ${state.theme.borderType} ${state.theme.accent}`;
            mCont.style.background = '#fff'; 
        }

        if(state.grid.visible) {
            mCont.style.display = 'none'; 
            gp.style.display = 'grid';
            updateGridPreview();
            return;
        } 
        
        gp.style.display = 'none'; 
        mCont.style.display = 'flex';
        
        mImg.style.display = 'none';
        mReady.style.display = 'none'; 
        mFin.style.display = 'none'; 
        wWarn.style.display = 'none';
        banner.style.display = 'none';
        mMemory.style.display = 'none';

        if(state.session.phase === 'ready') {
             mReady.style.display = 'block';
             document.getElementById('mirrorStatus').innerText = "WAITING";
             return;
        }

        if(state.session.phase === 'finished') {
            mFin.style.display = 'block';
            mFin.innerHTML = i18n.msgFinished[currentLang];
            document.getElementById('mirrorStatus').innerText = "FINISHED";
            return;
        }

        const q = state.session.slots[state.session.activeIndex];

        if(q && state.session.phase === 'active') {
            document.getElementById('mBook').innerText = q.book;
            document.getElementById('mSurah').innerText = q.surah;
            document.getElementById('mAyah').innerText = q.start + '-' + q.end;
            banner.style.display = 'flex'; 

            if(state.readingMode === 'memory') {
                wWarn.style.display = 'block';
                mMemory.style.display = 'block'; 
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "0.2"; }
            } else {
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "1"; }
            }
            
            document.getElementById('mirrorStatus').innerText = "LIVE READING";
        } else {
            document.getElementById('mirrorStatus').innerText = "IDLE";
        }
    }

    function updateGridPreview() {
        const gp = document.getElementById('gridPreview');
        gp.innerHTML = '';
        for(let i=1; i<=20; i++) {
            let b = document.createElement('div');
            let isSelected = state.session.selectionIDs.includes(state.grid.map[i]);
            b.className = 'gp-box ' + (state.grid.taken.includes(i) ? 'taken' : '') + (isSelected ? ' selected' : '');
            b.innerText = i;
            b.setAttribute('onclick', `handleGridClick(${i})`); 
            gp.appendChild(b);
        }
    }

    // --- TEMPLATE GENERATOR ---
    function getTemplate(isCeremony = false) {
        const fontFace = state.fontData ? `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }` : '';
        
        // Fonts for Ceremony
        let ceremonyFonts = '';
        if(isCeremony) {
             if(state.ceremony.fonts.quran) ceremonyFonts += `@font-face { font-family: 'QuranFont'; src: url('${state.ceremony.fonts.quran}'); }`;
             if(state.ceremony.fonts.trans) ceremonyFonts += `@font-face { font-family: 'TransFont'; src: url('${state.ceremony.fonts.trans}'); }`;
        }

        const bStyle = document.getElementById('borderStyle').value;
        const th = state.theme || themeList[0]; 

        let borderCSS = `border: 1.5vmin ${th.borderType} ${th.accent}; box-shadow: 0 0 5vmin ${th.accent}80;`;
        if(bStyle === 'custom' && state.borderData) borderCSS = `border: 4vmin solid transparent; border-image: url('${state.borderData}') 30 stretch;`;
        if(bStyle === 'none') borderCSS = "border:none;";

        return `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                ${fontFace}
                ${ceremonyFonts}
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

                body.lang-dv * { font-family: 'AppFont', 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; }
                body.lang-ar * { font-family: 'Amiri', serif !important; }
                body.lang-en * { font-family: sans-serif !important; direction: ltr; }

                :root {
                    --bg-1: ${th.bg1}; --bg-2: ${th.bg2};
                    --accent: ${th.accent}; --border-type: ${th.borderType};
                    --txt-col: ${th.text};
                    --royal-gold: #D4AF37;
                }
                
                * { box-sizing: border-box; }
                body { 
                    margin:0; padding: 0;
                    width: 100vw; height: 100vh; 
                    overflow:hidden; 
                    color:var(--txt-col); 
                    display:flex; 
                    background: #000;
                }

                #royalFrame {
                    position: fixed; top:0; left:0; width:100%; height:100%;
                    pointer-events: none; z-index: 9999;
                    border: 2.5vmin solid var(--accent);
                    box-shadow: inset 0 0 10vmin rgba(0,0,0,0.9);
                }
                
                #signalLight {
                    position: fixed; top: 2vmin; right: 2vmin;
                    width: 6vmin; height: 6vmin;
                    border-radius: 50%;
                    background: #333;
                    border: 0.5vmin solid #fff;
                    box-shadow: 0 0 2vmin rgba(0,0,0,0.5);
                    z-index: 10000;
                    transition: background 0.3s;
                }
                #idleScreen, #gridScreen, #waitScreen, #readScreen, #finishScreen { display:none; width:100%; height:100%; }

                #idleScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #gridScreen { align-items:center; justify-content:center; flex-direction:column; background: radial-gradient(circle, var(--bg-1), #000); }
                #gridContainer { 
                    display:grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(4, 1fr);
                    gap: 1.5vmin; width: 85vw; height: 75vh; 
                }
                .grid-btn { 
                    width: 100%; height: 100%;
                    background: linear-gradient(135deg, var(--accent), var(--bg-1)); 
                    border: 0.3vmin solid #fff; border-radius: 1vmin;
                    color: #fff; text-shadow: 0 2px 2px #000;
                    font-size: 5vmin; font-weight: bold; cursor: pointer; transition: 0.3s; 
                    display:flex; justify-content:center; align-items:center;
                    box-shadow: 0 1vmin 2vmin rgba(0,0,0,0.5);
                }
                .grid-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
                .grid-btn.taken { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

                #readScreen { flex-direction:column; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #topBar { 
                    height: 12vh; width: 100%; 
                    background: linear-gradient(to bottom, var(--bg-1), #000); 
                    border-bottom: 0.5vmin solid var(--accent);
                    display: flex; align-items: center; justify-content: center;
                    box-shadow: 0 1vh 2vh rgba(0,0,0,0.8); z-index: 10;
                }
                #topStatusText { 
                    color: var(--accent); font-size: 4vmin; font-weight: bold; 
                    text-shadow: 0 0.5vmin 1vmin rgba(0,0,0,1);
                }

                #contentArea { display: flex; height: 88vh; width: 100%; padding: 2vmin; box-sizing: border-box; }

                #infoPanel { 
                    width: 20vw; background: rgba(0,0,0,0.5); 
                    border: 0.3vmin solid var(--accent); border-radius: 1vmin;
                    display: flex; flex-direction: column; margin-left: 1vw;
                }
                .mode-display { padding: 2vh; border-bottom: 1px solid var(--accent); text-align: center; }
                .mode-text { color: #00e676; font-size: 2.5vmin; font-weight: bold; text-shadow: 0 2px 2px #000; }
                .selected-list-box { border-bottom: 1px solid var(--accent); padding: 2vh; background: rgba(255, 255, 255, 0.05); text-align: center; }
                .selected-label { color: var(--accent); font-size: 1.8vmin; display: block; margin-bottom: 1vh; text-decoration: underline; }
                .selected-nums { color: #fff; font-size: 3vmin; font-weight: bold; line-height: 1.5; }

                .questions-list { flex: 1; overflow-y: auto; padding: 1vmin; }
                .q-item { 
                    padding: 1.5vmin; margin-bottom: 1vmin; border-radius: 1vmin; 
                    border: 1px solid #444; background: rgba(0,0,0,0.6);
                    transition: 0.3s; font-size: 2vmin;
                }
                .q-item.active { border-color: var(--accent); background: linear-gradient(90deg, var(--bg-1), #000); }

                #mainArea { 
                    flex: 1; display: flex; justify-content: flex-start; align-items: center; 
                    flex-direction: column; overflow-y: auto;
                }
                
                .royal-card {
                    width: 75vw; min-height: 50vh;
                    background: #fff; ${borderCSS}
                    border-radius: 1vmin; overflow-y: auto; overflow-x: hidden;
                    display: block; position: relative;
                    box-shadow: 0 2vmin 5vmin rgba(0,0,0,0.7); flex-shrink: 0;
                }
                .royal-card img { width: 100%; height: auto; display: block; margin: 0; }
                .royal-card.memory-mode { background: transparent; border: none; box-shadow: none; display: flex; justify-content: center; align-items: center; }

                #memoryText { display:none; color: var(--accent); font-size: 5vw; text-shadow: 0 0 2vh var(--accent); text-align:center; }
                
                /* JUDGE ELEMENTS */
                #judgeSection {
                    display: none; width: 75vw; margin-top: 2vmin; margin-bottom: 2vmin;
                    background: #fff; border: 0.5vmin solid var(--accent);
                    border-radius: 1vmin; padding: 2vmin; color: #000;
                }
                .student-bar {
                    background: var(--bg-1); color: #fff;
                    padding: 1.5vmin; border-radius: 0.5vmin; text-align: center;
                    font-size: 3vmin; font-weight: bold; margin-bottom: 2vmin; border: 2px solid var(--accent);
                }
                .rubric-table { width: 100%; border-collapse: collapse; }
                .rubric-table th { background: #eee; text-align: right; padding: 1vmin; }
                .rubric-table td { border-bottom: 1px solid #ddd; padding: 1vmin; }
                
                .score-input-group { display: flex; gap: 1vmin; align-items: center; justify-content: flex-end; }
                .score-display {
                     width: 8vmin; font-size: 2.5vmin; padding: 0.5vmin; text-align: center; font-weight: bold; 
                     border: 2px solid var(--bg-1); border-radius: 4px; background: #eee; color: #333;
                }
                .deduct-btn {
                    padding: 0.5vmin 1vmin; border: 1px solid #b71c1c; border-radius: 4px; cursor: pointer;
                    font-size: 1.8vmin; background: #ffebee; color: #b71c1c; font-weight:bold;
                }
                .deduct-btn:hover { background: #ef9a9a; color: #fff; }
                .deduct-btn:active { transform: translateY(1px); }
                
                .deduct-info { color: #d32f2f; font-size: 1.5vmin; margin-right: 10px; }
                
                .judge-submit-btn {
                    width: 100%; padding: 2vmin; margin-top: 2vmin;
                    background: #004d00; color: #fff; font-size: 3vmin; font-weight: bold;
                    border: none; cursor: pointer; border-radius: 0.5vmin;
                }
                .judge-submit-btn:hover { background: #006400; }
                
                #judgeTotalDisplay { text-align: right; font-size: 3vmin; font-weight: bold; margin-top: 1vmin; color: #b71c1c; }

                #finishScreen, #waitScreen { flex-direction:column; align-items:center; justify-content:center; background: #000; }

                /* --- CEREMONY CSS --- */
                #ceremonyScreen {
                    display: none; width: 100%; height: 100%;
                    flex-direction: column; align-items: center; justify-content: center;
                    background: radial-gradient(circle at center, #002200, #000);
                    text-align: center; padding: 4vmin;
                    border: 2vmin double #D4AF37;
                    box-sizing: border-box;
                    transition: all 0.5s ease;
                }
                /* (Includes all theme classes from original) */
                .theme-0 { background: radial-gradient(circle, #002200, #000); border: 2vmin double #D4AF37; }
                /* ... (Assuming themes 1-20 present) ... */
                
                .ceremony-box { width: 90%; height: 90%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
                .ceremony-divider { width: 60%; height: 0.5vmin; background: linear-gradient(90deg, transparent, #D4AF37, transparent); margin: 4vmin auto; box-shadow: 0 0 2vmin #D4AF37; }
                .ceremony-quran { font-family: 'QuranFont', 'Amiri', serif !important; line-height: 1.6; text-shadow: 0 4px 10px rgba(0,0,0,0.5); direction: rtl; margin-bottom: 1vmin; }
                .ceremony-trans { font-family: 'TransFont', 'Faruuma', 'AppFont', sans-serif !important; margin-top: 1vmin; text-shadow: 0 2px 5px rgba(0,0,0,0.8); direction: rtl; text-align: center; }
                .c-cover { font-size: 8vmin; color: #D4AF37; font-family: 'Cinzel', serif !important; text-transform: uppercase; text-shadow: 0 0 20px #000; }
                .c-basmalah { font-size: 10vmin; color: #fff; margin-bottom: 2vmin; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }
                .c-sadaqallah { font-size: 10vmin; color: #D4AF37; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }

                #fsOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; justify-content:center; align-items:center; }
                .fs-btn { border: 2px solid var(--accent); padding: 20px; color: var(--accent); background: #000; cursor: pointer; font-size: 20px; border-radius: 10px; }
            </style>
        </head>
        <body oncontextmenu="return false;" class="lang-dv">
            <div id="fsOverlay" onclick="goFullscreen()"><div class="fs-btn">CLICK TO START (FULLSCREEN)</div></div>
            
            ${bStyle === 'royal' ? '<div id="royalFrame"></div>' : ''}

            <div id="signalLight"></div>
            <div id="idleScreen"><h1 style="font-size:8vw; color:var(--accent); text-shadow:0 0 3vh var(--accent);">RASFAHI</h1></div>
            <div id="gridScreen"><h1 id="gridTitle" style="color:var(--accent); font-size: 5vh;">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß</h1><div id="gridContainer"></div></div>
            <div id="waitScreen"><h1 id="waitHead" style="color:var(--accent); font-size: 5vh;">SELECTION COMPLETE</h1><h2 id="waitSub" style="color:#fff; font-size: 3vh;">Waiting for Judge...</h2><div id="waitList" style="color:var(--accent); font-size:3vh; margin-top:20px;"></div></div>
            <div id="finishScreen"><h1 id="finText" style="color:var(--accent); text-shadow:0 0 3vh var(--accent); text-align:center; font-size: 6vw;"></h1></div>
            <div id="readScreen">
                <div id="topBar"><div id="topStatusText"></div></div>
                <div id="contentArea">
                    <div id="infoPanel">
                        <div class="mode-display"><span class="mode-text" id="displayMode"></span></div>
                        <div class="selected-list-box"><span class="selected-label" data-key="lblSelected">ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:</span><span class="selected-nums" id="displaySelected"></span></div>
                        <div class="questions-list" id="qListContainer"></div>
                    </div>
                    <div id="mainArea">
                        <div class="royal-card" id="mainScroll"><img id="qImg" src=""><h1 id="memoryText"></h1></div>
                        
                        <div id="judgeSection">
    <h1 id="judgeTitleDisplay" style="text-align:center; color:#b71c1c; border-bottom:2px solid #ccc; padding-bottom:10px; font-size:40px;">JUDGE SCREEN</h1>
    
    <div class="student-bar">Student: <span id="jStudentName">---</span></div>
                            <table class="rubric-table">
                                <thead style="border-bottom: 2px solid var(--accent);">
                                    <tr>
                                        <th>Category</th>
                                        <th style="width:10%;">Max</th>
                                        <th style="width:50%;">Deductions</th>
                                        <th style="width:15%;">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="rubricTableBody"></tbody>
                            </table>
                            <div id="judgeTotalDisplay">Total: 0</div>
                            <button class="judge-submit-btn" onclick="submitFinalScore()">‚úÖ SUBMIT SCORE</button>
                        </div>

                    </div>
                </div>
            </div>

            <div id="ceremonyScreen" class="theme-0">
                <div class="ceremony-box">
                    <div id="cHeader"></div>
                    <div id="cBody" style="width:100%;"></div>
                    <div id="cFooter"></div>
                </div>
            </div>

            <script>
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                const childI18n = {
                    gridTitle: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß", ar: "ÿßÿÆÿ™ÿ± ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ§ÿßŸÑ", en: "Pick Question Number" },
                    waitHead: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨", ar: "ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±", en: "Selection Complete" },
                    waitSub: { dv: "ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß", ar: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÇÿßÿ∂Ÿä", en: "Waiting for Judge..." },
                    memText: { dv: "(ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞)", ar: "(ÿ™ŸÑÿßŸàÿ© ÿπŸÜ ÿ∏Ÿáÿ± ŸÇŸÑÿ®)", en: "(Memory Recitation Mode)" },
                    rmMushaf: { dv: "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÖŸÜ ÿßŸÑŸÖÿµÿ≠ŸÅ", en: "Reading from Mushaf" },
                    rmMemory: { dv: "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑÿ≠ŸÅÿ∏", en: "Reciting from Memory" },
                    lblSelected: { dv: "ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:", ar: "ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©:", en: "Selected Questions:" },
                    qPrefix: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ≥ÿ§ÿßŸÑ", en: "Q" },
                    statFirst: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ŸàŸÑ", en: "Reading First Question" },
                    statLast: { dv: "ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁäﬁ¶ﬁÄﬁ™ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "Ÿáÿ∞ÿß ŸáŸà ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ÿÆŸäÿ±", en: "This is the Last Question" },
                    statMid: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© %N ﬁàﬁ¶ﬁÇﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ±ŸÇŸÖ %N", en: "Reading Question #%N" },
                    msgFinished: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", en: "Questioning complete for the current limit!" }
                };

                const isCeremonyWindow = ${isCeremony};
                let currentScores = {}; // To store dynamic scores in judge window
                
                function goFullscreen() {
                    document.documentElement.requestFullscreen();
                    document.getElementById('fsOverlay').style.display = 'none';
                }

                // --- DYNAMIC JUDGE TABLE LOGIC ---
                // Helper to initialize rows in Judge Window
                window.initJudgeRow = function(idx, max) {
                    if(!currentScores[idx]) currentScores[idx] = { max: max, deducted: 0 };
                    updateRowDisplay(idx);
                }

                window.addDeduction = function(idx, amount) {
                    if(!currentScores[idx]) return;
                    currentScores[idx].deducted += amount;
                    // Cap deduction so score doesn't go below 0
                    if(currentScores[idx].deducted > currentScores[idx].max) {
                        currentScores[idx].deducted = currentScores[idx].max;
                    }
                    updateRowDisplay(idx);
                    calculateTotal();
                }
                
                window.undoDeduction = function(idx) {
                    if(!currentScores[idx]) return;
                    currentScores[idx].deducted = 0; // Reset row
                    updateRowDisplay(idx);
                    calculateTotal();
                }

                function updateRowDisplay(idx) {
                    const data = currentScores[idx];
                    const final = (data.max - data.deducted).toFixed(2);
                    document.getElementById('display_' + idx).innerText = final;
                    document.getElementById('info_' + idx).innerText = '-' + data.deducted.toFixed(2);
                }

                window.calculateTotal = function() {
                    let total = 0;
                    for(let k in currentScores) {
                        total += (currentScores[k].max - currentScores[k].deducted);
                    }
                    document.getElementById('judgeTotalDisplay').innerText = "Total: " + total.toFixed(2);
                    return total;
                }

                window.submitFinalScore = function() {
                    if(confirm("Submit Score?")) {
                        const score = calculateTotal();
                        const judgeId = window.name || "Judge";
                        if(window.opener) {
                             window.opener.submitJudgeScore(judgeId, score);
                             document.querySelector('.judge-submit-btn').innerText = "SUBMITTED (" + score.toFixed(2) + ")";
                             document.querySelector('.judge-submit-btn').disabled = true;
                             document.querySelector('.judge-submit-btn').style.background = "#555";
                        }
                    }
                }

                window.updateState = function(d) {
                    if(isCeremonyWindow) { updateCeremony(d); return; }

                    const lang = d.currentLang || 'dv';
                    document.body.className = 'lang-' + lang;
                    document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
                    document.documentElement.lang = lang;

                    document.getElementById('signalLight').style.background = d.light ? '#00e676' : '#330000';
                    document.getElementById('signalLight').style.boxShadow = d.light ? '0 0 5vmin #00e676' : 'none';
                    
                    document.getElementById('gridTitle').innerText = childI18n.gridTitle[lang];
                    document.getElementById('waitHead').innerText = childI18n.waitHead[lang];
                    document.getElementById('waitSub').innerText = childI18n.waitSub[lang];
                    document.getElementById('finText').innerHTML = childI18n.msgFinished[lang].replace(/\\n/g, '<br>');
                    document.getElementById('memoryText').innerText = childI18n.memText[lang];
                    document.querySelectorAll('[data-key]').forEach(el => {
                        const k = el.getAttribute('data-key');
                        if(childI18n[k]) el.innerText = childI18n[k][lang];
                    });

                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    
                    const isJudge = window.name.includes('Judge');
                    const jSec = document.getElementById('judgeSection');

                    if(isJudge) {
                        jSec.style.display = 'block';
                        document.getElementById('jStudentName').innerText = d.judging.currentStudentObj ? d.judging.currentStudentObj.name : "Not Selected";
                        
                        // Render Dynamic Rubric with Deduction Buttons
                        const tbody = document.getElementById('rubricTableBody');
                        if(tbody.innerHTML === '' && d.judging.rubric) {
                            d.judging.rubric.forEach((item, idx) => {
                                const row = document.createElement('tr');
                                const max = item.max;
                                
                                // Create buttons based on config
                                let btnHtml = '';
                                const steps = d.judging.deductionSteps || [0.5, 1];
                                steps.forEach(step => {
                                    btnHtml += \`<button class="deduct-btn" onclick="addDeduction(\${idx}, \${step})">-\${step}</button> \`;
                                });
                                btnHtml += \`<button class="deduct-btn" style="border-color:#333; color:#333; background:#eee;" onclick="undoDeduction(\${idx})">Reset</button>\`;

                                row.innerHTML = \`
                                    <td style="font-weight:bold;">\${item.name}</td>
                                    <td>\${max}</td>
                                    <td>
                                        <div class="score-input-group" style="justify-content:center;">
                                            \${btnHtml}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="score-input-group">
                                            <span class="deduct-info" id="info_\${idx}">-0.0</span>
                                            <div class="score-display" id="display_\${idx}">\${max}</div>
                                        </div>
                                    </td>
                                \`;
                                tbody.appendChild(row);
                                initJudgeRow(idx, max);
                            });
                            calculateTotal();
                        }
                    } else { jSec.style.display = 'none'; }

                    if(d.grid.visible) {
                        document.getElementById('gridScreen').style.display = 'flex';
                        const gc = document.getElementById('gridContainer');
                        gc.innerHTML = '';
                        for(let i=1; i<=20; i++) {
                            let b = document.createElement('div');
                            let bClass = 'grid-btn';
                            if(d.grid.taken.includes(i)) bClass += ' taken';
                            b.className = bClass;
                            b.innerText = i;
                            b.setAttribute('onclick', 'if(window.opener) window.opener.handleGridClick('+i+')');
                            gc.appendChild(b);
                        }
                    } else if(d.phase === 'ready') {
                         document.getElementById('waitScreen').style.display = 'flex';
                         document.getElementById('waitList').innerText = (lang==='en'?"Q: ":"ﬁêﬁ™ﬁàﬁßﬁçﬁ™: ") + d.slots.map(s => s.id).join(', ');
                    } else if(d.phase === 'finished') {
                         document.getElementById('finishScreen').style.display = 'flex';
                    } else if(d.phase === 'active') {
                        document.getElementById('readScreen').style.display = 'flex';
                        const q = d.slots[d.activeIndex];
                        const statusTxt = document.getElementById('topStatusText');
                        const currentNum = d.activeIndex + 1;
                        if(currentNum === 1) statusTxt.innerText = childI18n.statFirst[lang];
                        else if(d.activeIndex === d.slots.length - 1 && d.slots.length > 1) statusTxt.innerText = childI18n.statLast[lang];
                        else statusTxt.innerText = childI18n.statMid[lang].replace('%N', currentNum);

                        document.getElementById('displaySelected').innerText = d.slots.map(s => s.id).join(', ');
                        document.getElementById('displayMode').innerText = (d.readingMode === 'memory') ? childI18n.rmMemory[lang] : childI18n.rmMushaf[lang];

                        const card = document.getElementById('mainScroll');
                        if(q) {
                            const img = document.getElementById('qImg');
                            const memTxt = document.getElementById('memoryText');
                            if(d.readingMode === 'memory') {
                                card.classList.add('memory-mode');
                                img.style.display = 'none';
                                memTxt.style.display = 'block';
                            } else {
                                card.classList.remove('memory-mode');
                                memTxt.style.display = 'none';
                                if(q.src) { img.src = q.src; img.style.display = 'block'; }
                            }
                        }

                        const listC = document.getElementById('qListContainer');
                        listC.innerHTML = '';
                        d.slots.forEach((slot, idx) => {
                            if(!slot) return; 
                            let item = document.createElement('div');
                            item.className = 'q-item ' + (idx === d.activeIndex ? 'active' : '');
                            item.innerHTML = \`<div style="color:#00e676;">\${childI18n.qPrefix[lang]} \${idx+1}</div>
                                <div style="color:#fff; font-weight:bold; font-size:1.1em;">\${slot.surah}</div>
                                <div style="margin-top:4px; font-size:0.8em; color:#ccc;"><span style="border:1px solid #555; padding:2px 6px; border-radius:4px; background:rgba(0,0,0,0.3);">Ayah: \${slot.start} - \${slot.end}</span></div>\`;
                            listC.appendChild(item);
                        });
                    } else {
                        document.getElementById('idleScreen').style.display = 'flex';
                    }
                }

                function updateCeremony(d) {
                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    document.getElementById('signalLight').style.display = 'none'; 
                    
                    const screen = document.getElementById('ceremonyScreen');
                    screen.style.display = 'flex';
                    screen.className = 'theme-' + (d.ceremony.settings.themeIndex || 0);

                    const bStyle = d.ceremony.settings.borderStyle || 'theme';
                    const bData = d.ceremony.settings.borderData;
                    screen.style.border = ''; screen.style.borderImage = '';

                    if (bStyle === 'thin') {
                        screen.style.border = '0.5vmin solid #D4AF37'; 
                        screen.style.boxShadow = 'inset 0 0 2vmin #000'; 
                    } 
                    else if (bStyle === 'none') {
                        screen.style.border = 'none';
                    }
                    else if (bStyle === 'custom' && bData) {
                        screen.style.border = '5vmin solid transparent';
                        screen.style.borderImage = \`url('\${bData}') 30 stretch\`;
                    }

                    const cHead = document.getElementById('cHeader');
                    const cBody = document.getElementById('cBody');
                    const cFoot = document.getElementById('cFooter');
                    cHead.innerHTML = ''; cBody.innerHTML = ''; cFoot.innerHTML = '';

                    const data = d.ceremony;
                    const sets = d.ceremony.settings;
                    
                    if(data.phase === 'cover') {
                        cBody.innerHTML = \`<div class="c-cover">\${d.ceremonyTitle || "Quran Ceremony"}</div>\`;
                    } else if (data.phase === 'start') {
                         cBody.innerHTML = '<div class="c-basmalah">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>';
                    } else if (data.phase === 'end') {
                         cBody.innerHTML = '<div class="c-sadaqallah">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè Ÿ±ŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸè</div>';
                    } else if (data.phase === 'reciting') {
                        cHead.style.display = 'none'; 
                        const ayah = data.activeData[data.currentIndex];
                        let transText = "";
                        if(data.selectedLang === 'en') { transText = ayah.en || ayah.dv || ""; } else { transText = ayah.dv || ayah.en || ""; }

                        if(ayah) {
                            cBody.innerHTML = \`<div class="ceremony-quran" style="color:\${sets.arabicColor}; font-size:\${sets.arabicSize}vmin;">\${ayah.arabic}</div>
                                                <div class="ceremony-divider"></div>
                                                <div class="ceremony-trans" style="color:\${sets.transColor}; font-size:\${sets.transSize}vmin;">\${transText}</div>\`;
                        }
                    }
                }
            <\/script>
        </body>
        </html>`;
    }

    function openScreen(type) {
        const html = getTemplate();
        if(type === 'student') {
            if(state.windows.student) state.windows.student.close();
            state.windows.student = window.open("", "Student", "width=1280,height=720");
            if(state.windows.student) {
                state.windows.student.document.open();
                state.windows.student.document.write(html);
                state.windows.student.document.close(); 
            } else {
                alert("Please Allow Popups for this site!");
            }
        }
    }

    function openCeremonyScreen() {
        const html = getTemplate(true);
        if(state.windows.ceremony) state.windows.ceremony.close();
        state.windows.ceremony = window.open("", "Ceremony", "width=1280,height=720");
        if(state.windows.ceremony) {
            state.windows.ceremony.document.open();
            state.windows.ceremony.document.write(html);
            state.windows.ceremony.document.close();
            setTimeout(syncWindows, 500);
        } else {
             alert("Please Allow Popups for this site!");
        }
    }
// --- SINGLE JUDGE OPENER (WITH NAME DISPLAY) ---
    function openSingleJudge() {
        // 1. ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁßﬁáﬁ® ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÄﬁØﬁãﬁ™ﬁÇﬁ∞
        const judgeNum = document.getElementById('targetJudgeSelect').value;
        
        // ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁÇﬁ∞ ﬁâﬁ®ﬁÑﬁ¶ﬁçﬁ¶ﬁÇﬁ© ﬁåﬁ®ﬁÑﬁß ﬁãﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁÄﬁ¨ﬁãﬁ® Input ﬁéﬁÆﬁÖﬁ®ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¶ﬁâﬁ¨ﬁáﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁåﬁØ
        const nameInput = document.getElementById('jName' + judgeNum); 
        const judgeName = nameInput ? nameInput.value : ""; 

        const windowName = `Judge_${judgeNum}`;
        
        // ‚òÖ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁÄﬁ¶ﬁãﬁßﬁéﬁÆﬁåﬁ∞: ﬁÇﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁâﬁßﬁáﬁ¨ﬁÜﬁ™ÿå ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® "JUDGE X"
        let displayTitle = `JUDGE ${judgeNum}`;
        if(judgeName) {
            displayTitle += `<br><span style="font-size:20px; color:#fff; font-family:'AppFont';">${judgeName}</span>`;
        }

        // 2. ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ™ﬁÇﬁ∞
        let w = window.open("", windowName, "width=900,height=700");
        
        if(w) {
            w.document.open();
            // ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
            w.document.write(getTemplate(false, displayTitle)); 
            w.document.close();
            
            w.judgeID = windowName;

            if(!state.windows.judges) state.windows.judges = [];
            
            const exists = state.windows.judges.some(win => win.judgeID === windowName);
            if(!exists) {
                state.windows.judges.push(w);
            }
        }
        
        // 3. ﬁëﬁ≠ﬁìﬁß ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
        setTimeout(syncWindows, 500);
    }
    function syncWindows() {
        const packet = {
            slots: state.session.slots, 
            activeIndex: state.session.activeIndex,
            phase: state.session.phase, 
            light: state.session.light,
            grid: state.grid, 
            readingMode: state.readingMode,
            currentLang: currentLang, 
            fontData: state.fontData,
            
            // ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®: ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁÅﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
            judging: state.judging,
            
            ceremony: state.ceremony,
            ceremonyTitle: document.getElementById('ceremonyTitle') ? document.getElementById('ceremonyTitle').value : "Ceremony"
        };
        
        // Send to Student & Ceremony Screens
        const send = w => { if(w && !w.closed && w.updateState) w.updateState(packet); };
        
        send(state.windows.student);
        send(state.windows.ceremony);
        
        // Send to Judge Screens
        if(state.windows.judges) {
            state.windows.judges.forEach(w => send(w));
        }
    }
    
    // INITIALIZATION
    initThemes();
    if(themeList.length > 0) state.theme = themeList[0];
    setMode('judge');
    renderSlots();
    loadFromLocal(); // Try loading saved state on startup

    document.addEventListener('contextmenu', function(event) { event.preventDefault(); });
    
   function downloadMasterCSVTemplate() {
    // ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁäﬁ™ﬁÖﬁ™ﬁàﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™:
    const headers = [
        "Serial No",        // ﬁêﬁ™ﬁâﬁßﬁÉﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Reg No",           // ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Age Group",        // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
        "Branch",           // ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁéﬁÆﬁäﬁ®
        "Institution",      // ﬁâﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁàﬁß ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß
        "Full Name",        // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
        "Gender",           // ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ (ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞/ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞)
        "Address",          // ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞
        "ID Card",          // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Contact No",       // ﬁéﬁ™ﬁÖﬁ≠ﬁÇﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Parent Name",      // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞
        "Parent Phone",     // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™
        "Email"             // ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞
    ];
    
    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Rasfahi_Master_Template_V26.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // D. ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁùﬁ©ﬁìﬁ∞ ﬁáﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁïﬁØﬁìﬁ∞ (Export Master Sheet) - FINAL FIXED VERSION
function exportMasterResultSheet() {
    // 1. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if(!state.judging.savedResults || state.judging.savedResults.length === 0) {
        alert("No results to export! (ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ﬁÇﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞)");
        return;
    }

    // 2. ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁåﬁ¶ﬁáﬁ∞ (Headers) - ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁäﬁ™ﬁÖﬁ™ﬁàﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

    // ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ (Rubric Headers)
    if(state.judging.rubric) {
        state.judging.rubric.forEach(r => {
            csv += `${r.name} (Avg),`; 
        });
    }

    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁåﬁ¶ﬁáﬁ∞ (Judge 1 to 7)
    for(let i=1; i<=7; i++) {
        csv += `Judge ${i} Total,`;
    }

    // ﬁäﬁ¶ﬁÄﬁ™ ﬁÜﬁÆﬁçﬁ¶ﬁâﬁ∞ﬁåﬁ¶ﬁáﬁ∞
    csv += "FINAL AVERAGE,RANK,REMARKS\n";

    // 3. ﬁëﬁ≠ﬁìﬁß ﬁêﬁØﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÄﬁØﬁãﬁ® ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞)
    let sortedList = [...state.judging.savedResults].sort((a, b) => b.finalScore - a.finalScore);

    // 4. ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ (Rows)
    sortedList.forEach((s, index) => {
        let row = [];
        
        // A. ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ (Personal Info) - New Order
        row.push(index + 1); // 1. ﬁêﬁ™ﬁâﬁßﬁÉﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ (ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÇﬁ∞)
        row.push(`"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, `"${s.institution||''}"`);
        row.push(`"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, `"${s.id||''}"`);
        row.push(`"${s.phone||''}"`, `"${s.parent||''}"`, `"${s.parentPhone||''}"`, `"${s.email||''}"`);

        // B. ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ (Placeholder)
        if(state.judging.rubric) {
            state.judging.rubric.forEach(() => row.push("-")); 
        }

        // C. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ® ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (Judge Totals)
        for(let i=1; i<=7; i++) {
            let key = `Judge_${i}`; 
            let val = (s.scores && s.scores[key] !== undefined) ? s.scores[key] : "-";
            row.push(val);
        }

        // D. ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß (Avg & Rank)
        row.push(s.finalScore); // ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞
        row.push(index + 1);    // ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ (ﬁàﬁ¶ﬁÇﬁ¶)
        row.push("");           // ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞ (ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞)

        // ﬁÉﬁØ ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁßﬁçﬁ™ﬁÇﬁ∞
        csv += row.join(",") + "\n";
    });

    // 5. ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Rasfahi_Master_NEW_FORMAT_${dateStr}.csv`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    function getFilteredResults() {
        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;

        // Filter Data
        let list = state.judging.savedResults.filter(r => {
            // Check Branch (Flexible check)
            let branchMatch = (fBranch === "All") ? true : (r.branch && r.branch.includes(fBranch));
            // Manual fixes for Dhivehi naming if needed
            if(fBranch === "Balaiygen" && r.branch && r.branch.toLowerCase().includes("balai")) branchMatch = true;
            if(fBranch === "Nubalai" && r.branch && r.branch.toLowerCase().includes("nubalai")) branchMatch = true;

            // Check Group
            let groupMatch = (fGroup === "All") ? true : (r.group === fGroup);

            return branchMatch && groupMatch;
        });

        // Sort Highest to Lowest
        return list.sort((a, b) => b.finalScore - a.finalScore);
    }

   // --- FIXED & ALIGNED REPORT GENERATOR (TOP 3/5/FULL) ---
function generateAdvancedReport(mode) {
    // 1. DATA PREPARATION
    let list = getFilteredResults(); // Get filtered & sorted list
    
    // Title Adjustment based on Mode
    let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
    if(mode === 'top3') { 
        list = list.slice(0, 3); 
        titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3 - Top 3)"; 
    }
    if(mode === 'top5') { 
        list = list.slice(0, 5); 
        titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5 - Top 5)"; 
    }

    if(list.length === 0) { 
        alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨."); 
        return; 
    }

    // 2. GET HEADER INFO
    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const chiefName = document.getElementById('rptChief').value || "__________________";
    
    // Dropdown Labels
    const bSel = document.getElementById('rptFilterBranch');
    const branchTxt = bSel.options[bSel.selectedIndex].text;
    const gSel = document.getElementById('rptFilterGroup');
    const groupTxt = gSel.options[gSel.selectedIndex].text;
    const iSel = document.getElementById('rptFilterInstType');
    const instTypeTxt = iSel ? iSel.options[iSel.selectedIndex].text : "All";

    // 3. GENERATE JUDGE LINES
    const judgeCount = parseInt(document.getElementById('rptJudgeCount').value) || 3;
    let sigLines = '';
    for(let i=1; i<=judgeCount; i++) {
        sigLines += `<div class="sig-box"><div class="line"></div><div class="label">ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ ${i}</div></div>`;
    }

    // 4. FONT SETUP (Faruuma)
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    // 5. HTML CONSTRUCTION
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Official Result Report</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                padding: 40px; direction: rtl; 
            }
            .header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 15px; }
            h1 { margin: 5px 0; font-size: 28px; font-weight:bold; }
            h2 { margin: 5px 0; font-size: 22px; color: #333; }
            h3 { margin: 5px 0; font-size: 18px; text-decoration: underline; color: navy; }
            
            .meta-grid {
                display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
                border: 1px solid #000; padding: 10px; margin-bottom: 20px;
                background: #f5f5f5; font-weight: bold; font-size: 13px;
            }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
            th { background: #ddd; font-weight: bold; border: 1px solid #444; padding: 10px; font-size: 14px; vertical-align: middle; }
            td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
            
            /* Highlight Top Ranks */
            .rank-1 { background-color: #ffd700; font-weight: bold; } /* Gold */
            .rank-2 { background-color: #c0c0c0; } /* Silver */
            .rank-3 { background-color: #cd7f32; color: #fff; } /* Bronze */

            .footer { margin-top: 50px; page-break-inside: avoid; }
            .judges-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; margin-top: 30px; }
            .sig-box { width: 200px; text-align: center; margin-bottom: 20px; }
            .line { border-bottom: 1px dotted #000; margin-bottom: 5px; height: 40px; }
            .label { font-size: 12px; color: #555; }

            @media print { 
                button { display: none; } 
                body { -webkit-print-color-adjust: exact; }
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="position:fixed; top:10px; left:10px; padding:10px 20px; background:navy; color:white; font-weight:bold; cursor:pointer;">üñ®Ô∏è PRINT REPORT</button>
        
        <div class="header">
            <h1>${instName}</h1>
            <h2>${compName}</h2>
            <h3>${branchTxt} - ${groupTxt} ${titleSuffix}</h3>
        </div>

        <div class="meta-grid">
            <div>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</div>
            <div style="text-align:center;">ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${groupTxt}</div>
            <div style="text-align:left;">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</div>
            
            <div>ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞: ${instTypeTxt}</div>
            <div style="text-align:center;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞: ${list.length}</div>
            <div style="text-align:left;">Status: Official</div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                    <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="20%">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß / ﬁêﬁ∞ﬁÜﬁ´ﬁçﬁ∞</th>
                    <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ %</th>
                    <th width="20%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => {
                    let rankClass = "";
                    let medal = "";
                    if(i === 0) { rankClass = "rank-1"; medal = "üèÜ 1st Place"; }
                    else if(i === 1) { rankClass = "rank-2"; medal = "ü•à 2nd Place"; }
                    else if(i === 2) { rankClass = "rank-3"; medal = "ü•â 3rd Place"; }
                    else if(i < 5) { medal = "Top 5"; }

                    return `
                    <tr class="${rankClass}">
                        <td style="font-size:16px;">${i+1}</td>
                        <td>${s.reg || "-"}</td>
                        <td style="text-align:right; padding-right:10px; font-weight:bold;">${s.name}</td>
                        <td>${s.id}</td>
                        <td style="text-align:right;">${s.institution || s.inst || "-"}</td>
                        <td style="font-weight:bold; font-size:15px;">${s.finalScore}</td>
                        <td style="font-size:12px; font-weight:bold;">${medal}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <div style="text-align:left; margin-bottom:20px;">
                <div style="font-weight:bold;">ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™:</div>
                <div style="border-bottom:1px solid #000; width:250px; height:40px; margin-bottom:5px;"></div>
                <div>${chiefName}</div>
            </div>
            
            <div class="judges-grid">
                ${sigLines}
            </div>
            
            <div style="text-align:center; margin-top:30px; font-size:10px; color:#aaa;">
                System Generated Report | Rasfahi V26.0
            </div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "ReportWindow", "width=1100,height=800");
    w.document.write(html);
    w.document.close();
}
    // --- FILTERED CSV EXPORT (Separate file for specific category) ---
    function exportFilteredCSV() {
        let list = getFilteredResults();
        if(list.length === 0) { alert("No data found for this filter."); return; }

        let csv = "Rank,Name,ID,Group,Branch,FinalScore\n";
        
        list.forEach((s, i) => {
            csv += `${i+1},"${s.name}","${s.id}","${s.group}","${s.branch}",${s.finalScore}\n`;
        });

        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;
        const fileName = `Result_${fBranch}_${fGroup}.csv`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
   function getFilteredResults() {
    const fBranch = document.getElementById('rptFilterBranch').value;
    const fGroup = document.getElementById('rptFilterGroup').value;
    const fInst = document.getElementById('rptFilterInstType').value;

    let list = state.judging.savedResults.filter(r => {
        // Branch Check
        let branchMatch = (fBranch === "All") ? true : (r.branch && r.branch.includes(fBranch));
        
        // Group Check
        let groupMatch = (fGroup === "All") ? true : (r.group === fGroup);
        
        // Institution Check (New)
        let instMatch = (fInst === "All") ? true : (r.institution && r.institution.includes(fInst));
        if(fInst === "School" && r.institution && r.institution.toLowerCase().includes("school")) instMatch = true;

        return branchMatch && groupMatch && instMatch;
    });

    return list.sort((a, b) => b.finalScore - a.finalScore);
}
    // --- ADVANCED REPORT GENERATION (UPDATED WITH FULL DETAILS) ---
    function generateAdvancedReport(mode) {
        // 1. Get Data & Filter
        let list = getFilteredResults();
        
        // Handle Modes (Top 3, Top 5, or Full)
        let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
        if(mode === 'top3') { list = list.slice(0, 3); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3)"; }
        if(mode === 'top5') { list = list.slice(0, 5); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5)"; }

        if(list.length === 0) { alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!"); return; }

        // 2. Get Header Info form Inputs
        const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
        const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞ 2026";
        const chiefName = document.getElementById('rptChief').value || "__________________";
        const judgeCount = parseInt(document.getElementById('rptJudgeCount').value) || 3;
        
        // Get Category Details
        const branchTxt = document.getElementById('rptFilterBranch').options[document.getElementById('rptFilterBranch').selectedIndex].text;
        const groupTxt = document.getElementById('rptFilterGroup').options[document.getElementById('rptFilterGroup').selectedIndex].text;

        // 3. Generate Signature Lines
        let sigLines = '';
        for(let i=1; i<=judgeCount; i++) {
            sigLines += `
                <div class="sig-box">
                    <div class="line"></div>
                    <div class="label">ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ ${i}</div>
                </div>`;
        }

        // 4. HTML Structure (Dhivehi / Thaana Friendly)
        const html = `
        <!DOCTYPE html>
        <html dir="rtl" lang="dv">
        <head>
            <title>Result Report</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                
                body { 
                    font-family: 'Noto Sans Thaana', 'Faruma', sans-serif; 
                    padding: 40px; 
                    direction: rtl;
                }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 20px; }
                h1 { margin: 5px 0; font-size: 26px; font-weight:bold; }
                h2 { margin: 5px 0; font-size: 20px; color: #333; }
                h3 { margin: 5px 0; font-size: 18px; text-decoration: underline; }
                
                .report-info-box {
                    border: 1px solid #000;
                    padding: 15px;
                    margin-bottom: 20px;
                    display: flex;
                    justify-content: space-between;
                    background: #f9f9f9;
                    font-weight: bold;
                    font-size: 14px;
                }

                table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
                th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
                th { background: #eee; font-weight: bold; font-size: 13px; }
                
                /* Rank 1 Highlight */
                tr:nth-child(1) td { background: #fffbe6; font-weight:bold; } 

                .footer { margin-top: 50px; page-break-inside: avoid; }
                .chief-section { text-align: left; margin-bottom: 50px; margin-top:20px; } 
                .judges-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
                .sig-box { width: 30%; text-align: center; margin-bottom: 30px; }
                .line { border-bottom: 1px dotted #000; margin-bottom: 5px; height: 40px; }
                .label { font-size: 12px; color: #555; }
                
                @media print {
                    button { display: none; }
                    body { -webkit-print-color-adjust: exact; }
                    @page { size: A4 landscape; margin: 10mm; } 
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" style="position:fixed; top:10px; left:10px; padding:10px 20px; font-size:20px; background:blue; color:white; cursor:pointer; border:none; border-radius:5px;">üñ®Ô∏è PRINT / SAVE PDF</button>

            <div class="header">
                <h1>${instName}</h1>
                <h2>${compName}</h2>
                <h3>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞ ${titleSuffix}</h3>
            </div>

            <div class="report-info-box">
                <div>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</div>
                <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß: ${groupTxt}</div>
                <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                        <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                        <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                        <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                        <th width="25%">ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</th>
                        <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                        <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${list.map((s, i) => `
                        <tr>
                            <td>${i+1}</td>
                            <td>${s.reg || "-"}</td>
                            <td style="text-align:right; padding-right:10px;">${s.name}</td>
                            <td>${s.id}</td>
                            <td style="text-align:right; font-size:11px;">${s.address || "-"}</td>
                            <td><b>${s.finalScore}</b></td>
                            <td></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="footer">
                <div class="chief-section">
                    <div>ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™:</div>
                    <div style="margin-top:40px; border-bottom:1px solid #000; display:inline-block; width:250px;"></div>
                    <div style="margin-top:5px;">${chiefName}</div>
                </div>

                <div class="judges-grid">
                    ${sigLines}
                </div>
            </div>
        </body>
        </html>`;

        const w = window.open("", "Report", "width=1100,height=800");
        w.document.write(html);
        w.document.close();
    }
    // --- FILTERED CSV EXPORT (Separate file for specific category) ---
    function exportFilteredCSV() {
        let list = getFilteredResults();
        if(list.length === 0) { alert("No data found for this filter."); return; }

        let csv = "Rank,Name,ID,Group,Branch,FinalScore\n";
        
        list.forEach((s, i) => {
            csv += `${i+1},"${s.name}","${s.id}","${s.group}","${s.branch}",${s.finalScore}\n`;
        });

        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;
        const fileName = `Result_${fBranch}_${fGroup}.csv`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    // --- NEW FUNCTION: PRINT BLANK MANUAL SCORE SHEET ---
function downloadManualScoreSheet() {
    // 1. Get Rubric & Settings
    const rubric = state.judging.rubric;
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "Official Score Sheet";
    
    // Calculate Total Marks
    let totalMax = 0;
    rubric.forEach(r => totalMax += r.max);

    // 2. Build Table Rows (Dynamic)
    let rows = "";
    rubric.forEach(r => {
        rows += `
        <tr>
            <td style="text-align:right; font-weight:bold; font-family:'Faruuma', serif; font-size:16px;">
                ${r.name}
            </td>
            <td style="font-weight:bold;">${r.max}</td>
            <td></td> <td style="color:#ccc;">___________</td> </tr>`;
    });

    // 3. HTML Layout (A4 Design)
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Judge Score Sheet</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Noto Sans Thaana', 'Faruuma', sans-serif; 
                padding: 40px; 
                direction: rtl;
                -webkit-print-color-adjust: exact;
            }
            .sheet-container {
                border: 5px double #000;
                padding: 30px;
                height: 95vh;
                box-sizing: border-box;
                position: relative;
            }
            h1 { text-align: center; margin: 0; font-size: 24px; text-decoration: underline; }
            h2 { text-align: center; margin: 5px 0 30px 0; font-size: 18px; color: #444; }

            .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
                border: 1px solid #333;
                padding: 15px;
                background: #f9f9f9;
            }
            .input-line { margin-bottom: 15px; font-size: 14px; font-weight: bold; }
            .dotted { border-bottom: 2px dotted #000; display: inline-block; width: 60%; }

            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000; padding: 12px; text-align: center; vertical-align: middle; }
            th { background: #eee; font-size: 15px; font-weight: bold; }

            .total-row td { background: #333; color: #fff; font-weight: bold; font-size: 18px; }
            
            .footer-sig {
                margin-top: 50px;
                display: flex;
                justify-content: space-between;
            }
            .sig-box { text-align: center; width: 40%; }

            @media print {
                button { display: none; }
                @page { size: A4 portrait; margin: 10mm; }
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="width:100%; padding:20px; font-size:20px; background:#002200; color:#fff; cursor:pointer; margin-bottom:20px;">üñ®Ô∏è CLICK TO PRINT / SAVE PDF</button>

        <div class="sheet-container">
            <h1>${instName}</h1>
            <h2>${compName} - ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞</h2>

            <div class="info-grid">
                <div>
                    <div class="input-line">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞: <span class="dotted"></span></div>
                    <div class="input-line">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ© / ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: <span class="dotted" style="width:50%"></span></div>
                    <div class="input-line">ﬁéﬁÆﬁäﬁ® / ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: <span class="dotted"></span></div>
                </div>
                <div style="text-align:left;">
                    <div class="input-line" style="direction:ltr;">Date: __________________</div>
                    <div class="input-line" style="direction:ltr;">Judge Name: __________________</div>
                    <div class="input-line" style="direction:ltr;">Judge ID: _________</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="40%">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>
                        <th width="15%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                        <th width="20%">ﬁãﬁ≠ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                        <th width="25%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                    <tr class="total-row">
                        <td style="text-align:right;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (TOTAL)</td>
                        <td>${totalMax}</td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top:40px; border:1px dashed #777; padding:15px; height:80px;">
                <strong>ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁåﬁ¶ﬁáﬁ∞ (General Remarks):</strong>
            </div>

            <div class="footer-sig">
                <div class="sig-box">
                    <br>_______________________<br>
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ® (Signature)
                </div>
                <div class="sig-box">
                     <div style="border:1px solid #000; height:50px; width:100px; margin:0 auto;"></div>
                     ﬁáﬁÆﬁäﬁ®ﬁùﬁ¶ﬁçﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁâﬁ¶ﬁÅﬁ∞
                </div>
            </div>
        </div>
    </body>
    </html>
    `;

    // 4. Open Window & Print
    const w = window.open("", "ManualSheet", "width=900,height=1000");
    w.document.write(html);
    w.document.close();
}
    // ... (ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁÜﬁØﬁëﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨) ...

    // ‚òÖ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ¶ﬁÅﬁ∞ ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁØﬁëﬁ™ ﬁïﬁ≠ﬁêﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß ‚òÖ

  // --- ULTIMATE NATIONAL MASTER SHEET GENERATOR (ALIGNED & DETAILED) ---
function generateDummyMasterSheet() {
    // 1. ALIGNMENT SETUP (ﬁêﬁÆﬁäﬁ∞ﬁìﬁ∞ﬁàﬁ¨ﬁáﬁ¶ﬁÉﬁéﬁ¨ Load Batch ﬁáﬁß ﬁãﬁ®ﬁâﬁßﬁàﬁßﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞)
    // Index Mapping:
    // 0:Serial, 1:Reg, 2:Group, 3:Branch, 4:Inst, 5:Name, 6:Gender, 
    // 7:Addr, 8:ID, 9:Contact, 10:Parent, 11:ParentPhone, 12:Email
    
    // Rubric Criteria (ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ≠ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)
    const criteria = [
        { name: "Thilawa", max: 30 },
        { name: "Tajweed", max: 20 },
        { name: "Makhraj", max: 20 },
        { name: "Sifa", max: 10 },
        { name: "Fasaha", max: 10 },
        { name: "Talaffuz", max: 5 },
        { name: "Maqamat", max: 5 }
    ];

    // 2. CSV HEADERS CONSTRUCTION
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

    // Dynamic Headers for 5 Judges (Detailed Columns)
    for (let j = 1; j <= 5; j++) {
        criteria.forEach(c => {
            csv += `J${j}-${c.name} (${c.max}),`; // Individual Criteria
        });
        csv += `J${j}-TOTAL,`; // Judge's Total
    }

    // Final Summary Columns
    csv += "GRAND TOTAL (5 Judges),FINAL AVERAGE,RANK,REMARKS (Top list)\n";

    // 3. DATA POOLS (Random Data Sources)
    const institutions = [
        "Arabiyya School", "Iskandhar School", "Majeedhiyya School", "Aminiya School", 
        "Jamaluddin School", "Kulliyya", "Villa College", "MNU", "IUM", 
        "Fathura Quran Class", "Tharteel Academy", "Private Candidate", "Imaduddin School"
    ];
    const islands = ["Male'", "Hulhumale'", "Addu City", "Fuvahmulah", "Kulhudhuffushi", "Thinadhoo", "Naifaru"];
    const branches = ["Balaiygen", "Nubalai"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "Under 21", "General"];
    const names = ["Ahmed", "Mohamed", "Ibrahim", "Ali", "Hussain", "Fathimath", "Aishath", "Mariyam", "Aminath", "Zainab", "Yusuf", "Musa"];
    const lastNames = ["Rasheed", "Nazeer", "Fayaz", "Manik", "Didi", "Saeed", "Zahir", "Riza", "Nasir"];

    let students = [];
    let serialCounter = 1;

    // 4. GENERATION LOOP (Creating 300+ Students)
    institutions.forEach(inst => {
        branches.forEach(branch => {
            groups.forEach(group => {
                const count = Math.floor(Math.random() * 2) + 1; // 1-2 students per combo
                
                for(let k=0; k<count; k++) {
                    // --- Personal Info Generation ---
                    const fname = names[Math.floor(Math.random() * names.length)];
                    const lname = lastNames[Math.floor(Math.random() * lastNames.length)];
                    const fullName = `${fname} ${lname}`;
                    const gender = (["Fathimath","Aishath","Mariyam","Aminath","Zainab"].includes(fname)) ? "Female" : "Male";
                    const addr = islands[Math.floor(Math.random() * islands.length)];
                    const idCard = `A${Math.floor(Math.random() * 899999) + 100000}`;
                    const regNo = `REG-${1000 + serialCounter}`;

                    // --- SCORING ENGINE (5 Judges) ---
                    let rowData = {
                        // Store basic info in specific object keys to map correctly later
                        reg: regNo, group: group, branch: branch, inst: inst, 
                        name: fullName, gender: gender, addr: addr, id: idCard,
                        
                        // Score Data
                        judgeColumns: [], // Stores J1-Crit1, J1-Crit2... J1-Total...
                        grandTotal: 0,
                        finalAvg: 0
                    };

                    let grandTotal = 0;

                    for(let j=1; j<=5; j++) {
                        // Student Ability (Base) + Judge Variance
                        let ability = Math.random() * (0.98 - 0.65) + 0.65; 
                        let variance = (Math.random() * 0.10) - 0.05; 
                        let performance = Math.min(1.0, Math.max(0, ability + variance));

                        let judgeTotal = 0;

                        // Generate Criteria Scores
                        criteria.forEach(c => {
                            let raw = (c.max * performance) + ((Math.random()*2)-1);
                            let val = parseFloat(Math.min(c.max, Math.max(0, raw)).toFixed(2));
                            rowData.judgeColumns.push(val); // Add to CSV line
                            judgeTotal += val;
                        });

                        // Add Judge Total Column
                        let jTotalFixed = parseFloat(judgeTotal.toFixed(2));
                        rowData.judgeColumns.push(jTotalFixed);
                        grandTotal += jTotalFixed;
                    }

                    rowData.grandTotal = parseFloat(grandTotal.toFixed(2));
                    rowData.finalAvg = parseFloat((grandTotal / 5).toFixed(2));
                    
                    students.push(rowData);
                    serialCounter++;
                }
            });
        });
    });

    // 5. SORTING & RANKING
    students.sort((a, b) => b.finalAvg - a.finalAvg);

    // 6. BUILD CSV ROWS (Correct Alignment)
    students.forEach((s, idx) => {
        let rank = idx + 1;
        let remarks = "";
        if(rank <= 3) remarks = "Top 3 üèÜ";
        else if(rank <= 5) remarks = "Top 5 üéñÔ∏è";

        let row = [];
        
        // --- COLUMNS 0 to 12 (Must match LoadBatch) ---
        row.push(rank); // Serial (Rank Based)
        row.push(`"${s.reg}"`);
        row.push(`"${s.group}"`);
        row.push(`"${s.branch}"`);
        row.push(`"${s.inst}"`);
        row.push(`"${s.name}"`);
        row.push(`"${s.gender}"`);
        row.push(`"${s.addr}"`);
        row.push(`"${s.id}"`);
        row.push("7770000"); // Contact
        row.push("Parent Name");
        row.push("7771111");
        row.push("test@email.com");

        // --- JUDGE COLUMNS (Detailed) ---
        s.judgeColumns.forEach(val => row.push(val));

        // --- FINAL CALCULATIONS ---
        row.push(s.grandTotal); // Sum of 5 Judges
        row.push(s.finalAvg);   // Average
        row.push(rank);         // Rank
        row.push(`"${remarks}"`); // Remarks

        csv += row.join(",") + "\n";
    });

    

    // 7. DOWNLOAD
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Rasfahi_Ultimate_Master_${dateStr}.csv`;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- BULK JUDGE SHEET PRINTING (FARUUMA FONT) ---
function printBulkJudgeSheets() {
    const judgeKey = document.getElementById('bulkJudgeSelect').value; // e.g., "Judge_1"
    const savedData = state.judging.savedResults;

    if (!savedData || savedData.length === 0) {
        alert("ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ©ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨.");
        return;
    }

    // Report Headers
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞";

    // Rubric Items
    const rubric = state.judging.rubric;
    
    // Generate Sheets HTML
    let sheetsHTML = "";

    savedData.forEach((student, index) => {
        // Calculate Marks given by THIS specific judge
        let judgeTotal = student.scores[judgeKey] || 0;
        let marksRows = "";
        
        // Note: Since we only save the Total Score per judge (to save memory), 
        // we can't show the breakdown per category unless we change the saving logic.
        // For now, we will show the Categories and leave marks blank or show Total.
        // If you want breakdown, we need to change how data is SAVED first.
        // Assuming user wants the "Total" shown and categories listed for signature.

        rubric.forEach(r => {
            marksRows += `
            <tr>
                <td style="text-align:right;">${r.name}</td>
                <td>${r.max}</td>
                <td>-</td> </tr>`;
        });

        // Add Page Break for all except last one
        const pageBreak = (index < savedData.length - 1) ? "page-break-after: always;" : "";

        sheetsHTML += `
        <div class="sheet-page" style="${pageBreak}">
            <div class="sheet-header">
                <h1>${instName}</h1>
                <h2>${compName}</h2>
                <div class="judge-badge">${judgeKey.replace('_', ' ')}</div>
            </div>

            <div class="student-info">
                <table class="info-table">
                    <tr>
                        <td class="label">ﬁÇﬁ¶ﬁÇﬁ∞:</td>
                        <td class="data">${student.name}</td>
                        <td class="label">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©:</td>
                        <td class="data">${student.id}</td>
                    </tr>
                    <tr>
                        <td class="label">ﬁéﬁÆﬁäﬁ®:</td>
                        <td class="data">${student.branch}</td>
                        <td class="label">ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™:</td>
                        <td class="data">${student.group}</td>
                    </tr>
                    <tr>
                        <td class="label">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß:</td>
                        <td class="data" colspan="3">${student.institution || student.instType || '-'}</td>
                    </tr>
                </table>
            </div>

            <table class="marks-table">
                <thead>
                    <tr>
                        <th width="50%">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>
                        <th width="20%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                        <th width="30%">ﬁãﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${marksRows}
                    <tr class="total-row">
                        <td style="text-align:right; font-weight:bold;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (TOTAL)</td>
                        <td></td>
                        <td style="font-size:24px;">${judgeTotal}</td>
                    </tr>
                </tbody>
            </table>

            <div class="remarks-box">
                <p>ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞: __________________________________________________</p>
            </div>

            <div class="signature-area">
                <div>
                    ____________________<br>
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®
                </div>
                <div>
                    ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}
                </div>
            </div>
            
            <div class="footer-tiny">Serial: ${index + 1} | Reg: ${student.reg || '-'}</div>
        </div>
        `;
    });

    // Full HTML Document with Faruuma Font
    const fullHTML = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Bulk Judge Sheets</title>
        <style>
            /* Font Imports */
            @font-face {
                font-family: 'Faruuma';
                src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
            }
            
            body { 
                font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif; 
                margin: 0; padding: 20px; background: #ccc; 
            }
            
            .sheet-page {
                background: white;
                width: 210mm; /* A4 Width */
                min-height: 297mm; /* A4 Height */
                padding: 40px;
                margin: 0 auto 20px auto;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }

            h1, h2 { text-align: center; margin: 5px 0; }
            h1 { font-size: 28px; text-decoration: underline; }
            h2 { font-size: 20px; color: #444; }

            .judge-badge {
                position: absolute; top: 40px; left: 40px;
                border: 2px solid #000; padding: 5px 10px;
                font-weight: bold; font-size: 18px; text-transform: uppercase;
                direction: ltr;
            }

            .info-table { width: 100%; border-collapse: collapse; margin-top: 30px; margin-bottom: 20px; }
            .info-table td { padding: 8px; border: 1px solid #ddd; font-size: 16px; }
            .label { background: #f9f9f9; font-weight: bold; width: 15%; }
            .data { width: 35%; font-weight:bold; }

            .marks-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .marks-table th { background: #eee; padding: 10px; border: 1px solid #000; font-weight: bold; }
            .marks-table td { padding: 10px; border: 1px solid #000; text-align: center; font-size: 18px; }
            
            .total-row td { background: #333; color: white; border-color: #000; }

            .remarks-box { margin-top: 40px; border: 1px dashed #000; padding: 20px; height: 60px; }
            
            .signature-area { margin-top: 60px; display: flex; justify-content: space-between; padding: 0 50px; font-size: 18px; }
            
            .footer-tiny { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; font-size: 10px; color: #888; direction: ltr; }

            @media print {
                body { background: none; padding: 0; }
                .sheet-page { margin: 0; box-shadow: none; width: 100%; }
                button { display: none; }
            }
        </style>
    </head>
    <body>
        <div style="text-align:center; margin-bottom:20px;">
            <button onclick="window.print()" style="padding:15px 30px; font-size:20px; background:blue; color:white; border:none; cursor:pointer;">
                üñ®Ô∏è CLICK TO PRINT / SAVE AS PDF
            </button>
        </div>
        ${sheetsHTML}
    </body>
    </html>
    `;

    const w = window.open("", "BulkPrint", "width=900,height=1000");
    w.document.write(fullHTML);
    w.document.close();
}
    // --- NEW SEARCH LOGIC (DATALIST) ---

// 1. Update the Datalist when batch is loaded
function populateStudentSelector() {
    const dList = document.getElementById('studentDatalist');
    dList.innerHTML = ''; // Clear old
    
    state.allStudents.forEach((s, idx) => {
        const option = document.createElement('option');
        // Value contains the unique identifier to find it later
        option.value = `${s.name} (${s.id})`; 
        dList.appendChild(option);
    });
}

// 2. Handle Selection (When user picks from list or hits enter)
function onStudentSelected(val) {
    if(!val) return;
    
    // Find the index of the selected student string
    // We check if "Name (ID)" matches the input
    const index = state.allStudents.findIndex(s => `${s.name} (${s.id})` === val);
    
    if (index > -1) {
        populateStudentForm(index);
        // Optional: Clear input after selection if desired, or keep it
    } else {
        alert("Student not found! Please check the name.");
    }
}
    // --- 3. A3 MANUAL MASTER SHEET (EXACT MATCH WITH TEMPLATE/DUMMY) ---
function downloadDetailedManualSheet() {
    // 1. SETUP HEADERS & CRITERIA
    // ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ≠ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Must match exactly with other sheets)
    const criteria = (state.judging.rubric && state.judging.rubric.length > 0) 
        ? state.judging.rubric 
        : [
            { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
            { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
            { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, { name: "Maqamat", max: 5 }
          ];

    // CSV Headers - Part 1: Personal Info
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

    // CSV Headers - Part 2: 5 Judges Detailed Columns
    for (let j = 1; j <= 5; j++) {
        criteria.forEach(c => { csv += `J${j}-${c.name} (${c.max}),`; });
        csv += `J${j}-TOTAL,`;
    }

    // CSV Headers - Part 3: Final Summary
    csv += "GRAND TOTAL (5 Judges),FINAL AVERAGE,RANK,REMARKS\n";

    // 2. GET STUDENTS
    // Use savedResults if available (has scores), otherwise allStudents (raw list)
    // We try to merge them to show scores if they exist.
    let students = state.allStudents; 
    if(!students || students.length === 0) {
        // If allStudents is empty, try savedResults
        students = state.judging.savedResults;
    }

    if (!students || students.length === 0) {
        alert("No students found to generate sheet! (Please load a batch first)");
        return;
    }

    // 3. GENERATE ROWS
    students.forEach((s, index) => {
        let row = [];

        // --- A. Personal Info (Aligned with Template) ---
        // 0:Serial, 1:Reg, 2:Group, 3:Branch, 4:Inst, 5:Name, 6:Gender, 7:Addr, 8:ID...
        row.push(index + 1); // Serial
        row.push(`"${s.reg || ''}"`);
        row.push(`"${s.group || ''}"`);
        row.push(`"${s.branch || ''}"`);
        row.push(`"${s.institution || s.inst || ''}"`);
        row.push(`"${s.name || ''}"`);
        row.push(`"${s.gender || ''}"`);
        row.push(`"${s.address || s.addr || ''}"`);
        row.push(`"${s.id || ''}"`);
        row.push(`"${s.phone || '7770000'}"`);
        row.push(`"${s.parent || ''}"`);
        row.push(`"${s.parentPhone || ''}"`);
        row.push(`"${s.email || ''}"`);

        // --- B. Judges Detailed Columns (Logic to fill or leave blank) ---
        
        // Check if we have detailed data from the "Dummy Generator" (judgeColumns)
        if (s.judgeColumns && s.judgeColumns.length > 0) {
            // If data comes from the Fake Generator, it has all details perfectly
            s.judgeColumns.forEach(val => row.push(val));
        
        } else {
            // If data comes from Live Judging or Raw List:
            // The system usually stores scores in `s.scores` like {Judge_1: 90, Judge_2: 85}
            // It rarely stores the "Thilawa" breakdown individually for live judging to save memory.
            // So we will fill the TOTALS if we have them, and leave criteria BLANK for manual entry.
            
            for (let j = 1; j <= 5; j++) {
                // Criteria Columns (Empty for manual marking)
                criteria.forEach(() => row.push("")); 
                
                // Judge Total (Fill if exists in saved results)
                let jKey = `Judge_${j}`;
                let jTot = (s.scores && s.scores[jKey]) ? s.scores[jKey] : "";
                
                // If it's a "Result Object" from savedResults, it might have finalScore but maybe not individual judge breakdown depending on how it was saved.
                // We assume basic compatibility here.
                row.push(jTot);
            }
        }

        // --- C. Final Calculations ---
        // Use pre-calculated values if from Dummy, otherwise calculate or leave blank
        let gTotal = s.grandTotal || ""; 
        let fAvg = s.finalScore || s.finalAvg || "";
        let rank = ""; // Rank needs sorting to be accurate, usually filled after competition
        let rem = "";

        // If we have live scores but no grand total pre-calculated
        if (gTotal === "" && s.scores) {
            let sum = 0;
            Object.values(s.scores).forEach(v => sum += parseFloat(v));
            if(sum > 0) gTotal = sum.toFixed(2);
        }

        row.push(gTotal);
        row.push(fAvg);
        row.push(rank);
        row.push(rem);

        csv += row.join(",") + "\n";
    });

    // 4. DOWNLOAD CSV
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Rasfahi_A3_Full_Master_${dateStr}.csv`;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // ‚òÖ FIXED: PREVENT DUPLICATES & SAVE LOGIC ‚òÖ
function finalizeScore() {
    // 1. ﬁÜﬁ¶ﬁÉﬁ¶ﬁÇﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁß ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const currentStd = state.judging.currentStudentObj;
    if(!currentStd || !currentStd.id) {
        alert("No active student selected!");
        return;
    }

    // 2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁñﬁ¶ﬁâﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const liveScores = state.judging.liveScores; 
    let totalScore = 0;
    let judgeCount = 0;

    for (let key in liveScores) {
        if (liveScores.hasOwnProperty(key)) {
            totalScore += parseFloat(liveScores[key]);
            judgeCount++;
        }
    }

    // 3. ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞
    const finalAvg = judgeCount > 0 ? (totalScore / judgeCount).toFixed(2) : "0.00";

    // 4. ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const recordToSave = {
        ...currentStd,
        scores: {...liveScores},
        finalScore: parseFloat(finalAvg),
        savedAt: new Date().toISOString()
    };

    // ‚òÖ 5. ﬁëﬁ¶ﬁÑﬁ¶ﬁçﬁ∞ﬁàﬁ™ﬁÇﬁ∞ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ™ﬁÇﬁ∞ (ANTI-DUPLICATION LOGIC) ‚òÖ
    // ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁâﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁáﬁÆﬁåﬁ∞ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    // (Ensure savedResults exists)
    if (!state.judging.savedResults) {
        state.judging.savedResults = [];
    }

    const existingIndex = state.judging.savedResults.findIndex(s => s.id === recordToSave.id);

    if (existingIndex > -1) {
        // CASE A: ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁáﬁ¨ﬁÑﬁ¶ﬁáﬁ®ﬁÇﬁ∞ -> ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠
        state.judging.savedResults[existingIndex] = recordToSave;
        console.log(`Updated existing record for ${recordToSave.name}`);
    } else {
        // CASE B: ﬁáﬁ¶ﬁçﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁáﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¨ﬁáﬁ∞ -> ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁÜﬁ™ﬁÉﬁ≠
        state.judging.savedResults.push(recordToSave);
        console.log(`Added new record for ${recordToSave.name}`);
    }

    // 6. ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    saveToLocal();
    if(typeof updateSavedResultsList === 'function') {
        updateSavedResultsList(); 
    }
    
    // 7. ﬁÜﬁßﬁâﬁ®ﬁîﬁßﬁÑﬁ™ﬁàﬁ®ﬁÜﬁ¶ﬁÇﬁ∞ ﬁáﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÇﬁ∞
    const btn = document.getElementById('btnFinalize');
    if(btn) {
        btn.innerText = "Saved! ‚úÖ";
        btn.disabled = true; // Prevent double clicking
        setTimeout(() => {
            btn.innerText = "‚úÖ Save Student Result";
            btn.disabled = false;
        }, 2000);
    }
    
    alert(`Saved Successfully!\nStudent: ${recordToSave.name}\nFinal Score: ${finalAvg}`);
}
    // ‚òÖ FIXED REPORT GENERATOR (WITH FARUUMA FONT) ‚òÖ
function generateAdvancedReport(mode) {
    // 1. ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞ ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let list = getFilteredResults(); 
    
    // 2. ﬁâﬁØﬁëﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Top 3, 5, or Full)
    let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
    if(mode === 'top3') { 
        list.sort((a,b) => b.finalScore - a.finalScore); 
        list = list.slice(0, 3); 
        titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3)"; 
    }
    if(mode === 'top5') { 
        list.sort((a,b) => b.finalScore - a.finalScore); 
        list = list.slice(0, 5); 
        titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5)"; 
    }

    if(list.length === 0) { alert("ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁáﬁ® ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨."); return; }

    // 3. ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞";
    
    // ﬁéﬁÆﬁäﬁ® ﬁáﬁ¶ﬁãﬁ® ﬁáﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß ﬁìﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁÄﬁØﬁãﬁ™ﬁÇﬁ∞
    const bSel = document.getElementById('rptFilterBranch');
    const branchTxt = bSel.options[bSel.selectedIndex].text;
    
    const gSel = document.getElementById('rptFilterGroup');
    const groupTxt = gSel.options[gSel.selectedIndex].text;

    // 4. HTML ﬁñﬁ¨ﬁÇﬁ¨ﬁÉﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (With Font Fix)
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Result Report</title>
        <style>
            /* 1. Google Font Import (Fallback for Faruuma) */
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            /* 2. Main Font Settings */
            body { 
                /* Faruuma first, then Waheed, then Google Font */
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                background: white;
                padding: 40px;
                direction: rtl; 
            }

            /* 3. Table Styles */
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            th { background: #eee; font-weight: bold; border: 1px solid #444; padding: 10px; font-size:15px; }
            td { border: 1px solid #444; padding: 8px; text-align: center; font-size:14px; }
            
            /* 4. Layout Styles */
            h1 { font-size: 28px; text-decoration: underline; text-align: center; margin: 5px; }
            h2 { font-size: 20px; text-align: center; margin: 5px; color:#333; }
            h3 { font-size: 18px; text-align: center; margin: 5px; }
            
            .info-box { border:1px solid #ccc; padding:10px; margin-bottom:20px; display:flex; justify-content:space-between; font-weight:bold; background:#f9f9f9; }

            .rank-1 { background-color: #fffacD; font-weight: bold; } /* 1st place highlight */

            @media print { button { display: none; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="padding:15px; width:100%; background:navy; color:white; font-size:18px; margin-bottom:20px; cursor:pointer;">üñ®Ô∏è ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</button>

        <h1>${instName}</h1>
        <h2>${compName}</h2>
        <h3>${titleSuffix}</h3>
        
        <div class="info-box">
            <span>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</span>
            <span>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${groupTxt}</span>
            <span>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                    <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="30%">ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="10%">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©</th>
                    <th width="15%">ﬁéﬁÆﬁäﬁ®/ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™</th>
                    <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                    <th width="5%">ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr class="${i===0 ? 'rank-1' : ''}">
                        <td>${i+1}</td>
                        <td>${s.reg || '-'}</td>
                        <td style="text-align:right; padding-right:15px;">${s.name}</td>
                        <td>${s.id}</td>
                        <td>${s.branch} / ${s.group}</td>
                        <td style="font-weight:bold; font-size:16px;">${s.finalScore}</td>
                        <td>${i+1}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div style="margin-top:50px; text-align:center;">
            __________________________<br>
            ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®
        </div>
    </body>
    </html>`;

    const w = window.open("", "Report", "width=1000,height=800");
    w.document.write(html);
    w.document.close();
}
    // --- 4. SESSION ATTENDANCE / NOTICE BOARD LIST (ALIGNED WITH JUDGE SHEET) ---
function generateSessionList() {
    // 1. INPUTS & VALIDATION
    const dateEl = document.getElementById('sessDate');
    const timeEl = document.getElementById('sessTime');
    const nameEl = document.getElementById('sessName');
    
    if(!dateEl || !timeEl) { alert("Error: HTML Elements Missing!"); return; }

    const dateInput = dateEl.value;
    const timeInput = timeEl.value;
    const sessionName = nameEl.value || "-";
    
    // Filters (Must match Judge Sheet Logic)
    const filterBranch = document.getElementById('sessFilterBranch').value;
    const filterGroup = document.getElementById('sessFilterGroup').value;
    const filterGender = document.getElementById('sessFilterGender').value;
    const filterInst = document.getElementById('sessFilterInst').value; // Institution Filter

    // Day Name Calculation
    let dayName = "_______";
    if(dateInput) {
        const d = new Date(dateInput);
        const dvDays = ["ﬁáﬁßﬁãﬁ©ﬁáﬁ∞ﬁåﬁ¶", "ﬁÄﬁØﬁâﬁ¶", "ﬁáﬁ¶ﬁÇﬁ∞ﬁéﬁßﬁÉﬁ¶", "ﬁÑﬁ™ﬁãﬁ¶", "ﬁÑﬁ™ﬁÉﬁßﬁêﬁ∞ﬁäﬁ¶ﬁåﬁ®", "ﬁÄﬁ™ﬁÜﬁ™ﬁÉﬁ™", "ﬁÄﬁÆﬁÇﬁ®ﬁÄﬁ®ﬁÉﬁ™"];
        dayName = dvDays[d.getDay()];
    }

    // 2. GET & FILTER STUDENTS
    // Use Saved Results if available (for consistent names), else Master List
    let students = (state.allStudents && state.allStudents.length > 0) 
                   ? state.allStudents 
                   : state.judging.savedResults;

    if(!students || students.length === 0) {
        alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨! (Please Load CSV First)");
        return;
    }

    // ‚òÖ ALIGNED FILTER LOGIC (Same as Judge Sheet) ‚òÖ
    let list = students.filter(s => {
        let matchBranch = filterBranch === "" || (s.branch && s.branch.trim() === filterBranch);
        let matchGroup = filterGroup === "" || (s.group && s.group.trim() === filterGroup);
        let matchGender = filterGender === "" || (s.gender && s.gender.trim() === filterGender);
        
        // Inst Filter
        let matchInst = true;
        if(filterInst !== "") {
            const instName = (s.institution || s.inst || "").toLowerCase();
            const typeCheck = filterInst.toLowerCase();
            if(instName.includes(typeCheck)) matchInst = true;
            else if(filterInst === "Private" && (instName === "" || instName.includes("private") || instName.includes("amilla"))) matchInst = true;
            else matchInst = false;
        }

        return matchBranch && matchGroup && matchGender && matchInst;
    });

    if(list.length === 0) {
        alert("ﬁåﬁ®ﬁîﬁ¶ ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ¶ﬁÅﬁ∞/ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁäﬁ¨ﬁåﬁ≠ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨.");
        return;
    }

    // Sort by Registry
    list.sort((a, b) => a.reg.localeCompare(b.reg));

    // 3. HEADER INFO
    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const title = "ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ™ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁÄﬁßﬁíﬁ®ﬁÉﬁ™ﬁàﬁßﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁéﬁÆﬁåﬁ™ﬁéﬁ¨ ﬁåﬁßﬁàﬁ¶ﬁçﬁ™";

    // 4. FONT SETUP
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    // 5. GENERATE HTML
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Session Attendance List</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                padding: 20px; direction: rtl; 
            }
            h1 { font-size: 26px; text-decoration: underline; text-align:center; margin:5px; font-weight:bold; }
            h2 { font-size: 20px; text-align:center; margin:5px; color:#333; }
            h3 { font-size: 18px; text-align:center; margin-top:5px; text-decoration:underline; }
            
            .meta-box {
                border: 2px solid #000; padding: 15px; margin: 20px 0;
                display: flex; justify-content: space-between; align-items: center;
                font-weight: bold; font-size: 15px; background: #f0f0f0;
            }
            .meta-col { display:flex; flex-direction:column; gap:5px; }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            th { background: #ddd; font-weight: bold; border: 1px solid #000; padding: 8px; font-size: 15px; vertical-align: middle; }
            td { border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle; height:35px; }
            
            @media print { 
                button { display: none; } 
                @page { size: A4 landscape; margin: 10mm; } 
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="padding:15px; width:100%; background:navy; color:white; font-size:18px; margin-bottom:20px; cursor:pointer;">üñ®Ô∏è ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ (PRINT)</button>

        <h1>${instName}</h1>
        <h2>${compName}</h2>
        <h3>${title}</h3>
        
        <div class="meta-box">
            <div class="meta-col" style="text-align:right;">
                <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${dateInput || '_______'}</div>
                <div>ﬁãﬁ™ﬁàﬁ¶ﬁêﬁ∞: ${dayName}</div>
                <div>ﬁéﬁ¶ﬁëﬁ®: ${timeInput || '_______'}</div>
            </div>
            
            <div class="meta-col" style="text-align:center; border-left:1px solid #ccc; border-right:1px solid #ccc; padding:0 20px;">
                <div>ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞: ${sessionName}</div>
                <div>ﬁÄﬁØﬁçﬁ∞: __________________</div>
            </div>

            <div class="meta-col" style="text-align:left;">
                <div>ﬁéﬁÆﬁäﬁ®: ${filterBranch || 'All'}</div>
                <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${filterGroup || 'All'}</div>
                <div>ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞: ${filterInst || 'All'}</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="3%">#</th>
                    <th width="8%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="22%">ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="8%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="15%">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß / ﬁêﬁ∞ﬁÜﬁ´ﬁçﬁ∞</th>
                    <th width="5%">ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™</th>
                    <th width="10%">ﬁéﬁÆﬁäﬁ®/ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™</th>
                    <th width="10%">ﬁÄﬁßﬁíﬁ®ﬁÉﬁ™</th>
                    <th width="19%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.reg}</td>
                        <td style="text-align:right; padding-right:10px; font-weight:bold;">${s.name}</td>
                        <td>${s.id}</td>
                        <td style="font-size:13px;">${s.institution || s.inst || '-'}</td>
                        <td>${s.gender}</td>
                        <td style="font-size:12px;">${s.branch}<br>${s.group}</td>
                        <td>‚¨ú</td> 
                        <td></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div style="margin-top:20px; font-size:12px; color:#555; text-align:center;">
            ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁÇﬁ∞: ${list.length} | ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ©: ${new Date().toLocaleDateString()}
        </div>
    </body>
    </html>`;

    const w = window.open("", "SessionList", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}
    // ======================================================
// ‚òÖ FIXED PRINT FUNCTIONS (WITH FARUUMA FONT SUPPORT) ‚òÖ
// ======================================================

// 1. SESSION ATTENDANCE LIST (FIXED)
function generateSessionList() {
    // A. Inputs & Validation
    const dateInput = document.getElementById('sessDate').value;
    const timeInput = document.getElementById('sessTime').value;
    const sessionName = document.getElementById('sessName').value || "-";
    const filterBranch = document.getElementById('sessFilterBranch').value;
    const filterGroup = document.getElementById('sessFilterGroup').value;
    const filterGender = document.getElementById('sessFilterGender').value;

    // Day Name Generation
    let dayName = "-";
    if(dateInput) {
        const d = new Date(dateInput);
        const dvDays = ["ﬁáﬁßﬁãﬁ©ﬁáﬁ∞ﬁåﬁ¶", "ﬁÄﬁØﬁâﬁ¶", "ﬁáﬁ¶ﬁÇﬁ∞ﬁéﬁßﬁÉﬁ¶", "ﬁÑﬁ™ﬁãﬁ¶", "ﬁÑﬁ™ﬁÉﬁßﬁêﬁ∞ﬁäﬁ¶ﬁåﬁ®", "ﬁÄﬁ™ﬁÜﬁ™ﬁÉﬁ™", "ﬁÄﬁÆﬁÇﬁ®ﬁÄﬁ®ﬁÉﬁ™"];
        dayName = dvDays[d.getDay()];
    }

    // B. Filter Students
    let students = (state.allStudents && state.allStudents.length > 0) ? state.allStudents : state.judging.savedResults;
    if(!students || students.length === 0) { alert("No students found!"); return; }

    let list = students.filter(s => {
        let matchBranch = filterBranch === "" || (s.branch && s.branch.trim() === filterBranch);
        let matchGroup = filterGroup === "" || (s.group && s.group.trim() === filterGroup);
        let matchGender = filterGender === "" || (s.gender && s.gender.trim() === filterGender);
        return matchBranch && matchGroup && matchGender;
    });

    if(list.length === 0) { alert("No students match filters."); return; }
    list.sort((a, b) => a.reg.localeCompare(b.reg));

    // C. Font Injection (CRITICAL FIX)
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    // D. Generate HTML
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const title = `${filterBranch} - ${filterGroup} - ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™`;

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Session List</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                padding: 20px; direction: rtl; 
            }
            h1 { font-size: 24px; text-decoration: underline; text-align:center; margin:5px; }
            h2 { font-size: 18px; text-align:center; margin:5px; color:#444; }
            
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
            th { background: #eee; font-weight: bold; border: 1px solid #444; padding: 8px; font-size: 14px; }
            td { border: 1px solid #444; padding: 6px; text-align: center; }
            
            @media print { 
                button { display: none; } 
                @page { size: A4 landscape; margin: 10mm; } 
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="padding:15px; width:100%; background:navy; color:white; font-size:18px; margin-bottom:20px; cursor:pointer;">üñ®Ô∏è ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß</button>

        <h1>${instName}</h1>
        <h2>${title}</h2>
        
        <div style="border:1px solid #000; padding:10px; margin:10px 0; display:flex; justify-content:space-between; font-weight:bold;">
            <span>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${dateInput || '-'} (${dayName})</span>
            <span>ﬁéﬁ¶ﬁëﬁ®: ${timeInput || '-'}</span>
            <span>ﬁãﬁ¶ﬁÇﬁ∞ﬁäﬁ¶ﬁÖﬁ®: ${sessionName}</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="3%">#</th>
                    <th width="8%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="25%">ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="8%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="5%">ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™</th>
                    <th width="8%">ﬁéﬁÆﬁäﬁ®</th>
                    <th width="8%">ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™</th>
                    <th width="10%">ﬁÄﬁßﬁíﬁ®ﬁÉﬁ™ﬁàﬁ©ﬁéﬁ¶ﬁëﬁ®</th>
                    <th width="10%">ﬁêﬁÆﬁáﬁ®</th>
                    <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.reg}</td>
                        <td style="text-align:right; padding-right:10px;">${s.name}</td>
                        <td>${s.id}</td>
                        <td>${s.gender}</td>
                        <td>${s.branch}</td>
                        <td>${s.group}</td>
                        <td></td> <td></td> <td></td>
                    </tr>`).join('')}
            </tbody>
        </table>
        <div style="margin-top:20px; font-size:12px; color:#555;">
            ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶: ${list.length} ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ | ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ©: ${new Date().toLocaleDateString()}
        </div>
    </body>
    </html>`;

    const w = window.open("", "SessionList", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}

// 2. ADVANCED REPORT (TOP LISTS & FULL RESULTS) - FIXED
function generateAdvancedReport(mode) {
    let list = getFilteredResults();
    
    let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
    if(mode === 'top3') { list = list.slice(0, 3); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3)"; }
    if(mode === 'top5') { list = list.slice(0, 5); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5)"; }

    if(list.length === 0) { alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!"); return; }

    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞";
    const judgeCount = parseInt(document.getElementById('rptJudgeCount').value) || 3;
    
    // Safety check for dropdowns
    const bEl = document.getElementById('rptFilterBranch');
    const gEl = document.getElementById('rptFilterGroup');
    const branchTxt = bEl.options[bEl.selectedIndex].text;
    const groupTxt = gEl.options[gEl.selectedIndex].text;

    const chiefName = document.getElementById('rptChief').value || "__________________";

    let sigLines = '';
    for(let i=1; i<=judgeCount; i++) {
        sigLines += `<div class="sig-box"><div class="line"></div><div class="label">ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ ${i}</div></div>`;
    }

    // Font Injection
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Result Report</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                padding: 40px; direction: rtl; 
            }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 20px; }
            h1 { margin: 5px 0; font-size: 26px; font-weight:bold; }
            h2 { margin: 5px 0; font-size: 20px; color: #333; }
            h3 { margin: 5px 0; font-size: 18px; text-decoration: underline; }
            
            .report-info-box {
                border: 1px solid #000; padding: 15px; margin-bottom: 20px;
                display: flex; justify-content: space-between;
                background: #f9f9f9; font-weight: bold; font-size: 14px;
            }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
            th { background: #eee; font-weight: bold; font-size: 15px; }
            tr:nth-child(1) td { background: #fffbe6; font-weight:bold; } 

            .footer { margin-top: 50px; }
            .judges-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
            .sig-box { width: 30%; text-align: center; margin-bottom: 30px; }
            .line { border-bottom: 1px dotted #000; margin-bottom: 5px; height: 40px; }
            .label { font-size: 12px; color: #555; }
            @media print { button { display: none; } body { -webkit-print-color-adjust: exact; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="position:fixed; top:10px; left:10px; padding:10px 20px; background:blue; color:white; cursor:pointer;">üñ®Ô∏è PRINT</button>
        <div class="header">
            <h1>${instName}</h1>
            <h2>${compName}</h2>
            <h3>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞ ${titleSuffix}</h3>
        </div>
        <div class="report-info-box">
            <div>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</div>
            <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß: ${groupTxt}</div>
            <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                    <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="25%">ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</th>
                    <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                    <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.reg || "-"}</td>
                        <td style="text-align:right; padding-right:10px;">${s.name}</td>
                        <td>${s.id}</td>
                        <td style="text-align:right; font-size:11px;">${s.address || "-"}</td>
                        <td><b>${s.finalScore}</b></td>
                        <td></td>
                    </tr>`).join('')}
            </tbody>
        </table>
        <div class="footer">
            <div style="text-align:left; margin-bottom:30px;">
                ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™: ________________ ${chiefName}
            </div>
            <div class="judges-grid">${sigLines}</div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "Report", "width=1100,height=800");
    w.document.write(html);
    w.document.close();
}

// 3. BLANK JUDGE SHEET (FIXED)
function downloadManualScoreSheet() {
    const rubric = state.judging.rubric;
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞";
    
    let totalMax = 0;
    rubric.forEach(r => totalMax += r.max);

    let rows = "";
    rubric.forEach(r => {
        rows += `
        <tr>
            <td style="text-align:right; font-weight:bold; font-size:16px;">${r.name}</td>
            <td style="font-weight:bold;">${r.max}</td>
            <td></td> <td style="color:#ccc;">___________</td> 
        </tr>`;
    });

    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Judge Score Sheet</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; 
                padding: 40px; direction: rtl; -webkit-print-color-adjust: exact;
            }
            .sheet-container { border: 5px double #000; padding: 30px; height: 95vh; box-sizing: border-box; }
            h1 { text-align: center; margin: 0; font-size: 24px; text-decoration: underline; }
            h2 { text-align: center; margin: 5px 0 30px 0; font-size: 18px; color: #444; }

            .info-grid {
                display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
                margin-bottom: 20px; border: 1px solid #333; padding: 15px; background: #f9f9f9;
            }
            .input-line { margin-bottom: 15px; font-size: 14px; font-weight: bold; }
            .dotted { border-bottom: 2px dotted #000; display: inline-block; width: 60%; }

            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000; padding: 12px; text-align: center; vertical-align: middle; }
            th { background: #eee; font-size: 15px; font-weight: bold; }
            .total-row td { background: #333; color: #fff; font-weight: bold; font-size: 18px; }
            
            .footer-sig { margin-top: 50px; display: flex; justify-content: space-between; }
            .sig-box { text-align: center; width: 40%; }

            @media print { button { display: none; } @page { size: A4 portrait; margin: 10mm; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="width:100%; padding:20px; font-size:20px; background:#002200; color:#fff; cursor:pointer; margin-bottom:20px;">üñ®Ô∏è CLICK TO PRINT</button>

        <div class="sheet-container">
            <h1>${instName}</h1>
            <h2>${compName} - ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞</h2>

            <div class="info-grid">
                <div>
                    <div class="input-line">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞: <span class="dotted"></span></div>
                    <div class="input-line">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ© / ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: <span class="dotted" style="width:50%"></span></div>
                    <div class="input-line">ﬁéﬁÆﬁäﬁ® / ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: <span class="dotted"></span></div>
                </div>
                <div style="text-align:left;">
                    <div class="input-line" style="direction:ltr;">Date: __________________</div>
                    <div class="input-line" style="direction:ltr;">Judge Name: __________________</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="40%">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>
                        <th width="15%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                        <th width="20%">ﬁãﬁ≠ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                        <th width="25%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                    <tr class="total-row">
                        <td style="text-align:right;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (TOTAL)</td>
                        <td>${totalMax}</td>
                        <td></td> <td></td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top:40px; border:1px dashed #777; padding:15px; height:80px;">
                <strong>ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁåﬁ¶ﬁáﬁ∞ (General Remarks):</strong>
            </div>

            <div class="footer-sig">
                <div class="sig-box">
                    <br>_______________________<br>
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ® (Signature)
                </div>
            </div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "ManualSheet", "width=900,height=1000");
    w.document.write(html);
    w.document.close();
}
    // --- GENERATE JUDGE SESSION SHEET (UPDATED WITH INST FILTER) ---
function generateJudgeSessionSheet() {
    // 1. Inputs ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const dateEl = document.getElementById('sessDate');
    const timeEl = document.getElementById('sessTime');
    const nameEl = document.getElementById('sessName');
    
    // HTML ﬁáﬁ¨ﬁçﬁ¨ﬁâﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁîﬁ¶ﬁ§ﬁ©ﬁÇﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    if(!dateEl) { alert("Error: Refresh Page."); return; }

    const dateInput = dateEl.value;
    const timeInput = timeEl.value;
    const sessionName = nameEl.value || "-";
    const limitVal = document.getElementById('sessLimit').value;
    
    // Filters
    const filterBranch = document.getElementById('sessFilterBranch').value;
    const filterGroup = document.getElementById('sessFilterGroup').value;
    const filterGender = document.getElementById('sessFilterGender').value;
    const filterInst = document.getElementById('sessFilterInst').value; // ‚òÖ New Filter

    // Day Name
    let dayName = "-";
    if(dateInput) {
        const d = new Date(dateInput);
        const dvDays = ["ﬁáﬁßﬁãﬁ©ﬁáﬁ∞ﬁåﬁ¶", "ﬁÄﬁØﬁâﬁ¶", "ﬁáﬁ¶ﬁÇﬁ∞ﬁéﬁßﬁÉﬁ¶", "ﬁÑﬁ™ﬁãﬁ¶", "ﬁÑﬁ™ﬁÉﬁßﬁêﬁ∞ﬁäﬁ¶ﬁåﬁ®", "ﬁÄﬁ™ﬁÜﬁ™ﬁÉﬁ™", "ﬁÄﬁÆﬁÇﬁ®ﬁÄﬁ®ﬁÉﬁ™"];
        dayName = dvDays[d.getDay()];
    }

    // 2. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let students = (state.allStudents && state.allStudents.length > 0) ? state.allStudents : state.judging.savedResults;

    if(!students || students.length === 0) { 
        alert("ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨! (Please Load CSV First)"); 
        return; 
    }

    let list = students.filter(s => {
        // Basic Filters
        let matchBranch = filterBranch === "" || (s.branch && s.branch.trim() === filterBranch);
        let matchGroup = filterGroup === "" || (s.group && s.group.trim() === filterGroup);
        let matchGender = filterGender === "" || (s.gender && s.gender.trim() === filterGender);
        
        // ‚òÖ Institution Category Filter Logic ‚òÖ
        let matchInst = true;
        if(filterInst !== "") {
            const instName = (s.institution || "").toLowerCase();
            const typeCheck = filterInst.toLowerCase();
            
            // Check if name contains keyword (e.g. "School" in "Arabiyya School")
            if(instName.includes(typeCheck)) {
                matchInst = true;
            } 
            // Specific check for "Private"
            else if(filterInst === "Private" && (instName === "" || instName.includes("private") || instName.includes("amilla"))) {
                matchInst = true;
            }
            else {
                matchInst = false;
            }
        }

        return matchBranch && matchGroup && matchGender && matchInst;
    });

    if(list.length === 0) { 
        alert("ﬁåﬁ®ﬁîﬁ¶ ﬁùﬁ¶ﬁÉﬁ™ﬁ†ﬁ™ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁäﬁ¨ﬁåﬁ≠ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨.\n(No students match the filters)"); 
        return; 
    }

    // 3. Sort & Limit
    list.sort((a, b) => a.reg.localeCompare(b.reg)); 
    
    if(limitVal !== "All") {
        const limit = parseInt(limitVal);
        list = list.slice(0, limit);
    }

    // 4. Rubric Headers
    const rubric = (state.judging && state.judging.rubric && state.judging.rubric.length > 0)
                   ? state.judging.rubric 
                   : [{name:"Criteria", max:100}];

    let criteriaHeaders = "";
    let totalMax = 0;

    rubric.forEach(r => {
        criteriaHeaders += `<th style="width:80px;">${r.name}<br><small>(${r.max})</small></th>`;
        totalMax += r.max;
    });

    // 5. Font Injection
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    // 6. Generate HTML
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Judge Session Sheet</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            body { 
                font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important;
                padding: 0; margin: 0; direction: rtl; 
            }
            @page { size: A4 landscape; margin: 10mm; }
            
            .sheet-container { width: 100%; text-align: center; padding:20px; }
            h1 { font-size: 24px; text-decoration: underline; margin: 5px 0; font-weight:bold; }
            h2 { font-size: 18px; margin: 5px 0; color:#333; font-weight:bold; }
            
            .meta-box {
                display: flex; justify-content: space-between;
                border: 2px solid #000; padding: 10px; margin: 10px 0;
                font-size: 14px; font-weight: bold; background: #f9f9f9;
            }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            th { background: #e0e0e0; border: 1px solid #000; padding: 5px; font-weight:bold; vertical-align:middle; font-size:13px; }
            td { border: 1px solid #000; padding: 5px; text-align: center; height: 35px; vertical-align:middle; }
            
            .col-remarks { width: 120px; }
            .footer { margin-top: 30px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sig-line { width: 200px; border-top: 1px dotted #000; padding-top: 5px; margin-top:30px; font-weight:bold; text-align:center; }
            
            @media print { button { display: none; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="position:fixed; top:0; left:0; width:100%; padding:10px; background:navy; color:white; font-size:18px; cursor:pointer;">üñ®Ô∏è PRINT SHEET</button>
        
        <div class="sheet-container">
            <h1>ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞</h1>
            <h2>ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞ (ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞)</h2>
            
            <div class="meta-box">
                <div>
                    ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${dateInput || '_______'} (${dayName}) <br>
                    ﬁãﬁ¶ﬁÇﬁ∞ﬁäﬁ¶ﬁÖﬁ®: ${sessionName}
                </div>
                <div style="text-align:center;">
                    ﬁéﬁÆﬁäﬁ®: ${filterBranch || 'All'} <br>
                    ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${filterGroup || 'All'}
                </div>
                <div style="text-align:left;">
                    ﬁÑﬁßﬁàﬁ¶ﬁåﬁ∞: ${filterInst || 'All'} <br>
                    ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™: ${filterGender || 'All'}
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="3%">#</th>
                        <th width="8%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                        <th width="20%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                        <th width="15%">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß</th>
                        ${criteriaHeaders}
                        <th width="6%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶<br><small>(${totalMax})</small></th>
                        <th class="col-remarks">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${list.map((s, i) => {
                        let emptyCells = rubric.map(() => `<td></td>`).join('');
                        return `
                        <tr>
                            <td>${i+1}</td>
                            <td>${s.reg}</td>
                            <td style="text-align:right; padding-right:5px; font-weight:bold;">${s.name}</td>
                            <td style="font-size:11px;">${s.institution || '-'}</td>
                            ${emptyCells}
                            <td></td>
                            <td></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>

            <div class="footer">
                <div><div class="sig-line">ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</div></div>
                <div><div class="sig-line">ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®</div></div>
                <div><div class="sig-line">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</div></div>
            </div>
            
            <div style="text-align:center; margin-top:20px; font-size:10px; color:#555;">
                Generated on: ${new Date().toLocaleDateString()} | Total Candidates: ${list.length}
            </div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "JudgeSheet", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}
    // ======================================================
// ‚òÖ NEW FUNCTIONS FOR TEMPLATE & IMPORT (FIXED) ‚òÖ
// ======================================================

// 1. BLANK MASTER TEMPLATE (EXACT MATCH WITH DUMMY)
// ﬁëﬁ¶ﬁâﬁ© ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁáﬁßﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁéﬁÆﬁåﬁ∞ÿå ﬁáﬁ¨ﬁÜﬁ¶ﬁâﬁ¶ﬁÜﬁ™ ﬁÄﬁ™ﬁêﬁ∞ ﬁéﬁÆﬁÖﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ¨ﬁáﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
function downloadMasterCSVTemplate() {
    // A. HEADERS Setup
    const criteria = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, { name: "Maqamat", max: 5 }
    ];

    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

    // 5 Judges Columns
    for (let j = 1; j <= 5; j++) {
        criteria.forEach(c => { csv += `J${j}-${c.name} (${c.max}),`; });
        csv += `J${j}-TOTAL,`;
    }

    // Summary Columns
    csv += "GRAND TOTAL (5 Judges),FINAL AVERAGE,RANK,REMARKS (Top list)\n";

    // B. PLACEHOLDER ROW (Instructional Example)
    let row = [];
    // Personal Info
    row.push("1", "REG-0000", "Under 6", "Balaiygen/Nubalai", "School Name", "Student Name", "Male/Female", "Island/City", "AXXXXXX", "Phone", "Parent Name", "Phone", "email@example.com");

    // Judge Scores Placeholders
    for (let j = 1; j <= 5; j++) {
        criteria.forEach(c => { row.push(`0-${c.max}`); }); // e.g., 0-30
        row.push("Total");
    }

    // Final Calc Placeholders
    row.push("Auto-Calc", "Auto-Calc", "Auto-Calc", "Remarks");

    csv += row.join(",") + "\n";

    // C. DOWNLOAD
    const fileName = `Rasfahi_Official_Data_Entry_Template.csv`;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 2. INTELLIGENT BATCH LOADER (FIXES REPORTING ISSUE)
// ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁùﬁ©ﬁìﬁ∞ ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁßﬁáﬁ®ﬁÉﬁ™ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁßﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
function loadStudentBatch() {
    const file = document.getElementById('batchCsv').files[0];
    if(!file) { alert("Please select the CSV file first!"); return; }
    
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        
        // Clear previous data
        state.allStudents = []; 
        state.judging.savedResults = []; 

        let loadedCount = 0;
        let withScoresCount = 0;

        // Start from Row 1 (Skip Header)
        for(let i=1; i<rows.length; i++) {
            // Complex Split to handle commas inside quotes (Safe Parse)
            let rowRaw = rows[i].trim();
            if(!rowRaw) continue;

            // Simplified split logic (works for generated dummy)
            const cols = rowRaw.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(!cols || cols.length < 13) continue;

            // Remove quotes from values
            const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());

            // 1. Create Student Object (Basic Info)
            const sObj = {
                serial: clean[0], reg: clean[1], group: clean[2], branch: clean[3],
                institution: clean[4], name: clean[5], gender: clean[6], address: clean[7],
                id: clean[8], phone: clean[9], parent: clean[10], parentPhone: clean[11], email: clean[12],
                timestamp: new Date().toISOString()
            };

            // Add to Selection List (Always)
            state.allStudents.push(sObj);

            // 2. CHECK FOR SCORES (For Reports)
            if(clean.length > 20) { 
                // Final Average is typically the 3rd to last column
                // Index from end: Last = Remarks, 2nd Last = Rank, 3rd Last = Final Avg
                let finalAvgIndex = clean.length - 3; 
                let finalScoreVal = parseFloat(clean[finalAvgIndex]);
                
                // If valid score exists, add to savedResults for Reporting
                if(!isNaN(finalScoreVal)) {
                    let resultObj = {
                        ...sObj,
                        finalScore: finalScoreVal
                    };
                    state.judging.savedResults.push(resultObj);
                    withScoresCount++;
                }
            }
            loadedCount++;
        }
        
        populateStudentSelector(); // Update dropdown
        saveToLocal(); // Save to memory
        
        let msg = `‚úÖ Loaded ${loadedCount} students.`;
        if(withScoresCount > 0) {
            msg += `\nüìä ${withScoresCount} students have scores and are ready for Reports/Top Lists!`;
        } else {
            msg += `\n‚ö†Ô∏è No scores detected. Use 'Judge Screen' to enter marks.`;
        }
        alert(msg);
    };
    r.readAsText(file);
}
    // ======================================================
// ‚òÖ 1. NOTICE BOARD LIST (NO SIGNATURE, INFO ONLY) ‚òÖ
// ======================================================
function generateSessionList() {
    // 1. INPUTS
    const dateInput = document.getElementById('sessDate').value;
    const timeInput = document.getElementById('sessTime').value;
    const sessionName = document.getElementById('sessName').value || "-";
    const hallName = document.getElementById('sessHall') ? document.getElementById('sessHall').value : "-";
    const limitVal = document.getElementById('sessLimit').value;
    
    // Filters
    const filterBranch = document.getElementById('sessFilterBranch').value;
    const filterGroup = document.getElementById('sessFilterGroup').value;
    const filterGender = document.getElementById('sessFilterGender').value;
    const filterInst = document.getElementById('sessFilterInst').value;

    // Day Name
    let dayName = "_______";
    if(dateInput) {
        const d = new Date(dateInput);
        const dvDays = ["ﬁáﬁßﬁãﬁ©ﬁáﬁ∞ﬁåﬁ¶", "ﬁÄﬁØﬁâﬁ¶", "ﬁáﬁ¶ﬁÇﬁ∞ﬁéﬁßﬁÉﬁ¶", "ﬁÑﬁ™ﬁãﬁ¶", "ﬁÑﬁ™ﬁÉﬁßﬁêﬁ∞ﬁäﬁ¶ﬁåﬁ®", "ﬁÄﬁ™ﬁÜﬁ™ﬁÉﬁ™", "ﬁÄﬁÆﬁÇﬁ®ﬁÄﬁ®ﬁÉﬁ™"];
        dayName = dvDays[d.getDay()];
    }

    // 2. GET STUDENTS
    let students = (state.allStudents && state.allStudents.length > 0) ? state.allStudents : state.judging.savedResults;
    if(!students || students.length === 0) { alert("Please Load CSV First"); return; }

    // Filter Logic
    let list = students.filter(s => {
        let matchBranch = filterBranch === "" || (s.branch && s.branch.trim() === filterBranch);
        let matchGroup = filterGroup === "" || (s.group && s.group.trim() === filterGroup);
        let matchGender = filterGender === "" || (s.gender && s.gender.trim() === filterGender);
        
        let matchInst = true;
        if(filterInst !== "") {
            const instName = (s.institution || s.inst || "").toLowerCase();
            const typeCheck = filterInst.toLowerCase();
            if(instName.includes(typeCheck)) matchInst = true;
            else if(filterInst === "Private" && (instName === "" || instName.includes("private") || instName.includes("amilla"))) matchInst = true;
            else matchInst = false;
        }
        return matchBranch && matchGroup && matchGender && matchInst;
    });

    if(list.length === 0) { alert("No students match filters."); return; }
    list.sort((a, b) => a.reg.localeCompare(b.reg));
    
    if(limitVal !== "All") list = list.slice(0, parseInt(limitVal));

    // 3. GENERATE HTML
    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Notice Board List</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            body { font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; padding: 20px; direction: rtl; }
            h1 { font-size: 26px; text-decoration: underline; text-align:center; margin:5px; font-weight:bold; }
            h2 { font-size: 20px; text-align:center; margin:5px; color:#333; }
            h3 { font-size: 18px; text-align:center; margin-top:5px; background:#000; color:#fff; padding:5px; display:inline-block; width:100%; }
            
            .meta-box {
                border: 2px solid #000; padding: 15px; margin: 20px 0;
                display: flex; justify-content: space-between; align-items: center;
                font-weight: bold; font-size: 16px; background: #f0f0f0;
            }
            .meta-col { display:flex; flex-direction:column; gap:5px; }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            th { background: #ddd; font-weight: bold; border: 1px solid #000; padding: 10px; font-size: 15px; }
            td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; }
            
            @media print { button { display: none; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="padding:15px; width:100%; background:navy; color:white; font-size:18px; margin-bottom:20px; cursor:pointer;">üñ®Ô∏è ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ ﬁÇﬁØﬁìﬁ®ﬁêﬁ∞ (PRINT)</button>

        <h1>${instName}</h1>
        <h2>${compName}</h2>
        <h3>ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ™ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁÄﬁßﬁíﬁ®ﬁÉﬁ™ﬁàﬁßﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁéﬁÆﬁåﬁ™ﬁéﬁ¨ ﬁåﬁßﬁàﬁ¶ﬁçﬁ™</h3>
        
        <div class="meta-box">
            <div class="meta-col" style="text-align:right;">
                <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${dateInput || '_______'} (${dayName})</div>
                <div>ﬁéﬁ¶ﬁëﬁ®: ${timeInput || '_______'}</div>
            </div>
            <div class="meta-col" style="text-align:center;">
                <div style="font-size:18px; text-decoration:underline;">${sessionName}</div>
                <div>ﬁåﬁ¶ﬁÇﬁ∞ (Venue): ${hallName}</div>
            </div>
            <div class="meta-col" style="text-align:left;">
                <div>ﬁéﬁÆﬁäﬁ®: ${filterBranch || 'All'}</div>
                <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${filterGroup || 'All'}</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="20%">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß / ﬁêﬁ∞ﬁÜﬁ´ﬁçﬁ∞</th>
                    <th width="10%">ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™</th>
                    <th width="20%">ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁàﬁß ﬁéﬁÆﬁäﬁ®/ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.reg}</td>
                        <td style="text-align:right; padding-right:10px; font-weight:bold;">${s.name}</td>
                        <td>${s.id}</td>
                        <td>${s.institution || s.inst || 'Private'}</td>
                        <td>${s.gender}</td>
                        <td>${s.branch} - ${s.group}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div style="margin-top:20px; font-size:12px; color:#555; text-align:center;">
            ﬁâﬁ® ﬁêﬁ¨ﬁùﬁ¶ﬁÇﬁ∞ﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞: ${list.length}
        </div>
    </body>
    </html>`;

    const w = window.open("", "NoticeBoard", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}

// ======================================================
// ‚òÖ 2. JUDGE MARK SHEET (WITH SCORING COLUMNS) ‚òÖ
// ======================================================
function generateJudgeSessionSheet() {
    // 1. INPUTS
    const dateInput = document.getElementById('sessDate').value;
    const timeInput = document.getElementById('sessTime').value;
    const sessionName = document.getElementById('sessName').value || "-";
    const hallName = document.getElementById('sessHall') ? document.getElementById('sessHall').value : "-";
    const limitVal = document.getElementById('sessLimit').value;
    
    // Filters
    const filterBranch = document.getElementById('sessFilterBranch').value;
    const filterGroup = document.getElementById('sessFilterGroup').value;
    const filterGender = document.getElementById('sessFilterGender').value;
    const filterInst = document.getElementById('sessFilterInst').value;

    let dayName = "-";
    if(dateInput) {
        const d = new Date(dateInput);
        const dvDays = ["ﬁáﬁßﬁãﬁ©ﬁáﬁ∞ﬁåﬁ¶", "ﬁÄﬁØﬁâﬁ¶", "ﬁáﬁ¶ﬁÇﬁ∞ﬁéﬁßﬁÉﬁ¶", "ﬁÑﬁ™ﬁãﬁ¶", "ﬁÑﬁ™ﬁÉﬁßﬁêﬁ∞ﬁäﬁ¶ﬁåﬁ®", "ﬁÄﬁ™ﬁÜﬁ™ﬁÉﬁ™", "ﬁÄﬁÆﬁÇﬁ®ﬁÄﬁ®ﬁÉﬁ™"];
        dayName = dvDays[d.getDay()];
    }

    // 2. GET STUDENTS
    let students = (state.allStudents && state.allStudents.length > 0) ? state.allStudents : state.judging.savedResults;
    if(!students || students.length === 0) { alert("Please Load CSV First"); return; }

    let list = students.filter(s => {
        let matchBranch = filterBranch === "" || (s.branch && s.branch.trim() === filterBranch);
        let matchGroup = filterGroup === "" || (s.group && s.group.trim() === filterGroup);
        let matchGender = filterGender === "" || (s.gender && s.gender.trim() === filterGender);
        
        let matchInst = true;
        if(filterInst !== "") {
            const instName = (s.institution || s.inst || "").toLowerCase();
            const typeCheck = filterInst.toLowerCase();
            if(instName.includes(typeCheck)) matchInst = true;
            else if(filterInst === "Private" && (instName === "" || instName.includes("private") || instName.includes("amilla"))) matchInst = true;
            else matchInst = false;
        }
        return matchBranch && matchGroup && matchGender && matchInst;
    });

    if(list.length === 0) { alert("No students found."); return; }
    list.sort((a, b) => a.reg.localeCompare(b.reg));
    
    if(limitVal !== "All") list = list.slice(0, parseInt(limitVal));

    // 3. RUBRIC HEADERS
    const rubric = (state.judging && state.judging.rubric && state.judging.rubric.length > 0) 
                   ? state.judging.rubric 
                   : [{name:"Criteria", max:100}];
    let criteriaHeaders = "";
    let totalMax = 0;
    rubric.forEach(r => {
        criteriaHeaders += `<th style="width:70px; font-size:11px;">${r.name}<br>(${r.max})</th>`;
        totalMax += r.max;
    });

    // 4. GENERATE HTML (LANDSCAPE)
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Judge Mark Sheet</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            body { font-family: 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; padding: 0; margin: 0; direction: rtl; }
            @page { size: A4 landscape; margin: 10mm; }
            
            .sheet-container { width: 100%; text-align: center; padding:20px; box-sizing:border-box; }
            h1 { font-size: 22px; text-decoration: underline; margin: 0; font-weight:bold; }
            h2 { font-size: 16px; margin: 5px 0; font-weight:bold; }
            
            .meta-box {
                display: flex; justify-content: space-between;
                border: 2px solid #000; padding: 10px; margin: 10px 0;
                font-size: 13px; font-weight: bold; background: #f9f9f9;
            }

            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
            th { background: #e0e0e0; border: 1px solid #000; padding: 5px; font-weight:bold; }
            td { border: 1px solid #000; padding: 5px; text-align: center; height: 35px; }
            
            .footer { margin-top: 30px; display: flex; justify-content: space-between; }
            .sig-line { width: 200px; border-top: 1px dotted #000; padding-top: 5px; margin-top:30px; text-align:center; }
            
            @media print { button { display: none; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="position:fixed; top:0; left:0; width:100%; padding:10px; background:navy; color:white; cursor:pointer;">üñ®Ô∏è PRINT SHEET</button>
        
        <div class="sheet-container">
            <h1>ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁ§ﬁ™ﬁÉﬁ∞ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞ - ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞</h1>
            
            <div class="meta-box">
                <div>
                    ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${dateInput || '_______'} (${dayName}) <br>
                    ﬁãﬁ¶ﬁÇﬁ∞ﬁäﬁ¶ﬁÖﬁ®: ${sessionName}
                </div>
                <div style="text-align:center;">
                    ﬁéﬁÆﬁäﬁ®: ${filterBranch || 'All'} <br>
                    ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${filterGroup || 'All'}
                </div>
                <div style="text-align:left;">
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞: ___________________ <br>
                    ﬁÄﬁØﬁçﬁ™: ${hallName}
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="3%">#</th>
                        <th width="8%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                        <th width="20%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ / ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß</th>
                        ${criteriaHeaders}
                        <th width="6%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶<br>(${totalMax})</th>
                        <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${list.map((s, i) => {
                        let emptyCells = rubric.map(() => `<td></td>`).join('');
                        return `
                        <tr>
                            <td>${i+1}</td>
                            <td>${s.reg}</td>
                            <td style="text-align:right;">
                                <b>${s.name}</b><br>
                                <span style="font-size:11px; color:#555;">${s.institution || 'Private'}</span>
                            </td>
                            ${emptyCells}
                            <td></td>
                            <td></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>

            <div class="footer">
                <div><div class="sig-line">ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®</div></div>
                <div><div class="sig-line">ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™</div></div>
                <div><div class="sig-line">ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞</div></div>
            </div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "JudgeSheet", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}
    // ========================================================
// ‚òÖ NEW FEATURES LOGIC (EXTRA SCREEN & ADMIN SCORING) ‚òÖ
// ========================================================

// --- A. EXTRA SCREEN STATE ---
state.extra = {
    pool: [],       // Loaded from CSV
    gridTaken: [],  // Numbers picked
    currentQ: null, // Currently displayed question
    settings: {
        size: 5, posY: 0, posX: 0, color: '#ffffff'
    },
    window: null
};

// 1. CSV Loader for Extra Screen
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.pool = [];
        // Assuming Format: ID, Text/ImageName
        rows.slice(1).forEach(row => {
            const cols = row.split(',');
            if(cols.length > 1) {
                state.extra.pool.push({
                    id: cols[0].trim(),
                    content: cols[1].trim(), // Image name or Text
                    // You can add more columns here if your CSV has range info
                    details: cols.slice(2).join(' ') 
                });
            }
        });
        document.getElementById('extraStatus').innerText = `Loaded ${state.extra.pool.length} items.`;
        extraGridReset(); // Reset grid when new file loads
    };
    r.readAsText(file);
}

// 2. Launch The Extra Screen
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    // Using the same font logic
    const fontFace = state.fontData ? `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }` : '';
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <style>
            ${fontFace}
            body { 
                background: #000; color: #fff; margin: 0; overflow: hidden; 
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                font-family: 'AppFont', sans-serif;
            }
            #gridContainer { 
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 2vmin; 
                width: 80vw; height: 80vh;
            }
            .grid-box {
                background: #111; border: 2px solid #ff9800; border-radius: 10px;
                display: flex; align-items: center; justify-content: center;
                font-size: 6vmin; color: #ff9800; cursor: pointer;
                transition: 0.3s;
            }
            .grid-box:hover { background: #333; }
            .grid-box.hidden { opacity: 0; pointer-events: none; }
            
            #contentDisplay {
                display: none; position: absolute; top:0; left:0; width:100%; height:100%;
                justify-content: center; align-items: center; text-align: center;
            }
            #qContent { transition: all 0.2s ease; }
            img { max-width: 90%; max-height: 90%; }
        </style>
    </head>
    <body>
        <div id="gridContainer"></div>
        <div id="contentDisplay"><div id="qContent"></div></div>

        <script>
            window.opener.initExtraScreen(window);
            
            function updateView(d) {
                // Update Grid
                const gc = document.getElementById('gridContainer');
                const cd = document.getElementById('contentDisplay');
                const qc = document.getElementById('qContent');

                if(d.mode === 'grid') {
                    cd.style.display = 'none';
                    gc.style.display = 'grid';
                    gc.innerHTML = '';
                    for(let i=1; i<=20; i++) {
                        let b = document.createElement('div');
                        b.className = 'grid-box';
                        if(d.taken.includes(i)) b.style.opacity = '0.1';
                        b.innerText = i;
                        b.onclick = () => window.opener.extraGridClick(i);
                        gc.appendChild(b);
                    }
                } else {
                    gc.style.display = 'none';
                    cd.style.display = 'flex';
                    
                    // Apply Settings
                    qc.style.color = d.settings.color;
                    qc.style.fontSize = d.settings.size + 'vmin';
                    qc.style.transform = \`translate(\${d.settings.posX}px, \${d.settings.posY}px)\`;
                    
                    // Content Logic (Image or Text)
                    if(d.content.match(/\.(jpeg|jpg|gif|png)$/) != null) {
                       // It's an image path (you might need to handle Blob URLs if local)
                       // For simple text CSV, we display text
                       qc.innerHTML = '<img src="' + d.content + '">';
                    } else {
                       qc.innerText = d.content;
                    }
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1000,height=700");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
}

// 3. Logic Functions
window.initExtraScreen = function(win) {
    syncExtraScreen(); // Initial Sync
};

function extraGridReset() {
    state.extra.gridTaken = [];
    state.extra.currentQ = null;
    syncExtraScreen('grid');
}

window.extraGridClick = function(num) {
    if(state.extra.gridTaken.includes(num)) return;
    state.extra.gridTaken.push(num);
    
    // Pick specific or random from pool
    // Since this is a new feature, let's just pick random from loaded pool for now
    if(state.extra.pool.length > 0) {
        const rand = Math.floor(Math.random() * state.extra.pool.length);
        state.extra.currentQ = state.extra.pool[rand];
        // Remove used? optional.
    } else {
        state.extra.currentQ = { content: "No Data Loaded" };
    }
    
    syncExtraScreen('content');
};

function updateExtraScreen(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen('content');
}

function extraNextQ() {
    // Logic to move to next question if multiple selected
    // For simplicity, returns to grid
    syncExtraScreen('grid');
}

function syncExtraScreen(forceMode) {
    if(!state.extra.window || state.extra.window.closed) return;
    
    const packet = {
        mode: forceMode || (state.extra.currentQ ? 'content' : 'grid'),
        taken: state.extra.gridTaken,
        content: state.extra.currentQ ? state.extra.currentQ.content : "",
        settings: state.extra.settings
    };
    state.extra.window.updateView(packet);
}


// --- B. ADMIN MANUAL SCORING LOGIC ---

// 1. Render the manual inputs (Clone of Rubric)
function renderAdminManualScoring() {
    const container = document.getElementById('manualEntryContainer');
    container.innerHTML = '';
    
    if(!state.judging.rubric || state.judging.rubric.length === 0) {
        container.innerHTML = '<p style="color:#aaa;">No Rubric defined.</p>';
        return;
    }

    state.judging.rubric.forEach((r, idx) => {
        const div = document.createElement('div');
        div.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;";
        
        div.innerHTML = `
            <span style="color:#ccc; font-size:14px;">${r.name} (${r.max}):</span>
            <input type="number" class="manual-score-input" 
                   data-max="${r.max}" 
                   style="width:60px; padding:5px; text-align:center;" 
                   placeholder="0" oninput="calcManualTotal()">
        `;
        container.appendChild(div);
    });
}

// 2. Auto-Calculate Total in Admin Panel
function calcManualTotal() {
    const inputs = document.querySelectorAll('.manual-score-input');
    let total = 0;
    inputs.forEach(inp => {
        let val = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        if(isNaN(val)) val = 0;
        if(val > max) { val = max; inp.value = max; } // Cap at max
        total += val;
    });
    document.getElementById('manualTotalDisplay').innerText = total.toFixed(2);
    return total;
}

// 3. Save to System (Same logic as Judge pressing Submit)
function saveManualScore() {
    if(!state.judging.currentStudentObj) {
        alert("Please register/select a student first!");
        return;
    }
    
    const judgeID = document.getElementById('manualJudgeSelect').value;
    const totalScore = calcManualTotal();
    
    // Save into the main judging system (Mixed with digital judges)
    state.judging.liveScores[judgeID] = totalScore;
    
    // Update the existing monitor
    updateScoreMonitor();
    
    alert(`Saved Score: ${totalScore} for ${judgeID}`);
    
    // Clear inputs
    document.querySelectorAll('.manual-score-input').forEach(i => i.value = '');
    document.getElementById('manualTotalDisplay').innerText = "0.00";
}

// INITIALIZER CALL
// Call this once to setup the admin panel UI
renderAdminManualScoring();
// ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN & ADMIN LOGIC (V2) ‚òÖ
// ========================================================

state.extra = {
    pool: [],       
    gridTaken: [], 
    currentQ: null, 
    settings: {
        size: 8, posY: 0, posX: 0, color: '#ffffff', theme: 'green_gold_border'
    },
    window: null
};

// 1. UPDATED CSV LOADER (Handles 5 Columns)
// CSV Format Expectation: ID, QuranText, SurahName, AyahNumber, JuzName
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.pool = [];
        
        rows.slice(1).forEach(row => {
            // Smart split handling commas inside quotes
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 2) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                state.extra.pool.push({
                    id: clean[0],           // Col 1: Question ID
                    text: clean[1],         // Col 2: Quran Text (The Verse)
                    surah: clean[2] || "",  // Col 3: Surah Name
                    ayah: clean[3] || "",   // Col 4: Ayah Number
                    juz: clean[4] || ""     // Col 5: Juz/Book Name
                });
            }
        });
        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.pool.length} Questions.`;
        extraGridReset();
    };
    r.readAsText(file);
}

// 2. LAUNCH THE ULTIMATE ROYAL SCREEN
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    // Arabic Font (Amiri/Uthman Taha) & English Fonts
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Royal Student Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; justify-content: center; align-items: center;
                height: 100vh; width: 100vw;
            }

            /* --- 100 ROYAL THEMES ENGINE --- */
            /* Base Style */
            #mainContainer {
                width: 90vw; height: 90vh;
                position: relative;
                display: flex; flex-direction: column;
                justify-content: flex-start; align-items: center;
                border-radius: 20px;
                transition: all 0.5s ease;
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
            }

            /* --- THEME CLASSES --- */
            .theme-green_gold_border {
                background: radial-gradient(circle, #002200, #000);
                border: 15px double #FFD700;
                box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 0 20px #FFD700;
            }
            .theme-blue_gold_border {
                background: radial-gradient(circle, #001a33, #000);
                border: 15px double #FFD700;
                box-shadow: inset 0 0 50px rgba(0,0,0,0.8), 0 0 20px #FFD700;
            }
            .theme-pres_red {
                background: linear-gradient(135deg, #330000, #1a0000);
                border: 10px solid #800000;
                outline: 2px solid #FFD700;
            }
            .theme-pres_black {
                background: #0a0a0a;
                border: 5px solid #FFD700;
                border-radius: 0 !important;
            }
            .theme-white_gold {
                background: #fdfdfd;
                color: #000 !important;
                border: 20px solid #e0e0e0;
                border-image: linear-gradient(to bottom, #FFD700, #AA8800) 1;
            }
            /* Add more dynamic styles via JS if needed */

            /* --- ROYAL BANNER --- */
            .royal-banner {
                width: 80%;
                background: linear-gradient(90deg, rgba(0,0,0,0), rgba(212, 175, 55, 0.2), rgba(0,0,0,0));
                border-top: 2px solid #FFD700;
                border-bottom: 2px solid #FFD700;
                padding: 15px 0;
                margin-top: 40px;
                margin-bottom: 30px;
                display: flex; justify-content: space-around; align-items: center;
                color: #FFD700;
                font-family: 'Cinzel', serif; /* English headers */
                text-shadow: 0 2px 5px #000;
                direction: ltr; /* Force LTR for layout stability, inner text can be RTL */
                opacity: 0; transform: translateY(-20px); transition: 0.5s;
            }
            .banner-item { font-size: 1.8vw; font-weight: bold; }
            .banner-label { font-size: 0.8vw; color: #aaa; text-transform: uppercase; display:block; }

            /* --- QURAN TEXT AREA --- */
            #contentArea {
                flex: 1; width: 80%;
                display: flex; justify-content: center; align-items: center;
                text-align: center;
                position: relative;
            }
            #qText {
                color: #fff;
                font-size: 8vmin;
                line-height: 1.8;
                font-weight: bold;
                text-shadow: 0 4px 10px rgba(0,0,0,0.5);
                direction: rtl;
                opacity: 0; transition: opacity 0.5s;
                white-space: pre-wrap; /* Keeps formatting */
            }

            /* --- GRID SYSTEM --- */
            #gridWrapper {
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
                width: 80%; height: 70%;
                position: absolute; top: 15%;
            }
            .grid-box {
                background: rgba(255,255,255,0.05);
                border: 2px solid #FFD700; border-radius: 10px;
                display: flex; justify-content: center; align-items: center;
                font-size: 4vw; color: #FFD700; cursor: pointer;
                transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                font-family: 'Cinzel', serif;
            }
            .grid-box:hover { background: #FFD700; color: #000; transform: scale(1.05); }
            .grid-box.taken { opacity: 0; pointer-events: none; transform: scale(0.5); }

        </style>
    </head>
    <body>
        <div id="mainContainer" class="theme-green_gold_border">
            
            <div id="topBanner" class="royal-banner">
                <div class="banner-item"><span class="banner-label">Question No</span><span id="bQNo">-</span></div>
                <div class="banner-item"><span class="banner-label">Surah</span><span id="bSurah">-</span></div>
                <div class="banner-item"><span class="banner-label">Juz/Para</span><span id="bJuz">-</span></div>
                <div class="banner-item"><span class="banner-label">Start Ayah</span><span id="bAyah">-</span></div>
            </div>

            <div id="contentArea">
                <div id="qText"></div>
            </div>

            <div id="gridWrapper"></div>
        </div>

        <script>
            window.opener.initExtraScreen(window);

            function updateView(d) {
                const main = document.getElementById('mainContainer');
                const grid = document.getElementById('gridWrapper');
                const qDiv = document.getElementById('qText');
                const banner = document.getElementById('topBanner');

                // 1. APPLY THEME
                main.className = 'theme-' + d.settings.theme;
                if(d.settings.theme === 'white_gold') {
                    qDiv.style.color = "#000";
                    qDiv.style.textShadow = "none";
                } else {
                    qDiv.style.color = "#fff";
                    qDiv.style.textShadow = "0 4px 10px rgba(0,0,0,0.5)";
                }

                // 2. MODE SWITCH (GRID vs CONTENT)
                if(d.mode === 'grid') {
                    grid.style.display = 'grid';
                    qDiv.style.opacity = '0';
                    banner.style.opacity = '0';
                    banner.style.transform = 'translateY(-20px)';
                    
                    grid.innerHTML = '';
                    for(let i=1; i<=20; i++) {
                        let b = document.createElement('div');
                        b.className = 'grid-box ' + (d.taken.includes(i) ? 'taken' : '');
                        b.innerText = i;
                        b.onclick = () => window.opener.extraGridClick(i);
                        grid.appendChild(b);
                    }
                } else {
                    // SHOW CONTENT
                    grid.style.display = 'none';
                    qDiv.style.opacity = '1';
                    banner.style.opacity = '1';
                    banner.style.transform = 'translateY(0)';

                    // Fill Data
                    const data = d.currentQ || {};
                    qDiv.innerText = data.text || "No Text Available";
                    document.getElementById('bQNo').innerText = data.id || "-";
                    document.getElementById('bSurah').innerText = data.surah || "-";
                    document.getElementById('bJuz').innerText = data.juz || "-";
                    document.getElementById('bAyah').innerText = data.ayah || "-";

                    // Apply Adjustments
                    qDiv.style.fontSize = d.settings.size + 'vmin';
                    qDiv.style.transform = \`translate(\${d.settings.posX}px, \${d.settings.posY}px)\`;
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
}

// 3. LOGIC CONNECTORS
window.initExtraScreen = function(win) { syncExtraScreen(); };

function extraGridReset() {
    state.extra.gridTaken = [];
    state.extra.currentQ = null;
    syncExtraScreen('grid');
}

window.extraGridClick = function(num) {
    if(state.extra.gridTaken.includes(num)) return;
    state.extra.gridTaken.push(num);
    
    // Logic: Pick corresponding ID from pool or Random if pool is smaller
    // Trying to match Grid Num 1 to Question 1 if possible
    let selectedQ = null;
    
    // Ensure we have data
    if(state.extra.pool.length > 0) {
        // Try to find Question with ID == num
        selectedQ = state.extra.pool.find(q => parseInt(q.id) === num);
        
        // If not found (or IDs are weird), pick by index
        if(!selectedQ) {
            if(num <= state.extra.pool.length) selectedQ = state.extra.pool[num-1];
            else selectedQ = state.extra.pool[Math.floor(Math.random() * state.extra.pool.length)];
        }
    } else {
        selectedQ = { text: "Please Load CSV Data First", id: num };
    }

    state.extra.currentQ = selectedQ;
    syncExtraScreen('content');
};

function updateExtraScreen(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen('content');
}

function extraNextQ() {
    // Return to grid for next pick
    syncExtraScreen('grid');
}

function syncExtraScreen(forceMode) {
    if(!state.extra.window || state.extra.window.closed) return;
    
    const packet = {
        mode: forceMode || (state.extra.currentQ ? 'content' : 'grid'),
        taken: state.extra.gridTaken,
        currentQ: state.extra.currentQ,
        settings: state.extra.settings
    };
    state.extra.window.updateView(packet);
}


// --- B. ADMIN MANUAL SCORING LOGIC (DECIMAL FIX) ---

function renderAdminManualScoring() {
    const container = document.getElementById('manualEntryContainer');
    container.innerHTML = '';
    
    if(!state.judging.rubric || state.judging.rubric.length === 0) {
        container.innerHTML = '<p style="color:#aaa;">No Rubric defined.</p>';
        return;
    }

    state.judging.rubric.forEach((r, idx) => {
        const div = document.createElement('div');
        div.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;";
        
        // ADDED step="0.01" for decimal input support
        div.innerHTML = `
            <span style="color:#ccc; font-size:14px;">${r.name} (${r.max}):</span>
            <input type="number" class="manual-score-input" 
                   data-max="${r.max}" step="0.01"
                   style="width:70px; padding:5px; text-align:center; font-weight:bold;" 
                   placeholder="0" oninput="calcManualTotal()">
        `;
        container.appendChild(div);
    });
}

function calcManualTotal() {
    const inputs = document.querySelectorAll('.manual-score-input');
    let total = 0;
    inputs.forEach(inp => {
        let val = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        if(isNaN(val)) val = 0;
        if(val > max) { 
            // Optional: Warn user or cap it. Let's cap visual but allow entry
            inp.style.color = "red";
        } else {
            inp.style.color = "black";
        }
        total += val;
    });
    // Fix decimal places
    document.getElementById('manualTotalDisplay').innerText = total.toFixed(2);
    return total;
}

function saveManualScore() {
    if(!state.judging.currentStudentObj) {
        alert("Please register/select a student first!");
        return;
    }
    const judgeID = document.getElementById('manualJudgeSelect').value;
    const totalScore = calcManualTotal();
    
    state.judging.liveScores[judgeID] = parseFloat(totalScore.toFixed(2));
    updateScoreMonitor();
    
    alert(`‚úÖ Score Saved: ${totalScore.toFixed(2)} for ${judgeID}`);
    // Clear inputs
    document.querySelectorAll('.manual-score-input').forEach(i => i.value = '');
    document.getElementById('manualTotalDisplay').innerText = "0.00";
}

// Init Admin Panel UI
renderAdminManualScoring();
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V3 - DYNAMIC GRID) ‚òÖ
// ========================================================

state.extra = {
    pool: [],       
    gridTaken: [], 
    selectionQueue: [], // Stores selected question IDs in order
    currentQIndex: -1,
    settings: {
        size: 7, posY: 0, posX: 0, color: '#ffffff', 
        theme: 'green_gold_border', lines: 0,
        gridMax: 0 // 0 means auto based on pool size
    },
    window: null
};

// --- 1. CSV SAMPLE DOWNLOADER ---
function downloadSampleExtraCSV() {
    const headers = "ID,QuranText,SurahName,AyahNo,JuzNo";
    // Sample Rows with realistic data
    const rows = [
        `1,"ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê","Al-Fatiha",1,1`,
        `2,"Ÿ±ﬁçﬁ∞ﬁôﬁ¶ﬁâﬁ∞ﬁãﬁ∞ ﬁçﬁ®ﬁáﬁ∞ﬁçﬁßﬁÄﬁ® ﬁÉﬁ¶ﬁáﬁ∞ﬁÑﬁ®ﬁçﬁ∞ ﬁ¢ﬁßﬁçﬁ¶ﬁâﬁ©ﬁÇﬁ∞...","Al-Fatiha",2,1`,
        `3,"ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁßﬁÇﬁ¨ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ¶ﬁÅﬁ∞ ﬁïﬁ≠ﬁêﬁ∞ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß","Surah Name",10,30`
    ];
    
    const csvContent = headers + "\n" + rows.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "Royal_Grid_Sample.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- 2. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.pool = [];
        
        rows.slice(1).forEach(row => {
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 2) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                state.extra.pool.push({
                    id: parseInt(clean[0]) || 0, // Ensure ID is integer for matching
                    text: clean[1],
                    surah: clean[2] || "",
                    ayah: clean[3] || "",
                    juz: clean[4] || ""
                });
            }
        });
        
        // Auto-set grid size
        state.extra.settings.gridMax = state.extra.pool.length;
        document.getElementById('extraGridMax').value = state.extra.pool.length;
        document.getElementById('extraStatus').innerText = `‚úÖ Data Loaded: ${state.extra.pool.length} Items`;
        
        extraGridReset();
    };
    r.readAsText(file);
}

// --- 3. SETTINGS UPDATE ---
function updateExtraSettings() {
    const manualMax = parseInt(document.getElementById('extraGridMax').value);
    if(!isNaN(manualMax) && manualMax > 0) {
        state.extra.settings.gridMax = manualMax;
    } else {
        state.extra.settings.gridMax = state.extra.pool.length || 20; // Default fallback
    }
    syncExtraScreen('grid');
}

// --- 4. LAUNCH SCREEN ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    // Arabic & English Fonts
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Royal Grid Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; justify-content: center; align-items: center;
                height: 100vh; width: 100vw;
            }

            #mainContainer {
                width: 95vw; height: 95vh;
                position: relative;
                display: flex; flex-direction: column;
                justify-content: flex-start; align-items: center;
                border-radius: 15px;
                transition: all 0.5s ease;
                box-shadow: 0 0 60px rgba(0,0,0,0.9);
                overflow: hidden;
            }

            /* --- THEMES --- */
            .theme-green_gold_border {
                background: radial-gradient(circle, #002b15, #000);
                border: 20px double #FFD700;
                box-shadow: inset 0 0 80px #000;
            }
            .theme-blue_gold_border {
                background: radial-gradient(circle, #001a33, #000);
                border: 20px double #FFD700;
            }
            .theme-pres_red {
                background: linear-gradient(135deg, #4a0000, #1a0000);
                border: 15px solid #800000; outline: 3px solid #FFD700;
            }
            .theme-pres_black {
                background: #080808;
                border: 10px solid #FFD700;
            }

            /* --- ROYAL BANNER --- */
            .royal-banner {
                width: 100%;
                background: linear-gradient(90deg, #000, rgba(212, 175, 55, 0.3), #000);
                border-bottom: 2px solid #FFD700;
                padding: 15px 0;
                display: flex; justify-content: space-evenly; align-items: center;
                color: #FFD700; font-family: 'Cinzel', serif;
                text-shadow: 0 2px 5px #000;
                direction: ltr;
                opacity: 0; transform: translateY(-50px); transition: 0.6s;
                position: absolute; top: 0; z-index: 10;
            }
            .banner-item { font-size: 2.5vmin; font-weight: bold; text-align: center; }
            .banner-label { font-size: 1.5vmin; color: #ccc; display:block; text-transform:uppercase; letter-spacing:1px; }

            /* --- TEXT CONTENT --- */
            #contentArea {
                width: 85%; height: 100%;
                display: flex; justify-content: center; align-items: center;
                text-align: center;
                position: absolute; top: 0; left: 7.5%;
            }
            #qText {
                color: #fff; line-height: 2.2; font-weight: bold;
                text-shadow: 0 4px 10px rgba(0,0,0,0.8);
                direction: rtl; opacity: 0; transition: opacity 0.5s;
                white-space: pre-wrap; 
                
                /* LINE LIMIT LOGIC */
                display: -webkit-box;
                -webkit-box-orient: vertical;
                overflow: hidden;
                /* Lines will be set via JS */
            }

            /* --- DYNAMIC GRID --- */
            #gridWrapper {
                display: grid; 
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                gap: 15px; padding: 40px;
                width: 90%; height: 85%;
                overflow-y: auto; /* Scroll if too many */
                align-content: center;
            }
            
            /* Custom Scrollbar */
            #gridWrapper::-webkit-scrollbar { width: 10px; }
            #gridWrapper::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 5px; }

            .grid-box {
                background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.5));
                border: 2px solid #FFD700; border-radius: 8px;
                height: 100px;
                display: flex; justify-content: center; align-items: center;
                font-size: 35px; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            }
            .grid-box:hover { background: #FFD700; color: #000; transform: scale(1.1); z-index: 5; }
            .grid-box.taken { opacity: 0.1; pointer-events: none; filter: grayscale(1); transform: scale(0.8); }

        </style>
    </head>
    <body>
        <div id="mainContainer" class="theme-green_gold_border">
            
            <div id="topBanner" class="royal-banner">
                <div class="banner-item"><span class="banner-label">Question</span><span id="bQNo">-</span></div>
                <div class="banner-item"><span class="banner-label">Surah</span><span id="bSurah">-</span></div>
                <div class="banner-item"><span class="banner-label">Start Ayah</span><span id="bAyah">-</span></div>
                <div class="banner-item"><span class="banner-label">Juz</span><span id="bJuz">-</span></div>
            </div>

            <div id="contentArea"><div id="qText"></div></div>
            <div id="gridWrapper"></div>
        </div>

        <script>
            window.opener.initExtraScreen(window);

            function updateView(d) {
                const main = document.getElementById('mainContainer');
                const grid = document.getElementById('gridWrapper');
                const qDiv = document.getElementById('qText');
                const banner = document.getElementById('topBanner');

                // 1. Theme & Style
                main.className = 'theme-' + d.settings.theme;
                qDiv.style.fontSize = d.settings.size + 'vmin';
                
                // Line Limit Logic (CSS Line Clamp)
                const lines = parseInt(d.settings.lines);
                if(lines > 0) {
                    qDiv.style.webkitLineClamp = lines;
                } else {
                    qDiv.style.webkitLineClamp = 'unset'; 
                }

                // 2. Mode Handling
                if(d.mode === 'grid') {
                    grid.style.display = 'grid';
                    qDiv.style.opacity = '0';
                    banner.style.opacity = '0';
                    banner.style.transform = 'translateY(-50px)';
                    
                    // Render Grid based on Count
                    grid.innerHTML = '';
                    const max = d.settings.gridMax || 20;
                    
                    for(let i=1; i<=max; i++) {
                        let b = document.createElement('div');
                        b.className = 'grid-box ' + (d.taken.includes(i) ? 'taken' : '');
                        b.innerText = i;
                        b.onclick = () => window.opener.extraGridClick(i);
                        grid.appendChild(b);
                    }
                } else {
                    // Content Mode
                    grid.style.display = 'none';
                    qDiv.style.opacity = '1';
                    banner.style.opacity = '1';
                    banner.style.transform = 'translateY(0)';

                    const data = d.currentQ || {};
                    qDiv.innerText = data.text || "Loading...";
                    document.getElementById('bQNo').innerText = data.id || "-";
                    document.getElementById('bSurah').innerText = data.surah || "-";
                    document.getElementById('bAyah').innerText = data.ayah || "-";
                    document.getElementById('bJuz').innerText = data.juz || "-";
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
}

// --- 5. LOGIC & NAVIGATION ---
window.initExtraScreen = function(win) { syncExtraScreen(); };

function extraGridReset() {
    state.extra.gridTaken = [];
    state.extra.selectionQueue = [];
    state.extra.currentQIndex = -1;
    document.getElementById('selectionMonitor').innerText = "Selection: [None]";
    syncExtraScreen('grid');
}

window.extraGridClick = function(num) {
    if(state.extra.gridTaken.includes(num)) return;

    // Logic: Limit number of picks based on dropdown
    const pickLimit = parseInt(document.getElementById('extraPickCount').value);
    if(state.extra.selectionQueue.length >= pickLimit) {
        // Option: Auto clear old or just stop? Let's just stop or replace.
        // Let's enforce limit.
        return; 
    }

    state.extra.gridTaken.push(num);
    
    // Find Question Data
    let qData = state.extra.pool.find(q => q.id === num);
    if(!qData) {
        // Fallback if IDs don't match grid numbers (use index)
        if(num <= state.extra.pool.length) qData = state.extra.pool[num-1];
        else qData = { id: num, text: "Data not found for ID " + num };
    }
    
    state.extra.selectionQueue.push(qData);
    
    // Update Monitor
    document.getElementById('selectionMonitor').innerText = "Selected: " + state.extra.selectionQueue.map(q=>q.id).join(', ');

    // If we reached the pick limit, auto-show the first question
    if(state.extra.selectionQueue.length === pickLimit) {
        state.extra.currentQIndex = 0;
        syncExtraScreen('content');
    } else {
        // Still picking, update grid (mark as taken)
        syncExtraScreen('grid');
    }
};

function extraNextQ() {
    if(state.extra.selectionQueue.length === 0) return;
    
    // Move to next question in queue
    if(state.extra.currentQIndex < state.extra.selectionQueue.length - 1) {
        state.extra.currentQIndex++;
        syncExtraScreen('content');
    } else {
        // All done, maybe show a "Finished" screen or go back to grid?
        // Let's go back to grid for now
        syncExtraScreen('grid'); 
    }
}

function updateExtraScreen(key, val) {
    state.extra.settings[key] = val;
    // If lines changed, refresh view
    if(key === 'lines' || key === 'theme' || key === 'size') {
        // Keep current mode
        const mode = (state.extra.currentQIndex > -1) ? 'content' : 'grid';
        syncExtraScreen(mode);
    }
}

function syncExtraScreen(forceMode) {
    if(!state.extra.window || state.extra.window.closed) return;
    
    // Determine Current Question Data
    let qData = null;
    if(state.extra.currentQIndex > -1 && state.extra.selectionQueue.length > 0) {
        qData = state.extra.selectionQueue[state.extra.currentQIndex];
    }

    const packet = {
        mode: forceMode,
        taken: state.extra.gridTaken,
        currentQ: qData,
        settings: state.extra.settings
    };
    state.extra.window.updateView(packet);
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V4 - MASTER COMPATIBLE) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        // Full CSV Data
    filteredPool: [],   // Data filtered by Syllabus range
    gridMapping: {},    // Maps Grid Box (1-20) to Question ID
    selection: [],      // Questions selected by student
    currentIndex: -1,   // Currently viewing question index
    phase: 'grid',      // 'grid' or 'reading'
    settings: {
        size: 8, color: '#ffffff', theme: 'green', 
        lines: 0, mode: 'tilawa' // tilawa or hifz
    },
    window: null
};

// --- 1. SPECIAL CSV LOADER FOR RASFAHI MASTER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        
        // Skip Header (Row 0)
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;

            // Regex to split CSV considering quotes
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                
                // MAPPING BASED ON YOUR FILE:
                // 0:Q_ID, 1:Juz, 2:Page, 3:Surah, 4:Start, 5:End, 6:Text
                state.extra.allData.push({
                    id: parseInt(clean[0]),
                    juz: clean[1],
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6] // Arabic Text
                });
            }
        }
        
        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Questions (Master).`;
        resetExtraSession();
    };
    r.readAsText(file);
}

// --- 2. RESET & PREPARE GRID ---
function resetExtraSession() {
    // 1. Filter Data based on Syllabus Range
    const startID = parseInt(document.getElementById('exStart').value) || 1;
    const endID = parseInt(document.getElementById('exEnd').value) || 9999;
    
    state.extra.filteredPool = state.extra.allData.filter(q => q.id >= startID && q.id <= endID);
    
    if(state.extra.filteredPool.length === 0) {
        document.getElementById('exMonitor').innerText = "‚ö†Ô∏è Scope Empty! Check IDs.";
        return;
    }

    // 2. Setup Grid (Random mapping for 20 boxes)
    state.extra.gridMapping = {};
    let tempPool = [...state.extra.filteredPool]; // Copy
    
    for(let i=1; i<=20; i++) {
        if(tempPool.length > 0) {
            const rIdx = Math.floor(Math.random() * tempPool.length);
            state.extra.gridMapping[i] = tempPool[rIdx];
            tempPool.splice(rIdx, 1); // Avoid duplicates in grid
        } else {
            // If pool exhausted, recycle random
            const rIdx = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[rIdx];
        }
    }

    // 3. Reset State
    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = `Grid Ready (${state.extra.filteredPool.length} Qs)`;
    
    syncExtraScreen();
}

// --- 3. OPEN SCREEN (HTML STRUCTURE) ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }

            /* --- LAYOUTS --- */
            #gridScreen {
                width: 100%; height: 100%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 40px;
                box-sizing: border-box; align-content: center;
                background: radial-gradient(circle, #1a1a1a, #000);
            }

            #readScreen {
                width: 100%; height: 100%; display: none; /* Hidden initially */
                flex-direction: row;
            }

            /* --- SIDEBAR (RIGHT LIST) --- */
            #sideBar {
                width: 25%; height: 100%;
                background: rgba(255,255,255,0.05);
                border-left: 2px solid #FFD700;
                padding: 20px; box-sizing: border-box;
                display: flex; flex-direction: column; gap: 10px;
                overflow-y: auto;
            }
            .q-card {
                background: rgba(0,0,0,0.5);
                border: 1px solid #444; border-radius: 8px;
                padding: 15px; color: #aaa; transition: 0.3s;
                text-align: right; direction: rtl;
            }
            .q-card.active {
                border-color: #FFD700; background: linear-gradient(90deg, rgba(212,175,55,0.2), transparent);
                color: #fff; transform: scale(1.02);
            }
            .q-label { font-size: 14px; color: #FFD700; font-family: 'Cinzel', serif; margin-bottom: 5px; }
            .q-detail { font-size: 18px; font-weight: bold; }

            /* --- MAIN CONTENT --- */
            #mainContent {
                flex: 1; display: flex; flex-direction: column;
                justify-content: flex-start; align-items: center;
                position: relative; padding: 20px;
            }

            .royal-banner {
                width: 90%; margin-top: 30px; margin-bottom: 20px;
                padding: 15px; border-bottom: 2px solid #FFD700;
                display: flex; justify-content: space-around;
                color: #FFD700; font-family: 'Cinzel', sans-serif;
                background: linear-gradient(90deg, transparent, rgba(212,175,55,0.1), transparent);
                text-shadow: 0 2px 5px #000;
                direction: ltr; /* English headers */
            }
            .b-item { text-align: center; }
            .b-head { font-size: 12px; color: #888; text-transform: uppercase; }
            .b-val { font-size: 24px; font-weight: bold; }

            #quranText {
                width: 85%; text-align: center;
                color: #fff; font-weight: bold; line-height: 2.2;
                white-space: pre-wrap; direction: rtl;
                text-shadow: 0 4px 10px rgba(0,0,0,0.8);
                transition: 0.5s;
                
                /* Centering */
                flex: 1; display: flex; align-items: center; justify-content: center;
                overflow: hidden;
            }

            /* --- GRID BOXES --- */
            .grid-box {
                background: linear-gradient(135deg, #111, #000);
                border: 2px solid #FFD700; border-radius: 10px;
                display: flex; justify-content: center; align-items: center;
                font-size: 40px; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                transition: 0.3s; box-shadow: 0 0 15px rgba(212,175,55,0.1);
            }
            .grid-box:hover { background: #FFD700; color: #000; transform: scale(1.05); }
            .grid-box.taken { opacity: 0; pointer-events: none; transform: scale(0.5); }

            /* --- THEMES --- */
            .bg-green { background: radial-gradient(circle, #002200, #000); }
            .bg-blue { background: radial-gradient(circle, #001a33, #000); }
            .bg-red { background: linear-gradient(135deg, #330000, #000); }
            .bg-black { background: #050505; }

        </style>
    </head>
    <body id="bodyEl" class="bg-green">
        
        <div id="gridScreen"></div>

        <div id="readScreen">
            <div id="sideBar"></div>

            <div id="mainContent">
                <div class="royal-banner" id="banner">
                    <div class="b-item"><div class="b-head">Question</div><div class="b-val" id="dID">-</div></div>
                    <div class="b-item"><div class="b-head">Surah</div><div class="b-val" id="dSurah">-</div></div>
                    <div class="b-item"><div class="b-head">Ayah</div><div class="b-val" id="dAyah">-</div></div>
                    <div class="b-item"><div class="b-head">Juz</div><div class="b-val" id="dJuz">-</div></div>
                </div>
                
                <div id="quranText"></div>
            </div>
        </div>

        <script>
            window.opener.initExtraScreen(window);

            function updateView(d) {
                // 1. Apply Settings
                document.getElementById('bodyEl').className = 'bg-' + d.settings.theme;
                const txt = document.getElementById('quranText');
                txt.style.fontSize = d.settings.size + 'vmin';
                
                // Line Limit
                const l = parseInt(d.settings.lines);
                if(l > 0) {
                    txt.style.display = '-webkit-box';
                    txt.style.webkitLineClamp = l;
                    txt.style.webkitBoxOrient = 'vertical';
                } else {
                    txt.style.display = 'flex'; // Centered full view
                }

                // 2. Handle Phase
                if(d.phase === 'grid') {
                    document.getElementById('readScreen').style.display = 'none';
                    const gs = document.getElementById('gridScreen');
                    gs.style.display = 'grid';
                    gs.innerHTML = '';
                    
                    for(let i=1; i<=20; i++) {
                        let b = document.createElement('div');
                        b.className = 'grid-box ' + (d.taken.includes(i) ? 'taken' : '');
                        b.innerText = i;
                        b.onclick = () => window.opener.extraGridClick(i);
                        gs.appendChild(b);
                    }
                } else {
                    // READING PHASE
                    document.getElementById('gridScreen').style.display = 'none';
                    document.getElementById('readScreen').style.display = 'flex';
                    
                    // Render Sidebar
                    const sb = document.getElementById('sideBar');
                    sb.innerHTML = '';
                    d.selection.forEach((q, idx) => {
                        let div = document.createElement('div');
                        div.className = 'q-card ' + (idx === d.currentIdx ? 'active' : '');
                        div.innerHTML = \`
                            <div class="q-label">Question \${idx+1}</div>
                            <div class="q-detail">\${q.surah}</div>
                            <div style="font-size:12px;">Ayah: \${q.start} - \${q.end}</div>
                        \`;
                        sb.appendChild(div);
                    });

                    // Render Main Content
                    const cur = d.selection[d.currentIdx];
                    if(cur) {
                        document.getElementById('dID').innerText = cur.id;
                        document.getElementById('dSurah').innerText = cur.surah;
                        document.getElementById('dAyah').innerText = cur.start + '-' + cur.end;
                        document.getElementById('dJuz').innerText = cur.juz;

                        // HIFZ vs TILAWA Logic
                        if(d.settings.mode === 'hifz') {
                            txt.innerText = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ® (Hifz)";
                            txt.style.color = "#FFD700";
                            txt.style.border = "2px dashed #555";
                            txt.style.padding = "20px";
                        } else {
                            txt.innerText = cur.text;
                            txt.style.color = "#fff";
                            txt.style.border = "none";
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
}

// --- 4. CONTROLLER LOGIC ---
window.initExtraScreen = function(win) { syncExtraScreen(); };

window.extraGridClick = function(num) {
    if(state.extra.gridTaken.includes(num)) return;

    const limit = parseInt(document.getElementById('exPickCount').value);
    
    // Add to selection
    const qData = state.extra.gridMapping[num];
    if(qData) {
        state.extra.gridTaken.push(num);
        state.extra.selection.push(qData);
    }

    // Check if limit reached
    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'reading';
        state.extra.currentIndex = 0; // Show first selected
    }

    document.getElementById('exMonitor').innerText = `Selected: ${state.extra.selection.length} / ${limit}`;
    syncExtraScreen();
};

window.extraNextQ = function() {
    if(state.extra.phase !== 'reading') return;
    
    if(state.extra.currentIndex < state.extra.selection.length - 1) {
        state.extra.currentIndex++;
        syncExtraScreen();
    } else {
        // Option: Loop back or finish? Let's stop at end.
        // alert("Last Question Reached");
    }
};

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
};

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    
    const packet = {
        phase: state.extra.phase,
        taken: state.extra.gridTaken,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        settings: state.extra.settings
    };
    state.extra.window.updateView(packet);
}
    // ========================================================
// ‚òÖ MASTER EXTRA SCREEN LOGIC (V5 - HIFZ & GRID FIXED) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        // Full CSV Data
    filteredPool: [],   // Data filtered by Syllabus
    gridMapping: {},    // Grid Box 1-20 -> Question Data
    selection: [],      // Selected Questions
    currentIndex: -1,   // Active Question Index (-1 = Not started)
    phase: 'idle',      // phases: 'grid', 'ready', 'active', 'finished'
    settings: {
        size: 8, theme: 'green', mode: 'tilawa' // 'tilawa' or 'hifz'
    },
    window: null
};

// --- 1. CSV LOADER (RASFAHI MASTER FORMAT) ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        
        // Skip Header
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            // Handle quotes in CSV
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                state.extra.allData.push({
                    id: parseInt(clean[0]),
                    juz: clean[1],
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6] // Arabic Text
                });
            }
        }
        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs`;
        resetExtraSession();
    };
    r.readAsText(file);
}

// --- 2. RESET & GRID SETUP ---
function resetExtraSession() {
    // Filter by Scope
    const startID = parseInt(document.getElementById('exStart').value) || 1;
    const endID = parseInt(document.getElementById('exEnd').value) || 9999;
    
    state.extra.filteredPool = state.extra.allData.filter(q => q.id >= startID && q.id <= endID);
    
    if(state.extra.filteredPool.length === 0) {
        document.getElementById('exMonitor').innerText = "‚ö†Ô∏è Scope Empty!";
        return;
    }

    // Setup 20 Grid Boxes Randomly
    state.extra.gridMapping = {};
    let tempPool = [...state.extra.filteredPool];
    
    for(let i=1; i<=20; i++) {
        if(tempPool.length > 0) {
            const rIdx = Math.floor(Math.random() * tempPool.length);
            state.extra.gridMapping[i] = tempPool[rIdx];
            tempPool.splice(rIdx, 1);
        } else {
            // Recycle if pool is small
            const rIdx = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[rIdx];
        }
    }

    // Reset State
    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid'; // Start with Grid
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = "WAITING FOR SELECTION...";
    document.getElementById('btnNextQ').innerText = "‚ñ∂ START / NEXT";
    document.getElementById('btnNextQ').disabled = true; // Disable until selection done

    syncExtraScreen();
}

// --- 3. OPEN STUDENT SCREEN ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }

            /* --- 1. GRID SCREEN --- */
            #gridContainer {
                width: 100%; height: 100%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                padding: 50px; box-sizing: border-box;
                background: radial-gradient(circle, #002200, #000);
                align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0.8));
                border: 2px solid #FFD700; border-radius: 15px;
                display: flex; justify-content: center; align-items: center;
                font-size: 4vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transition: all 0.3s;
            }
            .grid-box:hover { transform: scale(1.05); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; pointer-events: none; transform: scale(0); }

            /* --- 2. READING SCREEN --- */
            #readContainer {
                width: 100%; height: 100%; display: none; 
                flex-direction: row; /* Sidebar Left (RTL) */
                background: #000;
            }

            /* Sidebar (Questions List) */
            #sideBar {
                width: 25%; height: 100%;
                background: #0a0a0a; border-left: 3px solid #FFD700;
                padding: 20px; box-sizing: border-box;
                display: flex; flex-direction: column; gap: 15px;
            }
            .q-card {
                border: 1px solid #333; padding: 15px; border-radius: 8px;
                background: #111; color: #777; transition: 0.3s;
            }
            .q-card.active {
                border-color: #FFD700; background: #001a00; color: #fff;
                box-shadow: 0 0 15px rgba(212,175,55,0.2);
            }
            .q-title { font-family: 'Cinzel', serif; font-size: 14px; color: #FFD700; }
            .q-info { font-size: 18px; font-weight:bold; margin-top:5px; }

            /* Main Content Area */
            #mainContent {
                flex: 1; display: flex; flex-direction: column;
                justify-content: center; align-items: center;
                position: relative; padding: 40px;
            }

            /* Royal Banner */
            #topBanner {
                position: absolute; top: 0; left: 0; width: 100%;
                height: 80px; background: linear-gradient(90deg, #000, #1a1a1a, #000);
                border-bottom: 2px solid #FFD700;
                display: flex; justify-content: space-around; align-items: center;
                color: #FFD700; font-family: 'Cinzel', serif;
                direction: ltr; /* English headers */
                opacity: 0; transition: 0.5s;
            }
            .b-item { text-align: center; }
            .b-label { font-size: 10px; color: #888; text-transform:uppercase; }
            .b-val { font-size: 20px; font-weight: bold; }

            /* Quran / Hifz Text */
            #displayText {
                font-size: 6vw; line-height: 2.0; color: #fff;
                text-align: center; font-weight: bold;
                text-shadow: 0 4px 10px rgba(0,0,0,0.8);
                opacity: 0; transition: opacity 0.5s;
                direction: rtl; width: 90%;
            }
            
            /* Hifz Mode Style */
            .hifz-badge {
                font-family: 'Noto Sans Thaana', sans-serif;
                font-size: 5vw; color: #FFD700;
                border: 4px double #FFD700; padding: 40px;
                border-radius: 20px; background: rgba(0,0,0,0.5);
            }

        </style>
    </head>
    <body>
        
        <div id="gridContainer"></div>

        <div id="readContainer">
            <div id="sideBar"></div>

            <div id="mainContent">
                <div id="topBanner">
                    <div class="b-item"><div class="b-label">Surah</div><div class="b-val" id="dSurah">-</div></div>
                    <div class="b-item"><div class="b-label">Ayah</div><div class="b-val" id="dAyah">-</div></div>
                    <div class="b-item"><div class="b-label">Juz</div><div class="b-val" id="dJuz">-</div></div>
                </div>
                <div id="displayText"></div>
            </div>
        </div>

        <script>
            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer');
                gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    b.onclick = () => { if(window.opener) window.opener.extraGridClick(i); };
                    gc.appendChild(b);
                }
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const txt = document.getElementById('displayText');
                const banner = document.getElementById('topBanner');
                const sideBar = document.getElementById('sideBar');

                // PHASE LOGIC
                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid';
                    readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } 
                else {
                    // READY or READING
                    gridDiv.style.display = 'none';
                    readDiv.style.display = 'flex';

                    // Update Sidebar
                    sideBar.innerHTML = '';
                    d.selection.forEach((q, idx) => {
                        let card = document.createElement('div');
                        let isActive = (d.phase === 'reading' && idx === d.currentIdx);
                        card.className = 'q-card ' + (isActive ? 'active' : '');
                        card.innerHTML = \`
                            <div class="q-title">Question \${idx+1}</div>
                            <div class="q-info">\${q.surah}</div>
                            <div style="font-size:12px;">Ayah: \${q.start}</div>
                        \`;
                        sideBar.appendChild(card);
                    });

                    // Update Main Content
                    if (d.phase === 'ready') {
                        // Waiting for Judge
                        txt.style.opacity = '1';
                        txt.className = 'hifz-badge'; // Reuse style
                        txt.innerText = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        txt.style.fontSize = "3vw";
                        banner.style.opacity = '0';
                    }
                    else if (d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(cur) {
                            // Update Banner
                            banner.style.opacity = '1';
                            document.getElementById('dSurah').innerText = cur.surah;
                            document.getElementById('dAyah').innerText = cur.start + '-' + cur.end;
                            document.getElementById('dJuz').innerText = cur.juz;

                            // Update Text (Hifz vs Tilawa)
                            txt.style.opacity = '1';
                            if (d.settings.mode === 'hifz') {
                                txt.className = 'hifz-badge';
                                txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px; color:#aaa;'>(Reciting from Memory)</span>";
                            } else {
                                txt.className = ''; // Remove badge style
                                txt.innerText = cur.text;
                                txt.style.fontSize = d.settings.size + 'vw'; // Dynamic Size
                            }
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    
    // Initial Sync
    setTimeout(syncExtraScreen, 500);
}

// --- 4. CONTROLLER LOGIC ---
window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return; // Prevent double pick

    const limit = parseInt(document.getElementById('exPickCount').value);
    
    // Get Question Data
    const qData = state.extra.gridMapping[num];
    if(qData) {
        state.extra.selection.push({ ...qData, gridNum: num });
    }

    // Check Limit
    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready'; // Move to Waiting Phase
        document.getElementById('exMonitor').innerText = "SELECTION COMPLETE. READY TO START.";
        document.getElementById('btnNextQ').disabled = false; // Enable Judge Control
    } else {
        document.getElementById('exMonitor').innerText = `Picked ${state.extra.selection.length} / ${limit}`;
    }

    syncExtraScreen();
};

window.extraNextQ = function() {
    if(state.extra.phase === 'ready') {
        // Start First Question
        state.extra.phase = 'reading';
        state.extra.currentIndex = 0;
    } 
    else if(state.extra.phase === 'reading') {
        // Move Next
        if(state.extra.currentIndex < state.extra.selection.length - 1) {
            state.extra.currentIndex++;
        } else {
            // Finished
            alert("All questions finished!");
            return;
        }
    }
    
    updateMonitor();
    syncExtraScreen();
};

function updateMonitor() {
    const cur = state.extra.selection[state.extra.currentIndex];
    const info = cur ? `${cur.surah} (Ayah ${cur.start})` : "";
    document.getElementById('exMonitor').innerText = `Active: Q${state.extra.currentIndex + 1} - ${info}`;
}

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
};

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    
    const packet = {
        phase: state.extra.phase,
        selection: state.extra.selection, // Send full selection list for sidebar
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum), // For grid hiding
        settings: state.extra.settings
    };
    
    if(state.extra.window.updateView) {
        state.extra.window.updateView(packet);
    }
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V6 - FINAL FILTER & BOX) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        // Full Data
    filteredPool: [],   // Filtered Data
    uniqueJuz: [],      // List of unique Juz numbers
    uniqueSurah: [],    // List of unique Surah names
    gridMapping: {},    
    selection: [],      
    currentIndex: -1,   
    phase: 'idle',      
    settings: {
        size: 6, width: 85, height: 60, // Box Dimensions
        theme: 'green', mode: 'tilawa' 
    },
    window: null
};

// --- 1. UI HELPERS ---
function toggleFilterUI() {
    const type = document.getElementById('filterType').value;
    document.getElementById('divJuzSelect').style.display = (type === 'juz') ? 'grid' : 'none';
    document.getElementById('divSurahSelect').style.display = (type === 'surah') ? 'grid' : 'none';
}

function populateDropdown(id, list) {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    list.forEach((item, index) => {
        let opt = document.createElement('option');
        opt.value = item; // Value is the item itself (Juz 1, Surah Name)
        opt.text = item;
        sel.appendChild(opt);
    });
    // Select last item for "End" dropdowns
    if(id.startsWith('end') && list.length > 0) sel.value = list[list.length-1];
}

// --- 2. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        const juzSet = new Set();
        const surahSet = new Set(); // Use Set to keep order if CSV is ordered
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                // Data Mapping
                const item = {
                    id: parseInt(clean[0]),
                    juz: parseInt(clean[1]), // Juz needs to be int for sorting
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6]
                };
                state.extra.allData.push(item);
                if(!isNaN(item.juz)) juzSet.add(item.juz);
                if(item.surah) surahSet.add(item.surah);
            }
        }
        
        // Populate Dropdowns
        state.extra.uniqueJuz = Array.from(juzSet).sort((a,b)=>a-b);
        state.extra.uniqueSurah = Array.from(surahSet); // Keep CSV order for Surahs
        
        populateDropdown('startJuz', state.extra.uniqueJuz);
        populateDropdown('endJuz', state.extra.uniqueJuz);
        populateDropdown('startSurah', state.extra.uniqueSurah);
        populateDropdown('endSurah', state.extra.uniqueSurah);

        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs. Filter Ready.`;
        // No auto reset, let user choose filter first
    };
    r.readAsText(file);
}

// --- 3. RESET & FILTER LOGIC ---
function resetExtraSession() {
    const type = document.getElementById('filterType').value;
    
    if(state.extra.allData.length === 0) {
        alert("Please load CSV first!"); return;
    }

    if(type === 'juz') {
        const sJuz = parseInt(document.getElementById('startJuz').value);
        const eJuz = parseInt(document.getElementById('endJuz').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.juz >= sJuz && q.juz <= eJuz);
    } 
    else {
        // Surah Filtering logic (Index based)
        const sSurah = document.getElementById('startSurah').value;
        const eSurah = document.getElementById('endSurah').value;
        
        // Find indices in the unique list
        const sIdx = state.extra.uniqueSurah.indexOf(sSurah);
        const eIdx = state.extra.uniqueSurah.indexOf(eSurah);
        
        // Filter based on the selected Surah names
        // We allow range selection (e.g. Fatiha to Baqarah)
        if(sIdx > -1 && eIdx > -1) {
            const validSurahs = state.extra.uniqueSurah.slice(Math.min(sIdx, eIdx), Math.max(sIdx, eIdx) + 1);
            state.extra.filteredPool = state.extra.allData.filter(q => validSurahs.includes(q.surah));
        } else {
            state.extra.filteredPool = [];
        }
    }

    if(state.extra.filteredPool.length === 0) {
        document.getElementById('exMonitor').innerText = "‚ö†Ô∏è Filter Result Empty!";
        return;
    }

    // Grid Setup
    state.extra.gridMapping = {};
    let tempPool = [...state.extra.filteredPool];
    
    for(let i=1; i<=20; i++) {
        if(tempPool.length > 0) {
            const rIdx = Math.floor(Math.random() * tempPool.length);
            state.extra.gridMapping[i] = tempPool[rIdx];
            tempPool.splice(rIdx, 1);
        } else {
            const rIdx = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[rIdx];
        }
    }

    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = `Ready: ${state.extra.filteredPool.length} Qs found.`;
    document.getElementById('btnNextQ').disabled = true;

    syncExtraScreen();
}

// --- 4. OPEN SCREEN ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }

            /* --- LAYOUTS --- */
            #gridContainer {
                width: 100%; height: 100%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                padding: 50px; box-sizing: border-box;
                background: radial-gradient(circle, #002200, #000);
                align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0.8));
                border: 2px solid #FFD700; border-radius: 15px;
                display: flex; justify-content: center; align-items: center;
                font-size: 4vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transition: all 0.3s;
            }
            .grid-box:hover { transform: scale(1.05); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; pointer-events: none; transform: scale(0); }

            /* --- READING SCREEN --- */
            #readContainer {
                width: 100%; height: 100%; display: none; 
                flex-direction: row; 
                background: #000;
            }

            /* --- SIDEBAR --- */
            #sideBar {
                width: 25%; height: 100%;
                background: #0a0a0a; border-left: 3px solid #FFD700;
                padding: 20px; box-sizing: border-box;
                display: flex; flex-direction: column; gap: 15px;
            }
            /* Sidebar Dynamic Header */
            #sbHeader {
                color: #FFD700; font-family: 'Noto Sans Thaana', sans-serif;
                font-size: 1.2vw; text-align: center; margin-bottom: 20px;
                border-bottom: 1px dashed #555; padding-bottom: 10px;
            }

            .q-card {
                border: 1px solid #333; padding: 15px; border-radius: 8px;
                background: #111; color: #777; transition: 0.3s;
            }
            .q-card.active {
                border-color: #FFD700; background: #001a00; color: #fff;
                box-shadow: 0 0 15px rgba(212,175,55,0.2);
            }
            .q-title { font-family: 'Cinzel', serif; font-size: 14px; color: #FFD700; }
            .q-info { font-size: 18px; font-weight:bold; margin-top:5px; }

            /* --- MAIN CONTENT & ROYAL BOX --- */
            #mainContent {
                flex: 1; display: flex; flex-direction: column;
                justify-content: center; align-items: center;
                position: relative; padding: 40px;
            }

            #topBanner {
                position: absolute; top: 0; left: 0; width: 100%;
                height: 80px; background: linear-gradient(90deg, #000, #1a1a1a, #000);
                border-bottom: 2px solid #FFD700;
                display: flex; justify-content: space-around; align-items: center;
                color: #FFD700; font-family: 'Cinzel', serif;
                direction: ltr; opacity: 0; transition: 0.5s;
            }
            .b-item { text-align: center; }
            .b-label { font-size: 10px; color: #888; text-transform:uppercase; }
            .b-val { font-size: 20px; font-weight: bold; }

            /* THE ROYAL TEXT BOX */
            #royalBox {
                border: 6px double #FFD700;
                border-radius: 20px;
                padding: 40px;
                background: radial-gradient(circle, rgba(0,20,0,0.8), rgba(0,0,0,0.9));
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.2), inset 0 0 50px rgba(0,0,0,0.8);
                display: flex; justify-content: center; align-items: center;
                overflow: hidden; opacity: 0; transition: opacity 0.5s;
                position: relative;
            }
            
            /* Decorative Corners */
            #royalBox::before {
                content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
                border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 15px; pointer-events: none;
            }

            #displayText {
                color: #fff; line-height: 2.0; font-weight: bold;
                text-align: center; direction: rtl;
                text-shadow: 0 4px 10px rgba(0,0,0,0.8);
                width: 100%; height: 100%;
                display: flex; align-items: center; justify-content: center;
                white-space: pre-wrap; /* Keeps formatting */
            }

            .hifz-badge {
                font-family: 'Noto Sans Thaana', sans-serif;
                font-size: 4vw; color: #FFD700; text-align:center;
            }

        </style>
    </head>
    <body>
        <div id="gridContainer"></div>

        <div id="readContainer">
            <div id="sideBar">
                <div id="sbHeader"></div> <div id="sideList"></div>
            </div>

            <div id="mainContent">
                <div id="topBanner">
                    <div class="b-item"><div class="b-label">Surah</div><div class="b-val" id="dSurah">-</div></div>
                    <div class="b-item"><div class="b-label">Ayah</div><div class="b-val" id="dAyah">-</div></div>
                    <div class="b-item"><div class="b-label">Juz</div><div class="b-val" id="dJuz">-</div></div>
                </div>
                
                <div id="royalBox">
                    <div id="displayText"></div>
                </div>
            </div>
        </div>

        <script>
            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer');
                gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    b.onclick = () => { if(window.opener) window.opener.extraGridClick(i); };
                    gc.appendChild(b);
                }
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const box = document.getElementById('royalBox');
                const txt = document.getElementById('displayText');
                const banner = document.getElementById('topBanner');
                const sideList = document.getElementById('sideList');
                const sbHeader = document.getElementById('sbHeader');

                // Apply Box Settings
                box.style.width = d.settings.width + '%';
                box.style.height = d.settings.height + '%';
                txt.style.fontSize = d.settings.size + 'vw';

                // Set Sidebar Header based on Mode
                if(d.settings.mode === 'hifz') {
                    sbHeader.innerText = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";
                } else {
                    sbHeader.innerText = "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";
                }

                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid';
                    readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } 
                else {
                    gridDiv.style.display = 'none';
                    readDiv.style.display = 'flex';

                    // Update List
                    sideList.innerHTML = '';
                    d.selection.forEach((q, idx) => {
                        let card = document.createElement('div');
                        let isActive = (d.phase === 'reading' && idx === d.currentIdx);
                        card.className = 'q-card ' + (isActive ? 'active' : '');
                        card.innerHTML = \`
                            <div class="q-title">Question \${idx+1}</div>
                            <div class="q-info">\${q.surah}</div>
                            <div style="font-size:12px;">Ayah: \${q.start}</div>
                        \`;
                        sideList.appendChild(card);
                    });

                    if (d.phase === 'ready') {
                        box.style.opacity = '1';
                        banner.style.opacity = '0';
                        txt.className = 'hifz-badge';
                        txt.innerHTML = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        box.style.border = "none"; box.style.background = "transparent"; box.style.boxShadow = "none";
                    }
                    else if (d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(cur) {
                            banner.style.opacity = '1';
                            document.getElementById('dSurah').innerText = cur.surah;
                            document.getElementById('dAyah').innerText = cur.start + '-' + cur.end;
                            document.getElementById('dJuz').innerText = cur.juz;

                            box.style.opacity = '1';
                            // Restore Royal Box Style
                            box.style.border = "6px double #FFD700";
                            box.style.background = "radial-gradient(circle, rgba(0,20,0,0.8), rgba(0,0,0,0.9))";
                            box.style.boxShadow = "0 0 40px rgba(212, 175, 55, 0.2), inset 0 0 50px rgba(0,0,0,0.8)";

                            if (d.settings.mode === 'hifz') {
                                txt.className = 'hifz-badge';
                                txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px; color:#aaa;'>(Reciting from Memory)</span>";
                            } else {
                                txt.className = ''; 
                                txt.innerText = cur.text;
                            }
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    
    setTimeout(syncExtraScreen, 500);
}

// --- 5. LOGIC CONTROLS ---
window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return;

    const limit = parseInt(document.getElementById('exPickCount').value);
    const qData = state.extra.gridMapping[num];
    
    if(qData) {
        state.extra.selection.push({ ...qData, gridNum: num });
    }

    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready'; 
        document.getElementById('exMonitor').innerText = "SELECTION COMPLETE. READY.";
        document.getElementById('btnNextQ').disabled = false; 
    } else {
        document.getElementById('exMonitor').innerText = `Picked ${state.extra.selection.length} / ${limit}`;
    }
    syncExtraScreen();
};

window.extraNextQ = function() {
    if(state.extra.phase === 'ready') {
        state.extra.phase = 'reading';
        state.extra.currentIndex = 0;
    } 
    else if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex < state.extra.selection.length - 1) {
            state.extra.currentIndex++;
        } else {
            alert("All questions finished!"); return;
        }
    }
    updateMonitor();
    syncExtraScreen();
};

function updateMonitor() {
    const cur = state.extra.selection[state.extra.currentIndex];
    const info = cur ? `${cur.surah} (Ayah ${cur.start})` : "";
    document.getElementById('exMonitor').innerText = `Active: Q${state.extra.currentIndex + 1} - ${info}`;
}

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
};

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    const packet = {
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings
    };
    if(state.extra.window.updateView) state.extra.window.updateView(packet);
}
    // --- 4. OPEN SCREEN (WITH FULLSCREEN CLICK) ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fonts = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fonts}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
                cursor: pointer; /* Shows hand cursor to indicate clickable */
            }

            /* --- LAYOUTS --- */
            #gridContainer {
                width: 100%; height: 100%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                padding: 50px; box-sizing: border-box;
                background: radial-gradient(circle, #002200, #000);
                align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0.8));
                border: 2px solid #FFD700; border-radius: 15px;
                display: flex; justify-content: center; align-items: center;
                font-size: 4vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transition: all 0.3s;
            }
            .grid-box:hover { transform: scale(1.05); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; pointer-events: none; transform: scale(0); }

            /* --- READING SCREEN --- */
            #readContainer {
                width: 100%; height: 100%; display: none; 
                flex-direction: row; 
                background: #000;
            }

            /* --- SIDEBAR --- */
            #sideBar {
                width: 25%; height: 100%;
                background: #0a0a0a; border-left: 3px solid #FFD700;
                padding: 20px; box-sizing: border-box;
                display: flex; flex-direction: column; gap: 15px;
            }
            #sbHeader {
                color: #FFD700; font-family: 'Noto Sans Thaana', sans-serif;
                font-size: 1.2vw; text-align: center; margin-bottom: 20px;
                border-bottom: 1px dashed #555; padding-bottom: 10px;
            }

            .q-card {
                border: 1px solid #333; padding: 15px; border-radius: 8px;
                background: #111; color: #777; transition: 0.3s;
            }
            .q-card.active {
                border-color: #FFD700; background: #001a00; color: #fff;
                box-shadow: 0 0 15px rgba(212,175,55,0.2);
            }
            .q-title { font-family: 'Cinzel', serif; font-size: 14px; color: #FFD700; }
            .q-info { font-size: 18px; font-weight:bold; margin-top:5px; }

            /* --- MAIN CONTENT --- */
            #mainContent {
                flex: 1; display: flex; flex-direction: column;
                justify-content: center; align-items: center;
                position: relative; padding: 40px;
            }

            #topBanner {
                position: absolute; top: 0; left: 0; width: 100%;
                height: 80px; background: linear-gradient(90deg, #000, #1a1a1a, #000);
                border-bottom: 2px solid #FFD700;
                display: flex; justify-content: space-around; align-items: center;
                color: #FFD700; font-family: 'Cinzel', serif;
                direction: ltr; opacity: 0; transition: 0.5s;
            }
            .b-item { text-align: center; }
            .b-label { font-size: 10px; color: #888; text-transform:uppercase; }
            .b-val { font-size: 20px; font-weight: bold; }

            /* ROYAL TEXT BOX */
            #royalBox {
                border: 6px double #FFD700;
                border-radius: 20px;
                padding: 40px;
                background: radial-gradient(circle, rgba(0,20,0,0.8), rgba(0,0,0,0.9));
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.2), inset 0 0 50px rgba(0,0,0,0.8);
                display: flex; justify-content: center; align-items: center;
                overflow: hidden; opacity: 0; transition: opacity 0.5s;
                position: relative;
            }
            #royalBox::before {
                content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
                border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 15px; pointer-events: none;
            }

            #displayText {
                color: #fff; line-height: 2.0; font-weight: bold;
                text-align: center; direction: rtl;
                text-shadow: 0 4px 10px rgba(0,0,0,0.8);
                width: 100%; height: 100%;
                display: flex; align-items: center; justify-content: center;
                white-space: pre-wrap; 
            }

            .hifz-badge {
                font-family: 'Noto Sans Thaana', sans-serif;
                font-size: 4vw; color: #FFD700; text-align:center;
            }
        </style>
    </head>
    <body>
        <div id="gridContainer"></div>

        <div id="readContainer">
            <div id="sideBar">
                <div id="sbHeader"></div>
                <div id="sideList"></div>
            </div>

            <div id="mainContent">
                <div id="topBanner">
                    <div class="b-item"><div class="b-label">Surah</div><div class="b-val" id="dSurah">-</div></div>
                    <div class="b-item"><div class="b-label">Ayah</div><div class="b-val" id="dAyah">-</div></div>
                    <div class="b-item"><div class="b-label">Juz</div><div class="b-val" id="dJuz">-</div></div>
                </div>
                
                <div id="royalBox">
                    <div id="displayText"></div>
                </div>
            </div>
        </div>

        <script>
           
            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer');
                gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    // Stop propagation so grid click doesn't toggle fullscreen immediately if not desired
                    // But usually user wants fullscreen on first click anyway.
                    b.onclick = (e) => { 
                        // e.stopPropagation(); // Uncomment if you DONT want grid click to trigger fullscreen
                        if(window.opener) window.opener.extraGridClick(i); 
                    };
                    gc.appendChild(b);
                }
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const box = document.getElementById('royalBox');
                const txt = document.getElementById('displayText');
                const banner = document.getElementById('topBanner');
                const sideList = document.getElementById('sideList');
                const sbHeader = document.getElementById('sbHeader');

                // Box Settings
                box.style.width = d.settings.width + '%';
                box.style.height = d.settings.height + '%';
                txt.style.fontSize = d.settings.size + 'vw';

                // Sidebar Header
                if(d.settings.mode === 'hifz') {
                    sbHeader.innerText = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";
                } else {
                    sbHeader.innerText = "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";
                }

                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid';
                    readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } 
                else {
                    gridDiv.style.display = 'none';
                    readDiv.style.display = 'flex';

                    // Update List
                    sideList.innerHTML = '';
                    d.selection.forEach((q, idx) => {
                        let card = document.createElement('div');
                        let isActive = (d.phase === 'reading' && idx === d.currentIdx);
                        card.className = 'q-card ' + (isActive ? 'active' : '');
                        card.innerHTML = \`
                            <div class="q-title">Question \${idx+1}</div>
                            <div class="q-info">\${q.surah}</div>
                            <div style="font-size:12px;">Ayah: \${q.start}</div>
                        \`;
                        sideList.appendChild(card);
                    });

                    if (d.phase === 'ready') {
                        box.style.opacity = '1';
                        banner.style.opacity = '0';
                        txt.className = 'hifz-badge';
                        txt.innerHTML = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        box.style.border = "none"; box.style.background = "transparent"; box.style.boxShadow = "none";
                    }
                    else if (d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(cur) {
                            banner.style.opacity = '1';
                            document.getElementById('dSurah').innerText = cur.surah;
                            document.getElementById('dAyah').innerText = cur.start + '-' + cur.end;
                            document.getElementById('dJuz').innerText = cur.juz;

                            box.style.opacity = '1';
                            box.style.border = "6px double #FFD700";
                            box.style.background = "radial-gradient(circle, rgba(0,20,0,0.8), rgba(0,0,0,0.9))";
                            box.style.boxShadow = "0 0 40px rgba(212, 175, 55, 0.2), inset 0 0 50px rgba(0,0,0,0.8)";

                            if (d.settings.mode === 'hifz') {
                                txt.className = 'hifz-badge';
                                txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px; color:#aaa;'>(Reciting from Memory)</span>";
                            } else {
                                txt.className = ''; 
                                txt.innerText = cur.text;
                            }
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;

    state.extra.window = window.open("", "ExtraScreen", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    
    setTimeout(syncExtraScreen, 500);
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V7 - 50 ROYAL THEMES) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        
    filteredPool: [],   
    uniqueJuz: [],      
    uniqueSurah: [],    
    gridMapping: {},    
    selection: [],      
    currentIndex: -1,   
    phase: 'idle',      
    settings: {
        size: 8, theme: 'green_1', mode: 'tilawa' 
    },
    window: null
};

// --- 1. THEME ENGINE (50 STYLES GENERATOR) ---
// This function returns CSS string based on theme ID
function getRoyalThemeCSS(themeID) {
    let css = "";
    
    // Base Colors
    const colors = {
        green: { bg1: "#002200", bg2: "#000000", border: "#FFD700" },
        blue: { bg1: "#001a33", bg2: "#000000", border: "#C0C0C0" },
        red: { bg1: "#330000", bg2: "#1a0000", border: "#FFD700" },
        black: { bg1: "#111111", bg2: "#000000", border: "#D4AF37" },
        mix: { bg1: "#1a0033", bg2: "#000000", border: "#FFD700" }
    };

    // Parse ID (e.g. "green_1")
    const parts = themeID.split('_');
    const cat = parts[0];
    const num = parseInt(parts[1]);
    const c = colors[cat] || colors.green;

    // Define border style based on number
    let borderStyle = "double";
    let borderWidth = "10px";
    let borderRadius = "20px"; // Default rounded
    let shadow = "0 0 30px rgba(0,0,0,0.8)";

    if (num === 1) { borderStyle = "double"; borderWidth = "15px"; }
    if (num === 2) { borderStyle = "solid"; borderWidth = "5px"; borderRadius = "30px"; }
    if (num === 3) { borderStyle = "groove"; borderWidth = "20px"; borderRadius = "0px"; } // Pattern/Square
    if (num === 4) { borderStyle = "ridge"; borderWidth = "10px"; borderRadius = "10px"; }
    if (num === 5) { borderStyle = "solid"; borderWidth = "3px"; shadow = "0 0 20px " + c.border; } // Glow
    if (num === 6) { borderStyle = "inset"; borderWidth = "15px"; borderRadius = "50px"; }
    if (num === 7) { borderStyle = "outset"; borderWidth = "10px"; }
    if (num === 8) { borderStyle = "double"; borderWidth = "8px"; borderRadius = "0px"; } // Square
    if (num === 9) { borderStyle = "solid"; borderWidth = "1px"; shadow = "inset 0 0 50px #000"; }
    if (num === 10) { borderStyle = "dotted"; borderWidth = "5px"; borderRadius = "15px"; }

    // Override colors for Mix category
    let bg = `radial-gradient(circle, ${c.bg1}, ${c.bg2})`;
    if(cat === 'mix') {
        if(num===1) bg = "linear-gradient(135deg, #4a148c, #000)";
        if(num===2) { bg = "#f5f5f5"; c.border = "#D4AF37"; } // White Gold
        if(num===3) bg = "linear-gradient(#5d4037, #000)"; // Bronze
    }

    css = `
        background: ${bg};
        border: ${borderWidth} ${borderStyle} ${c.border};
        border-radius: ${borderRadius};
        box-shadow: ${shadow};
    `;
    
    // Text Color Override for Light Themes
    let txtColor = "#ffffff";
    if(cat === 'mix' && num === 2) txtColor = "#000000";

    return { box: css, text: txtColor };
}

// --- 2. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        const juzSet = new Set();
        const surahSet = new Set();
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                const item = {
                    id: parseInt(clean[0]),
                    juz: parseInt(clean[1]),
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6]
                };
                state.extra.allData.push(item);
                if(!isNaN(item.juz)) juzSet.add(item.juz);
                if(item.surah) surahSet.add(item.surah);
            }
        }
        state.extra.uniqueJuz = Array.from(juzSet).sort((a,b)=>a-b);
        state.extra.uniqueSurah = Array.from(surahSet);
        
        populateDropdown('startJuz', state.extra.uniqueJuz);
        populateDropdown('endJuz', state.extra.uniqueJuz);
        populateDropdown('startSurah', state.extra.uniqueSurah);
        populateDropdown('endSurah', state.extra.uniqueSurah);

        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs.`;
    };
    r.readAsText(file);
}

function toggleFilterUI() {
    const type = document.getElementById('filterType').value;
    document.getElementById('divJuzSelect').style.display = (type === 'juz') ? 'grid' : 'none';
    document.getElementById('divSurahSelect').style.display = (type === 'surah') ? 'grid' : 'none';
}

function populateDropdown(id, list) {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    list.forEach(item => {
        let opt = document.createElement('option');
        opt.value = item; opt.text = item;
        sel.appendChild(opt);
    });
    if(id.startsWith('end') && list.length > 0) sel.value = list[list.length-1];
}

// --- 3. RESET ---
function resetExtraSession() {
    if(state.extra.allData.length === 0) { alert("Load CSV first!"); return; }
    
    const type = document.getElementById('filterType').value;
    if(type === 'juz') {
        const s = parseInt(document.getElementById('startJuz').value);
        const e = parseInt(document.getElementById('endJuz').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.juz >= s && q.juz <= e);
    } else {
        const s = document.getElementById('startSurah').value;
        const e = document.getElementById('endSurah').value;
        const sIdx = state.extra.uniqueSurah.indexOf(s);
        const eIdx = state.extra.uniqueSurah.indexOf(e);
        if(sIdx > -1 && eIdx > -1) {
            const valid = state.extra.uniqueSurah.slice(Math.min(sIdx, eIdx), Math.max(sIdx, eIdx)+1);
            state.extra.filteredPool = state.extra.allData.filter(q => valid.includes(q.surah));
        }
    }

    if(state.extra.filteredPool.length === 0) { document.getElementById('exMonitor').innerText = "Empty Filter!"; return; }

    state.extra.gridMapping = {};
    let temp = [...state.extra.filteredPool];
    for(let i=1; i<=20; i++) {
        if(temp.length > 0) {
            const r = Math.floor(Math.random() * temp.length);
            state.extra.gridMapping[i] = temp[r];
            temp.splice(r, 1);
        } else {
            const r = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[r];
        }
    }

    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    document.getElementById('exMonitor').innerText = `Ready (${state.extra.filteredPool.length})`;
    document.getElementById('btnNextQ').disabled = true;
    syncExtraScreen();
}

// --- 4. OPEN SCREEN ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    // Import Faruuma from provided URL or Local
    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Royal Student Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }
            /* Grid */
            #gridContainer {
                width: 100%; height: 100%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                padding: 50px; background: radial-gradient(circle, #002200, #000); align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0.8));
                border: 2px solid #FFD700; border-radius: 15px;
                display: flex; justify-content: center; align-items: center;
                font-size: 4vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.3s;
            }
            .grid-box:hover { transform: scale(1.05); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; transform: scale(0); pointer-events: none; }

            /* Reading */
            #readContainer { width: 100%; height: 100%; display: none; flex-direction: row; background: #000; }
            
            #sideBar {
                width: 25%; height: 100%; background: #080808; border-left: 3px solid #FFD700;
                padding: 20px; display: flex; flex-direction: column; gap: 15px;
            }
            #sbHeader {
                color: #FFD700; font-family: 'Faruuma', sans-serif; font-size: 1.5vw;
                text-align: center; border-bottom: 1px dashed #555; padding-bottom: 10px; margin-bottom: 10px;
            }
            .q-card { border: 1px solid #333; padding: 15px; border-radius: 8px; background: #111; color: #777; }
            .q-card.active { border-color: #FFD700; background: #001a00; color: #fff; box-shadow: 0 0 10px #FFD700; }

            #mainContent { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 30px; position:relative; }
            
            #topBanner {
                width: 100%; height: 70px; background: linear-gradient(90deg, #000, #111, #000);
                border-bottom: 2px solid #FFD700; display: flex; justify-content: space-around; align-items: center;
                color: #FFD700; font-family: 'Cinzel', serif; direction: ltr; margin-bottom:20px;
            }
            .b-val { font-size: 22px; font-weight: bold; }

            /* ROYAL BOX & SCROLLING */
            #royalBox {
                width: 90%; height: 75%; /* Large Box */
                padding: 40px; box-sizing: border-box;
                display: flex; justify-content: center; align-items: center;
                transition: all 0.5s;
                position: relative;
            }
            
            #displayText {
                width: 100%; height: 100%;
                overflow-y: auto; /* Enable Scroll */
                text-align: center; font-weight: bold;
                line-height: 2.2; direction: rtl;
                white-space: pre-wrap; 
                display: flex; align-items: center; justify-content: center; /* Center if short */
            }
            /* Scrollbar Styling */
            #displayText::-webkit-scrollbar { width: 10px; }
            #displayText::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 5px; }

            /* Block center alignment when content overflows */
            #displayText.scroll-active { display: block; } 

            .hifz-badge { font-family: 'Faruuma', sans-serif; font-size: 4vw; color: #FFD700; text-align:center; margin:auto; }

        </style>
    </head>
    <body>
        <div id="gridContainer"></div>
        <div id="readContainer">
            <div id="sideBar"><div id="sbHeader"></div><div id="sideList"></div></div>
            <div id="mainContent">
                <div id="topBanner">
                    <div class="b-item">Surah: <span id="dSurah" class="b-val">-</span></div>
                    <div class="b-item">Ayah: <span id="dAyah" class="b-val">-</span></div>
                    <div class="b-item">Juz: <span id="dJuz" class="b-val">-</span></div>
                </div>
                <div id="royalBox"><div id="displayText"></div></div>
            </div>
        </div>
        <script>
            window.opener.initExtra(window);
            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer'); gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    b.onclick = () => window.opener.extraGridClick(i);
                    gc.appendChild(b);
                }
            }
            function applyTheme(css, txtCol) {
                const box = document.getElementById('royalBox');
                box.style.cssText = css; // Apply generated CSS
                document.getElementById('displayText').style.color = txtCol;
            }
            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const txt = document.getElementById('displayText');
                const sbHeader = document.getElementById('sbHeader');
                
                // Set Header
                sbHeader.innerText = (d.settings.mode === 'hifz') ? 
                    "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞" : 
                    "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";

                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid'; readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } else {
                    gridDiv.style.display = 'none'; readDiv.style.display = 'flex';
                    
                    const sl = document.getElementById('sideList'); sl.innerHTML = '';
                    d.selection.forEach((q, i) => {
                        let div = document.createElement('div');
                        div.className = 'q-card ' + (i===d.currentIdx ? 'active' : '');
                        div.innerHTML = \`<div class="q-title">Question \${i+1}</div><div style="font-size:16px;">\${q.surah}</div>\`;
                        sl.appendChild(div);
                    });

                    // THEME APPLICATION
                    if(d.themeData) applyTheme(d.themeData.box, d.themeData.text);

                    if(d.phase === 'ready') {
                        txt.className = 'hifz-badge'; txt.innerText = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                    } else if(d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        document.getElementById('dSurah').innerText = cur.surah;
                        document.getElementById('dAyah').innerText = cur.start + '-' + cur.end;
                        document.getElementById('dJuz').innerText = cur.juz;

                        if(d.settings.mode === 'hifz') {
                            txt.className = 'hifz-badge'; 
                            txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px;'>(Reciting from Memory)</span>";
                        } else {
                            txt.className = '';
                            txt.innerText = cur.text;
                            txt.style.fontSize = d.settings.size + 'vw';
                            
                            // Scroll Check
                            if(txt.scrollHeight > txt.clientHeight) txt.classList.add('scroll-active');
                            else txt.classList.remove('scroll-active');
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;
    state.extra.window = window.open("", "Extra", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    setTimeout(syncExtraScreen, 500);
}

// --- 5. LOGIC CONTROLS ---
window.initExtra = function(w) { syncExtraScreen(); }

window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return;
    const limit = parseInt(document.getElementById('exPickCount').value);
    const qData = state.extra.gridMapping[num];
    if(qData) state.extra.selection.push({ ...qData, gridNum: num });

    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready';
        document.getElementById('exMonitor').innerText = "READY TO START";
        document.getElementById('btnNextQ').disabled = false;
    }
    syncExtraScreen();
}

window.extraNextQ = function() {
    if(state.extra.phase === 'ready') { state.extra.phase = 'reading'; state.extra.currentIndex = 0; }
    else if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex < state.extra.selection.length - 1) state.extra.currentIndex++;
        else { alert("Finished!"); return; }
    }
    syncExtraScreen();
}

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
}

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    // Generate Theme CSS on the fly
    const themeData = getRoyalThemeCSS(state.extra.settings.theme);
    
    state.extra.window.updateView({
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings,
        themeData: themeData // Send compiled CSS
    });
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V8 - FULL CONTROL) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        
    filteredPool: [],   
    uniqueJuz: [],      
    uniqueSurah: [],    
    gridMapping: {},    
    selection: [],      
    currentIndex: -1,   
    phase: 'idle',      
    settings: {
        zoom: 6, boxW: 90, boxH: 80, textX: 0, textY: 0,
        mode: 'tilawa' 
    },
    window: null
};

// --- 1. UI HELPERS ---
function toggleFilterUI() {
    const type = document.getElementById('filterType').value;
    document.getElementById('divJuzSelect').style.display = (type === 'juz') ? 'grid' : 'none';
    document.getElementById('divSurahSelect').style.display = (type === 'surah') ? 'grid' : 'none';
}

function populateDropdown(id, list) {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    list.forEach(item => {
        let opt = document.createElement('option');
        opt.value = item; opt.text = item;
        sel.appendChild(opt);
    });
    if(id.startsWith('end') && list.length > 0) sel.value = list[list.length-1];
}

// --- 2. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        const juzSet = new Set();
        const surahSet = new Set();
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                const item = {
                    id: parseInt(clean[0]),
                    juz: parseInt(clean[1]),
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6]
                };
                state.extra.allData.push(item);
                if(!isNaN(item.juz)) juzSet.add(item.juz);
                if(item.surah) surahSet.add(item.surah);
            }
        }
        state.extra.uniqueJuz = Array.from(juzSet).sort((a,b)=>a-b);
        state.extra.uniqueSurah = Array.from(surahSet);
        
        populateDropdown('startJuz', state.extra.uniqueJuz);
        populateDropdown('endJuz', state.extra.uniqueJuz);
        populateDropdown('startSurah', state.extra.uniqueSurah);
        populateDropdown('endSurah', state.extra.uniqueSurah);

        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs.`;
    };
    r.readAsText(file);
}

// --- 3. RESET & SYLLABUS SETTER ---
function resetExtraSession() {
    if(state.extra.allData.length === 0) { alert("Load CSV first!"); return; }
    
    const type = document.getElementById('filterType').value;
    if(type === 'juz') {
        const s = parseInt(document.getElementById('startJuz').value);
        const e = parseInt(document.getElementById('endJuz').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.juz >= s && q.juz <= e);
    } else {
        const s = document.getElementById('startSurah').value;
        const e = document.getElementById('endSurah').value;
        const sIdx = state.extra.uniqueSurah.indexOf(s);
        const eIdx = state.extra.uniqueSurah.indexOf(e);
        if(sIdx > -1 && eIdx > -1) {
            const valid = state.extra.uniqueSurah.slice(Math.min(sIdx, eIdx), Math.max(sIdx, eIdx)+1);
            state.extra.filteredPool = state.extra.allData.filter(q => valid.includes(q.surah));
        }
    }

    if(state.extra.filteredPool.length === 0) { 
        document.getElementById('exMonitor').innerText = "Empty Filter!"; return; 
    }

    // Grid Setup (1-20 Mapping)
    state.extra.gridMapping = {};
    let temp = [...state.extra.filteredPool];
    for(let i=1; i<=20; i++) {
        if(temp.length > 0) {
            const r = Math.floor(Math.random() * temp.length);
            state.extra.gridMapping[i] = temp[r];
            temp.splice(r, 1);
        } else {
            // Recycle if pool is small
            const r = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[r];
        }
    }

    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = `Grid Ready (${state.extra.filteredPool.length} Qs)`;
    document.getElementById('btnNextQ').disabled = true;
    syncExtraScreen();
}

// --- 4. OPEN SCREEN (NEW DESIGN) ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    // Import Fonts
    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
                cursor: pointer;
            }

            /* --- MAIN OUTER CONTAINER (Dark Green + White Line) --- */
            #royalWrapper {
                width: 100vw; height: 100vh;
                background: #002200; /* Dark Green */
                border: 15px solid #D4AF37; /* Gold Outer Border */
                box-sizing: border-box;
                display: flex; align-items: center; justify-content: center;
                position: relative;
            }
            
            /* The Thin White Line Decoration */
            #innerLine {
                position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
                border: 2px solid rgba(255,255,255,0.7); /* Thin White Line */
                pointer-events: none; z-index: 0;
            }

            /* --- 1. GRID SCREEN --- */
            #gridContainer {
                width: 90%; height: 80%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                z-index: 2; align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.5));
                border: 3px solid #FFD700; border-radius: 10px;
                display: flex; justify-content: center; align-items: center;
                font-size: 5vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 25px rgba(0,0,0,0.5); transition: 0.3s;
            }
            .grid-box:hover { transform: scale(1.1); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; transform: scale(0); pointer-events: none; }

            /* --- 2. READING SCREEN --- */
            #readContainer { width: 100%; height: 100%; display: none; flex-direction: row; z-index: 2; }
            
            /* Sidebar */
            #sideBar {
                width: 20%; height: 100%; background: rgba(0,0,0,0.6); 
                border-left: 2px solid #FFD700;
                padding: 20px; display: flex; flex-direction: column; gap: 15px;
                backdrop-filter: blur(10px);
            }
            #sbHeader {
                color: #FFD700; font-family: 'Faruuma', sans-serif; font-size: 1.2vw;
                text-align: center; border-bottom: 1px dashed #aaa; padding-bottom: 10px;
            }
            .q-card { border: 1px solid #555; padding: 15px; border-radius: 5px; background: rgba(0,0,0,0.5); color: #ccc; }
            .q-card.active { border-color: #FFD700; background: rgba(255,215,0,0.1); color: #fff; box-shadow: 0 0 10px #FFD700; }

            /* Main Content Area */
            #mainContent { flex: 1; display: flex; justify-content: center; align-items: center; position:relative; }

            /* TEXT BOX (Resizable) */
            #royalBox {
                border: 10px double #FFD700;
                border-radius: 20px;
                padding: 30px;
                background: radial-gradient(circle, rgba(0,0,0,0.8), rgba(0,20,0,0.95));
                box-shadow: 0 0 50px rgba(0,0,0,0.8);
                display: flex; justify-content: center; align-items: center;
                overflow: hidden; 
                transition: width 0.3s, height 0.3s; /* Smooth resize */
            }
            
            #displayText {
                width: 100%; height: 100%;
                overflow-y: auto;
                text-align: center; font-weight: bold;
                line-height: 2.2; direction: rtl;
                white-space: pre-wrap; 
                display: flex; align-items: center; justify-content: center;
                transition: font-size 0.3s, transform 0.3s; /* Smooth zoom/move */
            }
            /* Scrollbar */
            #displayText::-webkit-scrollbar { width: 8px; }
            #displayText::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 4px; }
            #displayText.scroll-active { display: block; } 

            .hifz-badge { font-family: 'Faruuma', sans-serif; font-size: 4vw; color: #FFD700; text-align:center; margin:auto; }

        </style>
    </head>
    <body>
        <div id="royalWrapper">
            <div id="innerLine"></div>

            <div id="gridContainer"></div>

            <div id="readContainer">
                <div id="sideBar">
                    <div id="sbHeader"></div>
                    <div id="sideList"></div>
                </div>
                <div id="mainContent">
                    <div id="royalBox">
                        <div id="displayText"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            

            window.opener.initExtra(window);

            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer'); gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    // Stop propagation to prevent instant fullscreen toggle on grid click if needed
                    // b.onclick = (e) => { e.stopPropagation(); window.opener.extraGridClick(i); }; 
                    b.onclick = () => window.opener.extraGridClick(i);
                    gc.appendChild(b);
                }
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const box = document.getElementById('royalBox');
                const txt = document.getElementById('displayText');
                const sbHeader = document.getElementById('sbHeader');
                
                // --- 1. APPLY ADJUSTMENTS ---
                box.style.width = d.settings.boxW + '%';
                box.style.height = d.settings.boxH + '%';
                
                txt.style.fontSize = d.settings.zoom + 'vw';
                txt.style.transform = \`translate(\${d.settings.textX}px, \${d.settings.textY}px)\`;

                sbHeader.innerText = (d.settings.mode === 'hifz') ? 
                    "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞" : 
                    "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";

                // --- 2. PHASE LOGIC ---
                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid'; readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } else {
                    gridDiv.style.display = 'none'; readDiv.style.display = 'flex';
                    
                    const sl = document.getElementById('sideList'); sl.innerHTML = '';
                    d.selection.forEach((q, i) => {
                        let div = document.createElement('div');
                        div.className = 'q-card ' + (i===d.currentIdx ? 'active' : '');
                        div.innerHTML = \`<div style="font-family:'Cinzel',serif; font-size:12px; color:#FFD700">Question \${i+1}</div>
                                           <div style="font-size:16px;">\${q.surah}</div>
                                           <div style="font-size:12px; color:#aaa">Ayah: \${q.start}</div>\`;
                        sl.appendChild(div);
                    });

                    if(d.phase === 'ready') {
                        txt.className = 'hifz-badge'; txt.innerText = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        txt.style.transform = 'none'; // Reset transform for message
                    } else if(d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(d.settings.mode === 'hifz') {
                            txt.className = 'hifz-badge'; 
                            txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px;'>(Reciting from Memory)</span>";
                            txt.style.transform = 'none';
                        } else {
                            txt.className = '';
                            txt.innerText = cur.text;
                            // Check scroll
                            if(txt.scrollHeight > txt.clientHeight) txt.classList.add('scroll-active');
                            else txt.classList.remove('scroll-active');
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;
    state.extra.window = window.open("", "Extra", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    setTimeout(syncExtraScreen, 500);
}

// --- 5. LOGIC CONTROLS ---
window.initExtra = function(w) { syncExtraScreen(); }

window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return;
    const limit = parseInt(document.getElementById('exPickCount').value);
    const qData = state.extra.gridMapping[num];
    if(qData) state.extra.selection.push({ ...qData, gridNum: num });

    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready';
        document.getElementById('exMonitor').innerText = "READY TO START";
        document.getElementById('btnNextQ').disabled = false;
    }
    syncExtraScreen();
}

window.extraNextQ = function() {
    if(state.extra.phase === 'ready') { state.extra.phase = 'reading'; state.extra.currentIndex = 0; }
    else if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex < state.extra.selection.length - 1) state.extra.currentIndex++;
        else { alert("Finished!"); return; }
    }
    syncExtraScreen();
}

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
}

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    state.extra.window.updateView({
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings
    });
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V10 - ALL FEATURES) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        
    filteredPool: [],   
    uniqueJuz: [],      
    uniqueSurah: [],    
    gridMapping: {},    
    selection: [],      
    currentIndex: -1,   
    phase: 'idle',      
    settings: {
        zoom: 6, boxW: 90, boxH: 80, textX: 0, textY: 0,
        mode: 'tilawa', theme: 'green_1', textColor: '#ffffff'
    },
    window: null
};

// --- 1. THEME ENGINE (50 STYLES GENERATOR) ---
function getRoyalThemeCSS(themeID) {
    let css = "";
    
    // Base Colors
    const colors = {
        green: { bg1: "#002200", bg2: "#000000", border: "#FFD700" },
        blue: { bg1: "#001a33", bg2: "#000000", border: "#C0C0C0" },
        red: { bg1: "#330000", bg2: "#1a0000", border: "#FFD700" },
        black: { bg1: "#111111", bg2: "#000000", border: "#D4AF37" },
        mix: { bg1: "#1a0033", bg2: "#000000", border: "#FFD700" }
    };

    // Parse ID (e.g. "green_1")
    const parts = themeID.split('_');
    const cat = parts[0];
    const num = parseInt(parts[1]);
    const c = colors[cat] || colors.green;

    // Define border style based on number
    let borderStyle = "double";
    let borderWidth = "10px";
    let borderRadius = "20px";
    let shadow = "0 0 30px rgba(0,0,0,0.8)";

    if (num === 1) { borderStyle = "double"; borderWidth = "15px"; }
    if (num === 2) { borderStyle = "solid"; borderWidth = "5px"; borderRadius = "30px"; }
    if (num === 3) { borderStyle = "groove"; borderWidth = "20px"; borderRadius = "0px"; } // Pattern/Square
    if (num === 4) { borderStyle = "ridge"; borderWidth = "10px"; borderRadius = "10px"; }
    if (num === 5) { borderStyle = "solid"; borderWidth = "3px"; shadow = "0 0 20px " + c.border; } // Glow
    if (num === 6) { borderStyle = "inset"; borderWidth = "15px"; borderRadius = "50px"; }
    if (num === 7) { borderStyle = "outset"; borderWidth = "10px"; }
    if (num === 8) { borderStyle = "double"; borderWidth = "8px"; borderRadius = "0px"; } // Square
    if (num === 9) { borderStyle = "solid"; borderWidth = "1px"; shadow = "inset 0 0 50px #000"; }
    if (num === 10) { borderStyle = "dotted"; borderWidth = "5px"; borderRadius = "15px"; }

    // Override colors for Mix category
    let bg = `radial-gradient(circle, ${c.bg1}, ${c.bg2})`;
    if(cat === 'mix') {
        if(num===1) bg = "linear-gradient(135deg, #4a148c, #000)";
        if(num===2) { bg = "#f5f5f5"; c.border = "#D4AF37"; } // White Gold
        if(num===3) bg = "linear-gradient(#5d4037, #000)"; // Bronze
        if(num===10) bg = "rgba(255,255,255,0.1)"; // Glass
    }

    css = `
        background: ${bg};
        border: ${borderWidth} ${borderStyle} ${c.border};
        border-radius: ${borderRadius};
        box-shadow: ${shadow};
    `;
    
    // Auto text color adjustment for light themes
    let txtColor = state.extra.settings.textColor;
    if(cat === 'mix' && num === 2 && txtColor === '#ffffff') {
        // If theme is white and text is white, suggest black (logic handled in view)
    }

    return { box: css };
}

// --- 2. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        const juzSet = new Set();
        const surahSet = new Set();
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                const item = {
                    id: parseInt(clean[0]),
                    juz: parseInt(clean[1]),
                    page: clean[2],
                    surah: clean[3],
                    start: clean[4],
                    end: clean[5],
                    text: clean[6]
                };
                state.extra.allData.push(item);
                if(!isNaN(item.juz)) juzSet.add(item.juz);
                if(item.surah) surahSet.add(item.surah);
            }
        }
        state.extra.uniqueJuz = Array.from(juzSet).sort((a,b)=>a-b);
        state.extra.uniqueSurah = Array.from(surahSet);
        
        populateDropdown('startJuz', state.extra.uniqueJuz);
        populateDropdown('endJuz', state.extra.uniqueJuz);
        populateDropdown('startSurah', state.extra.uniqueSurah);
        populateDropdown('endSurah', state.extra.uniqueSurah);

        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs.`;
    };
    r.readAsText(file);
}

function toggleFilterUI() {
    const type = document.getElementById('filterType').value;
    document.getElementById('divJuzSelect').style.display = (type === 'juz') ? 'grid' : 'none';
    document.getElementById('divSurahSelect').style.display = (type === 'surah') ? 'grid' : 'none';
}

function populateDropdown(id, list) {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    list.forEach(item => {
        let opt = document.createElement('option');
        opt.value = item; opt.text = item;
        sel.appendChild(opt);
    });
    if(id.startsWith('end') && list.length > 0) sel.value = list[list.length-1];
}

// --- 3. RESET & FILTER LOGIC ---
function resetExtraSession() {
    if(state.extra.allData.length === 0) { alert("Load CSV first!"); return; }
    
    const type = document.getElementById('filterType').value;
    if(type === 'juz') {
        const s = parseInt(document.getElementById('startJuz').value);
        const e = parseInt(document.getElementById('endJuz').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.juz >= s && q.juz <= e);
    } else {
        const s = document.getElementById('startSurah').value;
        const e = document.getElementById('endSurah').value;
        const sIdx = state.extra.uniqueSurah.indexOf(s);
        const eIdx = state.extra.uniqueSurah.indexOf(e);
        if(sIdx > -1 && eIdx > -1) {
            const valid = state.extra.uniqueSurah.slice(Math.min(sIdx, eIdx), Math.max(sIdx, eIdx)+1);
            state.extra.filteredPool = state.extra.allData.filter(q => valid.includes(q.surah));
        }
    }

    if(state.extra.filteredPool.length === 0) { 
        document.getElementById('exMonitor').innerText = "Empty Filter!"; return; 
    }

    // Grid Setup
    state.extra.gridMapping = {};
    let temp = [...state.extra.filteredPool];
    for(let i=1; i<=20; i++) {
        if(temp.length > 0) {
            const r = Math.floor(Math.random() * temp.length);
            state.extra.gridMapping[i] = temp[r];
            temp.splice(r, 1);
        } else {
            const r = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[r];
        }
    }

    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = `Grid Ready (${state.extra.filteredPool.length} Qs)`;
    document.getElementById('btnNextQ').disabled = true;
    syncExtraScreen();
}

// --- 4. OPEN SCREEN (THIN BORDER & CLICK FULLSCREEN) ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
                cursor: pointer;
            }

            /* --- MAIN BORDER CONTAINER (THIN GOLD) --- */
            #royalWrapper {
                width: 100vw; height: 100vh;
                background: #002200; /* Dark Green Base */
                border: 3px solid #FFD700; /* THIN GOLD BORDER */
                box-sizing: border-box;
                display: flex; align-items: center; justify-content: center;
                position: relative;
            }
            
            /* DECORATIVE INNER LINE */
            #innerLine {
                position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
                border: 1px solid rgba(255,255,255,0.5); /* Thin White Line */
                pointer-events: none; z-index: 0;
            }

            /* --- 1. GRID SCREEN --- */
            #gridContainer {
                width: 90%; height: 80%;
                display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                z-index: 2; align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.5));
                border: 2px solid #FFD700; border-radius: 10px;
                display: flex; justify-content: center; align-items: center;
                font-size: 5vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                box-shadow: 0 0 25px rgba(0,0,0,0.5); transition: 0.3s;
            }
            .grid-box:hover { transform: scale(1.1); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; transform: scale(0); pointer-events: none; }

            /* --- 2. READING SCREEN --- */
            #readContainer { width: 100%; height: 100%; display: none; flex-direction: row; z-index: 2; }
            
            #sideBar {
                width: 25%; height: 100%; background: rgba(0,0,0,0.8); 
                border-left: 2px solid #FFD700;
                padding: 20px; display: flex; flex-direction: column; gap: 15px;
                backdrop-filter: blur(10px);
            }
            #sbHeader {
                color: #FFD700; font-family: 'Faruuma', sans-serif; font-size: 1.5vw;
                text-align: center; border-bottom: 1px dashed #aaa; padding-bottom: 10px;
            }
            .q-card { border: 1px solid #555; padding: 15px; border-radius: 5px; background: rgba(0,0,0,0.5); color: #ccc; }
            .q-card.active { border-color: #FFD700; background: rgba(255,215,0,0.1); color: #fff; box-shadow: 0 0 10px #FFD700; }

            #mainContent { flex: 1; display: flex; justify-content: center; align-items: center; position:relative; }

            /* ROYAL BOX (Uses Theme) */
            #royalBox {
                padding: 30px;
                display: flex; justify-content: center; align-items: center;
                overflow: hidden; 
                transition: width 0.3s, height 0.3s;
            }
            
            #displayText {
                width: 100%; height: 100%;
                overflow-y: auto;
                text-align: center; font-weight: bold;
                line-height: 2.2; direction: rtl;
                white-space: pre-wrap; 
                display: flex; align-items: center; justify-content: center;
                transition: font-size 0.3s, color 0.3s, transform 0.3s;
            }
            #displayText::-webkit-scrollbar { width: 8px; }
            #displayText::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 4px; }
            #displayText.scroll-active { display: block; } 

            .hifz-badge { font-family: 'Faruuma', sans-serif; font-size: 4vw; color: #FFD700; text-align:center; margin:auto; }

        </style>
    </head>
    <body>
        <div id="royalWrapper">
            <div id="innerLine"></div>

            <div id="gridContainer"></div>

            <div id="readContainer">
                <div id="sideBar">
                    <div id="sbHeader"></div>
                    <div id="sideList"></div>
                </div>
                <div id="mainContent">
                    <div id="royalBox">
                        <div id="displayText"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        

            window.opener.initExtra(window);

            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer'); gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    b.onclick = () => window.opener.extraGridClick(i);
                    gc.appendChild(b);
                }
            }

            function applyTheme(css, txtCol) {
                const box = document.getElementById('royalBox');
                box.style.cssText = css; // Apply Theme CSS
                // Re-apply current dimensions from slider to override theme if needed, or theme adapts
                // But better to update box style properties directly
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const box = document.getElementById('royalBox');
                const txt = document.getElementById('displayText');
                const sbHeader = document.getElementById('sbHeader');
                
                // --- 1. APPLY ADJUSTMENTS ---
                box.style.width = d.settings.boxW + '%';
                box.style.height = d.settings.boxH + '%';
                
                // Text Settings
                txt.style.color = d.settings.textColor;
                txt.style.fontSize = d.settings.zoom + 'vw';
                txt.style.transform = \`translate(\${d.settings.textX}px, \${d.settings.textY}px)\`;

                sbHeader.innerText = (d.settings.mode === 'hifz') ? 
                    "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞" : 
                    "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";

                // --- 2. PHASE LOGIC ---
                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid'; readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } else {
                    gridDiv.style.display = 'none'; readDiv.style.display = 'flex';
                    
                    const sl = document.getElementById('sideList'); sl.innerHTML = '';
                    d.selection.forEach((q, i) => {
                        let div = document.createElement('div');
                        div.className = 'q-card ' + (i===d.currentIdx ? 'active' : '');
                        div.innerHTML = \`<div style="font-family:'Cinzel',serif; font-size:12px; color:#FFD700">Question \${i+1}</div>
                                           <div style="font-size:16px;">\${q.surah}</div>
                                           <div style="font-size:12px; color:#aaa">Ayah: \${q.start}</div>\`;
                        sl.appendChild(div);
                    });

                    // THEME APPLICATION
                    if(d.themeData) {
                        // Apply background/border/shadow from theme
                        // We must preserve width/height which are inline styles
                        // So we parse themeData.box and set properties individually or append
                        const currentW = box.style.width;
                        const currentH = box.style.height;
                        box.style.cssText = d.themeData.box;
                        box.style.width = currentW;
                        box.style.height = currentH;
                    }

                    if(d.phase === 'ready') {
                        txt.className = 'hifz-badge'; txt.innerText = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        txt.style.transform = 'none'; // Reset transform for message
                        txt.style.color = '#FFD700';
                        box.style.border = 'none'; box.style.background = 'transparent'; box.style.boxShadow = 'none';
                    } else if(d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(d.settings.mode === 'hifz') {
                            txt.className = 'hifz-badge'; 
                            txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px;'>(Reciting from Memory)</span>";
                            txt.style.transform = 'none';
                            txt.style.color = '#FFD700';
                        } else {
                            txt.className = '';
                            txt.innerText = cur.text;
                            txt.style.color = d.settings.textColor;
                            
                            // Scroll Check
                            if(txt.scrollHeight > txt.clientHeight) txt.classList.add('scroll-active');
                            else txt.classList.remove('scroll-active');
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;
    state.extra.window = window.open("", "Extra", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    setTimeout(syncExtraScreen, 500);
}

// --- 5. LOGIC CONTROLS ---
window.initExtra = function(w) { syncExtraScreen(); }

window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return;
    
    // Get limit from INPUT
    const limit = parseInt(document.getElementById('exPickCount').value) || 3;
    
    const qData = state.extra.gridMapping[num];
    if(qData) state.extra.selection.push({ ...qData, gridNum: num });

    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready';
        document.getElementById('exMonitor').innerText = "READY TO START";
        document.getElementById('btnNextQ').disabled = false;
    }
    syncExtraScreen();
}

window.extraNextQ = function() {
    if(state.extra.phase === 'ready') { state.extra.phase = 'reading'; state.extra.currentIndex = 0; }
    else if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex < state.extra.selection.length - 1) state.extra.currentIndex++;
        else { alert("Finished!"); return; }
    }
    syncExtraScreen();
}

window.updateExtraScreen = function(key, val) {
    state.extra.settings[key] = val;
    syncExtraScreen();
}

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    // Generate Theme CSS on the fly
    const themeData = getRoyalThemeCSS(state.extra.settings.theme);
    
    state.extra.window.updateView({
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings,
        themeData: themeData
    });
}
    // ========================================================
// ‚òÖ ULTIMATE EXTRA SCREEN LOGIC (V12 - COMPLETE) ‚òÖ
// ========================================================

state.extra = {
    allData: [],        
    filteredPool: [],   
    gridMapping: {},    
    selection: [],      
    currentIndex: -1,   
    phase: 'idle',      
    settings: {
        zoom: 6, boxW: 90, boxH: 80, textX: 0, textY: 0,
        mode: 'tilawa', theme: 'green_1', textColor: '#ffffff'
    },
    window: null
};

// --- 1. SURAH DATA (1-114) ---
const SURAH_LIST_FULL = [
    "Al-Fatiha", "Al-Baqarah", "Aali Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
    "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha",
    "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum",
    "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
    "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
    "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah",
    "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
    "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa",
    "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad",
    "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat",
    "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr",
    "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
];

// --- 2. DROPDOWN INITIALIZER ---
function initExtraDropdowns() {
    // Populate Juz 1-30
    const startJ = document.getElementById('startJuz');
    const endJ = document.getElementById('endJuz');
    startJ.innerHTML = ''; endJ.innerHTML = '';
    
    for(let i=1; i<=30; i++) {
        let opt = new Option(`Juz ${i}`, i);
        startJ.add(opt);
        endJ.add(opt.cloneNode(true));
    }
    endJ.value = 30; // Default

    // Populate Surah 1-114
    const startS = document.getElementById('startSurah');
    const endS = document.getElementById('endSurah');
    startS.innerHTML = ''; endS.innerHTML = '';

    SURAH_LIST_FULL.forEach((name, idx) => {
        let val = idx + 1;
        let txt = `${val}. ${name}`;
        let opt = new Option(txt, val);
        startS.add(opt);
        endS.add(opt.cloneNode(true));
    });
    endS.value = 114;
}

// Call init immediately
window.addEventListener('DOMContentLoaded', initExtraDropdowns);

// --- 3. THEME ENGINE (50 THEMES) ---
function getRoyalThemeCSS(themeID) {
    let css = "";
    
    // Base Colors
    const colors = {
        green: { bg1: "#002200", bg2: "#000000", border: "#FFD700" },
        blue: { bg1: "#001a33", bg2: "#000000", border: "#C0C0C0" },
        red: { bg1: "#330000", bg2: "#1a0000", border: "#FFD700" },
        black: { bg1: "#111111", bg2: "#000000", border: "#D4AF37" },
        mix: { bg1: "#1a0033", bg2: "#000000", border: "#FFD700" }
    };

    const parts = themeID.split('_');
    const cat = parts[0];
    const num = parseInt(parts[1]);
    const c = colors[cat] || colors.green;

    let borderStyle = "double";
    let borderWidth = "10px";
    let borderRadius = "20px";
    let shadow = "0 0 30px rgba(0,0,0,0.8)";

    if (num === 1) { borderStyle = "double"; borderWidth = "15px"; }
    if (num === 2) { borderStyle = "solid"; borderWidth = "5px"; borderRadius = "30px"; }
    if (num === 3) { borderStyle = "groove"; borderWidth = "20px"; borderRadius = "0px"; }
    if (num === 4) { borderStyle = "ridge"; borderWidth = "10px"; borderRadius = "10px"; }
    if (num === 5) { borderStyle = "solid"; borderWidth = "3px"; shadow = "0 0 20px " + c.border; }
    if (num === 6) { borderStyle = "inset"; borderWidth = "15px"; borderRadius = "50px"; }
    if (num === 7) { borderStyle = "outset"; borderWidth = "10px"; }
    if (num === 8) { borderStyle = "double"; borderWidth = "8px"; borderRadius = "0px"; }
    if (num === 9) { borderStyle = "solid"; borderWidth = "1px"; shadow = "inset 0 0 50px #000"; }
    if (num === 10) { borderStyle = "dotted"; borderWidth = "5px"; borderRadius = "15px"; }

    let bg = `radial-gradient(circle, ${c.bg1}, ${c.bg2})`;
    if(cat === 'mix') {
        if(num===1) bg = "linear-gradient(135deg, #4a148c, #000)";
        if(num===2) { bg = "#f5f5f5"; c.border = "#D4AF37"; } 
        if(num===3) bg = "linear-gradient(#5d4037, #000)"; 
        if(num===10) bg = "rgba(255,255,255,0.1)"; 
    }

    css = `background: ${bg}; border: ${borderWidth} ${borderStyle} ${c.border}; border-radius: ${borderRadius}; box-shadow: ${shadow};`;
    return { box: css };
}

// --- 4. CSV LOADER ---
function loadExtraCSV(input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.extra.allData = [];
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 7) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                
                // Map Surah Name to ID
                let sId = 0;
                let sName = clean[3];
                let foundIdx = SURAH_LIST_FULL.findIndex(s => s.toLowerCase() === sName.toLowerCase());
                if(foundIdx > -1) sId = foundIdx + 1;
                else sId = parseInt(sName) || 0;

                state.extra.allData.push({
                    id: parseInt(clean[0]),
                    juz: parseInt(clean[1]),
                    page: clean[2],
                    surah: sName,
                    surahId: sId,
                    start: clean[4],
                    end: clean[5],
                    text: clean[6]
                });
            }
        }
        document.getElementById('extraStatus').innerText = `‚úÖ Loaded ${state.extra.allData.length} Qs.`;
        // Refresh dropdowns just in case
        initExtraDropdowns();
    };
    r.readAsText(file);
}

// --- 5. UI TOGGLE ---
function toggleFilterUI() {
    const type = document.getElementById('filterType').value;
    document.getElementById('divJuzSelect').style.display = (type === 'juz') ? 'grid' : 'none';
    document.getElementById('divSurahSelect').style.display = (type === 'surah') ? 'grid' : 'none';
}

// --- 6. RESET & FILTER ---
function resetExtraSession() {
    if(state.extra.allData.length === 0) { alert("Please load CSV first!"); return; }
    
    const type = document.getElementById('filterType').value;
    
    if(type === 'juz') {
        const s = parseInt(document.getElementById('startJuz').value);
        const e = parseInt(document.getElementById('endJuz').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.juz >= s && q.juz <= e);
    } else {
        const s = parseInt(document.getElementById('startSurah').value);
        const e = parseInt(document.getElementById('endSurah').value);
        state.extra.filteredPool = state.extra.allData.filter(q => q.surahId >= s && q.surahId <= e);
    }

    if(state.extra.filteredPool.length === 0) { 
        document.getElementById('exMonitor').innerText = "‚ö†Ô∏è No Questions in Range!"; 
        return; 
    }

    // Generate 20 Grid Boxes
    state.extra.gridMapping = {};
    let temp = [...state.extra.filteredPool];
    for(let i=1; i<=20; i++) {
        if(temp.length > 0) {
            const r = Math.floor(Math.random() * temp.length);
            state.extra.gridMapping[i] = temp[r];
            temp.splice(r, 1);
        } else {
            const r = Math.floor(Math.random() * state.extra.filteredPool.length);
            state.extra.gridMapping[i] = state.extra.filteredPool[r];
        }
    }

    state.extra.selection = [];
    state.extra.currentIndex = -1;
    state.extra.phase = 'grid';
    state.extra.settings.mode = document.getElementById('exMode').value;
    
    document.getElementById('exMonitor').innerText = `Grid Ready (${state.extra.filteredPool.length} Qs)`;
    syncExtraScreen();
}

// --- 7. OPEN SCREEN (FULLSCREEN CLICK & THIN BORDER) ---
function openExtraScreen() {
    if(state.extra.window) state.extra.window.close();
    
    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;
    
    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Student Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; background: #000;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
                cursor: pointer;
            }

            /* --- OUTER BORDER (THIN GOLD) --- */
            #royalWrapper {
                width: 100vw; height: 100vh;
                background: #002200; /* Dark Green Base */
                border: 3px solid #FFD700; /* THIN GOLD BORDER */
                box-sizing: border-box;
                display: flex; align-items: center; justify-content: center;
                position: relative;
            }
            
            #innerLine {
                position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
                border: 1px solid rgba(255,255,255,0.5); pointer-events: none; z-index: 0;
            }

            #gridContainer {
                width: 90%; height: 80%; display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; 
                z-index: 2; align-content: center;
            }
            .grid-box {
                background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.5));
                border: 2px solid #FFD700; border-radius: 10px;
                display: flex; justify-content: center; align-items: center;
                font-size: 5vw; color: #FFD700; cursor: pointer;
                font-family: 'Cinzel', serif; font-weight: bold;
                transition: 0.3s;
            }
            .grid-box:hover { transform: scale(1.1); background: #FFD700; color: #000; }
            .grid-box.taken { opacity: 0; transform: scale(0); pointer-events: none; }

            #readContainer { width: 100%; height: 100%; display: none; flex-direction: row; z-index: 2; }
            
            #sideBar {
                width: 25%; height: 100%; background: rgba(0,0,0,0.8); 
                border-left: 2px solid #FFD700; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            }
            #sbHeader { color: #FFD700; font-family: 'Faruuma', sans-serif; font-size: 1.5vw; text-align: center; border-bottom: 1px dashed #aaa; padding-bottom: 10px; }
            .q-card { border: 1px solid #555; padding: 15px; border-radius: 5px; background: rgba(0,0,0,0.5); color: #ccc; }
            .q-card.active { border-color: #FFD700; background: rgba(255,215,0,0.1); color: #fff; }

            #mainContent { flex: 1; display: flex; justify-content: center; align-items: center; position:relative; }
            
            /* ROYAL BOX (Uses Theme CSS) */
            #royalBox {
                padding: 30px; display: flex; justify-content: center; align-items: center;
                overflow: hidden; transition: all 0.3s;
            }
            
            #displayText {
                width: 100%; height: 100%; overflow-y: auto;
                text-align: center; font-weight: bold;
                line-height: 2.2; direction: rtl;
                white-space: pre-wrap; 
                display: flex; align-items: center; justify-content: center;
                transition: font-size 0.3s, color 0.3s, transform 0.3s;
            }
            #displayText::-webkit-scrollbar { width: 8px; }
            #displayText::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 4px; }
            #displayText.scroll-active { display: block; } 

            .hifz-badge { font-family: 'Faruuma', sans-serif; font-size: 4vw; color: #FFD700; text-align:center; margin:auto; }

        </style>
    </head>
    <body>
        <div id="royalWrapper">
            <div id="innerLine"></div>
            <div id="gridContainer"></div>
            <div id="readContainer">
                <div id="sideBar"><div id="sbHeader"></div><div id="sideList"></div></div>
                <div id="mainContent"><div id="royalBox"><div id="displayText"></div></div></div>
            </div>
        </div>
        <script>
            
            window.opener.initExtra(window);

            function renderGrid(taken) {
                const gc = document.getElementById('gridContainer'); gc.innerHTML = '';
                for(let i=1; i<=20; i++) {
                    let b = document.createElement('div');
                    b.className = 'grid-box ' + (taken.includes(i) ? 'taken' : '');
                    b.innerText = i;
                    b.onclick = () => window.opener.extraGridClick(i);
                    gc.appendChild(b);
                }
            }

            function updateView(d) {
                const gridDiv = document.getElementById('gridContainer');
                const readDiv = document.getElementById('readContainer');
                const box = document.getElementById('royalBox');
                const txt = document.getElementById('displayText');
                const sbHeader = document.getElementById('sbHeader');
                
                box.style.width = d.settings.boxW + '%';
                box.style.height = d.settings.boxH + '%';
                
                txt.style.color = d.settings.textColor;
                txt.style.fontSize = d.settings.zoom + 'vw';
                txt.style.transform = \`translate(\${d.settings.textX}px, \${d.settings.textY}px)\`;

                sbHeader.innerText = (d.settings.mode === 'hifz') ? 
                    "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞" : 
                    "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁåﬁ¶ﬁáﬁ∞";

                if (d.phase === 'grid') {
                    gridDiv.style.display = 'grid'; readDiv.style.display = 'none';
                    renderGrid(d.taken);
                } else {
                    gridDiv.style.display = 'none'; readDiv.style.display = 'flex';
                    
                    const sl = document.getElementById('sideList'); sl.innerHTML = '';
                    d.selection.forEach((q, i) => {
                        let div = document.createElement('div');
                        div.className = 'q-card ' + (i===d.currentIdx ? 'active' : '');
                        div.innerHTML = \`<div style="font-family:'Cinzel',serif; font-size:12px; color:#FFD700">Question \${i+1}</div>
                                           <div style="font-size:16px;">\${q.surah}</div>
                                           <div style="font-size:12px; color:#aaa">Ayah: \${q.start}</div>\`;
                        sl.appendChild(div);
                    });

                    // APPLY THEME CSS
                    if(d.themeData) {
                        const cw = box.style.width; const ch = box.style.height;
                        box.style.cssText = d.themeData.box;
                        box.style.width = cw; box.style.height = ch;
                    }

                    if(d.phase === 'ready') {
                        txt.className = 'hifz-badge'; txt.innerText = "ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß";
                        txt.style.transform = 'none'; txt.style.color = '#FFD700';
                        box.style.border = 'none'; box.style.background = 'transparent'; box.style.boxShadow = 'none';
                    } else if(d.phase === 'reading') {
                        const cur = d.selection[d.currentIdx];
                        if(d.settings.mode === 'hifz') {
                            txt.className = 'hifz-badge'; 
                            txt.innerHTML = "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®<br><span style='font-size:20px;'>(Reciting from Memory)</span>";
                            txt.style.transform = 'none'; txt.style.color = '#FFD700';
                        } else {
                            txt.className = '';
                            txt.innerText = cur.text;
                            txt.style.color = d.settings.textColor;
                            if(txt.scrollHeight > txt.clientHeight) txt.classList.add('scroll-active');
                            else txt.classList.remove('scroll-active');
                        }
                    }
                }
            }
        <\/script>
    </body>
    </html>`;
    state.extra.window = window.open("", "Extra", "width=1280,height=720");
    state.extra.window.document.write(html);
    state.extra.window.document.close();
    setTimeout(syncExtraScreen, 500);
}

// --- 8. CONTROLS (NAVIGATION) ---
window.initExtra = function(w) { 
    initExtraDropdowns(); // Ensure dropdowns populated on init
    syncExtraScreen(); 
}

window.extraGridClick = function(num) {
    if(state.extra.phase !== 'grid') return;
    if(state.extra.selection.some(s => s.gridNum === num)) return;
    
    const limit = parseInt(document.getElementById('exPickCount').value) || 3;
    const qData = state.extra.gridMapping[num];
    if(qData) state.extra.selection.push({ ...qData, gridNum: num });

    if(state.extra.selection.length >= limit) {
        state.extra.phase = 'ready';
        document.getElementById('exMonitor').innerText = "READY TO START";
    }
    syncExtraScreen();
}

// NEXT BUTTON
window.extraNextQ = function() {
    if(state.extra.phase === 'ready') { state.extra.phase = 'reading'; state.extra.currentIndex = 0; }
    else if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex < state.extra.selection.length - 1) state.extra.currentIndex++;
        else { alert("Finished!"); return; }
    }
    updateMonitor(); syncExtraScreen();
}

// PREV BUTTON
window.extraPrevQ = function() {
    if(state.extra.phase === 'reading') {
        if(state.extra.currentIndex > 0) {
            state.extra.currentIndex--;
        } else {
            // Go back to ready
            state.extra.phase = 'ready';
            state.extra.currentIndex = -1;
        }
    }
    updateMonitor(); syncExtraScreen();
}

function updateMonitor() {
    if(state.extra.currentIndex > -1) {
        const q = state.extra.selection[state.extra.currentIndex];
        document.getElementById('exMonitor').innerText = `Active: Q${state.extra.currentIndex + 1} - ${q.surah}`;
    }
}

window.updateExtraScreen = function(key, val) { 
    state.extra.settings[key] = val; 
    syncExtraScreen(); 
}

function syncExtraScreen() {
    if(!state.extra.window || state.extra.window.closed) return;
    const themeData = getRoyalThemeCSS(state.extra.settings.theme);
    state.extra.window.updateView({
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings,
        themeData: themeData
    });
}
    // --- NEW: JUDGE MIRROR SCREEN LOGIC ---

// 1. Open Judge Screen Function
function openJudgeMirror() {
    if(state.extra.judgeWindow) state.extra.judgeWindow.close();

    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;

    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Judge Mirror Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; background: #1a1a1a;
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }
            
            /* HEADER BAR */
            #judgeHeader {
                position: absolute; top: 0; width: 100%; height: 60px;
                background: linear-gradient(90deg, #330033, #000);
                border-bottom: 3px solid #d500f9;
                display: flex; justify-content: space-between; align-items: center;
                padding: 0 20px; box-sizing: border-box; color: #fff; font-family: sans-serif;
                z-index: 10;
            }
            .judge-badge {
                background: #d500f9; color: #fff; padding: 5px 15px; 
                border-radius: 4px; font-weight: bold; font-size: 14px;
            }

            /* LAYOUT */
            #container {
                display: flex; width: 100%; height: 100%; padding-top: 60px; box-sizing: border-box;
            }
            
            /* SIDEBAR (List) */
            #sidePanel {
                width: 20%; background: #222; border-left: 1px solid #444;
                padding: 10px; overflow-y: auto;
            }
            .q-item {
                background: #333; padding: 10px; margin-bottom: 8px; border-radius: 4px;
                color: #ccc; font-size: 14px; cursor: default;
            }
            .q-item.active {
                background: #4a148c; color: #fff; border: 1px solid #d500f9;
            }

            /* MAIN VIEW */
            #mainView {
                flex: 1; display: flex; flex-direction: column; 
                justify-content: center; align-items: center; 
                background: #fff; color: #000; padding: 40px; text-align: center;
            }
            
            #quranText {
                font-size: 3vw; line-height: 2.2; font-weight: bold; width: 90%;
                direction: rtl; white-space: pre-wrap;
            }
            
            #infoBar {
                margin-bottom: 20px; font-size: 18px; color: #555; 
                background: #eee; padding: 10px 30px; border-radius: 20px;
                border: 1px solid #ccc;
            }

            /* STATUS OVERLAY */
            #statusOverlay {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); color: #d500f9;
                display: flex; justify-content: center; align-items: center;
                font-size: 30px; font-weight: bold; z-index: 5;
            }

        </style>
    </head>
    <body>
        <div id="judgeHeader">
            <div class="judge-badge">JUDGE VIEW (ALWAYS VISIBLE)</div>
            <div id="modeIndicator" style="color:#aaa;">-</div>
        </div>

        <div id="statusOverlay">WAITING FOR SELECTION...</div>

        <div id="container">
            <div id="sidePanel"></div>
            <div id="mainView">
                <div id="infoBar">
                    <span id="jSurah">-</span> | Ayah: <span id="jAyah">-</span> | Juz: <span id="jJuz">-</span>
                </div>
                <div id="quranText"></div>
            </div>
        </div>

        <script>
            window.opener.initExtra(window); // Sync immediately

            function updateView(d) {
                const overlay = document.getElementById('statusOverlay');
                const sidePanel = document.getElementById('sidePanel');
                const qText = document.getElementById('quranText');
                const modeInd = document.getElementById('modeIndicator');

                // Update Mode Indicator
                const modeText = (d.settings.mode === 'hifz') ? "HIFZ MODE (Student sees hidden text)" : "TILAWA MODE";
                modeInd.innerText = modeText;
                modeInd.style.color = (d.settings.mode === 'hifz') ? "#ff5252" : "#00e676";

                // Phase Logic
                if (d.phase === 'grid') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "STUDENT SELECTING QUESTIONS...";
                } 
                else if (d.phase === 'ready') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "READY TO START";
                    renderSideList(d);
                }
                else if (d.phase === 'reading') {
                    overlay.style.display = 'none';
                    renderSideList(d);
                    
                    const cur = d.selection[d.currentIdx];
                    if(cur) {
                        // ALWAYS SHOW TEXT (Even if Hifz)
                        qText.innerText = cur.text;
                        
                        document.getElementById('jSurah').innerText = cur.surah;
                        document.getElementById('jAyah').innerText = cur.start + '-' + cur.end;
                        document.getElementById('jJuz').innerText = cur.juz;
                    }
                }
            }

            function renderSideList(d) {
                const sp = document.getElementById('sidePanel');
                sp.innerHTML = '';
                d.selection.forEach((q, i) => {
                    let div = document.createElement('div');
                    div.className = 'q-item ' + (i === d.currentIdx ? 'active' : '');
                    div.innerText = \`Q\${i+1}: \${q.surah} (\${q.start})\`;
                    sp.appendChild(div);
                });
            }
        <\/script>
    </body>
    </html>`;

    state.extra.judgeWindow = window.open("", "JudgeMirror", "width=1000,height=700");
    state.extra.judgeWindow.document.write(html);
    state.extra.judgeWindow.document.close();
    
    // Slight delay to ensure window loads before sync
    setTimeout(syncExtraScreen, 500);
}

// 2. UPDATED SYNC FUNCTION (To update both screens)
function syncExtraScreen() {
    // Generate Theme CSS for Student
    const themeData = getRoyalThemeCSS(state.extra.settings.theme);
    
    const packet = {
        phase: state.extra.phase,
        selection: state.extra.selection,
        currentIdx: state.extra.currentIndex,
        taken: state.extra.selection.map(s => s.gridNum),
        settings: state.extra.settings,
        themeData: themeData
    };

    // Update Student Screen
    if(state.extra.window && !state.extra.window.closed) {
        state.extra.window.updateView(packet);
    }

    // Update Judge Screen
    if(state.extra.judgeWindow && !state.extra.judgeWindow.closed) {
        state.extra.judgeWindow.updateView(packet);
    }
}
    // ========================================================
// ‚òÖ NEW ROYAL JUDGE SCREEN (BLUE THEME) ‚òÖ
// ========================================================

function openJudgeMirror() {
    if(state.extra.judgeWindow) state.extra.judgeWindow.close();

    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;

    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Judge Royal Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; 
                background: radial-gradient(circle at center, #001a33, #000510); /* Royal Dark Blue */
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
            }
            
            /* HEADER BAR */
            #judgeHeader {
                position: absolute; top: 0; width: 100%; height: 60px;
                background: rgba(0,0,0,0.6);
                border-bottom: 1px solid #ffffff;
                display: flex; justify-content: space-between; align-items: center;
                padding: 0 20px; box-sizing: border-box; color: #fff; 
                z-index: 10; backdrop-filter: blur(5px);
            }
            .judge-badge {
                background: #fff; color: #001a33; padding: 5px 15px; 
                border-radius: 4px; font-weight: bold; font-size: 14px; font-family: sans-serif;
            }

            /* LAYOUT CONTAINER */
            #container {
                display: flex; width: 100%; height: 100%; padding-top: 60px; box-sizing: border-box;
            }
            
            /* SIDEBAR (List) */
            #sidePanel {
                width: 20%; background: rgba(0,0,0,0.3); border-left: 1px solid #444;
                padding: 10px; overflow-y: auto;
            }
            .q-item {
                background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px; border-radius: 4px;
                color: #ccc; font-size: 14px; cursor: default; border: 1px solid transparent;
            }
            .q-item.active {
                background: #004080; color: #fff; border-color: #fff; font-weight:bold;
            }

            /* MAIN VIEW AREA */
            #mainView {
                flex: 1; display: flex; flex-direction: column; 
                justify-content: center; align-items: center; 
                padding: 30px; position: relative;
            }
            
            /* INFO BAR (Top of Text) */
            #infoBar {
                margin-bottom: 15px; font-size: 16px; color: #b3e5fc; 
                font-family: 'Cinzel', serif; letter-spacing: 1px;
                text-shadow: 0 2px 4px #000;
            }

            /* --- ROYAL WHITE BORDER BOX --- */
            #judgeBox {
                width: 85%; height: 75%;
                border: 6px double #ffffff; /* Royal White Border */
                border-radius: 15px;
                padding: 30px;
                background: rgba(255,255,255,0.02); /* Very subtle fill */
                box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                position: relative;
            }

            /* CORNER DECORATION */
            #judgeBox::after {
                content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
                border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; pointer-events: none;
            }

            /* QURAN TEXT STYLING */
            #quranText {
                width: 100%; height: 100%;
                overflow-y: auto; /* Allow Scrolling */
                color: #ffffff;
                font-size: 3.5vw; 
                line-height: 2.2; 
                font-weight: bold; 
                text-align: center;
                direction: rtl; 
                white-space: pre-wrap;
                text-shadow: 0 2px 5px #000;
                
                /* CENTERING TRICK */
                display: flex; 
                flex-direction: column;
                align-items: center; 
                /* Justify center only if content is short, else top */
            }
            
            /* Scrollbar Styling for Blue Theme */
            #quranText::-webkit-scrollbar { width: 10px; }
            #quranText::-webkit-scrollbar-track { background: #001a33; }
            #quranText::-webkit-scrollbar-thumb { background: #fff; border-radius: 5px; }

            /* To allow centering when short, but scrolling when long */
            #quranText.center-content { justify-content: center; }
            #quranText.top-content { justify-content: flex-start; }

            /* STATUS OVERLAY */
            #statusOverlay {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,26,51,0.95); color: #fff;
                display: flex; justify-content: center; align-items: center;
                font-size: 30px; font-weight: bold; z-index: 20;
                font-family: 'Cinzel', serif;
            }

        </style>
    </head>
    <body>
        <div id="judgeHeader">
            <div class="judge-badge">JUDGE VIEW</div>
            <div id="modeIndicator" style="color:#aaa;">-</div>
        </div>

        <div id="statusOverlay">WAITING FOR SELECTION...</div>

        <div id="container">
            <div id="sidePanel"></div>
            <div id="mainView">
                <div id="infoBar">
                    <span id="jSurah">-</span> | Ayah: <span id="jAyah">-</span> | Juz: <span id="jJuz">-</span>
                </div>
                
                <div id="judgeBox">
                    <div id="quranText" class="center-content"></div>
                </div>
            </div>
        </div>

        <script>
            window.opener.initExtra(window); // Sync immediately

            function updateView(d) {
                const overlay = document.getElementById('statusOverlay');
                const sidePanel = document.getElementById('sidePanel');
                const qText = document.getElementById('quranText');
                const modeInd = document.getElementById('modeIndicator');

                // Update Mode Indicator
                const modeText = (d.settings.mode === 'hifz') ? "HIFZ MODE (Student sees hidden text)" : "TILAWA MODE";
                modeInd.innerText = modeText;
                modeInd.style.color = (d.settings.mode === 'hifz') ? "#ff5252" : "#00e676";

                // Phase Logic
                if (d.phase === 'grid') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "STUDENT SELECTING QUESTIONS...";
                } 
                else if (d.phase === 'ready') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "READY TO START";
                    renderSideList(d);
                }
                else if (d.phase === 'reading') {
                    overlay.style.display = 'none';
                    renderSideList(d);
                    
                    const cur = d.selection[d.currentIdx];
                    if(cur) {
                        // ALWAYS SHOW TEXT (Even if Hifz)
                        qText.innerText = cur.text;
                        
                        document.getElementById('jSurah').innerText = cur.surah;
                        document.getElementById('jAyah').innerText = cur.start + '-' + cur.end;
                        document.getElementById('jJuz').innerText = cur.juz;

                        // Check if text is long to handle centering vs scrolling
                        // Simple logic: Reset classes first
                        qText.className = 'center-content';
                        // Allow browser to render then check scroll height
                        setTimeout(() => {
                            if(qText.scrollHeight > qText.clientHeight) {
                                qText.className = 'top-content'; // Align top if scrolling needed
                            } else {
                                qText.className = 'center-content'; // Center if fits
                            }
                        }, 50);
                    }
                }
            }

            function renderSideList(d) {
                const sp = document.getElementById('sidePanel');
                sp.innerHTML = '';
                d.selection.forEach((q, i) => {
                    let div = document.createElement('div');
                    div.className = 'q-item ' + (i === d.currentIdx ? 'active' : '');
                    div.innerText = \`Q\${i+1}: \${q.surah} (\${q.start})\`;
                    sp.appendChild(div);
                });
            }
        <\/script>
    </body>
    </html>`;

    state.extra.judgeWindow = window.open("", "JudgeMirror", "width=1000,height=700");
    state.extra.judgeWindow.document.write(html);
    state.extra.judgeWindow.document.close();
    
    // Slight delay to ensure window loads before sync
    setTimeout(syncExtraScreen, 500);
}
    // ========================================================
// ‚òÖ NEW ROYAL JUDGE SCREEN (WITH FULLSCREEN CLICK) ‚òÖ
// ========================================================

function openJudgeMirror() {
    // Close existing window if open
    if(state.extra.judgeWindow) state.extra.judgeWindow.close();

    const fontCSS = `
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@700&display=swap');
        @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); } 
    `;

    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <title>Judge Royal Screen</title>
        <style>
            ${fontCSS}
            body { 
                margin: 0; overflow: hidden; 
                background: radial-gradient(circle at center, #001a33, #000510); /* Royal Dark Blue */
                font-family: 'Amiri', serif;
                display: flex; height: 100vh; width: 100vw;
                cursor: pointer; /* Hand cursor to indicate clickable */
            }
            
            /* HEADER BAR */
            #judgeHeader {
                position: absolute; top: 0; width: 100%; height: 60px;
                background: rgba(0,0,0,0.6);
                border-bottom: 1px solid #ffffff;
                display: flex; justify-content: space-between; align-items: center;
                padding: 0 20px; box-sizing: border-box; color: #fff; 
                z-index: 10; backdrop-filter: blur(5px);
            }
            .judge-badge {
                background: #fff; color: #001a33; padding: 5px 15px; 
                border-radius: 4px; font-weight: bold; font-size: 14px; font-family: sans-serif;
            }

            /* LAYOUT CONTAINER */
            #container {
                display: flex; width: 100%; height: 100%; padding-top: 60px; box-sizing: border-box;
            }
            
            /* SIDEBAR (List) */
            #sidePanel {
                width: 20%; background: rgba(0,0,0,0.3); border-left: 1px solid #444;
                padding: 10px; overflow-y: auto;
            }
            .q-item {
                background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px; border-radius: 4px;
                color: #ccc; font-size: 14px; cursor: default; border: 1px solid transparent;
            }
            .q-item.active {
                background: #004080; color: #fff; border-color: #fff; font-weight:bold;
            }

            /* MAIN VIEW AREA */
            #mainView {
                flex: 1; display: flex; flex-direction: column; 
                justify-content: center; align-items: center; 
                padding: 30px; position: relative;
            }
            
            /* INFO BAR (Top of Text) */
            #infoBar {
                margin-bottom: 15px; font-size: 16px; color: #b3e5fc; 
                font-family: 'Cinzel', serif; letter-spacing: 1px;
                text-shadow: 0 2px 4px #000;
            }

            /* --- ROYAL WHITE BORDER BOX --- */
            #judgeBox {
                width: 85%; height: 75%;
                border: 6px double #ffffff; /* Royal White Border */
                border-radius: 15px;
                padding: 30px;
                background: rgba(255,255,255,0.02); /* Very subtle fill */
                box-shadow: 0 0 40px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                position: relative;
            }

            /* CORNER DECORATION */
            #judgeBox::after {
                content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
                border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; pointer-events: none;
            }

            /* QURAN TEXT STYLING */
            #quranText {
                width: 100%; height: 100%;
                overflow-y: auto; /* Allow Scrolling */
                color: #ffffff;
                font-size: 3.5vw; 
                line-height: 2.2; 
                font-weight: bold; 
                text-align: center;
                direction: rtl; 
                white-space: pre-wrap;
                text-shadow: 0 2px 5px #000;
                
                /* CENTERING TRICK */
                display: flex; 
                flex-direction: column;
                align-items: center; 
            }
            
            /* Scrollbar Styling for Blue Theme */
            #quranText::-webkit-scrollbar { width: 10px; }
            #quranText::-webkit-scrollbar-track { background: #001a33; }
            #quranText::-webkit-scrollbar-thumb { background: #fff; border-radius: 5px; }

            /* To allow centering when short, but scrolling when long */
            #quranText.center-content { justify-content: center; }
            #quranText.top-content { justify-content: flex-start; }

            /* STATUS OVERLAY */
            #statusOverlay {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,26,51,0.95); color: #fff;
                display: flex; justify-content: center; align-items: center;
                font-size: 30px; font-weight: bold; z-index: 20;
                font-family: 'Cinzel', serif;
            }

        </style>
    </head>
    <body>
        <div id="judgeHeader">
            <div class="judge-badge">JUDGE VIEW</div>
            <div id="modeIndicator" style="color:#aaa;">-</div>
        </div>

        <div id="statusOverlay">WAITING FOR SELECTION...</div>

        <div id="container">
            <div id="sidePanel"></div>
            <div id="mainView">
                <div id="infoBar">
                    <span id="jSurah">-</span> | Ayah: <span id="jAyah">-</span> | Juz: <span id="jJuz">-</span>
                </div>
                
                <div id="judgeBox">
                    <div id="quranText" class="center-content"></div>
                </div>
            </div>
        </div>

        <script>
           
            window.opener.initExtra(window); // Sync immediately

            function updateView(d) {
                const overlay = document.getElementById('statusOverlay');
                const sidePanel = document.getElementById('sidePanel');
                const qText = document.getElementById('quranText');
                const modeInd = document.getElementById('modeIndicator');

                // Update Mode Indicator
                const modeText = (d.settings.mode === 'hifz') ? "HIFZ MODE (Student sees hidden text)" : "TILAWA MODE";
                modeInd.innerText = modeText;
                modeInd.style.color = (d.settings.mode === 'hifz') ? "#ff5252" : "#00e676";

                // Phase Logic
                if (d.phase === 'grid') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "STUDENT SELECTING QUESTIONS...";
                } 
                else if (d.phase === 'ready') {
                    overlay.style.display = 'flex';
                    overlay.innerText = "READY TO START";
                    renderSideList(d);
                }
                else if (d.phase === 'reading') {
                    overlay.style.display = 'none';
                    renderSideList(d);
                    
                    const cur = d.selection[d.currentIdx];
                    if(cur) {
                        // ALWAYS SHOW TEXT (Even if Hifz)
                        qText.innerText = cur.text;
                        
                        document.getElementById('jSurah').innerText = cur.surah;
                        document.getElementById('jAyah').innerText = cur.start + '-' + cur.end;
                        document.getElementById('jJuz').innerText = cur.juz;

                        // Check if text is long to handle centering vs scrolling
                        qText.className = 'center-content';
                        setTimeout(() => {
                            if(qText.scrollHeight > qText.clientHeight) {
                                qText.className = 'top-content'; // Align top if scrolling needed
                            } else {
                                qText.className = 'center-content'; // Center if fits
                            }
                        }, 50);
                    }
                }
            }

            function renderSideList(d) {
                const sp = document.getElementById('sidePanel');
                sp.innerHTML = '';
                d.selection.forEach((q, i) => {
                    let div = document.createElement('div');
                    div.className = 'q-item ' + (i === d.currentIdx ? 'active' : '');
                    div.innerText = \`Q\${i+1}: \${q.surah} (\${q.start})\`;
                    sp.appendChild(div);
                });
            }
        <\/script>
    </body>
    </html>`;

    state.extra.judgeWindow = window.open("", "JudgeMirror", "width=1000,height=700");
    state.extra.judgeWindow.document.write(html);
    state.extra.judgeWindow.document.close();
    
    // Slight delay to ensure window loads before sync
    setTimeout(syncExtraScreen, 500);
}
    // --- SECRETARY & ADMIN LOGIC (ADVANCED) ---

let secScores = {}; // To hold current calculations

// 1. Hook into the existing Student Selection to update Banner
const originalPopulateForm = populateStudentForm; // Backup old function
populateStudentForm = function(idx) {
    originalPopulateForm(idx); // Call original to fill inputs
    
    // NEW: Update Royal Banner
    if(idx !== "" && state.allStudents[idx]) {
        const s = state.allStudents[idx];
        document.getElementById('secStudentBanner').style.display = 'block';
        document.getElementById('secName').innerText = s.name;
        document.getElementById('secID').innerText = s.id;
        document.getElementById('secReg').innerText = s.reg || "-";
        document.getElementById('secAddr').innerText = s.address || "-";
        document.getElementById('secInst').innerText = s.institution || s.inst || "Private";
        document.getElementById('secBranch').innerText = s.branch || "-";
        document.getElementById('secGroup').innerText = s.group || "-";
        
        // Reset Scoring for new student
        renderSecretaryRubric();
    }
};

// 2. Render Rubric with Deduction Buttons
function renderSecretaryRubric() {
    const tbody = document.getElementById('secRubricBody');
    tbody.innerHTML = '';
    secScores = {}; // Reset local memory

    const rubric = state.judging.rubric;
    const steps = state.judging.deductionSteps || [0.25, 0.5, 1];

    rubric.forEach((r, idx) => {
        // Initialize Score
        secScores[idx] = { max: r.max, deducted: 0 };

        const tr = document.createElement('tr');
        tr.className = 'sec-row';
        
        // Buttons HTML
        let btns = '';
        steps.forEach(step => {
            btns += `<button class="sec-deduct-btn" onclick="addSecDeduction(${idx}, ${step})">-${step}</button>`;
        });
        btns += `<button class="sec-reset-btn" onclick="resetSecRow(${idx})">‚Ü∫</button>`;

        tr.innerHTML = `
            <td style="color:#fff; font-weight:bold;">${r.name}</td>
            <td style="text-align:center; color:#888;">${r.max}</td>
            <td>${btns} <span id="secDedInfo_${idx}" style="color:#ff5252; font-size:11px; margin-left:5px;"></span></td>
            <td style="text-align:center;">
                <span id="secScore_${idx}" style="color:#00e676; font-weight:bold; font-size:16px;">${r.max}</span>
            </td>
        `;
        tbody.appendChild(tr);
    });
    calculateSecTotal();
}

// 3. Calculation Logic
function addSecDeduction(idx, amount) {
    if(!secScores[idx]) return;
    
    // Increase deduction
    secScores[idx].deducted += amount;
    
    // Cap at Max (Cannot deduct more than max marks)
    if(secScores[idx].deducted > secScores[idx].max) {
        secScores[idx].deducted = secScores[idx].max;
    }
    updateSecRow(idx);
}

function resetSecRow(idx) {
    if(secScores[idx]) {
        secScores[idx].deducted = 0;
        updateSecRow(idx);
    }
}

function updateSecRow(idx) {
    const data = secScores[idx];
    const final = data.max - data.deducted;
    
    // Update UI
    document.getElementById(`secScore_${idx}`).innerText = final.toFixed(2);
    document.getElementById(`secDedInfo_${idx}`).innerText = data.deducted > 0 ? `(-${data.deducted.toFixed(2)})` : '';
    
    calculateSecTotal();
}

function calculateSecTotal() {
    let total = 0;
    for(let key in secScores) {
        total += (secScores[key].max - secScores[key].deducted);
    }
    document.getElementById('secTotalDisplay').innerText = total.toFixed(2);
    return total;
}

// 4. Save to Master System
function saveSecretaryScore() {
    // Validation
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!");
        return;
    }

    const judgeID = document.getElementById('secJudgeSelect').value;
    const finalScore = calculateSecTotal();

    // ‚òÖ LINK TO MASTER SHEET ‚òÖ
    // This updates the main judging memory, just like a digital judge
    state.judging.liveScores[judgeID] = parseFloat(finalScore.toFixed(2));
    
    // Trigger Auto-Save & Updates
    updateScoreMonitor(); // Updates the admin panel summary
    saveToLocal(); // Saves to browser memory
    
    // Visual Feedback
    const btn = document.querySelector('#secretaryPanel .btn-green');
    const oldText = btn.innerText;
    btn.innerText = "‚úÖ SAVED!";
    btn.style.background = "#fff";
    btn.style.color = "#000";
    
    setTimeout(() => {
        btn.innerText = oldText;
        btn.style.background = ""; // Reset to CSS default
        btn.style.color = "";
    }, 1500);
}

// Initialize on Load
document.addEventListener('DOMContentLoaded', () => {
    // If there is already an active student loaded from cache, render banner
    if(state.judging.currentStudentObj) {
       // We need to re-trigger the banner logic manually if needed, 
       // but typically 'populateStudentForm' handles it when selecting from list.
       renderSecretaryRubric();
    } else {
       renderSecretaryRubric(); // Render blank rubric
    }
});
    // --- ADVANCED SESSION QUEUE LOGIC ---

let sessionQueue = [];      // Stores the filtered list of students
let queueIndex = -1;        // Current position in the queue

// 1. LOAD MASTER SHEET DIRECTLY
function loadMasterSheetForQueue() {
    const fileInput = document.getElementById('masterSheetInput');
    if (!fileInput.files.length) { alert("Please select a CSV file!"); return; }

    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.allStudents = []; 

        // Parse CSV (Same logic as before)
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            // Handle quotes
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 6) {
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                // Mapping: 0:Serial, 1:Reg, 2:Group, 3:Branch, 4:Inst, 5:Name, 6:Gender...
                state.allStudents.push({
                    serial: clean[0], reg: clean[1], group: clean[2], branch: clean[3],
                    institution: clean[4], name: clean[5], gender: clean[6], address: clean[7],
                    id: clean[8], phone: clean[9], parent: clean[10], parentPhone: clean[11], email: clean[12],
                    scores: {} // Init empty scores
                });
            }
        }
        document.getElementById('queueStatus').innerText = `‚úÖ Loaded ${state.allStudents.length} Students`;
        alert("Master Sheet Loaded Successfully!");
    };
    r.readAsText(fileInput.files[0]);
}

// 2. CREATE SESSION QUEUE (FILTER)
function createSessionQueue() {
    const branch = document.getElementById('qBranch').value;
    const group = document.getElementById('qGroup').value;

    if(!branch || !group) { alert("Please select Branch and Age Group!"); return; }

    // Filter students
    sessionQueue = state.allStudents.filter(s => 
        s.branch === branch && s.group === group
    );

    if(sessionQueue.length === 0) {
        alert("No students found for this session!");
        return;
    }

    // Sort by Reg No (Optional)
    sessionQueue.sort((a,b) => a.reg.localeCompare(b.reg));

    // UI Setup
    document.getElementById('activeStudentControl').style.display = 'flex';
    queueIndex = 0;
    loadQueueStudent(0); // Load first student
    
    alert(`Session Started! ${sessionQueue.length} students in queue.`);
}

// 3. LOAD STUDENT INTO ACTIVE VIEW
function loadQueueStudent(idx) {
    if(idx < 0 || idx >= sessionQueue.length) return;
    
    const s = sessionQueue[idx];
    queueIndex = idx;

    // A. Update Visuals (Top Banner & Queue Panel)
    document.getElementById('qName').innerText = s.name;
    document.getElementById('qID').innerText = s.id;
    document.getElementById('qRegNo').innerText = s.reg;
    document.getElementById('qInst').innerText = s.institution;
    document.getElementById('qCounter').innerText = `Student ${idx + 1} of ${sessionQueue.length}`;

    // B. Set as System Active Student (Connects to Rubric)
    state.judging.currentStudentObj = s;
    state.judging.liveScores = s.scores || {}; // Load existing scores if any

    // C. Fill Hidden Inputs (For compatibility with other functions)
    document.getElementById('stdName').value = s.name;
    document.getElementById('stdID').value = s.id;
    // ... fill other inputs if needed

    // D. RESET RUBRIC & BANNER
    // This connects to the Secretary Panel logic we wrote earlier
    if(typeof renderSecretaryRubric === 'function') {
        renderSecretaryRubric(); 
    }
    
    // Update the Royal Banner in Main View
    document.getElementById('secName').innerText = s.name;
    document.getElementById('secID').innerText = s.id;
    document.getElementById('secReg').innerText = s.reg;
    document.getElementById('secInst').innerText = s.institution;
    document.getElementById('secBranch').innerText = s.branch;
    document.getElementById('secGroup').innerText = s.group;
    
    document.getElementById('secTotalDisplay').innerText = "0.00"; // Reset total display
}

// 4. NAVIGATION CONTROLS
function nextQueueStudent() {
    if(queueIndex < sessionQueue.length - 1) {
        loadQueueStudent(queueIndex + 1);
    } else {
        alert("End of List!");
    }
}

function prevQueueStudent() {
    if(queueIndex > 0) {
        loadQueueStudent(queueIndex - 1);
    }
}

// 5. ‚òÖ SAVE & AUTO-NEXT LOGIC (THE MAGIC FUNCTION) ‚òÖ
// Replace the old save function or update the button to call this
function saveAndNext() {
    // 1. Save Score
    saveSecretaryScore(); // Calls the existing logic to save to master array

    // 2. Visual Feedback & Delay
    const btn = document.getElementById('btnSaveNext'); // Assuming you ID the button
    
    setTimeout(() => {
        // 3. Auto Advance
        if(queueIndex < sessionQueue.length - 1) {
            nextQueueStudent();
            // Optional: Play a sound or flash the screen
        } else {
            alert("Session Complete! All students graded.");
        }
    }, 1000); // 1 second delay to see "Saved" message
}
    // --- MASTER SHEET TABLE LOGIC (LANDSCAPE VIEW) ---

let activeRowIndex = -1;

// 1. Load CSV to Table
function loadMasterSheetTable() {
    const fileInput = document.getElementById('masterSheetInput');
    if (!fileInput.files.length) return;

    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.allStudents = []; // Reset Data
        
        for(let i=1; i<rows.length; i++) {
            let row = rows[i].trim();
            if(!row) continue;
            // Handle quotes properly
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(cols && cols.length >= 6) {
                const c = cols.map(val => val.replace(/^"|"$/g, '').trim());
                
                // Create Student Object
                let sObj = {
                    serial: i, // Auto serial
                    reg: c[1] || "", group: c[2] || "", branch: c[3] || "",
                    institution: c[4] || "", name: c[5] || "", gender: c[6] || "",
                    address: c[7] || "", id: c[8] || "",
                    scores: {
                        Judge_1: 0, Judge_2: 0, Judge_3: 0, Judge_4: 0, Judge_5: 0
                    },
                    finalScore: 0,
                    rank: 0
                };
                state.allStudents.push(sObj);
            }
        }
        alert("Data Loaded!");
        renderMasterTable();
    };
    r.readAsText(fileInput.files[0]);
}

// 2. Render the Table (With Filters)
function renderMasterTable() {
    const fBranch = document.getElementById('filterBranch').value;
    const fGroup = document.getElementById('filterGroup').value;
    const tbody = document.getElementById('masterTableBody');
    
    tbody.innerHTML = '';

    // Filter Logic
    let displayList = state.allStudents.filter(s => {
        return (fBranch === "" || s.branch === fBranch) && 
               (fGroup === "" || s.group === fGroup);
    });

    // Sort by Rank or Name
    displayList.sort((a,b) => b.finalScore - a.finalScore); // High score top

    document.getElementById('tableCount').innerText = displayList.length;

    displayList.forEach((s, idx) => {
        let row = document.createElement('tr');
        if(s.id === state.judging.currentStudentObj?.id) row.classList.add('selected-row');

        // Calculate Rank (Dynamic)
        let rank = (s.finalScore > 0) ? (idx + 1) : "-";

        row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${s.reg}</td>
            <td style="text-align:left; font-weight:bold;">${s.name}</td>
            <td>${s.id}</td>
            <td>${s.branch}</td>
            <td>${s.group}</td>
            <td style="text-align:left;">${s.institution}</td>
            
            <td>${s.scores['Judge_1'] || '-'}</td>
            <td>${s.scores['Judge_2'] || '-'}</td>
            <td>${s.scores['Judge_3'] || '-'}</td>
            <td>${s.scores['Judge_4'] || '-'}</td>
            <td>${s.scores['Judge_5'] || '-'}</td>
            
            <td style="font-weight:bold; color:#00e676;">${s.finalScore || '-'}</td>
            <td style="color:#FFD700;">${rank}</td>
        `;

        // Click to Select Student for Grading
        row.onclick = () => selectStudentForGrading(s);
        tbody.appendChild(row);
    });
}

// 3. Select Logic (Links to Rubric & Banner)
function selectStudentForGrading(student) {
    // 1. Set Active Student
    state.judging.currentStudentObj = student;
    state.judging.liveScores = student.scores || {}; 

    // 2. Update Banner (Secretary Panel) - You need to add this banner back inside secretary panel if removed
    // Or we update the Banner Header if you kept it inside Secretary Panel
    if(document.getElementById('secName')) {
        document.getElementById('secStudentBanner').style.display = 'block';
        document.getElementById('secName').innerText = student.name;
        document.getElementById('secID').innerText = student.id;
        document.getElementById('secReg').innerText = student.reg;
        document.getElementById('secInst').innerText = student.institution;
    }

    // 3. Reset Rubric
    renderSecretaryRubric(); 
    
    // 4. Refresh Table to show selection highlight
    renderMasterTable();
}

// 4. Override Save Function to Update Table Immediately
const oldSaveFunc = saveSecretaryScore;
saveSecretaryScore = function() {
    // Call original logic to calculate totals
    if(!state.judging.currentStudentObj) return;
    
    const judgeID = document.getElementById('secJudgeSelect').value;
    const finalScore = calculateSecTotal();

    // Update Master Data
    const sIdx = state.allStudents.findIndex(x => x.id === state.judging.currentStudentObj.id);
    if(sIdx > -1) {
        state.allStudents[sIdx].scores[judgeID] = parseFloat(finalScore.toFixed(2));
        
        // Recalculate Average
        let total = 0; let count = 0;
        Object.values(state.allStudents[sIdx].scores).forEach(v => {
            if(v > 0) { total += v; count++; }
        });
        state.allStudents[sIdx].finalScore = count > 0 ? (total/count).toFixed(2) : 0;
    }

    // Visual Feedback
    alert("Saved!");
    renderMasterTable(); // Refresh table to show new scores
}
    // --- 2000 STUDENTS GENERATOR (FULL 5 JUDGES + RANKING) ---
function generateDetailedRankedCSV() {
    // 1. Scoring Criteria
    const criteria = [
        { name: "Thilawa", max: 30 }, 
        { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, 
        { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, 
        { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];

    // 2. Prepare Headers
    let headers = [
        "Serial No", "Reg No", "Age Group", "Branch", "Institution", 
        "Full Name", "Gender", "Address", "ID Card", "Contact", 
        "Parent Name", "Parent Phone", "Email"
    ];

    // Add Columns for EACH Judge (J1 to J5)
    for (let j = 1; j <= 5; j++) {
        criteria.forEach(c => {
            headers.push(`J${j}-${c.name}`);
        });
        headers.push(`J${j}-TOTAL`);
    }

    // Final Summary Columns
    headers.push("GRAND TOTAL", "FINAL AVERAGE", "RANK", "REMARKS");

    // 3. Data Pools
    const namesM = ["Ahmed", "Mohamed", "Ali", "Hussain", "Hassan", "Abdulla", "Ibrahim", "Yusuf", "Ismail", "Zaid"];
    const namesF = ["Fathimath", "Aishath", "Mariyam", "Aminath", "Zainab", "Hawwa", "Khadheeja", "Shifa", "Yumna"];
    const lastNames = ["Rasheed", "Nazeer", "Fayaz", "Manik", "Didi", "Saeed", "Zahir", "Riza", "Nasir", "Waheed"];
    const islands = ["Male'", "Hulhumale'", "Addu City", "Fuvahmulah", "Kulhudhuffushi", "Thinadhoo", "Naifaru"];
    const institutions = ["Arabiyya School", "Iskandhar School", "Majeedhiyya", "Aminiya", "Jamaluddin", "Ahmadhiyya", "Villa College", "MNU", "Quran Class"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "Under 21", "General"];
    const branches = ["Balaiygen", "Nubalai"];

    let allStudentsData = []; 

    // 4. Generate 2000 Students
    for (let i = 1; i <= 2000; i++) {
        const isFem = Math.random() > 0.5;
        const fName = isFem ? namesF[Math.floor(Math.random() * namesF.length)] : namesM[Math.floor(Math.random() * namesM.length)];
        const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
        
        let studentObj = {
            serial: i,
            reg: `REG-${1000 + i}`,
            group: groups[Math.floor(Math.random() * groups.length)],
            branch: branches[Math.floor(Math.random() * branches.length)],
            inst: institutions[Math.floor(Math.random() * institutions.length)],
            name: `${fName} ${lName}`,
            gender: isFem ? "Female" : "Male",
            addr: islands[Math.floor(Math.random() * islands.length)],
            id: `A${Math.floor(100000 + Math.random() * 900000)}`,
            contact: "7770000", parent: "Parent Name", pPhone: "7771111", email: "test@mail.com",
            
            judgeScores: [], 
            grandTotal: 0
        };

        // Base Ability (0.5 to 0.99)
        let ability = Math.random() * (0.99 - 0.50) + 0.50; 
        let totalForAllJudges = 0;

        for (let j = 1; j <= 5; j++) {
            let judgeSum = 0;
            let judgeRowParts = []; 
            let variance = (Math.random() * 0.1) - 0.05; 

            criteria.forEach(c => {
                let mark = c.max * (ability + variance);
                mark += (Math.random() * 2) - 1;
                mark = Math.max(0, Math.min(c.max, mark));
                mark = Math.round(mark * 2) / 2; // Round to 0.5

                judgeRowParts.push(mark.toFixed(2));
                judgeSum += mark;
            });

            judgeRowParts.push(judgeSum.toFixed(2));
            studentObj.judgeScores.push(judgeRowParts.join(","));
            totalForAllJudges += judgeSum;
        }

        studentObj.grandTotal = totalForAllJudges;
        studentObj.finalAvg = totalForAllJudges / 5;
        allStudentsData.push(studentObj);
    }

    // 5. SORTING FOR RANK (High Score First)
    allStudentsData.sort((a, b) => b.finalAvg - a.finalAvg);

    // 6. Build Final CSV
    let csvRows = [];
    csvRows.push(headers.join(",")); 

    allStudentsData.forEach((s, index) => {
        let rank = index + 1;
        let remarks = "";
        if (rank <= 3) remarks = `Top ${rank} üèÜ`;
        else if (rank <= 10) remarks = "Top 10 üéñÔ∏è";
        else if (s.finalAvg > 90) remarks = "Mumthaz";

        let row = [
            s.serial, s.reg, s.group, s.branch, s.inst, 
            s.name, s.gender, s.addr, s.id, s.contact, 
            s.parent, s.pPhone, s.email
        ];

        let rowString = row.map(v => `"${v}"`).join(","); 
        let judgesString = s.judgeScores.join(",");
        let statsString = `${s.grandTotal.toFixed(2)},${s.finalAvg.toFixed(2)},${rank},"${remarks}"`;

        csvRows.push(`${rowString},${judgesString},${statsString}`);
    });

    // 7. Download
    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const d = new Date();
    const dateStr = d.toISOString().split('T')[0];
    
    link.setAttribute("href", url);
    link.setAttribute("download", `Rasfahi_Full_Ranked_Data_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- SAVING LOGIC (PREVENTS DUPLICATES) ---
function finalizeStudentResult() {
    // 1. ﬁáﬁ¨ﬁÜﬁ∞ﬁìﬁ®ﬁàﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!");
        return;
    }
    
    // 2. ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let sum = 0;
    let count = 0;
    for(let j in state.judging.liveScores) {
        sum += state.judging.liveScores[j];
        count++;
    }
    
    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁ™ﬁãﬁ≠ﬁÇﬁ¶ﬁâﬁ¶ ﬁàﬁØﬁÇﬁ®ﬁÇﬁ∞ﬁé ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞
    if(count === 0) {
        if(!confirm("No judge scores received. Save with 0?")) return;
    }

    const finalScore = count > 0 ? (sum / count).toFixed(2) : 0;
    
    // 3. ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁëﬁ≠ﬁìﬁß ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const resultRecord = {
        ...state.judging.currentStudentObj, // ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™
        scores: {...state.judging.liveScores}, // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞
        finalScore: parseFloat(finalScore),    // ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞
        savedAt: new Date().toISOString()      // ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ® ﬁéﬁ¶ﬁëﬁ®
    };
    
    // ‚òÖ 4. ﬁëﬁ™ﬁïﬁ∞ﬁçﬁ®ﬁÜﬁ≠ﬁìﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ANTI-DUPLICATE CHECK) ‚òÖ
    // ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁâﬁ® ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ID) ﬁáﬁÆﬁåﬁ∞ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    const existingIndex = state.judging.savedResults.findIndex(r => r.id === resultRecord.id);

    if(existingIndex >= 0) {
        // ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁáﬁÆﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶: ﬁáﬁ¨ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠ (ﬁáﬁ¶ﬁáﬁ™ ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁÇﬁ™ﬁÜﬁ™ﬁÉﬁßﬁÇﬁ¨)
        state.judging.savedResults[existingIndex] = resultRecord;
        console.log(`Updated existing record for: ${resultRecord.name}`);
    } else {
        // ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶: ﬁáﬁ¶ﬁáﬁ™ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ¨ﬁáﬁ∞ ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ≠
        state.judging.savedResults.push(resultRecord);
        console.log(`Added new record for: ${resultRecord.name}`);
    }

    // 5. ﬁêﬁ≠ﬁàﬁ∞ & ﬁÉﬁ©ﬁêﬁ¨ﬁìﬁ∞
    saveToLocal(); // ﬁÑﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁíﬁß ﬁâﬁ¨ﬁâﬁÆﬁÉﬁ©ﬁáﬁ¶ﬁÅﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    
    // ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁéﬁ¨ ﬁÜﬁ™ﬁçﬁ¶ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ (Visual Feedback)
    const btn = document.getElementById('btnFinalize');
    if(btn) {
        btn.innerText = "‚úÖ Saved!";
        btn.classList.remove('btn-green');
        btn.style.backgroundColor = "#333"; // ﬁéﬁ¶ﬁãﬁ¶ ﬁáﬁ¶ﬁÖﬁ® ﬁÜﬁ™ﬁçﬁ¶
        btn.disabled = true; // ‚òÖ ﬁãﬁ¨ﬁàﬁ¶ﬁÇﬁ¶ ﬁäﬁ¶ﬁÄﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁäﬁ®ﬁáﬁ∞ﬁåﬁ™ﬁÇﬁ∞ ﬁâﬁ¶ﬁÇﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    }

    alert(`Saved Successfully!\nStudent: ${resultRecord.name}\nScore: ${finalScore}`);
    
    // 6. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁêﬁßﬁäﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ (Optional: Remove if you want to keep student visible)
    // document.getElementById('stdName').value = "";
    // document.getElementById('stdID').value = "";
    // state.judging.currentStudentObj = null;
    // state.judging.liveScores = {};
    // document.getElementById('currentStdLabel').innerText = "No student active.";
    // document.getElementById('adminScoreMonitor').innerText = "Waiting...";
    
    // ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ¶ﬁâﬁ¶)
    if(typeof renderMasterTable === 'function') renderMasterTable();
}
    // --- ULTIMATE 2000 STUDENTS GENERATOR (WITH CRITERIA BREAKDOWN) ---
function generateDetailedRankedCSV() {
    // 1. Scoring Criteria definition
    const criteriaList = [
        { name: "Thilawa", max: 30 }, 
        { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, 
        { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, 
        { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];

    // 2. Prepare Headers
    let headers = [
        "Serial No", "Reg No", "Age Group", "Branch", "Institution", 
        "Full Name", "Gender", "Address", "ID Card", "Contact", 
        "Parent Name", "Parent Phone", "Email"
    ];

    // ‚òÖ NEW: Add Headers for Criteria Averages (Categories)
    criteriaList.forEach(c => {
        headers.push(`${c.name} (AVG)`);
    });

    // Add Columns for EACH Judge Total
    for (let j = 1; j <= 5; j++) {
        headers.push(`Judge ${j} Total`);
    }

    // Final Summary Columns
    headers.push("GRAND TOTAL", "FINAL AVERAGE", "RANK", "REMARKS");

    // 3. Data Pools
    const namesM = ["Ahmed", "Mohamed", "Ali", "Hussain", "Hassan", "Abdulla", "Ibrahim", "Yusuf", "Ismail", "Zaid"];
    const namesF = ["Fathimath", "Aishath", "Mariyam", "Aminath", "Zainab", "Hawwa", "Khadheeja", "Shifa", "Yumna"];
    const lastNames = ["Rasheed", "Nazeer", "Fayaz", "Manik", "Didi", "Saeed", "Zahir", "Riza", "Nasir", "Waheed"];
    const islands = ["Male'", "Hulhumale'", "Addu City", "Fuvahmulah", "Kulhudhuffushi", "Thinadhoo", "Naifaru"];
    const institutions = ["Arabiyya School", "Iskandhar School", "Majeedhiyya", "Aminiya", "Jamaluddin", "Ahmadhiyya", "Villa College", "MNU", "Quran Class"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "Under 21", "General"];
    const branches = ["Balaiygen", "Nubalai"];

    let allStudentsData = []; 

    // 4. Generate 2000 Students
    for (let i = 1; i <= 2000; i++) {
        const isFem = Math.random() > 0.5;
        const fName = isFem ? namesF[Math.floor(Math.random() * namesF.length)] : namesM[Math.floor(Math.random() * namesM.length)];
        const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
        
        // Setup Sums Tracker for Criteria Averages
        let criteriaSums = {}; 
        criteriaList.forEach(c => criteriaSums[c.name] = 0);

        let studentObj = {
            serial: i,
            reg: `REG-${1000 + i}`,
            group: groups[Math.floor(Math.random() * groups.length)],
            branch: branches[Math.floor(Math.random() * branches.length)],
            inst: institutions[Math.floor(Math.random() * institutions.length)],
            name: `${fName} ${lName}`,
            gender: isFem ? "Female" : "Male",
            addr: islands[Math.floor(Math.random() * islands.length)],
            id: `A${Math.floor(100000 + Math.random() * 900000)}`,
            contact: "7770000", parent: "Parent Name", pPhone: "7771111", email: "test@mail.com",
            
            judgeTotals: [], // Store just the total for each judge
            catAverages: [], // Store the calculated average for each category
            grandTotal: 0
        };

        // Student Ability Factor (Consistency)
        let ability = Math.random() * (0.99 - 0.50) + 0.50; 
        let totalForAllJudges = 0;

        // Loop through 5 Judges
        for (let j = 1; j <= 5; j++) {
            let judgeSum = 0;
            let variance = (Math.random() * 0.1) - 0.05; 

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark += (Math.random() * 2) - 1;
                mark = Math.max(0, Math.min(c.max, mark));
                mark = Math.round(mark * 2) / 2;

                // Add to sums tracker
                criteriaSums[c.name] += mark;
                
                judgeSum += mark;
            });

            studentObj.judgeTotals.push(judgeSum.toFixed(2));
            totalForAllJudges += judgeSum;
        }

        // Calculate Category Averages (Sum / 5 Judges)
        criteriaList.forEach(c => {
            let avg = criteriaSums[c.name] / 5;
            studentObj.catAverages.push(avg.toFixed(2));
        });

        studentObj.grandTotal = totalForAllJudges;
        studentObj.finalAvg = totalForAllJudges / 5;
        allStudentsData.push(studentObj);
    }

    // 5. SORTING FOR RANK
    allStudentsData.sort((a, b) => b.finalAvg - a.finalAvg);

    // 6. Build Final CSV Content
    let csvRows = [];
    csvRows.push(headers.join(",")); 

    allStudentsData.forEach((s, index) => {
        let rank = index + 1;
        let remarks = "";
        if (rank <= 3) remarks = `Top ${rank} üèÜ`;
        else if (rank <= 10) remarks = "Top 10 üéñÔ∏è";
        else if (s.finalAvg > 90) remarks = "Mumthaz";

        // A. Basic Info
        let row = [
            s.serial, s.reg, s.group, s.branch, s.inst, 
            s.name, s.gender, s.addr, s.id, s.contact, 
            s.parent, s.pPhone, s.email
        ];
        let rowString = row.map(v => `"${v}"`).join(","); 

        // B. Criteria Averages (New Section)
        let catString = s.catAverages.join(",");

        // C. Judge Totals
        let judgesString = s.judgeTotals.join(",");

        // D. Final Stats
        let statsString = `${s.grandTotal.toFixed(2)},${s.finalAvg.toFixed(2)},${rank},"${remarks}"`;

        // Combine
        csvRows.push(`${rowString},${catString},${judgesString},${statsString}`);
    });

    // 7. Download
    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const d = new Date();
    const dateStr = d.toISOString().split('T')[0];
    
    link.setAttribute("href", url);
    link.setAttribute("download", `Rasfahi_Full_Ranked_Data_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- DYNAMIC AVERAGING LOGIC (FIXED) ---
function finalizeStudentResult() {
    // 1. ﬁáﬁ¨ﬁÜﬁ∞ﬁìﬁ®ﬁàﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!");
        return;
    }
    
    // 2. ﬁëﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁâﬁ®ﬁÜﬁ∞ ﬁÜﬁ¶ﬁçﬁ∞ﬁÜﬁ®ﬁáﬁ™ﬁçﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ (Dynamic Calculation)
    // ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁçﬁßﬁÇﬁ© ﬁÜﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁåﬁØ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ®ﬁÇﬁ©. 
    // ﬁâﬁ®ﬁêﬁßﬁçﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ 2 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁãﬁ©ﬁäﬁ®ﬁÇﬁ¶ﬁâﬁ¶ ﬁéﬁ¨ﬁáﬁ∞ﬁçﬁßﬁÇﬁ© 2 ﬁáﬁ®ﬁÇﬁ∞. 5 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁãﬁ©ﬁäﬁ®ﬁÇﬁ¶ﬁâﬁ¶ 5 ﬁáﬁ®ﬁÇﬁ∞.
    
    let sum = 0;
    let activeJudgeCount = 0; // ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ®ﬁÇﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ™

    // liveScores ﬁéﬁ¨ ﬁåﬁ¨ﬁÉﬁ≠ﬁéﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÉﬁ® ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁâﬁßﬁÜﬁ™ﬁÄﬁ¨ﬁáﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    for(let key in state.judging.liveScores) {
        let score = parseFloat(state.judging.liveScores[key]);
        
        // ﬁâﬁßﬁÜﬁ™ﬁÄﬁ¶ﬁÜﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁáﬁ¶ﬁãﬁ® 0 ﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ¶ﬁâﬁ¶ ﬁéﬁ™ﬁÇﬁßﬁÇﬁ¨
        if(!isNaN(score) && score > 0) {
            sum += score;
            activeJudgeCount++;
        }
    }
    
    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁ™ﬁãﬁ≠ﬁÇﬁ¶ﬁâﬁ¶ ﬁàﬁØﬁÇﬁ®ﬁÇﬁ∞ﬁé ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞
    if(activeJudgeCount === 0) {
        if(!confirm("No judge scores entered. Save with 0?")) return;
    }

    // 3. ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ (ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ / ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ™)
    const finalScore = activeJudgeCount > 0 ? (sum / activeJudgeCount).toFixed(2) : 0;
    
    // 4. ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁñﬁ¨ﬁÄﬁ≠ ﬁëﬁ≠ﬁìﬁß ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const resultRecord = {
        ...state.judging.currentStudentObj, // ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™
        scores: {...state.judging.liveScores}, // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞
        finalScore: parseFloat(finalScore),    // ﬁëﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁâﬁ®ﬁÜﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞
        judgeCount: activeJudgeCount,          // ﬁÜﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁÜﬁ¶ﬁÇﬁ∞ ﬁÉﬁ¨ﬁÜﬁØﬁëﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Optional)
        savedAt: new Date().toISOString()
    };
    
    // --- ﬁëﬁ™ﬁïﬁ∞ﬁçﬁ®ﬁÜﬁ≠ﬁìﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ ---
    const existingIndex = state.judging.savedResults.findIndex(r => r.id === resultRecord.id);

    if(existingIndex >= 0) {
        state.judging.savedResults[existingIndex] = resultRecord; // Update
    } else {
        state.judging.savedResults.push(resultRecord); // New Entry
    }

    // 5. ﬁêﬁ≠ﬁàﬁ∞ & ﬁäﬁ©ﬁëﬁ∞ﬁÑﬁ¨ﬁÜﬁ∞
    saveToLocal();
    
    // ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞
    const btn = document.getElementById('btnFinalize');
    if(btn) {
        btn.innerText = `‚úÖ Saved! (Avg: ${finalScore})`;
        btn.classList.remove('btn-green');
        btn.style.backgroundColor = "#333";
        btn.disabled = true;
    }

    alert(`Saved Successfully!\nActive Judges: ${activeJudgeCount}\nAverage Score: ${finalScore}`);
    
    // ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞
    if(typeof renderMasterTable === 'function') renderMasterTable();
}
    // --- 2000 STUDENTS GENERATOR (DYNAMIC AVERAGE LOGIC) ---
function generateDetailedRankedCSV() {
    const criteriaList = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];

    // Headers
    let headers = [
        "Serial No", "Reg No", "Age Group", "Branch", "Institution", 
        "Full Name", "Gender", "Address", "ID Card", "Contact", 
        "Parent Name", "Parent Phone", "Email"
    ];

    // Criteria Averages Headers
    criteriaList.forEach(c => headers.push(`${c.name} (AVG)`));
    
    // Judge Totals Headers
    for (let j = 1; j <= 5; j++) headers.push(`Judge ${j} Total`);

    // Summary Headers
    headers.push("ACTIVE JUDGES", "GRAND TOTAL", "FINAL AVERAGE", "RANK", "REMARKS");

    const namesM = ["Ahmed", "Mohamed", "Ali", "Hussain", "Hassan", "Abdulla", "Ibrahim"];
    const namesF = ["Fathimath", "Aishath", "Mariyam", "Aminath", "Zainab", "Hawwa"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "General"];
    const branches = ["Balaiygen", "Nubalai"];

    let allStudentsData = []; 

    // Generate Rows
    for (let i = 1; i <= 2000; i++) {
        const isFem = Math.random() > 0.5;
        const name = isFem ? namesF[i % namesF.length] : namesM[i % namesM.length];
        
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            group: groups[i % groups.length],
            branch: branches[i % branches.length],
            inst: "School " + (i % 10),
            name: `${name} Student ${i}`,
            gender: isFem ? "Female" : "Male",
            addr: "Island", id: `A000${i}`,
            
            judgeTotals: [], 
            catAverages: [], 
            grandTotal: 0,
            activeJudges: 0 // To track how many judges scored
        };

        // ‚òÖ DYNAMIC LOGIC: Randomly decide how many judges are present (3 to 5)
        // This simulates real life where not all 5 judges might be there
        let judgesPresent = Math.floor(Math.random() * 3) + 3; // Random 3, 4, or 5
        
        let ability = Math.random() * (0.95 - 0.50) + 0.50; 
        let totalForAllJudges = 0;
        let criteriaSums = {}; 
        criteriaList.forEach(c => criteriaSums[c.name] = 0);

        for (let j = 1; j <= 5; j++) {
            // If current judge number is greater than present count, give 0 marks (Absent)
            if (j > judgesPresent) {
                studentObj.judgeTotals.push("0.00"); // Empty score
                continue; 
            }

            let judgeSum = 0;
            let variance = (Math.random() * 0.1) - 0.05; 

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark));
                criteriaSums[c.name] += mark;
                judgeSum += mark;
            });

            studentObj.judgeTotals.push(judgeSum.toFixed(2));
            totalForAllJudges += judgeSum;
        }

        // Calculate Category Averages (Divide by Active Judges, NOT 5)
        criteriaList.forEach(c => {
            let avg = criteriaSums[c.name] / judgesPresent;
            studentObj.catAverages.push(avg.toFixed(2));
        });

        studentObj.activeJudges = judgesPresent;
        studentObj.grandTotal = totalForAllJudges;
        
        // ‚òÖ THE FIX: Divide by Active Judges Count
        studentObj.finalAvg = totalForAllJudges / judgesPresent;
        
        allStudentsData.push(studentObj);
    }

    // Sort
    allStudentsData.sort((a, b) => b.finalAvg - a.finalAvg);

    // Build CSV
    let csvRows = [];
    csvRows.push(headers.join(",")); 

    allStudentsData.forEach((s, index) => {
        let rank = index + 1;
        let remarks = (rank <= 10) ? "Top 10" : "";

        let row = [
            s.serial, s.reg, s.group, s.branch, s.inst, 
            s.name, s.gender, s.addr, s.id, "777", "Parent", "777", "mail"
        ];
        let rowString = row.map(v => `"${v}"`).join(","); 
        let catString = s.catAverages.join(",");
        let judgesString = s.judgeTotals.join(",");
        
        // Add Active Judges Count to CSV to verify logic
        let statsString = `${s.activeJudges},${s.grandTotal.toFixed(2)},${s.finalAvg.toFixed(2)},${rank},"${remarks}"`;

        csvRows.push(`${rowString},${catString},${judgesString},${statsString}`);
    });

    // Download
    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const dateStr = new Date().toISOString().split('T')[0];
    
    link.setAttribute("href", url);
    link.setAttribute("download", `Rasfahi_Dynamic_Results_${dateStr}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- NEW ROYAL CARD STYLE RENDERER ---
function renderSecretaryRubric() {
    // 1. Target the Container (Assuming you change the HTML container ID or use existing)
    // We will inject the grid into the same place where table was, replacing it.
    const wrapper = document.querySelector('.sec-table-wrapper');
    if (!wrapper) return;

    // Clear old table content
    wrapper.innerHTML = '<div id="rubricGrid" class="rubric-grid-container"></div>';
    const grid = document.getElementById('rubricGrid');
    
    secScores = {}; // Reset local calculation memory

    const rubric = state.judging.rubric;
    const steps = state.judging.deductionSteps || [0.5, 1]; // Default steps if missing

    rubric.forEach((r, idx) => {
        // Initialize State
        secScores[idx] = { max: r.max, deducted: 0 };

        // Create Card Element
        const card = document.createElement('div');
        card.className = 'rubric-card';

        // Generate Buttons HTML
        let btnsHtml = '';
        steps.forEach(step => {
            btnsHtml += `<button class="deduct-btn-mini" onclick="addSecDeduction(${idx}, ${step})">-${step}</button>`;
        });

        // Card HTML Structure
        card.innerHTML = `
            <div class="card-info">
                <div class="card-title">${r.name}</div>
                <div class="card-max">Max Marks: ${r.max}</div>
                <div class="card-actions">
                    ${btnsHtml}
                    <button class="reset-btn-mini" onclick="resetSecRow(${idx})" title="Reset">‚Ü∫</button>
                </div>
            </div>
            
            <div class="card-score-box">
                <div class="card-score-val" id="secScore_${idx}">${r.max}</div>
                <div class="card-deducted" id="secDedInfo_${idx}"></div>
            </div>
        `;
        
        grid.appendChild(card);
    });

    calculateSecTotal(); // Update Total
}
    // --- FIXED SAVE FUNCTION (LINKS CARD UI TO MASTER DATA) ---
function saveSecretaryScore() {
    // 1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ™ﬁÇﬁ∞
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first! (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß)");
        return;
    }

    // 2. ﬁñﬁ¶ﬁñﬁ™ ﬁáﬁ¶ﬁãﬁ® ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const judgeID = document.getElementById('secJudgeSelect').value; // e.g. "Judge_1"
    
    // ﬁÜﬁßﬁëﬁ™ﬁåﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ (secScores) ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let totalScore = 0;
    if(typeof secScores !== 'undefined') {
        for (let key in secScores) {
            totalScore += (secScores[key].max - secScores[key].deducted);
        }
    } else {
        // ﬁêﬁ≠ﬁäﬁ∞ﬁìﬁ©: ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ®ﬁáﬁ∞ﬁîﬁß 0
        totalScore = 0;
    }
    
    // ﬁïﬁÆﬁáﬁ®ﬁÇﬁ∞ﬁìﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ ﬁÄﬁ¶ﬁáﬁ∞ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (2 ﬁëﬁ¨ﬁêﬁ®ﬁâﬁ¶ﬁçﬁ∞)
    totalScore = parseFloat(totalScore.toFixed(2));

    // 3. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁâﬁ¨ﬁâﬁ¶ﬁÉﬁ© ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    if (!state.judging.liveScores) state.judging.liveScores = {};
    state.judging.liveScores[judgeID] = totalScore;

    // ‚òÖ 4. ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ∞ (ALL STUDENTS) ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ ‚òÖ
    // ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁïﬁØﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁßﬁáﬁ®ﬁÉﬁ™ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁßﬁÉﬁß ﬁâﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÄﬁ¶ﬁáﬁ∞ﬁçﬁ™
    const currentID = state.judging.currentStudentObj.id;
    
    // ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ﬁÇﬁ∞ ﬁâﬁ® ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁß ﬁÄﬁØﬁãﬁ™ﬁÇﬁ∞
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);

    if (sIdx > -1) {
        // ﬁêﬁ∞ﬁÜﬁØ ﬁáﬁÆﬁÑﬁ∞ﬁñﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞
        if (!state.allStudents[sIdx].scores) {
            state.allStudents[sIdx].scores = {};
        }
        
        // ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁçﬁ™ﬁÇﬁ∞
        state.allStudents[sIdx].scores[judgeID] = totalScore;

        // ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁáﬁÆﬁïﬁ∞ﬁùﬁ¶ﬁÇﬁ¶ﬁçﬁ∞)
        let sum = 0; 
        let count = 0;
        const allS = state.allStudents[sIdx].scores;
        for (let jKey in allS) {
            let val = parseFloat(allS[jKey]);
            if (val > 0) { sum += val; count++; }
        }
        // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁÄﬁßﬁçﬁ™ﬁÇﬁ∞
        state.allStudents[sIdx].finalScore = count > 0 ? parseFloat((sum / count).toFixed(2)) : 0;
    }

    // 5. ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    saveToLocal(); // ﬁÑﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁíﬁß ﬁâﬁ¨ﬁâﬁ¶ﬁÉﬁ©ﬁáﬁ¶ﬁÅﬁ∞
    
    if(typeof renderMasterTable === 'function') {
        renderMasterTable(); // ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ﬁàﬁßﬁÇﬁ¨
    }

    // 6. ﬁÜﬁßﬁâﬁ®ﬁîﬁßﬁÑﬁ™ﬁàﬁ®ﬁÜﬁ¶ﬁÇﬁ∞ ﬁáﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÇﬁ∞ (Visual Feedback)
    const saveBtn = document.getElementById('btnSaveNext'); // ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©
    if(saveBtn) {
        const oldTxt = saveBtn.innerText;
        saveBtn.innerText = `‚úÖ Saved! (${totalScore})`;
        saveBtn.style.background = "#fff";
        saveBtn.style.color = "#000";
        
        setTimeout(() => {
            saveBtn.innerText = oldTxt;
            saveBtn.style.background = ""; // Reset
            saveBtn.style.color = "";
        }, 1500);
    } else {
        // ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™ﬁÇﬁ¶ﬁâﬁ¶ ﬁáﬁ¨ﬁçﬁßﬁìﬁ¨ﬁáﬁ∞
        alert(`Score Saved!\nJudge: ${judgeID}\nMark: ${totalScore}`);
    }
}
    // --- FIXED: EXPORT ALL DATA (IGNORES FILTERS) ---
function exportFullMasterSheet() {
    // 1. ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨ ﬁâﬁ¶ﬁêﬁ∞ﬁãﬁ¶ﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ™ﬁÇﬁ∞
    // ﬁáﬁ®ﬁêﬁ∞ﬁÜﬁ¶ﬁÇﬁ∞ﬁãﬁ≠ﬁÇﬁ© "Master List" (state.allStudents) ﬁáﬁ¶ﬁÅﬁ¨ﬁàﬁ¨.
    let sourceData = [];

    if (state.allStudents && state.allStudents.length > 0) {
        sourceData = [...state.allStudents]; // Copy Master List
    } else if (state.judging.savedResults && state.judging.savedResults.length > 0) {
        sourceData = [...state.judging.savedResults]; // Fallback to saved results
    }

    if (sourceData.length === 0) {
        alert("No data found to export! (ﬁáﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁïﬁØﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁßﬁÇﬁ¨ ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞)");
        return;
    }

    // 2. CSV Headers ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    // ﬁâﬁ®ﬁáﬁ© ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁäﬁ™ﬁÖﬁ™ﬁàﬁ® ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞: ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ + ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶
    const criteriaList = [
        "Thilawa", "Tajweed", "Makhraj", "Sifa", "Fasaha", "Talaffuz", "Maqamat"
    ];

    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,";
    
    // Add Criteria Average Columns Headers
    criteriaList.forEach(c => csv += `${c} (AVG),`);
    
    // Add Judge Columns Headers
    for(let j=1; j<=5; j++) csv += `Judge ${j} Total,`;
    
    // Final Summary Headers
    csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

    // 3. ﬁëﬁ≠ﬁìﬁß ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ (Loop through ALL students)
    // ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ¶ﬁÅﬁ∞ﬁìﬁ¶ﬁÜﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁåﬁ®ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁêﬁØﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    sourceData.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));

    sourceData.forEach((s, idx) => {
        let row = [];
        
        // --- A. Personal Info ---
        row.push(idx + 1); // Serial (Rank Based)
        row.push(`"${s.reg || ''}"`);
        row.push(`"${s.group || ''}"`);
        row.push(`"${s.branch || ''}"`);
        row.push(`"${s.institution || s.inst || ''}"`);
        row.push(`"${s.name || ''}"`);
        row.push(`"${s.gender || ''}"`);
        row.push(`"${s.address || s.addr || ''}"`);
        row.push(`"${s.id || ''}"`);

        // --- B. Criteria Averages Logic ---
        // ﬁâﬁ®ﬁáﬁ© ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ¨ﬁáﬁ∞. ﬁáﬁ¶ﬁÖﬁ™ﬁéﬁ¶ﬁÇﬁëﬁ™ﬁâﬁ¨ﬁÇﬁ∞ ﬁáﬁ¶ﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁáﬁÆﬁåﬁ© ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÜﬁ¶ﬁâﬁ¶ﬁÅﬁ∞ﬁàﬁßﬁÇﬁ¶ﬁâﬁ¶
        // ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁäﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁãﬁ¶ﬁåﬁ®ﬁàﬁßﬁÇﬁ¨. ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ﬁàﬁ¨ﬁêﬁ∞ "Generate Dummy" ﬁáﬁ®ﬁÇﬁ∞ ﬁáﬁ¶ﬁáﬁ® ﬁëﬁ≠ﬁìﬁßﬁÇﬁ¶ﬁâﬁ¶ ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨.
        // ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁÅﬁ∞ ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¶ﬁÖﬁßﬁÇﬁ© "-" ﬁáﬁ¨ﬁàﬁ¨. (To prevent errors)
        
        // (If you created 'catAverages' in generator, use it. Else empty)
        if(s.catAverages && s.catAverages.length > 0) {
            s.catAverages.forEach(val => row.push(val));
        } else {
            // Fill blanks if data missing
            criteriaList.forEach(() => row.push("-")); 
        }

        // --- C. Judge Totals (The most important part) ---
        // Check s.scores object OR s.judgeTotals array
        for(let j=1; j<=5; j++) {
            let val = "0";
            
            // 1. Check Live Judging Object format { Judge_1: 90 }
            if(s.scores && s.scores[`Judge_${j}`]) {
                val = s.scores[`Judge_${j}`];
            } 
            // 2. Check Dummy Generator Array format [90, 80, ...]
            else if(s.judgeTotals && s.judgeTotals[j-1]) {
                val = s.judgeTotals[j-1];
            }
            
            row.push(val);
        }

        // --- D. Final Calculations ---
        // Recalculate Grand Total from the columns to be safe
        let grandTotal = 0;
        let activeJudges = 0;
        
        // Check scores again for calc
        for(let j=1; j<=5; j++) {
            let sc = 0;
            if(s.scores && s.scores[`Judge_${j}`]) sc = parseFloat(s.scores[`Judge_${j}`]);
            else if(s.judgeTotals && s.judgeTotals[j-1]) sc = parseFloat(s.judgeTotals[j-1]);
            
            if(sc > 0) {
                grandTotal += sc;
                activeJudges++;
            }
        }

        // If 'finalScore' is already saved, use it. Else calculate.
        let finalAvg = s.finalScore || 0;
        if(finalAvg === 0 && activeJudges > 0) {
            finalAvg = (grandTotal / activeJudges).toFixed(2);
        }

        row.push(grandTotal.toFixed(2));
        row.push(finalAvg);
        row.push(idx + 1); // Rank
        row.push(""); // Remarks

        csv += row.join(",") + "\n";
    });

    // 4. Download File
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Rasfahi_FULL_BACKUP_${dateStr}.csv`;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- ADVANCED SAVE: STORES DETAILED BREAKDOWN ---
function saveSecretaryScore() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!"); return;
    }

    const judgeID = document.getElementById('secJudgeSelect').value; // e.g., "Judge_1"
    const currentID = state.judging.currentStudentObj.id;
    
    // 1. Calculate Details from Cards (Rubric)
    let totalScore = 0;
    let detailsObj = {}; // To store { "Thilawa": 28, "Tajweed": 19... }

    if(state.judging.rubric && typeof secScores !== 'undefined') {
        state.judging.rubric.forEach((r, idx) => {
            const val = secScores[idx].max - secScores[idx].deducted;
            detailsObj[r.name] = val; // Store category score
            totalScore += val;
        });
    }
    totalScore = parseFloat(totalScore.toFixed(2));

    // 2. Find & Update Student in Master List
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);

    if (sIdx > -1) {
        // A. Update Totals (For Table View)
        if (!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
        state.allStudents[sIdx].scores[judgeID] = totalScore;

        // B. ‚òÖ SAVE DETAILED BREAKDOWN (New Feature) ‚òÖ
        if (!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};
        state.allStudents[sIdx].detailedScores[judgeID] = detailsObj; 

        // C. Update Final Average immediately
        let sum = 0; let count = 0;
        for (let j in state.allStudents[sIdx].scores) {
            let v = state.allStudents[sIdx].scores[j];
            if(v > 0) { sum += v; count++; }
        }
        state.allStudents[sIdx].finalScore = count > 0 ? parseFloat((sum / count).toFixed(2)) : 0;
    }

    // 3. Save & Refresh
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // 4. Visual Feedback
    const btn = document.querySelector('#secretaryPanel .btn-green'); // Or specific ID
    if(btn) {
        btn.innerText = `‚úÖ Saved! (${totalScore})`;
        setTimeout(() => btn.innerText = "üíæ SAVE & NEXT STUDENT ‚ñ∂", 1500);
    }
}
    // --- ULTIMATE EXPORT: INCLUDES CRITERIA AVERAGES ---
function exportFullMasterSheet() {
    // Data Source
    let sourceData = (state.allStudents && state.allStudents.length > 0) ? [...state.allStudents] : [...state.judging.savedResults];
    
    if (sourceData.length === 0) { alert("No data to export!"); return; }

    // 1. Get Criteria Names Dynamically
    const rubric = state.judging.rubric || [
        {name:"Thilawa"}, {name:"Tajweed"}, {name:"Makhraj"}, 
        {name:"Sifa"}, {name:"Fasaha"}, {name:"Talaffuz"}, {name:"Maqamat"}
    ];

    // 2. Build Headers
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,";
    
    // A. Add Criteria Average Headers
    rubric.forEach(r => csv += `${r.name} (AVG),`);
    
    // B. Add Judge Total Headers
    for(let j=1; j<=5; j++) csv += `Judge ${j} Total,`;
    
    csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

    // 3. Sort by Rank
    sourceData.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));

    // 4. Build Rows
    sourceData.forEach((s, idx) => {
        let row = [];
        row.push(idx + 1, `"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, `"${s.institution||s.inst||''}"`, `"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, `"${s.id||''}"`);

        // --- ‚òÖ CALCULATE CRITERIA AVERAGES ‚òÖ ---
        rubric.forEach(r => {
            let critSum = 0;
            let critCount = 0;

            // Check detailedScores { Judge_1: {Thilawa: 28}, Judge_2: {Thilawa: 29} }
            if (s.detailedScores) {
                for (let jID in s.detailedScores) {
                    let score = s.detailedScores[jID][r.name];
                    if (score !== undefined) {
                        critSum += parseFloat(score);
                        critCount++;
                    }
                }
            } 
            // Fallback for Dummy Data (if using array format)
            else if (s.catAverages) {
                // ... logic for dummy data mapping if needed ...
            }

            // Calc Average for this criteria
            let avg = critCount > 0 ? (critSum / critCount).toFixed(2) : "-";
            row.push(avg);
        });

        // --- Judge Totals ---
        let grandTotal = 0;
        let activeJudges = 0;
        for(let j=1; j<=5; j++) {
            let val = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0";
            row.push(val);
            if(parseFloat(val) > 0) { grandTotal += parseFloat(val); activeJudges++; }
        }

        // --- Summary ---
        let finalAvg = s.finalScore || (activeJudges > 0 ? (grandTotal/activeJudges).toFixed(2) : 0);
        
        row.push(grandTotal.toFixed(2));
        row.push(finalAvg);
        row.push(idx + 1);
        row.push("");

        csv += row.join(",") + "\n";
    });

    // 5. Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Rasfahi_Detailed_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- 1. FIXED DUMMY GENERATOR (SAVES TO MEMORY FIRST) ---
function generateDetailedRankedCSV() {
    // A. Setup Criteria
    const criteriaList = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];

    // B. Reset System Data
    state.allStudents = []; 
    
    const namesM = ["Ahmed", "Mohamed", "Ali", "Hussain", "Hassan", "Abdulla"];
    const namesF = ["Fathimath", "Aishath", "Mariyam", "Aminath", "Zainab"];
    const groups = ["Under 6", "Under 9", "Under 13", "General"];
    const branches = ["Balaiygen", "Nubalai"];

    // C. Generate 2000 Students
    for (let i = 1; i <= 2000; i++) {
        const isFem = Math.random() > 0.5;
        const name = isFem ? namesF[i % namesF.length] : namesM[i % namesM.length];
        
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            group: groups[i % groups.length],
            branch: branches[i % branches.length],
            inst: "School " + (i % 10),
            name: `${name} ${i}`,
            gender: isFem ? "Female" : "Male",
            addr: "Male'", id: `A000${i}`,
            
            // ‚òÖ IMPORTANT STORAGE STRUCTURES ‚òÖ
            scores: {},          // Stores { Judge_1: 90, Judge_2: 85 }
            detailedScores: {},  // Stores Breakdown { Judge_1: { Thilawa: 28... } }
            finalScore: 0
        };

        // Student Ability (Consistent across judges)
        let ability = Math.random() * (0.95 - 0.50) + 0.50; 
        let grandTotal = 0;

        // Loop 5 Judges
        for (let j = 1; j <= 5; j++) {
            let jKey = `Judge_${j}`;
            let judgeTotal = 0;
            let variance = (Math.random() * 0.1) - 0.05; 
            
            // Create Judge's Object inside Detailed Scores
            studentObj.detailedScores[jKey] = {};

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark));
                mark = parseFloat(mark.toFixed(2)); // Round appropriately

                // Store Breakdown
                studentObj.detailedScores[jKey][c.name] = mark;
                judgeTotal += mark;
            });

            // Store Totals
            judgeTotal = parseFloat(judgeTotal.toFixed(2));
            studentObj.scores[jKey] = judgeTotal;
            grandTotal += judgeTotal;
        }

        studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
        state.allStudents.push(studentObj);
    }

    // D. Save & Update UI
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();
    
    alert("‚úÖ 2000 Students Generated with FULL BREAKDOWN!\nNow click 'Export Full List' to see averages.");
}
    // --- 2. FIXED EXPORT FUNCTION (CALCULATES CATEGORY AVERAGES) ---
function exportFullMasterSheet() {
    // A. Get Data
    let sourceData = [];
    if (state.allStudents && state.allStudents.length > 0) sourceData = [...state.allStudents];
    else if (state.judging.savedResults && state.judging.savedResults.length > 0) sourceData = [...state.judging.savedResults];

    if (sourceData.length === 0) { alert("No data to export!"); return; }

    // B. Define Criteria
    const criteriaList = [
        "Thilawa", "Tajweed", "Makhraj", "Sifa", "Fasaha", "Talaffuz", "Maqamat"
    ];

    // C. Build CSV Header
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,";
    
    // 1. Criteria Average Headers
    criteriaList.forEach(c => csv += `${c} (AVG),`);
    
    // 2. Judge Total Headers
    for(let j=1; j<=5; j++) csv += `Judge ${j} Total,`;
    
    csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

    // D. Sort Data
    sourceData.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));

    // E. Build Rows
    sourceData.forEach((s, idx) => {
        let row = [];
        row.push(idx + 1, `"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, `"${s.institution||s.inst||''}"`, `"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, `"${s.id||''}"`);

        // --- ‚òÖ CRITICAL LOGIC: CALCULATE CRITERIA AVERAGES ‚òÖ ---
        criteriaList.forEach(critName => {
            let sum = 0;
            let count = 0;

            // Check detailedScores (created by generator or manual save)
            if (s.detailedScores) {
                for (let jKey in s.detailedScores) {
                    // Check if this judge has a score for this criteria
                    if (s.detailedScores[jKey][critName] !== undefined) {
                        sum += parseFloat(s.detailedScores[jKey][critName]);
                        count++;
                    }
                }
            }

            // If data exists, calc average. Else "-"
            let avg = count > 0 ? (sum / count).toFixed(2) : "-";
            row.push(avg);
        });

        // --- Judge Totals ---
        let grandTotal = 0;
        let activeJudges = 0;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = (s.scores && s.scores[jKey]) ? s.scores[jKey] : "0";
            row.push(val);
            
            if(parseFloat(val) > 0) {
                grandTotal += parseFloat(val);
                activeJudges++;
            }
        }

        // --- Final Stats ---
        let finalAvg = s.finalScore || (activeJudges > 0 ? (grandTotal/activeJudges).toFixed(2) : 0);
        
        row.push(grandTotal.toFixed(2));
        row.push(finalAvg);
        row.push(idx + 1);
        row.push("");

        csv += row.join(",") + "\n";
    });

    // F. Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Rasfahi_Full_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- 1. DUMMY GENERATOR (UPDATES MEMORY + DOWNLOADS CSV) ---
function generateDetailedRankedCSV() {
    state.allStudents = []; // Reset Data
    
    // Config
    const criteriaList = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];
    
    // Arrays for Random Data
    const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam"];
    const groups = ["Under 6", "Under 9", "Under 13", "General"];
    const branches = ["Balaiygen", "Nubalai"];

    // GENERATE 2000 STUDENTS
    for (let i = 1; i <= 2000; i++) {
        const name = names[i % names.length];
        
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            group: groups[i % groups.length],
            branch: branches[i % branches.length],
            inst: "School " + (i % 5),
            name: `${name} ${i}`,
            gender: (i % 2 === 0) ? "Female" : "Male",
            addr: "Male'", id: `A000${i}`,
            
            scores: {},          // Simple Totals
            detailedScores: {},  // Full Breakdown
            finalScore: 0
        };

        let ability = Math.random() * (0.95 - 0.50) + 0.50; 
        let grandTotal = 0;

        // Simulate 5 Judges
        for (let j = 1; j <= 5; j++) {
            let jKey = `Judge_${j}`;
            let judgeTotal = 0;
            let variance = (Math.random() * 0.1) - 0.05; 
            
            // Initialize Judge Object
            studentObj.detailedScores[jKey] = {};

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark));
                mark = parseFloat(mark.toFixed(2));

                // ‚òÖ STORE BREAKDOWN HERE ‚òÖ
                studentObj.detailedScores[jKey][c.name] = mark;
                judgeTotal += mark;
            });

            judgeTotal = parseFloat(judgeTotal.toFixed(2));
            studentObj.scores[jKey] = judgeTotal;
            grandTotal += judgeTotal;
        }

        studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
        state.allStudents.push(studentObj);
    }

    // Update Table & Save
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();
    
    // ‚òÖ TRIGGER DOWNLOAD IMMEDIATELY ‚òÖ
    exportFullMasterSheet(); 
    alert("‚úÖ Generated & Downloaded!");
}
    // --- 2. EXPORT FUNCTION (CALCULATES CATEGORY AVERAGES) ---
function exportFullMasterSheet() {
    let sourceData = (state.allStudents && state.allStudents.length > 0) ? [...state.allStudents] : [...state.judging.savedResults];
    if (sourceData.length === 0) { alert("No data to export!"); return; }

    const criteriaNames = ["Thilawa", "Tajweed", "Makhraj", "Sifa", "Fasaha", "Talaffuz", "Maqamat"];

    // 1. Build CSV Headers
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,";
    
    // Criteria Headers
    criteriaNames.forEach(c => csv += `${c} (AVG),`);
    
    // Judge Headers
    for(let j=1; j<=5; j++) csv += `Judge ${j} Total,`;
    
    csv += "GRAND TOTAL,FINAL AVERAGE,RANK\n";

    // 2. Sort Data
    sourceData.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));

    // 3. Loop Rows
    sourceData.forEach((s, idx) => {
        let row = [];
        row.push(idx + 1, `"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, `"${s.institution||s.inst||''}"`, `"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, `"${s.id||''}"`);

        // ‚òÖ CRITICAL: Calculate Average for Each Criteria ‚òÖ
        criteriaNames.forEach(crit => {
            let sum = 0;
            let count = 0;

            // Check if detailed scores exist
            if (s.detailedScores) {
                // Loop through Judge_1 to Judge_5 keys
                for (let key in s.detailedScores) {
                    let score = s.detailedScores[key][crit]; // e.g. detailedScores['Judge_1']['Thilawa']
                    if (score !== undefined) {
                        sum += parseFloat(score);
                        count++;
                    }
                }
            }

            let avg = count > 0 ? (sum / count).toFixed(2) : "0.00";
            row.push(avg); // Add to CSV Row
        });

        // Add Judge Totals
        let grandTotal = 0;
        let activeJudges = 0;
        for(let j=1; j<=5; j++) {
            let val = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0";
            row.push(val);
            if(parseFloat(val) > 0) { grandTotal += parseFloat(val); activeJudges++; }
        }

        let finalAvg = s.finalScore || (activeJudges > 0 ? (grandTotal/activeJudges).toFixed(2) : 0);
        row.push(grandTotal.toFixed(2), finalAvg, idx + 1);

        csv += row.join(",") + "\n";
    });

    // 4. Download Logic
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Rasfahi_Full_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // --- 3. SAVE FUNCTION (STORES DETAILS FOR EXPORT) ---
function saveSecretaryScore() {
    if(!state.judging.currentStudentObj) { alert("Select student first!"); return; }

    const judgeID = document.getElementById('secJudgeSelect').value;
    const currentID = state.judging.currentStudentObj.id;
    
    // 1. Get Details from Cards
    let totalScore = 0;
    let detailsObj = {}; // Holds Thilawa: 25, Tajweed: 15 etc.

    if(state.judging.rubric && typeof secScores !== 'undefined') {
        state.judging.rubric.forEach((r, idx) => {
            const val = secScores[idx].max - secScores[idx].deducted;
            detailsObj[r.name] = val; // Store Category Score
            totalScore += val;
        });
    }
    totalScore = parseFloat(totalScore.toFixed(2));

    // 2. Save to Master List
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);
    if (sIdx > -1) {
        if (!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
        state.allStudents[sIdx].scores[judgeID] = totalScore;

        // ‚òÖ THIS LINE SAVES THE BREAKDOWN ‚òÖ
        if (!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};
        state.allStudents[sIdx].detailedScores[judgeID] = detailsObj; 

        // Update Final Avg
        let sum = 0, count = 0;
        for (let j in state.allStudents[sIdx].scores) {
            let v = state.allStudents[sIdx].scores[j];
            if(v > 0) { sum += v; count++; }
        }
        state.allStudents[sIdx].finalScore = count > 0 ? parseFloat((sum / count).toFixed(2)) : 0;
    }

    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();
    
    // Button Feedback
    const btn = document.querySelector('#secretaryPanel .btn-green');
    if(btn) {
        let old = btn.innerText;
        btn.innerText = `‚úÖ SAVED (${totalScore})`;
        setTimeout(() => btn.innerText = old, 1500);
    }
}
    // --- 1. ULTIMATE DUMMY GENERATOR (ENABLES REPORTING & PRINTING) ---
function generateDetailedRankedCSV() {
    // A. Reset Both Memory Banks (To treat dummy as real data)
    state.allStudents = []; 
    state.judging.savedResults = []; // ‚òÖ Clears old results to load dummy as "Official"

    const criteriaList = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];
    
    // Config Data
    const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam", "Zainab"];
    // Ensure these match your Report Filter Dropdowns exactly
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "General"];
    const branches = ["Balaiygen", "Nubalai"];
    const institutions = ["Arabiyya School", "Majeedhiyya", "Aminiya", "Villa College", "Quran Class", "Private"];

    // B. Generate 2000 Students
    for (let i = 1; i <= 2000; i++) {
        const name = names[i % names.length];
        
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            group: groups[i % groups.length],
            branch: branches[i % branches.length],
            institution: institutions[i % institutions.length], // Added Inst
            name: `${name} ${i}`,
            gender: (i % 2 === 0) ? "Female" : "Male",
            addr: "Male'", id: `A000${i}`,
            
            scores: {},          
            detailedScores: {},  
            finalScore: 0
        };

        let ability = Math.random() * (0.98 - 0.50) + 0.50; 
        let grandTotal = 0;

        for (let j = 1; j <= 5; j++) {
            let jKey = `Judge_${j}`;
            let judgeTotal = 0;
            let variance = (Math.random() * 0.1) - 0.05; 
            
            studentObj.detailedScores[jKey] = {};

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark));
                mark = parseFloat(mark.toFixed(2));

                studentObj.detailedScores[jKey][c.name] = mark;
                judgeTotal += mark;
            });

            judgeTotal = parseFloat(judgeTotal.toFixed(2));
            studentObj.scores[jKey] = judgeTotal;
            grandTotal += judgeTotal;
        }

        studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
        
        // ‚òÖ THE FIX: Push to BOTH lists so Reporting buttons work ‚òÖ
        state.allStudents.push(studentObj);
        state.judging.savedResults.push(studentObj);
    }

    // C. Save & Finalize
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();
    
    // Auto-download the CSV as backup
    exportFullMasterSheet(); 
    
    alert("‚úÖ Dummy Data Generated & Set as OFFICIAL Results!\n\nYou can now click 'Top 3', 'Top 5', or 'Full List' buttons to print reports.");
}
    // --- ULTIMATE DUMMY GENERATOR V2 (FIXED DOWNLOAD) ---
function generateDetailedRankedCSV() {
    // 1. Reset Memory (So reports work on new data)
    state.allStudents = []; 
    state.judging.savedResults = []; 

    // Criteria Setup
    const criteriaList = [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];

    // --- PREPARE CSV CONTENT DIRECTLY ---
    // Headers
    let csvContent = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,";
    // Add Criteria Headers
    criteriaList.forEach(c => csvContent += `${c.name} (AVG),`);
    // Add Judge Headers
    for(let j=1; j<=5; j++) csvContent += `Judge ${j} Total,`;
    // Final Headers
    csvContent += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

    // Data Sources
    const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam", "Zainab"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "General"];
    const branches = ["Balaiygen", "Nubalai"];
    const insts = ["Arabiyya", "Majeedhiyya", "Aminiya", "Villa College", "Quran Class", "Private"];

    // 2. GENERATE DATA LOOP
    for (let i = 1; i <= 2000; i++) {
        const name = names[i % names.length];
        
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            group: groups[i % groups.length],
            branch: branches[i % branches.length],
            institution: insts[i % insts.length],
            name: `${name} ${i}`,
            gender: (i % 2 === 0) ? "Female" : "Male",
            addr: "Male'", id: `A000${i}`,
            
            scores: {},          
            detailedScores: {},  
            finalScore: 0
        };

        let ability = Math.random() * (0.98 - 0.50) + 0.50; 
        let grandTotal = 0;
        let catSums = {}; // Track sums for averages
        criteriaList.forEach(c => catSums[c.name] = 0);

        // Generate Judge Scores
        for (let j = 1; j <= 5; j++) {
            let jKey = `Judge_${j}`;
            let judgeTotal = 0;
            let variance = (Math.random() * 0.1) - 0.05; 
            
            studentObj.detailedScores[jKey] = {};

            criteriaList.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark));
                mark = parseFloat(mark.toFixed(2));

                studentObj.detailedScores[jKey][c.name] = mark;
                catSums[c.name] += mark; // Add to category sum
                judgeTotal += mark;
            });

            judgeTotal = parseFloat(judgeTotal.toFixed(2));
            studentObj.scores[jKey] = judgeTotal;
            grandTotal += judgeTotal;
        }

        studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
        
        // Push to Memory (For Reports)
        state.allStudents.push(studentObj);
        state.judging.savedResults.push(studentObj);

        // --- BUILD CSV ROW IMMEDIATELY ---
        let row = [];
        row.push(i, `"${studentObj.reg}"`, `"${studentObj.group}"`, `"${studentObj.branch}"`, `"${studentObj.institution}"`, `"${studentObj.name}"`, `"${studentObj.gender}"`, `"${studentObj.addr}"`, `"${studentObj.id}"`);

        // Criteria Averages
        criteriaList.forEach(c => {
            let avg = (catSums[c.name] / 5).toFixed(2);
            row.push(avg);
        });

        // Judge Totals
        for(let j=1; j<=5; j++) row.push(studentObj.scores[`Judge_${j}`]);

        // Final Stats
        // (Note: Rank is estimated as Serial here for speed, real rank needs sort)
        // Let's keep it simple for the dummy file
        row.push(grandTotal.toFixed(2), studentObj.finalScore, "", ""); 

        csvContent += row.join(",") + "\n";
    }

    // 3. Save to System Memory
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // 4. ‚òÖ FORCE DOWNLOAD CSV ‚òÖ
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    // Create filename with timestamp
    const dateStr = new Date().toISOString().slice(0,19).replace(/:/g,"-");
    link.setAttribute("href", url);
    link.setAttribute("download", `Rasfahi_Dummy_Data_${dateStr}.csv`);
    
    // Trigger click
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert("‚úÖ 2000 Students Generated!\n1. File Download Started.\n2. Data Loaded into System for Reports.");
}
// =========================================================================
// ‚òÖ RASFAHI ULTIMATE DATA SUITE (V10 - STRICT INST TYPES & FULL MARKS) ‚òÖ
// =========================================================================

// --- 0. SAFETY HELPER: GET RUBRIC ---
function getSafeRubricList() {
    if (typeof state !== 'undefined' && state.judging && state.judging.rubric && state.judging.rubric.length > 0) {
        return state.judging.rubric;
    }
    return [
        { name: "Thilawa", max: 30 }, { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, { name: "Talaffuz", max: 5 }, { name: "Maqamat", max: 5 }
    ];
}

// --- 1. BLANK TEMPLATE GENERATOR ---
function downloadMasterCSVTemplate() {
    try {
        const criteria = getSafeRubricList(); 
        let csv = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        criteria.forEach(c => { csv += `${c.name} (AVG),`; });
        for (let j = 1; j <= 5; j++) csv += `Judge ${j} Total,`;
        csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

        // Sample Row
        let row = ["1", "REG-001", "Under 6", "Balaiygen", "School", "Student Name", "Male", "Male'", "AXXXXXX", "7770000", "Parent Name", "7770000", "email@test.com"];
        criteria.forEach(() => row.push("")); 
        for (let j = 1; j <= 5; j++) row.push(""); 
        row.push("","","","");
        csv += row.join(",") + "\n";

        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_Master_Template.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (e) { alert("Template Error: " + e.message); }
}

// --- 2. DUMMY DATA GENERATOR (STRICT INST TYPES + FULL MARKS) ---
function generateDummyMasterSheet() {
    try {
        if(typeof state === 'undefined') { alert("State Error! Refresh."); return; }
        state.allStudents = []; 
        state.judging.savedResults = []; 

        const criteriaList = getSafeRubricList(); 

        // ‚òÖ STRICT LIST AS REQUESTED ‚òÖ
        const instTypes = ["School", "Office", "NGO", "University", "Private"];

        const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam", "Zainab"];
        const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "General"];
        const branches = ["Balaiygen", "Nubalai"];

        // Header Generation
        let csvContent = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        for(let j=1; j<=5; j++) {
            criteriaList.forEach(c => csvContent += `J${j}-${c.name},`);
            csvContent += `J${j}-TOTAL,`;
        }
        csvContent += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

        for (let i = 1; i <= 2000; i++) {
            const name = names[i % names.length];
            // Assign Institution Type strictly from the list
            const iType = instTypes[i % instTypes.length];
            
            let studentObj = {
                serial: i, reg: `REG-${1000 + i}`,
                name: `${name} ${i}`, id: `A000${i}`, gender: (i%2==0)?"Female":"Male",
                group: groups[i % groups.length], branch: branches[i % branches.length],
                address: "Male'",
                instType: iType, institution: iType, 
                contact: "7770000", parent: "Parent", pPhone: "7770000", email: "test@mail.com",
                scores: {}, detailedScores: {}, finalScore: 0
            };

            // Generate Marks
            let ability = Math.random() * (0.95 - 0.60) + 0.60; 
            let grandTotal = 0;
            let csvScoreString = "";

            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                let judgeTotal = 0;
                let variance = (Math.random() * 0.1) - 0.05; 
                studentObj.detailedScores[jKey] = {};

                criteriaList.forEach(c => {
                    let mark = c.max * (ability + variance);
                    mark = Math.max(0, Math.min(c.max, mark));
                    mark = parseFloat(mark.toFixed(2));
                    
                    studentObj.detailedScores[jKey][c.name] = mark;
                    judgeTotal += mark;
                    csvScoreString += `${mark},`; 
                });

                judgeTotal = parseFloat(judgeTotal.toFixed(2));
                studentObj.scores[jKey] = judgeTotal;
                grandTotal += judgeTotal;
                csvScoreString += `${judgeTotal},`; 
            }

            studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
            state.allStudents.push(studentObj);
            state.judging.savedResults.push(studentObj);

            let rowStart = `${i},"${studentObj.reg}","${studentObj.group}","${studentObj.branch}","${studentObj.instType}","${studentObj.name}","${studentObj.gender}","${studentObj.address}","${studentObj.id}","${studentObj.contact}","${studentObj.parent}","${studentObj.pPhone}","${studentObj.email}",`;
            let rowEnd = `${grandTotal.toFixed(2)},${studentObj.finalScore},"",""`;
            csvContent += rowStart + csvScoreString + rowEnd + "\n";
        }

        saveToLocal();
        if(typeof renderMasterTable === 'function') renderMasterTable();

        // Auto Download
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_Dummy_Sample_Strict.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert("‚úÖ Generated Sample Data: Only School, Office, NGO, University, Private included!");

    } catch (e) { alert("Gen Error: " + e.message); }
}

// --- 3. EXPORT MASTER ---
function exportMasterResultSheet() {
    /* (Standard Export Logic - Same as before) */
    try {
        let sourceData = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
        if (!sourceData || sourceData.length === 0) { alert("No data!"); return; }
        
        const criteriaList = getSafeRubricList();
        let csv = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        for(let j=1; j<=5; j++) {
            criteriaList.forEach(c => csv += `J${j}-${c.name},`);
            csv += `J${j}-TOTAL,`;
        }
        csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";
        
        sourceData.forEach((s, idx) => {
           let row = [idx + 1, `"${s.reg}"`, `"${s.group}"`, `"${s.branch}"`, `"${s.instType}"`, `"${s.name}"`, `"${s.gender}"`, `"${s.address}"`, `"${s.id}"`, `"${s.contact}"`, `"${s.parent}"`, `"${s.pPhone}"`, `"${s.email}"`];
           let gTotal = 0;
           for(let j=1; j<=5; j++){
               let jT = 0; let jKey = `Judge_${j}`;
               criteriaList.forEach(c => {
                   let m = (s.detailedScores && s.detailedScores[jKey]) ? s.detailedScores[jKey][c.name] : "";
                   row.push(m); if(m) jT+=parseFloat(m);
               });
               row.push(jT.toFixed(2)); gTotal+=jT;
           }
           row.push(gTotal.toFixed(2), s.finalScore, idx+1, "");
           csv += row.join(",") + "\n";
        });
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_Export.csv`;
        document.body.appendChild(link);
        link.click(); document.body.removeChild(link);
    } catch(e) { alert(e.message); }
}

// --- 4. BATCH LOADER ---
function loadStudentBatch() {
    const file = document.getElementById('batchCsv').files[0];
    if(!file) { alert("Select CSV!"); return; }
    const r = new FileReader();
    r.onload = e => {
        try {
            const rows = e.target.result.split('\n');
            state.allStudents = []; state.judging.savedResults = []; 
            
            for(let i=1; i<rows.length; i++) {
                let rowRaw = rows[i].trim();
                if(!rowRaw) continue;
                const cols = rowRaw.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if(!cols || cols.length < 13) continue;
                const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());

                // Index 4 is strictly Institution Type
                const sObj = {
                    serial: clean[0], reg: clean[1], group: clean[2], branch: clean[3],
                    instType: clean[4], institution: clean[4], 
                    name: clean[5], gender: clean[6], address: clean[7],
                    id: clean[8], phone: clean[9], parent: clean[10], parentPhone: clean[11], email: clean[12]
                };
                
                // Try to load scores if present in CSV
                if(clean.length > 20) {
                     // Basic logic to assume scores are present if cols exist
                     // For sample loading, we just push the object.
                     // A full implementation would parse marks back into detailedScores here.
                     // But for now, we load basic info.
                     let finalScore = parseFloat(clean[clean.length-3]);
                     if(!isNaN(finalScore)) { 
                         sObj.finalScore = finalScore; 
                         state.judging.savedResults.push(sObj);
                     }
                }
                state.allStudents.push(sObj);
            }
            if(typeof populateStudentSelector === 'function') populateStudentSelector();
            if(typeof saveToLocal === 'function') saveToLocal();
            alert(`‚úÖ Loaded ${state.allStudents.length} students.`);
        } catch(err) { alert(err.message); }
    };
    r.readAsText(file);
}

// --- 5. A3 MANUAL SHEET (‚òÖ WITH FILTER & FULL MARKS ‚òÖ) ---
function downloadDetailedManualSheet() {
    try {
        const criteria = getSafeRubricList(); 

        // 1. Get Filter Value from your HTML Dropdown
        let filterType = "All";
        const filterEl = document.getElementById("rptFilterInstType");
        if(filterEl) filterType = filterEl.value;

        // 2. Prepare Data Source
        let students = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
        
        // Fallback
        if ((!students || students.length === 0) && state.judging.savedResults.length > 0) {
            students = state.judging.savedResults;
        }

        if (!students || students.length === 0) { 
            alert("No data found! Please click 'Generate Dummy Data' first."); 
            return; 
        }

        // 3. APPLY FILTER (If user selected 'School', only show Schools)
        if (filterType !== "All") {
            students = students.filter(s => (s.instType === filterType || s.institution === filterType));
        }

        if (students.length === 0) {
            alert(`No students found for type: ${filterType}`);
            return;
        }

        // 4. Generate CSV Header
        let csv = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        
        // Add columns for ALL judges and ALL criteria
        for (let j = 1; j <= 5; j++) {
            criteria.forEach(c => { csv += `J${j}-${c.name},`; });
            csv += `J${j}-TOTAL,`;
        }
        csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

        // 5. Generate Rows with FULL MARKS
        students.forEach((s, index) => {
            let row = [];
            row.push(index + 1, `"${s.reg || ''}"`, `"${s.group || ''}"`, `"${s.branch || ''}"`, `"${s.instType || s.institution || ''}"`, `"${s.name || ''}"`, `"${s.gender || ''}"`, `"${s.address || s.addr || ''}"`, `"${s.id || ''}"`, `"${s.phone || ''}"`, `"${s.parent || ''}"`, `"${s.parentPhone || ''}"`, `"${s.email || ''}"`);

            let grandTotal = 0; let activeJudges = 0;

            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`; 
                let jTotal = 0;

                // ‚òÖ FILL EVERY SMALL MARK (BREAKDOWN) ‚òÖ
                criteria.forEach(c => {
                      let val = "";
                      // Check detailedScores
                      if(s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][c.name] !== undefined) {
                          val = s.detailedScores[jKey][c.name]; 
                          jTotal += parseFloat(val);
                      }
                      row.push(val); // This adds the small mark to the cell
                });

                // Judge Total
                let displayTotal = jTotal > 0 ? jTotal.toFixed(2) : (s.scores ? (s.scores[jKey] || "") : "");
                row.push(displayTotal);

                if(parseFloat(displayTotal) > 0) {
                    grandTotal += parseFloat(displayTotal);
                    activeJudges++;
                }
            }
            
            let finalAvg = s.finalScore || (activeJudges > 0 ? (grandTotal/activeJudges).toFixed(2) : "");
            
            row.push(grandTotal > 0 ? grandTotal.toFixed(2) : "", finalAvg, "", "");
            csv += row.join(",") + "\n";
        });

        // 6. Download
        const fileName = `Rasfahi_A3_${filterType}_${new Date().toISOString().slice(0,10)}.csv`;
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (e) {
        alert("Sheet Error: " + e.message);
    }
}
// =========================================================================
// ‚òÖ RASFAHI ULTIMATE - REALISTIC FULL DATA SAMPLE & EXPORT (V13) ‚òÖ
// =========================================================================

// --- 0. RUBRIC DEFINITION (Standard) ---
function getSafeRubricList() {
    // These match the column headers exactly
    return [
        { name: "Thilawa", max: 30 }, 
        { name: "Tajweed", max: 20 }, 
        { name: "Makhraj", max: 20 }, 
        { name: "Sifa", max: 10 }, 
        { name: "Fasaha", max: 10 }, 
        { name: "Talaffuz", max: 5 }, 
        { name: "Maqamat", max: 5 }
    ];
}

// --- 1. GENERATE REALISTIC SAMPLE DATA (WITH FULL BREAKDOWN) ---
function generateDummyMasterSheet() {
    try {
        if(typeof state === 'undefined') { alert("State Error! Refresh."); return; }
        
        // Clear existing data
        state.allStudents = []; 
        state.judging.savedResults = []; 

        const criteriaList = getSafeRubricList(); 
        
        // Strict Institution Types
        const instTypes = ["School", "Office", "NGO", "University", "Private"];
        const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam", "Zainab"];
        const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "General"];
        const branches = ["Balaiygen", "Nubalai"];

        // Generate 2000 Rows
        for (let i = 1; i <= 2000; i++) {
            const name = names[i % names.length];
            const iType = instTypes[i % instTypes.length];
            
            // Create Student Object
            let studentObj = {
                serial: i, 
                reg: `REG-${1000 + i}`,
                name: `${name} ${i}`, 
                id: `A000${i}`, 
                gender: (i%2==0)?"Female":"Male",
                group: groups[i % groups.length], 
                branch: branches[i % branches.length],
                address: "Male'", 
                instType: iType, 
                institution: iType, 
                contact: "7770000", parent: "Parent", pPhone: "7770000", email: "test@mail.com",
                
                // Important Containers
                scores: {}, 
                detailedScores: {}, 
                finalScore: 0
            };

            // --- MARK GENERATION LOGIC ---
            let grandTotal = 0;
            // Determine a "Skill Level" for this student (e.g., 60% to 95%)
            let skillLevel = Math.random() * (0.95 - 0.60) + 0.60; 

            // Loop through 5 Judges
            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                studentObj.detailedScores[jKey] = {}; // Init Judge Object
                
                let judgeTotal = 0;
                // Minor variance per judge (so they don't give exact same marks)
                let judgeVariance = (Math.random() * 0.1) - 0.05; 

                // Loop through Criteria (Thilawa, Tajweed...)
                criteriaList.forEach(c => {
                    // Calculate mark based on skill + variance
                    let rawMark = c.max * (skillLevel + judgeVariance);
                    // Ensure it stays within 0 to Max
                    let finalMark = Math.max(0, Math.min(c.max, rawMark));
                    // Round to 2 decimals
                    finalMark = parseFloat(finalMark.toFixed(2));
                    
                    // ‚òÖ STORE THE DETAILED MARK ‚òÖ
                    studentObj.detailedScores[jKey][c.name] = finalMark;
                    
                    judgeTotal += finalMark;
                });

                // Store Judge Total
                judgeTotal = parseFloat(judgeTotal.toFixed(2));
                studentObj.scores[jKey] = judgeTotal;
                grandTotal += judgeTotal;
            }

            // Calculate Final Average
            studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
            
            // Save to State
            state.allStudents.push(studentObj);
            state.judging.savedResults.push(studentObj);
        }

        saveToLocal();
        if(typeof renderMasterTable === 'function') renderMasterTable();

        alert(`‚úÖ Sample Data Generated!\n- 2000 Students\n- Full Marks for 5 Judges (Thilawa, Tajweed, etc.)\n- Ready to Export.`);

    } catch (e) {
        alert("Gen Error: " + e.message);
    }
}

// --- 2. EXPORT FULL LIST (WITH EVERY SINGLE MARK) ---
function exportMasterResultSheet() {
    try {
        let sourceData = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
        if (!sourceData || sourceData.length === 0) { alert("No data to export! Please Generate Sample Data first."); return; }

        const criteriaList = getSafeRubricList();
        
        // --- 1. BUILD HEADERS (DYNAMICALLY) ---
        let csv = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        
        // Loop 5 Judges
        for(let j=1; j<=5; j++) {
            // Add columns: J1-Thilawa, J1-Tajweed, etc.
            criteriaList.forEach(c => {
                csv += `J${j}-${c.name},`;
            });
            // Add Judge Total
            csv += `J${j}-TOTAL,`;
        }
        
        csv += "GRAND TOTAL (5 Judges),FINAL AVERAGE,RANK,REMARKS\n";

        // Sort by Rank
        sourceData.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));

        // --- 2. BUILD ROWS ---
        sourceData.forEach((s, idx) => {
            let row = [];
            
            // Student Info
            row.push(
                idx + 1, 
                `"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, 
                `"${s.instType||s.institution||''}"`, // Institution Type
                `"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, 
                `"${s.id||''}"`, `"${s.phone||''}"`, 
                `"${s.parent||''}"`, `"${s.parentPhone||''}"`, `"${s.email||''}"`
            );

            let grandTotal = 0;
            let activeJudges = 0;

            // Loop 5 Judges
            for(let j=1; j<=5; j++) {
                let jKey = `Judge_${j}`;
                let jTotalCalculated = 0;

                // Loop Criteria (Thilawa, Tajweed...)
                criteriaList.forEach(c => {
                    let markVal = "";
                    // Retrieve the specific mark we generated earlier
                    if(s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][c.name] !== undefined) {
                        markVal = s.detailedScores[jKey][c.name];
                        jTotalCalculated += parseFloat(markVal);
                    }
                    // ‚òÖ PUSH MARK TO CSV CELL ‚òÖ
                    row.push(markVal);
                });

                // Push Judge Total
                // Use calculated total from details if available, else fallback to score object
                let displayTotal = jTotalCalculated > 0 ? jTotalCalculated.toFixed(2) : (s.scores && s.scores[jKey] ? s.scores[jKey] : "");
                row.push(displayTotal);

                if(parseFloat(displayTotal) > 0) {
                    grandTotal += parseFloat(displayTotal);
                    activeJudges++;
                }
            }

            // Final Stats
            let finalAvg = s.finalScore || (activeJudges > 0 ? (grandTotal/activeJudges).toFixed(2) : 0);
            row.push(grandTotal.toFixed(2), finalAvg, idx + 1, "");
            
            csv += row.join(",") + "\n";
        });

        // --- 3. DOWNLOAD ---
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Rasfahi_FULL_ORIGINAL_DATA_SAMPLE_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch(e) {
        alert("Export Error: " + e.message);
    }
}
    // =========================================================================
// ‚òÖ FINAL SOLUTION: FORCE ENGLISH KEYS FOR PERFECT EXPORT ‚òÖ
// =========================================================================

// 1. Define Standard Keys (To ensure Generator & Exporter match 100%)
const STANDARD_KEYS = [
    { id: "Thilawa", label: "ﬁåﬁ®ﬁçﬁßﬁàﬁ¶ﬁåﬁ™ (Thilawa)" },
    { id: "Tajweed", label: "ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™ (Tajweed)" },
    { id: "Makhraj", label: "ﬁâﬁ¶ﬁöﬁ∞ﬁÉﬁ¶ﬁñﬁ∞ (Makhraj)" },
    { id: "Sifa", label: "ﬁûﬁ®ﬁäﬁ¶ (Sifa)" },
    { id: "Fasaha", label: "ﬁäﬁ¶ﬁûﬁßﬁôﬁß (Fasaha)" },
    { id: "Talaffuz", label: "ﬁåﬁ¶ﬁçﬁ¶ﬁáﬁ∞ﬁäﬁ™ﬁíﬁ∞ (Talaffuz)" },
    { id: "Maqamat", label: "ﬁâﬁ¶ﬁ§ﬁßﬁâﬁßﬁåﬁ™ (Maqamat)" }
];

// --- 2. GENERATE DATA (Using Simple IDs) ---
function generateDummyMasterSheet() {
    try {
        if(typeof state === 'undefined') { alert("State Error!"); return; }
        
        state.allStudents = []; 
        state.judging.savedResults = []; 

        const instTypes = ["School", "Office", "NGO", "University", "Private"];
        const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath"];

        for (let i = 1; i <= 500; i++) {
            let sObj = {
                serial: i, reg: `REG-${1000 + i}`,
                name: `${names[i % names.length]} ${i}`, 
                instType: instTypes[i % instTypes.length],
                institution: instTypes[i % instTypes.length],
                group: "General", branch: "Balaiygen",
                gender: (i%2==0)?"Female":"Male",
                
                detailedScores: {}, scores: {}, finalScore: 0
            };

            let grandSum = 0;

            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                sObj.detailedScores[jKey] = {}; 
                let jTotal = 0;

                // ‚òÖ FORCE SAVE USING SIMPLE IDS (Thilawa, Tajweed...) ‚òÖ
                STANDARD_KEYS.forEach(crit => {
                    // Random Mark (0 to 10 for simplicity in dummy)
                    let mark = parseFloat((Math.random() * 10).toFixed(1));
                    
                    // Save as "Thilawa" (Not the long Dhivehi string)
                    sObj.detailedScores[jKey][crit.id] = mark; 
                    
                    jTotal += mark;
                });

                sObj.scores[jKey] = parseFloat(jTotal.toFixed(2));
                grandSum += jTotal;
            }

            sObj.finalScore = parseFloat((grandSum / 5).toFixed(2));
            state.allStudents.push(sObj);
            state.judging.savedResults.push(sObj);
        }

        saveToLocal();
        alert("‚úÖ Generated Clean Data with English Keys (Thilawa, Tajweed...)");
    } catch (e) {
        alert("Gen Error: " + e.message);
    }
}

// --- 3. EXPORT MATRIX (Looking for Simple IDs) ---
function downloadRubricMatrix() {
    try {
        let data = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
        if (!data || data.length === 0) { alert("‚ö†Ô∏è No Data! Click 'Generate Dummy Data' first."); return; }

        // Build Header
        let csv = "Serial,Reg No,Name,Institution Type,Gender,";
        
        // Loop Judges
        for (let j = 1; j <= 5; j++) {
            STANDARD_KEYS.forEach(k => {
                // Header can show the Dhivehi Label if you want
                csv += `J${j}-${k.label},`; 
            });
            csv += `J${j}-TOTAL,`;
        }
        csv += "FINAL AVERAGE\n";

        // Build Rows
        data.forEach((s, idx) => {
            let row = [
                idx + 1, `"${s.reg}"`, `"${s.name}"`, `"${s.instType}"`, `"${s.gender}"`
            ];

            let grandTotal = 0;
            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                let jTotalCalculated = 0;

                STANDARD_KEYS.forEach(k => {
                    let val = "";
                    // ‚òÖ LOOK FOR THE SIMPLE ID (Thilawa) ‚òÖ
                    if(s.detailedScores && s.detailedScores[jKey]) {
                        // Check Exact ID
                        if (s.detailedScores[jKey][k.id] !== undefined) val = s.detailedScores[jKey][k.id];
                        // Fallback: Check Label
                        else if (s.detailedScores[jKey][k.label] !== undefined) val = s.detailedScores[jKey][k.label];
                    }
                    
                    row.push(val); 
                    if(val !== "" && !isNaN(val)) jTotalCalculated += parseFloat(val);
                });

                let displayTotal = jTotalCalculated > 0 ? jTotalCalculated.toFixed(2) : (s.scores[jKey] || "0.00");
                row.push(displayTotal);
                if(parseFloat(displayTotal)>0) grandTotal += parseFloat(displayTotal);
            }
            row.push((grandTotal/5).toFixed(2));
            csv += row.join(",") + "\n";
        });

        // Download
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_CLEAN_Matrix.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (e) {
        alert("Export Error: " + e.message);
    }
}
// =========================================================================
// ‚òÖ SMART SCRIPT: READS YOUR RUBRIC SETTINGS AUTOMATICALLY ‚òÖ
// =========================================================================

// 1. Generate Dummy Data (Reads from judging.rubric)
function generateDummyMasterSheet() {
    try {
        if(typeof state === 'undefined') { alert("State Error!"); return; }
        
        state.allStudents = []; 
        state.judging.savedResults = []; 

        // ‚òÖ THIS LINE READS YOUR SETTINGS AUTOMATICALLY ‚òÖ
        // It grabs "Thilawa", "Quality", etc. from the code you just edited.
        let activeRubric = state.judging.rubric; 

        if (!activeRubric || activeRubric.length === 0) {
            alert("‚ö†Ô∏è Rubric settings not found!"); return;
        }

        const instTypes = ["School", "Office", "NGO", "University", "Private"];
        const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath"];

        for (let i = 1; i <= 500; i++) {
            let sObj = {
                serial: i, reg: `REG-${1000 + i}`,
                name: `${names[i % names.length]} ${i}`, 
                instType: instTypes[i % instTypes.length],
                institution: instTypes[i % instTypes.length],
                group: "General", branch: "Balaiygen",
                gender: (i%2==0)?"Female":"Male",
                detailedScores: {}, scores: {}, finalScore: 0
            };

            let grandSum = 0;

            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                sObj.detailedScores[jKey] = {}; 
                let jTotal = 0;

                // Loop through your settings
                activeRubric.forEach(crit => {
                    let mark = parseFloat((Math.random() * crit.max).toFixed(1));
                    sObj.detailedScores[jKey][crit.name] = mark; 
                    jTotal += mark;
                });

                sObj.scores[jKey] = parseFloat(jTotal.toFixed(2));
                grandSum += jTotal;
            }

            sObj.finalScore = parseFloat((grandSum / 5).toFixed(2));
            state.allStudents.push(sObj);
            state.judging.savedResults.push(sObj);
        }

        saveToLocal();
        alert(`‚úÖ Generated Data for ${activeRubric.length} Categories (Including Quality!)`);

    } catch (e) {
        alert("Gen Error: " + e.message);
    }
}

// 2. Export Matrix (Also reads from judging.rubric)
function downloadRubricMatrix() {
    try {
        let data = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
        if (!data || data.length === 0) { alert("‚ö†Ô∏è No Data!"); return; }

        // ‚òÖ READ SETTINGS AGAIN ‚òÖ
        let rubricNames = state.judging.rubric.map(r => r.name);

        // Header
        let csv = "Serial,Reg No,Name,Institution Type,Gender,";
        for (let j = 1; j <= 5; j++) {
            rubricNames.forEach(name => { csv += `J${j}-${name},`; });
            csv += `J${j}-TOTAL,`;
        }
        csv += "FINAL AVERAGE\n";

        // Rows
        data.forEach((s, idx) => {
            let row = [idx + 1, `"${s.reg}"`, `"${s.name}"`, `"${s.instType}"`, `"${s.gender}"`];
            let grandTotal = 0;
            
            for (let j = 1; j <= 5; j++) {
                let jKey = `Judge_${j}`;
                let jTotalCalculated = 0;

                rubricNames.forEach(name => {
                    let val = "";
                    if (s.detailedScores && s.detailedScores[jKey]) {
                        val = s.detailedScores[jKey][name];
                    }
                    row.push(val); 
                    if(val !== "" && !isNaN(val)) jTotalCalculated += parseFloat(val);
                });

                let displayTotal = jTotalCalculated > 0 ? jTotalCalculated.toFixed(2) : (s.scores[jKey] || "0.00");
                row.push(displayTotal);
                if(parseFloat(displayTotal)>0) grandTotal += parseFloat(displayTotal);
            }
            row.push((grandTotal/5).toFixed(2));
            csv += row.join(",") + "\n";
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_Final_Matrix.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (e) {
        alert("Export Error: " + e.message);
    }
}

    // --- GENERATE CONSOLIDATED RUBRIC PDF (5-7 JUDGES) ---
function printConsolidatedRubricSheet() {
    // 1. ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    let students = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
    
    // ﬁêﬁØﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÇﬁ∞ ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ© ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÇﬁ∞)
    students.sort((a, b) => b.finalScore - a.finalScore);

    if (!students || students.length === 0) {
        alert("ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!");
        return;
    }

    // 2. ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ (ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ≠ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞) ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    // ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁëﬁ®ﬁäﬁØﬁçﬁ∞ﬁìﬁ∞ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨
    const rubric = (state.judging.rubric && state.judging.rubric.length > 0) 
                   ? state.judging.rubric 
                   : [
                       { name: "Thilawa", max: 30 }, 
                       { name: "Tajweed", max: 20 }, 
                       { name: "Makhraj", max: 20 }, 
                       { name: "Sifa", max: 10 }, 
                       { name: "Fasaha", max: 10 }, 
                       { name: "Talaffuz", max: 5 }, 
                       { name: "Maqamat", max: 5 }
                   ];

    // 3. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ™ﬁÇﬁ∞ (ﬁâﬁ®ﬁêﬁßﬁçﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ 7)
    const judgeCount = 7; 

    // 4. HTML ﬁÑﬁ®ﬁÇﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let contentHtml = "";

    students.forEach((s, idx) => {
        // --- HEADER INFO ---
        let headerInfo = `
            <div class="sheet-header">
                <h1>${document.getElementById('rptInstName').value || "Quran Competition"}</h1>
                <h2>Consolidated Score Sheet (Detailed)</h2>
                
                <div class="meta-grid">
                    <div><strong>Name:</strong> ${s.name}</div>
                    <div><strong>Reg No:</strong> ${s.reg}</div>
                    <div><strong>Rank:</strong> ${idx + 1}</div>
                    <div><strong>Group:</strong> ${s.group}</div>
                    <div><strong>Branch:</strong> ${s.branch}</div>
                    <div><strong>Final Score:</strong> ${s.finalScore}</div>
                </div>
            </div>
        `;

        // --- TABLE HEADERS ---
        let tableHeader = `
            <tr>
                <th style="width:150px; text-align:left;">Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)</th>
                <th style="width:50px;">Max</th>
        `;
        
        // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁáﬁ¶ﬁÅﬁ∞ ﬁçﬁ™ﬁÇﬁ∞
        for(let j=1; j<=judgeCount; j++) {
            tableHeader += `<th>J-${j}</th>`;
        }
        tableHeader += `<th style="background:#e0f7fa;">AVG</th></tr>`;

        // --- TABLE ROWS (CRITERIA SCORES) ---
        let tableRows = "";
        let totalMax = 0;
        let judgeTotals = {}; // To store total per judge (J1 Total, J2 Total...)

        // Initialize judge totals
        for(let j=1; j<=judgeCount; j++) judgeTotals[`Judge_${j}`] = 0;

        rubric.forEach(r => {
            totalMax += r.max;
            let row = `<tr>
                        <td style="text-align:left; font-weight:bold;">${r.name}</td>
                        <td style="font-weight:bold;">${r.max}</td>`;
            
            let criteriaSum = 0;
            let activeJudgesForCrit = 0;

            // Loop Judges Columns
            for(let j=1; j<=judgeCount; j++) {
                let jKey = `Judge_${j}`;
                let score = "-";
                
                // ﬁëﬁ©ﬁìﬁ¨ﬁáﬁ®ﬁçﬁ∞ﬁëﬁ∞ ﬁêﬁ∞ﬁÜﬁØﬁÉﬁêﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
                if(s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                    score = s.detailedScores[jKey][r.name];
                    // Add to totals
                    judgeTotals[jKey] += parseFloat(score);
                    criteriaSum += parseFloat(score);
                    activeJudgesForCrit++;
                }
                
                row += `<td>${score}</td>`;
            }

            // Criteria Average
            let cAvg = activeJudgesForCrit > 0 ? (criteriaSum / activeJudgesForCrit).toFixed(2) : "-";
            row += `<td style="font-weight:bold; background:#e0f7fa;">${cAvg}</td></tr>`;
            
            tableRows += row;
        });

        // --- TOTALS ROW ---
        let totalRow = `<tr style="background:#333; color:#fff; font-weight:bold;">
                            <td style="text-align:right;">GRAND TOTAL</td>
                            <td>${totalMax}</td>`;
        
        let grandSum = 0;
        let activeJ = 0;

        for(let j=1; j<=judgeCount; j++) {
            let jKey = `Judge_${j}`;
            let val = judgeTotals[jKey];
            let display = val > 0 ? val.toFixed(2) : "-";
            totalRow += `<td>${display}</td>`;

            if(val > 0) { grandSum += val; activeJ++; }
        }

        let finalAvg = activeJ > 0 ? (grandSum / activeJ).toFixed(2) : "0.00";
        totalRow += `<td style="background:#006064; color:#fff; font-size:16px;">${finalAvg}</td></tr>`;

        // --- COMBINE PER STUDENT ---
        contentHtml += `
            <div class="page">
                ${headerInfo}
                <table>
                    <thead>${tableHeader}</thead>
                    <tbody>${tableRows}${totalRow}</tbody>
                </table>
                <div class="footer-note">
                    System Generated Report | Rasfahi V26.0
                </div>
            </div>
        `;
    });

    // 5. ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ™ﬁÇﬁ∞
    const w = window.open("", "ConsolidatedRubric", "width=1200,height=900");
    w.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="dv">
        <head>
            <title>Detailed Judge Rubrics</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                body { font-family: 'Noto Sans Thaana', sans-serif; background: #ccc; margin: 0; padding: 20px; }
                
                .page {
                    background: white; width: 297mm; min-height: 210mm; /* A4 Landscape */
                    padding: 20px; margin: 0 auto 20px auto;
                    box-shadow: 0 0 10px rgba(0,0,0,0.2); page-break-after: always;
                    box-sizing: border-box; display: flex; flex-direction: column;
                }
                
                .sheet-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
                h1 { margin: 0; font-size: 24px; }
                h2 { margin: 5px 0; font-size: 18px; color: #555; }

                .meta-grid {
                    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
                    background: #f0f0f0; padding: 10px; border: 1px solid #999; margin-top: 10px;
                    font-size: 14px; text-align: left; direction: ltr; /* English text alignment */
                }

                table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; direction: ltr; }
                th, td { border: 1px solid #444; padding: 8px; text-align: center; }
                th { background: #eee; }

                .footer-note { margin-top: auto; text-align: center; font-size: 10px; color: #aaa; padding-top: 20px; }

                @media print {
                    body { background: none; padding: 0; }
                    .page { margin: 0; box-shadow: none; width: 100%; height: 100%; }
                    button { display: none; }
                    @page { size: A4 landscape; margin: 10mm; }
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" style="position:fixed; top:20px; left:20px; padding:15px; background:navy; color:white; font-size:18px; cursor:pointer; z-index:999;">üñ®Ô∏è SAVE AS PDF</button>
            ${contentHtml}
        </body>
        </html>
    `);
    w.document.close();
}
    // --- 5. PRINT FULL DETAILED RUBRIC SHEET (PER STUDENT) ---
function printFullRubricBreakdown() {
    // 1. ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    let students = state.allStudents.length > 0 ? state.allStudents : state.judging.savedResults;
    
    // ﬁêﬁØﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÇﬁ∞)
    students.sort((a, b) => b.finalScore - a.finalScore);

    if (!students || students.length === 0) {
        alert("ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁëﬁ≠ﬁìﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!");
        return;
    }

    // 2. ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ (ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ≠ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞) ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const rubric = (state.judging.rubric && state.judging.rubric.length > 0) 
                   ? state.judging.rubric 
                   : [
                       { name: "Thilawa", max: 30 }, 
                       { name: "Tajweed", max: 20 }, 
                       { name: "Makhraj", max: 20 }, 
                       { name: "Sifa", max: 10 }, 
                       { name: "Fasaha", max: 10 }, 
                       { name: "Talaffuz", max: 5 }, 
                       { name: "Maqamat", max: 5 }
                   ];

    // 3. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁãﬁ¶ﬁãﬁ™ (System Setting or Default 5)
    const judgeCount = parseInt(document.getElementById('rptJudgeCount')?.value) || 5; 

    // 4. HTML ﬁÑﬁ®ﬁÇﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let contentHtml = "";

    students.forEach((s, idx) => {
        // --- HEADER INFO ---
        let headerInfo = `
            <div class="sheet-header">
                <h1>${document.getElementById('rptInstName').value || "Quran Competition"}</h1>
                <h2>ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁßﬁéﬁ¨ ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ™ (Consolidated Rubric Sheet)</h2>
                
                <div class="meta-grid">
                    <div><strong>ﬁÇﬁ¶ﬁÇﬁ∞:</strong> ${s.name}</div>
                    <div><strong>ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©:</strong> ${s.reg}</div>
                    <div><strong>ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞:</strong> ${idx + 1}</div>
                    <div><strong>ﬁéﬁÆﬁäﬁ®:</strong> ${s.branch}</div>
                    <div><strong>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™:</strong> ${s.group}</div>
                    <div><strong>ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶:</strong> ${s.finalScore}</div>
                </div>
            </div>
        `;

        // --- TABLE HEADERS ---
        let tableHeader = `
            <tr>
                <th style="width:200px; text-align:left;">Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)</th>
                <th style="width:50px;">Max</th>
        `;
        
        // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁáﬁ¶ﬁÅﬁ∞ ﬁçﬁ™ﬁÇﬁ∞
        for(let j=1; j<=judgeCount; j++) {
            tableHeader += `<th>Judge ${j}</th>`;
        }
        tableHeader += `<th style="background:#e0f7fa;">AVG</th></tr>`;

        // --- TABLE ROWS (CRITERIA SCORES) ---
        let tableRows = "";
        let totalMax = 0;
        
        // To verify Grand Totals
        let judgeColumnTotals = {}; 
        for(let j=1; j<=judgeCount; j++) judgeColumnTotals[`Judge_${j}`] = 0;

        rubric.forEach(r => {
            totalMax += r.max;
            let row = `<tr>
                        <td style="text-align:left; font-weight:bold; font-family:'Faruuma'; font-size:16px;">${r.name}</td>
                        <td style="font-weight:bold;">${r.max}</td>`;
            
            let criteriaSum = 0;
            let activeJudgesForCrit = 0;

            // Loop Judges Columns
            for(let j=1; j<=judgeCount; j++) {
                let jKey = `Judge_${j}`;
                let score = "-";
                
                // ﬁëﬁ©ﬁìﬁ¨ﬁáﬁ®ﬁçﬁ∞ﬁëﬁ∞ ﬁêﬁ∞ﬁÜﬁØﬁÉﬁêﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
                if(s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                    score = s.detailedScores[jKey][r.name];
                    
                    // Add to totals
                    let flt = parseFloat(score);
                    if(!isNaN(flt)) {
                        judgeColumnTotals[jKey] += flt;
                        criteriaSum += flt;
                        activeJudgesForCrit++;
                    }
                }
                
                row += `<td>${score}</td>`;
            }

            // Criteria Average (Horizontal Average)
            let cAvg = activeJudgesForCrit > 0 ? (criteriaSum / activeJudgesForCrit).toFixed(2) : "-";
            row += `<td style="font-weight:bold; background:#e0f7fa;">${cAvg}</td></tr>`;
            
            tableRows += row;
        });

        // --- TOTALS ROW (BOTTOM) ---
        let totalRow = `<tr style="background:#333; color:#fff; font-weight:bold;">
                            <td style="text-align:right;">GRAND TOTAL</td>
                            <td>${totalMax}</td>`;
        
        let grandSum = 0;
        let activeJ = 0;

        for(let j=1; j<=judgeCount; j++) {
            let jKey = `Judge_${j}`;
            let val = judgeColumnTotals[jKey];
            
            // If total is 0, check if manual override score exists
            if(val === 0 && s.scores && s.scores[jKey]) {
                val = parseFloat(s.scores[jKey]);
            }

            let display = val > 0 ? val.toFixed(2) : "-";
            totalRow += `<td>${display}</td>`;

            if(val > 0) { grandSum += val; activeJ++; }
        }

        let finalAvg = activeJ > 0 ? (grandSum / activeJ).toFixed(2) : s.finalScore;
        totalRow += `<td style="background:#006064; color:#fff; font-size:18px;">${finalAvg}</td></tr>`;

        // --- COMBINE PER STUDENT ---
        contentHtml += `
            <div class="page">
                ${headerInfo}
                <table>
                    <thead>${tableHeader}</thead>
                    <tbody>${tableRows}${totalRow}</tbody>
                </table>
                
                <div style="margin-top:40px; display:flex; justify-content:space-between;">
                    <div style="text-align:center; width:200px;">
                        <hr style="border:1px solid #000;">
                        ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™
                    </div>
                    <div style="text-align:center; width:200px;">
                        <hr style="border:1px solid #000;">
                        ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ / ﬁÜﬁÆﬁâﬁ®ﬁìﬁ©
                    </div>
                </div>

                <div class="footer-note">
                    System Generated Report | Rasfahi V26.0
                </div>
            </div>
        `;
    });

    // 5. ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞ ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ™ﬁÇﬁ∞
    const w = window.open("", "ConsolidatedRubric", "width=1200,height=900");
    w.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="dv">
        <head>
            <title>Detailed Rubric Sheets</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                /* Faruuma Font Injection */
                @font-face { font-family: 'Faruuma'; src: local('Faruuma'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css'); }

                body { font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif; background: #ccc; margin: 0; padding: 20px; }
                
                .page {
                    background: white; width: 297mm; min-height: 210mm; /* A4 Landscape */
                    padding: 40px; margin: 0 auto 20px auto;
                    box-shadow: 0 0 10px rgba(0,0,0,0.2); page-break-after: always;
                    box-sizing: border-box; display: flex; flex-direction: column;
                }
                
                .sheet-header { text-align: center; border-bottom: 2px double #000; padding-bottom: 10px; margin-bottom: 20px; }
                h1 { margin: 0; font-size: 26px; text-decoration:underline; }
                h2 { margin: 5px 0; font-size: 20px; color: #444; }

                .meta-grid {
                    display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
                    background: #f0f0f0; padding: 15px; border: 1px solid #999; margin-top: 15px;
                    font-size: 16px; text-align: right; font-weight:bold;
                }

                table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 20px; direction: ltr; }
                th, td { border: 1px solid #444; padding: 10px; text-align: center; }
                th { background: #eee; font-size:15px; }

                .footer-note { margin-top: auto; text-align: center; font-size: 12px; color: #aaa; padding-top: 20px; }

                @media print {
                    body { background: none; padding: 0; }
                    .page { margin: 0; box-shadow: none; width: 100%; height: 100%; }
                    button { display: none; }
                    @page { size: A4 landscape; margin: 10mm; }
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" style="position:fixed; top:20px; left:20px; padding:15px; background:navy; color:white; font-size:18px; cursor:pointer; z-index:999;">üñ®Ô∏è PRINT ALL SHEETS</button>
            ${contentHtml}
        </body>
        </html>
    `);
    w.document.close();
}
    // --- FIXED SAVE FUNCTION: SAVES DETAILED BREAKDOWN (CRITICAL FIX) ---
function saveSecretaryScore() {
    // 1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ™ﬁÇﬁ∞
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first! (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß)");
        return;
    }

    const judgeID = document.getElementById('secJudgeSelect').value; // e.g. "Judge_1"
    const currentID = state.judging.currentStudentObj.id;
    
    // 2. ﬁÜﬁßﬁëﬁ™ﬁåﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ® ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ (CRITICAL STEP)
    let totalScore = 0;
    
    // ﬁâﬁ® ﬁáﬁÆﬁÑﬁ∞ﬁñﬁ¨ﬁÜﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁÖﬁßﬁÇﬁ©: { "Thilawa": 29, "Tajweed": 19... }
    let detailsObj = {}; 

    // ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁáﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ®ﬁÇﬁ∞ ﬁÇﬁ¶ﬁéﬁ¶ﬁáﬁ® ﬁÉﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    if(state.judging.rubric && typeof secScores !== 'undefined') {
        state.judging.rubric.forEach((r, idx) => {
            // ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÑﬁ¶ﬁáﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁàﬁ¶ﬁÜﬁ®ﬁÇﬁ∞ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Max - Deducted)
            // ﬁâﬁ®ﬁêﬁßﬁçﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞: 30 - 1 = 29
            const val = secScores[idx].max - secScores[idx].deducted;
            
            // ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®: ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ™ ﬁáﬁÆﬁÑﬁ∞ﬁñﬁ¨ﬁÜﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ (e.g. "Thilawa") ﬁáﬁßﬁáﬁ¨ﬁÜﬁ™ ﬁçﬁ™ﬁÇﬁ∞
            detailsObj[r.name] = parseFloat(val.toFixed(2));
            
            totalScore += val;
        });
    } else {
        totalScore = 0;
    }
    
    totalScore = parseFloat(totalScore.toFixed(2));

    // 3. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁâﬁ¨ﬁâﬁ¶ﬁÉﬁ© (Live Judge View) ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    if (!state.judging.liveScores) state.judging.liveScores = {};
    state.judging.liveScores[judgeID] = totalScore;

    // 4. ‚òÖ ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ™ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (THE FIX) ‚òÖ
    // ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁ™ﬁÇﬁ∞ ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁÜﬁÆﬁçﬁ¶ﬁâﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁÉﬁßﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨.
    
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);

    if (sIdx > -1) {
        // A. ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Totals)
        if (!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
        state.allStudents[sIdx].scores[judgeID] = totalScore;

        // B. ‚òÖ ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Details) ‚òÖ
        if (!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};
        
        // ﬁñﬁ¶ﬁñﬁ™ ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁáﬁ¶ﬁÅﬁ∞ ﬁÇﬁ®ﬁêﬁ∞ﬁÑﬁ¶ﬁåﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ™ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
        // ﬁâﬁ®ﬁÄﬁ¨ﬁÇﬁ∞ ﬁÄﬁ¨ﬁãﬁ©ﬁâﬁß Judge 1 ﬁéﬁ¨ Thilawa ﬁáﬁßﬁáﬁ® Judge 2 ﬁéﬁ¨ Thilawa ﬁàﬁ¶ﬁÜﬁ®ﬁÇﬁ∞ ﬁäﬁ¨ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨
        state.allStudents[sIdx].detailedScores[judgeID] = detailsObj; 

        // C. ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁàﬁ¶ﬁéﬁ™ﬁåﬁ™ﬁÇﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
        let sum = 0; let count = 0;
        for (let j in state.allStudents[sIdx].scores) {
            let v = state.allStudents[sIdx].scores[j];
            if(v > 0) { sum += v; count++; }
        }
        state.allStudents[sIdx].finalScore = count > 0 ? parseFloat((sum / count).toFixed(2)) : 0;
    }

    // 5. ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    saveToLocal(); 
    
    // ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÉﬁ®ﬁäﬁ∞ﬁÉﬁ¨ﬁùﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    if(typeof renderMasterTable === 'function') {
        renderMasterTable(); 
    }

    // 6. ﬁàﬁ®ﬁùﬁ™ﬁáﬁ¶ﬁçﬁ∞ ﬁäﬁ©ﬁëﬁ∞ﬁÑﬁ¨ﬁÜﬁ∞ (ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁáﬁ¶ﬁÅﬁ∞)
    const saveBtn = document.querySelector('#secretaryPanel .btn-green') || document.getElementById('btnSaveNext');
    if(saveBtn) {
        const oldTxt = saveBtn.innerText;
        saveBtn.innerText = `‚úÖ SAVED! (${totalScore})`;
        saveBtn.style.background = "#fff";
        saveBtn.style.color = "#000";
        
        setTimeout(() => {
            saveBtn.innerText = oldTxt;
            saveBtn.style.background = ""; 
            saveBtn.style.color = "";
        }, 1500);
    }
}
    // ﬁâﬁ® ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ¶ﬁÜﬁ© ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ (Detailed Report) ﬁéﬁ¨ HTML ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁáﬁ™ﬁäﬁ¶ﬁáﬁ∞ﬁãﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ¨ﬁàﬁ¨.
function generateDetailedReportHTML(student) {
    
    // 1. ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ (Rubric) ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ™ﬁÇﬁ∞
    if (!state.judging.rubric) return "<p>No rubric found.</p>";

    // 2. ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ﬁéﬁ¨ ﬁÑﬁÆﬁçﬁ™ (Header) ﬁÄﬁ¨ﬁãﬁ™ﬁÇﬁ∞: Category | Judge 1 | Judge 2 | ... | Average
    let html = `
    <table border="1" style="width:100%; border-collapse: collapse; text-align: center;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="padding: 8px; text-align: left;">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>`;

    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ ﬁáﬁ¶ﬁÅﬁ∞ ﬁçﬁ™ﬁÇﬁ∞ (Judge 1, Judge 2, Judge 3...)
    const judges = ["Judge_1", "Judge_2", "Judge_3"]; // ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁß ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁãﬁßﬁÇﬁ¨
    
    judges.forEach(jID => {
        html += `<th style="padding: 8px;">${jID.replace('_', ' ')}</th>`;
    });

    // ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁÜﬁÆﬁçﬁ¶ﬁâﬁ∞
    html += `<th style="padding: 8px;">ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞</th>
            </tr>
        </thead>
        <tbody>`;

    // 3. ﬁÉﬁ™ﬁÑﬁ∞ﬁÉﬁ®ﬁÜﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁçﬁ´ﬁïﬁ∞ ﬁñﬁ¶ﬁÄﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    // student.detailedScores ﬁéﬁ¶ﬁáﬁ® ﬁëﬁ≠ﬁìﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    const details = student.detailedScores || {};

    state.judging.rubric.forEach(criteria => {
        const criteriaName = criteria.name; // e.g., "Thilawa"
        
        html += `<tr>
                    <td style="padding: 8px; text-align: left; font-weight:bold;">${criteriaName}</td>`;

        let rowSum = 0;
        let rowCount = 0;

        // ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁñﬁ¶ﬁñﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁáﬁ¶ﬁåﬁ™ﬁÇﬁ∞ ﬁâﬁ® ﬁÑﬁ¶ﬁîﬁ¶ﬁÅﬁ∞ (e.g. Thilawa) ﬁãﬁ©ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÄﬁØﬁãﬁ™ﬁÇﬁ∞
        judges.forEach(jID => {
            let score = "-"; // ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁÇﬁ© -
            
            // ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®: Detailed Scores ﬁåﬁ¨ﬁÉﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ ‚òÖ
            if (details[jID] && details[jID][criteriaName] !== undefined) {
                score = details[jID][criteriaName];
                
                // ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁÄﬁ¨ﬁãﬁ™ﬁâﬁ¶ﬁÅﬁ∞ﬁìﬁ¶ﬁÜﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
                rowSum += score;
                rowCount++;
            }

            html += `<td style="padding: 8px;">${score}</td>`;
        });

        // ﬁâﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ (Row) ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁÄﬁ®ﬁêﬁßﬁÑﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
        const rowAvg = rowCount > 0 ? (rowSum / rowCount).toFixed(2) : "0.00";
        
        html += `<td style="padding: 8px; font-weight:bold;">${rowAvg}</td>
                 </tr>`;
    });

    // 4. ﬁäﬁ¶ﬁÄﬁ™ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (Grand Total)
    html += `<tr style="background-color: #e0e0e0; font-weight: bold;">
                <td style="padding: 8px; text-align: right;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶:</td>`;
    
    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞
    let finalSum = 0;
    let finalCount = 0;

    judges.forEach(jID => {
        let total = (student.scores && student.scores[jID]) ? student.scores[jID] : 0;
        if(total > 0) { finalSum += total; finalCount++; }
        html += `<td style="padding: 8px;">${total}</td>`;
    });

    // ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞
    const finalAvg = finalCount > 0 ? (finalSum / finalCount).toFixed(2) : "0.00";
    html += `<td style="padding: 8px; font-size: 1.2em;">${finalAvg}</td>
             </tr>`;

    html += `</tbody></table>`;
    
    return html;
}
// ======================================================
// ‚òÖ UPDATED DATA TOOLS (MATCHING UPLOADED CSV FORMAT) ‚òÖ
// ======================================================

// --- 1. BLANK TEMPLATE GENERATOR ---
function downloadMasterCSVTemplate() {
    try {
        // Criteria List (Must match the columns in your CSV)
        const criteriaList = ["Thilawa", "Tajweed", "Makhraj", "Sifa", "Fasaha", "Talaffuz", "Maqamat"];
        
        // 1. Build Headers
        let csv = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
        
        // 5 Judges Columns (Criteria + Total)
        for (let j = 1; j <= 5; j++) {
            criteriaList.forEach(c => { csv += `J${j}-${c},`; });
            csv += `J${j}-TOTAL,`;
        }
        
        // Final Summary Headers
        csv += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

        // 2. Create Sample Row (Blank Scores)
        let row = ["1", "REG-001", "Under 6", "Balaiygen", "School", "Student Name", "Male", "Male'", "AXXXXXX", "7770000", "Parent Name", "7770000", "email@test.com"];
        
        // Add Empty Cells for Scores
        // (7 Criteria + 1 Total) * 5 Judges = 40 Empty Cells
        for(let i=0; i < 40; i++) row.push(""); 
        
        // Final Summary Empty Cells
        row.push("","","","");

        csv += row.join(",") + "\n";

        // 3. Download File
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `Rasfahi_Master_Template.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (e) { alert("Error generating template: " + e.message); }
}

// --- 2. DUMMY DATA GENERATOR (2000 STUDENTS - FULL DETAILS) ---
function generateDetailedRankedCSV() {
    // 1. Reset System Memory
    state.allStudents = []; 
    state.judging.savedResults = []; 

    // 2. Criteria Configuration (Matching your Rubric)
    const criteriaConfig = [
        { name: "Thilawa", max: 30 },
        { name: "Tajweed", max: 20 },
        { name: "Makhraj", max: 20 },
        { name: "Sifa", max: 10 },
        { name: "Fasaha", max: 10 },
        { name: "Talaffuz", max: 5 },
        { name: "Maqamat", max: 5 }
    ];

    // 3. Prepare CSV Header
    let csvContent = "Serial No,Reg No,Age Group,Branch,Institution Type,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";
    
    // Judge Headers
    for (let j = 1; j <= 5; j++) {
        criteriaConfig.forEach(c => csvContent += `J${j}-${c.name},`);
        csvContent += `J${j}-TOTAL,`;
    }
    csvContent += "GRAND TOTAL,FINAL AVERAGE,RANK,REMARKS\n";

    // 4. Random Data Pools
    const names = ["Ahmed", "Ali", "Hassan", "Ibrahim", "Fathimath", "Aishath", "Mariyam", "Zainab"];
    const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "Under 16", "Under 19", "General"];
    const branches = ["Balaiygen", "Nubalai"];
    const instTypes = ["School", "Office", "NGO", "University", "Private"];

    // 5. Generate 2000 Rows Loop
    for (let i = 1; i <= 2000; i++) {
        const name = names[i % names.length];
        const iType = instTypes[i % instTypes.length];
        
        // Create Student Object
        let studentObj = {
            serial: i, reg: `REG-${1000 + i}`,
            name: `${name} ${i}`, id: `A000${i}`, gender: (i%2==0)?"Female":"Male",
            group: groups[i % groups.length], branch: branches[i % branches.length],
            institution: iType, instType: iType,
            address: "Male'", contact: "7770000", parent: "Parent", pPhone: "7770000", email: "test@mail.com",
            scores: {}, detailedScores: {}, finalScore: 0
        };

        // Mark Generation Logic
        let ability = Math.random() * (0.98 - 0.60) + 0.60; // Random Skill Level
        let grandTotal = 0;
        let csvScoreString = "";

        // Loop 5 Judges
        for (let j = 1; j <= 5; j++) {
            let jKey = `Judge_${j}`;
            let judgeTotal = 0;
            let variance = (Math.random() * 0.1) - 0.05; // Human variance
            
            studentObj.detailedScores[jKey] = {};

            // Loop Criteria
            criteriaConfig.forEach(c => {
                let mark = c.max * (ability + variance);
                mark = Math.max(0, Math.min(c.max, mark)); // Cap within limits
                mark = parseFloat(mark.toFixed(2)); // Round to 2 decimals

                // Store in object for Reports
                studentObj.detailedScores[jKey][c.name] = mark;
                
                judgeTotal += mark;
                csvScoreString += `${mark},`; // Add to CSV String
            });

            judgeTotal = parseFloat(judgeTotal.toFixed(2));
            studentObj.scores[jKey] = judgeTotal;
            grandTotal += judgeTotal;
            csvScoreString += `${judgeTotal},`; // Add Judge Total to CSV
        }

        studentObj.finalScore = parseFloat((grandTotal / 5).toFixed(2));
        
        // Push to System Memory (So buttons work immediately)
        state.allStudents.push(studentObj);
        state.judging.savedResults.push(studentObj);

        // Build CSV Row
        let rowStart = `${i},"${studentObj.reg}","${studentObj.group}","${studentObj.branch}","${studentObj.instType}","${studentObj.name}","${studentObj.gender}","${studentObj.address}","${studentObj.id}","${studentObj.contact}","${studentObj.parent}","${studentObj.pPhone}","${studentObj.email}",`;
        let rowEnd = `${grandTotal.toFixed(2)},${studentObj.finalScore},"",""`;
        
        csvContent += rowStart + csvScoreString + rowEnd + "\n";
    }

    // 6. Update System & Trigger Download
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
    link.download = `Rasfahi_Full_Dummy_Data.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert("‚úÖ 2000 Students Generated!\nFile matches your uploaded format perfectly.");
}
    function printFullRubricBreakdown() {
    // 1. ﬁëﬁ≠ﬁìﬁß ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉﬁÜﬁÆﬁÅﬁ∞ ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    // ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉﬁåﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁÇﬁ¶ﬁéﬁ¶ﬁáﬁ®ÿå ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁÄﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁêﬁØﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    let list = getFilteredResults(); 
    
    if(list.length === 0) { 
        alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!"); 
        return; 
    }

    // 2. ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const bSel = document.getElementById('rptFilterBranch');
    const branchTxt = bSel.options[bSel.selectedIndex].text;
    const gSel = document.getElementById('rptFilterGroup');
    const groupTxt = gSel.options[gSel.selectedIndex].text;

    // 3. HTML ﬁÑﬁ®ﬁÇﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const customFontCSS = state.fontData ? `@font-face { font-family: 'Faruuma'; src: url('${state.fontData}'); }` : '';

    let html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Full Student Rubric Report</title>
        <style>
            ${customFontCSS}
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif !important; 
                padding: 30px; background: white; direction: rtl;
            }
            .header-info { text-align: center; margin-bottom: 20px; }
            .header-info h1 { margin: 0; font-size: 26px; text-decoration: underline; }
            .header-info h2 { margin: 5px 0; font-size: 18px; color: #333; }
            
            .stats-bar { 
                display: flex; justify-content: space-between; 
                border: 2px solid #000; padding: 10px; margin-bottom: 20px;
                background: #f1f1f1; font-weight: bold; font-size: 13px;
            }

            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            th, td { 
                border: 1px solid #000; padding: 8px; text-align: center; 
                font-size: 12px; word-wrap: break-word;
            }
            th { background: #ddd; font-weight: bold; }
            
            /* ﬁÜﬁ™ﬁçﬁ¶ ﬁÜﬁØﬁëﬁ®ﬁÇﬁ∞ﬁé (ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁ® ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞) */
            .top3 { background-color: #d4edda !important; font-weight: bold; } /* ﬁäﬁ¨ﬁÄﬁ® ﬁÜﬁ™ﬁçﬁ¶ (ﬁéﬁ¶ﬁãﬁ¶ 3) */
            .top5 { background-color: #e2e3e5 !important; } /* ﬁáﬁ¶ﬁÖﬁ® ﬁÜﬁ™ﬁçﬁ¶ (ﬁéﬁ¶ﬁãﬁ¶ 5) */
            
            .footer-sig { margin-top: 50px; display: flex; justify-content: space-around; }
            .sig-box { text-align: center; width: 180px; border-top: 1px dotted #000; padding-top: 5px; font-size: 12px; }

            @media print {
                @page { size: A4 landscape; margin: 10mm; }
                button { display: none; }
                body { -webkit-print-color-adjust: exact; }
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="padding:10px 20px; background:#4a148c; color:white; border:none; cursor:pointer; margin-bottom:10px; font-weight:bold; border-radius:5px;">üñ®Ô∏è PRINT REPORT</button>

        <div class="header-info">
            <h1>${instName}</h1>
            <h2>${compName}</h2>
            <div style="font-weight:bold;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ™ (Detailed Rubric Sheet)</div>
        </div>

        <div class="stats-bar">
            <span>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</span>
            <span>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß: ${groupTxt}</span>
            <span>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:30px;">#</th>
                    <th style="width:70px;">Reg No</th>
                    <th style="width:150px;">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th style="width:80px;">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©</th>
                    <th>J-1</th>
                    <th>J-2</th>
                    <th>J-3</th>
                    <th>J-4</th>
                    <th>J-5</th>
                    <th style="background:#ccc;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                    <th style="background:#eee;">ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞</th>
                    <th style="width:40px; background:#bbb;">ﬁàﬁ¶ﬁÇﬁ¶</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => {
                    let rank = i + 1;
                    let rowClass = "";
                    if(rank <= 3) rowClass = "top3";
                    else if(rank <= 5) rowClass = "top5";

                    let j1 = s.scores?.Judge_1 || 0;
                    let j2 = s.scores?.Judge_2 || 0;
                    let j3 = s.scores?.Judge_3 || 0;
                    let j4 = s.scores?.Judge_4 || 0;
                    let j5 = s.scores?.Judge_5 || 0;

                    let totalSum = (parseFloat(j1) + parseFloat(j2) + parseFloat(j3) + parseFloat(j4) + parseFloat(j5)).toFixed(2);

                    return `
                    <tr class="${rowClass}">
                        <td>${rank}</td>
                        <td>${s.reg || '-'}</td>
                        <td style="text-align:right; padding-right:8px;">${s.name}</td>
                        <td>${s.id}</td>
                        <td>${j1}</td>
                        <td>${j2}</td>
                        <td>${j3}</td>
                        <td>${j4}</td>
                        <td>${j5}</td>
                        <td style="font-weight:bold;">${totalSum}</td>
                        <td style="font-weight:bold; font-size:14px;">${s.finalScore}</td>
                        <td>${rank}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <div class="footer-sig">
            <div class="sig-box">ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®</div>
            <div class="sig-box">ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ / ﬁÜﬁÆﬁâﬁ®ﬁìﬁ©</div>
            <div class="sig-box">ﬁåﬁ¶ﬁáﬁ∞ﬁéﬁ¶ﬁÇﬁëﬁ™</div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "_blank", "width=1200,height=800");
    w.document.write(html);
    w.document.close();
}
    // --- 5-JUDGE MATRIX ENTRY SYSTEM ---

// 1. Open the Matrix Window
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!"); return;
    }

    // Create Modal HTML dynamically if not exists
    if(!document.getElementById('matrixModal')) {
        const div = document.createElement('div');
        div.id = 'matrixModal';
        div.innerHTML = `
            <div class="matrix-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h2 style="color:#FFD700; margin:0;">üñêÔ∏è 5-Judge Simultaneous Entry</h2>
                    <button class="btn-red" onclick="closeMatrixInput()">‚úñ CLOSE</button>
                </div>
                <div id="matrixGridArea"></div>
                <div style="margin-top:10px; text-align:right;">
                    <button class="btn-green" style="padding:15px 30px;" onclick="saveMatrixScores()">üíæ SAVE ALL & FINISH</button>
                </div>
            </div>
        `;
        document.body.appendChild(div);
    }

    renderMatrixTable();
    document.getElementById('matrixModal').style.display = 'flex';
}

function closeMatrixInput() {
    document.getElementById('matrixModal').style.display = 'none';
}

// 2. Render the Grid
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    
    let html = `<table class="matrix-table">
        <thead>
            <tr>
                <th style="width:200px; text-align:left;">Criteria / Max</th>`;
    
    // Columns for 5 Judges
    for(let j=1; j<=5; j++) html += `<th>Judge ${j}</th>`;
    
    html += `</tr></thead><tbody>`;

    // Rows for Rubric
    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; color:#ccc;">
                ${r.name} <span style="color:#666; font-size:11px;">(${r.max})</span>
            </td>`;
        
        for(let j=1; j<=5; j++) {
            // Check if score exists
            let val = "";
            let sID = state.judging.currentStudentObj.id;
            // Try to find existing value in memory (detailedScores)
            // This part requires complex mapping, for now let's keep inputs blank or 0
            // If you want to load saved data, you'd access state.allStudents here.
            
            html += `<td>
                <input type="number" class="matrix-input j-${j}" 
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       placeholder="-" oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // Total Row
    html += `<tr style="background:#1a1a1a;">
                <td style="text-align:right; font-weight:bold;">TOTAL:</td>`;
    for(let j=1; j<=5; j++) {
        html += `<td><div id="mTotal_${j}" class="matrix-total">0.00</div></td>`;
    }
    html += `</tr></tbody></table>`;

    area.innerHTML = html;
}

// 3. Auto Calculate Totals per Column
window.calcMatrixTotal = function(jNum) {
    const inputs = document.querySelectorAll(`.matrix-input.j-${jNum}`);
    let sum = 0;
    inputs.forEach(inp => {
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        if(!isNaN(v)) {
            // Auto cap at max
            if(v > max) { v = max; inp.value = max; inp.style.color = "red"; } 
            else { inp.style.color = "#00e676"; }
            sum += v;
        }
    });
    document.getElementById(`mTotal_${jNum}`).innerText = sum.toFixed(2);
}

// 4. Save Logic (Connects to Master System)
window.saveMatrixScores = function() {
    const sIdx = state.allStudents.findIndex(s => s.id === state.judging.currentStudentObj.id);
    if(sIdx === -1) return;

    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    // Loop through 5 Judges
    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasScore = false;
        let details = {};

        const inputs = document.querySelectorAll(`.matrix-input.j-${j}`);
        inputs.forEach(inp => {
            let v = parseFloat(inp.value);
            if(!isNaN(v)) {
                jTotal += v;
                details[inp.dataset.criteria] = v; // Save breakdown
                hasScore = true;
            }
        });

        if(hasScore) {
            let jKey = `Judge_${j}`;
            jTotal = parseFloat(jTotal.toFixed(2));
            
            // Save to Master Data
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;

            grandTotal += jTotal;
            activeJudges++;
        }
    }

    // Calculate Final Average
    state.allStudents[sIdx].finalScore = activeJudges > 0 ? parseFloat((grandTotal / activeJudges).toFixed(2)) : 0;

    // Save & Close
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();
    closeMatrixInput();
    alert(`‚úÖ Saved Successfully! Average: ${state.allStudents[sIdx].finalScore}`);
}
    // --- 5-JUDGE MATRIX ENTRY SYSTEM (FIXED & UPDATED V2) ---

// 1. Open the Matrix Window (With Student Header)
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first! (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß)"); return;
    }

    const s = state.judging.currentStudentObj;

    // Create Modal HTML dynamically if not exists or needs update
    const modalID = 'matrixModal';
    let modal = document.getElementById(modalID);
    
    if(modal) modal.remove(); // Remove old to refresh header logic

    modal = document.createElement('div');
    modal.id = modalID;
    modal.innerHTML = `
        <div class="matrix-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#FFD700; margin:0; font-family:'Faruuma';">üñêÔ∏è 5 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ (Matrix Entry)</h2>
                <div>
                    <button class="btn-blue" onclick="printMatrixCurrentStudent()">üñ®Ô∏è Print Sheet</button>
                    <button class="btn-red" onclick="closeMatrixInput()">‚úñ CLOSE</button>
                </div>
            </div>

            <div style="background:#001a00; border:1px solid #00e676; padding:10px; border-radius:6px; margin-bottom:15px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; font-size:13px; color:#fff;">
                <div>
                    <div style="color:#aaa; font-size:11px;">Name & Reg:</div>
                    <strong style="font-size:16px; color:#FFD700;">${s.name}</strong> <br>
                    <span style="color:#00e676;">${s.reg || '-'}</span> | ${s.id || '-'}
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Category:</div>
                    <strong>${s.branch}</strong> - ${s.group} <br>
                    ${s.institution || s.inst || 'Private'}
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Address:</div>
                    ${s.address || '-'}
                </div>
            </div>

            <div id="matrixGridArea"></div>

            <div style="margin-top:10px; text-align:right;">
                <span id="saveStatus" style="color:#00e676; margin-right:10px; font-weight:bold; display:none;">‚úÖ Saved!</span>
                <button class="btn-green" style="padding:15px 40px; font-size:16px;" onclick="saveMatrixScores()">
                    üíæ SAVE ALL SCORES
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    renderMatrixTable();
    document.getElementById(modalID).style.display = 'flex';
}

function closeMatrixInput() {
    const m = document.getElementById('matrixModal');
    if(m) m.style.display = 'none';
}

// 2. Render the Grid (FIXED JUDGE 1 LOGIC)
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    const s = state.judging.currentStudentObj;
    
    // Check if there are saved detailed scores to pre-fill
    // Structure: s.detailedScores['Judge_1']['Thilawa']
    
    let html = `<table class="matrix-table" style="width:100%; border-collapse:collapse; color:#fff;">
        <thead>
            <tr>
                <th style="width:250px; text-align:left; background:#222; color:#FFD700; padding:10px; border:1px solid #444;">Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)</th>`;
    
    // Columns for 5 Judges
    for(let j=1; j<=5; j++) html += `<th style="background:#111; border:1px solid #444; color:#aaa;">Judge ${j}</th>`;
    
    html += `</tr></thead><tbody>`;

    // Rows for Rubric
    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; padding:8px; border:1px solid #333; color:#eee;">
                ${r.name} <span style="float:right; color:#666; font-size:11px;">(/ ${r.max})</span>
            </td>`;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = "";

            // Pre-fill if data exists
            if (s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                val = s.detailedScores[jKey][r.name];
            }

            html += `<td style="border:1px solid #333; padding:0;">
                <input type="number" class="matrix-input j-col-${j}" 
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       step="0.5" min="0" max="${r.max}"
                       value="${val}"
                       style="width:100%; height:40px; background:#000; border:none; color:#00e676; text-align:center; font-weight:bold; font-size:16px;"
                       onfocus="this.select()"
                       oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // Total Row
    html += `<tr style="background:#1a1a1a; height:50px;">
                <td style="text-align:right; font-weight:bold; padding-right:10px;">TOTAL:</td>`;
    for(let j=1; j<=5; j++) {
        // Pre-calc total if exists
        let preTotal = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0.00";
        html += `<td style="text-align:center; font-weight:bold; color:#FFD700; font-size:18px; border:1px solid #444;">
                    <span id="mTotal_${j}">${preTotal}</span>
                 </td>`;
    }
    html += `</tr></tbody></table>`;

    area.innerHTML = html;
}

// 3. Auto Calculate Totals per Column (FIXED)
window.calcMatrixTotal = function(jNum) {
    // Select inputs specifically by the class 'j-col-X'
    const inputs = document.querySelectorAll(`.matrix-input.j-col-${jNum}`);
    let sum = 0;
    
    inputs.forEach(inp => {
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        
        if(!isNaN(v)) {
            // Validation: Don't allow higher than max
            if(v > max) { 
                v = max; 
                inp.value = max; 
                inp.style.backgroundColor = "#330000"; // Warn color
            } else {
                inp.style.backgroundColor = "#000"; // Normal
            }
            sum += v;
        }
    });
    
    // Update the total display for this judge
    document.getElementById(`mTotal_${jNum}`).innerText = sum.toFixed(2);
}

// 4. Save Logic (Updates Master List & Detailed Scores)
window.saveMatrixScores = function() {
    const currentID = state.judging.currentStudentObj.id;
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);
    
    if(sIdx === -1) { alert("Error: Student not found in memory."); return; }

    // Init storage if missing
    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    // Loop through 5 Judges
    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasScore = false;
        let details = {}; // Store breakdown for this judge

        // Select all inputs for this judge column
        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        
        inputs.forEach(inp => {
            let v = parseFloat(inp.value);
            // Only save if it's a number (empty means no score for that criteria)
            if(!isNaN(v)) {
                jTotal += v;
                details[inp.dataset.criteria] = v; // Save: { "Thilawa": 28 }
                hasScore = true;
            }
        });

        let jKey = `Judge_${j}`;

        if(hasScore) {
            jTotal = parseFloat(jTotal.toFixed(2));
            
            // Save Totals
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.judging.liveScores[jKey] = jTotal; // Update live tracking

            // Save Details (CRITICAL for Printing/Editing later)
            state.allStudents[sIdx].detailedScores[jKey] = details;

            grandTotal += jTotal;
            activeJudges++;
        } else {
            // If completely empty, reset this judge
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
        }
    }

    // Calculate Final Average
    state.allStudents[sIdx].finalScore = activeJudges > 0 ? parseFloat((grandTotal / activeJudges).toFixed(2)) : 0;

    // Save to LocalStorage
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // Feedback
    const status = document.getElementById('saveStatus');
    status.style.display = 'inline';
    status.innerText = `‚úÖ Saved! (Avg: ${state.allStudents[sIdx].finalScore})`;
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

// 5. PRINT FUNCTION (Generate PDF for Current Student)
function printMatrixCurrentStudent() {
    const s = state.judging.currentStudentObj;
    if(!s) return;

    // Get current values from the inputs (what's on screen right now)
    // We construct a temporary object to print
    let printData = { ...s, tempScores: {} };
    
    // Get Rubric Headers
    const rubric = state.judging.rubric;
    let tableRows = "";
    
    // Build Table Rows
    rubric.forEach((r, rIdx) => {
        tableRows += `<tr><td style="text-align:left; font-weight:bold;">${r.name} (${r.max})</td>`;
        for(let j=1; j<=5; j++) {
            // Find input value
            const inp = document.querySelector(`.matrix-input.j-col-${j}[data-criteria="${r.name}"]`);
            let val = inp ? inp.value : "";
            tableRows += `<td>${val}</td>`;
        }
        tableRows += `</tr>`;
    });

    // Build Totals Row
    let totalRow = `<tr style="background:#eee; font-weight:bold;"><td>TOTAL</td>`;
    for(let j=1; j<=5; j++) {
        let tot = document.getElementById(`mTotal_${j}`).innerText;
        totalRow += `<td>${tot}</td>`;
    }
    totalRow += `</tr>`;

    // HTML Structure for Print Window
    const html = `
    <html>
    <head>
        <title>Score Sheet - ${s.name}</title>
        <style>
            body { font-family: sans-serif; padding: 20px; direction: rtl; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .info-box { border: 1px solid #000; padding: 10px; margin-bottom: 20px; display:flex; justify-content: space-between; font-weight:bold; font-size:14px; }
            table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; direction: ltr; }
            th, td { border: 1px solid #000; padding: 8px; }
            th { background: #ccc; }
            @media print { button { display:none; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="margin-bottom:10px; font-size:20px; padding:10px;">üñ®Ô∏è Print</button>
        <div class="header">
            <h2>${document.getElementById('rptInstName').value || "Quran Competition"}</h2>
            <h3>Score Sheet</h3>
        </div>
        <div class="info-box">
            <div>ﬁÇﬁ¶ﬁÇﬁ∞: ${s.name}</div>
            <div>ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: ${s.reg}</div>
            <div>ﬁéﬁÆﬁäﬁ®: ${s.branch}</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width:200px; text-align:left;">Criteria</th>
                    <th>Judge 1</th><th>Judge 2</th><th>Judge 3</th><th>Judge 4</th><th>Judge 5</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
                ${totalRow}
            </tbody>
        </table>
        <div style="margin-top:20px; font-size:12px; color:#555;">Generated on ${new Date().toLocaleString()}</div>
    </body>
    </html>
    `;

    const w = window.open("", "_blank", "width=900,height=800");
    w.document.write(html);
    w.document.close();
}
    // --- FIXED 1: RENDER TABLE (Clean Inputs) ---
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    const s = state.judging.currentStudentObj;
    
    // ﬁìﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ (Table Header)
    let html = `<table class="matrix-table" style="width:100%; border-collapse:collapse; color:#fff;">
        <thead>
            <tr>
                <th style="width:250px; text-align:left; background:#222; color:#FFD700; padding:10px; border:1px solid #444;">
                    Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)
                </th>`;
    
    // Judge Headers (J1 - J5)
    for(let j=1; j<=5; j++) {
        html += `<th style="background:#111; border:1px solid #444; color:#aaa;">Judge ${j}</th>`;
    }
    html += `</tr></thead><tbody>`;

    // Rows Logic
    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; padding:8px; border:1px solid #333; color:#eee;">
                ${r.name} <span style="float:right; color:#666; font-size:11px;">(/ ${r.max})</span>
            </td>`;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = ""; // Default to Empty (Not 0, Not Max)

            // ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁÄﬁ¨ﬁáﬁ∞ ﬁãﬁ©ﬁäﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁáﬁ¨ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
            if (s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                val = s.detailedScores[jKey][r.name];
            }

            // Input Field
            html += `<td style="border:1px solid #333; padding:0;">
                <input type="number" class="matrix-input j-col-${j}" 
                       id="inp_${j}_${rIdx}"
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       step="0.5" min="0" max="${r.max}"
                       value="${val}"
                       placeholder="-"
                       style="width:100%; height:45px; background:#000; border:none; color:#00e676; text-align:center; font-weight:bold; font-size:18px;"
                       onfocus="this.select()"
                       oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // Total Row (Initialize with 0.00)
    html += `<tr style="background:#1a1a1a; height:50px;">
                <td style="text-align:right; font-weight:bold; padding-right:10px; color:#fff;">TOTAL:</td>`;
    
    for(let j=1; j<=5; j++) {
        // ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁìﬁØﬁìﬁ¶ﬁçﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
        let preTotal = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0.00";
        
        html += `<td style="text-align:center; font-weight:bold; color:#FFD700; font-size:20px; border:1px solid #444;">
                    <span id="mTotal_${j}">${preTotal}</span>
                 </td>`;
    }
    html += `</tr></tbody></table>`;

    area.innerHTML = html;
}

// --- FIXED 2: CALCULATION (Zero if Empty) ---
window.calcMatrixTotal = function(jNum) {
    // Select inputs ONLY for this specific judge column
    const inputs = document.querySelectorAll(`.matrix-input.j-col-${jNum}`);
    let sum = 0;
    
    inputs.forEach(inp => {
        // ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™: ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ 0 ﬁáﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠ÿå ﬁÇﬁ´ﬁÇﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        
        if (isNaN(v)) {
            v = 0; // Fix: If NaN (empty), count as 0, NOT Max
        } else {
            // Validation: Max ﬁáﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁâﬁ¶ﬁåﬁ®ﬁàﬁ®ﬁîﬁ¶ ﬁÇﬁ™ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞
            if(v > max) { 
                v = max; 
                inp.value = max; 
                inp.style.backgroundColor = "#330000"; // Warn color
            } else {
                inp.style.backgroundColor = "#000"; // Normal
            }
        }
        sum += v;
    });
    
    // ﬁìﬁØﬁìﬁ¶ﬁçﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const totalEl = document.getElementById(`mTotal_${jNum}`);
    if(totalEl) totalEl.innerText = sum.toFixed(2);
}
    // --- FIXED SAVE LOGIC: FORCE OVERWRITE MASTER DATA ---
window.saveMatrixScores = function() {
    // 1. Find the student in the master list
    const currentID = state.judging.currentStudentObj.id;
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);
    
    if(sIdx === -1) { alert("Error: Student not found in memory."); return; }

    // Ensure storage objects exist
    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    // 2. Loop through all 5 Judges
    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; // Object to store criteria breakdown (Thilawa: 10, etc)

        // Select all inputs for this specific judge column from the screen
        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        
        inputs.forEach(inp => {
            let val = parseFloat(inp.value);
            // If input is empty or NaN, treat as 0
            if(isNaN(val)) val = 0;
            
            // If the field isn't empty string, we consider it "graded"
            if(inp.value.trim() !== "") hasData = true;

            jTotal += val;
            
            // Save breakdown text
            if(inp.dataset.criteria) {
                details[inp.dataset.criteria] = val;
            }
        });

        let jKey = `Judge_${j}`;
        jTotal = parseFloat(jTotal.toFixed(2));

        // 3. Save to Master List
        if (hasData) {
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            
            // Also update the "Live Judging" memory for other screens
            state.judging.liveScores[jKey] = jTotal;

            grandTotal += jTotal;
            activeJudges++;
        } else {
            // If input was blank, ensure it saves as 0, NOT 100
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
        }
    }

    // 4. Calculate Final Average
    // Avoid division by zero
    let finalAvg = 0;
    if (activeJudges > 0) {
        finalAvg = parseFloat((grandTotal / activeJudges).toFixed(2));
    }
    
    state.allStudents[sIdx].finalScore = finalAvg;

    // 5. Save & Update UI
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // Visual Feedback
    const status = document.getElementById('saveStatus');
    if(status) {
        status.style.display = 'inline';
        status.innerText = `‚úÖ Saved! (Avg: ${finalAvg})`;
        setTimeout(() => { status.style.display = 'none'; }, 2000);
    }
    
    // Optional: Close window after save
    // closeMatrixInput(); 
}
    // --- FIXED TABLE RENDER: PREVENT "100" DEFAULT ---
function renderMasterTable() {
    const fBranch = document.getElementById('filterBranch').value;
    const fGroup = document.getElementById('filterGroup').value;
    const tbody = document.getElementById('masterTableBody');
    
    tbody.innerHTML = '';

    // Filter Logic
    let displayList = state.allStudents.filter(s => {
        return (fBranch === "" || s.branch === fBranch) && 
               (fGroup === "" || s.group === fGroup);
    });

    // Sort by Rank
    displayList.sort((a,b) => (b.finalScore || 0) - (a.finalScore || 0));

    document.getElementById('tableCount').innerText = displayList.length;

    displayList.forEach((s, idx) => {
        let row = document.createElement('tr');
        // Highlight if active
        if(state.judging.currentStudentObj && s.id === state.judging.currentStudentObj.id) {
            row.classList.add('selected-row');
        }

        let rank = (s.finalScore > 0) ? (idx + 1) : "-";

        // Helper to safely get score
        const getScore = (key) => {
            if (s.scores && s.scores[key] !== undefined && s.scores[key] !== null) {
                return s.scores[key];
            }
            return '-'; // Return dash if no score
        };

        row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${s.reg || ''}</td>
            <td style="text-align:left; font-weight:bold;">${s.name}</td>
            <td>${s.id}</td>
            <td>${s.branch}</td>
            <td>${s.group}</td>
            <td style="text-align:left;">${s.institution || s.inst || ''}</td>
            
            <td>${getScore('Judge_1')}</td>
            <td>${getScore('Judge_2')}</td>
            <td>${getScore('Judge_3')}</td>
            <td>${getScore('Judge_4')}</td>
            <td>${getScore('Judge_5')}</td>
            
            <td style="font-weight:bold; color:#00e676;">${s.finalScore || '-'}</td>
            <td style="color:#FFD700;">${rank}</td>
        `;

        row.onclick = () => selectStudentForGrading(s);
        tbody.appendChild(row);
    });
}
   // ========================================================
// ‚òÖ COMPLETE FIXED MATRIX SYSTEM (PRINT + JUDGE 1 FIX) ‚òÖ
// ========================================================

// 1. OPEN MATRIX (With Print Button & Student Info)
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first! (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß)"); return;
    }

    const s = state.judging.currentStudentObj;
    const modalID = 'matrixModal';
    
    // Remove old modal if exists
    let oldModal = document.getElementById(modalID);
    if(oldModal) oldModal.remove();

    // Create New Modal
    let modal = document.createElement('div');
    modal.id = modalID;
    modal.innerHTML = `
        <div class="matrix-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#FFD700; margin:0; font-family:'Faruuma';">üñêÔ∏è 5 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ (Matrix Entry)</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-blue" onclick="printMatrixCurrentStudent()">üñ®Ô∏è PRINT SHEET</button>
                    <button class="btn-red" onclick="closeMatrixInput()">‚úñ CLOSE</button>
                </div>
            </div>

            <div style="background:#001a00; border:1px solid #00e676; padding:10px; border-radius:6px; margin-bottom:15px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; font-size:13px; color:#fff;">
                <div>
                    <div style="color:#aaa; font-size:11px;">Name & Reg:</div>
                    <strong style="font-size:18px; color:#FFD700;">${s.name}</strong> <br>
                    <span style="color:#00e676;">${s.reg || '-'}</span> | ${s.id || '-'}
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Category:</div>
                    <strong>${s.branch}</strong> - ${s.group} <br>
                    ${s.institution || s.inst || 'Private'}
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Judge Status:</div>
                    <span id="judgeStatusText" style="color:#ccc;">Waiting to save...</span>
                </div>
            </div>

            <div id="matrixGridArea"></div>

            <div style="margin-top:15px; text-align:right; border-top:1px solid #333; padding-top:10px;">
                <span id="saveStatus" style="color:#00e676; margin-right:15px; font-weight:bold; display:none; font-size:18px;">‚úÖ ALL SAVED!</span>
                <button class="btn-green" style="padding:15px 50px; font-size:18px; font-weight:bold;" onclick="saveMatrixScores()">
                    üíæ SAVE ALL & UPDATE
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    renderMatrixTable();
    document.getElementById(modalID).style.display = 'flex';
}

function closeMatrixInput() {
    const m = document.getElementById('matrixModal');
    if(m) m.style.display = 'none';
}

// 2. RENDER TABLE (Clean Inputs - No 100 Bug)
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    const s = state.judging.currentStudentObj;
    
    let html = `<table class="matrix-table" style="width:100%; border-collapse:collapse; color:#fff;">
        <thead>
            <tr>
                <th style="width:250px; text-align:left; background:#222; color:#FFD700; padding:10px; border:1px solid #444;">Criteria (ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞)</th>`;
    
    for(let j=1; j<=5; j++) html += `<th style="background:#111; border:1px solid #444; color:#aaa;">Judge ${j}</th>`;
    html += `</tr></thead><tbody>`;

    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; padding:8px; border:1px solid #333; color:#eee;">
                ${r.name} <span style="float:right; color:#666; font-size:11px;">(/ ${r.max})</span>
            </td>`;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = ""; 

            // Only fill if data actually exists in memory
            if (s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                val = s.detailedScores[jKey][r.name];
            }

            html += `<td style="border:1px solid #333; padding:0;">
                <input type="number" class="matrix-input j-col-${j}" 
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       step="0.5" min="0" max="${r.max}"
                       value="${val}" placeholder="-"
                       style="width:100%; height:45px; background:#000; border:none; color:#00e676; text-align:center; font-weight:bold; font-size:18px;"
                       onfocus="this.select()"
                       oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // TOTAL ROW
    html += `<tr style="background:#1a1a1a; height:50px;">
                <td style="text-align:right; font-weight:bold; padding-right:10px; color:#fff;">TOTAL:</td>`;
    
    for(let j=1; j<=5; j++) {
        let preTotal = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0.00";
        html += `<td style="text-align:center; font-weight:bold; color:#FFD700; font-size:20px; border:1px solid #444;">
                    <span id="mTotal_${j}">${preTotal}</span>
                 </td>`;
    }
    html += `</tr></tbody></table>`;

    area.innerHTML = html;
}

// 3. CALCULATION (Real-time)
window.calcMatrixTotal = function(jNum) {
    const inputs = document.querySelectorAll(`.matrix-input.j-col-${jNum}`);
    let sum = 0;
    inputs.forEach(inp => {
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        
        if (isNaN(v)) { v = 0; } // Empty = 0
        else {
            if(v > max) { v = max; inp.value = max; inp.style.backgroundColor = "#330000"; }
            else { inp.style.backgroundColor = "#000"; }
        }
        sum += v;
    });
    document.getElementById(`mTotal_${jNum}`).innerText = sum.toFixed(2);
}

// 4. SAVE LOGIC (Fixes Judge 1 Bug)
window.saveMatrixScores = function() {
    const sIdx = state.allStudents.findIndex(s => s.id === state.judging.currentStudentObj.id);
    if(sIdx === -1) { alert("Student not found!"); return; }

    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; 

        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        inputs.forEach(inp => {
            let v = parseFloat(inp.value);
            if(!isNaN(v)) { // If it's a number (even 0), we count it
                jTotal += v;
                details[inp.dataset.criteria] = v;
                // Check if the input is not just an empty string
                if(inp.value.trim() !== "") hasData = true;
            }
        });

        let jKey = `Judge_${j}`;
        
        if (hasData) {
            jTotal = parseFloat(jTotal.toFixed(2));
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            
            // Sync Live Memory
            state.judging.liveScores[jKey] = jTotal;
            
            grandTotal += jTotal;
            activeJudges++;
        } else {
            // ‚òÖ FORCE RESET TO 0 if empty (Fixes 100 bug) ‚òÖ
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
            if(state.judging.liveScores[jKey]) state.judging.liveScores[jKey] = 0;
        }
    }

    // Calc Final Avg
    let finalAvg = activeJudges > 0 ? (grandTotal / activeJudges).toFixed(2) : 0;
    state.allStudents[sIdx].finalScore = parseFloat(finalAvg);

    // Save & Refresh
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // Feedback
    const status = document.getElementById('saveStatus');
    status.style.display = 'inline';
    status.innerText = `‚úÖ Saved! (Avg: ${finalAvg})`;
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

// 5. PRINT SHEET FUNCTION (Restored)
function printMatrixCurrentStudent() {
    const s = state.judging.currentStudentObj;
    if(!s) return;

    const rubric = state.judging.rubric;
    
    // Build Rows from current INPUT values (what you see is what you print)
    let tableRows = "";
    rubric.forEach(r => {
        tableRows += `<tr><td style="text-align:left; font-weight:bold;">${r.name} (${r.max})</td>`;
        for(let j=1; j<=5; j++) {
            const inp = document.querySelector(`.matrix-input.j-col-${j}[data-criteria="${r.name}"]`);
            let val = inp ? inp.value : "";
            tableRows += `<td>${val}</td>`;
        }
        tableRows += `</tr>`;
    });

    // Totals Row
    let totalRow = `<tr style="background:#eee; font-weight:bold;"><td>TOTAL</td>`;
    for(let j=1; j<=5; j++) {
        let tot = document.getElementById(`mTotal_${j}`).innerText;
        totalRow += `<td>${tot}</td>`;
    }
    totalRow += `</tr>`;

    const html = `
    <html>
    <head>
        <title>Score Sheet - ${s.name}</title>
        <style>
            body { font-family: sans-serif; padding: 20px; direction: rtl; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .info-box { border: 1px solid #000; padding: 15px; margin-bottom: 20px; display:flex; justify-content: space-between; font-weight:bold; font-size:14px; background:#f9f9f9; }
            table { width: 100%; border-collapse: collapse; text-align: center; font-size: 14px; direction: ltr; }
            th, td { border: 1px solid #000; padding: 10px; }
            th { background: #ddd; }
            @media print { button { display:none; } body { -webkit-print-color-adjust: exact; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="margin-bottom:10px; font-size:20px; padding:10px; width:100%; background:navy; color:white; cursor:pointer;">üñ®Ô∏è Print Sheet</button>
        
        <div class="header">
            <h2>${document.getElementById('rptInstName').value || "Quran Competition"}</h2>
            <h3>Score Sheet</h3>
        </div>

        <div class="info-box">
            <div>
                ﬁÇﬁ¶ﬁÇﬁ∞: ${s.name} <br>
                ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: ${s.reg || '-'}
            </div>
            <div>
                ﬁéﬁÆﬁäﬁ®: ${s.branch} <br>
                ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${s.group}
            </div>
            <div>
                ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©: ${s.id} <br>
                ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß: ${s.institution || '-'}
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:250px; text-align:left;">Criteria</th>
                    <th>Judge 1</th><th>Judge 2</th><th>Judge 3</th><th>Judge 4</th><th>Judge 5</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
                ${totalRow}
            </tbody>
        </table>

        <div style="margin-top:50px; display:flex; justify-content:space-between;">
            <div style="text-align:center; width:200px; border-top:1px solid #000; padding-top:5px;">Admin Signature</div>
            <div style="text-align:center; width:200px; border-top:1px solid #000; padding-top:5px;">Chief Judge</div>
        </div>
    </body>
    </html>
    `;

    const w = window.open("", "_blank", "width=900,height=800");
    w.document.write(html);
    w.document.close();
}
    // ========================================================
// ‚òÖ FINAL FIX: PRINT BUTTON + JUDGE 1 RESET ‚òÖ
// ========================================================

// 1. MATRIX WINDOW (With Print Button & Header)
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!"); return;
    }
    const s = state.judging.currentStudentObj;
    const modalID = 'matrixModal';
    
    let old = document.getElementById(modalID);
    if(old) old.remove();

    let modal = document.createElement('div');
    modal.id = modalID;
    modal.innerHTML = `
        <div class="matrix-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#FFD700; margin:0; font-family:'Faruuma';">üñêÔ∏è 5 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ (Matrix Entry)</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-blue" onclick="printMatrixCurrentStudent()">üñ®Ô∏è PRINT / PDF</button>
                    <button class="btn-red" onclick="closeMatrixInput()">‚úñ CLOSE</button>
                </div>
            </div>

            <div style="background:#001a00; border:1px solid #00e676; padding:10px; border-radius:6px; margin-bottom:15px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; font-size:13px; color:#fff;">
                <div>
                    <div style="color:#aaa; font-size:11px;">Name:</div>
                    <strong style="font-size:16px; color:#FFD700;">${s.name}</strong> (${s.reg})
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Group/Branch:</div>
                    ${s.branch} - ${s.group}
                </div>
                <div>
                     <div style="color:#aaa; font-size:11px;">ID:</div>
                     ${s.id}
                </div>
            </div>

            <div id="matrixGridArea"></div>

            <div style="margin-top:15px; text-align:right; border-top:1px solid #333; padding-top:10px;">
                <span id="saveStatus" style="color:#00e676; margin-right:15px; font-weight:bold; display:none;">‚úÖ SAVED!</span>
                <button class="btn-green" style="padding:15px 50px; font-size:18px;" onclick="saveMatrixScores()">
                    üíæ SAVE & UPDATE MASTER
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    renderMatrixTable();
    document.getElementById(modalID).style.display = 'flex';
}

function closeMatrixInput() {
    const m = document.getElementById('matrixModal');
    if(m) m.style.display = 'none';
}

// 2. RENDER TABLE (Clean Inputs)
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    const s = state.judging.currentStudentObj;
    
    let html = `<table class="matrix-table" style="width:100%; border-collapse:collapse; color:#fff;">
        <thead>
            <tr>
                <th style="width:250px; text-align:left; background:#222; color:#FFD700; padding:10px; border:1px solid #444;">Criteria</th>`;
    
    for(let j=1; j<=5; j++) html += `<th style="background:#111; border:1px solid #444; color:#aaa;">Judge ${j}</th>`;
    html += `</tr></thead><tbody>`;

    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; padding:8px; border:1px solid #333; color:#eee;">${r.name} (${r.max})</td>`;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = ""; 
            // Only fill if data exists
            if (s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                val = s.detailedScores[jKey][r.name];
            }
            html += `<td style="border:1px solid #333; padding:0;">
                <input type="number" class="matrix-input j-col-${j}" 
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       step="0.5" min="0" max="${r.max}"
                       value="${val}" placeholder="-"
                       style="width:100%; height:45px; background:#000; border:none; color:#00e676; text-align:center; font-weight:bold; font-size:18px;"
                       oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // Total Row
    html += `<tr style="background:#1a1a1a; height:50px;"><td style="text-align:right; font-weight:bold;">TOTAL:</td>`;
    for(let j=1; j<=5; j++) {
        let savedTot = (s.scores && s.scores[`Judge_${j}`]) ? s.scores[`Judge_${j}`] : "0.00";
        // ‚òÖ BUG FIX: If showing 100 but details are empty, force display 0.00
        if(parseFloat(savedTot) === 100 && (!s.detailedScores || !s.detailedScores[`Judge_${j}`])) savedTot = "0.00";
        
        html += `<td style="text-align:center; font-weight:bold; color:#FFD700; font-size:20px; border:1px solid #444;">
                    <span id="mTotal_${j}">${savedTot}</span>
                 </td>`;
    }
    html += `</tr></tbody></table>`;
    area.innerHTML = html;
}

// 3. CALCULATION
window.calcMatrixTotal = function(jNum) {
    const inputs = document.querySelectorAll(`.matrix-input.j-col-${jNum}`);
    let sum = 0;
    inputs.forEach(inp => {
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        if (isNaN(v)) { v = 0; } 
        else {
            if(v > max) { v = max; inp.value = max; inp.style.backgroundColor = "#330000"; }
            else { inp.style.backgroundColor = "#000"; }
        }
        sum += v;
    });
    document.getElementById(`mTotal_${jNum}`).innerText = sum.toFixed(2);
}

// 4. SAVE LOGIC (STRICT OVERWRITE - FIXES 100 BUG)
window.saveMatrixScores = function() {
    const sIdx = state.allStudents.findIndex(s => s.id === state.judging.currentStudentObj.id);
    if(sIdx === -1) return;

    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; 

        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        inputs.forEach(inp => {
            let v = parseFloat(inp.value);
            // If field is not empty, we consider it entered
            if(inp.value.trim() !== "") {
                if(isNaN(v)) v = 0;
                jTotal += v;
                details[inp.dataset.criteria] = v;
                hasData = true;
            }
        });

        let jKey = `Judge_${j}`;
        
        if (hasData) {
            jTotal = parseFloat(jTotal.toFixed(2));
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            state.judging.liveScores[jKey] = jTotal;
            
            grandTotal += jTotal;
            activeJudges++;
        } else {
            // ‚òÖ CRITICAL FIX: If no data, FORCE 0 (This overwrites the 100) ‚òÖ
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
            if(state.judging.liveScores[jKey]) state.judging.liveScores[jKey] = 0;
        }
    }

    let finalAvg = activeJudges > 0 ? (grandTotal / activeJudges).toFixed(2) : 0;
    state.allStudents[sIdx].finalScore = parseFloat(finalAvg);

    saveToLocal();
    
    // Update Main Admin Table
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // Re-render internal matrix total row to show 0.00
    renderMatrixTable(); 

    const status = document.getElementById('saveStatus');
    status.style.display = 'inline';
    status.innerText = `‚úÖ SAVED! (Avg: ${finalAvg})`;
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

// 5. PRINT FUNCTION (RESTORED)
function printMatrixCurrentStudent() {
    const s = state.judging.currentStudentObj;
    if(!s) return;

    const rubric = state.judging.rubric;
    let tableRows = "";
    
    rubric.forEach(r => {
        tableRows += `<tr><td style="text-align:left; font-weight:bold;">${r.name} (${r.max})</td>`;
        for(let j=1; j<=5; j++) {
            const inp = document.querySelector(`.matrix-input.j-col-${j}[data-criteria="${r.name}"]`);
            let val = inp ? inp.value : "";
            tableRows += `<td>${val}</td>`;
        }
        tableRows += `</tr>`;
    });

    let totalRow = `<tr style="background:#eee; font-weight:bold;"><td>TOTAL</td>`;
    for(let j=1; j<=5; j++) {
        let tot = document.getElementById(`mTotal_${j}`).innerText;
        totalRow += `<td>${tot}</td>`;
    }
    totalRow += `</tr>`;

    const html = `
    <html><head><title>Score Sheet</title>
    <style>body{font-family:sans-serif;padding:20px;direction:rtl;}table{width:100%;border-collapse:collapse;text-align:center;direction:ltr;}th,td{border:1px solid #000;padding:8px;}@media print{button{display:none;}}</style>
    </head><body>
    <button onclick="window.print()" style="padding:10px 20px;font-size:20px;">üñ®Ô∏è Print</button>
    <h2 style="text-align:center;">Score Sheet: ${s.name}</h2>
    <div style="margin-bottom:20px;"><strong>Reg:</strong> ${s.reg} | <strong>Branch:</strong> ${s.branch}</div>
    <table><thead><tr><th style="text-align:left;">Criteria</th><th>J1</th><th>J2</th><th>J3</th><th>J4</th><th>J5</th></tr></thead>
    <tbody>${tableRows}${totalRow}</tbody></table>
    </body></html>`;

    const w = window.open("", "_blank", "width=900,height=800");
    w.document.write(html);
    w.document.close();
}

// 6. MAIN ADMIN TABLE FIX (Ensures 100 doesn't show up in main list)
function renderMasterTable() {
    const fBranch = document.getElementById('filterBranch').value;
    const fGroup = document.getElementById('filterGroup').value;
    const tbody = document.getElementById('masterTableBody');
    tbody.innerHTML = '';

    let displayList = state.allStudents.filter(s => {
        return (fBranch === "" || s.branch === fBranch) && (fGroup === "" || s.group === fGroup);
    });
    displayList.sort((a,b) => (b.finalScore || 0) - (a.finalScore || 0));
    document.getElementById('tableCount').innerText = displayList.length;

    displayList.forEach((s, idx) => {
        let row = document.createElement('tr');
        if(state.judging.currentStudentObj && s.id === state.judging.currentStudentObj.id) row.classList.add('selected-row');

        // Helper to clean score (prevent 100 ghost)
        const getScore = (key) => {
            let val = (s.scores && s.scores[key] !== undefined) ? s.scores[key] : '-';
            // ‚òÖ Safety Check: If 100 but no detailed marks, show 0 or -
            if (val === 100 || val === "100") {
                 if (!s.detailedScores || !s.detailedScores[key] || Object.keys(s.detailedScores[key]).length === 0) {
                     return 0; 
                 }
            }
            return val;
        };

        row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${s.reg || ''}</td>
            <td style="text-align:left; font-weight:bold;">${s.name}</td>
            <td>${s.id}</td>
            <td>${s.branch}</td>
            <td>${s.group}</td>
            <td style="text-align:left;">${s.institution || s.inst || ''}</td>
            <td>${getScore('Judge_1')}</td>
            <td>${getScore('Judge_2')}</td>
            <td>${getScore('Judge_3')}</td>
            <td>${getScore('Judge_4')}</td>
            <td>${getScore('Judge_5')}</td>
            <td style="font-weight:bold; color:#00e676;">${s.finalScore || '-'}</td>
            <td style="color:#FFD700;">${(s.finalScore > 0) ? (idx + 1) : "-"}</td>
        `;
        row.onclick = () => selectStudentForGrading(s);
        tbody.appendChild(row);
    });
}
    // =================================================================
// ‚òÖ FINAL & COMPLETE MATRIX FIX (JUDGE 1 RESET + PRINT) ‚òÖ
// =================================================================

// 1. OPEN MATRIX WINDOW
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first! (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß)"); return;
    }

    const s = state.judging.currentStudentObj;
    const modalID = 'matrixModal';
    
    // Remove old modal to ensure fresh start
    let old = document.getElementById(modalID);
    if(old) old.remove();

    // ‚òÖ BUG FIX: If Judge 1 is exactly 100 (Ghost Data), force clear it internally before rendering
    let j1Score = (s.scores && s.scores['Judge_1']) ? parseFloat(s.scores['Judge_1']) : 0;
    if(j1Score === 100) {
        // Check if details are empty, if so, it's a ghost score. Reset it.
        if(!s.detailedScores || !s.detailedScores['Judge_1'] || Object.keys(s.detailedScores['Judge_1']).length === 0) {
            if(s.scores) s.scores['Judge_1'] = 0;
        }
    }

    let modal = document.createElement('div');
    modal.id = modalID;
    modal.innerHTML = `
        <div class="matrix-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#FFD700; margin:0; font-family:'Faruuma';">üñêÔ∏è 5 ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ (Matrix Entry)</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-blue" onclick="printMatrixCurrentStudent()">üñ®Ô∏è PRINT SHEET</button>
                    <button class="btn-red" onclick="closeMatrixInput()">‚úñ CLOSE</button>
                </div>
            </div>

            <div style="background:#001a00; border:1px solid #00e676; padding:10px; border-radius:6px; margin-bottom:15px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; font-size:13px; color:#fff;">
                <div>
                    <div style="color:#aaa; font-size:11px;">Name:</div>
                    <strong style="font-size:18px; color:#FFD700;">${s.name}</strong> (${s.reg})
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Branch:</div>
                    ${s.branch} - ${s.group}
                </div>
                <div>
                     <div style="color:#aaa; font-size:11px;">ID:</div>
                     ${s.id}
                </div>
            </div>

            <div id="matrixGridArea"></div>

            <div style="margin-top:15px; text-align:right; border-top:1px solid #333; padding-top:10px;">
                <button class="btn-orange" style="float:left; font-size:12px; padding:10px;" onclick="clearJudge1Only()">‚ö†Ô∏è Reset Judge 1</button>
                
                <span id="saveStatus" style="color:#00e676; margin-right:15px; font-weight:bold; display:none; font-size:18px;">‚úÖ SAVED!</span>
                <button class="btn-green" style="padding:15px 50px; font-size:18px; font-weight:bold;" onclick="saveMatrixScores()">
                    üíæ SAVE & UPDATE
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    renderMatrixTable(); // Render input fields
    document.getElementById(modalID).style.display = 'flex';
}

function closeMatrixInput() {
    const m = document.getElementById('matrixModal');
    if(m) m.style.display = 'none';
}

// 2. RENDER TABLE (STRICT INPUT CONTROL)
function renderMatrixTable() {
    const rubric = state.judging.rubric;
    const area = document.getElementById('matrixGridArea');
    const s = state.judging.currentStudentObj;
    
    let html = `<table class="matrix-table" style="width:100%; border-collapse:collapse; color:#fff;">
        <thead>
            <tr>
                <th style="width:250px; text-align:left; background:#222; color:#FFD700; padding:10px; border:1px solid #444;">Criteria</th>`;
    
    for(let j=1; j<=5; j++) html += `<th style="background:#111; border:1px solid #444; color:#aaa;">Judge ${j}</th>`;
    html += `</tr></thead><tbody>`;

    // Loop Rubric Rows
    rubric.forEach((r, rIdx) => {
        html += `<tr>
            <td style="text-align:left; font-weight:bold; padding:8px; border:1px solid #333; color:#eee;">${r.name} (${r.max})</td>`;
        
        for(let j=1; j<=5; j++) {
            let jKey = `Judge_${j}`;
            let val = ""; 

            // ‚òÖ CRITICAL FIX: Only retrieve value if it is explicitly saved in 'detailedScores'
            // Do NOT fallback to 'max' marks.
            if (s.detailedScores && s.detailedScores[jKey] && s.detailedScores[jKey][r.name] !== undefined) {
                val = s.detailedScores[jKey][r.name];
            }

            html += `<td style="border:1px solid #333; padding:0;">
                <input type="number" class="matrix-input j-col-${j}" 
                       data-judge="${j}" data-criteria="${r.name}" data-max="${r.max}"
                       step="0.5" min="0" max="${r.max}"
                       value="${val}" placeholder="-"
                       style="width:100%; height:45px; background:#000; border:none; color:#00e676; text-align:center; font-weight:bold; font-size:18px;"
                       oninput="calcMatrixTotal(${j})">
            </td>`;
        }
        html += `</tr>`;
    });

    // Total Row
    html += `<tr style="background:#1a1a1a; height:50px;"><td style="text-align:right; font-weight:bold;">TOTAL:</td>`;
    
    for(let j=1; j<=5; j++) {
        // Calculate initial total based on loaded values (Not saved total, to avoid mismatch)
        html += `<td style="text-align:center; font-weight:bold; color:#FFD700; font-size:20px; border:1px solid #444;">
                    <span id="mTotal_${j}">0.00</span>
                 </td>`;
    }
    html += `</tr></tbody></table>`;
    area.innerHTML = html;

    // Trigger calculation once to update totals based on loaded values
    for(let j=1; j<=5; j++) calcMatrixTotal(j);
}

// 3. CALCULATION LOGIC (STRICT SUMMATION)
window.calcMatrixTotal = function(jNum) {
    const inputs = document.querySelectorAll(`.matrix-input.j-col-${jNum}`);
    let sum = 0;
    
    inputs.forEach(inp => {
        let v = parseFloat(inp.value);
        let max = parseFloat(inp.dataset.max);
        
        // ‚òÖ FIX: Treat empty/NaN as 0. NEVER auto-fill max.
        if (isNaN(v)) { 
            v = 0; 
        } else {
            // Validation: Cap at Max
            if(v > max) { v = max; inp.value = max; inp.style.backgroundColor = "#330000"; }
            else { inp.style.backgroundColor = "#000"; }
        }
        sum += v;
    });
    
    // Update Total Display
    const totEl = document.getElementById(`mTotal_${jNum}`);
    if(totEl) totEl.innerText = sum.toFixed(2);
}

// 4. SAVE LOGIC (FORCE OVERWRITE JUDGE 1)
window.saveMatrixScores = function() {
    const sIdx = state.allStudents.findIndex(s => s.id === state.judging.currentStudentObj.id);
    if(sIdx === -1) { alert("Student error"); return; }

    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;

    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; 

        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        inputs.forEach(inp => {
            let v = parseFloat(inp.value);
            // Only count if user typed a number
            if(!isNaN(v) && inp.value.trim() !== "") {
                jTotal += v;
                details[inp.dataset.criteria] = v;
                hasData = true;
            }
        });

        let jKey = `Judge_${j}`;
        
        if (hasData) {
            jTotal = parseFloat(jTotal.toFixed(2));
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            
            // Also update Live Memory used by other screens
            state.judging.liveScores[jKey] = jTotal;

            grandTotal += jTotal;
            activeJudges++;
        } else {
            // ‚òÖ FORCE ZERO: If inputs are empty, overwrite 100 with 0
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
            if(state.judging.liveScores[jKey]) state.judging.liveScores[jKey] = 0;
        }
    }

    let finalAvg = activeJudges > 0 ? (grandTotal / activeJudges).toFixed(2) : 0;
    state.allStudents[sIdx].finalScore = parseFloat(finalAvg);

    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    const status = document.getElementById('saveStatus');
    status.style.display = 'inline';
    status.innerText = `‚úÖ Saved! (Avg: ${finalAvg})`;
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

// 5. MANUAL RESET BUTTON (If 100 still persists)
function clearJudge1Only() {
    const inputs = document.querySelectorAll(`.matrix-input.j-col-1`);
    inputs.forEach(i => i.value = ""); // Clear inputs
    calcMatrixTotal(1); // Update Total to 0
    saveMatrixScores(); // Force Save 0
}

// 6. PRINT SHEET FUNCTION (RESTORED)
function printMatrixCurrentStudent() {
    const s = state.judging.currentStudentObj;
    if(!s) return;

    const rubric = state.judging.rubric;
    let tableRows = "";
    
    // Build rows from CURRENT inputs (What you see is what you print)
    rubric.forEach(r => {
        tableRows += `<tr><td style="text-align:left; font-weight:bold;">${r.name} (${r.max})</td>`;
        for(let j=1; j<=5; j++) {
            const inp = document.querySelector(`.matrix-input.j-col-${j}[data-criteria="${r.name}"]`);
            let val = inp ? inp.value : "";
            tableRows += `<td>${val}</td>`;
        }
        tableRows += `</tr>`;
    });

    let totalRow = `<tr style="background:#eee; font-weight:bold;"><td>TOTAL</td>`;
    for(let j=1; j<=5; j++) {
        let tot = document.getElementById(`mTotal_${j}`).innerText;
        totalRow += `<td>${tot}</td>`;
    }
    totalRow += `</tr>`;

    const html = `
    <html>
    <head>
        <title>Score Sheet - ${s.name}</title>
        <style>
            body { font-family: sans-serif; padding: 20px; direction: rtl; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .info-box { border: 1px solid #000; padding: 15px; margin-bottom: 20px; display:flex; justify-content: space-between; font-weight:bold; font-size:14px; background:#f9f9f9; }
            table { width: 100%; border-collapse: collapse; text-align: center; font-size: 14px; direction: ltr; }
            th, td { border: 1px solid #000; padding: 10px; }
            th { background: #ddd; }
            @media print { button { display:none; } body { -webkit-print-color-adjust: exact; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="margin-bottom:10px; font-size:20px; padding:10px; width:100%; background:navy; color:white; cursor:pointer;">üñ®Ô∏è Print / Save PDF</button>
        
        <div class="header">
            <h2>${document.getElementById('rptInstName').value || "Quran Competition"}</h2>
            <h3>Score Sheet</h3>
        </div>

        <div class="info-box">
            <div>ﬁÇﬁ¶ﬁÇﬁ∞: ${s.name} <br> ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: ${s.reg || '-'}</div>
            <div>ﬁéﬁÆﬁäﬁ®: ${s.branch} <br> ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: ${s.group}</div>
            <div>ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©: ${s.id}</div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width:250px; text-align:left;">Criteria</th>
                    <th>J-1</th><th>J-2</th><th>J-3</th><th>J-4</th><th>J-5</th>
                </tr>
            </thead>
            <tbody>${tableRows}${totalRow}</tbody>
        </table>
        
        <div style="margin-top:50px; text-align:center; font-size:12px; color:#555;">Generated System Report</div>
    </body>
    </html>`;

    const w = window.open("", "_blank", "width=900,height=800");
    w.document.write(html);
    w.document.close();
}
// ===============================================================
// ‚òÖ FINAL FIX: MATRIX TO MAIN SCREEN SYNC (SOLVES 100 BUG) ‚òÖ
// ===============================================================

window.saveMatrixScores = function() {
    // 1. Check Active Student
    if(!state.judging.currentStudentObj) { 
        alert("Student not found!"); return; 
    }
    
    const currentID = state.judging.currentStudentObj.id;
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);
    
    if(sIdx === -1) { alert("Critical Error: Student Index Missing."); return; }

    // Init storage if missing
    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;
    
    // ‚òÖ CRITICAL: Get the currently selected Judge on Main Screen to Sync
    const mainScreenJudge = document.getElementById('secJudgeSelect').value; // e.g. "Judge_1"

    // 2. Loop through all 5 Judges
    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; // Store breakdown

        // Select inputs for this judge column
        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        
        inputs.forEach((inp, idx) => {
            let val = parseFloat(inp.value);
            let max = parseFloat(inp.dataset.max);
            
            // If NaN (empty), treat as 0
            if(isNaN(val)) val = 0;
            
            // Check if user actually typed something (for active judge count)
            if(inp.value.trim() !== "") hasData = true;

            jTotal += val;
            
            // Save Detail text
            if(inp.dataset.criteria) {
                details[inp.dataset.criteria] = val;
            }

            // ‚òÖ SYNC LOGIC: If this column matches the Main Screen Judge (e.g. Judge 1)
            // We must update the "Secretary Panel" deductions immediately.
            let jKey = `Judge_${j}`;
            if (jKey === mainScreenJudge && typeof secScores !== 'undefined') {
                // Calculate Deduction: Max - Given
                // e.g. If Max 30, Given 28 => Deduction is 2
                let deduction = max - val;
                
                // Update the memory used by buttons
                if(secScores[idx]) {
                    secScores[idx].deducted = parseFloat(deduction.toFixed(2));
                }
                
                // Update Visual Text on Main Screen Cards/Table
                // Card Score (Big Number)
                const cardScoreEl = document.getElementById(`secScore_${idx}`);
                if(cardScoreEl) cardScoreEl.innerText = val;
                
                // Card Deduction (Small Red Number)
                const cardDedEl = document.getElementById(`secDedInfo_${idx}`);
                if(cardDedEl) cardDedEl.innerText = deduction > 0 ? `(-${deduction.toFixed(2)})` : "";
            }
        });

        let jKey = `Judge_${j}`;
        jTotal = parseFloat(jTotal.toFixed(2));

        // 3. Save to Master List
        if (hasData) {
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            
            // Sync Live Memory
            state.judging.liveScores[jKey] = jTotal;

            grandTotal += jTotal;
            activeJudges++;
        } else {
            // Force 0 if empty
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
        }
    }

    // 4. Calculate Final Average & Update Main Total
    let finalAvg = activeJudges > 0 ? (grandTotal / activeJudges).toFixed(2) : 0;
    state.allStudents[sIdx].finalScore = parseFloat(finalAvg);

    // ‚òÖ FORCE UPDATE THE BIG TOTAL DISPLAY ON MAIN SCREEN ‚òÖ
    // This looks at the secScores we just updated above
    if(typeof calculateSecTotal === 'function') {
        calculateSecTotal(); 
    }

    // 5. Save & Refresh Table
    saveToLocal();
    if(typeof renderMasterTable === 'function') renderMasterTable();

    // 6. Visual Feedback
    const status = document.getElementById('saveStatus');
    if(status) {
        status.style.display = 'inline';
        status.innerText = `‚úÖ SAVED! (Avg: ${finalAvg})`;
        setTimeout(() => { status.style.display = 'none'; }, 2000);
    }
}
    // ===============================================================
// ‚òÖ FINAL UPDATE: SAVE + SYNC + REFRESH TABLE IMMEDIATELY ‚òÖ
// ===============================================================

window.saveMatrixScores = function() {
    // 1. Check Active Student
    if(!state.judging.currentStudentObj) { 
        alert("Student not found!"); return; 
    }
    
    const currentID = state.judging.currentStudentObj.id;
    const sIdx = state.allStudents.findIndex(s => s.id === currentID);
    
    if(sIdx === -1) { alert("Critical Error: Student Index Missing."); return; }

    // Init storage if missing
    if(!state.allStudents[sIdx].scores) state.allStudents[sIdx].scores = {};
    if(!state.allStudents[sIdx].detailedScores) state.allStudents[sIdx].detailedScores = {};

    let grandTotal = 0;
    let activeJudges = 0;
    
    // Get the currently selected Judge ID on the Main Screen
    const mainScreenJudge = document.getElementById('secJudgeSelect').value; 

    // 2. Loop through all 5 Judges
    for(let j=1; j<=5; j++) {
        let jTotal = 0;
        let hasData = false;
        let details = {}; 

        const inputs = document.querySelectorAll(`.matrix-input.j-col-${j}`);
        
        inputs.forEach((inp, idx) => {
            let v = parseFloat(inp.value);
            let max = parseFloat(inp.dataset.max);
            
            if(isNaN(v)) v = 0;
            if(inp.value.trim() !== "") hasData = true;

            jTotal += v;
            
            if(inp.dataset.criteria) {
                details[inp.dataset.criteria] = v;
            }

            // ‚òÖ SYNC LOGIC: Update Main Screen inputs for the active judge
            let jKey = `Judge_${j}`;
            if (jKey === mainScreenJudge && typeof secScores !== 'undefined') {
                let deduction = max - v;
                if(secScores[idx]) {
                    secScores[idx].deducted = parseFloat(deduction.toFixed(2));
                }
                // Update Main Screen Cards visual
                const cardScoreEl = document.getElementById(`secScore_${idx}`);
                const cardDedEl = document.getElementById(`secDedInfo_${idx}`);
                if(cardScoreEl) cardScoreEl.innerText = v;
                if(cardDedEl) cardDedEl.innerText = deduction > 0 ? `(-${deduction.toFixed(2)})` : "";
            }
        });

        let jKey = `Judge_${j}`;
        jTotal = parseFloat(jTotal.toFixed(2));

        // 3. Save to Master List
        if (hasData) {
            state.allStudents[sIdx].scores[jKey] = jTotal;
            state.allStudents[sIdx].detailedScores[jKey] = details;
            state.judging.liveScores[jKey] = jTotal; // Sync Live Memory

            grandTotal += jTotal;
            activeJudges++;
        } else {
            state.allStudents[sIdx].scores[jKey] = 0;
            state.allStudents[sIdx].detailedScores[jKey] = {};
        }
    }

    // 4. Calculate Final Average
    let finalAvg = activeJudges > 0 ? (grandTotal / activeJudges).toFixed(2) : 0;
    state.allStudents[sIdx].finalScore = parseFloat(finalAvg);

    // Update Big Total Display on Main Screen
    if(typeof calculateSecTotal === 'function') {
        calculateSecTotal(); 
    }

    // 5. Save to Browser Memory
    saveToLocal();

    // ‚òÖ CRITICAL UPDATE: REFRESH MASTER TABLE IMMEDIATELY ‚òÖ
    // This line forces the main table to redraw with the new scores
    if(typeof renderMasterTable === 'function') {
        renderMasterTable(); 
    }

    // 6. Visual Feedback
    const status = document.getElementById('saveStatus');
    if(status) {
        status.style.display = 'inline';
        status.innerText = `‚úÖ Saved! (Avg: ${finalAvg})`;
        setTimeout(() => { status.style.display = 'none'; }, 2000);
    }
}
    // 1. OPEN MATRIX WINDOW (BUTTONS MOVED TO TOP)
function openMatrixInput() {
    if(!state.judging.currentStudentObj) {
        alert("Please select a student first!"); return;
    }
    const s = state.judging.currentStudentObj;
    const modalID = 'matrixModal';
    
    // Remove old modal
    let old = document.getElementById(modalID);
    if(old) old.remove();

    // Judge 1 Ghost Data Fix
    let j1Score = (s.scores && s.scores['Judge_1']) ? parseFloat(s.scores['Judge_1']) : 0;
    if(j1Score === 100) {
        if(!s.detailedScores || !s.detailedScores['Judge_1'] || Object.keys(s.detailedScores['Judge_1']).length === 0) {
            if(s.scores) s.scores['Judge_1'] = 0;
        }
    }

    let modal = document.createElement('div');
    modal.id = modalID;
    modal.innerHTML = `
        <div class="matrix-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h2 style="color:#FFD700; margin:0; font-family:'Faruuma';">üñêÔ∏è Matrix Entry</h2>
                
                <div style="display:flex; gap:8px; align-items:center;">
                    <span id="saveStatus" style="color:#00e676; font-weight:bold; display:none; font-size:14px; margin-right:5px;">‚úÖ Saved!</span>
                    
                    <button class="btn-green" onclick="saveMatrixScores()" style="padding:6px 15px; font-size:14px; border:1px solid #00e676;">
                        üíæ SAVE
                    </button>

                    <button class="btn-blue" onclick="printMatrixCurrentStudent()" style="padding:6px 15px; font-size:14px;">
                        üñ®Ô∏è PRINT
                    </button>
                    
                    <button class="btn-red" onclick="closeMatrixInput()" style="padding:6px 15px; font-size:14px;">
                        ‚úñ CLOSE
                    </button>
                </div>
            </div>

            <div style="background:#001a00; border:1px solid #00e676; padding:10px; border-radius:6px; margin-bottom:15px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; font-size:13px; color:#fff;">
                <div>
                    <div style="color:#aaa; font-size:11px;">Name:</div>
                    <strong style="font-size:16px; color:#FFD700;">${s.name}</strong> (${s.reg})
                </div>
                <div>
                    <div style="color:#aaa; font-size:11px;">Branch:</div>
                    ${s.branch} - ${s.group}
                </div>
                <div>
                      <div style="color:#aaa; font-size:11px;">ID:</div>
                      ${s.id}
                </div>
            </div>

            <div id="matrixGridArea" style="flex:1; overflow-y:auto;"></div>
            
            </div>
    `;
    document.body.appendChild(modal);

    renderMatrixTable();
    document.getElementById(modalID).style.display = 'flex';
}
// ============================================================
// ‚òÖ STAR RATING SYSTEM (V4 - WITH DHIVEHI GRADE TEXT) ‚òÖ
// ============================================================

if (typeof state.windows === 'undefined') state.windows = {};
state.windows.starScreen = null;

function openStarScreen() {
    const starHtml = `
    <!DOCTYPE html>
    <html lang="dv">
    <head>
        <meta charset="UTF-8">
        <title>Star Grade View</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@700&display=swap');
            body { 
                margin: 0; overflow: hidden; 
                background: radial-gradient(circle at center, #001a33, #000); 
                height: 100vh; width: 100vw; 
                display: flex; flex-direction: column; align-items: center; justify-content: center; 
                color: #fff; font-family: 'Noto Sans Thaana', sans-serif; 
            }
            #starContainer { display: flex; gap: 30px; justify-content: center; align-items: center; min-height: 300px; }
            .star { 
                font-size: 15vw; color: rgba(255,255,255,0.05); 
                text-shadow: 0 0 20px rgba(0,0,0,0.5); 
                transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
                transform: scale(0.6); opacity: 0.5; 
            }
            .star.active { color: #FFD700; text-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700; transform: scale(1.1); opacity: 1; }
            
            /* ﬁéﬁ∞ﬁÉﬁ≠ﬁëﬁ∞ ﬁäﬁ¨ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨ ﬁÑﬁ¶ﬁáﬁ® */
            #gradeText { 
                margin-top: 40px; font-size: 8vw; font-weight: bold; 
                color: #FFD700; opacity: 0; transition: 1.5s; 
                text-shadow: 0 0 30px rgba(255,215,0,0.5), 0 0 10px #000;
                direction: rtl;
            }
        </style>
    </head>
    <body>
        <div id="starContainer">
            <div class="star" id="st1">‚òÖ</div>
            <div class="star" id="st2">‚òÖ</div>
            <div class="star" id="st3">‚òÖ</div>
            <div class="star" id="st4">‚òÖ</div>
            <div class="star" id="st5">‚òÖ</div>
        </div>
        <div id="gradeText">ﬁÜﬁßﬁâﬁ®ﬁîﬁßﬁÑﬁ™</div>

        <script>
            window.updateStars = function(score) {
                const stars = [{id:'st1',min:75},{id:'st2',min:80},{id:'st3',min:85},{id:'st4',min:90},{id:'st5',min:95}];
                const gradeEl = document.getElementById('gradeText');
                
                // ﬁâﬁßﬁÜﬁ™ﬁÄﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁáﬁ¶ﬁÉﬁßﬁÇﬁ¨ ﬁáﬁ¶ﬁÜﬁ™ﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ™ﬁÇﬁ∞
                let gradeMsg = "";
                if (score >= 95) gradeMsg = "ﬁâﬁ™ﬁâﬁ∞ﬁåﬁßﬁíﬁ™";
                else if (score >= 90) gradeMsg = "ﬁñﬁ¶ﬁáﬁ∞ﬁîﬁ®ﬁãﬁ™ﬁçﬁ∞ ﬁñﬁ®ﬁáﬁ∞ﬁãﬁß";
                else if (score >= 85) gradeMsg = "ﬁñﬁ¶ﬁáﬁ∞ﬁîﬁ®ﬁãﬁ™";
                else if (score >= 80) gradeMsg = "ﬁâﬁ¶ﬁ§ﬁ∞ﬁÑﬁ´ﬁçﬁ∞";
                else if (score >= 75) gradeMsg = "ﬁÜﬁßﬁâﬁ®ﬁîﬁßﬁÑﬁ™";

                gradeEl.innerText = gradeMsg;
                gradeEl.style.opacity = score >= 75 ? "1" : "0";

                stars.forEach((s, idx) => {
                    const el = document.getElementById(s.id);
                    el.classList.remove('active');
                    if (score >= s.min) { 
                        setTimeout(() => { el.classList.add('active'); }, idx * 300); 
                    }
                });
            };
        <\/script>
    </body>
    </html>`;

    state.windows.starScreen = window.open("", "StarScreen", "width=1200,height=800");
    if (state.windows.starScreen) {
        state.windows.starScreen.document.open();
        state.windows.starScreen.document.write(starHtml);
        state.windows.starScreen.document.close();
    } else {
        alert("‚ö†Ô∏è Popup Blocked!");
    }
}

// ﬁáﬁÆﬁìﬁØﬁáﬁ®ﬁÇﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁß ﬁÑﬁ¶ﬁáﬁ®
setInterval(() => {
    if (state.windows.starScreen && !state.windows.starScreen.closed) {
        let sum = 0; let count = 0;
        for(let j in state.judging.liveScores) {
            let val = parseFloat(state.judging.liveScores[j]);
            if(!isNaN(val) && val > 0) { sum += val; count++; }
        }
        let avg = count > 0 ? (sum / count) : 0;
        if(avg >= 75 && state.windows.starScreen.updateStars) {
            state.windows.starScreen.updateStars(avg);
        }
    }
}, 2000);
</script>
</body>
</html>
