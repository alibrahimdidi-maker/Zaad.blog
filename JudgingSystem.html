<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Judging System - Professional Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --royal-gold: #d4af37;
            --royal-gold-dim: #aa8c2c;
            --royal-green: #064e3b;
            --royal-dark: #022c22;
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --text-light: #f3f4f6;
        }

        body {
            font-family: 'Noto Sans Thaana', 'Amiri', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header & Layout --- */
        header {
            background: linear-gradient(to right, #000000, var(--royal-dark));
            border-bottom: 2px solid var(--royal-gold);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .main-body { display: flex; flex: 1; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px; background: #0a0a0a; border-left: 1px solid #333;
            display: flex; flex-direction: column; padding: 10px; gap: 5px;
        }
        .nav-btn {
            padding: 12px; border-radius: 6px; cursor: pointer; color: #888;
            transition: 0.3s; text-align: right;
        }
        .nav-btn:hover { background: #222; color: var(--royal-gold); }
        .nav-btn.active { background: var(--royal-green); color: white; border-right: 4px solid var(--royal-gold); font-weight: bold; }

        /* --- Content Area --- */
        .content { flex: 1; padding: 20px; overflow-y: auto; background: #161616; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Elements --- */
        .card {
            background: var(--panel-bg); border: 1px solid #333; border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .gold-text { color: var(--royal-gold); }
        .btn {
            padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-gold { background: var(--royal-gold); color: black; border: 1px solid white; }
        .btn-gold:hover { transform: scale(1.02); background: #fff; }

        /* --- STUDENT PROFILE HEADER (NEW) --- */
        .student-profile-header {
            display: flex; gap: 20px; background: #000; border: 1px solid var(--royal-gold);
            padding: 15px; border-radius: 10px; margin-bottom: 20px; align-items: center;
        }
        .student-photo {
            width: 100px; height: 100px; background: #333; border-radius: 50%; border: 3px solid var(--royal-gold);
            display: flex; justify-content: center; align-items: center; font-size: 3rem; color: #555; overflow: hidden;
        }
        .student-details { flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9rem; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .detail-value { font-weight: bold; color: white; }
        .detail-value.highlight { color: var(--royal-gold); font-size: 1.1rem; }

        /* --- RUBRIC SLIDERS --- */
        .rubric-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #252525; padding: 12px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #333;
        }
        .rubric-label { font-size: 1.1rem; font-weight: bold; color: #ddd; }
        input[type=range] { width: 60%; accent-color: var(--royal-gold); cursor: pointer; }
        .score-box {
            background: #000; color: var(--royal-gold); border: 1px solid var(--royal-gold);
            width: 60px; text-align: center; font-weight: bold; font-size: 1.2rem; padding: 5px; border-radius: 4px;
        }

        /* --- GRID --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .grid-box {
            background: #333; border: 1px solid #555; height: 50px; display: flex;
            justify-content: center; align-items: center; font-weight: bold; cursor: pointer; border-radius: 5px;
        }
        .grid-box.selected { background: var(--royal-gold); color: black; border-color: white; }
        .grid-box.used { background: #111; color: #444; cursor: not-allowed; border-color: #222; }

    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <i class="fa-solid fa-scale-balanced text-3xl text-yellow-500"></i>
            <div>
                <h1 class="text-xl font-bold gold-text">Royal Judging System</h1>
                <div class="text-xs text-gray-400">Professional Competition Software</div>
            </div>
        </div>
        <div class="flex gap-3">
            <select id="mode-select" onchange="changeMode()" class="bg-gray-800 text-white border border-gray-600 rounded p-1">
                <option value="quran">Quran Competition</option>
                <option value="madhaha">Madhaha / Song</option>
                <option value="speech">Speech / Debate</option>
                <option value="quiz">Quiz Competition</option>
            </select>
            <button onclick="openScreen()" class="btn btn-gold"><i class="fa-solid fa-desktop"></i> Display Screen</button>
        </div>
    </header>

    <div class="main-body">
        <nav class="sidebar">
            <div class="nav-btn active" onclick="nav('setup')"><i class="fa-solid fa-database"></i> Setup Data</div>
            <div class="nav-btn" onclick="nav('grid')" id="btn-grid"><i class="fa-solid fa-th"></i> Question Grid</div>
            <div class="nav-btn" onclick="nav('judging')"><i class="fa-solid fa-gavel"></i> Judging Rubric</div>
            <div class="nav-btn" onclick="nav('results')"><i class="fa-solid fa-trophy"></i> Results</div>
            <div class="mt-auto">
                <button onclick="saveData()" class="w-full bg-blue-900 text-blue-200 py-2 rounded text-sm mb-2">Save System</button>
                <button onclick="resetAll()" class="w-full bg-red-900 text-red-200 py-2 rounded text-sm">Reset</button>
            </div>
        </nav>

        <main class="content">

            <div id="setup" class="section active">
                <div class="card">
                    <h2 class="text-xl gold-text mb-4">1. Import Data (CSV)</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 border border-gray-600 rounded bg-black">
                            <h3 class="font-bold text-white mb-2">Participants CSV</h3>
                            <input type="file" id="file-students" accept=".csv" class="text-gray-400 text-sm">
                            <button onclick="processCSV('students')" class="mt-2 bg-gray-700 px-3 py-1 rounded text-white text-sm">Load Students</button>
                            <p id="st-count" class="text-green-500 text-xs mt-1"></p>
                        </div>
                        <div class="p-4 border border-gray-600 rounded bg-black">
                            <h3 class="font-bold text-white mb-2">Questions CSV</h3>
                            <input type="file" id="file-questions" accept=".csv" class="text-gray-400 text-sm">
                            <button onclick="processCSV('questions')" class="mt-2 bg-gray-700 px-3 py-1 rounded text-white text-sm">Load Questions</button>
                            <p id="q-count" class="text-green-500 text-xs mt-1"></p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl gold-text mb-4">2. Judging Criteria</h2>
                    <p class="text-sm text-gray-400 mb-2">Default criteria based on selected mode. You can edit max marks.</p>
                    <div id="criteria-editor" class="space-y-2"></div>
                </div>
            </div>

            <div id="grid" class="section">
                <div class="card flex justify-between items-center">
                    <h2 class="text-xl gold-text">Question Grid</h2>
                    <div class="flex gap-2">
                        <input type="number" id="grid-size" value="20" class="w-20 bg-gray-800 text-white p-1 rounded border border-gray-600">
                        <button onclick="generateGrid()" class="bg-gray-700 text-white px-3 py-1 rounded">Generate</button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2 card min-h-[400px]">
                        <div id="grid-container" class="grid-container"></div>
                    </div>
                    <div class="col-span-1">
                        <div class="card bg-black border-yellow-600 text-center relative">
                             <div id="timer-display" class="hidden absolute top-2 right-2 text-red-500 font-mono text-2xl font-bold">00:00</div>
                            
                            <h3 class="text-gray-500 text-sm uppercase">Selected Question</h3>
                            <div id="active-q-text" class="py-8 text-2xl gold-text font-arabic leading-loose min-h-[150px] flex items-center justify-center">--</div>
                            <div id="active-q-meta" class="text-sm text-gray-400 mb-4"></div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="screenAction('show')" class="bg-green-800 text-white py-2 rounded">Show on Screen</button>
                                <button onclick="screenAction('hide')" class="bg-red-900 text-white py-2 rounded">Hide</button>
                            </div>
                            
                            <div id="quiz-btns" class="hidden grid grid-cols-2 gap-2 mt-2">
                                <button onclick="startTimer()" class="bg-blue-800 text-white py-1 rounded">Start Timer</button>
                                <button onclick="screenAction('correct')" class="bg-green-600 text-white py-1 rounded">Correct!</button>
                            </div>
                            <div id="quran-btns" class="hidden mt-2">
                                <button onclick="screenAction('end_ayah')" class="w-full bg-yellow-700 text-black font-bold py-1 rounded">Sadaqallah</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="judging" class="section">
                <div class="card bg-gray-900 sticky top-0 z-10 p-2 flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500">Select Participant</label>
                        <select id="judge-student-select" onchange="loadStudent()" class="w-full bg-black text-white border border-gray-600 rounded p-2"></select>
                    </div>
                    <div class="flex-1 text-right">
                         <span class="text-xs text-gray-500 block">Total Score</span>
                         <span id="judge-total-display" class="text-3xl font-bold gold-text">0.0</span>
                    </div>
                </div>

                <div id="student-header" class="student-profile-header hidden">
                    <div class="student-photo">
                        <i class="fa-solid fa-user"></i>
                        </div>
                    <div class="student-details">
                        <div class="detail-item">
                            <span class="detail-label">Full Name</span>
                            <span class="detail-value highlight" id="ph-name">--</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ID Card No</span>
                            <span class="detail-value" id="ph-id">--</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Reg Number</span>
                            <span class="detail-value" id="ph-reg">--</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Branch / Category</span>
                            <span class="detail-value text-yellow-500" id="ph-branch">--</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Age Group</span>
                            <span class="detail-value" id="ph-age">--</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Institution / Address</span>
                            <span class="detail-value text-blue-300" id="ph-inst">--</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto">
                    <button onclick="setJudge(1)" id="jbtn-1" class="btn btn-gold">Judge 1</button>
                    <button onclick="setJudge(2)" id="jbtn-2" class="btn bg-gray-700 text-white">Judge 2</button>
                    <button onclick="setJudge(3)" id="jbtn-3" class="btn bg-gray-700 text-white">Judge 3</button>
                    <button onclick="setJudge(4)" id="jbtn-4" class="btn bg-gray-700 text-white">Judge 4</button>
                    <button onclick="setJudge(5)" id="jbtn-5" class="btn bg-gray-700 text-white">Judge 5</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="gold-text border-b border-gray-700 pb-2 mb-4">Score Sheet</h3>
                            <div id="rubric-container" class="space-y-2">
                                </div>
                            <div class="mt-6">
                                <label class="text-xs text-gray-400">Judge's Comments</label>
                                <textarea id="judge-comment" class="w-full bg-black border border-gray-700 text-white p-2 rounded h-20"></textarea>
                            </div>
                            <button onclick="saveScore()" class="w-full mt-4 btn-gold py-3 text-lg">Submit Score</button>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="card bg-black border border-gray-700">
                            <h3 class="text-sm text-gray-500 uppercase mb-2">Active Question View</h3>
                            <div id="judge-q-display" class="font-arabic text-lg text-right leading-loose text-white">
                                Select a question from Grid to view here.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results" class="section">
                <div class="card flex justify-between">
                    <h2 class="text-xl gold-text">Final Results</h2>
                    <button onclick="exportCSV()" class="bg-green-700 text-white px-3 py-1 rounded text-sm">Export CSV</button>
                </div>
                <div class="card overflow-auto">
                    <table id="results-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- DATA ---
        let app = {
            mode: 'quran',
            students: [],
            questions: [],
            scores: {}, // { id: { judge1: {...}, judge2: {...} } }
            criteria: [],
            gridUsed: [],
            activeStudent: null,
            activeQuestion: null
        };

        const PRESETS = {
            quran: [
                { id: 'thilawa', name: 'Thilawa', max: 30 },
                { id: 'tajweed', name: 'Tajweed', max: 20 },
                { id: 'makhraj', name: 'Makhraj', max: 20 },
                { id: 'sifa', name: 'Sifa', max: 10 },
                { id: 'fasaha', name: 'Fasaha', max: 10 },
                { id: 'fluency', name: 'Fluency', max: 10 }
            ],
            madhaha: [
                { id: 'voice', name: 'Voice', max: 30 },
                { id: 'melody', name: 'Melody', max: 30 },
                { id: 'lyrics', name: 'Lyrics', max: 20 },
                { id: 'perf', name: 'Performance', max: 20 }
            ],
            speech: [
                { id: 'content', name: 'Content', max: 40 },
                { id: 'deliv', name: 'Delivery', max: 30 },
                { id: 'lang', name: 'Language', max: 20 },
                { id: 'time', name: 'Timing', max: 10 }
            ],
            quiz: [
                { id: 'ans', name: 'Correct Answer', max: 10 }
            ]
        };

        let currJudge = 1;

        // --- INIT ---
        window.onload = function() {
            const data = localStorage.getItem('royalSystemData_v2');
            if(data) {
                app = JSON.parse(data);
                document.getElementById('mode-select').value = app.mode;
            } else {
                app.criteria = [...PRESETS['quran']];
            }
            changeMode(false);
            renderCriteriaEditor();
            populateStudentSelect();
            renderResults();
        };

        function nav(sec) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(sec).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(sec === 'results') renderResults();
        }

        function changeMode(reset = true) {
            app.mode = document.getElementById('mode-select').value;
            // Show/Hide Quiz/Quran specific buttons
            const isQuiz = app.mode === 'quiz';
            const isQuran = app.mode === 'quran';
            
            document.getElementById('quiz-btns').classList.toggle('hidden', !isQuiz);
            document.getElementById('timer-display').classList.toggle('hidden', !isQuiz);
            document.getElementById('quran-btns').classList.toggle('hidden', !isQuran);

            if(reset) {
                app.criteria = JSON.parse(JSON.stringify(PRESETS[app.mode] || PRESETS['quran']));
                renderCriteriaEditor();
                saveData();
            }
        }

        // --- CSV ---
        function processCSV(type) {
            const file = document.getElementById(`file-${type}`).files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.split('\n').map(r => r.split(','));
                const headers = rows[0].map(h => h.trim().replace(/"/g, ''));
                const data = rows.slice(1).filter(r=>r.length>1).map(r => {
                    let obj = {};
                    headers.forEach((h, i) => obj[h] = r[i]?.trim().replace(/"/g, '') || '');
                    return obj;
                });
                
                if(type === 'students') {
                    app.students = data;
                    document.getElementById('st-count').innerText = data.length + " loaded";
                    populateStudentSelect();
                } else {
                    app.questions = data;
                    document.getElementById('q-count').innerText = data.length + " loaded";
                }
                saveData();
            };
            reader.readAsText(file);
        }

        // --- GRID ---
        function generateGrid() {
            if(!app.questions.length) return alert("Load Questions first");
            const con = document.getElementById('grid-container');
            con.innerHTML = '';
            const size = parseInt(document.getElementById('grid-size').value);
            
            // Generate grid items
            for(let i=0; i<size; i++) {
                if(i >= app.questions.length) break;
                const q = app.questions[i];
                const id = q.ID || i;
                const isUsed = app.gridUsed.includes(id);
                
                const div = document.createElement('div');
                div.className = `grid-box ${isUsed ? 'used' : ''}`;
                div.innerText = i + 1;
                div.onclick = () => selectQuestion(q, div, id);
                con.appendChild(div);
            }
        }

        function selectQuestion(q, el, id) {
            if(el.classList.contains('used')) return;
            document.querySelectorAll('.grid-box').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            
            app.activeQuestion = q;
            app.activeQuestionID = id;
            
            const text = q.QuestionText || q.Surah;
            const meta = app.mode === 'quran' ? `${q.Surah} (Ayah ${q.StartAyah}-${q.EndAyah})` : '';
            
            document.getElementById('active-q-text').innerText = text;
            document.getElementById('active-q-meta').innerText = meta;
            document.getElementById('judge-q-display').innerText = text + "\n" + meta;
        }

        // --- JUDGING (UPDATED WITH PROFILE) ---
        function populateStudentSelect() {
            const s = document.getElementById('judge-student-select');
            s.innerHTML = '<option value="">-- Select --</option>';
            app.students.forEach(st => {
                const label = st['Full Name'] || st['Name'] || st['ID'];
                const val = st['ID Card'] || st['ID'];
                s.innerHTML += `<option value="${val}">${label}</option>`;
            });
        }

        function loadStudent() {
            const id = document.getElementById('judge-student-select').value;
            app.activeStudent = app.students.find(s => (s['ID Card'] || s['ID']) == id);
            
            if(app.activeStudent) {
                // Show Header
                document.getElementById('student-header').classList.remove('hidden');
                
                // Populate Profile
                const p = app.activeStudent;
                document.getElementById('ph-name').innerText = p['Full Name'] || p['Name'];
                document.getElementById('ph-id').innerText = p['ID Card'] || '-';
                document.getElementById('ph-reg').innerText = p['Reg No'] || '-';
                document.getElementById('ph-branch').innerText = p['Branch'] || '-';
                document.getElementById('ph-age').innerText = p['Age Group'] || '-';
                document.getElementById('ph-inst').innerText = `${p['Institution'] || ''} ${p['Address'] ? '('+p['Address']+')' : ''}`;
                
                // If CSV has ImageName, we could set it:
                // if(p.ImageName) document.querySelector('.student-photo').innerHTML = `<img src="${p.ImageName}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                document.getElementById('student-header').classList.add('hidden');
            }

            renderRubric();
        }

        function setJudge(num) {
            currJudge = num;
            for(let i=1; i<=5; i++) {
                const btn = document.getElementById(`jbtn-${i}`);
                if(i===num) {
                    btn.className = 'btn btn-gold';
                } else {
                    btn.className = 'btn bg-gray-700 text-white';
                }
            }
            renderRubric();
        }

        function renderRubric() {
            const con = document.getElementById('rubric-container');
            con.innerHTML = '';
            
            if(!app.activeStudent) return;
            const id = app.activeStudent['ID Card'] || app.activeStudent['ID'];
            
            // Get saved data
            const saved = app.scores[id]?.[`judge${currJudge}`] || {};
            let total = 0;

            app.criteria.forEach(c => {
                const val = saved[c.id] !== undefined ? saved[c.id] : c.max;
                total += parseFloat(val);
                
                con.innerHTML += `
                    <div class="rubric-row">
                        <div class="w-1/3">
                            <div class="rubric-label">${c.name}</div>
                            <div class="text-xs text-gray-500">Max Marks: ${c.max}</div>
                        </div>
                        <div class="w-2/3 flex items-center gap-4">
                            <input type="range" id="rng-${c.id}" min="0" max="${c.max}" step="0.5" value="${val}" oninput="updateScore('${c.id}', this.value)">
                            <div class="score-box" id="disp-${c.id}">${val}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('judge-total-display').innerText = total.toFixed(1);
            document.getElementById('judge-comment').value = saved.comment || '';
        }

        function updateScore(id, val) {
            document.getElementById(`disp-${id}`).innerText = val;
            let tot = 0;
            app.criteria.forEach(c => {
                tot += parseFloat(document.getElementById(`rng-${c.id}`).value);
            });
            document.getElementById('judge-total-display').innerText = tot.toFixed(1);
        }

        function saveScore() {
            if(!app.activeStudent) return;
            const id = app.activeStudent['ID Card'] || app.activeStudent['ID'];
            
            if(!app.scores[id]) app.scores[id] = {};
            
            let obj = { total: 0 };
            app.criteria.forEach(c => {
                const val = parseFloat(document.getElementById(`rng-${c.id}`).value);
                obj[c.id] = val;
                obj.total += val;
            });
            obj.comment = document.getElementById('judge-comment').value;
            
            app.scores[id][`judge${currJudge}`] = obj;
            saveData();
            alert(`Score Saved for Judge ${currJudge}: ${obj.total}`);
        }

        // --- RESULTS & EXPORT ---
        function renderResults() {
            const tb = document.querySelector('#results-table tbody');
            const th = document.querySelector('#results-table thead');
            
            let header = `<tr><th>ID</th><th>Name</th>`;
            for(let i=1;i<=5;i++) header += `<th>J${i}</th>`;
            header += `<th>Avg</th><th>Total</th></tr>`;
            th.innerHTML = header;

            tb.innerHTML = '';
            app.students.forEach(s => {
                const id = s['ID Card'] || s['ID'];
                const sc = app.scores[id] || {};
                let row = `<tr><td>${id}</td><td>${s['Full Name'] || s.Name}</td>`;
                
                let sum = 0, count = 0;
                for(let i=1; i<=5; i++) {
                    const jTot = sc[`judge${i}`]?.total || 0;
                    if(jTot > 0) { sum += jTot; count++; }
                    row += `<td>${jTot || '-'}</td>`;
                }
                const avg = count ? (sum/count).toFixed(2) : 0;
                row += `<td class="text-yellow-500 font-bold">${avg}</td><td>${sum.toFixed(2)}</td></tr>`;
                tb.innerHTML += row;
            });
        }

        function exportCSV() {
            let csv = "ID,Name,Branch,J1,J2,J3,J4,J5,Average,GrandTotal\n";
            app.students.forEach(s => {
                const id = s['ID Card'] || s['ID'];
                const sc = app.scores[id] || {};
                let line = [id, `"${s['Full Name']}"`, s['Branch']];
                let sum=0, count=0;
                for(let i=1;i<=5;i++) {
                    const val = sc[`judge${i}`]?.total || 0;
                    if(val>0) { sum+=val; count++; }
                    line.push(val);
                }
                line.push(count ? (sum/count).toFixed(2) : 0);
                line.push(sum);
                csv += line.join(",") + "\n";
            });
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = "Results.csv";
            link.click();
        }

        // --- DISPLAY WINDOW ---
        let win;
        function openScreen() {
            win = window.open("", "Display", "width=1000,height=700");
            win.document.write(`
                <html><head><title>Display</title>
                <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body{background:#000;color:white;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;font-family:'Noto Sans Thaana';text-align:center;}
                    .card{border:4px solid #d4af37;padding:40px;width:80%;border-radius:20px;background:#111;}
                    h1{color:#d4af37;font-size:4rem;margin:0;}
                    .q{font-family:'Amiri';font-size:3.5rem;margin-top:20px;line-height:1.8;}
                    .correct{color:#4ade80;animation:pulse 1s infinite;}
                    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
                </style></head><body>
                <div id="box" class="card"><h1>Waiting...</h1></div>
                <script>
                    window.update=function(d){
                        const b=document.getElementById('box');
                        if(d.t=='q'){ b.innerHTML='<h2 style="color:#d4af37">Question</h2><div class="q">'+d.txt+'</div>'; }
                        if(d.t=='end'){ b.innerHTML='<div style="font-family:Amiri;font-size:5rem">صَدَقَ اللّٰهُ الْعَظِيمُ</div>'; }
                        if(d.t=='cor'){ b.querySelector('.q').classList.add('correct'); }
                    }
                <\/script></body></html>
            `);
        }
        function screenAction(act) {
            if(!win || win.closed) return;
            if(act=='show' && app.activeQuestion) {
                const txt = app.activeQuestion.QuestionText || app.activeQuestion.Surah;
                win.update({t:'q', txt:txt});
                // Mark used
                if(!app.gridUsed.includes(app.activeQuestionID)) {
                    app.gridUsed.push(app.activeQuestionID);
                    document.querySelector('.grid-box.selected').classList.add('used');
                    saveData();
                }
            }
            if(act=='hide') win.document.body.innerHTML = '<div style="background:black;height:100%"></div>';
            if(act=='end_ayah') win.update({t:'end'});
            if(act=='correct') win.update({t:'cor'});
        }

        // --- SYSTEM ---
        function renderCriteriaEditor() {
            const c = document.getElementById('criteria-editor');
            c.innerHTML = '';
            app.criteria.forEach((cr, i) => {
                c.innerHTML += `<div class="flex gap-2"><input value="${cr.name}" class="flex-1 text-sm bg-gray-800"><input value="${cr.max}" class="w-16 text-center text-sm bg-gray-800"></div>`;
            });
        }
        function saveData() { localStorage.setItem('royalSystemData_v2', JSON.stringify(app)); }
        function resetAll() { if(confirm("Reset All Data?")) { localStorage.clear(); location.reload(); } }

    </script>
</body>
</html>
