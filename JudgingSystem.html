<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Judge Ultimate - Pro Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-dim: #997b20;
            --dark: #0f0f0f;
            --panel: #1a1a1a;
            --green: #064e3b;
        }

        body {
            font-family: 'Noto Sans Thaana', 'Amiri', sans-serif;
            background-color: var(--dark);
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(to right, #000, var(--green));
            border-bottom: 2px solid var(--gold);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar {
            width: 260px; background: #111; border-left: 1px solid #333;
            display: flex; flex-direction: column; padding: 10px; gap: 5px;
        }
        
        .nav-btn {
            padding: 12px; border-radius: 6px; cursor: pointer; color: #888; text-align: right;
            border: 1px solid transparent; transition: 0.2s;
        }
        .nav-btn:hover { background: #222; color: var(--gold); }
        .nav-btn.active { background: var(--green); color: white; border-right: 4px solid var(--gold); font-weight: bold; }

        .content { flex: 1; padding: 20px; overflow-y: auto; background: #141414; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        /* --- UI Components --- */
        .card {
            background: var(--panel); border: 1px solid #333; border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .gold-text { color: var(--gold); text-shadow: 0 1px 1px black; }
        
        button { transition: 0.2s; }
        .btn-gold { background: var(--gold); color: black; font-weight: bold; padding: 8px 16px; border-radius: 4px; }
        .btn-gold:hover { background: white; }

        input, select { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; }

        /* --- RUBRIC MATRIX --- */
        .rubric-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .rubric-row { background: #222; border-radius: 8px; overflow: hidden; }
        .rubric-cell { padding: 15px; vertical-align: middle; border-top: 1px solid #333; border-bottom: 1px solid #333; }
        .rubric-row td:first-child { border-left: 1px solid #333; border-radius: 0 8px 8px 0; border-right: 4px solid var(--gold); }
        .rubric-row td:last-child { border-right: 1px solid #333; border-radius: 8px 0 0 8px; }
        
        .deduct-btn {
            background: #333; border: 1px solid #555; color: #aaa; width: 50px; height: 40px;
            border-radius: 4px; font-weight: bold; font-size: 0.8rem; margin: 0 2px;
        }
        .deduct-btn:hover { background: #7f1d1d; color: white; border-color: red; }
        .deduct-btn:active { transform: scale(0.95); }

        .score-display {
            background: black; color: var(--gold); font-size: 1.5rem; font-weight: bold;
            width: 70px; text-align: center; padding: 5px; border-radius: 5px; border: 1px solid var(--gold);
        }

        /* --- New Extended Profile --- */
        .profile-card {
            display: flex; gap: 20px; background: #000; border: 1px solid var(--gold);
            padding: 20px; border-radius: 8px; margin-bottom: 20px; align-items: flex-start;
        }
        .profile-photo-box {
            width: 120px; height: 140px; background: #222; border: 2px solid #444;
            display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 6px;
        }
        .profile-grid {
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: right;
        }
        .p-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .p-value { font-size: 1.1rem; font-weight: bold; color: white; border-bottom: 1px solid #333; padding-bottom: 2px;}

        /* Search Dropdown */
        .search-results-container {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1a1a1a; border: 1px solid var(--gold);
            max-height: 300px; overflow-y: auto; z-index: 50;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            border-radius: 0 0 8px 8px;
        }
        .search-item {
            padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between;
        }
        .search-item:hover { background: var(--green); color: white; }

    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-medal text-3xl text-yellow-500"></i>
            <div>
                <h1 class="text-xl font-bold gold-text">Royal Judging System</h1>
                <div class="text-xs text-gray-400">Pro Edition v5.0</div>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <select id="comp-mode" onchange="changeMode()" class="bg-gray-900 border-yellow-600 text-yellow-500 font-bold">
                <option value="quran">Quran (Hifz/Thilawa)</option>
                <option value="madhaha">Madhaha</option>
                <option value="speech">Speech</option>
                <option value="lhen">Lhen</option>
                <option value="quiz">Quiz</option>
            </select>
            <button onclick="saveData()" class="btn-gold text-sm"><i class="fa-solid fa-save"></i> Save</button>
        </div>
    </header>

    <div class="main-container">
        <nav class="sidebar">
            <div class="nav-btn active" onclick="nav('setup')"><i class="fa-solid fa-sliders"></i> Configuration</div>
            <div class="nav-btn" onclick="nav('judging')"><i class="fa-solid fa-gavel"></i> Judging Panel</div>
            <div class="nav-btn" onclick="nav('results')"><i class="fa-solid fa-list-check"></i> Results</div>
            
            <div class="mt-auto p-4 border-t border-gray-800">
                <button onclick="exportBulkPDF()" class="w-full bg-red-900 text-white py-2 rounded mb-2 hover:bg-red-800">
                    <i class="fa-solid fa-file-pdf"></i> Bulk PDF Export
                </button>
            </div>
        </nav>

        <main class="content">

            <div id="setup" class="section active">
                <div class="card">
                    <h2 class="text-xl gold-text mb-4">1. Import Data</h2>
                    <div class="bg-black p-4 rounded border border-gray-700">
                        <h3 class="font-bold mb-2">Participants CSV</h3>
                        <p class="text-xs text-gray-400 mb-2">Required Columns: ID, Name. Optional: Address, RegNo, PhotoURL, Category, Branch</p>
                        <input type="file" id="file-students" accept=".csv" class="w-full text-sm">
                        <button onclick="loadCSV('students')" class="mt-2 bg-gray-700 text-white px-3 py-1 rounded text-sm">Load</button>
                        <span id="st-status" class="text-green-500 text-xs ml-2"></span>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl gold-text">2. Customize Rubric: <span id="lbl-mode" class="text-white">Quran</span></h2>
                        <button onclick="addCriteria()" class="bg-green-700 text-white px-3 py-1 rounded text-sm">+ Add Item</button>
                    </div>
                    <div id="rubric-config-container" class="space-y-2"></div>
                    <div class="mt-4 flex justify-between">
                         <button onclick="restoreDefaults()" class="text-xs text-red-400 underline">Restore Defaults</button>
                         <div class="text-xl font-bold">Total: <span id="config-total" class="gold-text">100</span></div>
                    </div>
                </div>
            </div>

            <div id="judging" class="section">
                
                <div class="relative mb-6">
                    <div class="flex gap-4 items-center bg-gray-900 p-4 rounded border-b-2 border-yellow-600 sticky top-0 z-40">
                        <div class="flex-1 relative">
                            <label class="text-xs text-gray-500 uppercase font-bold">Search Student (Name or ID)</label>
                            <div class="relative">
                                <input type="text" id="search-box" onkeyup="filterStudents()" 
                                       placeholder="Type to search..." 
                                       class="w-full bg-black border border-yellow-700 text-lg font-bold text-white pl-4 py-2 focus:outline-none focus:border-yellow-400">
                                <div id="search-dropdown" class="search-results-container hidden"></div>
                            </div>
                        </div>
                        <div class="text-right pl-6 border-l border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Live Score</div>
                            <div id="live-total" class="text-5xl font-bold gold-text">0.0</div>
                        </div>
                    </div>
                </div>

                <div id="profile-area" class="profile-card hidden">
                    <div class="profile-photo-box">
                        <img id="p-photo-img" class="w-full h-full object-cover hidden" alt="Student Photo">
                        <i id="p-photo-icon" class="fa-solid fa-user text-6xl text-gray-600"></i>
                    </div>
                    
                    <div class="profile-grid">
                        <div>
                            <div class="p-label">Full Name / ފުރިހަމަ ނަން</div>
                            <div class="p-value text-yellow-400" id="p-name">--</div>
                        </div>
                        <div>
                            <div class="p-label">ID Number / އައިޑީ</div>
                            <div class="p-value" id="p-id">--</div>
                        </div>
                        
                        <div>
                            <div class="p-label">Registration No.</div>
                            <div class="p-value" id="p-reg">--</div>
                        </div>
                        <div>
                            <div class="p-label">Category / Age Group</div>
                            <div class="p-value" id="p-cat">--</div>
                        </div>

                        <div class="col-span-2">
                            <div class="p-label">Permanent Address / ދާއިމީ އެޑްރެސް</div>
                            <div class="p-value text-sm text-gray-300" id="p-address">--</div>
                        </div>
                         <div>
                            <div class="p-label">Branch/Mode</div>
                            <div class="p-value text-blue-300" id="p-branch">--</div>
                        </div>
                        <div>
                            <div class="p-label">Institute</div>
                            <div class="p-value" id="p-inst">--</div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <button onclick="setJudge(1)" id="jb-1" class="btn-gold">Judge 1</button>
                    <button onclick="setJudge(2)" id="jb-2" class="bg-gray-700 text-white px-4 py-2 rounded font-bold">Judge 2</button>
                    <button onclick="setJudge(3)" id="jb-3" class="bg-gray-700 text-white px-4 py-2 rounded font-bold">Judge 3</button>
                    <button onclick="setJudge(4)" id="jb-4" class="bg-gray-700 text-white px-4 py-2 rounded font-bold">Judge 4</button>
                    <button onclick="setJudge(5)" id="jb-5" class="bg-gray-700 text-white px-4 py-2 rounded font-bold">Judge 5</button>
                </div>

                <div class="card">
                    <table class="rubric-table">
                        <thead>
                            <tr>
                                <th class="text-right pl-4">Criteria</th>
                                <th class="text-center">Deduction</th>
                                <th class="text-center w-24">Score</th>
                            </tr>
                        </thead>
                        <tbody id="rubric-matrix-body">
                            </tbody>
                    </table>

                    <div class="mt-6">
                        <label class="text-xs text-gray-500 uppercase">General Comments</label>
                        <textarea id="judge-comment" class="w-full bg-black border-gray-700 text-white p-2 h-20" placeholder="Optional remarks..."></textarea>
                    </div>

                    <button onclick="saveScore()" class="w-full mt-4 bg-green-700 text-white py-3 font-bold rounded hover:bg-green-600 shadow-lg border border-green-500">
                        <i class="fa-solid fa-check-circle"></i> SUBMIT SCORE FOR JUDGE <span id="lbl-judge-num">1</span>
                    </button>
                </div>
            </div>

            <div id="results" class="section">
                <div class="card flex justify-between items-center">
                    <h2 class="text-xl gold-text">Final Results</h2>
                    <button onclick="exportCSV()" class="bg-blue-700 text-white px-3 py-1 rounded text-sm">Export CSV</button>
                </div>
                <div class="card overflow-auto">
                    <table class="w-full text-sm text-right" id="res-table">
                        <thead class="bg-green-900 text-white">
                            <tr>
                                <th class="p-2">ID</th>
                                <th class="p-2">Name</th>
                                <th class="p-2">Cat</th>
                                <th class="p-2">J1</th><th class="p-2">J2</th><th class="p-2">J3</th><th class="p-2">J4</th><th class="p-2">J5</th>
                                <th class="p-2">AVG</th>
                                <th class="p-2">Total</th>
                            </tr>
                        </thead>
                        <tbody id="res-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // --- PRESET RUBRICS ---
        const RUBRICS = {
            quran_thilawa: [
                { id: 'tajweed', name: 'Tajweed Rules (Ahkam)', max: 20 },
                { id: 'makhraj', name: 'Makhraj / Letters', max: 20 },
                { id: 'sifa', name: 'Sifaat', max: 10 },
                { id: 'voice', name: 'Voice & Tone', max: 10 },
                { id: 'fili', name: 'Vowels (Fili)', max: 10 },
                { id: 'fasaha', name: 'Fasaha', max: 10 },
                { id: 'adaa', name: 'Adaa / Talaffuz', max: 10 },
                { id: 'quality', name: 'Overall Quality', max: 10 }
            ],
            quran_hifz: [
                { id: 'hifz', name: 'Hifz / Fluency', max: 40 },
                { id: 'tajweed', name: 'Tajweed', max: 20 },
                { id: 'makhraj', name: 'Makhraj', max: 15 },
                { id: 'voice', name: 'Voice & Tone', max: 15 },
                { id: 'quality', name: 'Overall Quality', max: 10 }
            ],
            madhaha: [
                { id: 'voice', name: 'Voice Quality', max: 30 },
                { id: 'melody', name: 'Melody & Rhythm', max: 30 },
                { id: 'lyrics', name: 'Lyrics Clarity', max: 20 },
                { id: 'perf', name: 'Performance', max: 20 }
            ],
            speech: [
                { id: 'content', name: 'Content / Ideas', max: 40 },
                { id: 'delivery', name: 'Delivery / Fluency', max: 30 },
                { id: 'lang', name: 'Language', max: 20 },
                { id: 'timing', name: 'Timing & Presentation', max: 10 }
            ],
            lhen: [
                { id: 'meter', name: 'Baa / Vazan', max: 30 },
                { id: 'meaning', name: 'Meaning / Maana', max: 30 },
                { id: 'lang', name: 'Language / Bas', max: 20 },
                { id: 'pres', name: 'Presentation', max: 20 }
            ],
            quiz: [
                { id: 'ans', name: 'Correct Answer', max: 10 }
            ]
        };

        // --- STATE ---
        let app = {
            mode: 'quran',
            students: [],
            scores: {}, 
            config: JSON.parse(JSON.stringify(RUBRICS)),
            activeStudent: null
        };

        let currJudge = 1;

        // --- INIT ---
        window.onload = function() {
            const saved = localStorage.getItem('royalUltimate_v5');
            if(saved) {
                const parsed = JSON.parse(saved);
                app.students = parsed.students || [];
                app.scores = parsed.scores || {};
                if(parsed.config) app.config = parsed.config;
            }
            changeMode(); 
            // We do not auto-load a student anymore, user must search
        };

        function nav(sec) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(sec).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(sec === 'results') renderResults();
        }

        function changeMode() {
            app.mode = document.getElementById('comp-mode').value;
            document.getElementById('lbl-mode').innerText = app.mode.toUpperCase();
            renderConfigTable();
            // If we have an active student, refresh rubric based on mode change
            if(app.activeStudent) renderRubricMatrix(); 
        }

        // --- SEARCH FUNCTIONALITY ---
        function filterStudents() {
            const query = document.getElementById('search-box').value.toLowerCase().trim();
            const drop = document.getElementById('search-dropdown');
            
            if(query.length < 1) {
                drop.classList.add('hidden');
                return;
            }

            // Filter logic: Check ID or Name
            const matches = app.students.filter(s => {
                const name = (s['Full Name'] || s.Name || "").toLowerCase();
                const id = (s['ID Card'] || s.ID || "").toLowerCase();
                return name.includes(query) || id.includes(query);
            });

            if(matches.length > 0) {
                drop.innerHTML = '';
                matches.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    const name = s['Full Name'] || s.Name;
                    const id = s['ID Card'] || s.ID;
                    const cat = s['Category'] || s['Age Group'] || '';
                    
                    div.innerHTML = `
                        <div><span class="font-bold text-yellow-500">${id}</span> - ${name}</div>
                        <div class="text-xs text-gray-400 self-center">${cat}</div>
                    `;
                    div.onclick = () => selectStudent(s);
                    drop.appendChild(div);
                });
                drop.classList.remove('hidden');
            } else {
                drop.innerHTML = '<div class="p-2 text-gray-500 text-center">No matches found</div>';
                drop.classList.remove('hidden');
            }
        }

        function selectStudent(student) {
            app.activeStudent = student;
            
            // Clear search box and hide dropdown
            document.getElementById('search-box').value = '';
            document.getElementById('search-dropdown').classList.add('hidden');

            loadStudentProfile();
        }

        function loadStudentProfile() {
            if(!app.activeStudent) return;
            const p = app.activeStudent;
            
            // Unhide Profile Area
            document.getElementById('profile-area').classList.remove('hidden');

            // Populate Fields (Mapping common CSV variations)
            const name = p['Full Name'] || p['Name'] || p['Student Name'] || '--';
            const id = p['ID Card'] || p['ID'] || p['Index Number'] || '--';
            const reg = p['Registration No'] || p['Reg No'] || p['RegNo'] || '--';
            const cat = p['Category'] || p['Age Group'] || p['Class'] || '--';
            const address = p['Permanent Address'] || p['Address'] || p['Island'] || '--';
            const branch = p['Branch'] || p['Mode'] || '--';
            const inst = p['Institution'] || p['House'] || p['School'] || '--';
            const photoUrl = p['Photo'] || p['PhotoURL'] || p['Image'];

            document.getElementById('p-name').innerText = name;
            document.getElementById('p-id').innerText = id;
            document.getElementById('p-reg').innerText = reg;
            document.getElementById('p-cat').innerText = cat;
            document.getElementById('p-address').innerText = address;
            document.getElementById('p-branch').innerText = branch;
            document.getElementById('p-inst').innerText = inst;

            // Handle Photo
            const imgEl = document.getElementById('p-photo-img');
            const iconEl = document.getElementById('p-photo-icon');
            
            if(photoUrl && photoUrl.trim() !== '') {
                imgEl.src = photoUrl;
                imgEl.classList.remove('hidden');
                iconEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                iconEl.classList.remove('hidden');
            }

            renderRubricMatrix();
        }

        // --- CONFIG & RUBRIC ---
        function renderConfigTable() {
            let key = app.mode;
            if(key === 'quran') key = 'quran_thilawa';

            const list = app.config[key];
            const con = document.getElementById('rubric-config-container');
            con.innerHTML = '';
            let tot = 0;

            list.forEach((c, i) => {
                tot += parseFloat(c.max);
                con.innerHTML += `
                    <div class="flex gap-2 items-center bg-gray-900 p-2 rounded">
                        <input type="text" value="${c.name}" onchange="updateConfig('${key}', ${i}, 'name', this.value)" class="flex-1 bg-black text-sm">
                        <input type="number" value="${c.max}" onchange="updateConfig('${key}', ${i}, 'max', this.value)" class="w-16 text-center bg-black text-sm">
                        <button onclick="removeConfigItem('${key}', ${i})" class="text-red-500 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            });
            document.getElementById('config-total').innerText = tot;
        }

        function updateConfig(key, idx, field, val) {
            app.config[key][idx][field] = (field === 'max') ? parseFloat(val) : val;
            saveData();
            renderConfigTable();
        }

        function addCriteria() {
            let key = app.mode === 'quran' ? 'quran_thilawa' : app.mode;
            app.config[key].push({ id: Date.now(), name: 'New Criteria', max: 10 });
            renderConfigTable();
            saveData();
        }
        
        function removeConfigItem(key, idx) {
            app.config[key].splice(idx, 1);
            renderConfigTable();
            saveData();
        }

        function restoreDefaults() {
            if(confirm("Restore default rubric?")) {
                let key = app.mode === 'quran' ? 'quran_thilawa' : app.mode;
                app.config[key] = JSON.parse(JSON.stringify(RUBRICS[key]));
                if(app.mode === 'quran') app.config['quran_hifz'] = JSON.parse(JSON.stringify(RUBRICS['quran_hifz']));
                renderConfigTable();
                saveData();
            }
        }

        // --- JUDGING LOGIC ---
        function setJudge(num) {
            currJudge = num;
            document.getElementById('lbl-judge-num').innerText = num;
            for(let i=1; i<=5; i++) {
                const btn = document.getElementById(`jb-${i}`);
                if(i===num) {
                    btn.className = "btn-gold";
                    btn.style.color = "black";
                } else {
                    btn.className = "bg-gray-700 text-white px-4 py-2 rounded font-bold";
                    btn.style.color = "white";
                }
            }
            renderRubricMatrix();
        }

        function renderRubricMatrix() {
            const tbody = document.getElementById('rubric-matrix-body');
            tbody.innerHTML = '';
            
            if(!app.activeStudent) return;
            const id = app.activeStudent['ID Card'] || app.activeStudent.ID;

            // Determine rubric type
            let rubricKey = app.mode;
            if(app.mode === 'quran') {
                const branch = (app.activeStudent['Branch'] || "").toLowerCase();
                if(branch.includes('hifz') || branch.includes('nubalai')) {
                    rubricKey = 'quran_hifz';
                } else {
                    rubricKey = 'quran_thilawa';
                }
            }

            const criteriaList = app.config[rubricKey];
            const savedScores = app.scores[id]?.[`judge${currJudge}`] || {};

            let currentTotal = 0;

            criteriaList.forEach(c => {
                let val = savedScores[c.id] !== undefined ? savedScores[c.id] : c.max;
                currentTotal += parseFloat(val);

                const tr = document.createElement('tr');
                tr.className = 'rubric-row';
                
                tr.innerHTML = `
                    <td class="rubric-cell">
                        <div class="text-lg font-bold text-gray-200">${c.name}</div>
                        <div class="text-xs text-gray-500">Max: ${c.max}</div>
                    </td>
                `;

                const btnCell = document.createElement('td');
                btnCell.className = 'rubric-cell text-center';
                
                const resetBtn = document.createElement('button');
                resetBtn.className = 'deduct-btn text-green-500 border-green-800';
                resetBtn.innerText = "Full";
                resetBtn.onclick = () => updateRowScore(c.id, c.max, c.max);
                btnCell.appendChild(resetBtn);

                [0.25, 0.5, 1.0, 2.0, 5.0].forEach(d => {
                    const btn = document.createElement('button');
                    btn.className = 'deduct-btn';
                    btn.innerText = `-${d}`;
                    btn.onclick = () => {
                        let cur = parseFloat(document.getElementById(`val-${c.id}`).innerText);
                        let newVal = cur - d;
                        if(newVal < 0) newVal = 0;
                        updateRowScore(c.id, c.max, newVal);
                    };
                    btnCell.appendChild(btn);
                });
                tr.appendChild(btnCell);

                tr.innerHTML += `
                    <td class="rubric-cell text-center">
                        <div id="val-${c.id}" class="score-display mx-auto">${val}</div>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            document.getElementById('live-total').innerText = currentTotal.toFixed(2);
            document.getElementById('judge-comment').value = savedScores.comment || "";
            
            // Highlight boxes
            updateAllColors(criteriaList);
        }

        function updateRowScore(cid, max, newVal) {
            const el = document.getElementById(`val-${cid}`);
            el.innerText = parseFloat(newVal).toFixed(2);
            
            if(newVal < max) {
                el.style.color = "#ef4444"; 
                el.style.borderColor = "#ef4444";
            } else {
                el.style.color = "#d4af37";
                el.style.borderColor = "#d4af37";
            }

            let total = 0;
            const boxes = document.querySelectorAll('.score-display');
            boxes.forEach(b => total += parseFloat(b.innerText));
            document.getElementById('live-total').innerText = total.toFixed(2);
        }

        function updateAllColors(list) {
            list.forEach(c => {
                const el = document.getElementById(`val-${c.id}`);
                const val = parseFloat(el.innerText);
                if(val < c.max) {
                    el.style.color = "#ef4444";
                    el.style.borderColor = "#ef4444";
                } else {
                    el.style.color = "#d4af37";
                    el.style.borderColor = "#d4af37";
                }
            });
        }

        function saveScore() {
            if(!app.activeStudent) {
                alert("Please search and select a student first.");
                return;
            }
            const id = app.activeStudent['ID Card'] || app.activeStudent.ID;
            
            if(!app.scores[id]) app.scores[id] = {};
            
            let rubricKey = app.mode;
            if(app.mode === 'quran') {
                const branch = (app.activeStudent['Branch'] || "").toLowerCase();
                rubricKey = branch.includes('hifz') ? 'quran_hifz' : 'quran_thilawa';
            }
            const criteriaList = app.config[rubricKey];

            let scoreObj = { total: 0 };
            
            criteriaList.forEach(c => {
                const val = parseFloat(document.getElementById(`val-${c.id}`).innerText);
                scoreObj[c.id] = val;
                scoreObj.total += val;
            });
            scoreObj.comment = document.getElementById('judge-comment').value;

            app.scores[id][`judge${currJudge}`] = scoreObj;
            saveData();
            
            // Visual feedback
            const btn = document.querySelector('button[onclick="saveScore()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> SAVED!';
            setTimeout(() => btn.innerHTML = originalText, 1500);
            
            renderResults();
        }

        // --- RESULTS & PDF ---
        function renderResults() {
            const tb = document.getElementById('res-body');
            tb.innerHTML = '';
            app.students.forEach(s => {
                const id = s['ID Card'] || s.ID;
                const sc = app.scores[id] || {};
                
                let row = `<tr class="border-b border-gray-800">
                    <td class="p-2">${id}</td>
                    <td class="p-2 font-bold text-white">${s['Full Name'] || s.Name}</td>
                    <td class="p-2 text-xs text-gray-400">${s['Category'] || '-'}</td>`;
                
                let sum = 0, count = 0;
                for(let i=1; i<=5; i++) {
                    const val = sc[`judge${i}`]?.total || 0;
                    if(val > 0) { sum+=val; count++; }
                    row += `<td class="p-2 text-gray-400">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }
                const avg = count ? (sum/count).toFixed(2) : 0;
                row += `<td class="p-2 text-yellow-500 font-bold text-lg">${avg}</td>
                        <td class="p-2 font-bold">${sum.toFixed(2)}</td></tr>`;
                tb.innerHTML += row;
            });
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,ID,Name,Category,Judge1,Judge2,Judge3,Judge4,Judge5,Average,TotalSum\n";
            
            app.students.forEach(s => {
                const id = s['ID Card'] || s.ID;
                const name = s['Full Name'] || s.Name;
                const cat = s['Category'] || '';
                const sc = app.scores[id] || {};
                
                let row = `"${id}","${name}","${cat}"`;
                let sum = 0, count = 0;
                
                for(let i=1; i<=5; i++) {
                    const val = sc[`judge${i}`]?.total || 0;
                    if(val > 0) { sum += val; count++; }
                    row += `,${val > 0 ? val.toFixed(2) : 0}`;
                }
                const avg = count ? (sum/count).toFixed(2) : 0;
                row += `,${avg},${sum.toFixed(2)}`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `results_${app.mode}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
        }

        async function exportBulkPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let hasData = false;
            let pageCount = 0;

            for(let i=0; i<app.students.length; i++) {
                const s = app.students[i];
                const id = s['ID Card'] || s.ID;
                const scores = app.scores[id];
                
                if(!scores) continue;
                hasData = true;

                for(let j=1; j<=5; j++) {
                    const jScore = scores[`judge${j}`];
                    if(!jScore) continue;

                    if(pageCount > 0) doc.addPage();
                    pageCount++;

                    // Header
                    doc.setFillColor(6, 78, 59);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(212, 175, 55);
                    doc.setFontSize(22);
                    doc.text("JUDGING SCORE SHEET", 105, 20, null, null, "center");
                    
                    // Student Info
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.text(`Participant: ${s['Full Name'] || s.Name}`, 14, 50);
                    doc.text(`ID: ${id}`, 14, 56);
                    doc.text(`Category: ${s['Category'] || s['Age Group'] || '-'}`, 14, 62);
                    doc.text(`Reg No: ${s['Registration No'] || s['Reg No'] || '-'}`, 14, 68);
                    
                    doc.setFontSize(14);
                    doc.text(`Judge: ${j}`, 150, 50);
                    doc.setFontSize(10);
                    doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 56);

                    // Table
                    let rubricKey = app.mode;
                    if(app.mode === 'quran') {
                        const branch = (s['Branch'] || "").toLowerCase();
                        rubricKey = branch.includes('hifz') ? 'quran_hifz' : 'quran_thilawa';
                    }
                    const criteriaList = app.config[rubricKey];

                    const body = criteriaList.map(c => [
                        c.name, c.max, jScore[c.id] !== undefined ? jScore[c.id].toFixed(2) : '-'
                    ]);
                    body.push(['TOTAL', '', jScore.total.toFixed(2)]);

                    doc.autoTable({
                        startY: 75,
                        head: [['Criteria', 'Max', 'Score']],
                        body: body,
                        theme: 'grid',
                        headStyles: { fillColor: [6, 78, 59] },
                        columnStyles: { 2: { halign: 'center', fontStyle: 'bold' } }
                    });

                    // Comments
                    let finalY = doc.lastAutoTable.finalY + 10;
                    doc.text("Comments:", 14, finalY);
                    doc.rect(14, finalY + 2, 180, 20);
                    if(jScore.comment) doc.text(jScore.comment, 16, finalY + 8, {maxWidth: 175});

                    doc.text("_______________________", 150, finalY + 40);
                    doc.text("Signature", 160, finalY + 45);
                }
            }

            if(hasData) {
                doc.save(`Judges_Report_${app.mode}.pdf`);
            } else {
                alert("No scored data found to export.");
            }
        }

        // --- FILE IO ---
        function loadCSV(type) {
            const f = document.getElementById(`file-${type}`).files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = e => {
                const rows = e.target.result.split('\n').map(r=>r.split(','));
                const headers = rows[0].map(h=>h.trim().replace(/"/g,''));
                const data = rows.slice(1).filter(r=>r.length>1).map(r=>{
                    let o={}; headers.forEach((h,i)=>o[h]=r[i]?.trim().replace(/"/g,'')||''); return o;
                });
                app.students = data;
                document.getElementById('st-status').innerText = data.length + ' loaded';
                saveData();
            };
            reader.readAsText(f);
        }

        function saveData() {
            localStorage.setItem('royalUltimate_v5', JSON.stringify({
                students: app.students,
                scores: app.scores,
                config: app.config
            }));
        }

    </script>
</body>
</html>
