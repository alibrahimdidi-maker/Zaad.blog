<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Rasfahi portal (V33.0 - Platinum Edition - Navigation & Flex)</title>
    <style>
    /* 1. Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&family=Noto+Sans+Thaana:wght@400;700&display=swap');

    /* 2. Faruuma Font */
    @font-face {
        font-family: 'Faruuma';
        src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
    }

    /* --- THEME 4: THE DIPLOMATIC PEARL (White, Navy & Gold) - LTR EDITION --- */
    :root {
        /* Background: Clean Pearl White/Cream */
        --bg-grad: linear-gradient(135deg, #fdfbf7 0%, #ebedee 100%);
        
        /* Panels: White Glass with Navy Border */
        --panel-bg: rgba(255, 255, 255, 0.95); 
        --panel-border: 1px solid #1a237e; /* Navy Blue Border */
        
        /* Text - Dark for readability on Light BG */
        --text-main: #212121;
        --text-label: #0d47a1; /* Navy Blue Labels */
        --text-heading: #1a237e; /* Deep Navy Heading */
        
        /* Inputs */
        --input-bg: #ffffff;
        --input-border: 1px solid #b0bec5;
        
        /* Accents */
        --accent-color: #b8860b; /* Dark Gold */
        --highlight: #e8eaf6;
        --shadow: 0 10px 30px rgba(0,0,0,0.15); /* Softer Shadow */
    }

    body {
        margin: 0; padding: 0;
        background: var(--bg-grad);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        overflow: hidden; height: 100vh; width: 100vw;
        text-align: left; /* Global Left Align */
    }

    /* LAYOUT */
    .main-layout { display: flex; gap: 20px; height: 100vh; width: 100vw; padding: 20px; box-sizing: border-box; }
    
    .sidebar {
        flex: 0 0 380px;
        background: var(--panel-bg);
        border: var(--panel-border);
        border-radius: 4px; 
        padding: 20px;
        display: flex; flex-direction: column; 
        height: calc(100vh - 40px); /* Fixed Height */
        overflow-y: auto;
        box-shadow: var(--shadow);
        box-sizing: border-box;
    }

    .editor {
        flex: 1;
        background: var(--panel-bg);
        border: var(--panel-border);
        border-radius: 4px;
        padding: 30px;
        display: flex; flex-direction: column; 
        height: calc(100vh - 40px); /* Fixed Height */
        overflow-y: auto;
        box-shadow: var(--shadow);
        position: relative;
        box-sizing: border-box;
    }

    /* TYPOGRAPHY */
    h1, h2, h3, h4 { 
        margin: 5px 0; font-family: 'Playfair Display', serif; 
        color: var(--text-heading); text-transform: uppercase; letter-spacing: 1px; 
        text-align: left;
    }
    label { 
        display: block; font-size: 13px; color: var(--text-label); 
        margin: 15px 0 5px 0; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; 
        text-align: left;
    }
    .d-label { 
        font-size: 17px; font-weight: bold; color: var(--accent-color); 
        border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-top: 30px; 
        font-family: 'Playfair Display', serif;
        text-align: left;
    }

    /* INPUTS */
    input[type="text"], textarea, select, input[type="number"] { 
        width: 100%; padding: 12px; 
        border: var(--input-border); border-radius: 2px; 
        background: var(--input-bg); color: #000; 
        font-size: 15px; box-sizing: border-box; transition: 0.2s;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        text-align: left;
        font-family: 'Inter', sans-serif;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--text-label); background: #f5f5f5; outline: none; box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1); }
    
    /* Specific Inputs - Centered */
    #jLine1 { font-size: 22px !important; text-align: center !important; color: #fff !important; background: #1a237e !important; border: 2px solid var(--accent-color) !important; font-family: 'Playfair Display', serif !important; }
    .sub-title-input { text-align: center !important; background: #eceff1 !important; color: #000 !important; border: 1px solid #cfd8dc !important; }

    /* DHIVEHI OVERRIDE */
    .font-dv {
        font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif !important;
        direction: rtl !important;
        text-align: right !important;
    }

    /* BUTTONS */
    button { 
        cursor: pointer; font-weight: bold; border-radius: 4px; 
        border: 1px solid #1a237e; text-transform: uppercase; letter-spacing: 1px; font-size: 13px;
        background: #fff; color: #1a237e; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }
    button:hover { background: #1a237e; color: #fff; transform: translateY(-1px); }

    .launch-btn { background: #b71c1c !important; color: #fff !important; border: 1px solid #d32f2f; margin-bottom: 12px; padding: 14px; }
    .controls { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
    .btn-live { background: #1b5e20 !important; color: #fff !important; flex: 2; padding: 12px; }
    .btn-nav { background: #455a64 !important; color: #fff !important; width: 60px; font-size: 20px; }
    .btn-vid { background: #37474f !important; color: #fff !important; padding: 10px; width: 100%; margin-top: 5px; }
    .conf-btn { background: #0d47a1 !important; color: #fff !important; flex: 1; padding: 8px; font-size: 11px; }
    .config-btn-row { display: flex; gap: 5px; margin-bottom: 15px; }
    #lockBtn { background: var(--accent-color) !important; color: #fff !important; padding: 12px; width: 100%; margin-bottom: 15px; border:none !important; }
    #lockBtn.active { background: #d32f2f !important; color: #fff !important; }

    /* UI ELEMENTS */
    .royal-banner { background: #fff; border: 1px solid #1a237e; border-top: 4px solid var(--accent-color); padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .banner-main { color: #546e7a; font-size: 11px; letter-spacing: 3px; display: block; text-transform: uppercase; font-weight: bold; }
    .banner-sub { color: #1a237e; font-size: 24px; font-family: 'Playfair Display', serif; display: block; margin-top: 5px; }

    .group-box { border: 1px solid #cfd8dc; padding: 30px 20px 20px; margin-bottom: 25px; background: #f5f5f5; position: relative; border-radius: 6px; }
    .group-title { position: absolute; top: -10px; left: 20px; /* Left align */ background: #1a237e; color: #fff; padding: 4px 15px; font-size: 11px; font-weight: bold; border-radius: 4px; }

    .video-panel { background: #e3f2fd; padding: 15px; border: 1px solid #90caf9; margin-bottom: 20px; border-radius: 4px; }
    
    #stuList { background: #fff; color: #000; border: 1px solid #cfd8dc; min-height: 250px; text-align: left; }
    #stuList option { padding: 10px; border-bottom: 1px solid #eee; }
    
    .preview-container { background: #eeeeee; border: 1px solid #cfd8dc; padding: 15px; display: flex; justify-content: center; margin-top: 15px; border-radius: 4px; gap: 15px; }
    #previewImg { width: 110px; height: 110px; border: 3px solid var(--accent-color); background: #fff; object-fit: cover; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #eceff1; }
    ::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 4px; }

    /* EXTRAS */
    #cpFsBtn { position: fixed; bottom: 20px; right: 20px; /* Moved to Right */ width: 50px; height: 50px; background: #1a237e; color: #fff; border-radius: 50%; z-index: 1000; font-size: 24px; border: 2px solid var(--accent-color); display:flex; align-items:center; justify-content:center; }
    
    /* Security Overlay - CENTERED */
    #securityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; }
    
    .sec-box { 
        background: #f5f5f5; 
        padding: 50px; 
        border: 2px solid var(--accent-color); 
        text-align: center !important; /* Force Center */
        width: 500px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
    }
    /* Force children to center */
    .sec-box h1, .sec-box h2, .sec-box p, .sec-box div {
        text-align: center !important;
    }

    .sec-input { background: #fff; color: #000; border: 1px solid #cfd8dc; padding: 15px; font-size: 22px; width: 100%; margin-top: 20px; text-align: center; }
    .sec-btn { background: var(--accent-color); color: #fff; width: 100%; margin-top: 25px; padding: 15px; font-size: 18px; border: none; font-weight: bold; }
    .admin-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent-color); margin-bottom: 20px; background: #eee; }
    
    .dev-credits { text-align:center; font-size:12px; color:#90a4ae; margin-top:20px; border-top: 1px solid #cfd8dc; padding-top:10px; }

    /* Tabs */
    .lang-tabs { display:flex; gap:5px; margin-bottom:15px; }
    .lang-btn { flex:1; background:#eceff1 !important; color:#546e7a; text-align:center; padding:10px; text-decoration:none; border:1px solid #cfd8dc; }
    .lang-btn.active { background:#1a237e !important; color:#fff !important; border:1px solid #1a237e; }
    .list-switch-btn { background:#eceff1 !important; color:#546e7a; padding:10px; flex:1; border:1px solid #cfd8dc; }
    .list-switch-btn.active { background:var(--accent-color) !important; color:#fff !important; }
    
    /* Lock State */
    .locked-zone { opacity: 0.5; pointer-events: none; filter: grayscale(0.8); }
</style>
</head>
<body oncontextmenu="return false;">

    <button id="cpFsBtn" onclick="toggleControlFS()" title="Full Screen">‚õ∂</button>

    <div id="securityOverlay">
    <div class="sec-box" style="width: 500px; max-width: 90vw; padding: 40px 30px; box-sizing: border-box; max-height: 98vh; overflow-y: auto;">
        
        <img src="Photos/ali.png" class="admin-pic" alt="Ali Ibrahim Didi">
        
        <h1 style="color:#FFD700; font-size:20px; margin:0 0 5px 0; font-family:'Times New Roman', serif; text-transform:uppercase; letter-spacing:1px;">
            Warm Welcome to
        </h1>
        <h2 style="color:#fff; font-size:26px; margin:0 0 20px 0; text-shadow:0 2px 5px #000; line-height: 1.2;">
            Rasfahi Event and Graduation Software
        </h2>

        <p style="color:#bbdefb; font-size:13px; margin-bottom:15px;">
            Paste subscription code using <b>Ctrl + V</b>.<br>
            <span style="color:#ffcc80;">‚ö†Ô∏è No spaces allowed! Invalid if spaced.</span>
        </p>

        <input type="password" id="licenseKey" class="sec-input" placeholder="Paste Key Here..." style="font-size:16px; padding: 10px; margin-top:0;">
        <button class="sec-btn" onclick="verifyLicense()" style="margin-top: 15px; padding: 10px; font-size:16px;">AUTHENTICATE</button>
        <p id="secMsg" style="color:#ff5252; font-size:14px; margin-top:10px; font-weight:bold; min-height:20px;"></p>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.15); margin: 20px 0;">

        <div style="text-align:center; font-size:11px; color:#b0bec5; line-height:1.4;">
            <p style="margin-bottom:8px;">
                Intellectual property of <strong>Ali Ibrahim Didi</strong>.<br>
                Registered under Maldives Copyright Law.<br>
                <span style="color:#fff;">Reg: MED.03.IP.CR.26.EW5889</span>
            </p>

            <div style="color:#ff1744; font-weight:bold; background:rgba(40,0,0,0.3); padding:8px; border:1px solid #ff1744; border-radius:4px; margin-bottom:10px;">
                ‚õî Unauthorized use will result in legal action.
            </div>

            <p style="color:#64b5f6; margin:0;">
                Support: <b>7791550</b> / <b>9901550</b>
            </p>
        </div>
    </div>
</div>
</body>
<div style="margin-top:10px;">
                        
    <div class="main-layout" id="mainApp">
        <div class="sidebar">
            <div class="lang-tabs">
                <a href="RASFAHI-portal.html" class="lang-btn active">HOME</a>
            </div>

            <div class="royal-banner">
                <span class="banner-main">RASFAHI-EVENT AND GRADUATION CEREMONY SOFTWARE</span>
                <span class="banner-sub">Rasfahi Portal</span>
            </div>

            <div id="licenseStatus" style="font-size:13px; color:#0d47a1; text-align:center; margin-bottom:10px; font-weight:bold;"></div>

            <button class="launch-btn" onclick="openTV()">üñ•Ô∏è Turn on the TV screen</button>
            <div id="connStatus" style="font-size:14px; color:red; text-align:center; background:#ffebee; padding:4px; border-radius:4px; margin-bottom:10px; border:1px solid #ffcdd2;">Not Connected</div>

            <div id="configPanel" class="config-btn-row">
                <button class="conf-btn" onclick="downloadConfig()">‚¨á Save Configuration Settings</button>
                <button class="conf-btn" onclick="document.getElementById('confInput').click()">‚¨Ü Load Configuration Settings</button>
                <input type="file" id="confInput" accept=".json" style="display:none" onchange="loadConfig(this)">
            </div>

            <div id="sidebarFiles">
                <label style="margin-top:15px; color:#00281c;">üîç Search Students:</label>
            <div style="display:flex; gap:0; margin-bottom:5px;">
                <button class="list-switch-btn active" id="btnGenList" onclick="switchListMode('general')">üë• General List</button>
                <button class="list-switch-btn" id="btnTop5List" onclick="switchListMode('top5')">üèÜ Top 5 List</button>
            </div>
            <input type="text" id="search" placeholder="Type Name..." onkeyup="filterList()">
            
            <select id="stuList" size="10" style="flex-grow:1; border:1px solid #ccc; min-height: 200px;" onchange="loadStudent()"></select>
            
                <label style="color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px; margin-bottom:8px; font-size:16px; font-weight:bold;">üìÇ System Files</label>
                <div style="margin-bottom: 15px; text-align: center;">
        <a href="https://drive.google.com/drive/folders/1qcCTdxUv9gssjBjQ2LFKNDjxb2sWK1Xl?usp=drive_link" target="_blank" style="text-decoration:none;">
            <button style="width:100%; background: #e8f0fe; color: #1967d2; border: 1px solid #1967d2; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s;">
                üìÇ Download Sample Files (G-Drive)
            </button>
        </a>
        <small style="color: #666; font-size: 11px;">(Excel, Photos, Fonts & CSV Samples)</small>
    </div>
                <label>1. Students List (CSV):</label><input type="file" id="csvFile" accept=".csv">
                <label>2. Students Photo Folder:</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
                <label style="color:#2e7d32;">3. Main Logos (Max 5):</label><input type="file" id="mainLogosInput" accept="image/*" multiple onchange="loadMainLogos(this)">
                <label>4. Custom Font (TTF):</label><input type="file" id="fontFile" accept=".ttf, .otf">
                <label>5. Event Title (CSV):</label><input type="file" id="jalsaCsvFile" accept=".csv">
                <label style="color:#d84315;">6. Custom Frame:</label><input type="file" id="customBorderFile" accept="image/*">
                
                <hr>
                <label style="color:#2e7d32;">7. Partner Logos:</label>
                <input type="file" id="partnerLogos" accept="image/*" multiple onchange="loadPartnerLogos(this)">
                
                <label style="color:#c62828;">8. Advertisement / Banner (Photo/Video):</label>
                <input type="file" id="adFolder" accept="image/*, video/*" multiple onchange="loadAds(this)">
                
                <label style="color:#6a1b9a;">9. Custom Card Background:</label>
                <input type="file" id="customCardBgFile" accept="image/*" onchange="loadCustomCardBg(this)">
                
                <label style="color:#d32f2f;">10. PDF Presentation:</label>
                <input type="file" id="pdfFile" accept="application/pdf" onchange="loadPDF(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ff6f00; font-weight:900;">11. TOP 5 LIST (CSV):</label>
                <input type="file" id="top5CsvFile" accept=".csv" onchange="loadTop5Csv(this)">
                
                <label style="color:#ff6f00; font-weight:900;">12. TOP 5 VIDEOS:</label>
                <input type="file" id="top5VideoFiles" accept="video/*" multiple onchange="loadTop5Videos(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ffd700; font-weight:900;">13. ROYAL STAR ICON (PNG):</label>
                <input type="file" id="royalStarFile" accept="image/*" onchange="loadRoyalStar(this)">
                
                <label style="color:#ffd700; font-weight:900;">14. TROPHY ICON (PNG):</label>
                <input type="file" id="trophyFile" accept="image/*" onchange="loadTrophy(this)">
            </div>

            
            <div class="dev-credits">
                <span style="display:block; margin-bottom:3px;">Program Designed & Developed by:</span>
                <span class="dev-name">Ali Ibrahim Didi (+9607791550)</span>
                <span class="company-name">ZAAD RESEARCH AND PUBLISHING CONSULTANCY FIRM</span>
            </div>
        </div>

        <div class="editor" id="editorPanel">
            <button id="lockBtn" onclick="toggleLock()">üîì Unlocked (Editable Mode)</button>
            <div id="infoPanel" style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <label style="color:#d32f2f;">üöÄ SCENE SWITCHER (Change before time runs out):</label>
                <div id="listPanel" style="display:flex; gap:0; margin-bottom:5px;">
                    <button class="btn-live" style="background:#455a64; border-color:#37474f;" onclick="showJalsaScreen()">üè† TITLE SCREEN</button>
                    <button class="btn-live" style="background:#0d47a1; border-color:#002171;" onclick="forceStudentCard()">üéì STUDENT</button>
                    <button class="btn-live" style="background:#ff6f00; border-color:#c43e00;" onclick="forceTop5()">üèÜ TOP 5</button>
                </div>
            </div>
<div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px;">
   
    <div style="border-top: 1px dashed #9575cd; padding-top: 5px; margin-top: 5px;">
        
            <div class="controls" style="display: flex; justify-content: center; gap: 10px;">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ</button>
                <button class="action btn-live" onclick="updateTV()">üì∫ Display Student Name</button>
                <button class="action btn-nav" onclick="move(1)">‚ñ∂</button>
                <button class="action btn-nav" style="background:#c62828; font-size:16px;" onclick="clearTV()">X</button>
                <button class="action btn-nav" style="background:#f9a825; font-size:16px;" onclick="toggleAdsMode()" title="Advertisement Mode">üì¢</button>
            </div>

           <div class="video-panel">
    <div style="font-weight:bold; color:#0277bd; margin-bottom:5px;">üéûÔ∏è Video Player & Presentation</div>
    
    <div style="display:flex; gap:8px;">
        <label style="width:70%; font-size:12px; color:#555;">General Video Playlist:</label>
        <input type="file" id="videoPlaylist" accept="video/*" multiple style="width:70%">
        <button class="btn-vid" style="background:#e65100; width:15%; margin-right:2px;" onclick="playPrevVideo()">‚óÄ Back</button>
        <button class="btn-vid" style="background:#ef6c00; width:15%;" onclick="playNextVideo()">Next ‚ñ∂</button>
    </div>

    <div style="margin-top:5px;">
        <button class="btn-vid" style="background:#00695c; width:100%; font-weight:bold;" onclick="playGeneralSequence()">‚ñ∂ Play General Playlist (Sequential)</button>
    </div>
                
                <div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; background:#fff; padding:5px; border-radius:5px;">
    
    <label style="font-size:12px; display:inline-flex; align-items:center;">
        <input type="checkbox" id="vidOverlayCheck" onchange="toggleOverlayMode(this.checked)"> Video Overlay Card (Overlay)
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#c62828;">
        <input type="checkbox" id="top5ModeCheck"> <b>Top 5 Banner Mode (Royal)</b>
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#e65100;">
        <input type="checkbox" id="hideTrophyCheck" onchange="toggleTrophyVisibility(this.checked)"> <b>üö´ Hide Trophy</b>
    </label>

    <button class="btn-vid" style="background:#37474f; width:auto;" onclick="stopVideo()">‚èπ Stop</button>
</div>

                <hr style="border:1px dashed #ccc;">
                
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">WEB & PRESENTATION:</div>
                <div style="display:flex; gap:8px; margin-top:5px;">
                    <input type="text" id="presLink" placeholder="Canva/Gamma Link (Auto-Fix)..." style="width:60%; text-align:left;" class="font-en">
                      <select id="presType" style="width:20%; font-size:12px;">
                          <option value="auto">Auto-Detect</option>
                          <option value="gamma">Gamma.app</option>
                          <option value="canva">Canva</option>
                          <option value="google">Google Slides</option>
                      </select>
                    <button class="btn-vid" style="background:#6a1b9a; width:20%;" onclick="showPresentation()">Open</button>
                </div>
                <div style="margin-top:5px;">
                      <button class="btn-vid" style="background:#d32f2f;" onclick="showPDFScreen()">üìÑ Show PDF</button>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input type="text" id="ytLink" placeholder="YouTube Link (Any Format)..." style="width:50%; text-align:left;" class="font-en">
                    <button class="btn-vid" style="background:#c62828; width:30%;" onclick="playYoutube()">‚ñ∂ YouTube</button>
                    <button class="btn-vid" style="background:#0277bd; width:20%;" onclick="openYTPopup()">‚ö†Ô∏è Pop-up</button>
                </div>
                
                <div style="margin-top:10px;">
                    <button class="btn-vid" style="background:#2e7d32; width:100%; font-weight:bold;" onclick="forceShowTitles()">üîÑ Force Refresh Titles</button>
                </div>
            </div>
    <div id="statusMsg" style="font-weight:bold; color:#00695c; text-align:center; font-size:18px; margin:5px 0;">System Ready</div>
<div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px; margin-top:10px;">
    <label style="color:#512da8; font-size:14px; margin-bottom:5px; font-weight:bold; display:block;">üñ•Ô∏è 3-Screen Controls & Calibration:</label>

    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Left Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('left', this)" style="font-size:11px;">
        </div>
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Right Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('right', this)" style="font-size:11px;">
        </div>
    </div>

    <button class="btn-vid" style="background:#673ab7; font-weight:bold; margin-bottom:10px;" onclick="toggleTripleMode()">
        Toggle 3-Screen Mode (On/Off)
    </button>

    <div style="border-top: 1px dashed #9575cd; padding-top: 10px;">
        <label style="font-size:11px; color:#512da8; font-weight:bold;">üî≠ Monitor Zoom (View Only):</label>
        <input type="range" min="0.2" max="1" step="0.05" value="1" oninput="setTVZoom(this.value)" style="height:10px; width:100%;">
    </div>

    <div style="background:#fff; padding:5px; border-radius:5px; margin-top:5px; border:1px solid #d1c4e9;">
        <label style="font-size:11px; font-weight:bold; color:#311b92;">üõ†Ô∏è Screen Calibration (Position):</label>
        
        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Left:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('left', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('left', 'left', this.value)">
        </div>

        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Right:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('right', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('right', 'right', this.value)">
        </div>
    </div>
</div>
            
            <div style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; font-size:22px; color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px;">üéì Student Information</h3>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size:14px; color:#555;">Name (Dhivehi):</label>
                    <input id="nD" class="font-dv" placeholder="Name (Dhivehi)" style="width:100%;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size:14px; color:#555; text-align:right; display:block;">Name (English):</label>
                    <input id="nE" class="eng" placeholder="Name (English)" style="width:100%; text-align:left;">
                </div>
                
                <div class="row" style="display:flex; gap:10px; width:100%;">
                    <div class="col" style="flex:1;">
                        <input id="fD" class="font-dv" placeholder="Detail 1 (Dhivehi)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="fE" class="eng" placeholder="Detail 1 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>

                <div class="row" style="display:flex; gap:10px; width:100%; margin-top:5px;">
                    <div class="col" style="flex:1;">
                        <input id="cD" class="font-dv" placeholder="Detail 2 (Dhivehi)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="cE" class="eng" placeholder="Detail 2 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>
                
                <div class="row" style="margin-top:5px;">
                    <label style="font-size:14px; color:#d84315;">üèÜ Rank/Position (Optional):</label>
                    <input id="rankInput" placeholder="1, 2, 3..." style="width:100%;">
                </div>
                
                <textarea id="cm" rows="2" class="font-dv" placeholder="Additional Information..."></textarea>

                <div class="preview-container">
                    <div><img id="logoPreview" alt="Logo" style="height:50px; opacity:0.5;"></div>
                    <div style="text-align:center;">
                        <span id="pStat" style="font-size:14px; font-weight:bold; color:#777;">No Photo</span><br>
                        <img id="previewImg" src="https://via.placeholder.com/150">
                        <br><button style="font-size:12px; padding:3px 8px; margin-top:5px; background:#607d8b; color:#fff; border:none; border-radius:4px;" onclick="document.getElementById('singlePhoto').click()">Change</button>
                        <input type="file" id="singlePhoto" accept="image/*" style="display:none" onchange="manualPhoto(this)">
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:15px; color:#777; margin:20px 0; font-weight:bold; letter-spacing:1px; background:#eceff1; padding:5px; border-radius:20px;">‚¨á Settings and Design Control ‚¨á</div>

            <div id="designPanel">
                <div style="background:#fff8e1; padding:10px; border:2px solid #ff6f00; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <label style="color:#d84315; font-weight:900; font-size:13px; display:block; margin-bottom:8px; border-bottom:1px dashed #ffb74d; padding-bottom:5px;">
        üñ•Ô∏è UNIVERSAL SCREEN FITTER (Anti-Stretch)
    </label>
    
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
        <span style="font-size:12px; width:60px; font-weight:bold;">‚Üî Width:</span>
        <input type="range" min="30" max="100" value="100" style="flex:1; cursor:ew-resize;" 
               oninput="updateMasterScale('width', this.value)" title="Shrink Width to fix stretching">
        <span style="font-size:11px; font-weight:bold; color:#d84315;" id="dispMW">100%</span>
    </div>

    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
        <span style="font-size:12px; width:60px; font-weight:bold;">‚Üï Height:</span>
        <input type="range" min="30" max="100" value="100" style="flex:1; cursor:ns-resize;" 
               oninput="updateMasterScale('height', this.value)" title="Shrink Height">
        <span style="font-size:11px; font-weight:bold; color:#d84315;" id="dispMH">100%</span>
    </div>

    <div style="text-align:center;">
         <button onclick="resetMasterScale()" style="background:#ffcc80; color:#000; border:none; padding:5px 10px; font-size:10px; border-radius:4px;">
            ‚Ü∫ Reset to Full Screen
         </button>
    </div>
    
    <p style="font-size:10px; margin:5px 0 0 0; color:#666; font-style:italic;">
        * For 3360x840 Screen: Try reducing <b>Width</b> to approx <b>50-60%</b>.
    </p>
</div>
                <div class="group-box" style="border-color:#ffca28; background:#fffde7;">
                    <span class="group-title" style="background:#ff6f00;">üèÜ Top 5 Mode & Video</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Select Layout to move Card (Left/Right/Bottom). Use Video Sliders to move video box anywhere!</p>
                        
                        <div style="margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px;">1. Banner Layout Position:</span>
                             <select id="t5LayoutSel" onchange="liveUpdate('t5Layout', this.value)" style="width:100%; font-weight:bold; color:#d84315;">
                                 <option value="bottom">Bottom Banner (Default)</option>
                                 <option value="left">Left Sidebar (Left)</option>
                                 <option value="right">Right Sidebar (Right)</option>
                             </select>
                        </div>
                        
                        <div style="background:#fff; padding:10px; border-radius:5px; border:1px solid #ffcc80; margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px; display:block; margin-bottom:5px;">2. Video Box Control (Move Anywhere):</span>
                             <div style="display:flex; gap:5px;">
                                 <span style="font-size:12px;">X:</span><input type="range" min="0" max="100" value="10" oninput="liveUpdate('tvX', this.value)">
                                 <span style="font-size:12px;">Y:</span><input type="range" min="0" max="100" value="5" oninput="liveUpdate('tvY', this.value)">
                             </div>
                             <div style="display:flex; gap:5px; margin-top:5px;">
                                 <span style="font-size:12px;">Width:</span><input type="range" min="10" max="100" value="80" oninput="liveUpdate('tvW', this.value)">
                                 <span style="font-size:12px;">Height:</span><input type="range" min="10" max="100" value="65" oninput="liveUpdate('tvH', this.value)">
                             </div>
                        </div>

                        <span style="font-weight:bold; font-size:14px;">3. Card Sizing:</span>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Width:</span>
                            <input type="range" min="20" max="100" value="95" oninput="liveUpdate('t5CardW', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Height:</span>
                            <input type="range" min="10" max="100" value="22" oninput="liveUpdate('t5CardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:14px; width:100px;">Photo Size:</span>
                            <input type="range" min="80" max="300" value="160" oninput="liveUpdate('t5PhotoSize', this.value)">
                        </div>
                        
                        <hr style="border:1px dashed #ffd54f; margin:10px 0;">
                        <span style="display:block; font-weight:bold; margin-bottom:5px; color:#ff6f00;">4. Top 5 Text Settings (Flexible):</span>
                        
                        <div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
                            <span style="font-size:12px; width:80px; font-weight:bold; color:blue;">‚Üï Text Y-Pos:</span>
                            <input type="range" min="-300" max="300" value="0" oninput="liveUpdate('t5TextY', this.value)">
                        </div>

                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (DV):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="3.0" oninput="liveUpdate('t5NameSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (EN):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="2.0" oninput="liveUpdate('t5EngSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px;">
                            <span style="font-size:12px; width:80px;">Details:</span>
                            <input type="range" min="0.5" max="3" step="0.1" value="1.5" oninput="liveUpdate('t5DetSize', this.value)">
                            <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                        </div>
                    </div>
                </div>
                
                <div class="group-box" style="border-color:#d4af37; background:#fff8e1;">
                    <span class="group-title" style="background:#ff8f00;">üèÖ Badges & Animation Control</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Move badges anywhere and select animations.</p>
                        
                        <div style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                           <span style="font-weight:bold; color:#ff6f00;">1. Star Badge:</span>

<div style="display:flex; gap:5px; margin-top:5px;">
    <span style="font-size:12px;">X:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeX', this.value)">
    <span style="font-size:12px;">Y:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeY', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
    <span style="font-size:12px; width:40px;">Size:</span>
    <input type="range" min="50" max="600" value="200" oninput="liveUpdate('starSize', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
    <span style="font-size:12px;">Anim:</span>
    <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
        <option value="none">None</option>
        <option value="spin">Spin (Rotate)</option>
        <option value="pulse">Pulse (Scale)</option>
        <option value="float">Float (Up/Down)</option>
    </select>
</div>
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="spin">Spin (Rotate)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="float">Float (Up/Down)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <span style="font-weight:bold; color:#ff6f00;">2. Trophy Badge:</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <span style="font-size:12px;">X:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyX', this.value)">
                                <span style="font-size:12px;">Y:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyY', this.value)">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('trophyAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="shine">Shine (Glow)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="zoom">Zoom In</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üåç Theme and Background</span>
                    <div class="design-col">
                        <span class="d-label">1. Wallpaper Background:</span>
                        <div style="display:flex; gap:10px;">
                            <select id="bgPresetSel" onchange="liveUpdate('bgPreset', this.value)" style="width:70%;">
    
    <optgroup label="üëë Royal Green (Royal Green)">
        <script> for(let i=1; i<=20; i++) document.write(`<option value="bg${i}">Royal Green ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë Royal Blue (Royal Blue)">
        <script> for(let i=21; i<=40; i++) document.write(`<option value="bg${i}">Royal Blue ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë Royal Red (Royal Red)">
        <script> for(let i=41; i<=60; i++) document.write(`<option value="bg${i}">Royal Red ${i}</option>`); </script>
    </optgroup>

    <optgroup label="‚ö´ Luxury Black (Luxury Black)">
        <script> for(let i=61; i<=80; i++) document.write(`<option value="bg${i}">Luxury Dark ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üåê Others (Modern/Mixed)">
        <script> for(let i=81; i<=200; i++) document.write(`<option value="bg${i}">Theme ${i}</option>`); </script>
    </optgroup>

</select>
                            <input type="file" id="jalsaBgFile" accept="video/*, image/*" style="width:30%" title="Upload Custom BG">
                        </div>
                        <div style="margin-top:8px;">
                            <select id="bgLoopSel" onchange="liveUpdate('bgLoop', this.value)" style="background:#fff;">
                                <option value="on">Video Loop: Yes</option>
                                <option value="off">Video Loop: No</option>
                            </select>
                        </div>
                        
                        <span class="d-label">2. Student Card Design (Normal Mode):</span>
<div style="display:flex; gap:10px;">

   <select id="cBorderSel" onchange="liveUpdate('cBorder', this.value)" style="width:75%;">
    <option value="custom_bg">üñºÔ∏è Custom Background (Image)</option>
    <option value="custom">üñºÔ∏è Custom Frame (Frame)</option>
    
    <optgroup label="üëë 1. The Golden State (Gold & Black)">
        <script> for(let i=1; i<=20; i++) document.write(`<option value="b${i}">Style ${i} - Presidential Gold</option>`); </script>
    </optgroup>

    <optgroup label="üå¥ 2. Royal Maldivian (Green & Gold)">
        <script> for(let i=21; i<=40; i++) document.write(`<option value="b${i}">Style ${i} - Royal Green</option>`); </script>
    </optgroup>

    <optgroup label="‚öì 3. The Diplomat (Blue & Silver)">
        <script> for(let i=41; i<=60; i++) document.write(`<option value="b${i}">Style ${i} - Royal Blue</option>`); </script>
    </optgroup>

    <optgroup label="üéñÔ∏è 4. The Red Carpet (Maroon & Red)">
        <script> for(let i=61; i<=80; i++) document.write(`<option value="b${i}">Style ${i} - Royal Red</option>`); </script>
    </optgroup>

    <optgroup label="üíé 5. Ultra Modern (Glass & VVIP)">
        <script> for(let i=81; i<=100; i++) document.write(`<option value="b${i}">Style ${i} - VVIP Modern</option>`); </script>
    </optgroup>

    <option value="b0">üö´ No Border (Transparent)</option>
</select>

    <input type="color" id="bdColorPick" value="#d4af37" oninput="liveUpdate('bdColor', this.value)" title="Theme Color">
</div>
                        <span class="d-label">3. Card Position:</span>
                        <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc;">
                            <span style="font-size:14px; font-weight:bold;">Right/Left:</span>
                            <input type="range" id="cardXRange" min="-600" max="600" value="0" oninput="liveUpdate('cardX', this.value)">
                            <span style="font-size:14px; font-weight:bold;">Top/Bottom:</span>
                            <input type="range" id="cardYRange" min="-450" max="450" value="0" oninput="liveUpdate('cardY', this.value)">
                        </div>

                        <span class="d-label">4. Card Size:</span>
                        <div style="display:flex; gap:15px; align-items:center;">
                            <span style="font-size:14px; font-weight:bold;">Width:</span>
                            <input type="range" id="cardWRange" min="50" max="100" value="90" oninput="liveUpdate('cardW', this.value)">
                            <span style="font-size:14px; font-weight:bold;">Height:</span>
                            <input type="range" id="cardHRange" min="50" max="100" value="80" oninput="liveUpdate('cardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <select id="layoutDirSel" onchange="liveUpdate('layoutDir', this.value)" style="width:50%;">
                                <option value="rtl">Photo on Right (RTL)</option>
                                <option value="ltr">Photo on Left (LTR)</option>
                            </select>
                            <select id="textAlignSel" onchange="liveUpdate('textAlign', this.value)" style="width:50%;">
                                <option value="right">Text: Right / Align Right</option>
                                <option value="center">Text: Center / Align Center</option>
                                <option value="left">Text: Left / Align Left</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üì∏ Photo Studio</span>
                    
                    <span class="d-label">1.Frame Style:</span>
                    <select id="photoPresetSel" onchange="applyPhotoPreset(this.value)" style="width:100%; font-weight:bold; font-size:15px; padding:10px;">
                        <option value="0">--- Select Frame Style ---</option>
                        <optgroup label="No Border or Shadow">
                            <option value="1">1. Normal (No Border)</option>
                            <option value="2">2. Soft Shadow</option>
                            <option value="3">3. Hard Shadow</option>
                            <option value="4">4. Glow</option>
                        </optgroup>
                        <optgroup label="Basic Borders">
                            <option value="5">5. Thin Black Line</option>
                            <option value="6">6. Thick Blue Frame</option>
                            <option value="7">7. Dotted Line</option>
                            <option value="8">8. Dashed Line</option>
                            <option value="9">9. Double Line</option>
                            <option value="10">10. Rounded Corners</option>
                            <option value="11">11. Circle</option>
                        </optgroup>
                        <optgroup label="Creative">
                            <option value="12">12. Inset 3D</option>
                            <option value="13">13. Outset 3D</option>
                            <option value="14">14. Polaroid Style</option>
                            <option value="15">15. Golden Groove</option>
                            <option value="16">16. Card Style</option>
                        </optgroup>
                    </select>

                    <span class="d-label">2. Frame Adjustment:</span>
                    <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #b2dfdb;">
                        <span style="font-size:14px;">ﬁÜﬁ™ﬁçﬁ¶:</span><input type="color" id="pfColorPick" value="#000000" oninput="liveUpdate('pfColor', this.value)">
                        <span style="font-size:14px;">ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞:</span><input type="range" id="pfWidthRange" min="0" max="30" value="0" oninput="liveUpdate('pfWidth', this.value)">
                        <span style="font-size:14px;">ﬁàﬁ¶ﬁÅﬁ∞:</span><input type="range" id="pfRadiusRange" min="0" max="50" value="0" oninput="liveUpdate('pfRadius', this.value)">
                    </div>
                    
                    <span class="d-label">3. Photo Position & Zoom:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:50px;">Zoom:</span>
                        <input type="range" id="pSizeRange" min="150" max="800" value="260" oninput="liveUpdate('pSize', this.value)">
                        <select id="pVisSel" onchange="liveUpdate('pVis', this.value)" style="width:100px;"><option value="show">show</option><option value="hide">hide</option></select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px; width:50px;">ﬁâﬁ´ﬁàﬁ∞:</span>
                        <input type="range" id="pXRange" min="-600" max="600" value="0" title="X" oninput="liveUpdate('pX', this.value)">
                        <input type="range" id="pYRange" min="-400" max="400" value="0" title="Y" oninput="liveUpdate('pY', this.value)">
                    </div>
                    <div style="margin-top:10px;">
                        <select id="pFitSel" onchange="liveUpdate('pFit', this.value)">
                            <option value="cover">Fit: Fill Box (Cover)</option>
                            <option value="contain">Fit: Full Photo (Contain)</option>
                        </select>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üî§ Text Alignment & Styling (Normal Mode)</span>
                    
                    <span class="d-label">1. Student Name (Size/Color):</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">Dhivehi:</span>
                        <input type="range" min="2" max="10" step="0.1" value="6.5" oninput="liveUpdate('tnDSize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">English:</span>
                        <input type="range" min="1" max="8" step="0.1" value="4.5" oninput="liveUpdate('tnESize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('nLine', this.value)" style="background:#fff;">
                            <option value="off">Underline Name: No</option>
                            <option value="on">Underline Name: Yes</option>
                        </select>
                    </div>
                    
                    <hr style="border:1px dashed #aaa; margin:12px 0;">

                    <span class="d-label">2. Detail Lines:</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">Line1:</span>
                        <input type="range" min="1" max="6" step="0.1" value="2.5" oninput="liveUpdate('tfDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:60px;">Line 2:</span>
                        <input type="range" min="1" max="6" step="0.1" value="3.0" oninput="liveUpdate('tcDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tcDColor', this.value)">
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üëë Event Titles</span>
                    
                    <span class="d-label">1. Main Title:</span>
                    <input type="text" id="jLine1" placeholder="Main Title..." class="font-dv" oninput="updateJalsaText()">
                    
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('tLine', this.value)" style="width:100%; background:#fff;">
                            <option value="on">Underline Main Title: YES</option>
                            <option value="off">Underline Main Title: NO</option>
                        </select>
                    </div>

                    <div style="display:flex; align-items:center; gap:15px; margin-top:8px; background:#fff; padding:10px; border-radius:8px; border:1px solid #bbdefb;">
                        <div style="flex:1;">
                            <span style="font-size:13px; color:#555; display:block;">Top/Bottom (Y):</span>
                            <input type="range" id="mtYRange" min="-600" max="600" value="210" oninput="liveUpdate('mtY', this.value)">
                            <span style="font-size:13px; color:#555; display:block;">Right/Left (X):</span>
                            <input type="range" id="mtXRange" min="-800" max="800" value="0" oninput="liveUpdate('mtX', this.value)">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                        <span style="font-size:14px;">Size:</span>
                        <input type="range" id="mtSizeRange" min="2" max="10" step="0.1" value="5.6" oninput="liveUpdate('mtSize', this.value)">
                        <input type="color" id="mtColorPick" value="#d4af37" oninput="liveUpdate('mtColor', this.value)">
                        <select id="mtAlignSel" onchange="liveUpdate('mtAlign', this.value)" style="width:100px;"><option value="center">Center</option><option value="right">Right</option><option value="left">Left</option></select>
                    </div>
                    <div style="margin-top:5px;">
                        <label style="font-size:13px;"><input type="checkbox" id="keepTitleCheck" onchange="liveUpdate('keepTitle', this.checked)"> Keep Title with Student Card</label>
                    </div>

                    <hr style="border:1px dashed #999; margin:15px 0;">

                    <span class="d-label">2. Subtitles (7 Lines):</span>
                    
                    <div style="background:#e8eaf6; padding:10px; border-radius:8px; border:1px solid #c5cae9; margin-bottom:10px;">
                        <label style="font-size:12px;">Edit Style for Line:</label>
                        <select id="stStyleSelector" style="font-size:12px; padding:5px; margin-bottom:5px;">
                            <option value="1">Line 1</option>
                            <option value="2">Line 2</option>
                            <option value="3">Line 3</option>
                            <option value="4">Line 4</option>
                            <option value="5">Line 5</option>
                            <option value="6">Line 6</option>
                            <option value="7">Line 7</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <input type="range" oninput="setSubtitleStyle('size', this.value)" min="1" max="6" step="0.1" value="2.6" title="Size">
                            <input type="color" oninput="setSubtitleStyle('color', this.value)" value="#ffffff" title="Color">
                        </div>
                    </div>

                    <input type="text" id="jLine2" placeholder="Subtitle 1" class="sub-title-input">
                    <input type="text" id="jLine3" placeholder="Subtitle 2" class="sub-title-input">
                    <input type="text" id="jLine4" placeholder="Subtitle 3" class="sub-title-input">
                    <input type="text" id="jLine5" placeholder="Subtitle 4" class="sub-title-input">
                    <input type="text" id="jLine6" placeholder="Subtitle 5" class="sub-title-input">
                    <input type="text" id="jLine7" placeholder="Subtitle 6" class="sub-title-input">
                    <input type="text" id="jLine8" placeholder="Subtitle 7" class="sub-title-input">
                    
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px;">Align:</span>
                        <select id="stAlignSel" onchange="liveUpdate('stAlign', this.value)" style="width:100%; background:#fff;">
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Y-Pos:</span>
                          <input type="range" id="stYRange" min="0" max="400" value="0" title="Space" oninput="liveUpdate('stY', this.value)">
                    </div>
                      <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Gap:</span>
                          <input type="range" id="stGapRange" min="0" max="100" value="5" title="Gap" oninput="liveUpdate('stGap', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('stLine', this.value)" style="background:#fff;">
                            <option value="off">Subtitle Underline: No</option>
                            <option value="on">Subtitle Underline: Yes</option>
                        </select>
                    </div>
                    
                    <button class="btn-vid" style="background:#2e7d32; width:100%; margin-top:15px; font-weight:bold; font-size:18px; padding:12px;" onclick="updateJalsaText()">Update Titles</button>
                </div>

                <div class="group-box">
                    <span class="group-title">üñºÔ∏è 5 Main Logo Manager</span>
                    <div style="background:#fff; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <label style="font-size:12px;">Select Logo to Move:</label>
                        <select id="activeLogoIdx" onchange="refreshLogoInputs()" style="width:100%;">
                            <option value="0">Logo 1</option>
                            <option value="1">Logo 2</option>
                            <option value="2">Logo 3</option>
                            <option value="3">Logo 4</option>
                            <option value="4">Logo 5</option>
                        </select>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Size:</span>
                        <input type="range" id="mlSize" min="20" max="500" value="100" oninput="updateLogoStyle('size', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">X-Pos:</span>
                        <input type="range" id="mlX" min="-950" max="950" value="0" oninput="updateLogoStyle('x', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Y-Pos:</span>
                        <input type="range" id="mlY" min="-500" max="500" value="0" oninput="updateLogoStyle('y', this.value)">
                    </div>
                    
                      <div style="margin-top:8px;">
                        <label style="font-size:12px; display:inline-flex; align-items:center;">
                            <input type="checkbox" id="logoAutoHideCheck" checked onchange="liveUpdate('logoAutoHide', this.checked)"> Hide Main Logos when Student Card appears
                        </label>
                        <button class="btn-vid" style="background:#37474f; margin-top:5px;" onclick="toggleMainLogos()">üëÅÔ∏è Toggle Main Logos</button>
                    </div>
                    
                    <hr>
                    <span class="d-label" style="font-size:14px;">Partner Logos Settings:</span>
                      <div style="margin-bottom:8px;">
                          <label style="font-size:12px; display:inline-flex; align-items:center;">
                              <input type="checkbox" id="plAutoHideCheck" checked onchange="liveUpdate('plAutoHide', this.checked)"> Hide Partner Logos when Student Card appears
                          </label>
                      </div>
                      <div style="margin-bottom:8px;">
                          <button class="btn-vid" style="background:#455a64;" onclick="togglePartnerLogos()">üëÅÔ∏è Toggle Partner Logos</button>
                      </div>
                    <div style="display:flex; gap:5px;">
                          <span>Gap:</span><input type="range" oninput="liveUpdate('plGap', this.value)" min="0" max="100" value="20">
                          <span>Size:</span><input type="range" oninput="liveUpdate('plSize', this.value)" min="50" max="300" value="100">
                    </div>
                      <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>Y-Pos:</span><input type="range" oninput="liveUpdate('plY', this.value)" min="-600" max="600" value="0">
                      </div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>X-Pos:</span><input type="range" oninput="liveUpdate('plX', this.value)" min="-800" max="800" value="0">
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // --- FULL SCREEN ---
    function toggleControlFS() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- IMPROVED SECURITY FUNCTION ---
function verifyLicense() {
    var inputKey = document.getElementById('licenseKey').value.trim();
    var msgArea = document.getElementById('secMsg');
    var overlay = document.getElementById('securityOverlay');

    // ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁáﬁÆﬁåﬁ∞ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if (!inputKey) {
        msgArea.innerText = "‚ö†Ô∏è Please enter the license key!";
        return;
    }

    try {
        // 1. Decode Key
        var decodedString = atob(inputKey); 
        
        // 2. Strict Validation Check
        if (decodedString.indexOf("ROYAL_EXP_") !== 0) {
            throw new Error("Invalid Format");
        }

        var parts = decodedString.split('_');
        if (parts.length < 5) throw new Error("Incomplete Key");

        var expDateString = parts[2]; 
        var custName = parts[4];      
        var expDate = new Date(expDateString);
        var today = new Date();
        today.setHours(0,0,0,0); 

        // 3. Check Expiry
        if (today > expDate) {
            msgArea.innerText = "‚ùå The license has expired!";
            msgArea.style.color = "red";
            return;
        }

        // 4. Success - Remove Overlay completely from DOM
        // (ﬁâﬁ®ﬁáﬁ© ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁÜﬁØﬁëﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÉﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁåﬁ¨ﬁÉﬁ® ﬁéﬁÆﬁåﬁ¨ﬁÜﬁ¨ﬁàﬁ¨. ﬁçﬁÆﬁÜﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁßﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨.)
        overlay.style.opacity = '0';
        setTimeout(function(){
            overlay.remove(); 
        }, 500);

        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('licenseStatus').innerText = "‚úÖ PLATINUM ACTIVE | " + custName;

    } catch (e) {
        msgArea.innerText = "‚ùå The key is incorrect!";
        msgArea.style.color = "red";
        document.getElementById('licenseKey').value = ""; // Clear input for security
    }
}
    // Allow "Enter" key to submit
    document.getElementById('licenseKey').addEventListener("keyup", e => { if (e.key === "Enter") verifyLicense(); });
  
    let tvWindow = null;
    let students = [];
    let photoFiles = {};
    
    // Top 5 Separation Arrays
    let top5Students = [];
    let top5PhotoFiles = {};
    let activeListMode = 'general'; 
    let top5VideoPlaylist = []; 
    
    let partnerLogosData = [];
    let mainLogosData = [];
    let adFiles = [];
    let adInterval = null;
    let adIndex = 0;
    let currentPhotoData = null;
    let currentFontData = null;
    let currentJalsaBgData = null;
    let currentJalsaBgType = 'none';
    let customBorderData = null;
    let customCardBgData = null;
    let royalStarData = null;
    let trophyData = null;
    
    let isLocked = false;
    let lastActiveState = 'title'; 
    let playlist = [];
    let currentVidIdx = 0;
    let pdfUrl = null;

    // Subtitle Styles Logic
    let stStyles = {};
    for(let i=1; i<=8; i++) stStyles[i] = { size: 2.6, color: '#ffffff' };

    function setSubtitleStyle(prop, val) {
        let line = document.getElementById('stStyleSelector').value;
        if(prop === 'size') stStyles[line].size = val;
        if(prop === 'color') stStyles[line].color = val;
        updateJalsaText();
    }

    // --- STATE MANAGER ---
   // --- STATE MANAGER (UPDATED FOR ROYAL GREEN DEFAULT) ---
    let designState = {
        // 1. Title Colors (Gold Default)
        mtY: 210, mtX: 0, mtSize: 5.6, 
        mtColor: '#FFD700', // ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶ (Royal Gold)
        mtAlign: 'center', tLine: 'on', keepTitle: false,
        
        stY: 0, stX: 0, stGap: 5, stLine: 'off', stAlign: 'center',
        
        logos: [
            {x:0, y:-300, s:150}, {x:-400, y:-300, s:100}, {x:400, y:-300, s:100}, {x:0, y:300, s:100}, {x:0, y:0, s:100}
        ],
        logoVisible: true, logoAutoHide: true,
        plGap: 20, plSize: 100, plAutoHide: true, plVisible: true, plY: 20, plX: 0,
        pSize: 260, pX: 0, pY: 0, pVis: 'show', pFit: 'cover',
        pfWidth: 0, pfColor: '#000000', pfStyle: 'solid', pfRadius: 0, pfShadow: 'none',
        
        // 2. Card & Background Defaults
        cBorder: 'b1',      // Style 1 (Royal Green Border)
        bdColor: '#FFD700', // Theme Color (Gold)
        bgPreset: 'bg1',    // Background 1 (Royal Green Wallpaper)
        
        layoutDir: 'rtl', textAlign: 'right', bgLoop: 'on',
        
        // 3. Student Name Colors (Gold & White)
        tnDSize: 6.5, 
        tnDColor: '#FFD700', // ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®) - ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶
        tnESize: 4.5, 
        tnEColor: '#ffffff', // Name (English) - White
        nLine: 'off',
        
        tfDSize: 2.5, tfDColor: '#fff9c4', tcDSize: 3.0, tcDColor: '#fff9c4',
        cardW: 90, cardH: 80, cardX: 0, cardY: 0,
        
        // TOP 5 SPECIFIC VARIABLES
        t5CardW: 95, t5CardH: 22, t5Bottom: 2, t5PhotoSize: 160,
        t5NameSize: 3.0, t5EngSize: 2.0, t5DetSize: 1.5,
        t5TextY: 0, 
        t5Layout: 'bottom', 
        tvX: 10, tvY: 5, tvW: 80, tvH: 65, 
        
        // BADGES & ANIMATIONS
        badgeX: -20, badgeY: -20, badgeAnim: 'none',
        trophyX: -10, trophyY: -10, trophyAnim: 'none'
    };

    // --- MAIN LOGO MANAGER (MEMORY SAFE VERSION) ---
function loadMainLogos(input) {
    // 1. ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÉﬁ® ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁâﬁ¨ﬁâﬁÆﬁÉﬁ© ﬁêﬁßﬁäﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ (ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
    if (typeof mainLogosData !== 'undefined' && mainLogosData.length > 0) {
        mainLogosData.forEach(url => URL.revokeObjectURL(url));
    }

    // 2. ﬁáﬁß ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞ ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    mainLogosData = [];
    for(let f of input.files) {
        let url = URL.createObjectURL(f);
        mainLogosData.push(url);
    }

    renderMainLogos();
    alert(mainLogosData.length + " Main Logos Loaded (Memory Optimized).");
}

    function renderMainLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const container = tvWindow.document.getElementById('mainLogosContainer');
        container.innerHTML = '';
        mainLogosData.forEach((src, idx) => {
            if(idx >= 5) return;
            const img = tvWindow.document.createElement('img');
            img.src = src;
            img.id = 'ml-'+idx;
            img.className = 'main-logo-img';
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
            container.appendChild(img);
        });
    }

    function refreshLogoInputs() {
        const idx = document.getElementById('activeLogoIdx').value;
        const st = designState.logos[idx];
        document.getElementById('mlSize').value = st.s;
        document.getElementById('mlX').value = st.x;
        document.getElementById('mlY').value = st.y;
    }

    function updateLogoStyle(prop, val) {
        const idx = document.getElementById('activeLogoIdx').value;
        designState.logos[idx][prop.replace('size', 's')] = parseInt(val); 
        
        if(!tvWindow || tvWindow.closed) return;
        const img = tvWindow.document.getElementById('ml-'+idx);
        if(img) {
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
        }
    }

    function toggleMainLogos() {
        designState.logoVisible = !designState.logoVisible;
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('mainLogosContainer').style.opacity = designState.logoVisible ? '1' : '0';
    }

    // --- LOCK FUNCTION (FINAL FIXED VERSION) ---
    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        
        // ﬁïﬁ≠ﬁñﬁ™ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁßﬁáﬁ®ÿå ﬁáﬁ®ﬁÇﬁ∞ﬁïﬁ™ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁÆﬁàﬁßﬁçﬁ™ﬁÇﬁ∞
        const allElements = document.querySelectorAll('input, select, textarea, button');

        // ﬁàﬁ®ﬁùﬁ™ﬁáﬁ¶ﬁçﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (ﬁÜﬁ™ﬁçﬁ¶ ﬁäﬁ¶ﬁÇﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞)
        const sidebarFiles = document.getElementById('sidebarFiles');
        const designPanel = document.getElementById('designPanel');

        if (isLocked) {
            // --- LOCK MODE ON ---
            btn.innerHTML = "üîí SYSTEM LOCKED (LIVE MODE)";
            btn.classList.add('active');

            // ﬁêﬁ¶ﬁáﬁ®ﬁëﬁ∞ﬁÑﬁß ﬁáﬁ¶ﬁãﬁ® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¨ ﬁÜﬁ™ﬁçﬁ¶ ﬁäﬁ¶ﬁÇﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞
            if(sidebarFiles) sidebarFiles.classList.add('locked-zone');
            if(designPanel) designPanel.classList.add('locked-zone');

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁÆﬁÅﬁ∞ÿå ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁÄﬁ® ﬁçﬁÆﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            allElements.forEach(el => {
                // 1. ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁâﬁ® ﬁçﬁ®ﬁîﬁ¶ﬁÇﬁ© ﬁçﬁÆﬁÜﬁ∞ ﬁÇﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁãﬁ´ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (EXCEPTIONS)
                if (
                    el.id === 'lockBtn' ||                   // ﬁçﬁÆﬁÜﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                    el.id === 'cpFsBtn' ||                   // ﬁäﬁ™ﬁçﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                    el.closest('#listPanel') ||              // ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ / ﬁìﬁÆﬁïﬁ∞ 5 / ﬁêﬁ∞ﬁìﬁ´ﬁëﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.closest('.video-panel') ||            // ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁáﬁ¶ﬁãﬁ® ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁÑﬁ¶ﬁáﬁ®
                    el.closest('.controls') ||               // ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞/ﬁÇﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞/ﬁÑﬁ¨ﬁÜﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.closest('.lang-tabs') ||              // ﬁÑﬁ¶ﬁÄﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.classList.contains('sec-input') ||    // ﬁêﬁ¨ﬁÜﬁ®ﬁáﬁ™ﬁÉﬁ®ﬁìﬁ© ﬁïﬁ®ﬁÇﬁ∞ ﬁñﬁ¶ﬁÄﬁßﬁÑﬁ¶ﬁáﬁ®
                    el.classList.contains('sec-btn')         // ﬁêﬁ¨ﬁÜﬁ®ﬁáﬁ™ﬁÉﬁ®ﬁìﬁ© ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                ) {
                    // ﬁâﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ© ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ® (Do Nothing)
                    el.disabled = false; 
                } else {
                    // 2. ﬁãﬁ¨ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁçﬁÆﬁÜﬁ∞ ﬁàﬁßﬁÇﬁ¨ (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁîﬁßﬁáﬁ® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁáﬁ® ﬁÄﬁ®ﬁâﬁ¨ﬁÇﬁ≠ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞)
                    el.disabled = true;
                }
            });
            
        } else {
            // --- UNLOCK MODE ---
            btn.innerHTML = "üîì ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ® (ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ ﬁâﬁØﬁëﬁ™)";
            btn.classList.remove('active');

            // ﬁÜﬁ™ﬁçﬁ¶ ﬁáﬁ¶ﬁÇﬁÑﬁ™ﬁÉﬁß ﬁéﬁ¨ﬁÇﬁ¶ﬁáﬁ™ﬁÇﬁ∞
            if(sidebarFiles) sidebarFiles.classList.remove('locked-zone');
            if(designPanel) designPanel.classList.remove('locked-zone');

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁáﬁ¨ﬁÇﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            allElements.forEach(el => el.disabled = false);
        }
    }
    // --- UPDATED SAVE FUNCTION (COMBINED & FIXED) ---
function downloadConfig() {
    // 1. Save Subtitle Specific Styles
    designState.savedStStyles = stStyles;

    // 2. Save Written Titles (Saves what you typed in the boxes)
    designState.savedTitles = {
        t1: document.getElementById('jLine1').value,
        t2: document.getElementById('jLine2').value,
        t3: document.getElementById('jLine3').value,
        t4: document.getElementById('jLine4').value,
        t5: document.getElementById('jLine5').value,
        t6: document.getElementById('jLine6').value,
        t7: document.getElementById('jLine7').value,
        t8: document.getElementById('jLine8').value
    };

    // 3. Create and Download the File
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(designState));
    const a = document.createElement('a');
    a.href = dataStr;
    a.download = "royal_config_v33_full.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
}

    function loadConfig(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loaded = JSON.parse(e.target.result);
                Object.assign(designState, loaded);
                
                // --- RESTORE SUBTITLE STYLES ---
                if(loaded.savedStStyles) {
                    stStyles = loaded.savedStStyles;
                }

                // --- RESTORE WRITTEN TITLES ---
                if(loaded.savedTitles) {
                    document.getElementById('jLine1').value = loaded.savedTitles.t1 || "";
                    document.getElementById('jLine2').value = loaded.savedTitles.t2 || "";
                    document.getElementById('jLine3').value = loaded.savedTitles.t3 || "";
                    document.getElementById('jLine4').value = loaded.savedTitles.t4 || "";
                    document.getElementById('jLine5').value = loaded.savedTitles.t5 || "";
                    document.getElementById('jLine6').value = loaded.savedTitles.t6 || "";
                    document.getElementById('jLine7').value = loaded.savedTitles.t7 || "";
                    document.getElementById('jLine8').value = loaded.savedTitles.t8 || "";
                }

                if(tvWindow && !tvWindow.closed) { 
                    for (const key in designState) { liveUpdate(key, designState[key]); }
                    renderMainLogos(); 
                    
                    // Force update titles visually on TV
                    updateJalsaText();
                }
                
                // Update checkbox states based on loaded settings
                if(designState.plAutoHide !== undefined) document.getElementById('plAutoHideCheck').checked = designState.plAutoHide;
                if(designState.logoAutoHide !== undefined) document.getElementById('logoAutoHideCheck').checked = designState.logoAutoHide;
                if(designState.keepTitle !== undefined) document.getElementById('keepTitleCheck').checked = designState.keepTitle;
                if(designState.t5Layout !== undefined) document.getElementById('t5LayoutSel').value = designState.t5Layout;
                
                refreshLogoInputs();
                alert("Settings & Titles Loaded Successfully!");

            } catch(err) { 
                console.error(err);
                alert("Invalid Config File"); 
            }
        };
        reader.readAsText(file);
    }
    function setVal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

    function applyPhotoPreset(val) {
        let w = 0, c = '#000000', s = 'solid', r = 0, sh = 'none';
        switch(val) {
            case "1": break;
            case "2": sh = '0 4px 8px rgba(0,0,0,0.3)'; break;
            case "3": sh = '5px 5px 0px rgba(0,0,0,1)'; break;
            case "4": sh = '0 0 15px rgba(0, 150, 255, 0.6)'; break;
            case "5": w=1; break;
            case "6": w=6; c='#0056b3'; break;
            case "7": w=4; c='#d9534f'; s='dotted'; break;
            case "8": w=4; c='#5cb85c'; s='dashed'; break;
            case "9": w=6; c='#f0ad4e'; s='double'; break;
            case "10": w=3; c='#333333'; r=10; break;
            case "11": w=3; c='#5bc0de'; r=50; break;
            case "12": w=10; c='#999999'; s='inset'; break;
            case "13": w=10; c='#999999'; s='outset'; break;
            case "14": w=15; c='#ffffff'; sh='0 2px 5px rgba(0,0,0,0.3)'; break;
            case "15": w=8; c='#FFD700'; s='groove'; break;
            case "16": w=5; c='#ffffff'; r=5; sh='0 4px 6px rgba(0,0,0,0.1)'; break;
        }
        setVal('pfWidthRange', w); setVal('pfColorPick', c); setVal('pfRadiusRange', r);
        liveUpdate('pfWidth', w); liveUpdate('pfColor', c); liveUpdate('pfStyle', s); 
        liveUpdate('pfRadius', r); liveUpdate('pfShadow', sh);
    }

   function liveUpdate(key, value) {
        if(isLocked) return; 
        designState[key] = value;
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        const root = doc.documentElement;

        // --- ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¶ﬁçﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁÑﬁ¶ﬁáﬁ® (STAR SIZE) ---
        if(key === 'starSize') {
             root.style.setProperty('--star-s', value + 'px');
        }
        // -------------------------------------------
// ﬁìﬁÆﬁïﬁ∞ 5 ﬁìﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁáﬁ¨ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞
        if(key === 't5Align') {
             root.style.setProperty('--t5-align', value);
             
             if(value === 'left') root.style.setProperty('--t5-flex-align', 'flex-start');
             else if(value === 'right') root.style.setProperty('--t5-flex-align', 'flex-end');
             else root.style.setProperty('--t5-flex-align', 'center');
        }
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        if(key === 'trophyX') root.style.setProperty('--troph-x', value + 'px');
        if(key === 'trophyY') root.style.setProperty('--troph-y', value + 'px');
        
        if(key === 'badgeAnim') {
            const el = doc.getElementById('royalStar');
            el.className = 'royal-star-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }
        if(key === 'trophyAnim') {
            const el = doc.getElementById('trophyWrap');
            el.className = 'trophy-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }

        // TOP 5 VARIABLES & VIDEO POS
        if(key === 't5CardW') root.style.setProperty('--t5-w', value + (designState.t5Layout==='bottom'?'%':'vw'));
        if(key === 't5CardH') root.style.setProperty('--t5-h', value + (designState.t5Layout==='bottom'?'%':'vh'));
        if(key === 't5Bottom') root.style.setProperty('--t5-b', value + '%');
        if(key === 't5PhotoSize') root.style.setProperty('--t5-p', value + 'px');
        if(key === 't5TextY') root.style.setProperty('--t5-text-y', value + 'px');
        
        if(key === 'tvX') root.style.setProperty('--tv-x', value + '%');
        if(key === 'tvY') root.style.setProperty('--tv-y', value + '%');
        if(key === 'tvW') root.style.setProperty('--tv-w', value + '%');
        if(key === 'tvH') root.style.setProperty('--tv-h', value + '%');
        
        if(key === 't5Layout') {
            const card = doc.getElementById('card');
            card.classList.remove('t5-bottom', 't5-left', 't5-right');
            card.classList.add('t5-' + value);
            liveUpdate('t5CardW', designState.t5CardW);
            liveUpdate('t5CardH', designState.t5CardH);
        }
        
        if(key === 't5NameSize') root.style.setProperty('--t5-n-s', value + 'em');
        if(key === 't5EngSize') root.style.setProperty('--t5-e-s', value + 'em');
        if(key === 't5DetSize') root.style.setProperty('--t5-d-s', value + 'em');

        if(key === 'pfWidth' || key === 'pfColor' || key === 'pfStyle' || key === 'pfRadius' || key === 'pfShadow') {
            const img = doc.getElementById('stuImg');
            if(img) {
                if(key === 'pfShadow') img.style.boxShadow = value;
                else {
                    img.style.borderWidth = designState.pfWidth + 'px';
                    img.style.borderColor = designState.pfColor;
                    img.style.borderStyle = designState.pfStyle;
                    img.style.borderRadius = designState.pfRadius + '%';
                }
            }
        }

        if(key === 'cardW') { const c = doc.getElementById('card'); if(c) { c.style.width = value + 'vw'; if(value>90) c.style.maxWidth='none'; else c.style.maxWidth='1500px'; } }
        if(key === 'cardH') { const c = doc.getElementById('card'); if(c) c.style.height = value + 'vh'; }
        if(key === 'cardX' || key === 'cardY') { 
            const c = doc.getElementById('card'); 
            if(c) c.style.transform = `translate(calc(-50% + ${designState.cardX}px), calc(-50% + ${designState.cardY}px))`; 
        }

        if(key === 'pVis') { const el = doc.querySelector('.photo-col'); if(el) el.style.visibility = (value === 'show') ? 'visible' : 'hidden'; }
        
        if(key === 'lSize') { const logoImg = doc.getElementById('logoImg'); if(logoImg) logoImg.style.height = value + 'px'; }
        if(key === 'bgLoop') { const vid = doc.getElementById('bgVid'); if(vid) vid.style.display = (value === 'on') ? 'block' : 'none'; }
        if(key === 'layoutDir') { const card = doc.getElementById('card'); if(card) card.style.flexDirection = (value === 'rtl') ? 'row-reverse' : 'row'; }
        if(key === 'textAlign') { const txt = doc.querySelector('.text-col'); if(txt) txt.style.textAlign = value; }
        if(key === 'bgPreset') { const bg = doc.getElementById('bgLayer'); if(bg) { bg.className = ''; bg.classList.add(value); } }
        if(key === 'bdColor') { doc.documentElement.style.setProperty('--theme-color', value); }
        
        if(key === 'mtY' || key === 'mtX') doc.getElementById('titleContainer').style.transform = `translate(${designState.mtX}px, ${designState.mtY}px)`;
        if(key === 'mtSize') doc.getElementById('jt1').style.fontSize = value + 'em';
        if(key === 'mtColor') { 
            const el = doc.getElementById('jt1'); el.style.color = value; 
            if(designState.tLine === 'on') el.style.borderBottomColor = value; 
        }
        if(key === 'tLine') {
            const el = doc.getElementById('jt1');
            if(value === 'on') { el.style.borderBottom = '3px solid ' + designState.mtColor; el.style.paddingBottom = '10px'; }
            else { el.style.borderBottom = 'none'; el.style.paddingBottom = '0'; }
        }
        if(key === 'mtAlign') { doc.getElementById('mainTitleWrap').style.textAlign = value; doc.getElementById('jt1').style.textAlign = value; }

        if(key === 'stY') doc.getElementById('subTitleWrap').style.marginTop = value + 'px';
        if(key === 'stGap') doc.getElementById('subTitleWrap').style.gap = value + 'px';
        if(key === 'stAlign') doc.getElementById('subTitleWrap').style.textAlign = value;
        if(key === 'stLine') { updateJalsaText(); }
        
        if(key === 'plSize') doc.querySelectorAll('.pl-img').forEach(el => el.style.height = value + 'px');
        if(key === 'plGap') doc.getElementById('plContainer').style.gap = value + 'px';
        if(key === 'plY') doc.getElementById('plContainer').style.bottom = value + 'px';
        if(key === 'plX') doc.getElementById('plContainer').style.transform = `translateX(${value}px)`;

        if(key === 'tnDColor') doc.getElementById('tnD').style.color = value;
        if(key === 'tnDSize') doc.getElementById('tnD').style.fontSize = value + 'em';
        if(key === 'tnESize') doc.getElementById('tnE').style.fontSize = value + 'em';
        if(key === 'tnEColor') doc.getElementById('tnE').style.color = value;
        
        if(key === 'nLine') {
            const h2 = doc.getElementById('tnE'); 
            if(value === 'on') { h2.style.borderBottom = '2px solid var(--theme-color)'; h2.style.display='inline-block'; }
            else { h2.style.borderBottom = 'none'; }
        }

        if(key === 'tfDSize') { doc.getElementById('tfD').style.fontSize = value + 'em'; doc.getElementById('tfE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tfDColor') { doc.getElementById('tfD').style.color = value; doc.getElementById('tfE').style.color = value; }
        if(key === 'tcDSize') { doc.getElementById('tcD').style.fontSize = value + 'em'; doc.getElementById('tcE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tcDColor') { doc.getElementById('tcD').style.color = value; doc.getElementById('tcE').style.color = value; }
        
        if(key === 'pSize') { const img = doc.getElementById('stuImg'); if(img) { img.style.width = value+'px'; img.style.height = value+'px'; } }
        if(key === 'pX' || key === 'pY') { const el = doc.querySelector('.photo-col'); if(el) el.style.transform = `translate(${designState.pX}px, ${designState.pY}px)`; }
        if(key === 'pFit') { const img = doc.getElementById('stuImg'); if(img) img.style.objectFit = value; }

        if(key === 'cBorder') {
            const card = doc.getElementById('card');
            if(card) {
                card.className = ''; card.classList.add(value);
                if(document.getElementById('top5ModeCheck').checked) card.classList.add('t5-'+designState.t5Layout);
                
                if(value === 'custom' && customBorderData) {
                    card.style.backgroundImage = `url(${customBorderData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else if (value === 'custom_bg' && customCardBgData) {
                    card.style.backgroundImage = `url(${customCardBgData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else { card.style.backgroundImage = "none"; }
                
                if(value !== 'b1' && value !== 'b0') card.classList.add('active');
            }
        }
    }

    // ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº 3. UPDATED OPEN TV FUNCTION ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
function openTV() {
    tvWindow = window.open('', 'GradTV', 'width=1280,height=720,menubar=no,toolbar=no');
    if(!tvWindow) { alert("Please Allow Popups!"); return; }

    let fontCSS = `url('Fonts/faruuma.ttf') format('truetype')`;
    if (currentFontData) fontCSS = `url('${currentFontData}') format('truetype')`;

    // THEME GENERATION CODE (Standard)
    let cssGen = "";
    const makeGrad = (c1, c2, type="linear") => type === "radial" ? `radial-gradient(circle, ${c1}, ${c2})` : `linear-gradient(to bottom right, ${c1}, ${c2})`;
    
    // --- (Keeping your existing Theme Loop Logic) ---
    const baseStyles = ["border: 4px solid #FFD700; background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); border-radius: 12px;"]; 
    for(let i=0; i<200; i++) {
        // Just a placeholder loop to prevent errors if you copy-paste directly. 
        // In your real code, KEEP THE BIG THEME LOOPS HERE.
        let style = baseStyles[0]; 
        cssGen += `.b${i+1} { ${style} }\n`; 
        cssGen += `.b${i+1} #top5List > div, .b${i+1} .t5-item { position: relative !important; width: 96% !important; height: auto !important; margin: 8px auto !important; display: flex !important; align-items: center !important; }\n`;
        cssGen += `.bg${i+1} { background: #004d40; }\n`; 
    }

    const html = `
    <!DOCTYPE html>
    <html lang="dv" dir="rtl">
    <head>
        <style>
            @font-face { font-family: 'Faruuma'; src: ${fontCSS}; }
            :root { 
                --theme-color: ${designState.bdColor}; 
                --t5-w: ${designState.t5CardW}${designState.t5Layout==='bottom'?'%':'vw'}; 
                --t5-h: ${designState.t5CardH}${designState.t5Layout==='bottom'?'%':'vh'}; 
                --t5-b: ${designState.t5Bottom}%; --t5-p: ${designState.t5PhotoSize}px;
                --t5-n-s: ${designState.t5NameSize}em; --t5-e-s: ${designState.t5EngSize}em; --t5-d-s: ${designState.t5DetSize}em;
                --t5-text-y: ${designState.t5TextY}px;
                --tv-x: ${designState.tvX}%; --tv-y: ${designState.tvY}%;
                --tv-w: ${designState.tvW}%; --tv-h: ${designState.tvH}%;
                --star-x: ${designState.badgeX}px; --star-y: ${designState.badgeY}px;
                --troph-x: ${designState.trophyX}px; --troph-y: ${designState.trophyY}px;
                --star-s: ${designState.starSize || 200}px;
            }
            
            /* === MASTER LAYOUT FOR ANY SCREEN === */
            body { 
                margin:0; overflow:hidden; background:#000; user-select:none;
                /* Flexbox to center the Master Stage */
                display: flex; align-items: center; justify-content: center;
                width: 100vw; height: 100vh;
            }

            /* === THE STAGE (SCALABLE CONTAINER) === */
            #masterStage {
                width: 100%;  /* Controlled by Slider */
                height: 100%; /* Controlled by Slider */
                position: relative;
                overflow: hidden; /* Clips content outside */
                box-shadow: 0 0 0 2px #333; /* Border to see edges */
                flex-shrink: 0;
                transition: width 0.1s, height 0.1s; /* Smooth resizing */
            }

            ${cssGen}
            
            /* CONTENT STYLES */
            #jalsaContent { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; transition: opacity 0.8s ease; opacity:1; }
            #jalsaContent.hidden { opacity: 0; pointer-events:none; visibility: hidden; }
            
            #titleContainer { width: 90%; max-width: 1600px; text-align: center; } 
            #mainTitleWrap { width: 100%; text-align: ${designState.mtAlign}; } 
            #subTitleWrap { width: 100%; text-align: ${designState.stAlign}; display:flex; flex-direction:column; gap:${designState.stGap}px; } 

            .jalsa-text { direction: rtl; display:block; width:100%; font-family: 'Faruuma', serif; }
            .main-title { font-size: ${designState.mtSize}em; color: ${designState.mtColor}; text-shadow: 2px 2px 10px black; margin-bottom: 20px; border-bottom: 3px solid ${designState.mtColor}; padding-bottom:10px; }
            .sub-title { font-size: ${designState.stSize}em; color: ${designState.stColor}; text-shadow: 1px 1px 5px black; margin: 0; line-height:1.2; }
            
            #bgLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:-1; transition: background 0.5s ease; }
            
            #card { 
                position:absolute; top:54%; left:50%; transform:translate(-50%,-50%); 
                width:${designState.cardW}vw; height:${designState.cardH}vh; 
                display:flex; flex-direction:${designState.layoutDir === 'rtl' ? 'row-reverse' : 'row'}; 
                align-items:center; padding:3vh; box-sizing:border-box; 
                opacity:0; transition:all 0.5s ease; z-index:5001; 
            }
            #card.active { opacity:1; }
            
            /* UTILS */
            .font-dv { font-family: 'Faruuma', serif; }
            .font-en { font-family: 'Times New Roman', serif; direction:ltr; }
            .photo-col { position:relative; flex:0 0 auto; display:flex; justify-content:center; align-items:center; height: 100%; }
            #stuImg { width:${designState.pSize}px; height:${designState.pSize}px; object-fit:${designState.pFit}; background:#000; transition: all 0.3s ease; border-radius: ${designState.pfRadius}%; }
            .text-col { flex:1; text-align:${designState.textAlign}; padding:0 30px; color:white; display:flex; flex-direction:column; justify-content:center; }
            h1 { font-size: 5em; margin:0; color:#fff; }
            h2 { font-size: 3em; margin:10px 0; color:var(--theme-color); }
            
            /* LAYERS */
            #mainLogosContainer, #plContainer, #videoLayer, #adLayer { position: absolute; }
            
            /* 3-SCREEN ZONES */
            .screen-zone { position: fixed; top: 0; height: 100%; width: 16.666%; background-size: cover; background-position: center; z-index: 6000; display: none; background-color: #000; }
            #zoneLeft { left: 0; border-right: 2px solid rgba(255,255,255,0.2); }
            #zoneRight { right: 0; border-left: 2px solid rgba(255,255,255,0.2); }
            body.triple-active #zoneLeft, body.triple-active #zoneRight { display: flex; }
            
        </style>
        <script>function goFS(btn){document.documentElement.requestFullscreen(); btn.style.display='none';}<\/script>
    </head>
    <body>
    
    <div id="masterStage">
    
        <div id="zoneLeft" class="screen-zone"></div>
        <div id="zoneRight" class="screen-zone"></div>

        <div id="adLayer"></div>
        <div id="videoLayer"></div>
        <div id="bgLayer" class="${designState.bgPreset}"></div>
        <div id="mainLogosContainer"></div>
        <div id="plContainer"></div>

        <div id="jalsaContent">
            <div id="titleContainer" style="margin-top:${designState.mtY}px;"> 
                <div id="mainTitleWrap"><div id="jt1" class="main-title jalsa-text"></div></div>
                <div id="subTitleWrap">
                    <div id="jt2" class="sub-title jalsa-text"></div>
                    <div id="jt3" class="sub-title jalsa-text"></div>
                    </div>
            </div>
        </div>

        <div id="card" class="${designState.cBorder}">
            <div class="photo-col">
                <img id="stuImg" src="">
                <img id="royalStar" class="royal-star-badge" src="">
                <div id="trophyWrap" class="trophy-badge"><img id="trophyImg" src=""><span id="rankNum" class="rank-num"></span></div>
            </div>
            <div class="text-col">
                <h1 id="tnD" class="font-dv"></h1><h2 id="tnE" class="font-en"></h2>
                <div id="tfD" class="fac-dv font-dv"></div><div id="tfE" class="fac-en font-en"></div>
                <div id="tcD" class="crs-dv font-dv"></div><div id="tcE" class="crs-en font-en"></div>
                <div id="tcm" class="comm font-dv"></div>
            </div>
        </div>
        
        <button id="fsBtn" onclick="goFS(this)">‚õ∂ FULL SCREEN</button>

    </div> 
    </body>
    </html>`;

    tvWindow.document.write(html);
    tvWindow.document.close();

    renderMainLogos(); 
    updateJalsaBackground();
    updatePartnerLogos();
    setTimeout(() => { updateJalsaText(); for (const key in designState) { liveUpdate(key, designState[key]); } }, 500);

    document.getElementById('connStatus').innerText = "‚úÖ UNIVERSAL FIT READY";
}
// ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤ END UPDATED FUNCTION ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤
    function updateJalsaBackground() {
        if(!tvWindow || tvWindow.closed || !currentJalsaBgData) return;
        const bgDiv = tvWindow.document.getElementById('bgLayer');
        if(currentJalsaBgType === 'video') {
            bgDiv.innerHTML = `<video id="bgVid" src="${currentJalsaBgData}" autoplay loop muted style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;"></video>`;
            setTimeout(() => { const v = tvWindow.document.getElementById('bgVid'); if(v) v.play().catch(e=>{}); }, 500);
        } else if (currentJalsaBgType === 'image') {
            bgDiv.innerHTML = `<img src="${currentJalsaBgData}" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;">`;
        }
    }

    function forceShowTitles() {
        if(!tvWindow || tvWindow.closed) return;
        updateJalsaText();
        tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
        tvWindow.document.body.classList.remove('overlay-mode', 'top5-mode');
    }

    // --- NEW NAVIGATION FUNCTIONS ---
    function forceStudentCard() {
        switchListMode('general');
        updateTV();
    }

    function forceTop5() {
        switchListMode('top5');
        updateTV();
    }

    function updateJalsaText() {
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        doc.getElementById('jt1').innerText = document.getElementById('jLine1').value;
        
        for(let i=2; i<=8; i++) {
             let txt = document.getElementById('jLine'+i).value;
             let el = doc.getElementById('jt'+i);
             el.innerText = txt;
             if(stStyles[i-1]) {
                 el.style.fontSize = stStyles[i-1].size + 'em';
                 el.style.color = stStyles[i-1].color;
             }
             if(designState.stLine === 'on') {
                 el.style.borderBottom = `2px solid ${stStyles[i-1].color}`;
                 el.style.display = 'inline-block';
             } else {
                 el.style.borderBottom = 'none';
                 el.style.display = 'block';
             }
        }
        
        if(currentFontData) {
             const style = doc.createElement('style');
             style.innerHTML = `@font-face { font-family: 'Faruuma'; src: url('${currentFontData}') format('truetype'); } .jalsa-text, .font-dv { font-family: 'Faruuma', 'Amiri', serif !important; }`;
             doc.head.appendChild(style);
        }
    }

    function showJalsaScreen() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('card').classList.remove('active');
        const jContent = tvWindow.document.getElementById('jalsaContent');
        jContent.classList.remove('hidden');
        jContent.style.opacity = '1'; 
        jContent.style.display = 'flex'; 
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoVisible) mainLogoContainer.style.opacity = '1';
        
        if(designState.plVisible) {
             tvWindow.document.getElementById('plContainer').style.opacity = '1';
        }
        
        document.getElementById('statusMsg').innerText = "MODE: Jalsa Titles";
        lastActiveState = 'title'; 
    }

    function updateTV() {
        if(!tvWindow || tvWindow.closed) { alert("TV Closed!"); return; }
        stopAds();
        
        if(!designState.keepTitle) {
            tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
            tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        }
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoAutoHide) mainLogoContainer.style.opacity = '0';
        
        const plContainer = tvWindow.document.getElementById('plContainer');
        if(designState.plAutoHide) plContainer.style.opacity = '0';

        const doc = tvWindow.document;
        doc.getElementById('tnD').textContent = document.getElementById('nD').value;
        doc.getElementById('tnE').textContent = document.getElementById('nE').value;
        doc.getElementById('tfD').textContent = document.getElementById('fD').value;
        doc.getElementById('tfE').textContent = document.getElementById('fE').value;
        doc.getElementById('tcD').textContent = document.getElementById('cD').value;
        doc.getElementById('tcE').textContent = document.getElementById('cE').value;
        
        const cmText = document.getElementById('cm').value;
        const commBox = doc.getElementById('tcm');
        if(!cmText || cmText.trim() === "") {
            commBox.textContent = "";
            commBox.classList.add('comm-tiny');
        } else {
            commBox.textContent = cmText;
            commBox.classList.remove('comm-tiny');
        }

        const img = doc.getElementById('stuImg');
        const pCol = doc.querySelector('.photo-col');
        
        if(currentPhotoData) { 
            img.src = currentPhotoData; 
            img.style.display='block'; 
            pCol.classList.remove('shrink-photo');
        } else { 
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            pCol.classList.add('shrink-photo');
        }

        // Auto Toggle Top 5 Mode
        if(activeListMode === 'top5') {
            doc.body.classList.add('top5-mode');
            document.getElementById('top5ModeCheck').checked = true;
            doc.getElementById('card').classList.add('t5-' + designState.t5Layout);
            // SHOW ROYAL STAR
            if(royalStarData) {
                const rs = doc.getElementById('royalStar');
                rs.src = royalStarData;
                rs.style.display = 'block';
            }
        } else {
             if(!document.getElementById('top5ModeCheck').checked) {
                 doc.body.classList.remove('top5-mode');
                 doc.getElementById('royalStar').style.display = 'none';
             }
        }
        
        // SHOW TROPHY IF RANK EXISTS
        const rankTxt = document.getElementById('rankInput').value;
        const trophyWrap = doc.getElementById('trophyWrap');
        if(rankTxt && rankTxt.trim() !== "") {
            doc.getElementById('rankNum').innerText = rankTxt;
            if(trophyData) doc.getElementById('trophyImg').src = trophyData;
            trophyWrap.style.display = 'flex';
        } else {
            trophyWrap.style.display = 'none';
        }

        setTimeout(() => doc.getElementById('card').classList.add('active'), 100);
        stopVideo(); 
        document.getElementById('statusMsg').innerText = "LIVE: " + document.getElementById('nE').value;
        lastActiveState = 'card'; 
    }

    function clearTV() {
        if(!tvWindow || tvWindow.closed) return;
        stopAds();
        showJalsaScreen();
        stopVideo();
        document.getElementById('statusMsg').innerText = "CLEARED";
    }

    // --- NEW BADGE LOADERS ---
    function loadRoyalStar(input) {
        if(input.files && input.files[0]) {
            royalStarData = URL.createObjectURL(input.files[0]);
            alert("Royal Star Loaded!");
        }
    }
    
    function loadTrophy(input) {
        if(input.files && input.files[0]) {
            trophyData = URL.createObjectURL(input.files[0]);
            alert("Trophy Icon Loaded!");
        }
    }

    // --- VIDEO & ADS & PRESENTATION V29 ---
    
    function loadPartnerLogos(input) {
        partnerLogosData = [];
        for(let f of input.files) partnerLogosData.push(URL.createObjectURL(f));
        updatePartnerLogos();
        alert(partnerLogosData.length + " Partner Logos Loaded.");
    }
    
    function updatePartnerLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const c = tvWindow.document.getElementById('plContainer');
        c.innerHTML = '';
        partnerLogosData.forEach(src => {
            let img = tvWindow.document.createElement('img');
            img.src = src; img.className = 'pl-img';
            img.style.height = designState.plSize + 'px';
            c.appendChild(img);
        });
        c.style.gap = designState.plGap + 'px';
    }
    
    function togglePartnerLogos() {
        designState.plVisible = !designState.plVisible;
        if(tvWindow && !tvWindow.closed) {
             const c = tvWindow.document.getElementById('plContainer');
             c.style.opacity = designState.plVisible ? '1' : '0';
        }
    }

    function loadAds(input) {
        adFiles = [];
        for(let f of input.files) {
             let type = f.type.startsWith('video') ? 'video' : 'image';
             adFiles.push({ file: f, type: type, url: URL.createObjectURL(f) });
        }
        alert(adFiles.length + " Ads (Photos/Videos) Loaded.");
    }
    
    function toggleAdsMode() {
        if(adInterval) stopAds(); else startAds();
    }
    
    function startAds() {
        if(!tvWindow || tvWindow.closed || adFiles.length === 0) { alert("No Ads Loaded or TV Closed!"); return; }
        const adLayer = tvWindow.document.getElementById('adLayer');
        const adImg = tvWindow.document.getElementById('adImg');
        const adVid = tvWindow.document.getElementById('adVid');
        
        adLayer.style.display = 'flex';
        adIndex = 0;
        
        function playAd() {
            if(!adInterval) return; 
            let currentAd = adFiles[adIndex];
            
            if(currentAd.type === 'image') {
                adVid.pause(); adVid.style.display = 'none';
                adImg.src = currentAd.url;
                adImg.style.display = 'block';
                setTimeout(() => { if(adInterval) { nextAdIndex(); playAd(); } }, 10000);
            } else {
                adImg.style.display = 'none';
                adVid.src = currentAd.url;
                adVid.style.display = 'block';
                adVid.currentTime = 0;
                adVid.muted = false; 
                adVid.play().catch(() => { adVid.muted=true; adVid.play(); });
                adVid.onended = () => { if(adInterval) { nextAdIndex(); playAd(); } };
            }
        }
        
        function nextAdIndex() {
            adIndex = (adIndex + 1) % adFiles.length;
        }

        adInterval = true; 
        playAd();
        document.getElementById('statusMsg').innerText = "ADS MODE ON";
    }
    
    function stopAds() {
        adInterval = false;
        if(tvWindow && !tvWindow.closed) {
             tvWindow.document.getElementById('adLayer').style.display = 'none';
             tvWindow.document.getElementById('adVid').pause();
        }
        if(document.getElementById('statusMsg').innerText === "ADS MODE ON") document.getElementById('statusMsg').innerText = "ADS STOPPED";
    }

    document.getElementById('videoPlaylist').onchange = e => {
        playlist = Array.from(e.target.files);
        currentVidIdx = 0;
        alert(playlist.length + " General Videos Queued.");
    };
    
    function loadTop5Videos(input) {
        top5VideoPlaylist = Array.from(input.files);
        currentVidIdx = 0;
        alert(top5VideoPlaylist.length + " Top 5 Videos Queued.");
    }

    // --- NEXT VIDEO FUNCTION (SMART SEARCH + AUTO TV UPDATE) ---
    function playNextVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(targetStudentList.length === 0) { alert("Student List is empty!"); return; }
        if(targetVideoFiles.length === 0) { alert("No Videos Loaded!"); return; }
        
        // Reset index if needed
        if(currentVidIdx >= targetStudentList.length) currentVidIdx = 0;

        // 3. Get Student Data
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms (Dhivehi & English)
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Searching Next: " + nameDhivehi + " OR " + nameEnglish);

        // 4. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student & Load Data
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 

                // --- FORCE UPDATE TEXT ON TV ---
                if(tvWindow && !tvWindow.closed) {
                    let doc = tvWindow.document;
                    doc.getElementById('tnD').textContent = studentData.nD || "";
                    doc.getElementById('tnE').textContent = studentData.nE || "";
                    doc.getElementById('tfD').textContent = studentData.fD || "";
                    doc.getElementById('tfE').textContent = studentData.fE || "";
                    doc.getElementById('tcD').textContent = studentData.cD || "";
                    doc.getElementById('tcE').textContent = studentData.cE || "";
                    
                    if(studentData.rank) {
                        doc.getElementById('rankNum').innerText = studentData.rank;
                        doc.getElementById('trophyWrap').style.display = 'flex';
                    } else {
                        doc.getElementById('trophyWrap').style.display = 'none';
                    }
                }
                // -------------------------------
            }

            document.getElementById('statusMsg').innerText = "PLAYING: " + studentData.nD;
            
            // Move index forward for the next click
            currentVidIdx++; 
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™!\n\nﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™: " + studentData.nD);
        }
    }

    function toggleOverlayMode(enabled) {
         if(!tvWindow || tvWindow.closed) return;
         if(enabled) {
            tvWindow.document.body.classList.add('overlay-mode');
            if(lastActiveState === 'card') tvWindow.document.getElementById('card').classList.add('active'); 
         } else {
            tvWindow.document.body.classList.remove('overlay-mode');
         }
    }

    function playLocalVideoFile(file) {
        if(document.getElementById('top5ModeCheck').checked) {
            updateTV(); 
            tvWindow.document.body.classList.add('top5-mode');
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            if(document.getElementById('vidOverlayCheck').checked) {
                tvWindow.document.body.classList.add('overlay-mode');
                tvWindow.document.getElementById('card').classList.add('active'); 
            } else {
                tvWindow.document.body.classList.remove('overlay-mode');
                tvWindow.document.getElementById('card').classList.remove('active');
            }
        }

        const url = URL.createObjectURL(file);
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<video id="mainVid" src="${url}" autoplay controls style="width:100%;height:100%; object-fit:contain;"></video>`;
        vl.style.display = 'flex';
        setTimeout(() => { const v = tvWindow.document.getElementById('mainVid'); if(v) v.play().catch(e => {}); }, 100);
        document.getElementById('statusMsg').innerText = "PLAYING VIDEO";
    }
    
    function stopVideo() {
        if(!tvWindow || tvWindow.closed) return;
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = ''; vl.style.display = 'none';
        tvWindow.document.body.classList.remove('overlay-mode');
        if(!document.getElementById('top5ModeCheck').checked) tvWindow.document.body.classList.remove('top5-mode');
        
        if(lastActiveState === 'title') {
            showJalsaScreen();
        } else if (lastActiveState === 'card') {
            tvWindow.document.getElementById('card').classList.add('active');
            if(designState.keepTitle) {
                tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
            } else {
                 tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            }
        }
    }
    
   // --- SMART LINK CONVERTER (FIXED FOR YOUTUBE & OTHERS) ---
    function getSmartLink(url, type) {
        if (!url) return "";

        // 1. YouTube Handling (Shorts & Standard)
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            let videoId = null;

            // Handle Shorts
            if (url.includes('/shorts/')) {
                const parts = url.split('/shorts/');
                if (parts[1]) videoId = parts[1].split('?')[0]; // Remove query params
            } 
            // Handle Standard & Embed
            else {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                if (match && match[2] && match[2].length == 11) {
                    videoId = match[2];
                }
            }

            if (videoId) {
                // Use standard youtube.com/embed with autoplay
                return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0&modestbranding=1`;
            }
        }
        
        // 2. Canva Handling
        if (type === 'canva' || (type === 'auto' && url.includes('canva.com'))) {
             let cleanUrl = url.split('?')[0];
             if(cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
             if(cleanUrl.includes('/view')) {
                 if(!cleanUrl.includes('?embed')) return cleanUrl + '?embed';
             } else if(cleanUrl.includes('/edit')) {
                 return cleanUrl.replace('/edit', '/view?embed');
             } else {
                 return cleanUrl + '/view?embed';
             }
        }

        // 3. Gamma Handling
        if (type === 'gamma' || (type === 'auto' && url.includes('gamma.app'))) {
             return url; 
        }

        return url;
    }

    function showPresentation() {
        if(!tvWindow || tvWindow.closed) return;
        let url = document.getElementById('presLink').value;
        const type = document.getElementById('presType').value;
        if(!url) return;
        
        if(url.includes("<iframe")) {
            const match = url.match(/src="([^"]+)"/);
            if(match && match[1]) url = match[1];
        }

        const finalUrl = getSmartLink(url, type);

        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${finalUrl}" allow="fullscreen; autoplay; encrypted-media; clipboard-write" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function loadPDF(input) {
        if(input.files && input.files[0]) {
            pdfUrl = URL.createObjectURL(input.files[0]);
            alert("PDF Loaded. Click 'Show PDF' to display.");
        }
    }
    
    function showPDFScreen() {
        if(!tvWindow || tvWindow.closed) return;
        if(!pdfUrl) { alert("No PDF Loaded!"); return; }
        
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${pdfUrl}" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function playYoutube() {
        if(!tvWindow || tvWindow.closed) return;
        
        // Reset Views
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');

        let url = document.getElementById('ytLink').value;
        if(!url) return;
        
        const embedUrl = getSmartLink(url, 'auto');
        
        if(!embedUrl) { alert("Invalid YT Link"); return; }
        
        const vl = tvWindow.document.getElementById('videoLayer');
        // Added 'web-share' and 'referrerpolicy' for better compatibility
        vl.innerHTML = `<iframe id="ytFrame" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="width:100%;height:100%;"></iframe>`;
        vl.style.display = 'flex';
        
        document.getElementById('statusMsg').innerText = "PLAYING YOUTUBE";
    }
    
    function openYTPopup() {
        const url = document.getElementById('ytLink').value;
        if(url) window.open(url, '_blank', 'width=1280,height=720');
    }
    // --- FILE HANDLERS ---
    document.getElementById('jalsaCsvFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            const lines = evt.target.result.split('\n');
            if(lines.length > 0) {
                const cols = lines[0].split(',');
                if(cols[0]) document.getElementById('jLine1').value = cols[0].trim();
                for(let i=1; i<8; i++) {
                    if(cols[i]) document.getElementById('jLine'+(i+1)).value = cols[i].trim();
                }
                updateJalsaText(); alert("Titles Loaded!");
            }
        }; r.readAsText(file);
    };

    // --- FORCE FONT LOADER (FIXED) ---
    document.getElementById('fontFile').onchange = e => {
        const file = e.target.files[0]; 
        if(!file) return;
        
        const r = new FileReader();
        r.onload = evt => {
            currentFontData = evt.target.result; // Save Data URL
            
            // 1. Editor Font Update
            const newFont = new FontFace('Faruuma', `url(${currentFontData})`);
            newFont.load().then(f => {
                document.fonts.add(f);
                document.body.style.fontFamily = "'Faruuma', serif";
            });

            // 2. TV Window Font Update (Force Inject)
            if(tvWindow && !tvWindow.closed) {
                const doc = tvWindow.document;
                
                // Remove old font style if exists
                const oldStyle = doc.getElementById('customFontStyle');
                if(oldStyle) oldStyle.remove();

                // Inject NEW Font Face
                const style = doc.createElement('style');
                style.id = 'customFontStyle';
                style.innerHTML = `
                    @font-face { 
                        font-family: 'Faruuma'; 
                        src: url('${currentFontData}') format('truetype'); 
                    }
                    /* Force Apply to EVERYTHING */
                    body, h1, h2, h3, div, span, input, textarea, .jalsa-text, .font-dv { 
                        font-family: 'Faruuma', 'MV Boli', serif !important; 
                    }
                `;
                doc.head.appendChild(style);
                
                // Force Redraw
                updateJalsaText();
            }
            
            alert("Custom Font Loaded & Applied!");
        }; 
        r.readAsDataURL(file);
    };

    document.getElementById('jalsaBgFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            currentJalsaBgData = evt.target.result;
            currentJalsaBgType = file.type.startsWith('video') ? 'video' : 'image';
            updateJalsaBackground(); alert("Background Set");
        }; r.readAsDataURL(file);
    };

    document.getElementById('customBorderFile').onchange = e => {
        const r = new FileReader();
        r.onload = evt => {
            customBorderData = evt.target.result;
            if(designState.cBorder === 'custom') liveUpdate('cBorder', 'custom');
            alert("Custom Frame Loaded!");
        }; r.readAsDataURL(e.target.files[0]);
    };
    
    function loadCustomCardBg(input) {
        const r = new FileReader();
        r.onload = evt => {
            customCardBgData = evt.target.result;
            liveUpdate('cBorder', 'custom_bg');
            document.getElementById('cBorderSel').value = 'custom_bg';
            alert("Custom Card Background Loaded!");
        }; r.readAsDataURL(input.files[0]);
    }

    // UPDATED CSV PARSER FOR RANK
    function parseCSV(text) {
        let lines = text.split('\n');
        let data = [];
        lines.forEach(l => {
            let c = l.split(',');
            if(c.length>1) {
                data.push({
                    nD: c[0]?.trim(), nE: c[1]?.trim(), cD: c[2]?.trim(), cE: c[3]?.trim(), 
                    fD: c[4]?.trim(), fE: c[5]?.trim(), cm: c[6]?.trim(), ph: c[7]?.trim(),
                    rank: c[8]?.trim() // New Column for Rank
                });
            }
        });
        return data;
    }

    document.getElementById('csvFile').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            students = parseCSV(txt);
            if(activeListMode === 'general') filterList(); 
            alert("General List Loaded: " + students.length);
        }; r.readAsText(e.target.files[0]);
    };

    document.getElementById('photoFolder').onchange = e => {
        photoFiles = {};
        for(let f of e.target.files) {
            let name = f.name.toLowerCase();
            photoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) photoFiles[nameNoExt] = f; 
        }
        alert("General Photos: " + e.target.files.length);
    };

    function loadTop5Csv(input) {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            top5Students = parseCSV(txt);
            if(activeListMode === 'top5') filterList();
            alert("Top 5 List Loaded: " + top5Students.length);
        }; r.readAsText(input.files[0]);
    }

    function loadTop5Photos(input) {
        top5PhotoFiles = {};
        for(let f of input.files) {
            let name = f.name.toLowerCase();
            top5PhotoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) top5PhotoFiles[nameNoExt] = f; 
        }
        alert("Top 5 Photos: " + input.files.length);
    }

    function switchListMode(mode) {
        activeListMode = mode;
        document.getElementById('btnGenList').className = mode === 'general' ? 'list-switch-btn active' : 'list-switch-btn';
        document.getElementById('btnTop5List').className = mode === 'top5' ? 'list-switch-btn active' : 'list-switch-btn';
        
        if(mode === 'top5') {
            document.getElementById('top5ModeCheck').checked = true;
        } else {
             document.getElementById('top5ModeCheck').checked = false;
        }
        
        filterList();
        currentVidIdx = 0;
    }

    function processPhoto(file, cb) {
        const reader = new FileReader();
        reader.onload = e => { cb(e.target.result); };
        reader.readAsDataURL(file);
    }
    
    function manualPhoto(input) {
    if (input.files && input.files[0]) {
        // 1. ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁäﬁÆﬁìﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ÿå ﬁáﬁ¨ ﬁäﬁÆﬁìﬁØ ﬁâﬁ¨ﬁâﬁÆﬁÉﬁ©ﬁÇﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß (Free up RAM)
        if (currentPhotoData && currentPhotoData.startsWith('blob:')) {
            URL.revokeObjectURL(currentPhotoData);
        }

        // 2. ﬁãﬁ¨ﬁÇﬁ∞ ﬁáﬁß ﬁäﬁÆﬁìﬁØ ﬁïﬁ∞ﬁÉﬁÆﬁêﬁ¨ﬁêﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠
        processPhoto(input.files[0], d => {
            currentPhotoData = d;
            document.getElementById('previewImg').src = d;
            document.getElementById('pStat').innerText = "Manual";
            document.getElementById('pStat').style.color = "blue";
        });
    }
}

    function filterList() {
        let t = document.getElementById('search').value.toLowerCase();
        let l = document.getElementById('stuList'); l.innerHTML = '';
        
        let targetArray = activeListMode === 'top5' ? top5Students : students;
        
        targetArray.forEach((s,i) => {
            if((s.nD+s.nE).toLowerCase().includes(t)) {
                let prefix = activeListMode === 'top5' ? "üèÜ " : (i+1)+". ";
                let o = document.createElement('option'); o.value=i; o.text=prefix+s.nD; l.add(o);
            }
        });
    }

   function loadStudent() {
    let idx = document.getElementById('stuList').value;
    
    // Check which list and photo set to use
    let targetArray = activeListMode === 'top5' ? top5Students : students;
    
    // ================== ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ ﬁéﬁ¨ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÑﬁ¶ﬁáﬁ® ==================
    let targetPhotos;
    if (activeListMode === 'top5') {
        // Top 5 ﬁäﬁØﬁçﬁ∞ﬁëﬁß ﬁÄﬁ™ﬁêﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ General folder ﬁáﬁ®ﬁÇﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨
        targetPhotos = (Object.keys(top5PhotoFiles).length > 0) ? top5PhotoFiles : photoFiles;
    } else {
        targetPhotos = photoFiles;
    }
    // =========================================================
    
    if(!targetArray[idx]) return;

    let s = targetArray[idx];
    // Populate text fields
    document.getElementById('nD').value = s.nD || ""; 
    document.getElementById('nE').value = s.nE || "";
    document.getElementById('fD').value = s.fD || ""; 
    document.getElementById('fE').value = s.fE || "";
    document.getElementById('cD').value = s.cD || ""; 
    document.getElementById('cE').value = s.cE || "";
    document.getElementById('cm').value = s.cm || "";
    document.getElementById('rankInput').value = s.rank || "";
        
        // --- IMPROVED PHOTO FINDER ---
        let pNameRaw = s.ph ? s.ph.trim() : ""; // Name from CSV
        let pName = pNameRaw.toLowerCase(); // Lowercase version
        let pNameNoExt = pName.split('.').slice(0, -1).join('.'); // Remove .jpg if present

        let prev = document.getElementById('previewImg');
        let stat = document.getElementById('pStat');
        
        // Try matching in 3 ways: Exact, Lowercase, or No Extension
        let foundFile = targetPhotos[pNameRaw] || targetPhotos[pName] || targetPhotos[pNameNoExt];
        
        if(foundFile) {
            stat.innerText = "Loading...";
            processPhoto(foundFile, d => {
                currentPhotoData = d; 
                prev.src = d; 
                stat.innerText = "‚úÖ Found"; 
                stat.style.color="green";
                
                // --- FIX: REMOVED AUTO TV UPDATE CODE FROM HERE ---
                // The lines that forced the photo to TV immediately have been removed.
                // Now photo only goes to TV when you click 'Live'.
            });
        } else {
            currentPhotoData = null; 
            prev.src = "https://via.placeholder.com/150"; 
            
            // Show error in the preview box
            if(pNameRaw === "") {
                stat.innerText = "No Photo Name"; 
                stat.style.color="grey";
            } else {
                stat.innerText = "‚ùå Missing: " + pNameRaw; 
                stat.style.color="red";
            }
        }
    }
    function move(d) {
        let l = document.getElementById('stuList');
        if(l.options.length) {
            let newIdx = Math.min(Math.max(l.selectedIndex+d, 0), l.options.length-1);
            l.selectedIndex = newIdx;
            loadStudent();
        }
    }
    // --- PREVIOUS VIDEO FUNCTION (BACK BUTTON) ---
    function playPrevVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(currentVidIdx <= 0) { alert("ﬁâﬁ®ﬁáﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ! ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁãﬁ¨ﬁàﬁ≠ﬁÇﬁ¨."); return; }
        
        // 3. Move Index Backwards
        currentVidIdx--; 

        // 4. Get Student Data for the PREVIOUS student
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Going Back: Searching for " + nameDhivehi);

        // 5. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Previous Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student in List
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 
            }
            document.getElementById('statusMsg').innerText = "BACK TO: " + studentData.nD;
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™ (Back to): " + studentData.nD);
        }
    }

    // --- NEW FUNCTIONS (ZOOM & SCREEN CONTROL) ---

    // 1. ﬁìﬁ©ﬁàﬁ© ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁíﬁ´ﬁâﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function setTVZoom(val) {
        if(tvWindow && !tvWindow.closed) {
            tvWindow.document.body.style.zoom = val;
        }
    }

    // 2. ﬁáﬁ¶ﬁÉﬁ®ﬁâﬁ¶ﬁåﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁçﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function loadScreenBG(side, input) {
        if(!tvWindow || tvWindow.closed) return;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
                const zoneDiv = tvWindow.document.getElementById(zoneId);
                if(zoneDiv) {
                    zoneDiv.style.backgroundImage = `url(${e.target.result})`;
                    zoneDiv.style.backgroundSize = "cover";
                    document.getElementById('statusMsg').innerText = side.toUpperCase() + " SCREEN UPDATED";
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. ﬁåﬁ®ﬁÇﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁâﬁØﬁëﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
   // ... (ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ®ÿå ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® toggleTripleMode ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨) ...

    function toggleTripleMode() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.body.classList.toggle('triple-active');
    }

    function adjustZone(side, prop, val) {
        if(!tvWindow || tvWindow.closed) return;
        
        const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
        const el = tvWindow.document.getElementById(zoneId);
        
        if(el) {
            if(prop === 'width') {
                // ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (%)
                el.style.width = val + "%"; 
            } else {
                // ﬁãﬁ¨ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÅﬁ∞ ﬁñﬁ¨ﬁáﬁ∞ﬁêﬁ™ﬁÇﬁ∞ (Pixels)
                el.style[side] = val + "px"; 
            }
        }
    }
// --- DISABLE KEYBOARD SHORTCUTS & INSPECT ---
    document.addEventListener('keydown', function(e) {
        // 1. F12 (Developer Tools)
        if(e.key === 'F12' || e.keyCode === 123) {
            e.preventDefault();
            return false;
        }

        // 2. Ctrl + U (View Source Code)
        if(e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.keyCode === 85)) {
            e.preventDefault();
            return false;
        }

        // 3. Ctrl + Shift + I (Inspect Element)
        if(e.ctrlKey && e.shiftKey && (e.key === 'i' || e.key === 'I' || e.keyCode === 73)) {
            e.preventDefault();
            return false;
        }

        // 4. Ctrl + Shift + J (Console)
        if(e.ctrlKey && e.shiftKey && (e.key === 'j' || e.key === 'J' || e.keyCode === 74)) {
            e.preventDefault();
            return false;
        }

        // 5. Ctrl + S (Save Page - ﬁâﬁ®ﬁáﬁ®ﬁÇﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ≠ﬁÇﬁ¨)
        if(e.ctrlKey && (e.key === 's' || e.key === 'S' || e.keyCode === 83)) {
            e.preventDefault();
            // alert("Saving is disabled!"); // ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁâﬁ¨ﬁêﬁ¨ﬁñﬁ¨ﬁáﬁ∞ ﬁáﬁ¶ﬁÉﬁ™ﬁàﬁ¶ﬁÇﬁ∞ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ∞ ﬁáﬁ¶ﬁÇﬁ∞-ﬁÜﬁÆﬁâﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß
            return false;
        }
    });
   // --- GENERAL VIDEO PLAYLIST PLAYER ---
    let generalPlayIndex = 0;

    function playGeneralSequence() {
        // 1. Check if TV is open
        if(!tvWindow || tvWindow.closed) { 
            alert("Please Open TV Screen First!"); 
            return; 
        }

        // 2. Check if files are loaded
        if(playlist.length === 0) { 
            alert("Please select video files in 'General Video Playlist' first!"); 
            return; 
        }

        // 3. Reset index if at end
        if(generalPlayIndex >= playlist.length) {
            generalPlayIndex = 0;
        }

        // 4. Play the video
        let file = playlist[generalPlayIndex];
        playLocalVideoFile(file);

        // 5. Update Status & Increment
        document.getElementById('statusMsg').innerText = "Playing General: " + file.name;
        generalPlayIndex++;
    }

    // --- FINAL SYSTEM CHECKS ---

    // 1. Prevent Accidental Refresh (Data Loss Protection)
    window.onbeforeunload = function(e) {
        e = e || window.event;
        // For older browsers
        if (e) { e.returnValue = 'Sure?'; }
        return 'Sure?';
    };

    // 2. Clear Console clutter to improve performance slightly
    console.log = function() {}; 

    // 3. Safety Check for TV Window
    setInterval(function(){
        if(tvWindow && tvWindow.closed) {
            document.getElementById('connStatus').innerText = "‚ùå TV CLOSED";
            document.getElementById('connStatus').style.background = "#ffebee";
            document.getElementById('connStatus').style.color = "red";
        }
    }, 2000);
// 3. Safety Check for TV Window
    setInterval(function(){
        if(tvWindow && tvWindow.closed) {
            document.getElementById('connStatus').innerText = "‚ùå TV CLOSED";
            document.getElementById('connStatus').style.background = "#ffebee";
            document.getElementById('connStatus').style.color = "red";
        }
    }, 2000);

    function updateMasterScale(axis, value) {
        if(axis === 'width') document.getElementById('dispMW').innerText = value + '%';
        if(axis === 'height') document.getElementById('dispMH').innerText = value + '%';

        if(tvWindow && !tvWindow.closed) {
            const stage = tvWindow.document.getElementById('masterStage');
            if(stage) {
                stage.style[axis] = value + '%';
            }
        }
    }

    function resetMasterScale() {
        updateMasterScale('width', 100);
        updateMasterScale('height', 100);
        document.getElementById('dispMW').innerText = '100%';
        document.getElementById('dispMH').innerText = '100%';
        
        // Reset Sliders visually
        const inputs = document.querySelectorAll('input[type="range"]');
        inputs.forEach(input => {
            if(input.getAttribute('oninput') && input.getAttribute('oninput').includes('updateMasterScale')) {
                input.value = 100;
            }
        });
    }

</script>
</script>
</body>
</html>
