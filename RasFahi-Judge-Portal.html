<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasfahi Event & Graduation Software (Ultimate Edition)</title>
    <style>
        /* --- 1. GLOBAL FONTS & VARIABLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');

        :root {
            --gold: #D4AF37;
            --gold-dim: #aa8c2c;
            --gold-bright: #FFD700;
            --royal-blue: #001a33;
            --royal-green: #002b15;
            --panel-bg: #0b1016;
            --text-main: #ffffff;
        }

        /* Default Font Placeholder */
        @font-face { font-family: 'CustomDv'; src: local('Faruuma'), local('Waheed'), url(''); }

        * { box-sizing: border-box; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background: #000; color: #fff;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; /* Flex direction handles LTR/RTL Sidebar placement */
            font-family: 'Cinzel', sans-serif;
        }

        /* --- 2. ROYAL FRAME (THE MAIN CONTAINER) --- */
        .app-container {
            width: 98vw; height: 96vh;
            /* Royal Border */
            border: 4px double var(--gold);
            border-radius: 15px;
            display: flex;
            /* Royal Background Gradient: Deep Blue to Emerald Green */
            background: linear-gradient(135deg, #001a33 0%, #002b15 100%);
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* --- 3. SECURITY OVERLAY (LOCK SCREEN) --- */
        #securityOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #001a33, #000); 
            z-index: 99999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            width: 600px; padding: 50px; text-align: center;
            border: 4px double var(--gold); border-radius: 20px;
            background: rgba(0,0,0,0.9);
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.3);
            position: relative;
        }
        .login-card h1 {
            color: var(--gold); font-family: 'Cinzel', serif; 
            font-size: 32px; margin: 0 0 10px 0; letter-spacing: 2px;
            text-shadow: 0 2px 5px #000;
        }
        
        .pass-input {
            width: 80%; padding: 15px; font-size: 20px; text-align: center;
            border: 2px solid var(--gold-dim); background: #111; color: var(--gold);
            border-radius: 8px; font-family: monospace; letter-spacing: 3px;
        }
        .auth-btn {
            background: linear-gradient(to bottom, #D4AF37, #aa8c2c);
            color: #000; font-weight: 900; font-size: 18px;
            padding: 15px 40px; border: none; border-radius: 8px;
            margin-top: 20px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .auth-btn:hover { transform: scale(1.05); filter: brightness(1.2); }

        .disclaimer {
            font-family: sans-serif; font-size: 12px; color: #888;
            margin-top: 25px; padding: 15px; border: 1px dashed #444; background: #0b0b0b;
            line-height: 1.5; text-align: left;
        }

        /* --- 4. SIDEBAR (CONTROLS) --- */
        .sidebar {
            width: 450px; flex-shrink: 0;
            background: rgba(0, 0, 0, 0.6); /* Glass effect */
            backdrop-filter: blur(15px);
            display: flex; flex-direction: column;
            z-index: 100; 
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
            /* Border side handled by JS */
        }

        .header {
            padding: 20px; text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            border-bottom: 2px solid var(--gold);
        }
        .app-title {
            color: var(--gold); font-size: 20px; margin: 0;
            text-shadow: 0 2px 5px #000; letter-spacing: 1px; font-weight: bold;
        }

        .content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* Panels */
        .panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(212, 175, 55, 0.3); 
            border-radius: 8px; padding: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        h2 {
            color: var(--gold); margin: 0 0 8px 0; font-size: 14px;
            border-bottom: 1px dashed rgba(212, 175, 55, 0.3); padding-bottom: 5px;
            font-family: 'Noto Sans Thaana', sans-serif; 
        }
        label { color: #ccc; font-size: 12px; display: block; margin: 8px 0 2px; font-family: sans-serif; }
        
        input, select, button {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.6);
            border: 1px solid #445566; color: #fff; border-radius: 5px;
            font-size: 13px; margin-bottom: 4px;
        }
        button { cursor: pointer; background: linear-gradient(to bottom, #334455, #223344); font-weight: bold; border-color: #556677; transition:0.2s; }
        button:hover { border-color: var(--gold); color: var(--gold); }
        
        .btn-gold { background: linear-gradient(to bottom, #D4AF37, #aa8c2c) !important; color: #000 !important; border:1px solid #fff !important; }
        .btn-green { background: linear-gradient(to bottom, #004d00, #003300) !important; border-color: #006600 !important; }
        .btn-red { background: linear-gradient(to bottom, #660000, #440000) !important; border-color: #990000 !important; }

        .sidebar-footer {
            padding: 10px; text-align: center; font-size: 10px; color: #aaa;
            border-top: 1px solid var(--gold); background: rgba(0,0,0,0.8);
            font-family: sans-serif; line-height: 1.4;
        }
        
        .drive-link-btn {
            display: block; margin-top: 5px; padding: 10px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent); 
            border: 1px solid var(--gold);
            color: var(--gold); text-decoration: none; border-radius: 5px;
            font-weight: bold; font-size: 11px;
        }
        .drive-link-btn:hover { background: rgba(212, 175, 55, 0.3); }

        /* --- 5. MAIN PREVIEW MONITOR (UPDATED LARGER SIZE) --- */
        .main-view {
            flex: 1; 
            background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative;
        }

        /* NEW: INFO BANNER STYLE */
        .info-banner {
            width: 85%;
            padding: 10px 20px;
            margin-bottom: 15px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.8), transparent);
            border-top: 1px solid var(--gold);
            border-bottom: 1px solid var(--gold);
            color: var(--gold-bright);
            font-family: 'Noto Sans Thaana', 'Cinzel', sans-serif;
            text-align: center;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            min-height: 45px;
            display: flex; align-items: center; justify-content: center;
        }

        #previewContainer {
            /* MADE LARGER AS REQUESTED */
            width: 85%; 
            height: 75%; /* Significantly larger height */
            border: 8px double var(--gold);
            display: flex; justify-content: center; align-items: center;
            background: #000; color: #fff;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            position: relative; overflow: hidden;
            border-radius: 10px;
        }
        
        /* --- 6. ROYAL FULLSCREEN BUTTON (ROUND) --- */
        #fsToggleBtn {
            position: absolute; bottom: 30px; right: 30px;
            width: 70px; height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 3px solid #fff;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            cursor: pointer; z-index: 200;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: #000;
            transition: all 0.3s;
        }
        #fsToggleBtn:hover { transform: scale(1.1); box-shadow: 0 0 50px var(--gold); }

        /* Helpers */
        .lang-bar { display: flex; margin-bottom: 15px; border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        .lang-btn { flex: 1; background: rgba(0,0,0,0.5); color: #888; border: none; font-size: 12px; margin: 0; border-right: 1px solid #333; border-radius: 0; }
        .lang-btn.active { background: var(--royal-blue); color: var(--gold); font-weight: bold; }

        .row { display: flex; gap: 5px; }
        .hidden { display: none !important; }

    </style>
</head>
<body oncontextmenu="return false;">

    <div id="securityOverlay">
        <div class="login-card">
            <h1>RASFAHI EVENT & GRADUATION</h1>
            <p style="color:#ccc; margin-bottom:20px;">Quran Recitation Module (Royal Edition)</p>
            
            <input type="password" id="passcode" class="pass-input" placeholder="PASTE LICENSE KEY HERE">
            <br>
            <button onclick="unlockSystem()" class="auth-btn">AUTHENTICATE</button>
            <p id="errMsg" style="color:#ff4444; height:20px; margin-top:10px; font-weight:bold;"></p>

            <div class="disclaimer">
                <strong style="color:var(--gold);">‚ö†Ô∏è IMPORTANT VERIFICATION:</strong><br>
                Before projecting to the screen, please verify all Quranic verses against the Madina Mushaf. Ensure Dhivehi translations conform to the version endorsed by the President's Office or Ministry of Islamic Affairs.<br>
                <span style="opacity:0.7;">(System Version: 26.0 | Licensed for Event Use Only)</span>
            </div>
        </div>
    </div>

    <div class="app-container" id="mainAppContainer">
        
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div class="app-title">RASFAHI EVENT SOFTWARE</div>
                <div style="font-size:11px; color:#aaa;">Professional Quran Recitation Display System</div>
            </div>

            <div class="content">
                <div class="lang-bar">
                    <button class="lang-btn active" onclick="setLang('en')">ENGLISH</button>
                    <button class="lang-btn" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                </div>

                <div class="panel">
                    <h2 data-key="config">CONFIGURATION</h2>
                    <div class="row">
                        <button class="btn-green" onclick="saveConfig()" data-key="btnSave">üíæ SAVE CONFIG</button>
                        <button class="btn-green" onclick="document.getElementById('confInput').click()" data-key="btnLoad">üìÇ LOAD CONFIG</button>
                        <input type="file" id="confInput" accept=".json" class="hidden" onchange="loadConfig(this)">
                    </div>
                    <div id="autoSaveStatus" style="font-size:10px; color:var(--gold); text-align:center; opacity:0; transition:opacity 0.5s;">Autosaved to System</div>
                </div>

                <div class="panel">
                    <h2 data-key="data">DATA & FONTS</h2>
                    <label data-key="lblFont">Install Font (Faruuma/Waheed):</label>
                    <input type="file" id="fontInput" accept=".ttf,.otf,.woff">
                    <label data-key="lblCsv">Load Quran Database (CSV):</label>
                    <input type="file" id="csvInput" accept=".csv">
                </div>

                <div class="panel">
                    <h2 data-key="select">SELECTION</h2>
                    <label data-key="lblSurah">Select Surah:</label>
                    <select id="selSurah" onchange="updateRanges()"></select>
                    
                    <div class="row">
                        <div><label data-key="lblStart">Start Ayah:</label><select id="selStart" onchange="setAyahRange()"></select></div>
                        <div><label data-key="lblEnd">End Ayah:</label><select id="selEnd" onchange="setAyahRange()"></select></div>
                    </div>

                    <label data-key="lblTransMode">Translation Display Mode:</label>
                    <select id="transMode" onchange="updateLive()">
                        <option value="both">Dual (Dhivehi & English)</option>
                        <option value="dv">Dhivehi Only</option>
                        <option value="en">English Only</option>
                        <option value="none">Arabic Only</option>
                    </select>
                </div>

                <div class="panel">
                    <h2 data-key="adjust">TEXT ADJUSTMENT</h2>
                    <label data-key="lblArSize">Arabic Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colAr" value="#D4AF37" style="width:40px;" onchange="updateLive()">
                        <input type="range" id="sizeAr" min="1" max="10" step="0.1" value="3.5" oninput="updateLive()">
                    </div>
                    <label data-key="lblDvSize">Dhivehi Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colDv" value="#ffffff" style="width:40px;" onchange="updateLive()">
                        <input type="range" id="sizeDv" min="1" max="8" step="0.1" value="1.8" oninput="updateLive()">
                    </div>
                    <label data-key="lblEnSize">English Size/Color:</label>
                    <div class="row">
                        <input type="color" id="colEn" value="#cccccc" style="width:40px;" onchange="updateLive()">
                        <input type="range" id="sizeEn" min="1" max="8" step="0.1" value="1.5" oninput="updateLive()">
                    </div>
                </div>

                <div class="panel">
                    <h2 data-key="themes">PRESIDENTIAL THEMES</h2>
                    <select id="themeSelect" onchange="applyTheme(this.value)">
                        </select>
                </div>

                <div class="panel" style="border:1px solid var(--gold); background: rgba(212, 175, 55, 0.1);">
                    <h2 style="color:#fff;" data-key="live">LIVE PROJECTION</h2>
                    <button class="btn-gold" onclick="openProjector()" data-key="btnLaunch">üì∫ LAUNCH BIG SCREEN</button>
                    <div class="row" style="margin-top:5px;">
                        <button class="btn-green" onclick="sendPhase('start')">BASMALAH</button>
                        <button class="btn-red" onclick="sendPhase('end')">SADAQALLAH</button>
                    </div>
                    <div class="row">
                        <button onclick="navigate(-1)">‚óÄ PREV</button>
                        <button onclick="navigate(1)">NEXT ‚ñ∂</button>
                    </div>
                    <input type="text" id="eventTitle" placeholder="Event Title" oninput="updateLive()" style="text-align:center;">
                    <button onclick="sendPhase('cover')">SHOW TITLE CARD</button>
                </div>

            </div>

            <div class="sidebar-footer">
                Software Designed & Developed by:<br>
                <strong style="color:#ccc;">RASFAHI - ALI IBRAHIM DIDI</strong><br>
                
                <a href="https://drive.google.com/drive/folders/17DleEUNHdJkYlfiDefSghez-wIpA9MYL?usp=sharing" target="_blank" class="drive-link-btn">
                    üì• DOWNLOAD FONTS & CSV (GOOGLE DRIVE)
                </a>
            </div>
        </div>

        <div class="main-view">
            
            <div id="infoBanner" class="info-banner">
                Select a Surah to Begin / ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß
            </div>

            <div style="margin-bottom:5px; color:#aaa; font-size:10px; letter-spacing:1px;">LIVE PREVIEW</div>
            
            <div id="previewContainer">
                <div style="text-align:center; padding:20px;">
                    <div id="prevAr" style="font-family:'Amiri'; font-size:24px; color:var(--gold);">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
                    <div id="prevTr" style="font-family:'CustomDv'; font-size:14px; margin-top:10px; color:#ccc;">Preview Active</div>
                </div>
            </div>
            
            <button id="fsToggleBtn" onclick="toggleAppFullscreen()" title="Fullscreen Mode">‚õ∂</button>
        </div>

    </div> <script>
        // --- DATA & STATE ---
        const DB = {}; 
        let themes = [];
        let activeAyahs = [];
        let curIndex = 0;
        let curPhase = 'cover';
        let projWin = null;
        let customFontData = null;

        // --- LOCALIZATION DATA ---
        const langData = {
            en: {
                config: "CONFIGURATION", btnSave: "üíæ SAVE CONFIG", btnLoad: "üìÇ LOAD CONFIG",
                data: "DATA & FONTS", lblFont: "Install Font:", lblCsv: "Load CSV Database:",
                select: "SELECTION", lblSurah: "Select Surah:", lblStart: "Start Ayah:", lblEnd: "End Ayah:", lblTransMode: "Translation Mode:",
                adjust: "TEXT ADJUSTMENT", lblArSize: "Arabic Size/Color:", lblDvSize: "Dhivehi Size/Color:", lblEnSize: "English Size/Color:",
                themes: "PRESIDENTIAL THEMES", 
                live: "LIVE PROJECTION", btnLaunch: "üì∫ LAUNCH BIG SCREEN",
                lblBannerDef: "Select a Surah to Begin",
                lblReciting: "Reciting:"
            },
            dv: {
                config: "ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞", btnSave: "üíæ ﬁêﬁ≠ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ∞", btnLoad: "üìÇ ﬁçﬁØﬁëﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ∞",
                data: "ﬁëﬁ≠ﬁìﬁß ﬁáﬁ¶ﬁãﬁ® ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞", lblFont: "ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ∞ﬁìﬁØﬁçﬁ∞:", lblCsv: "ﬁëﬁ≠ﬁìﬁßﬁÑﬁ≠ﬁêﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞:",
                select: "ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞", lblSurah: "ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁéﬁß:", lblStart: "ﬁäﬁ¶ﬁÅﬁß ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:", lblEnd: "ﬁÇﬁ®ﬁâﬁ≠ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:", lblTransMode: "ﬁåﬁ¶ﬁÉﬁ™ﬁñﬁ¶ﬁâﬁß ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁéﬁÆﬁåﬁ∞:",
                adjust: "ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞", lblArSize: "ﬁ¢ﬁ¶ﬁÉﬁ¶ﬁÑﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:", lblDvSize: "ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:", lblEnSize: "ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶:",
                themes: "ﬁùﬁßﬁÄﬁ© ﬁåﬁ©ﬁâﬁ∞ﬁåﬁ¶ﬁáﬁ∞", 
                live: "ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", btnLaunch: "üì∫ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁáﬁ¶ﬁÉﬁ™ﬁàﬁß",
                lblBannerDef: "ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ¨ﬁáﬁ∞ ﬁöﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß",
                lblReciting: "ﬁâﬁ®ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ∞ ﬁÄﬁ¶ﬁâﬁ¶ﬁñﬁ¨ﬁÄﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁ¶ﬁÇﬁ©:"
            }
        };

        // --- 1. SECURITY & KEY VERIFICATION ---
        function unlockSystem() {
            const inp = document.getElementById('passcode').value.trim();
            const err = document.getElementById('errMsg');

            if(!inp) { err.innerText = "Please enter a key."; return; }

            try {
                // Decode Base64
                const decoded = atob(inp); // Format: ROYAL_EXP_YYYY-MM-DD_CUST_Name
                const parts = decoded.split('_');

                if(parts[0] !== "ROYAL" || parts[1] !== "EXP") throw "Invalid Format";
                
                const expDate = new Date(parts[2]);
                const today = new Date();
                if(expDate < today) throw "License Expired on " + parts[2];

                if(!parts[4]) throw "Invalid Customer Data";

                // Success
                document.getElementById('securityOverlay').style.display = 'none';
                initThemes(); 
                loadFromLocal(); // Auto Load
                setInterval(saveToLocal, 5000); // Auto Save Interval
                alert("WELCOME " + parts[4] + "\nSystem Unlocked Successfully.");

            } catch(e) {
                if(inp === "AIDD-2026-MASTER") {
                    document.getElementById('securityOverlay').style.display = 'none';
                    initThemes();
                } else {
                    err.innerText = "‚õî ACCESS DENIED";
                }
            }
        }
        
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        };

        // --- 2. LANGUAGE SWITCHER & AUTO-SAVE ---
        function setLang(l) {
            const sb = document.getElementById('sidebar');
            const btns = document.querySelectorAll('.lang-btn');
            
            btns.forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setLang('${l}')"]`).classList.add('active');

            document.documentElement.lang = l; // Set html lang attribute

            // Apply translations
            const t = langData[l];
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(t[k]) el.innerText = t[k];
            });

            // Layout Logic (LTR vs RTL)
            const app = document.getElementById('mainAppContainer');
            if(l === 'en') {
                app.style.flexDirection = 'row'; 
                sb.style.borderRight = "2px solid var(--gold)";
                sb.style.borderLeft = "none";
                document.documentElement.dir = "ltr";
            } else {
                app.style.flexDirection = 'row-reverse'; 
                sb.style.borderLeft = "2px solid var(--gold)";
                sb.style.borderRight = "none";
                document.documentElement.dir = "rtl";
            }
            updateBanner(); // Update banner text language
        }

        // Auto Save Logic
        function saveToLocal() {
            const state = {
                evtTitle: document.getElementById('eventTitle').value,
                theme: document.getElementById('themeSelect').value,
                transMode: document.getElementById('transMode').value,
                styles: {
                    ar: {c:document.getElementById('colAr').value, s:document.getElementById('sizeAr').value},
                    dv: {c:document.getElementById('colDv').value, s:document.getElementById('sizeDv').value},
                    en: {c:document.getElementById('colEn').value, s:document.getElementById('sizeEn').value}
                }
            };
            localStorage.setItem('rasfahi_royal_state', JSON.stringify(state));
            const stat = document.getElementById('autoSaveStatus');
            stat.style.opacity = 1; setTimeout(()=>stat.style.opacity=0, 1000);
        }

        function loadFromLocal() {
            const s = localStorage.getItem('rasfahi_royal_state');
            if(s) applyState(JSON.parse(s));
        }

        function saveConfig() {
            const config = JSON.parse(localStorage.getItem('rasfahi_royal_state'));
            const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "Rasfahi_Config.json";
            a.click();
        }

        function loadConfig(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                applyState(JSON.parse(e.target.result));
                alert("Configuration Loaded!");
            };
            r.readAsText(f);
        }

        function applyState(s) {
            if(s.evtTitle) document.getElementById('eventTitle').value = s.evtTitle;
            if(s.theme) document.getElementById('themeSelect').value = s.theme;
            if(s.transMode) document.getElementById('transMode').value = s.transMode;
            if(s.styles) {
                document.getElementById('colAr').value = s.styles.ar.c; document.getElementById('sizeAr').value = s.styles.ar.s;
                document.getElementById('colDv').value = s.styles.dv.c; document.getElementById('sizeDv').value = s.styles.dv.s;
                document.getElementById('colEn').value = s.styles.en.c; document.getElementById('sizeEn').value = s.styles.en.s;
            }
            updateLive();
        }

        // --- 3. FONT LOADING ---
        document.getElementById('fontInput').onchange = function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                customFontData = evt.target.result;
                const newRule = `@font-face { font-family: 'CustomDv'; src: url('${customFontData}'); }`;
                const style = document.createElement('style');
                style.innerHTML = newRule;
                document.head.appendChild(style);
                alert("Custom Font Loaded Successfully!");
                updateLive(); 
            };
            reader.readAsDataURL(file);
        };

        // --- 4. DATA HANDLING ---
        document.getElementById('csvInput').onchange = function(e) {
            const r = new FileReader();
            r.onload = function(ev) {
                const rows = ev.target.result.split('\n');
                rows.slice(1).forEach((row) => {
                    const c = row.split(',');
                    if(c.length >= 3) {
                        const s = c[0].trim();
                        const a = { no: c[1].trim(), ar: c[2].trim(), dv: c[3]?.trim()||"", en: c[4]?.trim()||"" };
                        if(!DB[s]) DB[s] = [];
                        DB[s].push(a);
                    }
                });
                
                const sel = document.getElementById('selSurah');
                sel.innerHTML = '<option value="">-- Select --</option>';
                Object.keys(DB).forEach(k => sel.add(new Option(k, k)));
                alert("Database Loaded!");
            };
            r.readAsText(e.target.files[0]);
        };

        function updateRanges() {
            const s = document.getElementById('selSurah').value;
            const st = document.getElementById('selStart');
            const en = document.getElementById('selEnd');
            st.innerHTML = ''; en.innerHTML = '';
            
            if(DB[s]) {
                DB[s].forEach((ayah, i) => {
                    const opt = new Option(`Ayah ${ayah.no}`, i);
                    st.add(opt);
                    en.add(opt.cloneNode(true));
                });
                en.value = DB[s].length - 1;
                setAyahRange();
            }
        }

        function setAyahRange() {
            const s = document.getElementById('selSurah').value;
            const i1 = parseInt(document.getElementById('selStart').value);
            const i2 = parseInt(document.getElementById('selEnd').value);
            
            if(DB[s]) {
                activeAyahs = DB[s].slice(i1, i2 + 1);
                curIndex = 0;
                sendPhase('reciting');
                updateBanner();
            }
        }

        // --- 5. BANNER LOGIC ---
        function updateBanner() {
            const s = document.getElementById('selSurah').value;
            const st = document.getElementById('selStart');
            const en = document.getElementById('selEnd');
            const banner = document.getElementById('infoBanner');
            const lang = document.documentElement.lang || 'en';

            if(s && st.options.length > 0) {
                const startTxt = st.options[st.selectedIndex].text;
                const endTxt = en.options[en.selectedIndex].text;
                
                if(lang === 'dv') {
                    banner.innerText = `ﬁâﬁ®ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ∞ ﬁÄﬁ¶ﬁâﬁ¶ﬁñﬁ¨ﬁÄﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁ¶ﬁÇﬁ©: ${s} (${startTxt} ﬁÇﬁ∞ ${endTxt} ﬁáﬁ¶ﬁÅﬁ∞)`;
                } else {
                    banner.innerText = `Scheduled Recitation: ${s} (${startTxt} to ${endTxt})`;
                }
            } else {
                banner.innerText = langData[lang].lblBannerDef;
            }
        }

        // --- 6. THEMES ---
        function initThemes() {
            const colors = [
                {n:"Royal Green", bg:"radial-gradient(circle, #004400, #000)", b:"#006600"},
                {n:"Midnight Blue", bg:"radial-gradient(circle, #001a4d, #000)", b:"#003366"},
                {n:"Majestic Maroon", bg:"radial-gradient(circle, #440000, #000)", b:"#660000"},
                {n:"Deep Teal", bg:"radial-gradient(circle, #003333, #000)", b:"#005555"},
                {n:"Obsidian", bg:"radial-gradient(circle, #1a1a1a, #000)", b:"#333"},
                {n:"Regal Purple", bg:"radial-gradient(circle, #2a0033, #000)", b:"#4d0066"},
                {n:"Presidential White", bg:"radial-gradient(circle, #fff, #f0f0f0)", b:"#D4AF37", txt:"#000"},
                {n:"Antique Cream", bg:"radial-gradient(circle, #fffdd0, #eee8aa)", b:"#8B4513", txt:"#222"}
            ];
            
            const borders = [
                "15px double", "6px solid", "10px ridge", "4px groove", 
                "2px solid", "20px double", "5px inset", "8px outset"
            ];

            const sel = document.getElementById('themeSelect');
            sel.innerHTML = "";
            let count = 1;

            colors.forEach(col => {
                borders.forEach(bord => {
                    const themeObj = {
                        id: count,
                        bg: col.bg,
                        border: `${bord} ${col.b === '#D4AF37' || count % 2 === 0 ? '#D4AF37' : col.b}`, 
                        boxShadow: `0 0 60px ${col.b}80`, 
                        textColor: col.txt || "#ffffff",
                        accentColor: "#D4AF37"
                    };
                    themes.push(themeObj);
                    sel.add(new Option(`${count}. ${col.n} - Variant`, count-1));
                    count++;
                });
            });
        }

        function applyTheme(idx) { updateLive(); }

        // --- 7. LIVE CONTROL ---
        function sendPhase(p) {
            curPhase = p;
            if(p === 'reciting') curIndex = 0;
            updateLive();
        }

        function navigate(dir) {
            if(curPhase !== 'reciting') { sendPhase('reciting'); return; }
            let n = curIndex + dir;
            if(n >= 0 && n < activeAyahs.length) {
                curIndex = n;
                updateLive();
            } else if (n >= activeAyahs.length) {
                sendPhase('end');
            }
        }

        function updateLive() {
            const data = getDisplayData();
            
            document.getElementById('prevAr').innerText = data.arabic;
            document.getElementById('prevTr').innerHTML = data.htmlTrans; 
            document.getElementById('prevTr').style.fontFamily = 'CustomDv';
            
            if(projWin && !projWin.closed) { projWin.render(data); }
        }

        function getDisplayData() {
            const title = document.getElementById('eventTitle').value;
            const themeIdx = document.getElementById('themeSelect').value || 0;
            const mode = document.getElementById('transMode').value;
            
            // Manual Styles
            const styles = {
                ar: {c:document.getElementById('colAr').value, s:document.getElementById('sizeAr').value},
                dv: {c:document.getElementById('colDv').value, s:document.getElementById('sizeDv').value},
                en: {c:document.getElementById('colEn').value, s:document.getElementById('sizeEn').value}
            };

            let ar = "", tr = "";

            if(curPhase === 'cover') {
                ar = title; tr = "";
            } else if(curPhase === 'start') {
                ar = "ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê"; tr = "";
            } else if(curPhase === 'end') {
                ar = "ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè Ÿ±ŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸè"; tr = "";
            } else if(activeAyahs[curIndex]) {
                const ay = activeAyahs[curIndex];
                ar = ay.ar;
                
                // DUAL TRANSLATION LOGIC
                if(mode === 'dv') tr = `<div class="dv-text">${ay.dv}</div>`;
                else if(mode === 'en') tr = `<div class="en-text">${ay.en}</div>`;
                else if(mode === 'none') tr = "";
                else if(mode === 'both') {
                    tr = `
                        <div class="dv-text">${ay.dv}</div>
                        <div class="royal-line"></div>
                        <div class="en-text">${ay.en}</div>
                    `;
                }
            }

            return {
                arabic: ar,
                htmlTrans: tr,
                theme: themes[themeIdx] || themes[0],
                phase: curPhase,
                fontData: customFontData, 
                styles: styles,
                transMode: mode
            };
        }

        // --- 8. TOGGLE APP FULLSCREEN ---
        function toggleAppFullscreen() {
            if(!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if(document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- 9. PROJECTOR WINDOW ---
        function openProjector() {
            if(projWin && !projWin.closed) { projWin.focus(); return; }

            projWin = window.open("", "RasfahiProjector", "width=1280,height=720");
            
            const html = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Amiri:wght@400;700&family=Noto+Sans+Thaana:wght@400;700&display=swap');
                    
                    body { 
                        margin:0; padding:0; overflow:hidden; 
                        background: #000; height: 100vh; width: 100vw;
                        display: flex; justify-content: center; align-items: center;
                        font-family: 'Amiri', serif;
                    }
                    
                    #card {
                        width: 92vw; height: 90vh; 
                        display: flex; flex-direction: column; 
                        justify-content: center; align-items: center;
                        text-align: center;
                        padding: 4vw; border-radius: 2vw;
                        transition: all 0.5s ease;
                        position: relative;
                        box-sizing: border-box;
                    }

                    #arabicText {
                        direction: rtl; line-height: 1.6;
                        text-shadow: 0 0.4vw 0.8vw rgba(0,0,0,0.6);
                        width: 100%;
                        margin-bottom: 3vh;
                    }

                    #transContainer {
                        width: 100%;
                        display: flex; flex-direction: column; align-items: center;
                        text-shadow: 0 0.2vw 0.4vw rgba(0,0,0,0.8);
                    }

                    .dv-text { font-family: 'CustomDv', 'Noto Sans Thaana'; direction: rtl; line-height: 1.6; margin-bottom: 1vh; }
                    .en-text { font-family: 'Cinzel', sans-serif; direction: ltr; margin-top: 1vh; text-transform: uppercase; letter-spacing: 0.1vw; }

                    .royal-line {
                        width: 50%; height: 0.2vw;
                        background: linear-gradient(90deg, transparent, #D4AF37, transparent);
                        margin: 1.5vh auto;
                        box-shadow: 0 0 1vw #D4AF37;
                    }

                    .title-mode { font-family: 'Cinzel', serif !important; text-transform: uppercase; color: #D4AF37 !important; text-shadow: 0 0 2vw #000; }

                    .watermark {
                        position: fixed; bottom: 2vh; left: 2vw;
                        color: rgba(255,255,255,0.15); font-family: 'Cinzel', sans-serif;
                        font-size: 1.2vw; letter-spacing: 0.2vw;
                        pointer-events: none; text-shadow:none;
                    }

                </style>
            </head>
            <body onclick="toggleFS()">
                <div id="card">
                    <div id="arabicText"></div>
                    <div id="transContainer"></div>
                </div>
                <div class="watermark">¬© AIDD RASFAHI</div>

                <script>
                    function toggleFS() {
                        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
                        else document.exitFullscreen();
                    }

                    window.render = function(data) {
                        // Inject Custom Font
                        if(data.fontData && !window.fontLoaded) {
                            const s = document.createElement('style');
                            s.innerHTML = \`@font-face { font-family: 'CustomDv'; src: url('\${data.fontData}'); }\`;
                            document.head.appendChild(s);
                            window.fontLoaded = true;
                        }

                        // Theme Application
                        const card = document.getElementById('card');
                        const th = data.theme;
                        card.style.background = th.bg;
                        card.style.border = th.border;
                        card.style.boxShadow = th.boxShadow;
                        card.style.color = th.textColor;

                        // Text Content
                        const arBox = document.getElementById('arabicText');
                        const trBox = document.getElementById('transContainer');
                        
                        arBox.innerHTML = data.arabic;
                        trBox.innerHTML = data.htmlTrans;

                        // APPLY MANUAL STYLES & AUTO SCALING
                        // Using 'vw' units for scaling based on sliders
                        
                        if(data.phase === 'cover') {
                            arBox.className = 'title-mode';
                            arBox.style.fontSize = (data.styles.ar.s * 1.5) + 'vw';
                            arBox.style.color = data.styles.ar.c;
                        } else if (data.phase === 'start' || data.phase === 'end') {
                            arBox.className = '';
                            arBox.style.fontSize = (data.styles.ar.s * 1.5) + 'vw';
                            arBox.style.color = '#fff';
                        } else {
                            arBox.className = '';
                            arBox.style.fontSize = data.styles.ar.s + 'vw'; 
                            arBox.style.color = data.styles.ar.c;
                            
                            const dv = document.querySelector('.dv-text');
                            const en = document.querySelector('.en-text');
                            if(dv) {
                                dv.style.fontSize = data.styles.dv.s + 'vw';
                                dv.style.color = data.styles.dv.c;
                            }
                            if(en) {
                                en.style.fontSize = data.styles.en.s + 'vw';
                                en.style.color = data.styles.en.c;
                            }
                        }
                    }
                <\/script>
            </body>
            </html>`;
            
            projWin.document.write(html);
            projWin.document.close();
            setTimeout(updateLive, 500); 
        }
    </script>
</body>
</html>
