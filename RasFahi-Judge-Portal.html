<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rasfahi Royal Quran (V24.2 Ceremony Pro)</title>
    <style>
        /* --- FONTS & IMPORTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700;900&family=Cinzel:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        /* Placeholder for Main App Font */
        @font-face {
            font-family: 'AppFont';
            src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
        }

        :root {
            --royal-blue: #001a33;
            --royal-blue-dark: #000d1a;
            --royal-green: #002200; 
            --royal-green-mix: #004d00;
            --gold: #D4AF37;
            --gold-bright: #FFD700;
            --gold-dim: #aa8c2c;
            --green: #006400;
            --green-bright: #00e676;
            --text-main: #ffffff;
            --panel-bg: #0b1016;
            --border-radius: 6px;
        }

        /* GLOBAL BOX SIZING */
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; outline: none; }
        
        /* APPLY FONT GLOBALLY */
        body, button, input, select, textarea, h1, h2, span, div, p, a, label { 
            font-family: 'AppFont', 'Noto Sans Thaana', 'Amiri', sans-serif !important; 
        }

        body { 
            margin: 0; padding: 0;
            background: #000; 
            color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; 
        }

        /* --- SIDEBAR DESIGN --- */
        .sidebar {
            width: 480px; 
            background: linear-gradient(180deg, var(--panel-bg) 0%, #000 100%); 
            border-left: 3px solid var(--gold);
            display: flex; flex-direction: column; height: 100vh; z-index: 100;
            box-shadow: 10px 0 40px rgba(0,0,0,0.8);
            transition: width 0.3s;
        }
        
        .header { 
            padding: 15px; text-align: center; 
            background: linear-gradient(to bottom, var(--royal-blue), var(--royal-blue-dark)); 
            border-bottom: 2px solid var(--gold); 
        }
        .app-title { 
            font-family: 'Cinzel', serif !important; color: var(--gold);
            font-size: 20px; margin: 0; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
        }

        .content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        /* FOOTER */
        .royal-footer {
            padding: 10px;
            background: linear-gradient(to top, #000, #111);
            border-top: 2px double var(--gold);
            text-align: center;
            font-size: 11px;
            color: #888;
        }
        .royal-footer p { margin: 2px 0; }
        .royal-footer .highlight { color: var(--gold); font-weight: bold; font-family: 'Cinzel', sans-serif !important; }
        
        .drive-btn {
            background: #1f1f1f; border: 1px dashed #555; color: #aaa;
            padding: 8px; width: 100%; margin-bottom: 10px; cursor: pointer;
            text-decoration: none; display: block; font-size: 11px;
            border-radius: 4px;
        }
        .drive-btn:hover { background: #333; color: #fff; border-color: var(--gold); }

        /* PANELS */
        .panel { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid #334455; 
            border-radius: var(--border-radius); 
            padding: 12px; 
            transition: 0.3s;
        }
        .panel:hover { border-color: #556677; }

        .panel-live {
            background: linear-gradient(135deg, rgba(0,26,51,0.6), rgba(0,0,0,0.8));
            border: 1px solid var(--gold-dim);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        h2 { 
            color: var(--gold); margin: 0 0 8px 0; font-size: 16px; 
            border-bottom: 1px dashed #445566; padding-bottom: 4px; 
        }
        
        label { color: #aab; font-size: 13px; display: block; margin-top: 8px; margin-bottom: 2px; }
        
        input, select, button { 
            width: 100%; padding: 8px; margin-top: 2px; 
            background: #1a222c; border: 1px solid #334455; 
            color: #fff; border-radius: 4px; 
            font-size: 14px; 
        }
        
        /* Custom Controls for Ceremony */
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .color-picker { width: 40px; padding: 2px; height: 35px; cursor: pointer; border: 1px solid #555; }
        .range-slider { flex: 1; cursor: pointer; accent-color: var(--gold); }
        
        /* BUTTON STYLES */
        button { 
            cursor: pointer; font-weight: bold; border-color: #445566; 
            transition: all 0.2s; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(to bottom, #2a3b4c, #1a222c);
        }
        button:hover { filter: brightness(1.2); border-color: var(--gold); transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        .btn-green { background: linear-gradient(to bottom, #004d00, #003300) !important; border-color: #006400 !important; color: #fff !important; }
        .btn-red { background: linear-gradient(to bottom, #8b0000, #500000) !important; border-color: #b71c1c !important; color: #fff !important; }
        .btn-gold { background: linear-gradient(to bottom, var(--gold), var(--gold-dim)) !important; color: #000 !important; border-color: #fff !important; font-weight: 900 !important; }
        .btn-blue { background: linear-gradient(to bottom, #004080, #002040) !important; border-color: #0059b3 !important; color: #fff !important; }
        .btn-purple { background: linear-gradient(to bottom, #4a148c, #311b92) !important; border-color: #7c4dff !important; color: #fff !important; }
        .btn-orange { background: linear-gradient(to bottom, #e65100, #bf360c) !important; border-color: #ff6d00 !important; color: #fff !important; }

        /* LANG SWITCHER */
        .lang-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .lang-btn { flex: 1; font-size: 12px; padding: 5px; background: #222; color: #777; border: 1px solid #444; }
        .lang-btn.active { background: var(--royal-blue); color: var(--gold); border-color: var(--gold); font-weight: bold; }

        /* MODE SWITCHER */
        .mode-switch { display: flex; background: #000; border: 1px solid #444; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: #222; color: #666; font-size: 12px; cursor: pointer; }
        .mode-btn.active { background: var(--royal-blue); color: var(--gold); font-weight: bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        /* READING MODE SWITCHER */
        .read-switch { display:flex; gap:5px; margin-bottom:10px; }
        .read-btn { flex:1; padding:8px; border:1px solid #444; background:#111; color:#888; font-size:12px; cursor: pointer; }
        .read-btn.active { background:#004d40; color:#fff; border-color:#00e676; font-weight:bold; }

        /* STATUS & SLOTS */
        #statusDisplay {
            background: #000; border: 2px solid var(--green-bright);
            color: var(--green-bright); text-align: center;
            font-family: 'Cinzel', serif !important; font-size: 18px; font-weight: bold;
            padding: 8px; margin-bottom: 10px; border-radius: 4px;
            text-shadow: 0 0 10px rgba(0,230,118,0.5);
        }

        #slotGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .slot-box { 
            background: #222; padding: 10px; text-align: center; font-size: 14px; 
            color: #555; border: 1px solid #333; border-radius: 4px; transition: 0.3s;
        }
        .slot-box.active { 
            background: var(--royal-blue); color: var(--gold); border-color: var(--gold); 
            font-weight: bold; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); transform: scale(1.05);
        }

        /* MAIN PREVIEW AREA (ADMIN MONITOR) */
        .main-view { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #222; position: relative; overflow: hidden; }
        .mirror-header { background: #111; padding: 5px 15px; color: #666; font-size: 11px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; flex-shrink: 0; }
        
        #adminMirror {
            flex: 1; overflow: hidden; position: relative;
            background: radial-gradient(circle, #001a33, #000);
            display: flex; justify-content: center; align-items: center;
        }
        
        /* SCROLLABLE ADMIN CARD */
        .mirror-card {
            width: 85%; height: 85%;
            background: #fff;
            border: 10px double var(--gold);
            position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 8px;
        }

        .mirror-banner-strip {
            background: rgba(0,0,0,0.9);
            color: var(--gold);
            padding: 8px;
            display: flex; justify-content: space-around;
            border-bottom: 2px solid var(--gold);
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            flex-shrink: 0;
        }

        /* SCROLLABLE IMAGE CONTAINER */
        .mirror-img-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background: #fff;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) #222;
        }
        
        .mirror-img-container::-webkit-scrollbar { width: 8px; }
        .mirror-img-container::-webkit-scrollbar-track { background: #222; }
        .mirror-img-container::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 4px; }

        .mirror-img-container img {
            width: 100%; height: auto; display: block;
        }

        .mirror-info-span { color: #fff; margin-left: 5px; }

        /* GRID PREVIEW */
        #gridPreview { display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 60%; }
        .gp-box { 
            background: #111; border: 1px solid #444; color: #666; 
            text-align: center; padding: 10px; font-size: 12px; cursor: pointer;
        }
        .gp-box:hover { background: #222; color: #fff; border-color: #666; }
        .gp-box.taken { background: #330000; color: #555; border-color: #500; pointer-events: none; }
        .gp-box.selected { background: var(--gold); color: #000; border-color: #fff; font-weight:bold; }

        .hidden { display: none !important; }

        /* SECURITY OVERLAY */
        #securityOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .sec-box { border: 2px solid var(--gold); padding: 40px; text-align: center; background: #000d1a; border-radius: 10px; width: 400px; box-shadow: 0 0 50px rgba(212,175,55,0.2); }

        /* ROYAL FULLSCREEN BUTTON */
        #royalFSBtn {
            position: absolute; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(212,175,55, 0.6);
            cursor: pointer; z-index: 200;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #000; transition: all 0.3s;
        }
        #royalFSBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }

        /* --- MOBILE & RESPONSIVE DESIGN --- */
        @media screen and (max-width: 900px) {
            body { flex-direction: column-reverse; height: auto; overflow-y: auto; }
            .sidebar { 
                width: 100%; height: auto; 
                border-left: none; border-top: 3px solid var(--gold); 
                order: 2;
            }
            .main-view { 
                width: 100%; height: 60vh; 
                order: 1; border-right: none;
            }
            .content { max-height: 400px; }
            .mirror-card { width: 95%; height: 95%; border-width: 5px; }
            .sec-box { width: 90%; }
            button, select, input { padding: 12px; font-size: 16px; }
        }

    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="bellStart" src="start.mp3"></audio>
    <audio id="bellEnd" src="end.mp3"></audio>

    <div id="securityOverlay">
        <div class="sec-box">
            <h1 style="color:var(--gold); font-family:'Cinzel' !important; margin:0;">Quran Recitation & Competition Judging Software</h1>
            <p style="color:#666; font-size:10px;">JUDGE + CEREMONY EDITION</p>
            <input type="password" id="secKey" style="text-align:center; font-size:18px; margin:15px 0; padding:10px; border-color:var(--gold);" placeholder="Enter License Key">
            <button class="btn-green" onclick="unlockSystem()">UNLOCK SYSTEM</button>
            <p id="secMsg" style="color:#ff5252; margin-top:10px; font-size:12px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="header">
            <h1 class="app-title" data-translate="title">RASFAHI JUDGE V24.2</h1>
        </div>

        <div class="content">
            <div class="lang-bar">
                <button class="lang-btn active" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                <button class="lang-btn" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                <button class="lang-btn" onclick="setLang('en')">English</button>
            </div>
            
            <div id="licenseDisplay" style="display:none; background:#e3f2fd; color:#00008b; text-align:center; font-weight:bold; font-size:13px; padding:8px; margin-bottom:10px; border-radius:4px; border: 1px solid #00008b;">
                Licensed To: <span id="licenseName"></span>
            </div>
            
            <div class="panel panel-live">
                <h2 data-translate="liveCtrl">1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Live)</h2>
                
                <div id="statusDisplay">WAITING...</div>
                
                <div class="mode-switch">
                    <button id="modeJudge" class="mode-btn active" onclick="setMode('judge')" data-translate="mJudge">‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)</button>
                    <button id="modeStudent" class="mode-btn" onclick="setMode('student')" data-translate="mStudent">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)</button>
                </div>

                <div class="read-switch">
                    <button id="rmMushaf" class="read-btn active" onclick="setReadingMode('mushaf')" data-translate="rmMushaf">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</button>
                    <button id="rmMemory" class="read-btn" onclick="setReadingMode('memory')" data-translate="rmMemory">üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</button>
                </div>

                <div id="judgeControls">
                    <button class="btn-gold" style="padding:12px;" onclick="pickRandomQuestion()" data-translate="btnPick">üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)</button>
                </div>

                <div id="studentControls" class="hidden">
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-blue" onclick="toggleGridScreen(true)" data-translate="btnShowGrid">1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß (Show Grid)</button>
                        <button class="btn-gold" onclick="reshuffleGrid()" data-translate="btnShuffle">üîÑ ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    </div>
                    
                    <div id="selectionInfo" style="background:#000; padding:5px; border:1px solid #444; margin:5px 0; font-size:12px; text-align:center; color:var(--gold);">
                        No selection yet.
                    </div>

                    <button id="btnStartReading" class="btn-green hidden" onclick="startReadingSession()" data-translate="btnStartQ1">2. ﬁäﬁ¶ﬁÅﬁß (Start Question 1)</button>
                </div>

                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-gold" style="width:30%;" onclick="prevQuestion()" data-translate="btnPrev">‚óÄ Previous</button>
                    <button class="btn-gold" style="flex:1;" onclick="nextQuestion()" data-translate="btnNext">Next Question ‚è©</button>
                </div>

                <div id="slotGrid"></div>

                <hr style="border-color:#334455; margin:15px 0;">

                <div style="display:flex; gap:10px;">
                    <button class="btn-green" onclick="toggleBell(true)" data-translate="btnBellStart">üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                    <button class="btn-red" onclick="toggleBell(false)" data-translate="btnBellStop">üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                </div>

                <button style="margin-top:10px; background:#442222; border:1px solid #aa3333;" onclick="resetStudentSession()" data-translate="btnReset">üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)</button>
            </div>

            <div class="panel">
                <h2 data-translate="lblSyllabus">2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)</h2>
                
                <label data-translate="lblFilterType">ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:</label>
                <select id="filterType" onchange="updateFilterUI()">
                    <option value="book" selected>By Book/Juz (ﬁäﬁÆﬁåﬁ™ﬁÇﬁ∞)</option>
                    <option value="surah">By Surah Order (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ™ﬁÇﬁ∞)</option>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label id="lblStartVal">ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start):</label>
                        <input type="number" id="scopeStart" value="1" placeholder="Start">
                    </div>
                    <div>
                        <label id="lblEndVal">ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End):</label>
                        <input type="number" id="scopeEnd" value="30" placeholder="End">
                    </div>
                </div>

                <button class="btn-green" onclick="applySyllabusFilter()" style="margin-top:10px;">‚úÖ Apply Syllabus</button>
                <div id="scopeStatus" style="font-size:11px; color:#aaa; margin-top:5px; text-align:center;">
                    System contains all questions.
                </div>
            </div>

            <div class="panel">
                <h2 data-translate="screens">3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</h2>
                
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn-blue" onclick="saveConfig()">üíæ SAVE Config</button>
                    <button class="btn-orange" onclick="document.getElementById('loadConf').click()">üìÇ LOAD Config</button>
                    <input type="file" id="loadConf" accept=".json" class="hidden" onchange="loadConfig(this)">
                </div>

                <button class="btn-red" onclick="clearCache()" style="font-size:10px; margin-bottom:10px;">üßπ Purge Memory (Clear Cache)</button>

                <label data-translate="lblStudent">1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:</label>
                <button onclick="openScreen('student')" class="btn-purple" data-translate="btnLaunchStudent">üñ•Ô∏è Student Screen (Launch)</button>

                <label data-translate="lblJudge">2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ (Multicast):</label>
                <div style="display:flex; gap:5px;">
                    <select id="judgeCount" style="width:40%;">
                        <script>
                            for(let i=1; i<=10; i++) document.write(`<option value="${i}" ${i===3?'selected':''}>${i} Judges</option>`);
                        </script>
                    </select>
                    <button onclick="openJudges()" class="btn-blue" data-translate="btnLaunchJudges">Open Judges üöÄ</button>
                </div>
            </div>

            <div class="panel">
                <h2 data-translate="settings">4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß</h2>
                
                <label style="color:#00e676;">‚òÖ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ∞ﬁìﬁØﬁçﬁ∞ (App Font):</label>
                <input type="file" id="fontLoader" accept=".ttf,.otf,.woff,.woff2" style="border-color:#00e676;">
                <small style="color:#666; font-size:10px;">Select .TTF or .WOFF file for Faruuma/Waheed</small>
                <hr style="border-color:#333; margin:8px 0;">

                <label>1. Royal Theme Engine (Main App):</label>
                <select id="themeSelect" onchange="updateTheme()">
                    </select>

                <label data-translate="lblCSV">2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
<div style="display:flex; gap:5px;">
    <input type="file" id="csvQ" accept=".csv">
    <a href="QuranQuestionBank.html" target="_blank" class="btn-purple" style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #7c4dff;">
        ‚¨áÔ∏è Sample / Bank
    </a>
</div> 
                <label data-translate="lblImg">3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ (Folder):</label>
                <input type="file" id="imgF" webkitdirectory directory multiple>
                <small id="imgStatus" style="color:#aaa; display:block;">No images loaded</small>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label data-translate="lblBorder">ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:</label>
                        <select id="borderStyle" onchange="syncWindows()">
                            <option value="royal">Royal Frame</option>
                            <option value="custom">Custom Img</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div>
                        <label data-translate="lblQCount">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:</label>
                        <select id="qLimit" onchange="resetStudentSession()">
                            <script>
                                for(let i=1; i<=20; i++) document.write(`<option value="${i}" ${i===3?'selected':''}>${i}</option>`);
                            </script>
                        </select>
                    </div>
                </div>
                <input type="file" id="borderImg" accept="image/*" class="hidden" style="margin-top:5px;">
            </div>

            <div class="panel">
                <h2 style="color:#ff9800;">5. ﬁñﬁ¶ﬁñﬁ®ﬁÇﬁ∞ﬁé & ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞</h2>
                
                <label>1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÄﬁÆﬁáﬁ∞ﬁàﬁ¶ﬁàﬁß:</label>
                <div style="display:flex; gap:5px;">
                    <select id="studentSelect" onchange="updateJudgeScreen()">
                        <option value="">-- Select Student --</option>
                    </select>
                    <button class="btn-green" style="width:40px;" onclick="addStudentPrompt()">+</button>
                </div>
                
                <p style="font-size:10px; color:#888; margin-top:10px;">
                    * The Rubric is built-in (Reading & Memory criteria). Judges will see the full marking grid automatically.
                </p>
            </div>

            <div class="panel" style="border:1px solid #00acc1; box-shadow:inset 0 0 10px rgba(0,172,193,0.1);">
                <h2 style="color:#00e5ff;">6. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ∞ (Ceremony)</h2>
                
                <label>1. ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Special Fonts):</label>
                <input type="file" id="ceremonyQuranFont" accept=".ttf,.otf" style="margin-bottom:5px;">
                <small style="color:#aaa;">Quran Font (e.g., Tanzil/Madina)</small>
                <input type="file" id="ceremonyTransFont" accept=".ttf,.otf">
                <small style="color:#aaa;">Translation Font (e.g., Faruuma)</small>
                
                <hr style="border-color:#333; margin:8px 0;">
                
                <label>2. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="file" id="ceremonyCSV" accept=".csv">
                </div>
                <button onclick="downloadCeremonySample('dv')" class="btn-purple" style="font-size:9px;">‚¨áÔ∏è Sample (Fixed Format)</button>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="color:#FFD700;">‚òÖ ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ (Styles):</label>
                
                <div style="margin-bottom:8px;">
                    <small style="color:#aaa;">Ceremony Theme (20+ Royal Styles):</small>
                    <select id="ceremonyTheme" onchange="updateCeremonyState()">
                        <script>
                            const cThemes = [
                                "Royal Green (Double Gold)", "Royal Blue (Double Gold)", "Royal Red (Double Gold)",
                                "Emerald Green (Single Gold)", "Midnight Blue (Single Gold)", "Burgundy (Single Gold)",
                                "Green & Blue Mix (Gold)", "Red & Black Mix (Gold)", "Deep Purple (Gold)",
                                "White & Gold (Royal Light)", "Cream & Gold (Classic)", "Black & Gold (Premium)",
                                "Green Gradient (Silver)", "Blue Gradient (Silver)", "Red Gradient (Silver)",
                                "Royal Teal (Gold Frame)", "Majestic Maroon (Gold Frame)", "Onyx Black (Double White)",
                                "Pearl White (Double Green)", "Mix: Green/Red/Blue (Presidential)"
                            ];
                            cThemes.forEach((t, i) => document.write(`<option value="${i}">${i+1}. ${t}</option>`));
                        </script>
                    </select>
                </div>

                <div class="control-row">
                    <input type="color" id="cArabicColor" value="#D4AF37" class="color-picker" onchange="updateCeremonyState()" title="Arabic Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Arabic Size (ﬁ¢ﬁ¶ﬁÉﬁ¶ﬁÑﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cArabicSize" class="range-slider" min="5" max="25" step="0.5" value="12" oninput="updateCeremonyState()">
                    </div>
                </div>

                <div class="control-row">
                    <input type="color" id="cTransColor" value="#ffffff" class="color-picker" onchange="updateCeremonyState()" title="Translation Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Dhivehi Size (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cTransSize" class="range-slider" min="2" max="15" step="0.5" value="5" oninput="updateCeremonyState()">
                    </div>
                </div>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="margin-top:10px; color:#00e5ff;">3. ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁêﬁ¨ﬁçﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ (Selection):</label>
                
                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Surah (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</small>
                    <select id="cSurah" onchange="onSurahChange()">
                        <option value="">-- Select Surah --</option>
                    </select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Start Ayah No (ﬁäﬁ¶ﬁÅﬁß ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cStart" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">End Ayah No (ﬁÇﬁ®ﬁâﬁ≠ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cEnd" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Translation Language:</small>
                    <select id="cLang" onchange="onRangeChange()">
                        <option value="dv">Dhivehi (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)</option>
                        <option value="en">English (ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ®)</option>
                    </select>
                </div>

                <label>4. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ (Event Title):</label>
                <input type="text" id="ceremonyTitle" placeholder="e.g. Quran Competition Opening" oninput="updateCeremonyState()">

                <button onclick="openCeremonyScreen()" class="btn-orange" style="margin-top:10px;">üì∫ Launch Ceremony Screen</button>

                <hr style="border-color:#333; margin:10px 0;">
                
                <div style="background:#000; padding:10px; border-radius:4px; text-align:center;">
                    <div id="ceremonyPreview" style="color:var(--gold); font-size:14px; margin-bottom:5px;">IDLE</div>
                    <div style="display:flex; gap:5px; justify-content:center;">
                         <button class="btn-blue" onclick="ceremonyPrev()">‚óÄ</button>
                         <button class="btn-blue" onclick="ceremonyNext()">‚ñ∂</button>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:5px;">
                      <button class="btn-green" onclick="ceremonySetPhase('start')">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</button>
                      <button class="btn-red" onclick="ceremonySetPhase('end')">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè</button>
                </div>
                <button class="btn-gold" style="margin-top:5px;" onclick="ceremonySetPhase('cover')">Show Cover / Hide</button>

            </div>

        </div>

        <div class="royal-footer">
            <a id="driveLink" href="#" target="_blank" class="drive-btn">
                üìÇ Open Google Drive Folder (Samples)
            </a>

            <p>Copyright Reserved</p>
            <p class="highlight">Ali Ibrahim Didi 7791550 & 9901550</p>
            <p>Zad Research and Consultancy Firm</p>
        </div>
    </div>

    <div class="main-view">
        <div class="mirror-header">
            <span>LIVE VIEW (ADMIN MONITOR)</span>
            <span id="mirrorStatus" style="color:var(--gold);">IDLE</span>
        </div>
        
        <div id="adminMirror">
            <div id="gridPreview"></div>

            <div id="mirrorContainer" class="mirror-card" style="display:flex;">
                
                <div id="adminBanner" class="mirror-banner-strip" style="display:none;">
                    <span>Book: <span id="mBook" class="mirror-info-span">-</span></span>
                    <span>Surah: <span id="mSurah" class="mirror-info-span">-</span></span>
                    <span>Ayah: <span id="mAyah" class="mirror-info-span">-</span></span>
                </div>

                <div class="mirror-img-container">
                    <img id="mImg" src="" style="display:none;">
                    
                    <h1 id="mMemoryText" style="display:none; color: var(--gold); text-align:center; font-size: 30px; margin-top: 20%;">
                        (Memory Recitation Mode)
                    </h1>

                    <h2 id="mReadyText" style="display:none; color:#00e676; text-align:center; margin-top:20%;">READY TO START</h2>
                    <h1 id="mFinishText" style="display:none; color:#ff5252; text-align:center; margin-top:20%; font-size:24px;"></h1>
                </div>

                <div id="adminWarn" style="position:absolute; bottom:5px; left:5px; color:#ff5252; font-size:11px; display:none; background:rgba(0,0,0,0.8); padding:2px;">‚ö†Ô∏è MEMORY MODE</div>
            </div>
            
            <div id="mirrorLight" style="position:absolute; bottom:20px; right:100px; width:30px; height:30px; background:#333; border-radius:50%; border:2px solid #555;"></div>

            <button id="royalFSBtn" onclick="toggleAppFullscreen()" title="Full Screen">‚õ∂</button>
        </div>
    </div>

<script>
    // --- 0. SURAH LIST FOR FILTERING ---
    const SURAH_NAMES = [
        "al-fatiha", "al-baqarah", "ali 'imran", "an-nisa", "al-ma'idah", "al-an'am", "al-a'raf", "al-anfal", "at-tawbah", "yunus",
        "hud", "yusuf", "ar-ra'd", "ibrahim", "al-hijr", "an-nahl", "al-isra", "al-kahf", "maryam", "ta-ha",
        "al-anbiya", "al-hajj", "al-mu'minun", "an-nur", "al-furqan", "ash-shu'ara", "an-naml", "al-qasas", "al-ankabut", "ar-rum",
        "luqman", "as-sajdah", "al-ahzab", "saba", "fatir", "ya-sin", "as-saffat", "sad", "az-zumar", "ghafir",
        "fussilat", "ash-shura", "az-zukhruf", "ad-dukhan", "al-jathiyah", "al-ahqaf", "muhammad", "al-fath", "al-hujurat", "qaf",
        "adh-dhariyat", "at-tur", "an-najm", "al-qamar", "ar-rahman", "al-waqi'ah", "al-hadid", "al-mujadila", "al-hashr", "al-mumtahanah",
        "as-saff", "al-jumu'ah", "al-munafiqun", "at-taghabun", "at-talaq", "at-tahrim", "al-mulk", "al-qalam", "al-haqqah", "al-ma'arij",
        "nuh", "al-jinn", "al-muzzammil", "al-muddaththir", "al-qiyamah", "al-insan", "al-mursalat", "an-naba", "an-nazi'at", "abasa",
        "at-takwir", "al-infitar", "al-mutaffifin", "al-inshiqaq", "al-buruj", "at-tariq", "al-a'la", "al-ghashiyah", "al-fajr", "al-balad",
        "ash-shams", "al-layl", "ad-duha", "ash-sharh", "at-tin", "al-alaq", "al-qadr", "al-bayyinah", "az-zalzalah", "al-adiyat",
        "al-qari'ah", "at-takathur", "al-asr", "al-humazah", "al-fil", "quraysh", "al-ma'un", "al-kawthar", "al-kafirun", "an-nasr",
        "al-masad", "al-ikhlas", "al-falaq", "an-nas"
    ];

    // --- 0. SECURITY & CONFIG ---
    const GOOGLE_DRIVE_URL = "https://drive.google.com/drive/folders/YOUR_FOLDER_ID"; 
    document.getElementById('driveLink').href = GOOGLE_DRIVE_URL;

    // --- NEW: FONT LOADING LOGIC ---
    document.getElementById('fontLoader').onchange = e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            state.fontData = evt.target.result;
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }`;
            document.head.appendChild(style);
            alert("Font Loaded Successfully! (Syncing to screens...)");
            syncWindows();
        };
        reader.readAsDataURL(file);
    };

    // --- TRANSLATION DICTIONARY ---
    const i18n = {
        title: { dv: "ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ∞ V24.2", ar: "ÿßŸÑŸÇÿßÿ∂Ÿä ÿ±ÿµŸÅŸáŸä V24.2", en: "Rasfahi Judge V24.2" },
        lblSyllabus: { dv: "2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)", ar: "2. ÿßŸÑŸÖŸÜŸáÿ¨", en: "2. Syllabus Scope" },
        lblFilterType: { dv: "ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:", ar: "ŸÜŸàÿπ ÿßŸÑÿ™ÿµŸÅŸäÿ©:", en: "Filter Mode:" },
        liveCtrl: { dv: "1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", ar: "1. ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±", en: "1. Live Control" },
        mJudge: { dv: "‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)", ar: "‚öñÔ∏è Ÿàÿ∂ÿπ ÿßŸÑŸÇÿßÿ∂Ÿä (ÿ™ŸÑŸÇÿßÿ¶Ÿä)", en: "‚öñÔ∏è Judge Mode (Auto)" },
        mStudent: { dv: "üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)", ar: "üéì Ÿàÿ∂ÿπ ÿßŸÑÿ∑ÿßŸÑÿ® (ŸäÿØŸàŸä)", en: "üéì Student Mode (Manual)" },
        rmMushaf: { dv: "üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)", ar: "üìñ ÿßŸÑŸÖÿµÿ≠ŸÅ (ŸÜÿ∏ÿ±)", en: "üìñ Mushaf (Reading)" },
        rmMemory: { dv: "üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)", ar: "üß† ÿßŸÑÿ≠ŸÅÿ∏ (ÿ∫Ÿäÿ®)", en: "üß† Memory (Recital)" },
        btnPick: { dv: "üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)", ar: "üé≤ ÿßÿÆÿ™ÿ± ÿ≥ÿ§ÿßŸÑÿßŸã (ÿπÿ¥Ÿàÿßÿ¶Ÿä)", en: "üé≤ Pick Question (Random)" },
        btnShowGrid: { dv: "1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß", ar: "1. ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ®ŸÉÿ©", en: "1. Show Grid" },
        btnShuffle: { dv: "üîÑ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠", ar: "üîÑ ÿÆŸÑÿ∑", en: "üîÑ Shuffle" },
        btnStartQ1: { dv: "2. ﬁäﬁ¶ﬁÅﬁß (Start Q1)", ar: "2. ÿßÿ®ÿØÿ£ (ÿ≥ÿ§ÿßŸÑ 1)", en: "2. Start (Q1)" },
        btnPrev: { dv: "‚óÄ ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨", ar: "‚óÄ ÿßŸÑÿ≥ÿßÿ®ŸÇ", en: "‚óÄ Prev" },
        btnNext: { dv: "ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ‚è©", ar: "ÿßŸÑÿ™ÿßŸÑŸä ‚è©", en: "Next ‚è©" },
        btnBellStart: { dv: "üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üîî ÿßÿ®ÿØÿ£ (ÿ¨ÿ±ÿ≥)", en: "üîî Start (Bell)" },
        btnBellStop: { dv: "üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üõë ÿ™ŸàŸÇŸÅ (ÿ¨ÿ±ÿ≥)", en: "üõë Stop (Bell)" },
        btnReset: { dv: "üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)", ar: "üîÑ ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ (ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ)", en: "üîÑ New Student (Reset)" },
        screens: { dv: "3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞", ar: "3. ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™", en: "3. Screens & Config" },
        lblStudent: { dv: "1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "1. ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:", en: "1. Student Screen:" },
        btnLaunchStudent: { dv: "üñ•Ô∏è ﬁçﬁØﬁÇﬁ∞ﬁóﬁ∞ (Student)", ar: "üñ•Ô∏è ŸÅÿ™ÿ≠ (ÿßŸÑÿ∑ÿßŸÑÿ®)", en: "üñ•Ô∏è Launch (Student)" },
        lblJudge: { dv: "2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "2. ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇÿßÿ∂Ÿä:", en: "2. Judge Screen:" },
        btnLaunchJudges: { dv: "Open Judges üöÄ", ar: "ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ∂ÿßÿ© üöÄ", en: "Open Judges üöÄ" },
        settings: { dv: "4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß", ar: "4. ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™", en: "4. Settings & Data" },
        lblCSV: { dv: "2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):", ar: "2. ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (CSV):", en: "2. Question Data (CSV):" },
        lblImg: { dv: "3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ:", ar: "3. ÿµŸàÿ± ÿßŸÑÿ¢Ÿäÿßÿ™:", en: "3. Ayah Images:" },
        lblBorder: { dv: "ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:", ar: "ÿßŸÑÿ•ÿ∑ÿßÿ±:", en: "Border:" },
        lblQCount: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:", ar: "ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©:", en: "Question Count:" },
        msgFinished: { 
            dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", 
            ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", 
            en: "Questioning complete for the current limit!" 
        }
    };

    let currentLang = 'dv';
    let themeList = [];

    // --- 1. THEME ENGINE (MAIN APP) ---
    function initThemes() {
        const bases = [
            {n:"Royal Blue", c1:"#001a33", c2:"#000d1a", txt:"#ffffff"},
            {n:"Emerald Green", c1:"#002b15", c2:"#001a0d", txt:"#e6ffe6"},
            {n:"Burgundy Red", c1:"#2a0000", c2:"#1a0000", txt:"#ffe6e6"},
            {n:"Midnight Black", c1:"#111111", c2:"#000000", txt:"#ffffff"},
            {n:"Imperial Purple", c1:"#1a0033", c2:"#0d001a", txt:"#f2e6ff"}
        ];
        const accents = [
            {n:"Gold", c:"#D4AF37", b:"double"},
            {n:"Silver", c:"#C0C0C0", b:"ridge"},
            {n:"Bronze", c:"#cd7f32", b:"groove"},
            {n:"White Gold", c:"#f5f5dc", b:"solid"}
        ];

        const sel = document.getElementById('themeSelect');
        sel.innerHTML = ""; 
        let count = 1;
        
        bases.forEach(base => {
            accents.forEach(acc => {
                for(let i=1; i<=5; i++) { 
                     let variantName = i === 1 ? "Standard" : (i===2 ? "Dark" : (i===3 ? "Deep" : (i===4 ? "Vivid" : "Classic")));
                     let themeObj = {
                        name: `Theme ${count}: ${base.n} & ${acc.n} (${variantName})`,
                        bg1: base.c1, bg2: base.c2,
                        accent: acc.c, borderType: acc.b, text: base.txt,
                        id: count
                    };
                    themeList.push(themeObj);
                    let opt = document.createElement('option');
                    opt.value = count-1;
                    opt.innerText = themeObj.name;
                    sel.appendChild(opt);
                    count++;
                }
            });
        });
        
        if(themeList.length > 0) {
            state.theme = themeList[0];
            sel.value = 0;
        }
    }

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
        document.querySelector('.sidebar').style.borderLeft = (lang === 'en') ? 'none' : '3px solid var(--gold)';

        // Apply translations
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if(i18n[key] && i18n[key][lang]) {
                el.innerText = i18n[key][lang];
            }
        });

        // Update Scope UI labels based on language
        updateFilterUI();

        if(i18n.msgFinished[lang]) {
            document.getElementById('mFinishText').innerHTML = i18n.msgFinished[lang].replace(/\n/g, '<br>');
        }
        syncWindows();
    }

    function toggleAppFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
        } else {
            document.exitFullscreen();
        }
    }

    // --- STATE ---
    let state = {
        qPool: [],        
        filteredPool: [], 
        qUsed: [], qDataMap: {}, 
        pImages: {}, 
        fontData: null, borderData: null,
        windows: { student: null, judges: [], ceremony: null },
        session: { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false },
        mode: 'judge', readingMode: 'mushaf',
        grid: { map: {}, visible: false, taken: [] },
        theme: null,
        
        // Syllabus State
        syllabus: {
            active: false,
            type: 'book', 
            start: 1,
            end: 30
        },

        // Judging Data
        judging: {
            students: ["Ali", "Ahmed", "Fathimath", "Aishath", "Hassan"], 
            currentStudent: "",
            rubric: [
                { name: "ﬁãﬁ¨ﬁçﬁ®ﬁéﬁ¶ﬁÇﬁëﬁ™ﬁéﬁ¨ ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (Fluency)", max: 10 },
                { name: "ﬁáﬁ¶ﬁÜﬁ™ﬁÉﬁ™ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁöﬁ∞ﬁÉﬁ¶ﬁñﬁ™ (Makhraj)", max: 10 },
                { name: "ﬁÇﬁ´ﬁÇﬁ™ﬁêﬁ™ﬁÜﬁ™ﬁÇﬁßﬁáﬁ® ﬁåﬁ¶ﬁÇﬁ∞ﬁàﬁ©ﬁÇﬁ™ﬁéﬁ¨ ﬁôﬁ™ﬁÜﬁ™ﬁÇﬁ∞ (Noon/Tanween)", max: 5 },
                { name: "ﬁâﬁ©ﬁâﬁ∞ﬁéﬁ¨ ﬁôﬁ™ﬁÜﬁ™ﬁÇﬁ∞ (Meem Sakinah)", max: 5 },
                { name: "ﬁûﬁ®ﬁäﬁ¶ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁãﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Sifaat)", max: 10 },
                { name: "ﬁäﬁ®ﬁçﬁ®ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ ﬁáﬁ¶ﬁãﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Vowels)", max: 5 },
                { name: "ﬁâﬁ¶ﬁáﬁ∞ﬁãﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁãﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Madd)", max: 5 },
                { name: "ﬁàﬁ¶ﬁ§ﬁ∞ﬁäﬁ∞ ﬁáﬁ¶ﬁãﬁßﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Waqf)", max: 5 },
                { name: "ﬁåﬁ¶ﬁçﬁ¶ﬁáﬁ∞ﬁäﬁ™ﬁíﬁßﬁáﬁ® ﬁáﬁ¶ﬁãﬁß (Talaffuz)", max: 10 },
                { name: "ﬁäﬁ¶ﬁûﬁßﬁôﬁß (Fasaha)", max: 5 },
                { name: "ﬁåﬁ¶ﬁñﬁ∞ﬁàﬁ©ﬁãﬁ™ﬁéﬁ¨ ﬁÄﬁ¶ﬁâﬁ¶ﬁåﬁ¶ﬁáﬁ∞ (Overall Tajweed)", max: 10 },
                { name: "ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁäﬁ¶ﬁÉﬁ®ﬁåﬁ¶ﬁÜﬁ¶ﬁÇﬁ∞ (Overall Fluency)", max: 5 },
                { name: "ﬁáﬁ¶ﬁëﬁ™ ﬁéﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÖﬁ™ﬁÇﬁ∞ (Voice Control)", max: 5 },
                { name: "ﬁÉﬁßﬁéﬁ™ (Tune/Raagu)", max: 5 },
                { name: "ﬁâﬁ¶ﬁ§ﬁßﬁâﬁßﬁåﬁ™ (Maqamat)", max: 5 }
            ]
        },

        // Ceremony Data (Fixed Structure)
        ceremony: {
            active: false,
            phase: 'cover', // cover, start, reciting, end
            groupedData: {}, // Map { "Al-Fatiha": [ {no:1, arabic:.., dv:.., en:..} ] }
            activeData: [], // Selected Slice of ayahs
            currentIndex: 0,
            selectedLang: 'dv', // dv or en
            fonts: { quran: null, trans: null },
            
            // New Settings for Ceremony Screen
            settings: {
                themeIndex: 0,
                arabicColor: '#D4AF37',
                transColor: '#ffffff',
                arabicSize: 12,
                transSize: 5
            }
        }
    };

    // --- SYSTEM SECURITY & VALIDATION ---
    function unlockSystem() {
        const inputKey = document.getElementById('secKey').value.trim();
        const msg = document.getElementById('secMsg');

        if (inputKey === "ADMIN-12345") {
            document.getElementById('securityOverlay').classList.add('hidden');
            renderSlots();
            const licDisp = document.getElementById('licenseDisplay');
            const licName = document.getElementById('licenseName');
            if(licDisp && licName) {
                licDisp.style.display = "block";
                licName.innerText = "SYSTEM ADMIN";
            }
            return;
        }

        try {
            const decodedString = atob(inputKey);
            if (!decodedString.startsWith("ROYAL_EXP_")) {
                throw new Error("Invalid Format");
            }
            const parts = decodedString.split('_'); 
            const expiryDateStr = parts[2]; 
            let customerName = parts[4]; 
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const expiry = new Date(expiryDateStr);

            if (isNaN(expiry.getTime())) throw new Error("Invalid Date");

            if (today > expiry) {
                msg.innerText = "‚õî LICENSE EXPIRED! (Valid until: " + expiryDateStr + ")";
                msg.style.color = "#ff5252";
            } else {
                document.getElementById('securityOverlay').classList.add('hidden');
                renderSlots();
                customerName = customerName.replace(/-/g, ' ');
                const licDisp = document.getElementById('licenseDisplay');
                const licName = document.getElementById('licenseName');
                if(licDisp && licName) {
                    licDisp.style.display = "block";
                    licName.innerText = customerName.toUpperCase();
                }
            }

        } catch (e) {
            msg.innerText = "‚ùå Invalid License Key.";
            msg.style.color = "#ffb74d";
        }
    }

    function setMode(mode) {
        state.mode = mode;
        document.getElementById('modeJudge').classList.toggle('active', mode === 'judge');
        document.getElementById('modeStudent').classList.toggle('active', mode === 'student');
        document.getElementById('judgeControls').classList.toggle('hidden', mode !== 'judge');
        document.getElementById('studentControls').classList.toggle('hidden', mode !== 'student');
        
        if(mode === 'student') {
            reshuffleGrid(); 
        } else { 
            state.grid.visible = false; 
            syncWindows(); 
        }
    }

    function setReadingMode(rm) {
        state.readingMode = rm;
        document.getElementById('rmMushaf').classList.toggle('active', rm === 'mushaf');
        document.getElementById('rmMemory').classList.toggle('active', rm === 'memory');
        updateMirror(); syncWindows();
    }

    function updateTheme() {
        const idx = document.getElementById('themeSelect').value;
        state.theme = themeList[idx];
        syncWindows();
    }

    function downloadSampleCSV() {
        const csvContent = "data:text/csv;charset=utf-8,ID,Image,Book,Surah,Page,StartAyah,EndAyah\n1,1.png,Juz 1,Al-Fatiha,1,1,7\n2,002.png,Juz 1,Al-Baqarah,2,1,5\n3,003.png,Juz 30,114. An-Nas,604,1,6";
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "main_quiz_sample.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // --- CEREMONY CSV & LOGIC (FIXED) ---
    function downloadCeremonySample(lang) {
        // Correct headers for filtering
        let content = "SurahName,AyahNo,AyahArabic,TranslationDV,TranslationEN\n";
        content += "Al-Fatiha,1,ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê,ﬁÑﬁ®ﬁêﬁ∞ﬁâﬁ®Ô∑≤,In the name of Allah\n";
        content += "Al-Fatiha,2,ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé,ﬁâﬁßﬁåﬁ∞Ô∑≤ﬁáﬁ¶ﬁÅﬁ∞ ﬁôﬁ¶ﬁâﬁ∞ﬁãﬁ™ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ¨ﬁàﬁ¨.,Praise be to Allah\n";
        
        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(content);
        link.download = `ceremony_fixed_sample.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    document.getElementById('ceremonyCSV').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.ceremony.groupedData = {};
            
            // Expected CSV: SurahName, AyahNo, Arabic, TransDV, TransEN
            rows.slice(1).forEach((r, idx) => {
                const c = r.split(',');
                if(c.length >= 3) {
                    const surah = c[0].trim();
                    const no = parseInt(c[1].trim()) || (idx + 1);
                    const arabic = c[2].trim();
                    const dv = c[3] ? c[3].trim() : "";
                    const en = c[4] ? c[4].trim() : "";
                    
                    if(surah && arabic) {
                        if(!state.ceremony.groupedData[surah]) {
                            state.ceremony.groupedData[surah] = [];
                        }
                        state.ceremony.groupedData[surah].push({
                            no: no,
                            arabic: arabic,
                            dv: dv,
                            en: en
                        });
                    }
                }
            });

            // Populate Surah Dropdown
            const cSurah = document.getElementById('cSurah');
            cSurah.innerHTML = '<option value="">-- Select Surah --</option>';
            Object.keys(state.ceremony.groupedData).forEach(sName => {
                cSurah.add(new Option(sName, sName));
            });

            alert(`Ceremony Data Loaded! Found ${Object.keys(state.ceremony.groupedData).length} Surahs.`);
        };
        r.readAsText(e.target.files[0]);
    };

    // --- UI LOGIC FOR DROPDOWNS ---
    function onSurahChange() {
        const sName = document.getElementById('cSurah').value;
        const cStart = document.getElementById('cStart');
        const cEnd = document.getElementById('cEnd');
        
        cStart.innerHTML = ''; 
        cEnd.innerHTML = '';
        
        if(!sName || !state.ceremony.groupedData[sName]) return;

        const ayahs = state.ceremony.groupedData[sName];
        
        // Populate Start and End Dropdowns with Numbers
        ayahs.forEach((a, idx) => {
            let txt = `Ayah ${a.no}`;
            cStart.add(new Option(txt, idx)); // Value is index in the array
            cEnd.add(new Option(txt, idx));
        });

        // Default End to last ayah
        cEnd.value = ayahs.length - 1;
        
        onRangeChange(); // Update state
    }

    function onRangeChange() {
        const sName = document.getElementById('cSurah').value;
        if(!sName) return;

        const startIdx = parseInt(document.getElementById('cStart').value);
        const endIdx = parseInt(document.getElementById('cEnd').value);
        const lang = document.getElementById('cLang').value;

        state.ceremony.selectedLang = lang;
        
        const ayahs = state.ceremony.groupedData[sName];
        
        if(startIdx > endIdx) {
            // Invalid range, do nothing or warn (handled by slicing returning empty or swapping if logic added)
             state.ceremony.activeData = [];
        } else {
             state.ceremony.activeData = ayahs.slice(startIdx, endIdx + 1);
        }

        state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }

    // Load Ceremony Fonts
    const loadCF = (id, key) => {
        document.getElementById(id).onchange = e => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => { 
                state.ceremony.fonts[key] = ev.target.result; 
                alert(key + " Font Loaded!"); 
                syncWindows(); 
            };
            r.readAsDataURL(f);
        }
    };
    loadCF('ceremonyQuranFont', 'quran');
    loadCF('ceremonyTransFont', 'trans');

    function ceremonyNext() {
        if(state.ceremony.phase === 'reciting') {
            if(state.ceremony.currentIndex < state.ceremony.activeData.length - 1) {
                state.ceremony.currentIndex++;
                updateCeremonyPreview();
                syncWindows();
            } else {
                state.ceremony.phase = 'end'; // Go to Sadaqallah
                updateCeremonyPreview();
                syncWindows();
            }
        } else if (state.ceremony.phase === 'start') {
            state.ceremony.phase = 'reciting';
            state.ceremony.currentIndex = 0;
            updateCeremonyPreview();
            syncWindows();
        }
    }

    function ceremonyPrev() {
        if(state.ceremony.phase === 'reciting' && state.ceremony.currentIndex > 0) {
            state.ceremony.currentIndex--;
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'reciting' && state.ceremony.currentIndex === 0) {
            state.ceremony.phase = 'start';
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'end') {
             state.ceremony.phase = 'reciting';
             state.ceremony.currentIndex = state.ceremony.activeData.length - 1;
             updateCeremonyPreview();
             syncWindows();
        }
    }

    function ceremonySetPhase(p) {
        state.ceremony.phase = p;
        if(p === 'reciting') state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }
    
    function updateCeremonyState() {
        // Collect new settings
        state.ceremony.settings.themeIndex = document.getElementById('ceremonyTheme').value;
        state.ceremony.settings.arabicColor = document.getElementById('cArabicColor').value;
        state.ceremony.settings.transColor = document.getElementById('cTransColor').value;
        state.ceremony.settings.arabicSize = document.getElementById('cArabicSize').value;
        state.ceremony.settings.transSize = document.getElementById('cTransSize').value;
        
        syncWindows(); 
    }

    function updateCeremonyPreview() {
        const el = document.getElementById('ceremonyPreview');
        if(state.ceremony.phase === 'cover') el.innerText = "DISPLAYING COVER (Title)";
        else if(state.ceremony.phase === 'start') el.innerText = "DISPLAYING BASMALAH";
        else if(state.ceremony.phase === 'end') el.innerText = "DISPLAYING SADAQALLAH";
        else {
            const a = state.ceremony.activeData[state.ceremony.currentIndex];
            if(a) {
                el.innerText = `Ayah ${a.no}: ${a.arabic.substring(0, 20)}...`;
            } else {
                el.innerText = "No Ayah Selected";
            }
        }
    }

    // --- END CEREMONY LOGIC ---

    function saveConfig() {
        const config = {
            themeIndex: document.getElementById('themeSelect').value,
            borderStyle: document.getElementById('borderStyle').value,
            qLimit: document.getElementById('qLimit').value,
            mode: state.mode,
            readingMode: state.readingMode,
            judgeCount: document.getElementById('judgeCount').value
        };
        const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "rasfahi_config.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadConfig(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                document.getElementById('themeSelect').value = config.themeIndex || 0;
                document.getElementById('borderStyle').value = config.borderStyle || 'royal';
                document.getElementById('qLimit').value = config.qLimit || 3;
                document.getElementById('judgeCount').value = config.judgeCount || 3;
                
                updateTheme();
                setMode(config.mode || 'judge');
                setReadingMode(config.readingMode || 'mushaf');
                
                resetStudentSession();
                alert("Configuration Loaded Successfully!");
            } catch(err) {
                alert("Error loading config: " + err);
            }
        };
        reader.readAsText(file);
    }

    function clearCache() {
        if(confirm("Are you sure? This will clear all loaded images to free up memory.")) {
            Object.values(state.pImages).forEach(url => URL.revokeObjectURL(url));
            state.pImages = {};
            state.qDataMap = {};
            state.qPool = [];
            state.filteredPool = [];
            state.qUsed = [];
            document.getElementById('imgStatus').innerText = "Memory Purged. Reload Images.";
            document.getElementById('mImg').src = "";
            resetStudentSession();
            alert("Memory Cleared!");
        }
    }

    function resolveImage(rawName) {
        if(!rawName) return null;
        rawName = rawName.toString().toLowerCase().trim();
        if(state.pImages[rawName]) return state.pImages[rawName];
        if(state.pImages[rawName + '.png']) return state.pImages[rawName + '.png'];
        if(state.pImages[rawName.padStart(3, '0') + '.png']) return state.pImages[rawName.padStart(3, '0') + '.png'];
        const intVal = parseInt(rawName);
        if(!isNaN(intVal) && state.pImages[intVal]) return state.pImages[intVal];
        return null;
    }

    function rebindAllImages() {
        Object.values(state.qDataMap).forEach(q => { q.src = resolveImage(q.imgRaw); });
        syncWindows();
    }

    document.getElementById('imgF').onchange = e => {
        let count = 0; state.pImages = {}; 
        for(let f of e.target.files) {
            if(f.type.startsWith('image/')) {
                const url = URL.createObjectURL(f);
                const name = f.name.toLowerCase();
                state.pImages[name] = url; 
                state.pImages[name.split('.')[0]] = url; 
                count++;
            }
        }
        document.getElementById('imgStatus').innerText = count + " images loaded ready.";
        rebindAllImages();
    };

    document.getElementById('csvQ').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.qPool = []; state.qUsed = []; state.filteredPool = [];
            rows.slice(1).forEach(r => {
                const c = r.split(',');
                if(c.length < 2) return;
                const id = c[0].trim();
                const imgRaw = c[1] ? c[1].trim() : "";
                
                // Helper to extract numbers
                const bookVal = c[2] ? c[2].trim() : "";
                const bookNum = parseInt(bookVal.replace(/\D/g,'')) || 0; // "Juz 30" -> 30

                const surahVal = c[3] ? c[3].trim() : "";
                let surahNum = 0;

                // Try to find Surah number from string (e.g. "114. An-Nas")
                const match = surahVal.match(/^(\d+)/);
                if(match) {
                    surahNum = parseInt(match[1]);
                } else {
                    // Try to map name from list
                    const sLower = surahVal.toLowerCase().replace(/[^a-z]/g, '');
                    const idx = SURAH_NAMES.findIndex(n => n.replace(/[^a-z]/g, '') === sLower);
                    if(idx > -1) surahNum = idx + 1;
                }

                state.qDataMap[id] = { 
                    id: id, imgRaw: imgRaw, src: null,        
                    book: bookVal, bookNum: bookNum,
                    surah: surahVal, surahNum: surahNum,
                    page: c[4], start: c[5], end: c[6] 
                };
                state.qPool.push(id);
            });
            rebindAllImages();
            // Default to all active
            state.filteredPool = [...state.qPool];
            applySyllabusFilter(); // Re-apply if settings exist
            alert("Questions Loaded: " + state.qPool.length);
        };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('borderStyle').onchange = function() {
        document.getElementById('borderImg').classList.toggle('hidden', this.value !== 'custom');
        syncWindows();
    };
    document.getElementById('borderImg').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { state.borderData = ev.target.result; syncWindows(); };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- NEW SYLLABUS LOGIC ---
    function updateFilterUI() {
        const type = document.getElementById('filterType').value;
        const lblStart = document.getElementById('lblStartVal');
        const lblEnd = document.getElementById('lblEndVal');
        
        if(type === 'book') {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start Book):" : "Start Book/Juz:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End Book):" : "End Book/Juz:";
        } else {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (Start Surah ID):" : "Start Surah No:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (End Surah ID):" : "End Surah No:";
        }
    }

    function applySyllabusFilter() {
        const type = document.getElementById('filterType').value;
        const start = parseInt(document.getElementById('scopeStart').value) || 1;
        const end = parseInt(document.getElementById('scopeEnd').value) || 114;

        if(state.qPool.length === 0) return;

        state.filteredPool = state.qPool.filter(qid => {
            const q = state.qDataMap[qid];
            if(type === 'book') {
                // Filter by Book/Juz Number
                return q.bookNum >= start && q.bookNum <= end;
            } else {
                // Filter by Surah Number
                return q.surahNum >= start && q.surahNum <= end;
            }
        });

        // Update UI
        const status = document.getElementById('scopeStatus');
        status.innerText = `Active Questions: ${state.filteredPool.length} (Range: ${start}-${end})`;
        status.style.color = state.filteredPool.length > 0 ? "#00e676" : "#ff5252";

        if(state.filteredPool.length === 0) {
            alert("‚ö†Ô∏è No questions found in this range!");
        } else {
             // Reset grid to reflect new syllabus
            if(state.mode === 'student') reshuffleGrid();
        }
    }

    // --- GRID ---
    window.handleGridClick = function(boxID) {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.selectionIDs.length >= limit) return;

        const qID = state.grid.map[boxID];
        
        if(!qID || state.grid.taken.includes(boxID)) {
             return;
        }

        state.grid.taken.push(boxID);
        state.session.selectionIDs.push(qID);

        // Remove from pools
        const idx = state.qPool.indexOf(qID);
        if(idx > -1) state.qPool.splice(idx, 1);
        
        const fIdx = state.filteredPool.indexOf(qID);
        if(fIdx > -1) state.filteredPool.splice(fIdx, 1);

        state.qUsed.push(qID);

        updateSelectionUI();

        if(state.session.selectionIDs.length === limit) {
            state.grid.visible = false;
            state.session.phase = 'ready';
            prepareSlotsFromSelection();
            document.getElementById('btnStartReading').classList.remove('hidden');
        } else {
            state.session.phase = 'selection';
        }
        renderSlots(); updateGridPreview(); syncWindows();
    }

    function updateSelectionUI() {
        document.getElementById('selectionInfo').innerText = "Selected: " + state.session.selectionIDs.join(", ");
    }

    function prepareSlotsFromSelection() {
        state.session.slots = state.session.selectionIDs.map(id => {
            let q = state.qDataMap[id];
            if(q && !q.src) q.src = resolveImage(q.imgRaw);
            return q;
        });
        state.session.activeIndex = -1;
        updateStatus();
    }

    window.startReadingSession = function() {
        if(state.session.slots.length === 0) return;
        state.session.activeIndex = 0;
        state.session.phase = 'active';
        document.getElementById('btnStartReading').classList.add('hidden');
        updateStatus(); updateMirror(); syncWindows();
    }

    window.pickRandomQuestion = function() {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.slots.length >= limit) return;
        
        const q = getRandomQ();
        if(!q) return;

        state.session.slots.push(q);
        state.session.activeIndex = state.session.slots.length - 1;
        state.session.phase = 'active';
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    };

    function getRandomQ() {
        // Use filtered pool for syllabus
        if(state.filteredPool.length === 0) {
             if(state.qUsed.length === 0) { alert("No Data or Empty Filter!"); return null; }
             alert("Syllabus pool empty. Reload or check scope.");
             return null;
        }
        const rIdx = Math.floor(Math.random() * state.filteredPool.length);
        const qID = state.filteredPool[rIdx];
        
        // Move from pool to used
        state.filteredPool.splice(rIdx, 1);
        
        // Also remove from main qPool to keep synced
        const mIdx = state.qPool.indexOf(qID);
        if(mIdx > -1) state.qPool.splice(mIdx, 1);

        state.qUsed.push(qID);
        
        const qData = state.qDataMap[qID];
        if(!qData.src) qData.src = resolveImage(qData.imgRaw);
        return qData;
    }

    // UPDATED RESHUFFLE LOGIC TO USE SYLLABUS
    window.reshuffleGrid = function() {
        // Safety Check
        if(state.qPool.length === 0 && state.qUsed.length === 0) {
            alert("No questions loaded! Please load CSV first.");
            return;
        }

        // Use filtered pool
        let sourcePool = [...state.filteredPool];

        if(sourcePool.length < 1) {
            alert("The selected Syllabus (Scope) has no questions available!");
            return;
        }

        state.grid.map = {}; state.grid.taken = [];
        
        for(let i=1; i<=20; i++) {
            if(sourcePool.length === 0) {
                state.grid.map[i] = null; 
                continue;
            }
            const rIdx = Math.floor(Math.random() * sourcePool.length);
            state.grid.map[i] = sourcePool[rIdx];
            sourcePool.splice(rIdx, 1);
        }
        updateGridPreview(); syncWindows();
    }

    window.toggleGridScreen = function(show) {
        state.grid.visible = show;
        state.session.phase = 'selection';
        syncWindows(); updateGridPreview();
    }

    // --- NAVIGATION SAFEGUARDS & FEATURES ---
    window.prevQuestion = function() {
        if(state.session.phase === 'finished') {
            state.session.phase = 'active';
            state.session.activeIndex = state.session.slots.length - 1;
        } else if (state.session.activeIndex > 0) {
            state.session.activeIndex--;
        } else {
            return; 
        }
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.nextQuestion = function() {
        if(state.session.phase === 'ready') {
            startReadingSession(); return;
        }

        if(state.session.phase === 'finished') return; 

        const nextIdx = state.session.activeIndex + 1;
        
        if(nextIdx >= state.session.slots.length) {
            state.session.phase = 'finished';
        } else {
            state.session.activeIndex = nextIdx;
        }
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.resetStudentSession = function() {
        state.session = { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false };
        state.grid.taken = []; state.grid.visible = false;
        document.getElementById('btnStartReading').classList.add('hidden');
        document.getElementById('selectionInfo').innerText = "No selection yet.";
        
        // Reshuffle based on current scope
        if(state.mode === 'student') reshuffleGrid();
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    function toggleBell(on) {
        const bs = document.getElementById('bellStart');
        const be = document.getElementById('bellEnd');
        if(on) { bs.currentTime=0; bs.play().catch(()=>{}); }
        else { be.currentTime=0; be.play().catch(()=>{}); }
        state.session.light = on;
        updateMirror(); syncWindows();
    }

    // --- UI RENDER ---
    function renderSlots() {
        const limit = parseInt(document.getElementById('qLimit').value);
        const g = document.getElementById('slotGrid');
        g.style.gridTemplateColumns = `repeat(${limit}, 1fr)`;
        g.innerHTML = '';
        
        const source = (state.session.phase === 'selection' || state.session.phase === 'ready') 
                        ? state.session.selectionIDs 
                        : state.session.slots;

        for(let i=0; i<limit; i++) {
            let d = document.createElement('div');
            let content = `Slot ${i+1}`;
            if(source[i]) { content = source[i].id ? `Q: ${source[i].id}` : `Q: ${source[i]}`; }
            d.className = 'slot-box ' + (i === state.session.activeIndex ? 'active' : '');
            d.innerText = content;
            g.appendChild(d);
        }
    }

    function updateStatus() {
        const s = document.getElementById('statusDisplay');
        if(state.session.phase === 'idle') { s.innerText = "WAITING..."; s.style.color="#777"; }
        else if(state.session.phase === 'selection') { s.innerText = "SELECTING..."; s.style.color="#D4AF37"; }
        else if(state.session.phase === 'ready') { s.innerText = "READY"; s.style.color="#00e676"; }
        else if(state.session.phase === 'finished') { s.innerText = "FINISHED"; s.style.color="#ff5252"; }
        else { s.innerText = `Q-${state.session.slots[state.session.activeIndex]?.id || "?"}`; s.style.color = "#00e676"; }
    }

    function updateMirror() {
        const gp = document.getElementById('gridPreview');
        const mCont = document.getElementById('mirrorContainer');
        const mImg = document.getElementById('mImg');
        const mReady = document.getElementById('mReadyText');
        const mFin = document.getElementById('mFinishText');
        const wWarn = document.getElementById('adminWarn');
        const banner = document.getElementById('adminBanner');
        const mMemory = document.getElementById('mMemoryText');
        
        document.getElementById('mirrorLight').style.background = state.session.light ? '#00e676' : '#333';

        if(state.theme) {
            mCont.style.border = `10px ${state.theme.borderType} ${state.theme.accent}`;
            mCont.style.background = '#fff'; 
        }

        if(state.grid.visible) {
            mCont.style.display = 'none'; 
            gp.style.display = 'grid';
            updateGridPreview();
            return;
        } 
        
        gp.style.display = 'none'; 
        mCont.style.display = 'flex';
        
        mImg.style.display = 'none';
        mReady.style.display = 'none'; 
        mFin.style.display = 'none'; 
        wWarn.style.display = 'none';
        banner.style.display = 'none';
        mMemory.style.display = 'none';

        if(state.session.phase === 'ready') {
             mReady.style.display = 'block';
             document.getElementById('mirrorStatus').innerText = "WAITING";
             return;
        }

        if(state.session.phase === 'finished') {
            mFin.style.display = 'block';
            mFin.innerHTML = i18n.msgFinished[currentLang];
            document.getElementById('mirrorStatus').innerText = "FINISHED";
            return;
        }

        const q = state.session.slots[state.session.activeIndex];

        if(q && state.session.phase === 'active') {
            document.getElementById('mBook').innerText = q.book;
            document.getElementById('mSurah').innerText = q.surah;
            document.getElementById('mAyah').innerText = q.start + '-' + q.end;
            banner.style.display = 'flex'; 

            if(state.readingMode === 'memory') {
                wWarn.style.display = 'block';
                mMemory.style.display = 'block'; 
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "0.2"; }
            } else {
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "1"; }
            }
            
            document.getElementById('mirrorStatus').innerText = "LIVE READING";
        } else {
            document.getElementById('mirrorStatus').innerText = "IDLE";
        }
    }

    function updateGridPreview() {
        const gp = document.getElementById('gridPreview');
        gp.innerHTML = '';
        for(let i=1; i<=20; i++) {
            let b = document.createElement('div');
            let isSelected = state.session.selectionIDs.includes(state.grid.map[i]);
            b.className = 'gp-box ' + (state.grid.taken.includes(i) ? 'taken' : '') + (isSelected ? ' selected' : '');
            b.innerText = i;
            b.setAttribute('onclick', `handleGridClick(${i})`); 
            gp.appendChild(b);
        }
    }

    // --- TEMPLATE GENERATOR ---
    function getTemplate(isCeremony = false) {
        const fontFace = state.fontData ? `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }` : '';
        
        // Fonts for Ceremony
        let ceremonyFonts = '';
        if(isCeremony) {
             if(state.ceremony.fonts.quran) ceremonyFonts += `@font-face { font-family: 'QuranFont'; src: url('${state.ceremony.fonts.quran}'); }`;
             if(state.ceremony.fonts.trans) ceremonyFonts += `@font-face { font-family: 'TransFont'; src: url('${state.ceremony.fonts.trans}'); }`;
        }

        const bStyle = document.getElementById('borderStyle').value;
        const th = state.theme || themeList[0]; 

        let borderCSS = `border: 1.5vmin ${th.borderType} ${th.accent}; box-shadow: 0 0 5vmin ${th.accent}80;`;
        if(bStyle === 'custom' && state.borderData) borderCSS = `border: 4vmin solid transparent; border-image: url('${state.borderData}') 30 stretch;`;
        if(bStyle === 'none') borderCSS = "border:none;";

        return `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                ${fontFace}
                ${ceremonyFonts}
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

                body.lang-dv * { font-family: 'AppFont', 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; }
                body.lang-ar * { font-family: 'Amiri', serif !important; }
                body.lang-en * { font-family: sans-serif !important; direction: ltr; }

                :root {
                    --bg-1: ${th.bg1}; --bg-2: ${th.bg2};
                    --accent: ${th.accent}; --border-type: ${th.borderType};
                    --txt-col: ${th.text};
                    --royal-gold: #D4AF37;
                    --royal-green-dark: #002200;
                }
                
                * { box-sizing: border-box; }
                body { 
                    margin:0; padding: 0;
                    width: 100vw; height: 100vh; 
                    overflow:hidden; 
                    color:var(--txt-col); 
                    display:flex; 
                    background: #000;
                }

                #royalFrame {
                    position: fixed; top:0; left:0; width:100%; height:100%;
                    pointer-events: none; z-index: 9999;
                    border: 2.5vmin solid var(--accent);
                    box-shadow: inset 0 0 10vmin rgba(0,0,0,0.9);
                }
                
                /* --- GENERAL UI (STUDENT/JUDGE) --- */
                #signalLight {
                    position: fixed; top: 2vmin; right: 2vmin;
                    width: 6vmin; height: 6vmin;
                    border-radius: 50%;
                    background: #333;
                    border: 0.5vmin solid #fff;
                    box-shadow: 0 0 2vmin rgba(0,0,0,0.5);
                    z-index: 10000;
                    transition: background 0.3s;
                }
                #idleScreen, #gridScreen, #waitScreen, #readScreen, #finishScreen { display:none; width:100%; height:100%; }

                #idleScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #gridScreen { align-items:center; justify-content:center; flex-direction:column; background: radial-gradient(circle, var(--bg-1), #000); }
                #gridContainer { 
                    display:grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(4, 1fr);
                    gap: 1.5vmin; width: 85vw; height: 75vh; 
                }
                .grid-btn { 
                    width: 100%; height: 100%;
                    background: linear-gradient(135deg, var(--accent), var(--bg-1)); 
                    border: 0.3vmin solid #fff; border-radius: 1vmin;
                    color: #fff; text-shadow: 0 2px 2px #000;
                    font-size: 5vmin; font-weight: bold; cursor: pointer; transition: 0.3s; 
                    display:flex; justify-content:center; align-items:center;
                    box-shadow: 0 1vmin 2vmin rgba(0,0,0,0.5);
                }
                .grid-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
                .grid-btn.taken { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

                #readScreen { flex-direction:column; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #topBar { 
                    height: 12vh; width: 100%; 
                    background: linear-gradient(to bottom, var(--bg-1), #000); 
                    border-bottom: 0.5vmin solid var(--accent);
                    display: flex; align-items: center; justify-content: center;
                    box-shadow: 0 1vh 2vh rgba(0,0,0,0.8); z-index: 10;
                }
                #topStatusText { 
                    color: var(--accent); font-size: 4vmin; font-weight: bold; 
                    text-shadow: 0 0.5vmin 1vmin rgba(0,0,0,1);
                }

                #contentArea { display: flex; height: 88vh; width: 100%; padding: 2vmin; box-sizing: border-box; }

                #infoPanel { 
                    width: 20vw; background: rgba(0,0,0,0.5); 
                    border: 0.3vmin solid var(--accent); border-radius: 1vmin;
                    display: flex; flex-direction: column; margin-left: 1vw;
                }
                .mode-display { padding: 2vh; border-bottom: 1px solid var(--accent); text-align: center; }
                .mode-text { color: #00e676; font-size: 2.5vmin; font-weight: bold; text-shadow: 0 2px 2px #000; }
                .selected-list-box { border-bottom: 1px solid var(--accent); padding: 2vh; background: rgba(255, 255, 255, 0.05); text-align: center; }
                .selected-label { color: var(--accent); font-size: 1.8vmin; display: block; margin-bottom: 1vh; text-decoration: underline; }
                .selected-nums { color: #fff; font-size: 3vmin; font-weight: bold; line-height: 1.5; }

                .questions-list { flex: 1; overflow-y: auto; padding: 1vmin; }
                .q-item { 
                    padding: 1.5vmin; margin-bottom: 1vmin; border-radius: 1vmin; 
                    border: 1px solid #444; background: rgba(0,0,0,0.6);
                    transition: 0.3s; font-size: 2vmin;
                }
                .q-item.active { border-color: var(--accent); background: linear-gradient(90deg, var(--bg-1), #000); }

                #mainArea { 
                    flex: 1; display: flex; justify-content: flex-start; align-items: center; 
                    flex-direction: column; overflow-y: auto;
                }
                
                .royal-card {
                    width: 75vw; min-height: 50vh;
                    background: #fff; ${borderCSS}
                    border-radius: 1vmin; overflow-y: auto; overflow-x: hidden;
                    display: block; position: relative;
                    box-shadow: 0 2vmin 5vmin rgba(0,0,0,0.7); flex-shrink: 0;
                }
                .royal-card img { width: 100%; height: auto; display: block; margin: 0; }
                .royal-card.memory-mode { background: transparent; border: none; box-shadow: none; display: flex; justify-content: center; align-items: center; }

                #memoryText { display:none; color: var(--accent); font-size: 5vw; text-shadow: 0 0 2vh var(--accent); text-align:center; }
                
                /* JUDGE ELEMENTS */
                #judgeSection {
                    display: none; width: 75vw; margin-top: 2vmin; margin-bottom: 2vmin;
                    background: #fff; border: 0.5vmin solid var(--accent);
                    border-radius: 1vmin; padding: 2vmin; color: #000;
                }
                .student-bar {
                    background: var(--bg-1); color: #fff;
                    padding: 1.5vmin; border-radius: 0.5vmin; text-align: center;
                    font-size: 3vmin; font-weight: bold; margin-bottom: 2vmin; border: 2px solid var(--accent);
                }
                .rubric-container { display: grid; grid-template-columns: 1fr; gap: 1vmin; }
                .rubric-row {
                    display: flex; justify-content: space-between; align-items: center;
                    background: #f4f4f4; padding: 1vmin; border-radius: 0.5vmin; border-bottom: 1px solid #ccc;
                }
                .rubric-label { font-size: 2vmin; font-weight: bold; width: 40%; }
                .rubric-options { display: flex; gap: 0.5vmin; flex: 1; justify-content: flex-end; }
                .rubric-btn {
                    padding: 1vmin 2vmin; border: none; border-radius: 0.5vmin;
                    font-size: 1.5vmin; cursor: pointer; color: #fff; font-weight: bold;
                    transition: 0.2s; background: #555;
                }
                .btn-excellent { background: linear-gradient(to bottom, #2e7d32, #1b5e20); }
                .btn-good { background: linear-gradient(to bottom, #00acc1, #00838f); }
                .btn-avg { background: linear-gradient(to bottom, #fdd835, #fbc02d); color: #000; }
                .btn-poor { background: linear-gradient(to bottom, #d32f2f, #b71c1c); }
                .rubric-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
                .rubric-btn.selected { border: 0.4vmin solid #000; box-shadow: 0 0 1vmin rgba(0,0,0,0.5); transform: scale(1.1); }
                .score-display { margin-left: 2vmin; width: 8vmin; text-align: center; font-size: 2.5vmin; font-weight: bold; color: var(--bg-1); }
                .total-footer { margin-top: 2vmin; padding-top: 2vmin; border-top: 2px solid #000; text-align: right; font-size: 4vmin; font-weight: 900; color: #d32f2f; }

                #finishScreen, #waitScreen { flex-direction:column; align-items:center; justify-content:center; background: #000; }

                /* --- ROYAL CEREMONY SCREEN CSS (THEMING) --- */
                #ceremonyScreen {
                    display: none; width: 100%; height: 100%;
                    flex-direction: column; align-items: center; justify-content: center;
                    /* Default Background - Overridden by JS */
                    background: radial-gradient(circle at center, #002200, #000);
                    text-align: center; padding: 4vmin;
                    border: 2vmin double #D4AF37;
                    box-sizing: border-box;
                    transition: all 0.5s ease;
                }
                
                /* THEME CLASSES */
                .theme-0 { background: radial-gradient(circle, #002200, #000); border: 2vmin double #D4AF37; } /* Royal Green */
                .theme-1 { background: radial-gradient(circle, #001a33, #000); border: 2vmin double #D4AF37; } /* Royal Blue */
                .theme-2 { background: radial-gradient(circle, #330000, #000); border: 2vmin double #D4AF37; } /* Royal Red */
                .theme-3 { background: radial-gradient(circle, #004d00, #002200); border: 2vmin solid #D4AF37; } /* Emerald */
                .theme-4 { background: radial-gradient(circle, #000066, #000033); border: 2vmin solid #D4AF37; } /* Midnight */
                .theme-5 { background: radial-gradient(circle, #4d0000, #220000); border: 2vmin solid #D4AF37; } /* Burgundy */
                .theme-6 { background: linear-gradient(135deg, #002200, #001a33); border: 2vmin ridge #D4AF37; } /* Mix Green/Blue */
                .theme-7 { background: linear-gradient(135deg, #330000, #000); border: 2vmin ridge #D4AF37; } /* Mix Red/Black */
                .theme-8 { background: radial-gradient(circle, #1a0033, #0d001a); border: 2vmin double #D4AF37; } /* Deep Purple */
                .theme-9 { background: radial-gradient(circle, #fdfcf0, #e0e0e0); border: 2vmin double #D4AF37; } /* White/Gold */
                .theme-10 { background: radial-gradient(circle, #fffdd0, #f5f5dc); border: 2vmin solid #aa8c2c; } /* Cream */
                .theme-11 { background: radial-gradient(circle, #111, #000); border: 2vmin double #D4AF37; } /* Black/Gold */
                .theme-12 { background: linear-gradient(to bottom, #004d00, #000); border: 2vmin double #C0C0C0; } /* Green/Silver */
                .theme-13 { background: linear-gradient(to bottom, #002040, #000); border: 2vmin double #C0C0C0; } /* Blue/Silver */
                .theme-14 { background: linear-gradient(to bottom, #500000, #000); border: 2vmin double #C0C0C0; } /* Red/Silver */
                .theme-15 { background: #004d40; border: 3vmin solid #D4AF37; box-shadow: inset 0 0 5vmin #000; } /* Teal */
                .theme-16 { background: #4a0000; border: 3vmin solid #D4AF37; box-shadow: inset 0 0 5vmin #000; } /* Maroon */
                .theme-17 { background: #000; border: 1.5vmin double #fff; } /* Onyx */
                .theme-18 { background: #f0f0f0; border: 2vmin double #004d00; } /* Pearl/Green */
                .theme-19 { background: linear-gradient(45deg, #002200, #001a33, #330000); border: 2vmin double #D4AF37; } /* Mix All */

                /* Special Overrides for Light Themes to make text visible if needed (Handled via JS Color Picker mostly) */
                .theme-9 .c-basmalah, .theme-9 .c-sadaqallah, .theme-10 .c-basmalah, .theme-10 .c-sadaqallah, .theme-18 .c-basmalah, .theme-18 .c-sadaqallah { color: #000 !important; }

                .ceremony-box {
                    width: 90%; height: 90%;
                    display: flex; flex-direction: column; justify-content: center; align-items: center;
                    position: relative;
                }

                .ceremony-divider {
                    width: 60%; height: 0.5vmin; 
                    background: linear-gradient(90deg, transparent, #D4AF37, transparent);
                    margin: 4vmin auto;
                    box-shadow: 0 0 2vmin #D4AF37;
                }

                .ceremony-quran {
                    font-family: 'QuranFont', 'Amiri', serif !important;
                    /* Color set by JS */
                    line-height: 1.6;
                    text-shadow: 0 4px 10px rgba(0,0,0,0.5);
                    direction: rtl;
                    margin-bottom: 1vmin;
                }
                
                .ceremony-trans {
                    font-family: 'TransFont', 'Faruuma', 'AppFont', sans-serif !important;
                    /* Color set by JS */
                    margin-top: 1vmin;
                    text-shadow: 0 2px 5px rgba(0,0,0,0.8);
                    direction: rtl; 
                    text-align: center;
                }

                .c-cover { font-size: 8vmin; color: #D4AF37; font-family: 'Cinzel', serif !important; text-transform: uppercase; text-shadow: 0 0 20px #000; }
                .c-basmalah { font-size: 10vmin; color: #fff; margin-bottom: 2vmin; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }
                .c-sadaqallah { font-size: 10vmin; color: #D4AF37; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }

                #fsOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; justify-content:center; align-items:center; }
                .fs-btn { border: 2px solid var(--accent); padding: 20px; color: var(--accent); background: #000; cursor: pointer; font-size: 20px; border-radius: 10px; }
            </style>
        </head>
        <body oncontextmenu="return false;" class="lang-dv">
            <div id="fsOverlay" onclick="goFullscreen()"><div class="fs-btn">CLICK TO START (FULLSCREEN)</div></div>
            
            ${bStyle === 'royal' ? '<div id="royalFrame"></div>' : ''}

            <div id="signalLight"></div>
            <div id="idleScreen"><h1 style="font-size:8vw; color:var(--accent); text-shadow:0 0 3vh var(--accent);">RASFAHI</h1></div>
            <div id="gridScreen"><h1 id="gridTitle" style="color:var(--accent); font-size: 5vh;">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß</h1><div id="gridContainer"></div></div>
            <div id="waitScreen"><h1 id="waitHead" style="color:var(--accent); font-size: 5vh;">SELECTION COMPLETE</h1><h2 id="waitSub" style="color:#fff; font-size: 3vh;">Waiting for Judge...</h2><div id="waitList" style="color:var(--accent); font-size:3vh; margin-top:20px;"></div></div>
            <div id="finishScreen"><h1 id="finText" style="color:var(--accent); text-shadow:0 0 3vh var(--accent); text-align:center; font-size: 6vw;"></h1></div>
            <div id="readScreen">
                <div id="topBar"><div id="topStatusText"></div></div>
                <div id="contentArea">
                    <div id="infoPanel">
                        <div class="mode-display"><span class="mode-text" id="displayMode"></span></div>
                        <div class="selected-list-box"><span class="selected-label" data-key="lblSelected">ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:</span><span class="selected-nums" id="displaySelected"></span></div>
                        <div class="questions-list" id="qListContainer"></div>
                    </div>
                    <div id="mainArea">
                        <div class="royal-card" id="mainScroll"><img id="qImg" src=""><h1 id="memoryText"></h1></div>
                        <div id="judgeSection">
                            <div class="student-bar">Student: <span id="jStudentName">---</span></div>
                            <div class="rubric-container" id="rubricContainer"></div>
                            <div class="total-footer">Total: <span id="jTotalScore">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ceremonyScreen" class="theme-0">
                <div class="ceremony-box">
                    <div id="cHeader"></div>
                    <div id="cBody" style="width:100%;"></div>
                    <div id="cFooter"></div>
                </div>
            </div>

            <script>
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                const childI18n = {
                    gridTitle: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß", ar: "ÿßÿÆÿ™ÿ± ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ§ÿßŸÑ", en: "Pick Question Number" },
                    waitHead: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨", ar: "ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±", en: "Selection Complete" },
                    waitSub: { dv: "ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß", ar: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÇÿßÿ∂Ÿä", en: "Waiting for Judge..." },
                    memText: { dv: "(ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞)", ar: "(ÿ™ŸÑÿßŸàÿ© ÿπŸÜ ÿ∏Ÿáÿ± ŸÇŸÑÿ®)", en: "(Memory Recitation Mode)" },
                    rmMushaf: { dv: "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÖŸÜ ÿßŸÑŸÖÿµÿ≠ŸÅ", en: "Reading from Mushaf" },
                    rmMemory: { dv: "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑÿ≠ŸÅÿ∏", en: "Reciting from Memory" },
                    lblSelected: { dv: "ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:", ar: "ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©:", en: "Selected Questions:" },
                    qPrefix: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ≥ÿ§ÿßŸÑ", en: "Q" },
                    statFirst: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ŸàŸÑ", en: "Reading First Question" },
                    statLast: { dv: "ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁäﬁ¶ﬁÄﬁ™ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "Ÿáÿ∞ÿß ŸáŸà ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ÿÆŸäÿ±", en: "This is the Last Question" },
                    statMid: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© %N ﬁàﬁ¶ﬁÇﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ±ŸÇŸÖ %N", en: "Reading Question #%N" },
                    msgFinished: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", en: "Questioning complete for the current limit!" }
                };

                let currentScores = {}; 
                const isCeremonyWindow = ${isCeremony};

                function goFullscreen() {
                    document.documentElement.requestFullscreen();
                    document.getElementById('fsOverlay').style.display = 'none';
                }

                window.updateRubricScore = function(rowIdx, score, btn) {
                    currentScores[rowIdx] = score;
                    const row = btn.parentElement;
                    const allBtns = row.querySelectorAll('.rubric-btn');
                    allBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('score_' + rowIdx).innerText = score;
                    let total = 0;
                    for (let key in currentScores) { total += currentScores[key]; }
                    document.getElementById('jTotalScore').innerText = total;
                }

                window.updateState = function(d) {
                    if(isCeremonyWindow) {
                        updateCeremony(d);
                        return;
                    }

                    // NORMAL MODE LOGIC
                    const lang = d.currentLang || 'dv';
                    document.body.className = 'lang-' + lang;
                    document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
                    document.documentElement.lang = lang;

                    document.getElementById('signalLight').style.background = d.light ? '#00e676' : '#330000';
                    document.getElementById('signalLight').style.boxShadow = d.light ? '0 0 5vmin #00e676' : 'none';
                    
                    document.getElementById('gridTitle').innerText = childI18n.gridTitle[lang];
                    document.getElementById('waitHead').innerText = childI18n.waitHead[lang];
                    document.getElementById('waitSub').innerText = childI18n.waitSub[lang];
                    document.getElementById('finText').innerHTML = childI18n.msgFinished[lang].replace(/\\n/g, '<br>');
                    document.getElementById('memoryText').innerText = childI18n.memText[lang];
                    document.querySelectorAll('[data-key]').forEach(el => {
                        const k = el.getAttribute('data-key');
                        if(childI18n[k]) el.innerText = childI18n[k][lang];
                    });

                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    
                    const card = document.getElementById('mainScroll');
                    const jSec = document.getElementById('judgeSection');
                    const isJudge = window.name.includes('Judge');
                    
                    if(isJudge) {
                        jSec.style.display = 'block';
                        document.getElementById('jStudentName').innerText = d.judging.currentStudent || "Not Selected";
                        const rCont = document.getElementById('rubricContainer');
                        if(rCont.innerHTML === '' && d.judging.rubric) {
                            d.judging.rubric.forEach((item, idx) => {
                                let row = document.createElement('div');
                                row.className = 'rubric-row';
                                const s1 = item.max;
                                const s2 = item.max * 0.75;
                                const s3 = item.max * 0.5;
                                const s4 = item.max * 0.25;
                                row.innerHTML = \`<div class="rubric-label">\${item.name} <br><small style='color:#777'>(Max: \${item.max})</small></div>
                                    <div class="rubric-options">
                                        <button class="rubric-btn btn-excellent" onclick="updateRubricScore(\${idx}, \${s1}, this)">Very Good</button>
                                        <button class="rubric-btn btn-good" onclick="updateRubricScore(\${idx}, \${s2}, this)">Good</button>
                                        <button class="rubric-btn btn-avg" onclick="updateRubricScore(\${idx}, \${s3}, this)">Average</button>
                                        <button class="rubric-btn btn-poor" onclick="updateRubricScore(\${idx}, \${s4}, this)">Poor</button>
                                    </div>
                                    <div class="score-display" id="score_\${idx}">0</div>\`;
                                rCont.appendChild(row);
                            });
                        }
                    } else { jSec.style.display = 'none'; }

                    if(d.grid.visible) {
                        document.getElementById('gridScreen').style.display = 'flex';
                        const gc = document.getElementById('gridContainer');
                        gc.innerHTML = '';
                        for(let i=1; i<=20; i++) {
                            let b = document.createElement('div');
                            let bClass = 'grid-btn';
                            if(d.grid.taken.includes(i)) bClass += ' taken';
                            b.className = bClass;
                            b.innerText = i;
                            b.setAttribute('onclick', 'if(window.opener) window.opener.handleGridClick('+i+')');
                            gc.appendChild(b);
                        }
                    } else if(d.phase === 'ready') {
                         document.getElementById('waitScreen').style.display = 'flex';
                         document.getElementById('waitList').innerText = (lang==='en'?"Q: ":"ﬁêﬁ™ﬁàﬁßﬁçﬁ™: ") + d.slots.map(s => s.id).join(', ');
                    } else if(d.phase === 'finished') {
                         document.getElementById('finishScreen').style.display = 'flex';
                    } else if(d.phase === 'active') {
                        document.getElementById('readScreen').style.display = 'flex';
                        const q = d.slots[d.activeIndex];
                        const statusTxt = document.getElementById('topStatusText');
                        const currentNum = d.activeIndex + 1;
                        if(currentNum === 1) statusTxt.innerText = childI18n.statFirst[lang];
                        else if(d.activeIndex === d.slots.length - 1 && d.slots.length > 1) statusTxt.innerText = childI18n.statLast[lang];
                        else statusTxt.innerText = childI18n.statMid[lang].replace('%N', currentNum);

                        document.getElementById('displaySelected').innerText = d.slots.map(s => s.id).join(', ');
                        document.getElementById('displayMode').innerText = (d.readingMode === 'memory') ? childI18n.rmMemory[lang] : childI18n.rmMushaf[lang];

                        if(q) {
                            const img = document.getElementById('qImg');
                            const memTxt = document.getElementById('memoryText');
                            if(d.readingMode === 'memory') {
                                card.classList.add('memory-mode');
                                img.style.display = 'none';
                                memTxt.style.display = 'block';
                            } else {
                                card.classList.remove('memory-mode');
                                memTxt.style.display = 'none';
                                if(q.src) { img.src = q.src; img.style.display = 'block'; }
                            }
                        }

                        const listC = document.getElementById('qListContainer');
                        listC.innerHTML = '';
                        d.slots.forEach((slot, idx) => {
                            if(!slot) return; 
                            let item = document.createElement('div');
                            item.className = 'q-item ' + (idx === d.activeIndex ? 'active' : '');
                            item.innerHTML = \`<div style="color:#00e676;">\${childI18n.qPrefix[lang]} \${idx+1}</div>
                                <div style="color:#fff; font-weight:bold; font-size:1.1em;">\${slot.surah}</div>
                                <div style="margin-top:4px; font-size:0.8em; color:#ccc;"><span style="border:1px solid #555; padding:2px 6px; border-radius:4px; background:rgba(0,0,0,0.3);">Ayah: \${slot.start} - \${slot.end}</span></div>\`;
                            listC.appendChild(item);
                        });
                    } else {
                        document.getElementById('idleScreen').style.display = 'flex';
                    }
                }

                function updateCeremony(d) {
                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    document.getElementById('signalLight').style.display = 'none'; // Hide light for ceremony
                    
                    const screen = document.getElementById('ceremonyScreen');
                    screen.style.display = 'flex';
                    
                    // APPLY THEME
                    screen.className = 'theme-' + (d.ceremony.settings.themeIndex || 0);

                    const cHead = document.getElementById('cHeader');
                    const cBody = document.getElementById('cBody');
                    const cFoot = document.getElementById('cFooter');
                    cHead.innerHTML = ''; cBody.innerHTML = ''; cFoot.innerHTML = '';

                    const data = d.ceremony;
                    const sets = d.ceremony.settings;
                    
                    if(data.phase === 'cover') {
                        cBody.innerHTML = \`<div class="c-cover">\${d.ceremonyTitle || "Quran Ceremony"}</div>\`;
                    } else if (data.phase === 'start') {
                         cBody.innerHTML = '<div class="c-basmalah">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>';
                    } else if (data.phase === 'end') {
                         cBody.innerHTML = '<div class="c-sadaqallah">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè Ÿ±ŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸè</div>';
                    } else if (data.phase === 'reciting') {
                        cHead.style.display = 'none'; 
                        
                        const ayah = data.activeData[data.currentIndex];
                        
                        // Select translation based on dropdown
                        let transText = "";
                        if(data.selectedLang === 'en') {
                             transText = ayah.en || ayah.dv || ""; 
                        } else {
                             transText = ayah.dv || ayah.en || "";
                        }

                        if(ayah) {
                            cBody.innerHTML = \`<div class="ceremony-quran" style="color:\${sets.arabicColor}; font-size:\${sets.arabicSize}vmin;">\${ayah.arabic}</div>
                                                <div class="ceremony-divider"></div>
                                                <div class="ceremony-trans" style="color:\${sets.transColor}; font-size:\${sets.transSize}vmin;">\${transText}</div>\`;
                        }
                    }
                }
            <\/script>
        </body>
        </html>`;
    }

    function initJudgingUI() {
        const sel = document.getElementById('studentSelect');
        sel.innerHTML = '<option value="">-- Select Student --</option>';
        state.judging.students.forEach(s => {
            let opt = document.createElement('option');
            opt.value = s; opt.innerText = s;
            sel.appendChild(opt);
        });
    }

    function addStudentPrompt() {
        const name = prompt("Enter Student Name:");
        if(name) {
            state.judging.students.push(name);
            initJudgingUI();
        }
    }

    function updateJudgeScreen() {
        state.judging.currentStudent = document.getElementById('studentSelect').value;
        syncWindows();
    }

    window.addEventListener('load', initJudgingUI);

    function openScreen(type) {
        const html = getTemplate();
        if(type === 'student') {
            if(state.windows.student) state.windows.student.close();
            state.windows.student = window.open("", "Student", "width=1280,height=720");
            if(state.windows.student) {
                state.windows.student.document.open();
                state.windows.student.document.write(html);
                state.windows.student.document.close(); 
            } else {
                alert("Please Allow Popups for this site!");
            }
        }
    }

    function openCeremonyScreen() {
        const html = getTemplate(true);
        if(state.windows.ceremony) state.windows.ceremony.close();
        state.windows.ceremony = window.open("", "Ceremony", "width=1280,height=720");
        if(state.windows.ceremony) {
            state.windows.ceremony.document.open();
            state.windows.ceremony.document.write(html);
            state.windows.ceremony.document.close();
            setTimeout(syncWindows, 500);
        } else {
             alert("Please Allow Popups for this site!");
        }
    }

    function openJudges() {
        const count = parseInt(document.getElementById('judgeCount').value);
        state.windows.judges.forEach(w => w.close());
        state.windows.judges = [];
        for(let i=0; i<count; i++) {
            let w = window.open("", `Judge_${i+1}`, "width=800,height=600");
            if(w) {
                w.document.open();
                w.document.write(getTemplate());
                w.document.close();
                state.windows.judges.push(w);
            }
        }
        setTimeout(syncWindows, 500);
    }

    function syncWindows() {
        const packet = {
            slots: state.session.slots, activeIndex: state.session.activeIndex,
            phase: state.session.phase, light: state.session.light,
            grid: state.grid, readingMode: state.readingMode,
            currentLang: currentLang, fontData: state.fontData,
            judging: state.judging,
            
            // New Ceremony Data
            ceremony: state.ceremony,
            ceremonyTitle: document.getElementById('ceremonyTitle') ? document.getElementById('ceremonyTitle').value : "Ceremony"
        };
        const send = w => { if(w && !w.closed && w.updateState) w.updateState(packet); };
        send(state.windows.student);
        send(state.windows.ceremony);
        state.windows.judges.forEach(w => send(w));
    }
    
    // INITIALIZATION
    initThemes();
    if(themeList.length > 0) state.theme = themeList[0];
    setMode('judge');
    renderSlots();

    document.addEventListener('contextmenu', function(event) { event.preventDefault(); });
</script>
</body>
</html>
