<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Royal Event Master (V39 - Expanded Full Version)</title>
    <style>
        /* =========================================
           1. GLOBAL STYLES & SECURITY
           ========================================= */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
            background: #001a12;
            font-family: 'Faruuma', 'Times New Roman', serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        @font-face {
            font-family: 'Faruuma';
            src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
        }

        /* =========================================
           2. LOGIN SCREEN
           ========================================= */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #00281c;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #d4af37;
        }

        #loginBox {
            background: rgba(0, 0, 0, 0.6);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #d4af37;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        #passInput {
            padding: 10px;
            font-size: 20px;
            border-radius: 5px;
            border: 1px solid #d4af37;
            text-align: center;
            width: 250px;
            margin-top: 15px;
            font-family: sans-serif;
            letter-spacing: 3px;
        }

        #loginBtn {
            margin-top: 15px;
            padding: 10px 30px;
            font-size: 18px;
            cursor: pointer;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            color: #00281c;
            font-family: 'Faruuma';
        }

        #loginBtn:hover {
            background: #ffd700;
        }

        /* =========================================
           3. MAIN LAYOUT
           ========================================= */
        .main-layout {
            display: none;
            gap: 5px;
            height: 100vh;
            width: 100vw;
            padding: 5px;
            box-sizing: border-box;
            background: #00281c;
        }

        .sidebar {
            flex: 0 0 260px;
            background: #f1f8e9;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            border-right: 3px solid #d4af37;
        }

        .editor {
            flex: 1;
            background: #ffffff;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            position: relative;
            border-left: 3px solid #d4af37;
            border-right: 3px solid #d4af37;
        }

        .extra-panel {
            flex: 0 0 290px;
            background: #e0f2f1;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            border-left: 3px solid #d4af37;
        }

        /* =========================================
           4. UI COMPONENTS
           ========================================= */
        h3 {
            margin: 5px 0 10px 0;
            color: #004d40;
            font-family: 'Faruuma';
            font-size: 16px;
            border-bottom: 1px solid #aaa;
            padding-bottom: 5px;
        }

        label {
            display: block;
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
            color: #333;
        }

        input[type="text"], textarea, select {
            width: 98%;
            padding: 5px;
            border: 1px solid #aaa;
            border-radius: 3px;
            font-size: 12px;
            margin-bottom: 5px;
            font-family: 'Faruuma', 'Times New Roman';
        }

        input[type="file"] {
            width: 100%;
            font-size: 10px;
        }

        /* Custom Buttons */
        .btn-vid {
            font-size: 11px;
            padding: 6px;
            margin-top: 2px;
            border: none;
            border-radius: 3px;
            color: white;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            font-family: sans-serif;
        }

        .controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        button.action {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-family: 'Faruuma';
        }

        .btn-live { background: #004d40; flex: 2; border: 2px solid #ffd700; color: #ffd700; }
        .btn-live:hover { background: #00695c; box-shadow: 0 0 10px #ffd700; }
        .btn-nav { background: #455a64; }
        .btn-clear { background: #b71c1c; flex: 0.5; }

        .file-box {
            background: #eee;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }

        /* Target Selectors */
        .target-bar {
            display: flex;
            gap: 2px;
            margin-bottom: 10px;
            background: #b0bec5;
            padding: 3px;
            border-radius: 3px;
        }

        .t-btn {
            flex: 1;
            border: none;
            padding: 8px;
            font-size: 11px;
            cursor: pointer;
            background: #eceff1;
            font-weight: bold;
        }

        .t-btn.active {
            background: #006064;
            color: white;
        }

        /* Preview Area */
        .preview-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            background: #fff8e1;
            padding: 10px;
            border: 1px solid #ffb300;
            border-radius: 5px;
            margin-top: 10px;
        }

        #previewImg {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #d4af37;
        }

        #logoPreview {
            height: 40px;
            object-fit: contain;
        }

        /* Design Panel */
        .design-panel {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: none; /* Hidden by default */
        }

        .design-panel.active { display: block; }
        .design-panel.locked { pointer-events: none; opacity: 0.6; filter: grayscale(1); }

        .d-grp {
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .d-label {
            font-size: 10px;
            font-weight: bold;
            color: #e65100;
            display: block;
        }

        input[type=range] {
            height: 10px;
            width: 100%;
            cursor: pointer;
        }

        input[type=color] {
            height: 20px;
            width: 30px;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .row { display: flex; gap: 5px; }
        .col { flex: 1; }

        /* Video & Pres Panels */
        .video-panel {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #90caf9;
            margin-top: auto;
        }

        .pres-panel {
            background: #fbe9e7;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ffab91;
            margin-bottom: 10px;
        }

        .pres-active {
            border: 3px solid red;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 5px red; }
            50% { box-shadow: 0 0 20px red; }
            100% { box-shadow: 0 0 5px red; }
        }

        .screen-launcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }

        .launch-btn {
            background: #37474f;
            color: white;
            padding: 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            width: 100%;
            cursor: pointer;
        }

        .cfg-btn {
            background: #0277bd;
            color: white;
            padding: 5px;
            width: 48%;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            margin-top: 5px;
            cursor: pointer;
        }

        #statusMsg {
            text-align: center;
            margin-top: auto;
            font-weight: bold;
            color: green;
            font-size: 12px;
            background: #e8f5e9;
            padding: 5px;
            border-radius: 4px;
        }
        
        .copyright-text {
            text-align: center; font-size: 10px; color: #d4af37; background: #00281c; margin-top: 5px; padding: 5px; border-radius: 4px; font-weight: bold;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loginOverlay">
        <div id="loginBox">
            <h1 style="color:#d4af37; font-family:'Faruuma'; font-size:2em;">Royal Event Master V39</h1>
            <p id="expiryMsg" style="font-size:12px; color:#aaa;"></p>
            <input type="password" id="passInput" placeholder="License Key">
            <br>
            <button id="loginBtn" onclick="checkPassword()">Verify & Login</button>
            <p id="loginError" style="color: #ff5252; display: none; margin-top: 10px;">Invalid License Key!</p>
        </div>
    </div>

    <div class="main-layout" id="mainApp">
        
        <div class="sidebar">
            <div class="screen-launcher">
                <button class="launch-btn" style="background:#c62828; grid-column: span 2;" onclick="openTV(1)">üñ•Ô∏è 1. MAIN (Stage)</button>
                <button class="launch-btn" onclick="openTV(2)">üñ•Ô∏è 2. Left Banner</button>
                <button class="launch-btn" onclick="openTV(3)">üñ•Ô∏è 3. Right Banner</button>
                <button class="launch-btn" onclick="openTV(4)">üñ•Ô∏è 4. Presentation</button>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                <button class="cfg-btn" onclick="exportConfig()">üíæ Save Config</button>
                <button class="cfg-btn" style="background:#00695c;" onclick="document.getElementById('confLoad').click()">üìÇ Load Config</button>
                <input type="file" id="confLoad" accept=".json" style="display:none" onchange="importConfig(this)">
            </div>

            <div class="target-bar">
                <button class="t-btn active" onclick="setTarget(1)" id="tb1">S1</button>
                <button class="t-btn" onclick="setTarget(2)" id="tb2">S2</button>
                <button class="t-btn" onclick="setTarget(3)" id="tb3">S3</button>
                <button class="t-btn" onclick="setTarget(4)" id="tb4">S4</button>
            </div>

            <div class="file-box">
                <label id="fileLabel" style="color:blue;">Files for: Screen 1</label>
                <label>1. Content CSV:</label><input type="file" id="targetCsv" accept=".csv" onchange="loadTargetCsv(this)">
                <label>2. Background:</label><input type="file" id="targetBg" accept="video/*, image/*" onchange="updateTargetBg(this)">
                
                <div id="mainFilesOnly">
                    <label>3. Photos (S1 Only):</label><input type="file" id="photoFolder" webkitdirectory directory multiple onchange="loadPhotos(this)">
                    <label>4. Logo (S1 Only):</label><input type="file" id="logoFile" accept="image/*" onchange="loadLogo(this)">
                    <label>5. Font (Global):</label><input type="file" id="fontFile" accept=".ttf, .otf" onchange="loadFont(this)">
                    <label style="color:#e65100;">6. Custom Frame (S1):</label><input type="file" id="customBorderFile" accept="image/*" onchange="loadCustomFrame(this)">
                </div>
            </div>

            <label>Select Item:</label>
            <input type="text" id="search" placeholder="Search Name..." onkeyup="filterList()">
            <select id="stuList" size="5" style="flex-grow:1;" onchange="loadContentToEditor()"></select>
            
            <button onclick="toggleDesignPanel()" class="btn-vid" style="background:#555;">üé® Design Panel (Toggle)</button>
            
            <div class="copyright-text">&copy; Ali Ibrahim Didi (7791550)</div>
        </div>

        <div class="editor">
            <div style="background:#e8f5e9; padding:5px; border-radius:4px; margin-bottom:5px;">
                <h3>‚úèÔ∏è Edit Content (<span id="editLabel">Screen 1</span>)</h3>
                <input type="text" id="line1" placeholder="Line 1 / Main Title" class="font-dv" style="font-weight:bold;">
                <input type="text" id="line2" placeholder="Line 2 / Sub Title" class="font-dv">
                <input type="text" id="line3" placeholder="Line 3 / Detail 1" class="font-dv">
                <input type="text" id="line4" placeholder="Line 4 / Detail 2" class="font-dv">
                <button class="btn-vid" style="background:#2e7d32;" onclick="sendContent()">‚ö° Send to Selected Screen</button>
            </div>

            <div id="mainPreview" class="preview-container">
                <div style="width:40px;"><img id="logoPreview" alt="Logo" style="width:100%;"></div>
                <div><img id="previewImg" src="https://via.placeholder.com/150"></div>
            </div>

            <div class="controls">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ Prev</button>
                <button class="action btn-live" onclick="sendContent()">üì∫ LIVE</button>
                <button class="action btn-nav" onclick="move(1)">Next ‚ñ∂</button>
                <button class="action btn-clear" onclick="clearTarget()">Clear</button>
            </div>
            
            <div style="margin-top:5px; display:flex; justify-content:flex-end;">
                <div style="font-size:10px; font-weight:bold; color:#c62828;"><input type="checkbox" id="lockCheck" onchange="toggleLock(this)"> Lock Controls</div>
            </div>

            <div id="designPanel" class="design-panel">
                <label style="color:#e65100;">üé® Design for: <span id="designTargetLabel">Screen 1</span></label>
                
                <div id="mainDesignCtrls">
                    <div class="d-grp">
                        <span class="d-label">Frame & Theme:</span>
                        <div class="row">
                            <select id="in_cBorder" onchange="liveUpdate('cBorder', this.value)" style="width:100%;">
                                <optgroup label="Basic">
                                    <option value="b0">üö´ No Border</option>
                                    <option value="custom">üñºÔ∏è Custom Frame</option>
                                </optgroup>
                                <optgroup label="Royal Collection">
                                    <option value="frame-1">1. Gold Double</option>
                                    <option value="frame-2">2. Dashed Glow</option>
                                    <option value="frame-3">3. Thick Solid</option>
                                    <option value="frame-4">4. Gradient Fade</option>
                                    <option value="frame-5">5. Offset Line</option>
                                    <option value="frame-6">6. Ornamental</option>
                                    <option value="frame-7">7. Minimalist</option>
                                    <option value="frame-8">8. Triple Layer</option>
                                    <option value="frame-9">9. Silver Edge</option>
                                    <option value="frame-10">10. Ancient Scroll</option>
                                    <option value="frame-11">11. Modern Box</option>
                                    <option value="frame-12">12. Corner Decos</option>
                                    <option value="frame-13">13. Soft Shadow</option>
                                    <option value="frame-14">14. Neon Gold</option>
                                    <option value="frame-15">15. Dark Wood</option>
                                    <option value="frame-16">16. Marble</option>
                                    <option value="frame-17">17. Silk Ribbon</option>
                                    <option value="frame-18">18. Dotted Royal</option>
                                    <option value="frame-19">19. Inset Glow</option>
                                    <option value="frame-20">20. Heavy Metal</option>
                                </optgroup>
                            </select>
                            <select id="in_mainTheme" onchange="liveUpdate('mainTheme', this.value)" style="width:100%;">
                                <option value="theme-1">Green</option><option value="theme-2">Blue</option>
                                <option value="theme-3">Maroon</option><option value="theme-4">Black</option>
                                <option value="theme-5">Purple</option><option value="theme-6">Teal</option>
                                <option value="theme-7">Red</option><option value="theme-8">Gold</option>
                                <option value="theme-9">Silver</option><option value="theme-10">Choco</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grp">
                        <span class="d-label">Photo (Vis/Pos/Size):</span>
                        <div class="row">
                            <select id="in_pVis" onchange="liveUpdate('pVis', this.value)" style="width:33%; background:#ffe0b2;">
                                <option value="show">Show</option><option value="hide">Hide</option>
                            </select>
                            <select id="in_pShape" onchange="liveUpdate('pShape', this.value)" style="width:33%;">
                                <option value="50%">Cir</option><option value="10px">Sqr</option>
                            </select>
                            <select id="in_pBorder" onchange="liveUpdate('pBorder', this.value)" style="width:33%;">
                                <option value="on">Border</option><option value="off">None</option>
                            </select>
                        </div>
                        <div class="row">
                            <input id="in_pX" type="range" min="-1000" max="1000" oninput="liveUpdate('pX', this.value)">
                            <input id="in_pY" type="range" min="-600" max="600" oninput="liveUpdate('pY', this.value)">
                        </div>
                        <input id="in_pSize" type="range" min="100" max="600" oninput="liveUpdate('pSize', this.value)">
                    </div>
                    <div class="d-grp">
                        <span class="d-label">Logo (Pos/Vis):</span>
                        <div class="row">
                            <select id="in_lVis" onchange="liveUpdate('lVis', this.value)" style="width:100%; background:#ffe0b2;">
                                <option value="show">Show Logo</option><option value="hide">Hide Logo</option>
                            </select>
                        </div>
                        <div class="row">
                            <input id="in_logoX" type="range" min="-500" max="500" oninput="liveUpdate('logoX', this.value)">
                            <input id="in_logoY" type="range" min="0" max="500" oninput="liveUpdate('logoY', this.value)">
                        </div>
                    </div>
                </div>

                <div class="d-grp">
                    <span class="d-label">Text Layout & Style:</span>
                    <div class="row">
                        <select id="in_layoutDir" onchange="liveUpdate('layoutDir', this.value)" style="width:50%;">
                            <option value="rtl">Photo Right</option><option value="ltr">Photo Left</option>
                        </select>
                        <select id="in_textAlign" onchange="liveUpdate('textAlign', this.value)" style="width:50%;">
                            <option value="right">Align Right</option><option value="left">Align Left</option><option value="center">Center</option>
                        </select>
                    </div>
                    <div class="row">
                        <input id="in_txtX" type="range" min="-500" max="500" oninput="liveUpdate('txtX', this.value)">
                        <input id="in_txtY" type="range" min="-300" max="300" oninput="liveUpdate('txtY', this.value)">
                    </div>
                    <div class="row" style="margin-top:2px;">
                        <input id="in_mtSize" type="range" min="1" max="10" step="0.1" oninput="liveUpdate('mtSize', this.value)">
                        <input id="in_mtColor" type="color" oninput="liveUpdate('mtColor', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <div class="extra-panel">
            <div class="video-panel">
                <h3>üé• Main Screen Video</h3>
                <input type="file" id="videoLocal" accept="video/*">
                <button class="btn-vid" style="background:#e65100;" onclick="playLocalVideo()">‚ñ∂ Play Local Video</button>
                <hr>
                <input type="text" id="ytLink" placeholder="YouTube Link..." class="font-en">
                <button class="btn-vid" style="background:#c62828;" onclick="playYoutube()">‚ñ∂ Play YouTube</button>
                <button class="btn-vid" style="background:#333; margin-top:5px;" onclick="stopVideo()">‚èπ STOP VIDEO</button>
            </div>

            <div class="pres-panel" id="presPanel">
                <h3>üìä Presentation Hub</h3>
                <input type="text" id="presUrl" class="font-en" placeholder="Embed URL..." onchange="loadPres()">
                <div class="row">
                    <button class="btn-vid" style="background:#bf360c;" onclick="loadPres()">Load on S4</button>
                    <button class="btn-vid" style="background:#3e2723;" onclick="clearPres()">Clear</button>
                </div>
                <hr>
                <label style="color:red; font-weight:bold;">üî¥ MAIN SCREEN CAST:</label>
                <button id="castBtn" class="btn-vid" style="background:#b71c1c; padding:10px;" onclick="toggleCast()">CAST PRES TO MAIN</button>
            </div>

            <div id="statusMsg">Ready</div>
        </div>
    </div>

<script>
    // --- SECURITY & CONFIG ---
    const LICENSE_KEY = "7791550";
    const EXPIRY_DATE = "2025-12-31"; 
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; }

    // --- STATE ---
    let activeTarget = 1;
    let tvWindows = {};
    let screenData = { 1: [], 2: [], 3: [], 4: [] }; 
    let bgData = { 1: {d:null, t:'none'}, 2: {d:null, t:'none'}, 3: {d:null, t:'none'}, 4: {d:null, t:'none'} };
    let photoFiles = {};
    let logoData = null;
    let customBorderData = null;
    let currentFontData = null;
    let isCasting = false;

    // Design State per Screen (Default Values)
    let settings = {
        1: { cBorder:'frame-1', mainTheme:'theme-1', pX:-40, pY:0, pSize:260, pVis:'show', pShape:'50%', pBorder:'on', lVis:'show', logoX:0, logoY:40, mtX:0, mtY:210, mtSize:5.6, mtColor:'#d4af37', txtX:0, txtY:0, layoutDir:'rtl', textAlign:'right' },
        2: { mainTheme:'theme-1', mtX:0, mtY:0, mtSize:4.0, mtColor:'#d4af37', txtX:0, txtY:0, textAlign:'center' },
        3: { mainTheme:'theme-1', mtX:0, mtY:0, mtSize:4.0, mtColor:'#d4af37', txtX:0, txtY:0, textAlign:'center' },
        4: { mainTheme:'theme-1', mtX:0, mtY:0, mtSize:4.0, mtColor:'#d4af37', txtX:0, txtY:0, textAlign:'center' }
    };

    function checkPassword() {
        const pass = document.getElementById('passInput').value.trim();
        const today = new Date();
        const expiry = new Date(EXPIRY_DATE);
        expiry.setHours(23, 59, 59);
        document.getElementById('expiryMsg').innerText = "Valid until: " + EXPIRY_DATE;

        if (today > expiry) { alert("License Expired!"); return; }
        if (pass === LICENSE_KEY) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            try { loadSettings(); } catch(e){}
        } else { document.getElementById('loginError').style.display = 'block'; }
    }

    // --- TARGET SYSTEM ---
    function setTarget(id) {
        activeTarget = id;
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tb'+id).classList.add('active');
        document.getElementById('fileLabel').innerText = "Files for: Screen " + id;
        document.getElementById('editLabel').innerText = "Screen " + id;
        document.getElementById('designTargetLabel').innerText = "Screen " + id;
        
        // Show/Hide Specific Inputs
        document.getElementById('mainFilesOnly').style.display = (id === 1) ? 'block' : 'none';
        document.getElementById('mainDesignCtrls').style.display = (id === 1) ? 'block' : 'none';
        
        // Show/Hide Main Preview
        document.getElementById('mainPreview').style.display = (id === 1) ? 'flex' : 'none';

        refreshList(); updateDesignInputs();
    }

    function refreshList() {
        const sel = document.getElementById('stuList'); sel.innerHTML = '';
        const data = screenData[activeTarget];
        if (data && data.length > 0) {
            data.forEach((item, i) => {
                let txt = (activeTarget === 1) ? item.nD : item.l1;
                let opt = document.createElement('option'); opt.value = i; opt.text = (i+1) + ". " + txt; sel.add(opt);
            });
        }
    }
    
    function updateDesignInputs() {
        const s = settings[activeTarget];
        for(const [k,v] of Object.entries(s)) {
            const el = document.getElementById('in_'+k);
            if(el) el.value = v;
        }
    }

    // --- FILE LOADERS ---
    function loadTargetCsv(input) {
        const r = new FileReader();
        r.onload = e => {
            const lines = e.target.result.split('\n');
            let newData = [];
            lines.forEach(l => {
                const c = l.split(',');
                if(c[0]) {
                    if(activeTarget === 1) newData.push({nD:c[0], nE:c[1], cD:c[2], cE:c[3], fD:c[4], fE:c[5]});
                    else newData.push({l1:c[0], l2:c[1]||'', l3:c[2]||'', l4:c[3]||''});
                }
            });
            screenData[activeTarget] = newData;
            refreshList();
            alert("Loaded " + newData.length + " items to Screen " + activeTarget);
        };
        r.readAsText(input.files[0]);
    }

    function updateTargetBg(input) {
        const file = input.files[0];
        const r = new FileReader();
        r.onload = e => {
            bgData[activeTarget] = { d: e.target.result, t: file.type.startsWith('video') ? 'video' : 'image' };
            if(tvWindows[activeTarget] && !tvWindows[activeTarget].closed) applyBg(activeTarget);
        };
        r.readAsDataURL(file);
    }

    function loadPhotos(input) {
        for(let f of input.files) { photoFiles[f.name.toLowerCase().split('.')[0]] = f; }
        alert("Photos Loaded for Main Screen");
    }
    function loadLogo(input) { const r = new FileReader(); r.onload = e => { logoData = e.target.result; if(tvWindows[1]) tvWindows[1].document.getElementById('logoImg').src = logoData; document.getElementById('logoPreview').src = logoData; }; r.readAsDataURL(input.files[0]); }
    function loadCustomFrame(input) { const r = new FileReader(); r.onload = e => { customBorderData = e.target.result; alert("Custom Frame Loaded"); }; r.readAsDataURL(input.files[0]); }
    function loadFont(input) { const r = new FileReader(); r.onload = e => { currentFontData = e.target.result; alert("Font Loaded"); }; r.readAsDataURL(input.files[0]); }

    // --- EDITOR ---
    function loadContentToEditor() {
        const idx = document.getElementById('stuList').value;
        const data = screenData[activeTarget][idx];
        if(!data) return;
        if(activeTarget === 1) {
            document.getElementById('line1').value = data.nD; document.getElementById('line2').value = data.nE; document.getElementById('line3').value = data.fD; document.getElementById('line4').value = data.cD;
            let pName = data.nD ? data.nD.trim().toLowerCase() : "";
            if(photoFiles[pName]) { const r = new FileReader(); r.onload = e => { document.getElementById('previewImg').src = e.target.result; }; r.readAsDataURL(photoFiles[pName]); }
            else { document.getElementById('previewImg').src = "https://via.placeholder.com/150"; }
        } else {
            document.getElementById('line1').value = data.l1; document.getElementById('line2').value = data.l2; document.getElementById('line3').value = data.l3; document.getElementById('line4').value = data.l4;
        }
    }

    // --- FULL CSS FOR POPUPS ---
    const POPUP_CSS = `
    @font-face { font-family: 'Faruuma'; src: url('Fonts/faruuma.ttf') format('truetype'); }
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
    body { margin:0; overflow:hidden; background:#000; font-family:'Faruuma', serif; transition:0.3s; }
    #bgLayer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
    #bgLayer video, #bgLayer img { width:100%; height:100%; object-fit:cover; }
    /* Themes */
    .theme-1 { background:#001a12; } .theme-2 { background:radial-gradient(circle,#0d47a1 0%,#000 100%); }
    .theme-3 { background:radial-gradient(circle,#880e4f 0%,#210313 100%); } .theme-4 { background:linear-gradient(135deg,#000,#434343); }
    .theme-5 { background:radial-gradient(circle,#4a148c 0%,#000 100%); } .theme-6 { background:linear-gradient(to bottom right,#004d40,#000); }
    .theme-7 { background:radial-gradient(circle at center,#b71c1c,#3e0404); } .theme-8 { background:radial-gradient(circle,#ffb300,#5d4037); }
    .theme-9 { background:linear-gradient(to right,#ece9e6,#fff); } .theme-10 { background:#3e2723; }
    
    /* Main S1 */ #card { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90vw; display:flex; align-items:center; z-index:20; opacity:0; transition:0.5s; padding:20px; } #card.active { opacity:1; }
    /* Frame Definitions */
    .frame-1 { border:none; box-shadow:0 0 100px #000; } .frame-1::after { content:''; position:absolute; top:-10px; left:-10px; right:-10px; bottom:-10px; border:5px solid #d4af37; z-index:-1; }
    .frame-2 { border:4px dashed #d4af37; box-shadow:0 0 20px #d4af37; border-radius:20px; }
    .frame-3 { border:10px solid #d4af37; border-radius:30px; }
    .frame-4 { border:8px solid transparent; border-image:linear-gradient(45deg,#d4af37,#ffe57f) 1; }
    .frame-5 { border:2px solid #d4af37; outline:4px solid #fff; outline-offset:-10px; }
    .frame-6 { border-top:10px double #d4af37; border-bottom:10px double #d4af37; }
    .frame-7 { border:1px solid #d4af37; box-shadow:0 0 50px #000; }
    .frame-8 { border:3px solid #d4af37; outline:2px solid #d4af37; outline-offset:5px; }
    .frame-9 { border:5px ridge #c0c0c0; background:rgba(0,0,0,0.8); }
    .frame-10 { border:5px solid #5d4037; background:url('https://www.transparenttextures.com/patterns/aged-paper.png'); }
    .frame-11 { border:15px solid #fff; box-shadow:0 0 10px #000; background:#fff; color:#000; } .frame-11 h1,.frame-11 h2,.frame-11 div { color:#000 !important; }
    .frame-12 { border:2px solid #d4af37; } .frame-12::after { content:''; position:absolute; top:10px; left:10px; right:10px; bottom:10px; border:1px solid #d4af37; }
    .frame-13 { border:none; box-shadow:20px 20px 60px #000; border-radius:50px; }
    .frame-14 { border:2px solid #fff; box-shadow:0 0 10px #fff, 0 0 20px #d4af37; }
    .frame-15 { border:20px solid #3e2723; border-image:url('https://www.transparenttextures.com/patterns/wood-pattern.png') 30 stretch; }
    .frame-16 { border:10px solid #fff; outline:1px solid #000; }
    .frame-17 { border-left:50px solid #d4af37; background:rgba(0,0,0,0.8); }
    .frame-18 { border:5px dotted #d4af37; border-radius:10px; }
    .frame-19 { box-shadow:inset 0 0 50px #d4af37; border:2px solid #d4af37; }
    .frame-20 { border:10px outset #555; background:#222; }
    .custom { border:none; box-shadow:none; } .b0 { border:none; background:transparent; box-shadow:none; }
    
    #logoWrap { position:absolute; top:40px; z-index:30; } #logoImg { height:120px; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
    #subContent { position:absolute; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; text-align:center; transition:0.3s; }
    #presFrame, #videoLayer { position:fixed; top:0; left:0; width:100%; height:100%; border:none; z-index:50; display:none; background:#000; }
    #videoLayer { display:none; justify-content:center; align-items:center; } #videoLayer video, #videoLayer iframe { width:100%; height:100%; border:none; }
    h1 { font-size:5em; margin:0; line-height:1.1; color:white; } h2 { font-size:3em; margin:5px 0; color:#d4af37; }
    .photo-col { flex:0 0 300px; display:flex; justify-content:center; transition:0.2s; } #stuImg { width:260px; height:260px; object-fit:cover; transition:0.2s; } .text-col { flex:1; padding-right:30px; color:white; transition:0.2s; }
    `;

    function openTV(id) {
        const win = window.open('', 'TV_'+id, 'width=1280,height=720,menubar=no,toolbar=no');
        tvWindows[id] = win;
        const html = `<html><head><style>${POPUP_CSS}</style></head><body class="${settings[id].mainTheme}">
            <div id="bgLayer"></div><iframe id="presFrame"></iframe><div id="videoLayer"></div>
            ${id === 1 ? `
            <div id="logoWrap"><img id="logoImg" src=""></div>
            <div id="card" class="frame-1"><div class="photo-col"><img id="stuImg"></div>
            <div class="text-col"><h1 id="t1" class="font-dv"></h1><h2 id="t2" class="font-en"></h2><div id="t3"></div><div id="t4"></div></div></div>
            ` : `<div id="subContent"><div id="s1" style="font-weight:bold;"></div><div id="s2"></div><div id="s3"></div><div id="s4"></div></div>`}
        </body></html>`;
        win.document.write(html); win.document.close();
        if(currentFontData) { const s = win.document.createElement('style'); s.innerHTML = `@font-face { font-family: 'Faruuma'; src: url('${currentFontData}') format('truetype'); } body { font-family: 'Faruuma'; }`; win.document.head.appendChild(s); }
        applyBg(id); applyDesign(id);
        if(id===1 && logoData) win.document.getElementById('logoImg').src = logoData;
        document.getElementById('connStatus').innerText = "‚úÖ Connected"; document.getElementById('connStatus').style.color = "green";
    }

    function applyBg(id) {
        const win = tvWindows[id]; const data = bgData[id];
        if(win && !win.closed && data.d) {
            const bg = win.document.getElementById('bgLayer');
            if(data.t === 'video') bg.innerHTML = `<video src="${data.d}" autoplay loop muted style="width:100%; height:100%; object-fit:cover;"></video>`;
            else bg.innerHTML = `<img src="${data.d}" style="width:100%; height:100%; object-fit:cover;">`;
        }
    }

    function sendContent() {
        const win = tvWindows[activeTarget]; if(!win || win.closed) return;
        const doc = win.document;
        const l1 = document.getElementById('line1').value; const l2 = document.getElementById('line2').value;
        const l3 = document.getElementById('line3').value; const l4 = document.getElementById('line4').value;

        if(activeTarget === 1) {
            const idx = document.getElementById('stuList').value; const data = screenData[1][idx];
            if(data) {
                doc.getElementById('t1').innerText = data.nD; doc.getElementById('t2').innerText = data.nE;
                doc.getElementById('t3').innerText = data.fD; doc.getElementById('t4').innerText = data.cD;
                let pName = data.nD ? data.nD.trim().toLowerCase() : "";
                if(photoFiles[pName]) { const r = new FileReader(); r.onload = e => { doc.getElementById('stuImg').src = e.target.result; }; r.readAsDataURL(photoFiles[pName]); }
                else { doc.getElementById('stuImg').src = ""; }
            } else { doc.getElementById('t1').innerText = l1; doc.getElementById('t2').innerText = l2; }
            doc.getElementById('card').classList.add('active');
        } else {
            doc.getElementById('s1').innerText = l1; doc.getElementById('s2').innerText = l2;
            doc.getElementById('s3').innerText = l3; doc.getElementById('s4').innerText = l4;
        }
        document.getElementById('statusMsg').innerText = "Sent to Screen " + activeTarget;
    }

    function clearTarget() {
        const win = tvWindows[activeTarget]; if(win && !win.closed) {
            if(activeTarget === 1) win.document.getElementById('card').classList.remove('active');
            else { win.document.getElementById('s1').innerText = ""; win.document.getElementById('s2').innerText = ""; }
        }
    }

    // --- DESIGN SYSTEM ---
    function liveUpdate(key, value) {
        settings[activeTarget][key] = value;
        localStorage.setItem('royalEventConfig', JSON.stringify(settings));
        applyDesign(activeTarget);
    }

    function applyDesign(id) {
        const win = tvWindows[id]; if(!win || win.closed) return;
        const doc = win.document; const s = settings[id];
        doc.body.className = s.mainTheme;

        if(id === 1) {
            const card = doc.getElementById('card'); card.className = s.cBorder;
            if(s.cBorder === 'custom' && customBorderData) { card.style.backgroundImage = `url(${customBorderData})`; card.style.backgroundSize = "100% 100%"; } 
            else { card.style.backgroundImage = "none"; }
            card.style.flexDirection = (s.layoutDir === 'rtl') ? 'row-reverse' : 'row';
            
            const pCol = doc.querySelector('.photo-col'); pCol.style.display = (s.pVis === 'show') ? 'flex' : 'none';
            pCol.style.transform = `translate(${s.pX}px, ${s.pY}px)`;
            const img = doc.getElementById('stuImg'); img.style.width = s.pSize + 'px'; img.style.height = s.pSize + 'px';
            img.style.borderRadius = s.pShape; 
            if(s.pBorder === 'on') { img.style.border = `5px solid ${s.bdColor}`; img.style.background='#000'; img.style.boxShadow='0 15px 40px rgba(0,0,0,0.8)'; }
            else { img.style.border='none'; img.style.background='transparent'; img.style.boxShadow='none'; }

            const logo = doc.getElementById('logoWrap'); logo.style.display = (s.lVis === 'show') ? 'block' : 'none';
            logo.style.top = s.logoY + 'px'; logo.style.left = '50%'; logo.style.transform = `translate(calc(-50% + ${s.logoX}px), 0)`;

            const txt = doc.querySelector('.text-col'); txt.style.textAlign = s.textAlign;
            txt.style.transform = `translate(${s.txtX}px, ${s.txtY}px)`;
            doc.querySelector('h1').style.color = s.mtColor; doc.querySelector('h1').style.fontSize = s.mtSize + 'em';
        } else {
            const con = doc.getElementById('subContent');
            con.style.transform = `translate(${s.txtX}px, ${s.txtY}px)`; con.style.textAlign = s.textAlign;
            doc.getElementById('s1').style.fontSize = s.mtSize + 'em'; doc.getElementById('s1').style.color = s.mtColor;
        }
    }

    // --- VIDEO & PRES ---
    function playLocalVideo() {
        const file = document.getElementById('videoLocal').files[0];
        if(!file) { alert("Select video!"); return; }
        const url = URL.createObjectURL(file);
        if(tvWindows[1]) {
            const v = tvWindows[1].document.getElementById('videoLayer');
            v.innerHTML = `<video id="mainVid" src="${url}" autoplay controls></video>`;
            v.style.display = 'flex';
            tvWindows[1].document.getElementById('card').classList.remove('active');
        }
    }

    function playYoutube() {
        const url = document.getElementById('ytLink').value;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
        if(match && match[2].length === 11 && tvWindows[1]) {
            const v = tvWindows[1].document.getElementById('videoLayer');
            v.innerHTML = `<iframe src="https://www.youtube.com/embed/${match[2]}?autoplay=1" style="border:none;"></iframe>`;
            v.style.display = 'flex';
            tvWindows[1].document.getElementById('card').classList.remove('active');
        }
    }

    function stopVideo() {
        if(tvWindows[1]) {
            tvWindows[1].document.getElementById('videoLayer').innerHTML = '';
            tvWindows[1].document.getElementById('videoLayer').style.display = 'none';
        }
    }

    function loadPres() {
        const url = document.getElementById('presUrl').value;
        if(tvWindows[4]) { const f = tvWindows[4].document.getElementById('presFrame'); f.src=url; f.style.display='block'; }
        if(isCasting && tvWindows[1]) { const f = tvWindows[1].document.getElementById('presFrame'); f.src=url; f.style.display='block'; }
    }

    function clearPres() { if(tvWindows[4]) tvWindows[4].document.getElementById('presFrame').style.display='none'; }
    function toggleCast() {
        isCasting = !isCasting; const btn = document.getElementById('castBtn');
        if(isCasting) { btn.innerText = "‚èπ STOP CASTING"; document.getElementById('presPanel').classList.add('pres-active'); if(tvWindows[1]) { const f = tvWindows[1].document.getElementById('presFrame'); f.src = document.getElementById('presUrl').value; f.style.display='block'; tvWindows[1].document.getElementById('card').classList.remove('active'); } }
        else { btn.innerText = "üî¥ CAST PRES TO MAIN"; document.getElementById('presPanel').classList.remove('pres-active'); if(tvWindows[1]) tvWindows[1].document.getElementById('presFrame').style.display='none'; }
    }

    // --- UTILS ---
    function move(d) { let l = document.getElementById('stuList'); l.selectedIndex = Math.min(Math.max(l.selectedIndex+d, 0), l.options.length-1); loadContentToEditor(); }
    function toggleDesignPanel() { const p = document.getElementById('designPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function toggleLock(cb) { if(cb.checked) document.getElementById('designPanel').classList.add('locked'); else document.getElementById('designPanel').classList.remove('locked'); }
    function exportConfig() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(settings)); const a = document.createElement('a'); a.href=d; a.download="royal_setup.json"; a.click(); }
    function importConfig(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { settings = JSON.parse(e.target.result); localStorage.setItem('royalEventConfig', JSON.stringify(settings)); loadSettings(); alert("Loaded!"); } catch(err){ alert("Error!"); } }; r.readAsText(f); }
    function loadSettings() { const s = localStorage.getItem('royalEventConfig'); if(s) settings = JSON.parse(s); updateDesignInputs(); }
    
    // Default load content for S1
    function filterList() { let t = document.getElementById('search').value.toLowerCase(); let l = document.getElementById('stuList'); l.innerHTML = ''; const d = screenData[activeTarget]; if(d) d.forEach((item, i) => { let txt = (activeTarget===1) ? item.nD : item.l1; if(txt.toLowerCase().includes(t)) { let opt = document.createElement('option'); opt.value=i; opt.text=(i+1)+". "+txt; l.add(opt); } }); }
</script>
</body>
</html>
