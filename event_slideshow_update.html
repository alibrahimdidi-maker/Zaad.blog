<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Royal Graduation System (V22.0 - Enterprise)</title>
    <style>
        /* --- GLOBAL VARIABLES --- */
        :root {
            --gold: #d4af37; --dark: #001a12; --green: #004d40; 
            --light: #fffde7; --blue: #0d47a1; --red: #c62828;
            --shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        body {
            margin:0; padding:0; background:radial-gradient(circle,#00281c 0%,#000 100%);
            font-family:'Faruuma','MV Boli',serif; overflow:hidden; height:100vh; width:100vw;
            color:#333; user-select:none;
        }
        @font-face { font-family:'Faruuma'; src:local('Faruuma'),url('Fonts/faruuma.ttf') format('truetype'); }

        /* --- UI LAYOUT --- */
        .main-layout { display:flex; gap:15px; height:100vh; padding:15px; box-sizing:border-box; }
        .sidebar {
            flex:0 0 350px; background:linear-gradient(180deg,#d4af37 0%,#a1887f 100%);
            padding:15px; border-radius:12px; display:flex; flex-direction:column;
            overflow-y:auto; border:3px solid #fff; box-shadow:var(--shadow);
        }
        .editor {
            flex:1; background:var(--light); padding:20px; border-radius:12px;
            display:flex; flex-direction:column; overflow-y:auto; position:relative;
            border:4px solid var(--gold); box-shadow:var(--shadow);
        }

        /* --- CONTROLS --- */
        h2, h3 { margin:5px 0; color:var(--dark); text-align:center; text-shadow:1px 1px 0 #fff; }
        h3 { border-bottom:2px solid var(--gold); padding-bottom:5px; color:var(--green); text-align:right; }
        
        label { display:block; font-weight:bold; font-size:14px; margin-bottom:3px; }
        .d-label { font-size:16px; font-weight:bold; color:var(--green); margin:15px 0 5px; border-bottom:1px dotted #999; }

        input, select, textarea { 
            width:100%; padding:8px; border:1px solid #777; border-radius:5px; 
            font-size:14px; margin-bottom:5px; font-family:'Faruuma'; box-sizing:border-box;
        }
        input[type=range] { height:15px; accent-color:var(--green); margin:5px 0; }
        input[type=color] { width:40px; height:30px; padding:0; cursor:pointer; }

        .group-box {
            border:2px solid var(--gold); border-radius:10px; padding:20px 15px; 
            margin-bottom:20px; background:#fff; position:relative;
        }
        .group-title {
            position:absolute; top:-15px; right:15px; background:var(--green); 
            color:var(--gold); padding:4px 20px; font-size:16px; border-radius:15px;
            border:2px solid var(--gold);
        }

        /* --- BUTTONS --- */
        button { cursor:pointer; font-family:'Faruuma'; font-weight:bold; border-radius:6px; transition:0.2s; }
        .launch-btn { background:var(--red); color:#fff; padding:12px; width:100%; font-size:18px; margin-bottom:10px; border:2px solid #fff; }
        .btn-live { background:var(--green); flex:2; border:3px solid var(--gold); color:var(--gold); font-size:22px; padding:10px; }
        .btn-nav { background:#455a64; color:#fff; padding:10px; width:60px; font-size:20px; }
        .feature-btn { background:var(--blue); color:#fff; width:100%; padding:8px; margin-top:5px; border:1px solid #fff; }
        
        /* --- EXTRAS --- */
        .preview-container { display:flex; gap:10px; background:#fff3e0; padding:10px; border-radius:10px; justify-content:center; align-items:center; }
        #previewImg { height:80px; width:80px; object-fit:cover; border-radius:50%; border:3px solid var(--gold); }
        .video-panel { background:#e1f5fe; padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #29b6f6; }
        .arrow-controls { display:flex; flex-direction:column; align-items:center; background:#eee; padding:5px; border-radius:8px; }
        .btn-arr { width:35px; height:30px; font-size:16px; background:#fff; border:1px solid #555; }
        
        /* --- SECURITY --- */
        #securityOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .sec-box { background:rgba(0,26,18,0.9); padding:50px; border:3px solid var(--gold); text-align:center; width:400px; border-radius:20px; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width:8px; } ::-webkit-scrollbar-thumb { background:var(--gold); border-radius:4px; }
    </style>
</head>
<body oncontextmenu="return false;">
<div id="securityOverlay">
        <div class="sec-box">
            <h1 style="color:var(--gold); font-size:40px;">Royal Graduation V22.0</h1>
            <p style="color:#fff;">ﬁáﬁ¨ﬁÇﬁ∞ﬁìﬁ¶ﬁïﬁ∞ﬁÉﬁ¶ﬁáﬁ®ﬁíﬁ∞ ﬁáﬁ¨ﬁëﬁ®ﬁùﬁ¶ﬁÇﬁ∞ - ﬁçﬁÆﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®</p>
            <input type="password" id="licenseKey" style="padding:10px; font-size:20px; text-align:center;" placeholder="ﬁÜﬁ© ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß">
            <button onclick="verifyLicense()" style="margin-top:20px; padding:10px 40px; font-size:18px; background:var(--gold);">ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁß</button>
            <p id="secMsg" style="color:#ff5252; margin-top:10px;"></p>
        </div>
    </div>

    <div class="main-layout" id="mainApp" style="display:none;">
        <div class="sidebar">
            <h2>ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞</h2>
            <button class="launch-btn" onclick="openTV()">üñ•Ô∏è 1. ﬁìﬁ©ﬁàﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁß</button>
            <div id="connStatus" style="font-size:13px; color:red; text-align:center; background:#fff; padding:4px; margin-bottom:10px;">ﬁÜﬁ¶ﬁÇﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ ﬁÇﬁ™ﬁàﬁ≠</div>

            <div style="background:#fff; padding:10px; border-radius:10px; overflow-y:auto; flex:1;">
                <label style="color:var(--blue); border-bottom:1px solid #ccc;">üìÇ ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞:</label>
                <label>1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ (CSV):</label><input type="file" id="csvFile" accept=".csv">
                <label>2. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ:</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
                <label>3. ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁéﬁØ:</label><input type="file" id="logoFile" accept="image/*">
                <label>4. ﬁêﬁ™ﬁÉﬁ™ﬁöﬁ©ﬁåﬁ¶ﬁáﬁ∞ (CSV):</label><input type="file" id="jalsaCsvFile" accept=".csv">
                <label style="color:red;">5. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÜﬁßﬁëﬁ™/ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞:</label><input type="file" id="customBorderFile" accept="image/*">
                <hr>
                <label style="color:var(--green);">6. ﬁêﬁ∞ﬁïﬁÆﬁÇﬁ∞ﬁêﬁ¶ﬁÉ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞:</label><input type="file" id="sponsorFolder" webkitdirectory directory multiple>
                <label style="color:var(--green);">7. ﬁáﬁ®ﬁùﬁ∞ﬁåﬁ®ﬁÄﬁßﬁÉﬁ™/ﬁäﬁÆﬁìﬁØﬁåﬁ¶ﬁáﬁ∞:</label><input type="file" id="adsFolder" webkitdirectory directory multiple>
                <label style="color:var(--green);">8. ﬁìﬁÆﬁïﬁ∞ 5 ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁåﬁ¶ﬁáﬁ∞:</label><input type="file" id="top5Folder" webkitdirectory directory multiple>
            </div>
            
            <label style="margin-top:10px;">üîç ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁÄﬁØﬁãﬁß:</label>
            <input type="text" id="search" placeholder="..." onkeyup="filterList()">
            <select id="stuList" size="2" style="height:150px; border:2px solid var(--green);" onchange="loadStudent()"></select>
            
            <div style="background:#e8eaf6; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #3f51b5;">
                <label style="color:#1a237e;">üìΩÔ∏è ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞:</label>
                <input type="text" id="pptLink" placeholder="ﬁéﬁ´ﬁéﬁ™ﬁçﬁ∞ ﬁêﬁ∞ﬁçﬁ¶ﬁáﬁ®ﬁëﬁ∞ ﬁçﬁ®ﬁÇﬁ∞ﬁÜﬁ∞...">
                <button class="feature-btn" onclick="togglePPT()">ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁâﬁØﬁëﬁ∞ (ON/OFF)</button>
            </div>
        </div>

        <div class="editor" id="editorPanel">
            <button id="lockBtn" style="background:#455a64; color:#fff; width:100%; padding:10px; border-radius:6px; margin-bottom:15px;" onclick="toggleLock()">üîì ﬁáﬁ¨ﬁëﬁ®ﬁìﬁ∞ ﬁâﬁØﬁëﬁ∞ (ﬁçﬁÆﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ≠)</button>

            <div class="controls" style="display:flex; gap:10px;">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ</button>
                <button class="action btn-live" onclick="updateTV()">üì∫ ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ (ﬁÜﬁßﬁëﬁ™)</button>
                <button class="action btn-nav" onclick="move(1)">‚ñ∂</button>
                <button class="action btn-nav" style="background:#b71c1c;" onclick="clearTV()">X</button>
            </div>

            <div style="background:#fff; padding:15px; border-radius:12px; border:2px solid #ccc; margin-bottom:20px;">
                <h3>üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</h3>
                <div style="display:flex; gap:5px;"><input id="nD" class="font-dv" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)"><input id="nE" style="direction:ltr; text-align:left;" placeholder="Name (En)"></div>
                <div style="display:flex; gap:5px;"><input id="fD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 1"><input id="fE" style="direction:ltr; text-align:left;" placeholder="Detail 1"></div>
                <div style="display:flex; gap:5px;"><input id="cD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 2"><input id="cE" style="direction:ltr; text-align:left;" placeholder="Detail 2"></div>
                
                <div class="preview-container">
                    <div><img id="logoPreview" alt="Logo" style="height:60px;"></div>
                    <div style="text-align:center;">
                        <span id="pStat" style="font-size:12px;">ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¨ﬁåﬁ∞</span><br>
                        <img id="previewImg" src="https://via.placeholder.com/150">
                        <br><button onclick="document.getElementById('singlePhoto').click()" style="font-size:10px;">ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                        <input type="file" id="singlePhoto" accept="image/*" style="display:none" onchange="manualPhoto(this)">
                    </div>
                </div>
            </div>

            <div class="group-box" style="background:#e0f7fa; border-color:#006064;">
                <span class="group-title">üåü ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁäﬁ©ﬁóﬁßﬁêﬁ∞ (ﬁáﬁ¨ﬁÇﬁ∞ﬁìﬁ¶ﬁïﬁ∞ﬁÉﬁ¶ﬁáﬁ®ﬁíﬁ∞)</span>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="feature-btn" style="flex:1; background:var(--blue);" onclick="toggleAdsMode()">üñºÔ∏è ﬁáﬁ®ﬁùﬁ∞ﬁåﬁ®ﬁÄﬁßﬁÉﬁ™ / ﬁäﬁÆﬁìﬁØﬁåﬁ¶ﬁáﬁ∞</button>
                    <button class="feature-btn" style="flex:1; background:var(--green);" onclick="toggleSponsors()">ü§ù ﬁêﬁ∞ﬁïﬁÆﬁÇﬁ∞ﬁêﬁ¶ﬁÉ ﬁÑﬁß (ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ®)</button>
                </div>
                <hr>
                <label>üèÜ ﬁìﬁÆﬁïﬁ∞ 5 ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁïﬁ∞ﬁçﬁ≠ﬁîﬁ¶ﬁÉ:</label>
                <div style="display:flex; gap:5px;">
                    <button class="feature-btn" style="background:#e65100;" onclick="playNextTop5()">‚ñ∂ ﬁÇﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ</button>
                    <button class="feature-btn" style="background:#333;" onclick="stopTop5()">‚èπ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁßﬁçﬁß</button>
                </div>
                <div style="margin-top:5px; font-size:12px;">
                    <label><input type="checkbox" id="chk_top5_overlay" checked> ﬁÜﬁßﬁëﬁ™ ﬁáﬁØﬁàﬁ¶ﬁçﬁ≠ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß</label>
                </div>
            </div>

            <div id="designPanel">
                <div class="group-box">
                    <span class="group-title">üåç ﬁåﬁ©ﬁâﬁ∞ & ﬁÜﬁßﬁëﬁ™</span>
                    <span class="d-label">1. ﬁÑﬁ¨ﬁÜﬁ∞ﬁéﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁëﬁ∞:</span>
                    <div style="display:flex; gap:10px;">
                        <select id="bgPresetSel" onchange="liveUpdate('bgPreset', this.value)" style="width:60%;"><script>for(let i=1;i<=50;i++)document.write(`<option value="bg${i}">Theme ${i}</option>`);</script></select>
                        <input type="file" id="jalsaBgFile" accept="video/*,image/*" style="width:40%">
                    </div>
                    <span class="d-label">2. ﬁÜﬁßﬁëﬁ™ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞:</span>
                    <div style="display:flex; gap:10px;">
                         <select id="cBorderSel" onchange="liveUpdate('cBorder', this.value)" style="width:70%;"><option value="custom">ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ (ﬁáﬁ®ﬁâﬁ≠ﬁñﬁ∞)</option><script>for(let i=1;i<=50;i++)document.write(`<option value="b${i}">Card ${i}</option>`);</script><option value="b0">ﬁÑﬁØﬁëﬁ¶ﬁÉ ﬁÇﬁ¨ﬁåﬁ∞</option></select>
                         <input type="color" id="bdColorPick" value="#d4af37" oninput="liveUpdate('bdColor',this.value)">
                    </div>
                    <span class="d-label">3. ﬁÜﬁßﬁëﬁ™ ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁåﬁ¶ﬁÇﬁ∞:</span>
                    <div style="display:flex; gap:5px;"><span>W:</span><input type="range" id="cardWRange" min="50" max="100" value="90" oninput="liveUpdate('cardW',this.value)"><span>H:</span><input type="range" id="cardHRange" min="50" max="100" value="80" oninput="liveUpdate('cardH',this.value)"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;"><select id="layoutDirSel" onchange="liveUpdate('layoutDir',this.value)"><option value="rtl">ﬁäﬁÆﬁìﬁØ ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞</option><option value="ltr">ﬁäﬁÆﬁìﬁØ ﬁàﬁßﬁåﬁ∞</option></select><select id="textAlignSel" onchange="liveUpdate('textAlign',this.value)"><option value="right">ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞</option><option value="center">ﬁâﬁ¨ﬁãﬁ™</option></select></div>
                </div>

                <div class="group-box">
                    <span class="group-title">üëë ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁêﬁ™ﬁÉﬁ™ﬁöﬁ©ﬁåﬁ¶ﬁáﬁ∞ (7 ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞)</span>
                    <input type="text" id="jLine1" placeholder="ﬁâﬁ¶ﬁáﬁ® ﬁêﬁ™ﬁÉﬁ™ﬁöﬁ©" oninput="updateJalsaText()" style="font-weight:bold; font-size:16px;">
                    <div style="display:flex; gap:5px;">
                         <input type="range" id="mtYRange" min="-600" max="600" value="210" oninput="liveUpdate('mtY',this.value)">
                         <button onclick="adjT('y',-10)">‚¨Ü</button><button onclick="adjT('y',10)">‚¨á</button>
                    </div>
                    <hr>
                    <div id="subTitlesArea">
                        <script>
                            for(let i=1; i<=7; i++) {
                                document.write(`
                                    <div style="margin-bottom:5px; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                                        <input type="text" id="sub${i}Text" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ${i}" oninput="updateJalsaText()">
                                        <div style="display:flex; gap:5px;">
                                            <span style="font-size:10px;">ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞:</span><input type="range" id="sub${i}Size" min="1" max="5" step="0.1" value="2.0" oninput="updateJalsaText()">
                                            <input type="color" id="sub${i}Color" value="#ffffff" oninput="updateJalsaText()">
                                        </div>
                                    </div>
                                `);
                            }
                        </script>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <span>ﬁéﬁ∞ﬁÉﬁ´ﬁïﬁ∞ ﬁåﬁ¶ﬁÇﬁ∞:</span><input type="range" id="stYRange" min="0" max="200" value="0" oninput="liveUpdate('stY',this.value)">
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üì∏ ﬁäﬁÆﬁìﬁØ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞</span>
                    <select id="photoPresetSel" onchange="applyPhotoPreset(this.value)"><option value="0">-- ﬁÇﬁ¶ﬁéﬁß --</option><option value="1">Plain</option><option value="2">Shadow</option><option value="6">Blue Frame</option><option value="10">Rounded</option><option value="11">Circle</option><option value="14">Polaroid</option><option value="15">Gold</option></select>
                    <div style="display:flex; gap:5px; margin-top:5px;"><span>ﬁÜﬁ™ﬁçﬁ¶:</span><input type="color" id="pfColorPick" value="#000000" oninput="liveUpdate('pfColor',this.value)"><span>ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞:</span><input type="range" id="pfWidthRange" min="0" max="30" value="0" oninput="liveUpdate('pfWidth',this.value)"></div>
                </div>
            </div>
        </div>
    </div>
<script>
    document.addEventListener('contextmenu', e=>e.preventDefault());

    // --- LICENSE ---
    function verifyLicense(){
        const k=document.getElementById('licenseKey').value; 
        if(k==="ROYAL2025" || k) { // Easy unlock for you
            document.getElementById('securityOverlay').style.display='none';
            document.getElementById('mainApp').style.display='flex';
            document.getElementById('licenseStatus').innerText="‚úÖ SYSTEM UNLOCKED";
        }
    }

    let tv=null, students=[], photoFiles={}, sponsorFiles=[], adFiles=[], top5Files=[], top5Index=0;
    let currentPhoto=null, currentLogo=null, customBorder=null, currentBG=null, bgType='none';
    let isLocked=false, isAds=false, isSponsor=false, isPPT=false;
    
    let ds = {
        mtY:210, mtX:0, mtSize:5.6, mtColor:'#d4af37', tLine:'on', 
        stY:0, cardW:90, cardH:80, layoutDir:'rtl', textAlign:'right',
        pfWidth:0, pfColor:'#000', pfStyle:'solid', pfRadius:0, pfShadow:'none',
        cBorder:'b1', bdColor:'#d4af37', bgPreset:'bg1', bgLoop:'on',
        pSize:260, pX:0, pY:0, pVis:'show',
        tnDSize:5, tnDColor:'#fff', tnESize:3, tnEColor:'#fff', 
        tfDSize:2, tfDColor:'#fff9c4', tcDSize:2.5, tcDColor:'#fff9c4'
    };

    // --- CORE FUNCTIONS ---
    function toggleLock(){ isLocked=!isLocked; document.getElementById('lockBtn').innerText=isLocked?"üîí LOCKED":"üîì EDIT MODE"; }
    function setVal(id,v){const e=document.getElementById(id);if(e)e.value=v;}
    function adjT(a,v){ if(a=='y'){ds.mtY=parseInt(ds.mtY)+v; setVal('mtYRange',ds.mtY); liveUpdate('mtY',ds.mtY);} }

    function liveUpdate(k,v){
        if(isLocked)return; ds[k]=v; if(!tv||tv.closed)return; const d=tv.document;
        // Logic for updates
        if(k=='bgPreset')d.getElementById('bgLayer').className=v;
        if(k=='cBorder'){const c=d.getElementById('card'); c.className=v+' active'; if(v=='custom'&&customBorder)c.style.backgroundImage=`url(${customBorder})`; else c.style.backgroundImage='none';}
        if(k.startsWith('pf')){const i=d.getElementById('stuImg'); if(i){i.style.borderWidth=ds.pfWidth+'px'; i.style.borderColor=ds.pfColor; i.style.borderRadius=ds.pfRadius+'%'; i.style.boxShadow=ds.pfShadow;}}
        if(k=='pSize'){const i=d.getElementById('stuImg'); if(i){i.style.width=v+'px';i.style.height=v+'px';}}
        if(k=='pX'||k=='pY')d.querySelector('.photo-col').style.transform=`translate(${ds.pX}px,${ds.pY}px)`;
        if(k=='cardW')d.getElementById('card').style.width=v+'vw'; if(k=='cardH')d.getElementById('card').style.height=v+'vh';
        if(k=='layoutDir')d.getElementById('card').style.flexDirection=(v=='rtl')?'row-reverse':'row';
        if(k=='textAlign')d.querySelector('.text-col').style.textAlign=v;
        if(k=='mtY')d.getElementById('titleContainer').style.marginTop=v+'px';
        if(k=='stY')d.getElementById('subTitleContainer').style.marginTop=v+'px';
        if(k.startsWith('tn')||k.startsWith('tf')||k.startsWith('tc')){ /* Text sizes update - simplified */
            d.getElementById('tnD').style.fontSize=ds.tnDSize+'em'; d.getElementById('tnD').style.color=ds.tnDColor;
            d.getElementById('tnE').style.fontSize=ds.tnESize+'em'; d.getElementById('tnE').style.color=ds.tnEColor;
        }
    }

    function applyPhotoPreset(v){
        let w=0,c='#000',r=0,sh='none';
        if(v=='2')sh='0 4px 8px rgba(0,0,0,0.5)'; if(v=='6'){w=6;c='blue';} if(v=='10'){w=3;r=10;} if(v=='11'){w=3;r=50;} if(v=='15'){w=8;c='gold';}
        setVal('pfWidthRange',w); setVal('pfColorPick',c); setVal('pfRadiusRange',r);
        liveUpdate('pfWidth',w); liveUpdate('pfColor',c); liveUpdate('pfRadius',r); liveUpdate('pfShadow',sh);
    }

    function updateJalsaText(){
        if(!tv||tv.closed)return; const d=tv.document;
        d.getElementById('mainT').innerText = document.getElementById('jLine1').value;
        // Loop 7 Subtitles
        for(let i=1; i<=7; i++){
            const txt = document.getElementById(`sub${i}Text`).value;
            const sz = document.getElementById(`sub${i}Size`).value;
            const cl = document.getElementById(`sub${i}Color`).value;
            const el = d.getElementById(`st${i}`);
            if(el){
                el.innerText = txt;
                el.style.fontSize = sz + 'em';
                el.style.color = cl;
                el.style.display = txt ? 'block' : 'none';
            }
        }
    }

    // --- TV WINDOW GENERATOR ---
    function openTV(){
        tv=window.open('','GradTV','width=1280,height=720,menubar=no');
        if(!tv){alert("Popups Disabled!");return;}
        
        let css=""; 
        const grads=["radial-gradient(circle,#004d40,#001a12)","linear-gradient(135deg,#000,#333)"];
        for(let i=0;i<50;i++) css+=`.bg${i+1}{background:${grads[i%grads.length]}}\n`;
        const brds=["border:none","border:10px solid var(--gold)","border:5px double #fff"];
        for(let i=0;i<50;i++) css+=`.b${i+1}{${brds[i%brds.length]}}\n`;

        const html = `
        <!DOCTYPE html><html lang="dv" dir="rtl"><head>
        <style>
            @font-face{font-family:'Faruuma';src:url('Fonts/faruuma.ttf');} :root{--gold:#d4af37;}
            body{margin:0;overflow:hidden;background:#000;font-family:'Faruuma';}
            #bgLayer{position:fixed;width:100%;height:100%;z-index:0;} ${css}
            #jalsaContent{position:absolute;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;transition:0.5s;}
            #titleContainer{text-align:center; transition:0.3s;}
            .main-title{font-size:5em; color:var(--gold); text-shadow:2px 2px 10px #000; border-bottom:3px solid var(--gold);}
            .sub-title{text-shadow:1px 1px 5px #000; margin:5px 0;}
            
            #card{position:absolute;top:54%;left:50%;transform:translate(-50%,-50%);width:90vw;height:80vh;display:flex;align-items:center;background:rgba(0,20,15,0.92);padding:3vh;opacity:0;transition:0.5s;z-index:20;}
            #card.active{opacity:1;}
            .photo-col{flex:0 0 auto;min-width:200px;display:flex;justify-content:center;height:100%;}
            #stuImg{width:260px;height:260px;object-fit:cover;border:5px solid #000;transition:0.3s;}
            .text-col{flex:1;text-align:right;padding:0 30px;color:white;}
            h1{font-size:5em;margin:0;color:#fff;} h2{font-size:3em;color:var(--gold);}
            
            /* LAYERS */
            #videoLayer, #adsLayer, #pptLayer {position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:5000;display:none;}
            #sponsorBar {position:fixed;bottom:0;left:0;width:100%;height:80px;background:#fff;z-index:6000;display:none;justify-content:center;align-items:center;gap:30px;box-shadow:0 -5px 15px rgba(0,0,0,0.5); animation: scroll 20s linear infinite;}
            .sp-img {height:60px; object-fit:contain;}
            #adsGrid {display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:20px; width:100%; height:100%; box-sizing:border-box;}
            .ad-item {width:100%; height:100%; object-fit:contain;}
            #logoWrap {position:absolute;top:0;left:50%;transform:translate(-50%,0);z-index:30;}
            .custom{border:none!important; background-size:100% 100%!important;}
        </style></head><body>
        <div id="videoLayer"></div><div id="adsLayer"><div id="adsGrid"></div></div><div id="pptLayer"></div>
        <div id="bgLayer" class="bg1"></div>
        <div id="logoWrap"><img id="logoImg" src="" style="height:150px;"></div>
        
        <div id="jalsaContent">
            <div id="titleContainer">
                <div id="mainT" class="main-title"></div>
                <div id="subTitleContainer">
                    <div id="st1" class="sub-title"></div><div id="st2" class="sub-title"></div>
                    <div id="st3" class="sub-title"></div><div id="st4" class="sub-title"></div>
                    <div id="st5" class="sub-title"></div><div id="st6" class="sub-title"></div>
                    <div id="st7" class="sub-title"></div>
                </div>
            </div>
        </div>

        <div id="card" class="b1">
            <div class="photo-col"><img id="stuImg" src=""></div>
            <div class="text-col">
                <h1 id="tnD"></h1><h2 id="tnE"></h2>
                <div id="tfD" style="font-size:2em;color:#fff9c4"></div><div id="tfE" style="font-size:1.6em;color:#fff9c4"></div>
                <div id="tcD" style="font-size:2.5em;color:#fff9c4"></div><div id="tcE" style="font-size:2em;color:#fff9c4"></div>
                <div id="tcm" style="font-size:2.2em;margin-top:20px;"></div>
            </div>
        </div>
        <div id="sponsorBar"></div>
        </body></html>`;
        
        tv.document.write(html); tv.document.close();
        document.getElementById('connStatus').innerText="‚úÖ ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞"; document.getElementById('connStatus').style.color="green";
        updateJalsaText();
    }

    // --- DATA HANDLING ---
    document.getElementById('csvFile').onchange=e=>{const r=new FileReader();r.onload=v=>{const l=v.target.result.split('\n');students=[];l.forEach(x=>{const c=x.split(',');if(c.length>1)students.push({nD:c[0],nE:c[1],fD:c[4],fE:c[5],cD:c[2],cE:c[3],cm:c[6],ph:c[7]});});filterList();alert("Students Loaded");};r.readAsText(e.target.files[0]);}
    document.getElementById('photoFolder').onchange=e=>{photoFiles={};for(let f of e.target.files)photoFiles[f.name.toLowerCase()]=f; alert("Photos Loaded");}
    document.getElementById('customBorderFile').onchange=e=>{const r=new FileReader();r.onload=v=>{customBorder=v.target.result;liveUpdate('cBorder','custom');};r.readAsDataURL(e.target.files[0]);}
    document.getElementById('logoFile').onchange=e=>{const r=new FileReader();r.onload=v=>{if(tv)tv.document.getElementById('logoImg').src=v.target.result;};r.readAsDataURL(e.target.files[0]);}
    
    // --- ADVANCED FEATURES ---
    document.getElementById('sponsorFolder').onchange=e=>{sponsorFiles=[]; for(let f of e.target.files)if(f.type.startsWith('image'))sponsorFiles.push(f); renderSponsors();}
    document.getElementById('adsFolder').onchange=e=>{adFiles=[]; for(let f of e.target.files)if(f.type.startsWith('image'))adFiles.push(f); renderAds();}
    document.getElementById('top5Folder').onchange=e=>{top5Files=[]; for(let f of e.target.files)if(f.type.startsWith('video'))top5Files.push(f); alert(`Top 5: ${top5Files.length} videos`);}

    function renderSponsors(){if(!tv)return; const b=tv.document.getElementById('sponsorBar'); b.innerHTML=''; sponsorFiles.forEach(f=>{const r=new FileReader();r.onload=e=>{const i=tv.document.createElement('img');i.src=e.target.result;i.className='sp-img';b.appendChild(i);};r.readAsDataURL(f);});}
    function renderAds(){if(!tv)return; const g=tv.document.getElementById('adsGrid'); g.innerHTML=''; adFiles.forEach(f=>{const r=new FileReader();r.onload=e=>{const i=tv.document.createElement('img');i.src=e.target.result;i.className='ad-item';g.appendChild(i);};r.readAsDataURL(f);});}

    function toggleSponsors(){if(tv){const b=tv.document.getElementById('sponsorBar'); b.style.display = b.style.display=='flex'?'none':'flex';}}
    function toggleAdsMode(){isAds=!isAds; if(tv){tv.document.getElementById('jalsaContent').style.display=isAds?'none':'flex'; tv.document.getElementById('adsLayer').style.display=isAds?'grid':'none';}}
    
    function togglePPT(){
        isPPT=!isPPT; 
        if(!tv)return; 
        const l=tv.document.getElementById('pptLayer'); 
        const url=document.getElementById('pptLink').value;
        if(isPPT && url){
            l.innerHTML=`<iframe src="${url}" style="width:100%;height:100%;border:none;"></iframe>`;
            l.style.display='block';
            tv.document.getElementById('jalsaContent').style.display='none';
        } else {
            l.style.display='none';
            l.innerHTML='';
            tv.document.getElementById('jalsaContent').style.display='flex';
        }
    }

    function playNextTop5(){
        if(!tv || top5Files.length===0)return;
        if(top5Index >= top5Files.length) top5Index=0;
        const f = top5Files[top5Index];
        const u = URL.createObjectURL(f);
        const v = tv.document.getElementById('videoLayer');
        
        // Show Card Overlay if checked
        const showCard = document.getElementById('chk_top5_overlay').checked;
        if(showCard) tv.document.getElementById('card').classList.add('active');
        else tv.document.getElementById('card').classList.remove('active');
        tv.document.getElementById('jalsaContent').classList.add('hidden');

        v.innerHTML=`<video src="${u}" autoplay style="width:100%;height:100%;object-fit:contain;"></video>`;
        v.style.display='block';
        top5Index++;
    }
    function stopTop5(){stopVideo();}

    // --- STANDARD FUNCS ---
    function updateTV(){
        if(!tv)return;
        tv.document.getElementById('jalsaContent').classList.add('hidden');
        const d=tv.document; 
        d.getElementById('tnD').innerText=document.getElementById('nD').value;
        d.getElementById('tnE').innerText=document.getElementById('nE').value;
        d.getElementById('tfD').innerText=document.getElementById('fD').value;
        d.getElementById('tfE').innerText=document.getElementById('fE').value;
        d.getElementById('tcD').innerText=document.getElementById('cD').value;
        d.getElementById('tcE').innerText=document.getElementById('cE').value;
        d.getElementById('tcm').innerText=document.getElementById('cm').value;
        
        if(currentPhoto){ d.getElementById('stuImg').src=currentPhoto; }
        else { d.getElementById('stuImg').src=""; }
        
        setTimeout(()=>d.getElementById('card').classList.add('active'),100);
        stopVideo();
    }

    function clearTV(){if(tv){tv.document.getElementById('card').classList.remove('active'); tv.document.getElementById('jalsaContent').classList.remove('hidden');}}
    function stopVideo(){if(tv){tv.document.getElementById('videoLayer').style.display='none'; tv.document.getElementById('videoLayer').innerHTML='';}}
    
    function manualPhoto(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{currentPhoto=e.target.result;document.getElementById('previewImg').src=currentPhoto;document.getElementById('pStat').innerText="Manual";};r.readAsDataURL(i.files[0]);}}
    function filterList(){let t=document.getElementById('search').value.toLowerCase();let l=document.getElementById('stuList');l.innerHTML='';students.forEach((s,i)=>{if((s.nD+s.nE).toLowerCase().includes(t)){let o=document.createElement('option');o.value=i;o.text=s.nD;l.add(o);}});}
    function loadStudent(){let i=document.getElementById('stuList').value;let s=students[i];document.getElementById('nD').value=s.nD;document.getElementById('nE').value=s.nE;document.getElementById('fD').value=s.fD;document.getElementById('fE').value=s.fE;document.getElementById('cD').value=s.cD;document.getElementById('cE').value=s.cE;document.getElementById('cm').value=s.cm;let p=s.ph?s.ph.trim().toLowerCase():"";let f=photoFiles[p];if(f){const r=new FileReader();r.onload=e=>{currentPhoto=e.target.result;document.getElementById('previewImg').src=currentPhoto;document.getElementById('pStat').innerText="Found";};r.readAsDataURL(f);}else{currentPhoto=null;document.getElementById('previewImg').src="https://via.placeholder.com/150";document.getElementById('pStat').innerText="Missing";}}
    function move(d){let l=document.getElementById('stuList');if(l.options.length){l.selectedIndex=Math.min(Math.max(l.selectedIndex+d,0),l.options.length-1);loadStudent();}}
</script>
</body>
</html>
