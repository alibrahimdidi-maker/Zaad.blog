<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rasfahi Royal Quran (V26.0 Ultimate Upgrade)</title>
    <style>
        /* --- FONTS & IMPORTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700;900&family=Cinzel:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        /* Placeholder for Main App Font */
        @font-face {
            font-family: 'AppFont';
            src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
        }

        :root {
            --royal-blue: #001a33;
            --royal-blue-dark: #000d1a;
            --royal-green: #002200; 
            --royal-green-mix: #004d00;
            --gold: #D4AF37;
            --gold-bright: #FFD700;
            --gold-dim: #aa8c2c;
            --green: #006400;
            --green-bright: #00e676;
            --text-main: #ffffff;
            --panel-bg: #0b1016;
            --border-radius: 6px;
        }

        /* GLOBAL BOX SIZING */
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; outline: none; }
        
        /* APPLY FONT GLOBALLY */
        body, button, input, select, textarea, h1, h2, span, div, p, a, label, th, td { 
            font-family: 'AppFont', 'Noto Sans Thaana', 'Amiri', sans-serif !important; 
        }

        body { 
            margin: 0; padding: 0;
            background: #000; 
            color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; 
        }

        /* --- SIDEBAR DESIGN --- */
        .sidebar {
            width: 500px; 
            background: linear-gradient(180deg, var(--panel-bg) 0%, #000 100%); 
            border-left: 3px solid var(--gold);
            display: flex; flex-direction: column; height: 100vh; z-index: 100;
            box-shadow: 10px 0 40px rgba(0,0,0,0.8);
            transition: width 0.3s;
        }
        
        .header { 
            padding: 15px; text-align: center; 
            background: linear-gradient(to bottom, var(--royal-blue), var(--royal-blue-dark)); 
            border-bottom: 2px solid var(--gold); 
        }
        .app-title { 
            font-family: 'Cinzel', serif !important; color: var(--gold);
            font-size: 20px; margin: 0; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
        }

        .content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        /* FOOTER */
        .royal-footer {
            padding: 10px;
            background: linear-gradient(to top, #000, #111);
            border-top: 2px double var(--gold);
            text-align: center;
            font-size: 11px;
            color: #888;
        }
        .royal-footer p { margin: 2px 0; }
        .royal-footer .highlight { color: var(--gold); font-weight: bold; font-family: 'Cinzel', sans-serif !important; }
        
        .drive-btn {
            background: #1f1f1f; border: 1px dashed #555; color: #aaa;
            padding: 8px; width: 100%; margin-bottom: 10px; cursor: pointer;
            text-decoration: none; display: block; font-size: 11px;
            border-radius: 4px;
        }
        .drive-btn:hover { background: #333; color: #fff; border-color: var(--gold); }

        /* PANELS */
        .panel { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid #334455; 
            border-radius: var(--border-radius); 
            padding: 12px; 
            transition: 0.3s;
        }
        .panel:hover { border-color: #556677; }

        .panel-live {
            background: linear-gradient(135deg, rgba(0,26,51,0.6), rgba(0,0,0,0.8));
            border: 1px solid var(--gold-dim);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        h2 { 
            color: var(--gold); margin: 0 0 8px 0; font-size: 16px; 
            border-bottom: 1px dashed #445566; padding-bottom: 4px; 
        }
        
        label { color: #aab; font-size: 13px; display: block; margin-top: 8px; margin-bottom: 2px; }
        
        input, select, button { 
            width: 100%; padding: 8px; margin-top: 2px; 
            background: #1a222c; border: 1px solid #334455; 
            color: #fff; border-radius: 4px; 
            font-size: 14px; 
        }
        
        /* Custom Controls for Ceremony */
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .color-picker { width: 40px; padding: 2px; height: 35px; cursor: pointer; border: 1px solid #555; }
        .range-slider { flex: 1; cursor: pointer; accent-color: var(--gold); }
        
        /* BUTTON STYLES */
        button { 
            cursor: pointer; font-weight: bold; border-color: #445566; 
            transition: all 0.2s; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(to bottom, #2a3b4c, #1a222c);
        }
        button:hover { filter: brightness(1.2); border-color: var(--gold); transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        .btn-green { background: linear-gradient(to bottom, #004d00, #003300) !important; border-color: #006400 !important; color: #fff !important; }
        .btn-red { background: linear-gradient(to bottom, #8b0000, #500000) !important; border-color: #b71c1c !important; color: #fff !important; }
        .btn-gold { background: linear-gradient(to bottom, var(--gold), var(--gold-dim)) !important; color: #000 !important; border-color: #fff !important; font-weight: 900 !important; }
        .btn-blue { background: linear-gradient(to bottom, #004080, #002040) !important; border-color: #0059b3 !important; color: #fff !important; }
        .btn-purple { background: linear-gradient(to bottom, #4a148c, #311b92) !important; border-color: #7c4dff !important; color: #fff !important; }
        .btn-orange { background: linear-gradient(to bottom, #e65100, #bf360c) !important; border-color: #ff6d00 !important; color: #fff !important; }
        .btn-cyan { background: linear-gradient(to bottom, #00838f, #006064) !important; border-color: #00bcd4 !important; color: #fff !important; }

        /* LANG SWITCHER */
        .lang-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .lang-btn { flex: 1; font-size: 12px; padding: 5px; background: #222; color: #777; border: 1px solid #444; }
        .lang-btn.active { background: var(--royal-blue); color: var(--gold); border-color: var(--gold); font-weight: bold; }

        /* MODE SWITCHER */
        .mode-switch { display: flex; background: #000; border: 1px solid #444; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: #222; color: #666; font-size: 12px; cursor: pointer; }
        .mode-btn.active { background: var(--royal-blue); color: var(--gold); font-weight: bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        /* READING MODE SWITCHER */
        .read-switch { display:flex; gap:5px; margin-bottom:10px; }
        .read-btn { flex:1; padding:8px; border:1px solid #444; background:#111; color:#888; font-size:12px; cursor: pointer; }
        .read-btn.active { background:#004d40; color:#fff; border-color:#00e676; font-weight:bold; }

        /* STATUS & SLOTS */
        #statusDisplay {
            background: #000; border: 2px solid var(--green-bright);
            color: var(--green-bright); text-align: center;
            font-family: 'Cinzel', serif !important; font-size: 18px; font-weight: bold;
            padding: 8px; margin-bottom: 10px; border-radius: 4px;
            text-shadow: 0 0 10px rgba(0,230,118,0.5);
        }

        #slotGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .slot-box { 
            background: #222; padding: 10px; text-align: center; font-size: 14px; 
            color: #555; border: 1px solid #333; border-radius: 4px; transition: 0.3s;
        }
        .slot-box.active { 
            background: var(--royal-blue); color: var(--gold); border-color: var(--gold); 
            font-weight: bold; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); transform: scale(1.05);
        }

        /* MAIN PREVIEW AREA (ADMIN MONITOR) */
        .main-view { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #222; position: relative; overflow: hidden; }
        .mirror-header { background: #111; padding: 5px 15px; color: #666; font-size: 11px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; flex-shrink: 0; }
        
        #adminMirror {
            flex: 1; overflow: hidden; position: relative;
            background: radial-gradient(circle, #001a33, #000);
            display: flex; justify-content: center; align-items: center;
        }
        
        /* SCROLLABLE ADMIN CARD */
        .mirror-card {
            width: 85%; height: 85%;
            background: #fff;
            border: 10px double var(--gold);
            position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 8px;
        }

        .mirror-banner-strip {
            background: rgba(0,0,0,0.9);
            color: var(--gold);
            padding: 8px;
            display: flex; justify-content: space-around;
            border-bottom: 2px solid var(--gold);
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            flex-shrink: 0;
        }

        /* SCROLLABLE IMAGE CONTAINER */
        .mirror-img-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background: #fff;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) #222;
        }
        
        .mirror-img-container::-webkit-scrollbar { width: 8px; }
        .mirror-img-container::-webkit-scrollbar-track { background: #222; }
        .mirror-img-container::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 4px; }

        .mirror-img-container img {
            width: 100%; height: auto; display: block;
        }

        .mirror-info-span { color: #fff; margin-left: 5px; }

        /* GRID PREVIEW */
        #gridPreview { display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 60%; }
        .gp-box { 
            background: #111; border: 1px solid #444; color: #666; 
            text-align: center; padding: 10px; font-size: 12px; cursor: pointer;
        }
        .gp-box:hover { background: #222; color: #fff; border-color: #666; }
        .gp-box.taken { background: #330000; color: #555; border-color: #500; pointer-events: none; }
        .gp-box.selected { background: var(--gold); color: #000; border-color: #fff; font-weight:bold; }

        .hidden { display: none !important; }

        /* SECURITY OVERLAY */
        #securityOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .sec-box { border: 2px solid var(--gold); padding: 40px; text-align: center; background: #000d1a; border-radius: 10px; width: 400px; box-shadow: 0 0 50px rgba(212,175,55,0.2); }

        /* ROYAL FULLSCREEN BUTTON */
        #royalFSBtn {
            position: absolute; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(212,175,55, 0.6);
            cursor: pointer; z-index: 200;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #000; transition: all 0.3s;
        }
        #royalFSBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }

        /* --- MOBILE & RESPONSIVE DESIGN --- */
        @media screen and (max-width: 900px) {
            body { flex-direction: column-reverse; height: auto; overflow-y: auto; }
            .sidebar { 
                width: 100%; height: auto; 
                border-left: none; border-top: 3px solid var(--gold); 
                order: 2;
            }
            .main-view { 
                width: 100%; height: 60vh; 
                order: 1; border-right: none;
            }
            .content { max-height: 400px; }
            .mirror-card { width: 95%; height: 95%; border-width: 5px; }
            .sec-box { width: 90%; }
            button, select, input { padding: 12px; font-size: 16px; }
        }
        
        /* Rubric Table Styles in Sidebar */
        .rubric-edit-row { display: grid; grid-template-columns: 2fr 1fr 30px; gap: 5px; margin-bottom: 5px; }
        .rubric-edit-row input { margin: 0; padding: 4px; }
        
        /* Auto Save Indicator */
        #autoSaveStatus {
            position: fixed; top: 10px; left: 10px; 
            padding: 5px 10px; background: rgba(0,255,0,0.2); 
            border: 1px solid #00e676; border-radius: 20px;
            color: #00e676; font-size: 10px; z-index: 99999;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }

    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="bellStart" src="start.mp3"></audio>
    <audio id="bellEnd" src="end.mp3"></audio>

    <div id="autoSaveStatus">üíæ Auto Saved</div>

<div id="securityOverlay">
        <style>
            #securityOverlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: #000; z-index: 99999;
                /* FLEXBOX CENTERING - KEEPS IT IN MIDDLE */
                display: flex; 
                justify-content: center; 
                align-items: center;
                font-family: 'Poppins', sans-serif;
            }
            .login-card {
                width: 500px; padding: 35px; text-align: center;
                border: 2px solid #FFD700; border-radius: 20px;
                background: #050505;
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.15);
                position: relative;
                margin: 0; /* Ensures no offset */
            }
            /* Double Border Effect */
            .login-card::before {
                content: ''; position: absolute;
                top: 6px; left: 6px; right: 6px; bottom: 6px;
                border: 1px solid #c5a059; border-radius: 15px;
                pointer-events: none;
            }
            
            /* Profile Image Circle */
            .profile-circle {
                width: 100px; height: 100px; margin: 0 auto 20px auto;
                border-radius: 50%; overflow: hidden;
                border: 3px solid #00e676;
                box-shadow: 0 0 20px #00e676;
                background: #111;
            }
            .profile-circle img { 
                width: 100%; height: 100%; 
                object-fit: cover; 
            }

            /* Green Pill Badge */
            .welcome-pill {
                display: inline-block; padding: 6px 20px;
                border: 1px solid #00e676; border-radius: 50px;
                color: #00e676; font-size: 11px; font-weight: bold; letter-spacing: 2px;
                margin-bottom: 20px; text-transform: uppercase;
                background: rgba(0, 230, 118, 0.05);
            }

            .main-title {
                font-family: 'Cinzel', serif; color: #eecda3;
                background: linear-gradient(to right, #fbf5b7, #eecda3);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                font-size: 26px; font-weight: 900; line-height: 1.3; margin-bottom: 25px;
                text-transform: uppercase;
            }

            .input-box {
                background: #0b1016; border: 1px solid #334455;
                color: #fff; width: 100%; padding: 12px;
                border-radius: 8px; text-align: center; font-size: 16px;
                margin-bottom: 15px; letter-spacing: 1px; outline: none;
                transition: 0.3s;
            }
            .input-box:focus { border-color: #00e676; box-shadow: 0 0 10px rgba(0, 230, 118, 0.2); }

            .auth-btn {
                background: linear-gradient(to right, #004d40, #00695c);
                color: #fff; width: 100%; padding: 12px;
                border: 1px solid #00e676; border-radius: 8px;
                font-size: 15px; font-weight: bold; cursor: pointer;
                text-transform: uppercase; letter-spacing: 1px;
                transition: 0.3s;
            }
            .auth-btn:hover { background: #00695c; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }

            /* Updated Disclaimer Style */
            .disclaimer-box {
                margin-top: 20px; padding: 12px;
                background: rgba(255, 215, 0, 0.03);
                border: 1px dashed #554400; border-radius: 8px;
                font-size: 11px; color: #bbb; line-height: 1.5;
            }

            .footer-info { margin-top: 20px; color: #666; font-size: 10px; line-height: 1.6; }
            .highlight-name { color: #fff; font-weight: bold; }
            .reg-no { color: #00e676; }
            
            .unauth-badge {
                display: inline-block; margin-top: 8px; padding: 4px 12px;
                border: 1px solid #ff5252; color: #ff5252;
                border-radius: 4px; font-size: 9px; font-weight: bold;
                background: rgba(255, 82, 82, 0.1);
            }
            .support-line { color: #2196f3; font-weight: bold; margin-top: 5px; font-size: 11px; }
        </style>

        <div class="login-card">
            <div class="profile-circle">
                <img src="images/ali.png" alt="Ali Ibrahim Didi">
            </div>

            <div class="welcome-pill">WARM WELCOME TO</div>

            <div class="main-title">
                Rasfahi Quran Recitation <br> Judging Software
            </div>

            <p style="color:#aaa; font-size:11px; margin-bottom:5px;">Paste code: <b>Ctrl + V</b> (No Spaces)</p>
            
            <input type="password" id="secKey" class="input-box" placeholder="P a s t e   K e y   H e r e . . .">
            
            <button class="auth-btn" onclick="unlockSystem()">AUTHENTICATE</button>
            <p id="secMsg" style="color:#ff5252; margin-top:5px; font-size:11px; height:15px;"></p>

            <div class="disclaimer-box">
                <strong style="color:#FFD700; letter-spacing:0.5px;">‚ö†Ô∏è VERIFICATION REQUIRED:</strong><br>
                Please verify Quran verses against a Mushaf and <span style="color:#fff; font-weight:bold;">ensure conformity</span> of Dhivehi translations with the official government text before display.<br>
                <span style="opacity:0.6; font-style:italic; font-size:10px;">Data sourced from Tanzil.net.</span>
            </div>

            <div class="footer-info">
                Intellectual property of <span class="highlight-name">Ali Ibrahim Didi</span>.<br>
                Reg: <span class="reg-no">MED.03.IP.CR.26.EW5889</span>
                
                <div style="margin-top:5px;">
                    <div class="unauth-badge">‚õî UNAUTHORIZED USE PROHIBITED</div>
                </div>
                
                <div class="support-line">Support: 7791550 / 9901550</div>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <div class="header">
            <h1 class="app-title" data-translate="title">RASFAHI JUDGE V26.0</h1>
            <div style="font-size:10px; color:#aaa; margin-top:2px;">Ultimate Upgrade Edition</div>
        </div>

        <div class="content">
            <div class="lang-bar">
                <button class="lang-btn active" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                <button class="lang-btn" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                <button class="lang-btn" onclick="setLang('en')">English</button>
            </div>
            
            <div id="licenseDisplay" style="display:none; background:#e3f2fd; color:#00008b; text-align:center; font-weight:bold; font-size:13px; padding:8px; margin-bottom:10px; border-radius:4px; border: 1px solid #00008b;">
                Licensed To: <span id="licenseName"></span>
            </div>
            
            <div class="panel panel-live">
                <h2 data-translate="liveCtrl">1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Live)</h2>
                
                <div id="statusDisplay">WAITING...</div>
                
                <div class="mode-switch">
                    <button id="modeJudge" class="mode-btn active" onclick="setMode('judge')" data-translate="mJudge">‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)</button>
                    <button id="modeStudent" class="mode-btn" onclick="setMode('student')" data-translate="mStudent">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)</button>
                </div>

                <div class="read-switch">
                    <button id="rmMushaf" class="read-btn active" onclick="setReadingMode('mushaf')" data-translate="rmMushaf">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</button>
                    <button id="rmMemory" class="read-btn" onclick="setReadingMode('memory')" data-translate="rmMemory">üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</button>
                </div>

                <div id="judgeControls">
                    <button class="btn-gold" style="padding:12px;" onclick="pickRandomQuestion()" data-translate="btnPick">üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)</button>
                </div>

                <div id="studentControls" class="hidden">
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-blue" onclick="toggleGridScreen(true)" data-translate="btnShowGrid">1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß (Show Grid)</button>
                        <button class="btn-gold" onclick="reshuffleGrid()" data-translate="btnShuffle">üîÑ ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    </div>
                    
                    <div id="selectionInfo" style="background:#000; padding:5px; border:1px solid #444; margin:5px 0; font-size:12px; text-align:center; color:var(--gold);">
                        No selection yet.
                    </div>

                    <button id="btnStartReading" class="btn-green hidden" onclick="startReadingSession()" data-translate="btnStartQ1">2. ﬁäﬁ¶ﬁÅﬁß (Start Question 1)</button>
                </div>

                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-gold" style="width:30%;" onclick="prevQuestion()" data-translate="btnPrev">‚óÄ Previous</button>
                    <button class="btn-gold" style="flex:1;" onclick="nextQuestion()" data-translate="btnNext">Next Question ‚è©</button>
                </div>

                <div id="slotGrid"></div>

                <hr style="border-color:#334455; margin:15px 0;">

                <div style="display:flex; gap:10px;">
                    <button class="btn-green" onclick="toggleBell(true)" data-translate="btnBellStart">üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                    <button class="btn-red" onclick="toggleBell(false)" data-translate="btnBellStop">üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                </div>

                <button style="margin-top:10px; background:#442222; border:1px solid #aa3333;" onclick="resetStudentSession()" data-translate="btnReset">üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)</button>
            </div>

            <div class="panel">
                <h2 data-translate="lblSyllabus">2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)</h2>
                
                <label data-translate="lblFilterType">ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:</label>
                <select id="filterType" onchange="updateFilterUI()">
                    <option value="book" selected>By Book/Juz (ﬁäﬁÆﬁåﬁ™ﬁÇﬁ∞)</option>
                    <option value="surah">By Surah Order (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ™ﬁÇﬁ∞)</option>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label id="lblStartVal">ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start):</label>
                        <input type="number" id="scopeStart" value="1" placeholder="Start">
                    </div>
                    <div>
                        <label id="lblEndVal">ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End):</label>
                        <input type="number" id="scopeEnd" value="30" placeholder="End">
                    </div>
                </div>

                <button class="btn-green" onclick="applySyllabusFilter()" style="margin-top:10px;">‚úÖ Apply Syllabus</button>
                <div id="scopeStatus" style="font-size:11px; color:#aaa; margin-top:5px; text-align:center;">
                    System contains all questions.
                </div>
            </div>

            <div class="panel">
                <h2 data-translate="screens">3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</h2>
                
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn-blue" onclick="saveConfig()">üíæ SAVE Config</button>
                    <button class="btn-orange" onclick="document.getElementById('loadConf').click()">üìÇ LOAD Config</button>
                    <input type="file" id="loadConf" accept=".json" class="hidden" onchange="loadConfig(this)">
                </div>

                <button class="btn-red" onclick="clearCache()" style="font-size:10px; margin-bottom:10px;">üßπ Purge Memory (Clear Cache)</button>

                <label data-translate="lblStudent">1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:</label>
                <button onclick="openScreen('student')" class="btn-purple" data-translate="btnLaunchStudent">üñ•Ô∏è Student Screen (Launch)</button>

                <label data-translate="lblJudge">2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ (Manual Entry):</label>
   <div style="display:flex; gap:5px;">
        <select id="targetJudgeSelect" style="width:50%;">
            <option value="1">Judge 1</option>
            <option value="2">Judge 2</option>
            <option value="3">Judge 3</option>
            <option value="4">Judge 4</option>
            <option value="5">Judge 5</option>
            <option value="6">Judge 6</option>
            <option value="7">Judge 7</option>
        </select>
        
        <button onclick="openSingleJudge()" class="btn-blue" data-translate="btnLaunchJudges">
            Open Screen üñ•Ô∏è
        </button>
    </div>

    <div style="margin-top:10px; padding:5px; border:1px dashed #334455; background:#000;">
        <small style="color:#aaa; display:block; margin-bottom:5px;">Set Judge Names (Optional):</small>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="jName1" placeholder="Judge 1 Name">
            <input type="text" id="jName2" placeholder="Judge 2 Name">
            <input type="text" id="jName3" placeholder="Judge 3 Name">
            <input type="text" id="jName4" placeholder="Judge 4 Name">
            <input type="text" id="jName5" placeholder="Judge 5 Name">
            <input type="text" id="jName6" placeholder="Judge 6 Name">
            <input type="text" id="jName7" placeholder="Judge 7 Name">
        </div>
    </div>
    </div>

<div class="panel">
                <h2 data-translate="settings">4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß</h2>
                
               <label style="color:#00e676;">‚òÖ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁêﬁ∞ﬁìﬁØﬁçﬁ∞ (App Font):</label>
<div style="display:flex; gap:5px;">
    <input type="file" id="fontLoader" accept=".ttf,.otf,.woff,.woff2" style="border-color:#00e676;">
    
    <a href="https://drive.google.com/drive/folders/1t39hcv1wEn22fEJVn7jDc5SupKhJ1CYo?usp=sharing" 
       target="_blank" 
       class="btn-green" 
       style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #00e676;">
       ‚¨áÔ∏è Download Font
    </a>
</div>
<small style="color:#666; font-size:10px;">Select .TTF or .WOFF file for Faruuma/Waheed</small>
                
                <hr style="border-color:#333; margin:8px 0;">

                <label>1. Royal Theme Engine (Main App):</label>
                <select id="themeSelect" onchange="updateTheme()">
                    </select>

                <label data-translate="lblCSV">2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="csvQ" accept=".csv">
                    <a href="QuranQuestionBank.html" target="_blank" class="btn-purple" style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #7c4dff;">
                        ‚¨áÔ∏è Sample / Bank
                    </a>
                </div>
                
                <label data-translate="lblImg">3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ (Folder):</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="imgF" webkitdirectory directory multiple>
                    <a href="https://drive.google.com/drive/folders/1ihATXy_TIQZOU5qlXll-5c7SbNRdpsPO?usp=sharing" 
                       target="_blank" 
                       class="btn-blue" 
                       style="width:40%; font-size:10px; text-decoration:none; display:flex; align-items:center; justify-content:center; color:white; border-radius:4px; font-weight:bold; border:1px solid #0059b3;">
                       ‚¨áÔ∏è Download Images
                    </a>
                </div>
                <small id="imgStatus" style="color:#aaa; display:block;">No images loaded</small>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label data-translate="lblBorder">ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:</label>
                        <select id="borderStyle" onchange="syncWindows()">
                            <option value="royal">Royal Frame</option>
                            <option value="custom">Custom Img</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div>
                        <label data-translate="lblQCount">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:</label>
                        <select id="qLimit" onchange="resetStudentSession()">
                            <script>
                                for(let i=1; i<=20; i++) document.write(`<option value="${i}" ${i===3?'selected':''}>${i}</option>`);
                            </script>
                        </select>
                    </div>
                </div>
                <input type="file" id="borderImg" accept="image/*" class="hidden" style="margin-top:5px;">
            </div>
            
           <div class="panel">
    <h2 style="color:#ff9800;">5. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ (Student Info)</h2>
    
    <label>1. Bulk Import (Master Sheet CSV):</label>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="file" id="batchCsv" accept=".csv">
        <button class="btn-blue" onclick="loadStudentBatch()">Load Batch</button>
    </div>

    <div style="display:flex; gap:5px;">
        <button class="btn-purple" onclick="downloadMasterCSVTemplate()" style="flex:1; font-size:11px;">
            ‚¨áÔ∏è Blank Template
        </button>
        <button class="btn-orange" onclick="generateDummyMasterSheet()" style="flex:1; font-size:11px;">
            ü§ñ Generate Fake Data
        </button>
    </div>
    <small style="color:#aaa;">Use Fake Data to test the Master Sheet format.</small>

    <hr style="border-color:#333; margin:8px 0;">
    
  <label>2. Select Student (Search & Select):</label>
    
    <input list="studentDatalist" id="studentSearchInput" 
           placeholder="üîç ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß..." 
           onchange="onStudentSelected(this.value)"
           style="margin-bottom:5px; border:1px solid #FFD700; background:#001a33; color:#fff; font-weight:bold;">
           
    <datalist id="studentDatalist"></datalist>
    <div style="margin-top:10px; border:1px dashed #444; padding:5px;">
        <label>Personal Details:</label>
        <input type="text" id="stdName" placeholder="ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞ (Full Name)">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="stdID" placeholder="ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© (ID Card)">
            <input type="text" id="stdReg" placeholder="ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ© (Reg No)">
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <select id="stdGender">
                <option value="Male">ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞ (Male)</option>
                <option value="Female">ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞ (Female)</option>
            </select>
            <input type="text" id="stdPhone" placeholder="ﬁäﬁØﬁÇﬁ™ (Contact)">
        </div>

        <input type="text" id="stdAddr" placeholder="ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞ (Address)">

        <label style="margin-top:5px;">Competition Details:</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <select id="stdGroup">
                <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
                <option value="General">ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®</option>
            </select>
            <input type="text" id="stdBranch" placeholder="ﬁéﬁÆﬁäﬁ® (Branch)">
        </div>
        <input type="text" id="stdInst" placeholder="ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß (Institution)">

        <label style="margin-top:5px;">Parent Info:</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="text" id="stdParent" placeholder="ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß (Parent)">
            <input type="text" id="stdParentPhone" placeholder="ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™">
        </div>
        <input type="text" id="stdEmail" placeholder="ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞ (Email)">

        <button class="btn-green" style="margin-top:10px;" onclick="registerStudent()">üíæ Register & Set Active</button>
    </div>
    
    <p style="font-size:10px; color:#aaa; margin-top:5px;" id="currentStdLabel">No student active.</p>
</div>
            
            <div class="panel">
                <h2 style="color:#ff4081;">7. ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ®ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁ¶ﬁàﬁßﬁáﬁ®ﬁãﬁ™ (Rubric)</h2>
                
                <label>1. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁëﬁ®ﬁëﬁ¶ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞:</label>
                <input type="text" id="deductionStepsInput" value="0.25, 0.5, 1, 2" placeholder="e.g. 0.5, 1, 2" onchange="updateDeductionSteps()">
                <small style="color:#aaa;">Comma separated values for deduction buttons</small>
                
                <hr style="border-color:#333; margin:8px 0;">

                <label>2. ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁáﬁ∞ (Categories & Max Marks):</label>
                <div id="rubricConfigList"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="newRubricName" placeholder="New Category Name">
                    <input type="number" id="newRubricMax" placeholder="Max" style="width:60px;">
                    <button class="btn-blue" style="width:40px;" onclick="addRubricItem()">+</button>
                </div>
                <button class="btn-gold" style="margin-top:5px; font-size:11px;" onclick="syncWindows()">üîÑ Update Judges Screens</button>
            </div>

            <div class="panel" style="border:1px solid #00acc1; box-shadow:inset 0 0 10px rgba(0,172,193,0.1);">
    <h2 style="color:#00e5ff;">8. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß & ﬁÉﬁ®ﬁïﬁØﬁìﬁ∞ (Advanced Reports)</h2>

    <div style="background:#002200; padding:10px; border-radius:4px; margin-bottom:10px;">
        <h4 style="margin:0; color:#fff;">Current Session Scores:</h4>
        <div id="adminScoreMonitor" style="font-size:12px; color:#aaa; margin-top:5px;">Waiting for judges...</div>
        <button class="btn-green" id="btnFinalize" style="margin-top:5px;" onclick="finalizeStudentResult()">‚úÖ Save Student Result</button>
    </div>

    <hr style="border-color:#333; margin:8px 0;">

    <label style="color:#FFD700;">1. Report Headers (ﬁÉﬁ®ﬁïﬁØﬁìﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™):</label>
    <input type="text" id="rptInstName" placeholder="Institution Name (e.g. Madharusathul Arabiyya)">
    <input type="text" id="rptCompName" placeholder="Competition Name (e.g. Quran Mubaaraaiy 1446)" style="margin-top:2px;">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
        <input type="text" id="rptChief" placeholder="Chief Judge Name">
        <select id="rptJudgeCount">
            <option value="3">3 Signature Lines</option>
            <option value="5">5 Signature Lines</option>
            <option value="7">7 Signature Lines</option>
        </select>
    </div>

    <hr style="border-color:#333; margin:8px 0;">

    <label style="color:#FFD700;">2. Filter Category (ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ© ﬁÇﬁ¶ﬁéﬁß):</label>
    <div style="display:flex; gap:5px; flex-wrap:wrap;">
        <select id="rptFilterBranch" style="flex:1;">
            <option value="All">All Branches (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁéﬁÆﬁåﬁ∞ﬁïﬁ¨ﬁáﬁ∞)</option>
            <option value="Balaiygen">Balaiygen (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</option>
            <option value="Nubalai">Nubalai (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</option>
        </select>
        
        <select id="rptFilterGroup" style="flex:1;">
            <option value="All">All Ages (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ¨ﬁáﬁ∞)</option>
            <option value="Under 6">6 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 9">9 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 11">11 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 13">13 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 16">16 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="Under 19">19 ﬁáﬁ¶ﬁÄﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁãﬁ¶ﬁÅﬁ∞</option>
            <option value="General">General (ﬁ¢ﬁßﬁáﬁ∞ﬁâﬁ™)</option>
        </select>

        <select id="rptFilterInstType" style="flex:1;">
            <option value="All">All Inst. (ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß)</option>
            <option value="School">Schools Only</option>
            <option value="Office">Offices Only</option>
            <option value="NGO">NGOs Only</option>
            <option value="University">Universities</option>
            <option value="Private">Private</option>
        </select>
    </div>
    <label style="margin-top:10px;">3. Generate Report (PDF / Print):</label>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
        <button class="btn-orange" onclick="generateAdvancedReport('top3')">ü•â Top 3</button>
        <button class="btn-cyan" onclick="generateAdvancedReport('top5')">üèÜ Top 5</button>
        <button class="btn-purple" onclick="generateAdvancedReport('all')">üìÑ Full List</button>
    </div>

    <label style="margin-top:5px;">4. Downloads:</label>
    <button class="btn-blue" onclick="exportFilteredCSV()">üì• Download Filtered CSV</button>

    <hr style="border-color:#333; margin:8px 0;">
    
    <button class="btn-green" onclick="exportMasterResultSheet()">üì• Export FULL Master CSV</button>
    
    <button class="btn-gold" style="margin-top:5px;" onclick="downloadManualScoreSheet()">üìÑ Print Blank Sheet (PDF)</button>
    <hr style="border-color:#333; margin:8px 0;">
    <label style="color:#FFD700; font-family:'Faruuma';">‚òÖ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁùﬁ©ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (ﬁÑﬁ¶ﬁçﬁ∞ﬁÜﬁ™ ﬁïﬁ∞ﬁÉﬁ®ﬁÇﬁ∞ﬁìﬁ∞):</label>
    <div style="background:#111; padding:10px; border:1px dashed #444; border-radius:5px;">
        <select id="bulkJudgeSelect" style="margin-bottom:5px;">
            <option value="Judge_1">Judge 1 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 1)</option>
            <option value="Judge_2">Judge 2 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 2)</option>
            <option value="Judge_3">Judge 3 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 3)</option>
            <option value="Judge_4">Judge 4 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 4)</option>
            <option value="Judge_5">Judge 5 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 5)</option>
            <option value="Judge_6">Judge 6 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 6)</option>
            <option value="Judge_7">Judge 7 (ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ 7)</option>
        </select>
        <button class="btn-green" onclick="printBulkJudgeSheets()">
            üñ®Ô∏è Print All Sheets (PDF)
        </button>
    </div>
    <button class="btn-red" style="font-size:10px; margin-top:5px;" onclick="clearAllResults()">Reset All Data</button>
</div>

            <div class="panel" style="border:1px solid #00acc1; box-shadow:inset 0 0 10px rgba(0,172,193,0.1);">
                <h2 style="color:#00e5ff;">6. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁäﬁ¨ﬁÅﬁ™ﬁÇﬁ∞ (Ceremony)</h2>
                
                <label>1. ﬁöﬁßﬁáﬁ∞ﬁûﬁ¶ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (Special Fonts):</label>
                <div style="display:flex; gap:5px; align-items:flex-start;">
                    <div style="flex:1;">
                        <input type="file" id="ceremonyQuranFont" accept=".ttf,.otf" style="margin-bottom:5px;">
                        <small style="color:#aaa; display:block; margin-bottom:5px;">Quran Font (e.g., Tanzil/Madina)</small>
                        
                        <input type="file" id="ceremonyTransFont" accept=".ttf,.otf">
                        <small style="color:#aaa; display:block;">Translation Font (e.g., Faruuma)</small>
                    </div>
                </div>
                
                <hr style="border-color:#333; margin:8px 0;">
                
                <label>2. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="file" id="ceremonyCSV" accept=".csv">
                </div>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="color:#FFD700;">‚òÖ ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁß ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ (Styles):</label>
                
                <div style="margin-bottom:8px;">
                    <small style="color:#aaa;">Ceremony Theme (20+ Royal Styles):</small>
                    <select id="ceremonyTheme" onchange="updateCeremonyState()">
                        <script>
                            const cThemes = [
                                "1. Royal Green (Gold Border)", "2. Royal Blue (Gold Border)", "3. Royal Red (Gold Border)",
                                "4. Emerald Green (Double Gold)", "5. Midnight Blue (Silver)", "6. Burgundy (Gold)",
                                "7. Green & Blue Mix", "8. Red & Black Mix", "9. Deep Purple",
                                "10. White & Gold (Light)", "11. Cream & Gold", "12. Black & Gold (Thin)",
                                "13. Green Gradient (Silver)", "14. Blue Gradient (Silver)", "15. Red Gradient (Silver)",
                                "16. Royal Teal", "17. Majestic Maroon", "18. Onyx Black (White)",
                                "19. Pearl White (Green)", "20. Presidential Mix"
                            ];
                            cThemes.forEach((t, i) => document.write(`<option value="${i}">${t}</option>`));
                        </script>
                    </select>
                </div>

                <div style="margin-top:8px; margin-bottom:8px; border-top:1px dashed #333; padding-top:5px;">
                    <label style="color:#FFD700;">‚òÖ ﬁêﬁ¨ﬁÉﬁ¶ﬁâﬁ¶ﬁÇﬁ© ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞:</label>
                    <select id="cBorderStyle" onchange="updateCeremonyState()">
                        <option value="theme">Use Theme Border (Default)</option>
                        <option value="thin">Very Thin Gold Line (ﬁÄﬁ®ﬁâﬁ¶ ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÉﬁÆﬁÇﬁéﬁ¨ﬁáﬁ∞)</option>
                        <option value="none">No Border (ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁçﬁß)</option>
                        <option value="custom">Custom Image Border (ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁÆﬁìﬁØ)</option>
                    </select>
                    
                    <input type="file" id="cBorderImgFile" accept="image/*" style="margin-top:5px;" onchange="loadCeremonyBorder(this)">
                </div>

                <div class="control-row">
                    <input type="color" id="cArabicColor" value="#D4AF37" class="color-picker" onchange="updateCeremonyState()" title="Arabic Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Arabic Size (ﬁ¢ﬁ¶ﬁÉﬁ¶ﬁÑﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cArabicSize" class="range-slider" min="5" max="25" step="0.5" value="12" oninput="updateCeremonyState()">
                    </div>
                </div>

                <div class="control-row">
                    <input type="color" id="cTransColor" value="#ffffff" class="color-picker" onchange="updateCeremonyState()" title="Translation Text Color">
                    <div style="flex:1;">
                        <small style="color:#aaa;">Dhivehi Size (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ® ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞)</small>
                        <input type="range" id="cTransSize" class="range-slider" min="2" max="15" step="0.5" value="5" oninput="updateCeremonyState()">
                    </div>
                </div>

                <hr style="border-color:#333; margin:8px 0;">

                <label style="margin-top:10px; color:#00e5ff;">3. ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞ ﬁêﬁ¨ﬁçﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ (Selection):</label>
                
                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Surah (ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞):</small>
                    <select id="cSurah" onchange="onSurahChange()">
                        <option value="">-- Select Surah --</option>
                    </select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Start Ayah No (ﬁäﬁ¶ﬁÅﬁß ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cStart" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">End Ayah No (ﬁÇﬁ®ﬁâﬁ≠ ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™):</small>
                    <select id="cEnd" onchange="onRangeChange()"></select>
                </div>

                <div style="margin-bottom:5px;">
                    <small style="color:#aaa;">Translation Language:</small>
                    <select id="cLang" onchange="onRangeChange()">
                        <option value="dv">Dhivehi (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)</option>
                        <option value="en">English (ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ®)</option>
                    </select>
                </div>

                <label>4. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ (Event Title):</label>
                <input type="text" id="ceremonyTitle" placeholder="e.g. Quran Competition Opening" oninput="updateCeremonyState()">

                <button onclick="openCeremonyScreen()" class="btn-orange" style="margin-top:10px;">üì∫ Launch Ceremony Screen</button>

                <hr style="border-color:#333; margin:10px 0;">
                
                <div style="background:#000; padding:10px; border-radius:4px; text-align:center;">
                    <div id="ceremonyPreview" style="color:var(--gold); font-size:14px; margin-bottom:5px;">IDLE</div>
                    <div style="display:flex; gap:5px; justify-content:center;">
                         <button class="btn-blue" onclick="ceremonyPrev()">‚óÄ</button>
                         <button class="btn-blue" onclick="ceremonyNext()">‚ñ∂</button>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-top:5px;">
                      <button class="btn-green" onclick="ceremonySetPhase('start')">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</button>
                      <button class="btn-red" onclick="ceremonySetPhase('end')">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè</button>
                </div>
                <button class="btn-gold" style="margin-top:5px;" onclick="ceremonySetPhase('cover')">Show Cover / Hide</button>

            </div>
        </div>

        <div class="royal-footer">
            <a id="driveLink" href="#" target="_blank" class="drive-btn">
                üìÇ Open Google Drive Folder (Samples)
            </a>

            <p>Copyright Reserved</p>
            <p class="highlight">Ali Ibrahim Didi 7791550 & 9901550</p>
            <p>Zad Research and Consultancy Firm</p>
        </div>
    </div>

    <div class="main-view">
        <div class="mirror-header">
            <span>LIVE VIEW (ADMIN MONITOR)</span>
            <span id="mirrorStatus" style="color:var(--gold);">IDLE</span>
        </div>
        
        <div id="adminMirror">
            <div id="gridPreview"></div>

            <div id="mirrorContainer" class="mirror-card" style="display:flex;">
                
                <div id="adminBanner" class="mirror-banner-strip" style="display:none;">
                    <span>Book: <span id="mBook" class="mirror-info-span">-</span></span>
                    <span>Surah: <span id="mSurah" class="mirror-info-span">-</span></span>
                    <span>Ayah: <span id="mAyah" class="mirror-info-span">-</span></span>
                </div>

                <div class="mirror-img-container">
                    <img id="mImg" src="" style="display:none;">
                    
                    <h1 id="mMemoryText" style="display:none; color: var(--gold); text-align:center; font-size: 30px; margin-top: 20%;">
                        (Memory Recitation Mode)
                    </h1>

                    <h2 id="mReadyText" style="display:none; color:#00e676; text-align:center; margin-top:20%;">READY TO START</h2>
                    <h1 id="mFinishText" style="display:none; color:#ff5252; text-align:center; margin-top:20%; font-size:24px;"></h1>
                </div>

                <div id="adminWarn" style="position:absolute; bottom:5px; left:5px; color:#ff5252; font-size:11px; display:none; background:rgba(0,0,0,0.8); padding:2px;">‚ö†Ô∏è MEMORY MODE</div>
            </div>
            
            <div id="mirrorLight" style="position:absolute; bottom:20px; right:100px; width:30px; height:30px; background:#333; border-radius:50%; border:2px solid #555;"></div>

            <button id="royalFSBtn" onclick="toggleAppFullscreen()" title="Full Screen">‚õ∂</button>
        </div>
    </div>

<script>
    // --- 0. SURAH LIST FOR FILTERING ---
    const SURAH_NAMES = [
        "al-fatiha", "al-baqarah", "ali 'imran", "an-nisa", "al-ma'idah", "al-an'am", "al-a'raf", "al-anfal", "at-tawbah", "yunus",
        "hud", "yusuf", "ar-ra'd", "ibrahim", "al-hijr", "an-nahl", "al-isra", "al-kahf", "maryam", "ta-ha",
        "al-anbiya", "al-hajj", "al-mu'minun", "an-nur", "al-furqan", "ash-shu'ara", "an-naml", "al-qasas", "al-ankabut", "ar-rum",
        "luqman", "as-sajdah", "al-ahzab", "saba", "fatir", "ya-sin", "as-saffat", "sad", "az-zumar", "ghafir",
        "fussilat", "ash-shura", "az-zukhruf", "ad-dukhan", "al-jathiyah", "al-ahqaf", "muhammad", "al-fath", "al-hujurat", "qaf",
        "adh-dhariyat", "at-tur", "an-najm", "al-qamar", "ar-rahman", "al-waqi'ah", "al-hadid", "al-mujadila", "al-hashr", "al-mumtahanah",
        "as-saff", "al-jumu'ah", "al-munafiqun", "at-taghabun", "at-talaq", "at-tahrim", "al-mulk", "al-qalam", "al-haqqah", "al-ma'arij",
        "nuh", "al-jinn", "al-muzzammil", "al-muddaththir", "al-qiyamah", "al-insan", "al-mursalat", "an-naba", "an-nazi'at", "abasa",
        "at-takwir", "al-infitar", "al-mutaffifin", "al-inshiqaq", "al-buruj", "at-tariq", "al-a'la", "al-ghashiyah", "al-fajr", "al-balad",
        "ash-shams", "al-layl", "ad-duha", "ash-sharh", "at-tin", "al-alaq", "al-qadr", "al-bayyinah", "az-zalzalah", "al-adiyat",
        "al-qari'ah", "at-takathur", "al-asr", "al-humazah", "al-fil", "quraysh", "al-ma'un", "al-kawthar", "al-kafirun", "an-nasr",
        "al-masad", "al-ikhlas", "al-falaq", "an-nas"
    ];

    // --- 0. SECURITY & CONFIG ---
    const GOOGLE_DRIVE_URL = "https://drive.google.com/drive/folders/YOUR_FOLDER_ID"; 
    document.getElementById('driveLink').href = GOOGLE_DRIVE_URL;

    // --- FONT LOADING ---
    document.getElementById('fontLoader').onchange = e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            state.fontData = evt.target.result;
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }`;
            document.head.appendChild(style);
            alert("Font Loaded Successfully! (Syncing to screens...)");
            saveToLocal();
            syncWindows();
        };
        reader.readAsDataURL(file);
    };

    // --- TRANSLATION DICTIONARY ---
    const i18n = {
        title: { dv: "ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ∞ V26.0", ar: "ÿßŸÑŸÇÿßÿ∂Ÿä ÿ±ÿµŸÅŸáŸä V26.0", en: "Rasfahi Judge V26.0" },
        lblSyllabus: { dv: "2. ﬁâﬁ™ﬁ§ﬁ¶ﬁáﬁ∞ﬁÉﬁ¶ﬁÉﬁ™ (Syllabus Scope)", ar: "2. ÿßŸÑŸÖŸÜŸáÿ¨", en: "2. Syllabus Scope" },
        lblFilterType: { dv: "ﬁäﬁ®ﬁçﬁ∞ﬁìﬁ¶ﬁÉ ﬁÜﬁ™ﬁÉﬁßﬁéﬁÆﬁåﬁ∞:", ar: "ŸÜŸàÿπ ÿßŸÑÿ™ÿµŸÅŸäÿ©:", en: "Filter Mode:" },
        liveCtrl: { dv: "1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", ar: "1. ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±", en: "1. Live Control" },
        mJudge: { dv: "‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)", ar: "‚öñÔ∏è Ÿàÿ∂ÿπ ÿßŸÑŸÇÿßÿ∂Ÿä (ÿ™ŸÑŸÇÿßÿ¶Ÿä)", en: "‚öñÔ∏è Judge Mode (Auto)" },
        mStudent: { dv: "üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)", ar: "üéì Ÿàÿ∂ÿπ ÿßŸÑÿ∑ÿßŸÑÿ® (ŸäÿØŸàŸä)", en: "üéì Student Mode (Manual)" },
        rmMushaf: { dv: "üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)", ar: "üìñ ÿßŸÑŸÖÿµÿ≠ŸÅ (ŸÜÿ∏ÿ±)", en: "üìñ Mushaf (Reading)" },
        rmMemory: { dv: "üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)", ar: "üß† ÿßŸÑÿ≠ŸÅÿ∏ (ÿ∫Ÿäÿ®)", en: "üß† Memory (Recital)" },
        btnPick: { dv: "üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)", ar: "üé≤ ÿßÿÆÿ™ÿ± ÿ≥ÿ§ÿßŸÑÿßŸã (ÿπÿ¥Ÿàÿßÿ¶Ÿä)", en: "üé≤ Pick Question (Random)" },
        btnShowGrid: { dv: "1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß", ar: "1. ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ®ŸÉÿ©", en: "1. Show Grid" },
        btnShuffle: { dv: "üîÑ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠", ar: "üîÑ ÿÆŸÑÿ∑", en: "üîÑ Shuffle" },
        btnStartQ1: { dv: "2. ﬁäﬁ¶ﬁÅﬁß (Start Q1)", ar: "2. ÿßÿ®ÿØÿ£ (ÿ≥ÿ§ÿßŸÑ 1)", en: "2. Start (Q1)" },
        btnPrev: { dv: "‚óÄ ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨", ar: "‚óÄ ÿßŸÑÿ≥ÿßÿ®ŸÇ", en: "‚óÄ Prev" },
        btnNext: { dv: "ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ‚è©", ar: "ÿßŸÑÿ™ÿßŸÑŸä ‚è©", en: "Next ‚è©" },
        btnBellStart: { dv: "üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üîî ÿßÿ®ÿØÿ£ (ÿ¨ÿ±ÿ≥)", en: "üîî Start (Bell)" },
        btnBellStop: { dv: "üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üõë ÿ™ŸàŸÇŸÅ (ÿ¨ÿ±ÿ≥)", en: "üõë Stop (Bell)" },
        btnReset: { dv: "üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)", ar: "üîÑ ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ (ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ)", en: "üîÑ New Student (Reset)" },
        screens: { dv: "3. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ & ﬁÜﬁÆﬁÇﬁ∞ﬁäﬁ®ﬁéﬁ¶ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞", ar: "3. ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™", en: "3. Screens & Config" },
        lblStudent: { dv: "1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "1. ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:", en: "1. Student Screen:" },
        btnLaunchStudent: { dv: "üñ•Ô∏è ﬁçﬁØﬁÇﬁ∞ﬁóﬁ∞ (Student)", ar: "üñ•Ô∏è ŸÅÿ™ÿ≠ (ÿßŸÑÿ∑ÿßŸÑÿ®)", en: "üñ•Ô∏è Launch (Student)" },
        lblJudge: { dv: "2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "2. ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇÿßÿ∂Ÿä:", en: "2. Judge Screen:" },
        btnLaunchJudges: { dv: "Open Judges üöÄ", ar: "ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ∂ÿßÿ© üöÄ", en: "Open Judges üöÄ" },
        settings: { dv: "4. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁëﬁ≠ﬁìﬁß", ar: "4. ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™", en: "4. Settings & Data" },
        lblCSV: { dv: "2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):", ar: "2. ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (CSV):", en: "2. Question Data (CSV):" },
        lblImg: { dv: "3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ:", ar: "3. ÿµŸàÿ± ÿßŸÑÿ¢Ÿäÿßÿ™:", en: "3. Ayah Images:" },
        lblBorder: { dv: "ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:", ar: "ÿßŸÑÿ•ÿ∑ÿßÿ±:", en: "Border:" },
        lblQCount: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:", ar: "ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©:", en: "Question Count:" },
        msgFinished: { 
            dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", 
            ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", 
            en: "Questioning complete for the current limit!" 
        }
    };

    let currentLang = 'dv';
    let themeList = [];

    // --- 1. THEME ENGINE ---
    function initThemes() {
        const bases = [
            {n:"Royal Blue", c1:"#001a33", c2:"#000d1a", txt:"#ffffff"},
            {n:"Emerald Green", c1:"#002b15", c2:"#001a0d", txt:"#e6ffe6"},
            {n:"Burgundy Red", c1:"#2a0000", c2:"#1a0000", txt:"#ffe6e6"},
            {n:"Midnight Black", c1:"#111111", c2:"#000000", txt:"#ffffff"},
            {n:"Imperial Purple", c1:"#1a0033", c2:"#0d001a", txt:"#f2e6ff"}
        ];
        const accents = [
            {n:"Gold", c:"#D4AF37", b:"double"},
            {n:"Silver", c:"#C0C0C0", b:"ridge"},
            {n:"Bronze", c:"#cd7f32", b:"groove"},
            {n:"White Gold", c:"#f5f5dc", b:"solid"}
        ];

        const sel = document.getElementById('themeSelect');
        sel.innerHTML = ""; 
        let count = 1;
        
        bases.forEach(base => {
            accents.forEach(acc => {
                for(let i=1; i<=5; i++) { 
                     let variantName = i === 1 ? "Standard" : (i===2 ? "Dark" : (i===3 ? "Deep" : (i===4 ? "Vivid" : "Classic")));
                     let themeObj = {
                        name: `Theme ${count}: ${base.n} & ${acc.n} (${variantName})`,
                        bg1: base.c1, bg2: base.c2,
                        accent: acc.c, borderType: acc.b, text: base.txt,
                        id: count
                    };
                    themeList.push(themeObj);
                    let opt = document.createElement('option');
                    opt.value = count-1;
                    opt.innerText = themeObj.name;
                    sel.appendChild(opt);
                    count++;
                }
            });
        });
        
        if(themeList.length > 0) {
            state.theme = themeList[0];
            sel.value = 0;
        }
    }

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
        document.querySelector('.sidebar').style.borderLeft = (lang === 'en') ? 'none' : '3px solid var(--gold)';

        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if(i18n[key] && i18n[key][lang]) {
                el.innerText = i18n[key][lang];
            }
        });
        updateFilterUI();
        if(i18n.msgFinished[lang]) {
            document.getElementById('mFinishText').innerHTML = i18n.msgFinished[lang].replace(/\n/g, '<br>');
        }
        syncWindows();
    }

    function toggleAppFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
        } else {
            document.exitFullscreen();
        }
    }

    // --- STATE ---
    let state = {
        qPool: [],         
        filteredPool: [], 
        qUsed: [], qDataMap: {}, 
        pImages: {}, 
        fontData: null, borderData: null,
        windows: { student: null, judges: [], ceremony: null },
        session: { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false },
        mode: 'judge', readingMode: 'mushaf',
        grid: { map: {}, visible: false, taken: [] },
        theme: null,
        
        // Data Management
        allStudents: [], // Loaded from Batch CSV
        
        // Syllabus State
        syllabus: {
            active: false,
            type: 'book', 
            start: 1,
            end: 30
        },

        // Judging Data
        judging: {
            currentStudentObj: null,
            liveScores: {}, // { "Judge_1": 95, "Judge_2": 90 }
            savedResults: [], // Array of final student records
            deductionSteps: [0.25, 0.5, 1, 2], // Configurable deduction buttons
            rubric: [
                { name: "ﬁåﬁ®ﬁçﬁßﬁàﬁ¶ﬁåﬁ™ (Thilawa)", max: 30 },
                { name: "ﬁåﬁ¶ﬁñﬁ™ﬁàﬁ©ﬁãﬁ™ (Tajweed)", max: 20 },
                { name: "ﬁâﬁ¶ﬁöﬁ∞ﬁÉﬁ¶ﬁñﬁ∞ (Makhraj)", max: 20 },
                { name: "ﬁûﬁ®ﬁäﬁ¶ (Sifa)", max: 10 },
                { name: "ﬁäﬁ¶ﬁûﬁßﬁôﬁß (Fasaha)", max: 10 },
                { name: "ﬁåﬁ¶ﬁçﬁ¶ﬁáﬁ∞ﬁäﬁ™ﬁíﬁßﬁáﬁ® ﬁáﬁ¶ﬁãﬁß (Talaffuz)", max: 5 },
                { name: "ﬁâﬁ¶ﬁ§ﬁßﬁâﬁßﬁåﬁ™ (Maqamat)", max: 5 }
            ]
        },

        // Ceremony Data
        ceremony: {
            active: false,
            phase: 'cover',
            groupedData: {}, 
            activeData: [], 
            currentIndex: 0,
            selectedLang: 'dv',
            fonts: { quran: null, trans: null },
            settings: {
                themeIndex: 0,
                arabicColor: '#D4AF37',
                transColor: '#ffffff',
                arabicSize: 12,
                transSize: 5,
                borderStyle: 'theme',
                borderData: null      
            }
        }
    };

    // --- AUTO SAVE LOGIC ---
    function saveToLocal() {
        const d = {
            rubric: state.judging.rubric,
            savedResults: state.judging.savedResults,
            deductionSteps: state.judging.deductionSteps,
            allStudents: state.allStudents,
            header: document.getElementById('rptHeader').value,
            footer: document.getElementById('rptFooter').value
        };
        localStorage.setItem('rasfahi_v26_data', JSON.stringify(d));
        
        // Show indicator
        const ind = document.getElementById('autoSaveStatus');
        ind.style.opacity = 1;
        setTimeout(() => { ind.style.opacity = 0; }, 2000);
    }

    function loadFromLocal() {
        const raw = localStorage.getItem('rasfahi_v26_data');
        if(raw) {
            try {
                const d = JSON.parse(raw);
                if(d.rubric) state.judging.rubric = d.rubric;
                if(d.savedResults) state.judging.savedResults = d.savedResults;
                if(d.deductionSteps) state.judging.deductionSteps = d.deductionSteps;
                if(d.allStudents) { state.allStudents = d.allStudents; populateStudentSelector(); }
                if(d.header) document.getElementById('rptHeader').value = d.header;
                if(d.footer) document.getElementById('rptFooter').value = d.footer;
                
                // Update Inputs
                document.getElementById('deductionStepsInput').value = state.judging.deductionSteps.join(', ');
                renderRubricConfig();
                console.log("Auto-loaded data from LocalStorage");
            } catch(e) { console.error("Error loading local data", e); }
        }
    }

    // --- ADVANCED SECURITY UNLOCK (NEW) ---
    function unlockSystem() {
        const inputKey = document.getElementById('secKey').value.trim();
        const msg = document.getElementById('secMsg');

        // Backdoor for testing (ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁâﬁ®ﬁÑﬁ¶ﬁáﬁ® ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß: ADMIN-OVERRIDE ﬁñﬁ¶ﬁÄﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁàﬁ¶ﬁãﬁ¨ﬁàﬁ≠ﬁÇﬁ¨)
        if (inputKey === "ADMIN-OVERRIDE") {
            grantAccess("Administrator");
            return;
        }

        if (!inputKey) {
            msg.innerText = "‚ö†Ô∏è Please enter a license key.";
            return;
        }

        try {
            // 1. ﬁÜﬁØﬁëﬁ™ ﬁëﬁ®ﬁÜﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (Base64 Decode)
            const decoded = atob(inputKey); 
            
            // ﬁÜﬁØﬁëﬁ™ ﬁÄﬁ¨ﬁãﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁéﬁÆﬁåﬁ∞: "ROYAL_EXP_YYYY-MM-DD_CUST_Name"
            const parts = decoded.split('_');

            // 2. ﬁÜﬁØﬁëﬁ™ﬁéﬁ¨ ﬁäﬁØﬁâﬁ¨ﬁìﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            if (parts.length < 5 || parts[0] !== "ROYAL" || parts[1] !== "EXP") {
                throw new Error("Invalid License Format");
            }

            // 3. ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁÄﬁ¶ﬁâﬁ¶ﬁàﬁ¨ﬁäﬁ¶ﬁáﬁ®ﬁàﬁ≠ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
            const expDateString = parts[2]; // YYYY-MM-DD
            const expDate = new Date(expDateString);
            const today = new Date();
            
            // ﬁéﬁ¶ﬁëﬁ® ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞ ﬁÑﬁ¨ﬁçﬁ™ﬁâﬁ¶ﬁÅﬁ∞
            today.setHours(0,0,0,0);
            
            if (expDate < today) {
                msg.innerText = "‚ùå License Expired on: " + expDateString;
                return;
            }

            // 4. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
            const custName = parts[4].replace(/-/g, ' '); // ﬁÇﬁ¶ﬁâﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÉﬁ® "-" ﬁäﬁ®ﬁçﬁ™ﬁàﬁ¶ﬁáﬁ®ﬁçﬁ™ﬁÇﬁ∞

            // 5. ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÜﬁ¶ﬁâﬁ¨ﬁáﬁ∞ ﬁÉﬁ¶ﬁÇﬁéﬁ¶ﬁÖﬁ™ﬁÇﬁ¶ﬁâﬁ¶ ﬁàﬁ¶ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÄﬁ™ﬁáﬁ∞ﬁãﬁ¶ ﬁãﬁ®ﬁÇﬁ™ﬁÇﬁ∞
            grantAccess(custName);

        } catch (e) {
            console.error(e);
            msg.innerText = "‚ùå Invalid License Key.";
        }
    }

    // ﬁàﬁ¶ﬁÇﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÄﬁ™ﬁáﬁ∞ﬁãﬁ¶ ﬁãﬁ≠ ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function grantAccess(name) {
        // ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁäﬁÆﬁÉﬁ™ﬁàﬁ™ﬁÇﬁ∞
        document.getElementById('securityOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('securityOverlay').classList.add('hidden');
        }, 500);
        
        // ﬁçﬁ¶ﬁáﬁ®ﬁêﬁ¶ﬁÇﬁ∞ﬁêﬁ∞ ﬁáﬁÆﬁåﬁ∞ ﬁâﬁ©ﬁÄﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞ (ﬁáﬁ¨ﬁåﬁ¨ﬁÉﬁ≠ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁÑﬁ¶ﬁáﬁ® ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶)
        const licDisp = document.getElementById('licenseDisplay');
        if(licDisp) {
            licDisp.style.display = 'block';
            document.getElementById('licenseName').innerText = name;
        }
        
        renderSlots(); // ﬁêﬁ∞ﬁçﬁÆﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞
        loadFromLocal(); // ‚òÖ ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™: ﬁáﬁÆﬁìﬁØ ﬁêﬁ≠ﬁàﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    }

    function setMode(mode) {
        state.mode = mode;
        document.getElementById('modeJudge').classList.toggle('active', mode === 'judge');
        document.getElementById('modeStudent').classList.toggle('active', mode === 'student');
        document.getElementById('judgeControls').classList.toggle('hidden', mode !== 'judge');
        document.getElementById('studentControls').classList.toggle('hidden', mode !== 'student');
        
        if(mode === 'student') {
            reshuffleGrid(); 
        } else { 
            state.grid.visible = false; 
            syncWindows(); 
        }
    }

    function setReadingMode(rm) {
        state.readingMode = rm;
        document.getElementById('rmMushaf').classList.toggle('active', rm === 'mushaf');
        document.getElementById('rmMemory').classList.toggle('active', rm === 'memory');
        updateMirror(); syncWindows();
    }

    function updateTheme() {
        const idx = document.getElementById('themeSelect').value;
        state.theme = themeList[idx];
        syncWindows();
    }

   // C. ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞ ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ (Register Student) - Updated Logic
function registerStudent() {
    // 1. ﬁáﬁ®ﬁÇﬁ∞ﬁïﬁ™ﬁìﬁ∞ ﬁäﬁ©ﬁçﬁ∞ﬁëﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁÇﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    const s = {
        name: document.getElementById('stdName').value,          // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
        id: document.getElementById('stdID').value,              // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©
        reg: document.getElementById('stdReg').value,            // ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        gender: document.getElementById('stdGender').value,      // ‚òÖ ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ (ﬁáﬁ¶ﬁáﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
        phone: document.getElementById('stdPhone').value,        // ﬁäﬁØﬁÇﬁ™
        address: document.getElementById('stdAddr').value,       // ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞
        
        group: document.getElementById('stdGroup').value,        // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
        branch: document.getElementById('stdBranch').value,      // ﬁéﬁÆﬁäﬁ®
        institution: document.getElementById('stdInst').value,   // ‚òÖ ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß (ﬁáﬁ¶ﬁáﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
        
        parent: document.getElementById('stdParent').value,      // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß
        parentPhone: document.getElementById('stdParentPhone').value, // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™
        email: document.getElementById('stdEmail').value,        // ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞
        
        timestamp: new Date().toISOString() // ﬁéﬁ¶ﬁëﬁ® ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞
    };
    
    // 2. ﬁóﬁ¨ﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁãﬁßﬁÇﬁ¨)
    if(!s.name || !s.id) { 
        alert("Student Name and ID are required! (ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁñﬁ¶ﬁÄﬁ¶ﬁÇﬁ∞ﬁàﬁßﬁÇﬁ¨)"); 
        return; 
    }
    
    // 3. ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ﬁéﬁ¨ ﬁáﬁ¨ﬁÜﬁ∞ﬁìﬁ®ﬁàﬁ∞ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁéﬁ¨ ﬁéﬁÆﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁêﬁ¨ﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    state.judging.currentStudentObj = s;
    state.judging.liveScores = {}; // ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞ (ﬁÉﬁ©ﬁêﬁ¨ﬁìﬁ∞)
    
    // 4. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁáﬁ¨ﬁÇﬁ∞ﬁéﬁ™ﬁÇﬁ∞ (UI Updates)
    // ﬁáﬁ¨ﬁëﬁ∞ﬁâﬁ®ﬁÇﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¶ﬁÇﬁ∞ ﬁãﬁ¨ﬁáﬁ∞ﬁÜﬁ™ﬁÇﬁ∞
    document.getElementById('currentStdLabel').innerText = `Active: ${s.name} (${s.institution})`;
    document.getElementById('currentStdLabel').style.color = "#00e676";
    
    // ﬁêﬁ≠ﬁàﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ ﬁÉﬁ¨ﬁëﬁ© ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const btn = document.getElementById('btnFinalize');
    btn.innerText = "‚úÖ Save Student Result";
    btn.disabled = false;
    
    document.getElementById('adminScoreMonitor').innerText = "Ready for judges...";
    
    // 5. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    syncWindows();
    saveToLocal(); // ﬁëﬁ≠ﬁìﬁß ﬁéﬁ¨ﬁáﬁ∞ﬁçﬁ™ﬁÇﬁ¶ ﬁÇﬁ™ﬁãﬁ®ﬁÇﬁ™ﬁâﬁ¶ﬁÅﬁ∞ ﬁêﬁ≠ﬁàﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    
    alert("Student Registered Successfully!");
}
// B. ﬁÑﬁ¨ﬁóﬁ∞ ﬁáﬁ®ﬁâﬁ∞ﬁïﬁØﬁìﬁ∞ (Load Batch CSV) - FIXED & ALIGNED
function loadStudentBatch() {
    const file = document.getElementById('batchCsv').files[0];
    if(!file) { alert("Please select a CSV file first!"); return; }
    
    const r = new FileReader();
    r.onload = e => {
        const rows = e.target.result.split('\n');
        state.allStudents = []; // ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁëﬁ≠ﬁìﬁß ﬁäﬁÆﬁÄﬁ¨ﬁçﬁ™ﬁÇﬁ∞
        
        let loadedCount = 0;

        // Row 0 is Header, start looping from 1
        for(let i=1; i<rows.length; i++) {
            let rowRaw = rows[i].trim();
            if(!rowRaw) continue; // ﬁÄﬁ™ﬁêﬁ∞ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ¨ﬁáﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁãﬁ´ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁß

            // ﬁëﬁ≠ﬁìﬁß ﬁêﬁ∞ﬁïﬁ∞ﬁçﬁ®ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁâﬁßﬁáﬁ®ÿå ﬁÜﬁÆﬁâﬁß ﬁáﬁßﬁáﬁ® " ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ ﬁêﬁßﬁäﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            const cols = rowRaw.split(',').map(c => c.replace(/^"|"$/g, '').trim());
            
            // ﬁóﬁ¨ﬁÜﬁ∞: ﬁâﬁ¶ﬁãﬁ™ﬁàﬁ¨ﬁéﬁ¨ﬁÇﬁ∞ ﬁÇﬁ¶ﬁâﬁßﬁáﬁ® ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¶ﬁÅﬁ∞ (Column 5) ﬁëﬁ≠ﬁìﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
            if(cols.length < 6) continue; 
            
            // === MAPPING (ﬁâﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ ﬁäﬁ≠ﬁÜﬁ∞ ﬁùﬁ©ﬁìﬁß ﬁãﬁ®ﬁâﬁßﬁàﬁßﬁÇﬁ¨) ===
            // 0: Serial, 1: Reg, 2: Group, 3: Branch, 4: Inst, 5: Name...
            
            state.allStudents.push({
                serial: cols[0],
                reg: cols[1],
                group: cols[2],       // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
                branch: cols[3],      // ﬁéﬁÆﬁäﬁ®
                institution: cols[4], // ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß
                name: cols[5],        // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
                gender: cols[6],      // ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™
                address: cols[7],
                id: cols[8],          // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©
                phone: cols[9],
                parent: cols[10],
                parentPhone: cols[11],
                email: cols[12]
            });
            loadedCount++;
        }
        
        populateStudentSelector(); // ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁÅﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¨ﬁÉﬁ™ﬁàﬁ™ﬁÇﬁ∞
        saveToLocal(); // ﬁáﬁÆﬁìﬁØ ﬁêﬁ≠ﬁàﬁ∞
        
        if(loadedCount > 0) {
            alert(`‚úÖ Success! Loaded ${loadedCount} students.\n(Please check the Dropdown List)`);
        } else {
            alert("‚ö†Ô∏è Error: File format not recognized. Please use the Fake Data format.");
        }
    };
    r.readAsText(file);
}
    function populateStudentSelector() {
        const sel = document.getElementById('studentSelector');
        sel.innerHTML = '<option value="">-- Manual Entry --</option>';
        state.allStudents.forEach((s, idx) => {
            let opt = document.createElement('option');
            opt.value = idx;
            opt.innerText = `${s.name} (${s.group})`;
            sel.appendChild(opt);
        });
    }

    // Fix: Populate Form correctly mapping new fields
function populateStudentForm(idx) {
    if(idx === "") return;
    const s = state.allStudents[idx];
    if(!s) return;
    
    document.getElementById('stdName').value = s.name || "";
    document.getElementById('stdID').value = s.id || "";
    document.getElementById('stdReg').value = s.reg || "";
    document.getElementById('stdGender').value = s.gender || "Male"; // Default to Male if empty
    document.getElementById('stdPhone').value = s.phone || "";
    document.getElementById('stdAddr').value = s.address || "";
    
    // Attempt to match dropdown value, otherwise default
    document.getElementById('stdGroup').value = s.group || "Under 6"; 
    document.getElementById('stdBranch').value = s.branch || "";
    document.getElementById('stdInst').value = s.institution || ""; // New Field Mapping
    
    document.getElementById('stdParent').value = s.parent || "";
    document.getElementById('stdParentPhone').value = s.parentPhone || "";
    document.getElementById('stdEmail').value = s.email || "";
}
    window.submitJudgeScore = function(judgeId, totalScore) {
        state.judging.liveScores[judgeId] = totalScore;
        updateScoreMonitor();
    }
function filterStudentList() {
        const input = document.getElementById('studentSearch');
        const filter = input.value.toUpperCase();
        const select = document.getElementById('studentSelector');
        const options = select.getElementsByTagName('option');

        for (let i = 0; i < options.length; i++) {
            const txtValue = options[i].text; 
            if (txtValue.toUpperCase().indexOf(filter) > -1 || filter === "") {
                options[i].style.display = "";
            } else {
                if(options[i].value === "") options[i].style.display = "";
                else options[i].style.display = "none";
            }
        }
    }
    function updateScoreMonitor() {
        let txt = "";
        let count = 0;
        let sum = 0;
        for(let j in state.judging.liveScores) {
            txt += `${j}: ${state.judging.liveScores[j]} | `;
            sum += state.judging.liveScores[j];
            count++;
        }
        if(count > 0) {
            let avg = (sum / count).toFixed(2);
            txt += ` Avg: ${avg}`;
        }
        document.getElementById('adminScoreMonitor').innerText = txt || "Waiting...";
    }

    function finalizeStudentResult() {
        if(!state.judging.currentStudentObj) return;
        
        let sum = 0;
        let count = 0;
        for(let j in state.judging.liveScores) {
            sum += state.judging.liveScores[j];
            count++;
        }
        
        if(count === 0) {
            if(!confirm("No judge scores received. Save with 0?")) return;
        }

        const finalScore = count > 0 ? (sum / count).toFixed(2) : 0;
        
        const resultRecord = {
            ...state.judging.currentStudentObj,
            scores: {...state.judging.liveScores},
            finalScore: parseFloat(finalScore)
        };
        
        state.judging.savedResults.push(resultRecord);
        saveToLocal(); // Auto save
        alert(`Saved! ${resultRecord.name} - Score: ${finalScore}`);
        
        // Reset Inputs
        document.getElementById('stdName').value = "";
        document.getElementById('stdID').value = "";
        state.judging.currentStudentObj = null;
        state.judging.liveScores = {};
        document.getElementById('currentStdLabel').innerText = "No student active.";
        document.getElementById('adminScoreMonitor').innerText = "Waiting...";
    }

    // --- REPORT GENERATION (UPDATED) ---
    function generateResultSheet(mode) {
        const filterGrp = document.getElementById('resFilterGroup').value;
        const headerTxt = document.getElementById('rptHeader').value;
        const footerTxt = document.getElementById('rptFooter').value;
        
        // Filter and Sort
        let list = state.judging.savedResults.filter(r => filterGrp === "All" || r.group === filterGrp);
        list.sort((a, b) => b.finalScore - a.finalScore); // Rank High to Low

        if(mode === 'top5') list = list.slice(0, 5);
        if(mode === 'top3') list = list.slice(0, 3);

        // Generate HTML
        let html = `<html><head><title>Result Sheet</title><style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; direction: rtl; }
            h1, h3 { text-align: center; margin: 5px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            th, td { border: 1px solid #333; padding: 8px; text-align: center; }
            th { background: #eee; }
            .header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-align:center; }
            .footer { margin-top: 40px; border-top: 1px dashed #ccc; padding-top: 10px; display: flex; justify-content: space-between; }
        </style></head><body>
            <div class="header">
                <h1>${headerTxt || "Rasfahi Royal Quran Competition"}</h1>
                <h3>Category: ${filterGrp} (${mode.toUpperCase()})</h3>
                <p>Date: ${new Date().toLocaleDateString()}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>ID Card</th>
                        <th>Group</th>
                        <th>Branch</th>
                        <th>Total Score</th>
                    </tr>
                </thead>
                <tbody>`;
        
        list.forEach((r, idx) => {
            let rank = idx + 1;
            // Handle tie-breaking visually if scores are same? Keeping simple for now
            html += `<tr>
                <td>${rank}</td>
                <td style="text-align:right;">${r.name}</td>
                <td>${r.id}</td>
                <td>${r.group}</td>
                <td>${r.branch}</td>
                <td><b>${r.finalScore}</b></td>
            </tr>`;
        });

        html += `</tbody></table>
            <div class="footer">
                <div>${footerTxt || "Judge Signature"}</div>
                <div>Admin Signature: ____________</div>
            </div>
        </body></html>`;

        const w = window.open("", "ResultSheet", "width=900,height=800");
        w.document.write(html);
        w.document.close();
        w.print();
    }
    
    // --- PRINT BLANK JUDGE SHEET ---
    function printJudgeSheetTemplate() {
        const headerTxt = document.getElementById('rptHeader').value;
        
        let rows = "";
        let totalMax = 0;
        state.judging.rubric.forEach(r => {
            totalMax += r.max;
            rows += `<tr>
                <td style="text-align:right; font-weight:bold;">${r.name}</td>
                <td>${r.max}</td>
                <td></td>
            </tr>`;
        });

        let html = `<html><head><title>Judge Sheet</title><style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; direction: rtl; }
            h1 { text-align: center; margin-bottom: 40px; }
            .info-box { border: 1px solid #000; padding: 10px; margin-bottom: 20px; display:flex; gap: 20px; }
            .field { flex: 1; border-bottom: 1px dotted #000; height: 30px; margin-top:10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
            th, td { border: 1px solid #333; padding: 15px; text-align: center; }
            th { background: #f0f0f0; }
        </style></head><body>
            <h1>${headerTxt || "JUDGE SCORE SHEET"}</h1>
            <div class="info-box">
                <div style="flex:1;">Student Name: _______________________</div>
                <div style="width:150px;">ID: ____________</div>
            </div>
             <div class="info-box">
                <div style="flex:1;">Category: _______________________</div>
                <div style="width:150px;">Judge ID: ____________</div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th style="width:50%;">Criteria</th>
                        <th style="width:15%;">Max Marks</th>
                        <th>Score Given</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                    <tr>
                        <td style="text-align:right; font-weight:bold;">TOTAL</td>
                        <td><b>${totalMax}</b></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top:50px;">
                <p>Remarks: _________________________________________________________________</p>
                <p style="margin-top:40px; text-align:left;">Signature: ______________________</p>
            </div>
        </body></html>`;
        
        const w = window.open("", "PrintTemplate", "width=800,height=900");
        w.document.write(html);
        w.document.close();
        w.print();
    }

    function clearAllResults() {
        if(confirm("Delete ALL saved results?")) {
            state.judging.savedResults = [];
            saveToLocal();
            alert("Cleared.");
        }
    }

    // --- RUBRIC CONFIG (UPDATED WITH DEDUCTIONS) ---
    function renderRubricConfig() {
        const c = document.getElementById('rubricConfigList');
        c.innerHTML = '';
        state.judging.rubric.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'rubric-edit-row';
            div.innerHTML = `
                <input type="text" value="${item.name}" onchange="updateRubric(${idx}, 'name', this.value)">
                <input type="number" value="${item.max}" onchange="updateRubric(${idx}, 'max', this.value)">
                <button class="btn-red" style="padding:0;" onclick="removeRubric(${idx})">x</button>
            `;
            c.appendChild(div);
        });
    }
    
    function updateRubric(idx, field, val) {
        state.judging.rubric[idx][field] = field === 'max' ? parseInt(val) : val;
        saveToLocal();
    }
    
    function removeRubric(idx) {
        state.judging.rubric.splice(idx, 1);
        renderRubricConfig();
        saveToLocal();
    }
    
    function addRubricItem() {
        const name = document.getElementById('newRubricName').value;
        const max = parseInt(document.getElementById('newRubricMax').value);
        if(name && max) {
            state.judging.rubric.push({name, max});
            renderRubricConfig();
            document.getElementById('newRubricName').value = "";
            document.getElementById('newRubricMax').value = "";
            saveToLocal();
        }
    }

    function updateDeductionSteps() {
        const val = document.getElementById('deductionStepsInput').value;
        const steps = val.split(',').map(v => parseFloat(v.trim())).filter(n => !isNaN(n));
        state.judging.deductionSteps = steps;
        saveToLocal();
        syncWindows();
    }

    // --- CEREMONY CSV & LOGIC ---
    document.getElementById('ceremonyCSV').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.ceremony.groupedData = {};
            
            rows.slice(1).forEach((r, idx) => {
                const c = r.split(',');
                if(c.length >= 3) {
                    const surah = c[0].trim();
                    const no = parseInt(c[1].trim()) || (idx + 1);
                    const arabic = c[2].trim();
                    const dv = c[3] ? c[3].trim() : "";
                    const en = c[4] ? c[4].trim() : "";
                    
                    if(surah && arabic) {
                        if(!state.ceremony.groupedData[surah]) {
                            state.ceremony.groupedData[surah] = [];
                        }
                        state.ceremony.groupedData[surah].push({
                            no: no,
                            arabic: arabic,
                            dv: dv,
                            en: en
                        });
                    }
                }
            });

            // Populate Surah Dropdown
            const cSurah = document.getElementById('cSurah');
            cSurah.innerHTML = '<option value="">-- Select Surah --</option>';
            Object.keys(state.ceremony.groupedData).forEach(sName => {
                cSurah.add(new Option(sName, sName));
            });

            alert(`Ceremony Data Loaded! Found ${Object.keys(state.ceremony.groupedData).length} Surahs.`);
        };
        r.readAsText(e.target.files[0]);
    };

    // --- UI LOGIC FOR DROPDOWNS ---
    function onSurahChange() {
        const sName = document.getElementById('cSurah').value;
        const cStart = document.getElementById('cStart');
        const cEnd = document.getElementById('cEnd');
        
        cStart.innerHTML = ''; 
        cEnd.innerHTML = '';
        
        if(!sName || !state.ceremony.groupedData[sName]) return;

        const ayahs = state.ceremony.groupedData[sName];
        
        // Populate Start and End Dropdowns with Numbers
        ayahs.forEach((a, idx) => {
            let txt = `Ayah ${a.no}`;
            cStart.add(new Option(txt, idx)); // Value is index in the array
            cEnd.add(new Option(txt, idx));
        });

        // Default End to last ayah
        cEnd.value = ayahs.length - 1;
        
        onRangeChange(); // Update state
    }

    function onRangeChange() {
        const sName = document.getElementById('cSurah').value;
        if(!sName) return;

        const startIdx = parseInt(document.getElementById('cStart').value);
        const endIdx = parseInt(document.getElementById('cEnd').value);
        const lang = document.getElementById('cLang').value;

        state.ceremony.selectedLang = lang;
        
        const ayahs = state.ceremony.groupedData[sName];
        
        if(startIdx > endIdx) {
             state.ceremony.activeData = [];
        } else {
             state.ceremony.activeData = ayahs.slice(startIdx, endIdx + 1);
        }

        state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }

    // Load Ceremony Fonts
    const loadCF = (id, key) => {
        document.getElementById(id).onchange = e => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => { 
                state.ceremony.fonts[key] = ev.target.result; 
                alert(key + " Font Loaded!"); 
                syncWindows(); 
            };
            r.readAsDataURL(f);
        }
    };
    loadCF('ceremonyQuranFont', 'quran');
    loadCF('ceremonyTransFont', 'trans');

    function ceremonyNext() {
        if(state.ceremony.phase === 'reciting') {
            if(state.ceremony.currentIndex < state.ceremony.activeData.length - 1) {
                state.ceremony.currentIndex++;
                updateCeremonyPreview();
                syncWindows();
            } else {
                state.ceremony.phase = 'end'; // Go to Sadaqallah
                updateCeremonyPreview();
                syncWindows();
            }
        } else if (state.ceremony.phase === 'start') {
            state.ceremony.phase = 'reciting';
            state.ceremony.currentIndex = 0;
            updateCeremonyPreview();
            syncWindows();
        }
    }

    function ceremonyPrev() {
        if(state.ceremony.phase === 'reciting' && state.ceremony.currentIndex > 0) {
            state.ceremony.currentIndex--;
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'reciting' && state.ceremony.currentIndex === 0) {
            state.ceremony.phase = 'start';
            updateCeremonyPreview();
            syncWindows();
        } else if (state.ceremony.phase === 'end') {
             state.ceremony.phase = 'reciting';
             state.ceremony.currentIndex = state.ceremony.activeData.length - 1;
             updateCeremonyPreview();
             syncWindows();
        }
    }

    function ceremonySetPhase(p) {
        state.ceremony.phase = p;
        if(p === 'reciting') state.ceremony.currentIndex = 0;
        updateCeremonyPreview();
        syncWindows();
    }
    
    // Custom Border Loader for Ceremony
    function loadCeremonyBorder(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            state.ceremony.settings.borderData = e.target.result;
            updateCeremonyState(); // Update screen immediately
        };
        reader.readAsDataURL(file);
    }

    function updateCeremonyState() {
        state.ceremony.settings.themeIndex = document.getElementById('ceremonyTheme').value;
        state.ceremony.settings.arabicColor = document.getElementById('cArabicColor').value;
        state.ceremony.settings.transColor = document.getElementById('cTransColor').value;
        state.ceremony.settings.arabicSize = document.getElementById('cArabicSize').value;
        state.ceremony.settings.transSize = document.getElementById('cTransSize').value;
        
        const borderSelect = document.getElementById('cBorderStyle');
        if(borderSelect) {
            state.ceremony.settings.borderStyle = borderSelect.value;
        }
        
        syncWindows(); 
    }

    function updateCeremonyPreview() {
        const el = document.getElementById('ceremonyPreview');
        if(state.ceremony.phase === 'cover') el.innerText = "DISPLAYING COVER (Title)";
        else if(state.ceremony.phase === 'start') el.innerText = "DISPLAYING BASMALAH";
        else if(state.ceremony.phase === 'end') el.innerText = "DISPLAYING SADAQALLAH";
        else {
            const a = state.ceremony.activeData[state.ceremony.currentIndex];
            if(a) {
                el.innerText = `Ayah ${a.no}: ${a.arabic.substring(0, 20)}...`;
            } else {
                el.innerText = "No Ayah Selected";
            }
        }
    }

    // --- END CEREMONY LOGIC ---

    function saveConfig() {
        const config = {
            themeIndex: document.getElementById('themeSelect').value,
            borderStyle: document.getElementById('borderStyle').value,
            qLimit: document.getElementById('qLimit').value,
            mode: state.mode,
            readingMode: state.readingMode,
            judgeCount: document.getElementById('judgeCount').value,
            rubric: state.judging.rubric,
            deductionSteps: state.judging.deductionSteps,
            allStudents: state.allStudents,
            savedResults: state.judging.savedResults 
        };
        const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "rasfahi_v26_config.json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadConfig(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                document.getElementById('themeSelect').value = config.themeIndex || 0;
                document.getElementById('borderStyle').value = config.borderStyle || 'royal';
                document.getElementById('qLimit').value = config.qLimit || 3;
                document.getElementById('judgeCount').value = config.judgeCount || 3;
                
                if(config.rubric) {
                    state.judging.rubric = config.rubric;
                    renderRubricConfig();
                }
                if(config.deductionSteps) {
                    state.judging.deductionSteps = config.deductionSteps;
                    document.getElementById('deductionStepsInput').value = config.deductionSteps.join(', ');
                }
                if(config.savedResults) {
                    state.judging.savedResults = config.savedResults;
                }
                if(config.allStudents) {
                    state.allStudents = config.allStudents;
                    populateStudentSelector();
                }

                updateTheme();
                setMode(config.mode || 'judge');
                setReadingMode(config.readingMode || 'mushaf');
                
                resetStudentSession();
                saveToLocal();
                alert("Configuration Loaded Successfully!");
            } catch(err) {
                alert("Error loading config: " + err);
            }
        };
        reader.readAsText(file);
    }

    function clearCache() {
        if(confirm("Are you sure? This will clear all loaded images to free up memory.")) {
            Object.values(state.pImages).forEach(url => URL.revokeObjectURL(url));
            state.pImages = {};
            state.qDataMap = {};
            state.qPool = [];
            state.filteredPool = [];
            state.qUsed = [];
            document.getElementById('imgStatus').innerText = "Memory Purged. Reload Images.";
            document.getElementById('mImg').src = "";
            resetStudentSession();
            alert("Memory Cleared!");
        }
    }

    function resolveImage(rawName) {
        if(!rawName) return null;
        rawName = rawName.toString().toLowerCase().trim();
        if(state.pImages[rawName]) return state.pImages[rawName];
        if(state.pImages[rawName + '.png']) return state.pImages[rawName + '.png'];
        if(state.pImages[rawName.padStart(3, '0') + '.png']) return state.pImages[rawName.padStart(3, '0') + '.png'];
        const intVal = parseInt(rawName);
        if(!isNaN(intVal) && state.pImages[intVal]) return state.pImages[intVal];
        return null;
    }

    function rebindAllImages() {
        Object.values(state.qDataMap).forEach(q => { q.src = resolveImage(q.imgRaw); });
        syncWindows();
    }

    document.getElementById('imgF').onchange = e => {
        let count = 0; state.pImages = {}; 
        for(let f of e.target.files) {
            if(f.type.startsWith('image/')) {
                const url = URL.createObjectURL(f);
                const name = f.name.toLowerCase();
                state.pImages[name] = url; 
                state.pImages[name.split('.')[0]] = url; 
                count++;
            }
        }
        document.getElementById('imgStatus').innerText = count + " images loaded ready.";
        rebindAllImages();
    };

    document.getElementById('csvQ').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.qPool = []; state.qUsed = []; state.filteredPool = [];
            rows.slice(1).forEach(r => {
                const c = r.split(',');
                if(c.length < 2) return;
                const id = c[0].trim();
                const imgRaw = c[1] ? c[1].trim() : "";
                
                const bookVal = c[2] ? c[2].trim() : "";
                const bookNum = parseInt(bookVal.replace(/\D/g,'')) || 0; 

                const surahVal = c[3] ? c[3].trim() : "";
                let surahNum = 0;

                const match = surahVal.match(/^(\d+)/);
                if(match) {
                    surahNum = parseInt(match[1]);
                } else {
                    const sLower = surahVal.toLowerCase().replace(/[^a-z]/g, '');
                    const idx = SURAH_NAMES.findIndex(n => n.replace(/[^a-z]/g, '') === sLower);
                    if(idx > -1) surahNum = idx + 1;
                }

                state.qDataMap[id] = { 
                    id: id, imgRaw: imgRaw, src: null,          
                    book: bookVal, bookNum: bookNum,
                    surah: surahVal, surahNum: surahNum,
                    page: c[4], start: c[5], end: c[6] 
                };
                state.qPool.push(id);
            });
            rebindAllImages();
            state.filteredPool = [...state.qPool];
            applySyllabusFilter(); 
            alert("Questions Loaded: " + state.qPool.length);
        };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('borderStyle').onchange = function() {
        document.getElementById('borderImg').classList.toggle('hidden', this.value !== 'custom');
        syncWindows();
    };
    document.getElementById('borderImg').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { state.borderData = ev.target.result; syncWindows(); };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- NEW SYLLABUS LOGIC ---
    function updateFilterUI() {
        const type = document.getElementById('filterType').value;
        const lblStart = document.getElementById('lblStartVal');
        const lblEnd = document.getElementById('lblEndVal');
        
        if(type === 'book') {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁäﬁÆﬁåﬁ∞ (Start Book):" : "Start Book/Juz:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁäﬁÆﬁåﬁ∞ (End Book):" : "End Book/Juz:";
        } else {
            lblStart.innerText = currentLang === 'dv' ? "ﬁäﬁ¶ﬁÅﬁß ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (Start Surah ID):" : "Start Surah No:";
            lblEnd.innerText = currentLang === 'dv' ? "ﬁÇﬁ®ﬁâﬁ≠ ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞ (End Surah ID):" : "End Surah No:";
        }
    }

    function applySyllabusFilter() {
        const type = document.getElementById('filterType').value;
        const start = parseInt(document.getElementById('scopeStart').value) || 1;
        const end = parseInt(document.getElementById('scopeEnd').value) || 114;

        if(state.qPool.length === 0) return;

        state.filteredPool = state.qPool.filter(qid => {
            const q = state.qDataMap[qid];
            if(type === 'book') {
                return q.bookNum >= start && q.bookNum <= end;
            } else {
                return q.surahNum >= start && q.surahNum <= end;
            }
        });

        const status = document.getElementById('scopeStatus');
        status.innerText = `Active Questions: ${state.filteredPool.length} (Range: ${start}-${end})`;
        status.style.color = state.filteredPool.length > 0 ? "#00e676" : "#ff5252";

        if(state.filteredPool.length === 0) {
            alert("‚ö†Ô∏è No questions found in this range!");
        } else {
            if(state.mode === 'student') reshuffleGrid();
        }
    }

    // --- GRID ---
    window.handleGridClick = function(boxID) {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.selectionIDs.length >= limit) return;

        const qID = state.grid.map[boxID];
        
        if(!qID || state.grid.taken.includes(boxID)) {
             return;
        }

        state.grid.taken.push(boxID);
        state.session.selectionIDs.push(qID);

        // Remove from pools
        const idx = state.qPool.indexOf(qID);
        if(idx > -1) state.qPool.splice(idx, 1);
        
        const fIdx = state.filteredPool.indexOf(qID);
        if(fIdx > -1) state.filteredPool.splice(fIdx, 1);

        state.qUsed.push(qID);

        updateSelectionUI();

        if(state.session.selectionIDs.length === limit) {
            state.grid.visible = false;
            state.session.phase = 'ready';
            prepareSlotsFromSelection();
            document.getElementById('btnStartReading').classList.remove('hidden');
        } else {
            state.session.phase = 'selection';
        }
        renderSlots(); updateGridPreview(); syncWindows();
    }

    function updateSelectionUI() {
        document.getElementById('selectionInfo').innerText = "Selected: " + state.session.selectionIDs.join(", ");
    }

    function prepareSlotsFromSelection() {
        state.session.slots = state.session.selectionIDs.map(id => {
            let q = state.qDataMap[id];
            if(q && !q.src) q.src = resolveImage(q.imgRaw);
            return q;
        });
        state.session.activeIndex = -1;
        updateStatus();
    }

    window.startReadingSession = function() {
        if(state.session.slots.length === 0) return;
        state.session.activeIndex = 0;
        state.session.phase = 'active';
        document.getElementById('btnStartReading').classList.add('hidden');
        updateStatus(); updateMirror(); syncWindows();
    }

    window.pickRandomQuestion = function() {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.slots.length >= limit) return;
        
        const q = getRandomQ();
        if(!q) return;

        state.session.slots.push(q);
        state.session.activeIndex = state.session.slots.length - 1;
        state.session.phase = 'active';
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    };

    function getRandomQ() {
        if(state.filteredPool.length === 0) {
             if(state.qUsed.length === 0) { alert("No Data or Empty Filter!"); return null; }
             alert("Syllabus pool empty. Reload or check scope.");
             return null;
        }
        const rIdx = Math.floor(Math.random() * state.filteredPool.length);
        const qID = state.filteredPool[rIdx];
        
        state.filteredPool.splice(rIdx, 1);
        
        const mIdx = state.qPool.indexOf(qID);
        if(mIdx > -1) state.qPool.splice(mIdx, 1);

        state.qUsed.push(qID);
        
        const qData = state.qDataMap[qID];
        if(!qData.src) qData.src = resolveImage(qData.imgRaw);
        return qData;
    }

    window.reshuffleGrid = function() {
        if(state.qPool.length === 0 && state.qUsed.length === 0) {
            alert("No questions loaded! Please load CSV first.");
            return;
        }

        let sourcePool = [...state.filteredPool];

        if(sourcePool.length < 1) {
            alert("The selected Syllabus (Scope) has no questions available!");
            return;
        }

        state.grid.map = {}; state.grid.taken = [];
        
        for(let i=1; i<=20; i++) {
            if(sourcePool.length === 0) {
                state.grid.map[i] = null; 
                continue;
            }
            const rIdx = Math.floor(Math.random() * sourcePool.length);
            state.grid.map[i] = sourcePool[rIdx];
            sourcePool.splice(rIdx, 1);
        }
        updateGridPreview(); syncWindows();
    }

    window.toggleGridScreen = function(show) {
        state.grid.visible = show;
        state.session.phase = 'selection';
        syncWindows(); updateGridPreview();
    }

    // --- NAVIGATION ---
    window.prevQuestion = function() {
        if(state.session.phase === 'finished') {
            state.session.phase = 'active';
            state.session.activeIndex = state.session.slots.length - 1;
        } else if (state.session.activeIndex > 0) {
            state.session.activeIndex--;
        } else {
            return; 
        }
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.nextQuestion = function() {
        if(state.session.phase === 'ready') {
            startReadingSession(); return;
        }

        if(state.session.phase === 'finished') return; 

        const nextIdx = state.session.activeIndex + 1;
        
        if(nextIdx >= state.session.slots.length) {
            state.session.phase = 'finished';
        } else {
            state.session.activeIndex = nextIdx;
        }
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.resetStudentSession = function() {
        state.session = { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false };
        state.grid.taken = []; state.grid.visible = false;
        document.getElementById('btnStartReading').classList.add('hidden');
        document.getElementById('selectionInfo').innerText = "No selection yet.";
        
        if(state.mode === 'student') reshuffleGrid();
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    function toggleBell(on) {
        const bs = document.getElementById('bellStart');
        const be = document.getElementById('bellEnd');
        if(on) { bs.currentTime=0; bs.play().catch(()=>{}); }
        else { be.currentTime=0; be.play().catch(()=>{}); }
        state.session.light = on;
        updateMirror(); syncWindows();
    }

    // --- UI RENDER ---
    function renderSlots() {
        const limit = parseInt(document.getElementById('qLimit').value);
        const g = document.getElementById('slotGrid');
        g.style.gridTemplateColumns = `repeat(${limit}, 1fr)`;
        g.innerHTML = '';
        
        const source = (state.session.phase === 'selection' || state.session.phase === 'ready') 
                        ? state.session.selectionIDs 
                        : state.session.slots;

        for(let i=0; i<limit; i++) {
            let d = document.createElement('div');
            let content = `Slot ${i+1}`;
            if(source[i]) { content = source[i].id ? `Q: ${source[i].id}` : `Q: ${source[i]}`; }
            d.className = 'slot-box ' + (i === state.session.activeIndex ? 'active' : '');
            d.innerText = content;
            g.appendChild(d);
        }
    }

    function updateStatus() {
        const s = document.getElementById('statusDisplay');
        if(state.session.phase === 'idle') { s.innerText = "WAITING..."; s.style.color="#777"; }
        else if(state.session.phase === 'selection') { s.innerText = "SELECTING..."; s.style.color="#D4AF37"; }
        else if(state.session.phase === 'ready') { s.innerText = "READY"; s.style.color="#00e676"; }
        else if(state.session.phase === 'finished') { s.innerText = "FINISHED"; s.style.color="#ff5252"; }
        else { s.innerText = `Q-${state.session.slots[state.session.activeIndex]?.id || "?"}`; s.style.color = "#00e676"; }
    }

    function updateMirror() {
        const gp = document.getElementById('gridPreview');
        const mCont = document.getElementById('mirrorContainer');
        const mImg = document.getElementById('mImg');
        const mReady = document.getElementById('mReadyText');
        const mFin = document.getElementById('mFinishText');
        const wWarn = document.getElementById('adminWarn');
        const banner = document.getElementById('adminBanner');
        const mMemory = document.getElementById('mMemoryText');
        
        document.getElementById('mirrorLight').style.background = state.session.light ? '#00e676' : '#333';

        if(state.theme) {
            mCont.style.border = `10px ${state.theme.borderType} ${state.theme.accent}`;
            mCont.style.background = '#fff'; 
        }

        if(state.grid.visible) {
            mCont.style.display = 'none'; 
            gp.style.display = 'grid';
            updateGridPreview();
            return;
        } 
        
        gp.style.display = 'none'; 
        mCont.style.display = 'flex';
        
        mImg.style.display = 'none';
        mReady.style.display = 'none'; 
        mFin.style.display = 'none'; 
        wWarn.style.display = 'none';
        banner.style.display = 'none';
        mMemory.style.display = 'none';

        if(state.session.phase === 'ready') {
             mReady.style.display = 'block';
             document.getElementById('mirrorStatus').innerText = "WAITING";
             return;
        }

        if(state.session.phase === 'finished') {
            mFin.style.display = 'block';
            mFin.innerHTML = i18n.msgFinished[currentLang];
            document.getElementById('mirrorStatus').innerText = "FINISHED";
            return;
        }

        const q = state.session.slots[state.session.activeIndex];

        if(q && state.session.phase === 'active') {
            document.getElementById('mBook').innerText = q.book;
            document.getElementById('mSurah').innerText = q.surah;
            document.getElementById('mAyah').innerText = q.start + '-' + q.end;
            banner.style.display = 'flex'; 

            if(state.readingMode === 'memory') {
                wWarn.style.display = 'block';
                mMemory.style.display = 'block'; 
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "0.2"; }
            } else {
                if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; mImg.style.opacity = "1"; }
            }
            
            document.getElementById('mirrorStatus').innerText = "LIVE READING";
        } else {
            document.getElementById('mirrorStatus').innerText = "IDLE";
        }
    }

    function updateGridPreview() {
        const gp = document.getElementById('gridPreview');
        gp.innerHTML = '';
        for(let i=1; i<=20; i++) {
            let b = document.createElement('div');
            let isSelected = state.session.selectionIDs.includes(state.grid.map[i]);
            b.className = 'gp-box ' + (state.grid.taken.includes(i) ? 'taken' : '') + (isSelected ? ' selected' : '');
            b.innerText = i;
            b.setAttribute('onclick', `handleGridClick(${i})`); 
            gp.appendChild(b);
        }
    }

    // --- TEMPLATE GENERATOR ---
    function getTemplate(isCeremony = false) {
        const fontFace = state.fontData ? `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }` : '';
        
        // Fonts for Ceremony
        let ceremonyFonts = '';
        if(isCeremony) {
             if(state.ceremony.fonts.quran) ceremonyFonts += `@font-face { font-family: 'QuranFont'; src: url('${state.ceremony.fonts.quran}'); }`;
             if(state.ceremony.fonts.trans) ceremonyFonts += `@font-face { font-family: 'TransFont'; src: url('${state.ceremony.fonts.trans}'); }`;
        }

        const bStyle = document.getElementById('borderStyle').value;
        const th = state.theme || themeList[0]; 

        let borderCSS = `border: 1.5vmin ${th.borderType} ${th.accent}; box-shadow: 0 0 5vmin ${th.accent}80;`;
        if(bStyle === 'custom' && state.borderData) borderCSS = `border: 4vmin solid transparent; border-image: url('${state.borderData}') 30 stretch;`;
        if(bStyle === 'none') borderCSS = "border:none;";

        return `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                ${fontFace}
                ${ceremonyFonts}
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

                body.lang-dv * { font-family: 'AppFont', 'Faruuma', 'Waheed', 'Noto Sans Thaana', sans-serif !important; }
                body.lang-ar * { font-family: 'Amiri', serif !important; }
                body.lang-en * { font-family: sans-serif !important; direction: ltr; }

                :root {
                    --bg-1: ${th.bg1}; --bg-2: ${th.bg2};
                    --accent: ${th.accent}; --border-type: ${th.borderType};
                    --txt-col: ${th.text};
                    --royal-gold: #D4AF37;
                }
                
                * { box-sizing: border-box; }
                body { 
                    margin:0; padding: 0;
                    width: 100vw; height: 100vh; 
                    overflow:hidden; 
                    color:var(--txt-col); 
                    display:flex; 
                    background: #000;
                }

                #royalFrame {
                    position: fixed; top:0; left:0; width:100%; height:100%;
                    pointer-events: none; z-index: 9999;
                    border: 2.5vmin solid var(--accent);
                    box-shadow: inset 0 0 10vmin rgba(0,0,0,0.9);
                }
                
                #signalLight {
                    position: fixed; top: 2vmin; right: 2vmin;
                    width: 6vmin; height: 6vmin;
                    border-radius: 50%;
                    background: #333;
                    border: 0.5vmin solid #fff;
                    box-shadow: 0 0 2vmin rgba(0,0,0,0.5);
                    z-index: 10000;
                    transition: background 0.3s;
                }
                #idleScreen, #gridScreen, #waitScreen, #readScreen, #finishScreen { display:none; width:100%; height:100%; }

                #idleScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #gridScreen { align-items:center; justify-content:center; flex-direction:column; background: radial-gradient(circle, var(--bg-1), #000); }
                #gridContainer { 
                    display:grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(4, 1fr);
                    gap: 1.5vmin; width: 85vw; height: 75vh; 
                }
                .grid-btn { 
                    width: 100%; height: 100%;
                    background: linear-gradient(135deg, var(--accent), var(--bg-1)); 
                    border: 0.3vmin solid #fff; border-radius: 1vmin;
                    color: #fff; text-shadow: 0 2px 2px #000;
                    font-size: 5vmin; font-weight: bold; cursor: pointer; transition: 0.3s; 
                    display:flex; justify-content:center; align-items:center;
                    box-shadow: 0 1vmin 2vmin rgba(0,0,0,0.5);
                }
                .grid-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
                .grid-btn.taken { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

                #readScreen { flex-direction:column; background: radial-gradient(circle, var(--bg-1), var(--bg-2)); }
                
                #topBar { 
                    height: 12vh; width: 100%; 
                    background: linear-gradient(to bottom, var(--bg-1), #000); 
                    border-bottom: 0.5vmin solid var(--accent);
                    display: flex; align-items: center; justify-content: center;
                    box-shadow: 0 1vh 2vh rgba(0,0,0,0.8); z-index: 10;
                }
                #topStatusText { 
                    color: var(--accent); font-size: 4vmin; font-weight: bold; 
                    text-shadow: 0 0.5vmin 1vmin rgba(0,0,0,1);
                }

                #contentArea { display: flex; height: 88vh; width: 100%; padding: 2vmin; box-sizing: border-box; }

                #infoPanel { 
                    width: 20vw; background: rgba(0,0,0,0.5); 
                    border: 0.3vmin solid var(--accent); border-radius: 1vmin;
                    display: flex; flex-direction: column; margin-left: 1vw;
                }
                .mode-display { padding: 2vh; border-bottom: 1px solid var(--accent); text-align: center; }
                .mode-text { color: #00e676; font-size: 2.5vmin; font-weight: bold; text-shadow: 0 2px 2px #000; }
                .selected-list-box { border-bottom: 1px solid var(--accent); padding: 2vh; background: rgba(255, 255, 255, 0.05); text-align: center; }
                .selected-label { color: var(--accent); font-size: 1.8vmin; display: block; margin-bottom: 1vh; text-decoration: underline; }
                .selected-nums { color: #fff; font-size: 3vmin; font-weight: bold; line-height: 1.5; }

                .questions-list { flex: 1; overflow-y: auto; padding: 1vmin; }
                .q-item { 
                    padding: 1.5vmin; margin-bottom: 1vmin; border-radius: 1vmin; 
                    border: 1px solid #444; background: rgba(0,0,0,0.6);
                    transition: 0.3s; font-size: 2vmin;
                }
                .q-item.active { border-color: var(--accent); background: linear-gradient(90deg, var(--bg-1), #000); }

                #mainArea { 
                    flex: 1; display: flex; justify-content: flex-start; align-items: center; 
                    flex-direction: column; overflow-y: auto;
                }
                
                .royal-card {
                    width: 75vw; min-height: 50vh;
                    background: #fff; ${borderCSS}
                    border-radius: 1vmin; overflow-y: auto; overflow-x: hidden;
                    display: block; position: relative;
                    box-shadow: 0 2vmin 5vmin rgba(0,0,0,0.7); flex-shrink: 0;
                }
                .royal-card img { width: 100%; height: auto; display: block; margin: 0; }
                .royal-card.memory-mode { background: transparent; border: none; box-shadow: none; display: flex; justify-content: center; align-items: center; }

                #memoryText { display:none; color: var(--accent); font-size: 5vw; text-shadow: 0 0 2vh var(--accent); text-align:center; }
                
                /* JUDGE ELEMENTS */
                #judgeSection {
                    display: none; width: 75vw; margin-top: 2vmin; margin-bottom: 2vmin;
                    background: #fff; border: 0.5vmin solid var(--accent);
                    border-radius: 1vmin; padding: 2vmin; color: #000;
                }
                .student-bar {
                    background: var(--bg-1); color: #fff;
                    padding: 1.5vmin; border-radius: 0.5vmin; text-align: center;
                    font-size: 3vmin; font-weight: bold; margin-bottom: 2vmin; border: 2px solid var(--accent);
                }
                .rubric-table { width: 100%; border-collapse: collapse; }
                .rubric-table th { background: #eee; text-align: right; padding: 1vmin; }
                .rubric-table td { border-bottom: 1px solid #ddd; padding: 1vmin; }
                
                .score-input-group { display: flex; gap: 1vmin; align-items: center; justify-content: flex-end; }
                .score-display {
                     width: 8vmin; font-size: 2.5vmin; padding: 0.5vmin; text-align: center; font-weight: bold; 
                     border: 2px solid var(--bg-1); border-radius: 4px; background: #eee; color: #333;
                }
                .deduct-btn {
                    padding: 0.5vmin 1vmin; border: 1px solid #b71c1c; border-radius: 4px; cursor: pointer;
                    font-size: 1.8vmin; background: #ffebee; color: #b71c1c; font-weight:bold;
                }
                .deduct-btn:hover { background: #ef9a9a; color: #fff; }
                .deduct-btn:active { transform: translateY(1px); }
                
                .deduct-info { color: #d32f2f; font-size: 1.5vmin; margin-right: 10px; }
                
                .judge-submit-btn {
                    width: 100%; padding: 2vmin; margin-top: 2vmin;
                    background: #004d00; color: #fff; font-size: 3vmin; font-weight: bold;
                    border: none; cursor: pointer; border-radius: 0.5vmin;
                }
                .judge-submit-btn:hover { background: #006400; }
                
                #judgeTotalDisplay { text-align: right; font-size: 3vmin; font-weight: bold; margin-top: 1vmin; color: #b71c1c; }

                #finishScreen, #waitScreen { flex-direction:column; align-items:center; justify-content:center; background: #000; }

                /* --- CEREMONY CSS --- */
                #ceremonyScreen {
                    display: none; width: 100%; height: 100%;
                    flex-direction: column; align-items: center; justify-content: center;
                    background: radial-gradient(circle at center, #002200, #000);
                    text-align: center; padding: 4vmin;
                    border: 2vmin double #D4AF37;
                    box-sizing: border-box;
                    transition: all 0.5s ease;
                }
                /* (Includes all theme classes from original) */
                .theme-0 { background: radial-gradient(circle, #002200, #000); border: 2vmin double #D4AF37; }
                /* ... (Assuming themes 1-20 present) ... */
                
                .ceremony-box { width: 90%; height: 90%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
                .ceremony-divider { width: 60%; height: 0.5vmin; background: linear-gradient(90deg, transparent, #D4AF37, transparent); margin: 4vmin auto; box-shadow: 0 0 2vmin #D4AF37; }
                .ceremony-quran { font-family: 'QuranFont', 'Amiri', serif !important; line-height: 1.6; text-shadow: 0 4px 10px rgba(0,0,0,0.5); direction: rtl; margin-bottom: 1vmin; }
                .ceremony-trans { font-family: 'TransFont', 'Faruuma', 'AppFont', sans-serif !important; margin-top: 1vmin; text-shadow: 0 2px 5px rgba(0,0,0,0.8); direction: rtl; text-align: center; }
                .c-cover { font-size: 8vmin; color: #D4AF37; font-family: 'Cinzel', serif !important; text-transform: uppercase; text-shadow: 0 0 20px #000; }
                .c-basmalah { font-size: 10vmin; color: #fff; margin-bottom: 2vmin; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }
                .c-sadaqallah { font-size: 10vmin; color: #D4AF37; font-family: 'Amiri', serif !important; text-shadow: 0 0 20px #000; }

                #fsOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; justify-content:center; align-items:center; }
                .fs-btn { border: 2px solid var(--accent); padding: 20px; color: var(--accent); background: #000; cursor: pointer; font-size: 20px; border-radius: 10px; }
            </style>
        </head>
        <body oncontextmenu="return false;" class="lang-dv">
            <div id="fsOverlay" onclick="goFullscreen()"><div class="fs-btn">CLICK TO START (FULLSCREEN)</div></div>
            
            ${bStyle === 'royal' ? '<div id="royalFrame"></div>' : ''}

            <div id="signalLight"></div>
            <div id="idleScreen"><h1 style="font-size:8vw; color:var(--accent); text-shadow:0 0 3vh var(--accent);">RASFAHI</h1></div>
            <div id="gridScreen"><h1 id="gridTitle" style="color:var(--accent); font-size: 5vh;">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß</h1><div id="gridContainer"></div></div>
            <div id="waitScreen"><h1 id="waitHead" style="color:var(--accent); font-size: 5vh;">SELECTION COMPLETE</h1><h2 id="waitSub" style="color:#fff; font-size: 3vh;">Waiting for Judge...</h2><div id="waitList" style="color:var(--accent); font-size:3vh; margin-top:20px;"></div></div>
            <div id="finishScreen"><h1 id="finText" style="color:var(--accent); text-shadow:0 0 3vh var(--accent); text-align:center; font-size: 6vw;"></h1></div>
            <div id="readScreen">
                <div id="topBar"><div id="topStatusText"></div></div>
                <div id="contentArea">
                    <div id="infoPanel">
                        <div class="mode-display"><span class="mode-text" id="displayMode"></span></div>
                        <div class="selected-list-box"><span class="selected-label" data-key="lblSelected">ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:</span><span class="selected-nums" id="displaySelected"></span></div>
                        <div class="questions-list" id="qListContainer"></div>
                    </div>
                    <div id="mainArea">
                        <div class="royal-card" id="mainScroll"><img id="qImg" src=""><h1 id="memoryText"></h1></div>
                        
                        <div id="judgeSection">
    <h1 id="judgeTitleDisplay" style="text-align:center; color:#b71c1c; border-bottom:2px solid #ccc; padding-bottom:10px; font-size:40px;">JUDGE SCREEN</h1>
    
    <div class="student-bar">Student: <span id="jStudentName">---</span></div>
                            <table class="rubric-table">
                                <thead style="border-bottom: 2px solid var(--accent);">
                                    <tr>
                                        <th>Category</th>
                                        <th style="width:10%;">Max</th>
                                        <th style="width:50%;">Deductions</th>
                                        <th style="width:15%;">Score</th>
                                    </tr>
                                </thead>
                                <tbody id="rubricTableBody"></tbody>
                            </table>
                            <div id="judgeTotalDisplay">Total: 0</div>
                            <button class="judge-submit-btn" onclick="submitFinalScore()">‚úÖ SUBMIT SCORE</button>
                        </div>

                    </div>
                </div>
            </div>

            <div id="ceremonyScreen" class="theme-0">
                <div class="ceremony-box">
                    <div id="cHeader"></div>
                    <div id="cBody" style="width:100%;"></div>
                    <div id="cFooter"></div>
                </div>
            </div>

            <script>
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                const childI18n = {
                    gridTitle: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß", ar: "ÿßÿÆÿ™ÿ± ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ§ÿßŸÑ", en: "Pick Question Number" },
                    waitHead: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¨ﬁéﬁ™ﬁÇﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨", ar: "ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±", en: "Selection Complete" },
                    waitSub: { dv: "ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ ﬁäﬁ¶ﬁÅﬁ¶ﬁÇﬁ∞ﬁãﬁ¨ﬁÇﬁ∞ ﬁâﬁ¶ﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß", ar: "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÇÿßÿ∂Ÿä", en: "Waiting for Judge..." },
                    memText: { dv: "(ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞)", ar: "(ÿ™ŸÑÿßŸàÿ© ÿπŸÜ ÿ∏Ÿáÿ± ŸÇŸÑÿ®)", en: "(Memory Recitation Mode)" },
                    rmMushaf: { dv: "ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÖŸÜ ÿßŸÑŸÖÿµÿ≠ŸÅ", en: "Reading from Mushaf" },
                    rmMemory: { dv: "ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁß ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁéﬁÆﬁäﬁ®", ar: "ŸÅÿ±ÿπ ÿßŸÑÿ≠ŸÅÿ∏", en: "Reciting from Memory" },
                    lblSelected: { dv: "ﬁáﬁ®ﬁöﬁ∞ﬁåﬁ®ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ™:", ar: "ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©:", en: "Selected Questions:" },
                    qPrefix: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ≥ÿ§ÿßŸÑ", en: "Q" },
                    statFirst: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ŸàŸÑ", en: "Reading First Question" },
                    statLast: { dv: "ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁäﬁ¶ﬁÄﬁ™ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "Ÿáÿ∞ÿß ŸáŸà ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ÿÆŸäÿ±", en: "This is the Last Question" },
                    statMid: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© %N ﬁàﬁ¶ﬁÇﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™", ar: "ÿ£ŸÜÿ™ ÿ™ŸÇÿ±ÿ£ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ±ŸÇŸÖ %N", en: "Reading Question #%N" },
                    msgFinished: { dv: "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁ¶ﬁÇﬁëﬁ¶ﬁáﬁ¨ﬁÖﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁâﬁ®ﬁÇﬁ∞ﬁàﬁ¶ﬁÉﬁ¶ﬁÅﬁ∞ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁÇﬁ®ﬁâﬁ®ﬁáﬁ∞ﬁñﬁ¨!", ar: "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©!", en: "Questioning complete for the current limit!" }
                };

                const isCeremonyWindow = ${isCeremony};
                let currentScores = {}; // To store dynamic scores in judge window
                
                function goFullscreen() {
                    document.documentElement.requestFullscreen();
                    document.getElementById('fsOverlay').style.display = 'none';
                }

                // --- DYNAMIC JUDGE TABLE LOGIC ---
                // Helper to initialize rows in Judge Window
                window.initJudgeRow = function(idx, max) {
                    if(!currentScores[idx]) currentScores[idx] = { max: max, deducted: 0 };
                    updateRowDisplay(idx);
                }

                window.addDeduction = function(idx, amount) {
                    if(!currentScores[idx]) return;
                    currentScores[idx].deducted += amount;
                    // Cap deduction so score doesn't go below 0
                    if(currentScores[idx].deducted > currentScores[idx].max) {
                        currentScores[idx].deducted = currentScores[idx].max;
                    }
                    updateRowDisplay(idx);
                    calculateTotal();
                }
                
                window.undoDeduction = function(idx) {
                    if(!currentScores[idx]) return;
                    currentScores[idx].deducted = 0; // Reset row
                    updateRowDisplay(idx);
                    calculateTotal();
                }

                function updateRowDisplay(idx) {
                    const data = currentScores[idx];
                    const final = (data.max - data.deducted).toFixed(2);
                    document.getElementById('display_' + idx).innerText = final;
                    document.getElementById('info_' + idx).innerText = '-' + data.deducted.toFixed(2);
                }

                window.calculateTotal = function() {
                    let total = 0;
                    for(let k in currentScores) {
                        total += (currentScores[k].max - currentScores[k].deducted);
                    }
                    document.getElementById('judgeTotalDisplay').innerText = "Total: " + total.toFixed(2);
                    return total;
                }

                window.submitFinalScore = function() {
                    if(confirm("Submit Score?")) {
                        const score = calculateTotal();
                        const judgeId = window.name || "Judge";
                        if(window.opener) {
                             window.opener.submitJudgeScore(judgeId, score);
                             document.querySelector('.judge-submit-btn').innerText = "SUBMITTED (" + score.toFixed(2) + ")";
                             document.querySelector('.judge-submit-btn').disabled = true;
                             document.querySelector('.judge-submit-btn').style.background = "#555";
                        }
                    }
                }

                window.updateState = function(d) {
                    if(isCeremonyWindow) { updateCeremony(d); return; }

                    const lang = d.currentLang || 'dv';
                    document.body.className = 'lang-' + lang;
                    document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
                    document.documentElement.lang = lang;

                    document.getElementById('signalLight').style.background = d.light ? '#00e676' : '#330000';
                    document.getElementById('signalLight').style.boxShadow = d.light ? '0 0 5vmin #00e676' : 'none';
                    
                    document.getElementById('gridTitle').innerText = childI18n.gridTitle[lang];
                    document.getElementById('waitHead').innerText = childI18n.waitHead[lang];
                    document.getElementById('waitSub').innerText = childI18n.waitSub[lang];
                    document.getElementById('finText').innerHTML = childI18n.msgFinished[lang].replace(/\\n/g, '<br>');
                    document.getElementById('memoryText').innerText = childI18n.memText[lang];
                    document.querySelectorAll('[data-key]').forEach(el => {
                        const k = el.getAttribute('data-key');
                        if(childI18n[k]) el.innerText = childI18n[k][lang];
                    });

                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    
                    const isJudge = window.name.includes('Judge');
                    const jSec = document.getElementById('judgeSection');

                    if(isJudge) {
                        jSec.style.display = 'block';
                        document.getElementById('jStudentName').innerText = d.judging.currentStudentObj ? d.judging.currentStudentObj.name : "Not Selected";
                        
                        // Render Dynamic Rubric with Deduction Buttons
                        const tbody = document.getElementById('rubricTableBody');
                        if(tbody.innerHTML === '' && d.judging.rubric) {
                            d.judging.rubric.forEach((item, idx) => {
                                const row = document.createElement('tr');
                                const max = item.max;
                                
                                // Create buttons based on config
                                let btnHtml = '';
                                const steps = d.judging.deductionSteps || [0.5, 1];
                                steps.forEach(step => {
                                    btnHtml += \`<button class="deduct-btn" onclick="addDeduction(\${idx}, \${step})">-\${step}</button> \`;
                                });
                                btnHtml += \`<button class="deduct-btn" style="border-color:#333; color:#333; background:#eee;" onclick="undoDeduction(\${idx})">Reset</button>\`;

                                row.innerHTML = \`
                                    <td style="font-weight:bold;">\${item.name}</td>
                                    <td>\${max}</td>
                                    <td>
                                        <div class="score-input-group" style="justify-content:center;">
                                            \${btnHtml}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="score-input-group">
                                            <span class="deduct-info" id="info_\${idx}">-0.0</span>
                                            <div class="score-display" id="display_\${idx}">\${max}</div>
                                        </div>
                                    </td>
                                \`;
                                tbody.appendChild(row);
                                initJudgeRow(idx, max);
                            });
                            calculateTotal();
                        }
                    } else { jSec.style.display = 'none'; }

                    if(d.grid.visible) {
                        document.getElementById('gridScreen').style.display = 'flex';
                        const gc = document.getElementById('gridContainer');
                        gc.innerHTML = '';
                        for(let i=1; i<=20; i++) {
                            let b = document.createElement('div');
                            let bClass = 'grid-btn';
                            if(d.grid.taken.includes(i)) bClass += ' taken';
                            b.className = bClass;
                            b.innerText = i;
                            b.setAttribute('onclick', 'if(window.opener) window.opener.handleGridClick('+i+')');
                            gc.appendChild(b);
                        }
                    } else if(d.phase === 'ready') {
                         document.getElementById('waitScreen').style.display = 'flex';
                         document.getElementById('waitList').innerText = (lang==='en'?"Q: ":"ﬁêﬁ™ﬁàﬁßﬁçﬁ™: ") + d.slots.map(s => s.id).join(', ');
                    } else if(d.phase === 'finished') {
                         document.getElementById('finishScreen').style.display = 'flex';
                    } else if(d.phase === 'active') {
                        document.getElementById('readScreen').style.display = 'flex';
                        const q = d.slots[d.activeIndex];
                        const statusTxt = document.getElementById('topStatusText');
                        const currentNum = d.activeIndex + 1;
                        if(currentNum === 1) statusTxt.innerText = childI18n.statFirst[lang];
                        else if(d.activeIndex === d.slots.length - 1 && d.slots.length > 1) statusTxt.innerText = childI18n.statLast[lang];
                        else statusTxt.innerText = childI18n.statMid[lang].replace('%N', currentNum);

                        document.getElementById('displaySelected').innerText = d.slots.map(s => s.id).join(', ');
                        document.getElementById('displayMode').innerText = (d.readingMode === 'memory') ? childI18n.rmMemory[lang] : childI18n.rmMushaf[lang];

                        const card = document.getElementById('mainScroll');
                        if(q) {
                            const img = document.getElementById('qImg');
                            const memTxt = document.getElementById('memoryText');
                            if(d.readingMode === 'memory') {
                                card.classList.add('memory-mode');
                                img.style.display = 'none';
                                memTxt.style.display = 'block';
                            } else {
                                card.classList.remove('memory-mode');
                                memTxt.style.display = 'none';
                                if(q.src) { img.src = q.src; img.style.display = 'block'; }
                            }
                        }

                        const listC = document.getElementById('qListContainer');
                        listC.innerHTML = '';
                        d.slots.forEach((slot, idx) => {
                            if(!slot) return; 
                            let item = document.createElement('div');
                            item.className = 'q-item ' + (idx === d.activeIndex ? 'active' : '');
                            item.innerHTML = \`<div style="color:#00e676;">\${childI18n.qPrefix[lang]} \${idx+1}</div>
                                <div style="color:#fff; font-weight:bold; font-size:1.1em;">\${slot.surah}</div>
                                <div style="margin-top:4px; font-size:0.8em; color:#ccc;"><span style="border:1px solid #555; padding:2px 6px; border-radius:4px; background:rgba(0,0,0,0.3);">Ayah: \${slot.start} - \${slot.end}</span></div>\`;
                            listC.appendChild(item);
                        });
                    } else {
                        document.getElementById('idleScreen').style.display = 'flex';
                    }
                }

                function updateCeremony(d) {
                    ['idleScreen','gridScreen','waitScreen','readScreen','finishScreen', 'ceremonyScreen'].forEach(id=>document.getElementById(id).style.display='none');
                    document.getElementById('signalLight').style.display = 'none'; 
                    
                    const screen = document.getElementById('ceremonyScreen');
                    screen.style.display = 'flex';
                    screen.className = 'theme-' + (d.ceremony.settings.themeIndex || 0);

                    const bStyle = d.ceremony.settings.borderStyle || 'theme';
                    const bData = d.ceremony.settings.borderData;
                    screen.style.border = ''; screen.style.borderImage = '';

                    if (bStyle === 'thin') {
                        screen.style.border = '0.5vmin solid #D4AF37'; 
                        screen.style.boxShadow = 'inset 0 0 2vmin #000'; 
                    } 
                    else if (bStyle === 'none') {
                        screen.style.border = 'none';
                    }
                    else if (bStyle === 'custom' && bData) {
                        screen.style.border = '5vmin solid transparent';
                        screen.style.borderImage = \`url('\${bData}') 30 stretch\`;
                    }

                    const cHead = document.getElementById('cHeader');
                    const cBody = document.getElementById('cBody');
                    const cFoot = document.getElementById('cFooter');
                    cHead.innerHTML = ''; cBody.innerHTML = ''; cFoot.innerHTML = '';

                    const data = d.ceremony;
                    const sets = d.ceremony.settings;
                    
                    if(data.phase === 'cover') {
                        cBody.innerHTML = \`<div class="c-cover">\${d.ceremonyTitle || "Quran Ceremony"}</div>\`;
                    } else if (data.phase === 'start') {
                         cBody.innerHTML = '<div class="c-basmalah">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>';
                    } else if (data.phase === 'end') {
                         cBody.innerHTML = '<div class="c-sadaqallah">ÿµŸéÿØŸéŸÇŸé Ÿ±ŸÑŸÑŸëŸ∞ŸáŸè Ÿ±ŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸè</div>';
                    } else if (data.phase === 'reciting') {
                        cHead.style.display = 'none'; 
                        const ayah = data.activeData[data.currentIndex];
                        let transText = "";
                        if(data.selectedLang === 'en') { transText = ayah.en || ayah.dv || ""; } else { transText = ayah.dv || ayah.en || ""; }

                        if(ayah) {
                            cBody.innerHTML = \`<div class="ceremony-quran" style="color:\${sets.arabicColor}; font-size:\${sets.arabicSize}vmin;">\${ayah.arabic}</div>
                                                <div class="ceremony-divider"></div>
                                                <div class="ceremony-trans" style="color:\${sets.transColor}; font-size:\${sets.transSize}vmin;">\${transText}</div>\`;
                        }
                    }
                }
            <\/script>
        </body>
        </html>`;
    }

    function openScreen(type) {
        const html = getTemplate();
        if(type === 'student') {
            if(state.windows.student) state.windows.student.close();
            state.windows.student = window.open("", "Student", "width=1280,height=720");
            if(state.windows.student) {
                state.windows.student.document.open();
                state.windows.student.document.write(html);
                state.windows.student.document.close(); 
            } else {
                alert("Please Allow Popups for this site!");
            }
        }
    }

    function openCeremonyScreen() {
        const html = getTemplate(true);
        if(state.windows.ceremony) state.windows.ceremony.close();
        state.windows.ceremony = window.open("", "Ceremony", "width=1280,height=720");
        if(state.windows.ceremony) {
            state.windows.ceremony.document.open();
            state.windows.ceremony.document.write(html);
            state.windows.ceremony.document.close();
            setTimeout(syncWindows, 500);
        } else {
             alert("Please Allow Popups for this site!");
        }
    }
// --- SINGLE JUDGE OPENER (WITH NAME DISPLAY) ---
    function openSingleJudge() {
        // 1. ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁßﬁáﬁ® ﬁÇﬁ¶ﬁÇﬁ∞ ﬁÄﬁØﬁãﬁ™ﬁÇﬁ∞
        const judgeNum = document.getElementById('targetJudgeSelect').value;
        
        // ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁÇﬁ∞ ﬁâﬁ®ﬁÑﬁ¶ﬁçﬁ¶ﬁÇﬁ© ﬁåﬁ®ﬁÑﬁß ﬁãﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁÄﬁ¨ﬁãﬁ® Input ﬁéﬁÆﬁÖﬁ®ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁÇﬁ¶ﬁâﬁ¨ﬁáﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁåﬁØ
        const nameInput = document.getElementById('jName' + judgeNum); 
        const judgeName = nameInput ? nameInput.value : ""; 

        const windowName = `Judge_${judgeNum}`;
        
        // ‚òÖ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁÄﬁ¶ﬁãﬁßﬁéﬁÆﬁåﬁ∞: ﬁÇﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁâﬁßﬁáﬁ¨ﬁÜﬁ™ÿå ﬁÇﬁ¨ﬁåﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁÄﬁ¶ﬁâﬁ¶ﬁáﬁ¨ﬁÜﬁ¶ﬁÇﬁ® "JUDGE X"
        let displayTitle = `JUDGE ${judgeNum}`;
        if(judgeName) {
            displayTitle += `<br><span style="font-size:20px; color:#fff; font-family:'AppFont';">${judgeName}</span>`;
        }

        // 2. ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ™ﬁÇﬁ∞
        let w = window.open("", windowName, "width=900,height=700");
        
        if(w) {
            w.document.open();
            // ﬁåﬁ¶ﬁáﬁ∞ﬁîﬁßﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
            w.document.write(getTemplate(false, displayTitle)); 
            w.document.close();
            
            w.judgeID = windowName;

            if(!state.windows.judges) state.windows.judges = [];
            
            const exists = state.windows.judges.some(win => win.judgeID === windowName);
            if(!exists) {
                state.windows.judges.push(w);
            }
        }
        
        // 3. ﬁëﬁ≠ﬁìﬁß ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
        setTimeout(syncWindows, 500);
    }
    function syncWindows() {
        const packet = {
            slots: state.session.slots, 
            activeIndex: state.session.activeIndex,
            phase: state.session.phase, 
            light: state.session.light,
            grid: state.grid, 
            readingMode: state.readingMode,
            currentLang: currentLang, 
            fontData: state.fontData,
            
            // ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®: ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁÅﬁ∞ ﬁäﬁÆﬁÇﬁ™ﬁàﬁ™ﬁÇﬁ∞
            judging: state.judging,
            
            ceremony: state.ceremony,
            ceremonyTitle: document.getElementById('ceremonyTitle') ? document.getElementById('ceremonyTitle').value : "Ceremony"
        };
        
        // Send to Student & Ceremony Screens
        const send = w => { if(w && !w.closed && w.updateState) w.updateState(packet); };
        
        send(state.windows.student);
        send(state.windows.ceremony);
        
        // Send to Judge Screens
        if(state.windows.judges) {
            state.windows.judges.forEach(w => send(w));
        }
    }
    
    // INITIALIZATION
    initThemes();
    if(themeList.length > 0) state.theme = themeList[0];
    setMode('judge');
    renderSlots();
    loadFromLocal(); // Try loading saved state on startup

    document.addEventListener('contextmenu', function(event) { event.preventDefault(); });
    
   function downloadMasterCSVTemplate() {
    // ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁäﬁ™ﬁÖﬁ™ﬁàﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™:
    const headers = [
        "Serial No",        // ﬁêﬁ™ﬁâﬁßﬁÉﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Reg No",           // ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Age Group",        // ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß
        "Branch",           // ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁß ﬁéﬁÆﬁäﬁ®
        "Institution",      // ﬁâﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁàﬁß ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß
        "Full Name",        // ﬁäﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁâﬁ¶ ﬁÇﬁ¶ﬁÇﬁ∞
        "Gender",           // ﬁñﬁ®ﬁÇﬁ∞ﬁêﬁ™ (ﬁáﬁ¶ﬁÇﬁ∞ﬁÄﬁ¨ﬁÇﬁ∞/ﬁäﬁ®ﬁÉﬁ®ﬁÄﬁ¨ﬁÇﬁ∞)
        "Address",          // ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞
        "ID Card",          // ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ© ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Contact No",       // ﬁéﬁ™ﬁÖﬁ≠ﬁÇﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉ
        "Parent Name",      // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞
        "Parent Phone",     // ﬁÑﬁ¨ﬁçﬁ¨ﬁÇﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁß ﬁäﬁØﬁÇﬁ™
        "Email"             // ﬁáﬁ©ﬁâﬁ¨ﬁáﬁ®ﬁçﬁ∞
    ];
    
    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Rasfahi_Master_Template_V26.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    // D. ﬁâﬁßﬁêﬁ∞ﬁìﬁ¶ﬁÉ ﬁùﬁ©ﬁìﬁ∞ ﬁáﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁïﬁØﬁìﬁ∞ (Export Master Sheet) - FINAL FIXED VERSION
function exportMasterResultSheet() {
    // 1. ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁßﬁáﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁÉﬁ®ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if(!state.judging.savedResults || state.judging.savedResults.length === 0) {
        alert("No results to export! (ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ¨ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ﬁÇﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞)");
        return;
    }

    // 2. ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁåﬁ¶ﬁáﬁ∞ (Headers) - ﬁåﬁ®ﬁÑﬁß ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁäﬁ™ﬁÖﬁ™ﬁàﬁ® ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™
    let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

    // ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉ (Rubric Headers)
    if(state.judging.rubric) {
        state.judging.rubric.forEach(r => {
            csv += `${r.name} (Avg),`; 
        });
    }

    // ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁÄﬁ¨ﬁëﬁ¶ﬁÉﬁåﬁ¶ﬁáﬁ∞ (Judge 1 to 7)
    for(let i=1; i<=7; i++) {
        csv += `Judge ${i} Total,`;
    }

    // ﬁäﬁ¶ﬁÄﬁ™ ﬁÜﬁÆﬁçﬁ¶ﬁâﬁ∞ﬁåﬁ¶ﬁáﬁ∞
    csv += "FINAL AVERAGE,RANK,REMARKS\n";

    // 3. ﬁëﬁ≠ﬁìﬁß ﬁêﬁØﬁìﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁâﬁ¶ﬁåﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁÄﬁØﬁãﬁ® ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞)
    let sortedList = [...state.judging.savedResults].sort((a, b) => b.finalScore - a.finalScore);

    // 4. ﬁÜﬁÆﬁÇﬁ∞ﬁâﬁ¨ ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁ¨ﬁáﬁ∞ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ (Rows)
    sortedList.forEach((s, index) => {
        let row = [];
        
        // A. ﬁÜﬁ™ﬁáﬁ∞ﬁñﬁßﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™ (Personal Info) - New Order
        row.push(index + 1); // 1. ﬁêﬁ™ﬁâﬁßﬁÉﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ (ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ ﬁåﬁ¶ﬁÉﬁ™ﬁåﬁ©ﬁÑﬁ™ﬁÇﬁ∞)
        row.push(`"${s.reg||''}"`, `"${s.group||''}"`, `"${s.branch||''}"`, `"${s.institution||''}"`);
        row.push(`"${s.name||''}"`, `"${s.gender||''}"`, `"${s.address||''}"`, `"${s.id||''}"`);
        row.push(`"${s.phone||''}"`, `"${s.parent||''}"`, `"${s.parentPhone||''}"`, `"${s.email||''}"`);

        // B. ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞ (Placeholder)
        if(state.judging.rubric) {
            state.judging.rubric.forEach(() => row.push("-")); 
        }

        // C. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁàﬁ¶ﬁÜﬁ®ﬁàﬁ¶ﬁÜﬁ® ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (Judge Totals)
        for(let i=1; i<=7; i++) {
            let key = `Judge_${i}`; 
            let val = (s.scores && s.scores[key] !== undefined) ? s.scores[key] : "-";
            row.push(val);
        }

        // D. ﬁäﬁ¶ﬁáﬁ®ﬁÇﬁ¶ﬁçﬁ∞ ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß (Avg & Rank)
        row.push(s.finalScore); // ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁáﬁ¨ﬁàﬁ∞ﬁÉﬁ¨ﬁñﬁ∞
        row.push(index + 1);    // ﬁÉﬁ≠ﬁÇﬁ∞ﬁÜﬁ∞ (ﬁàﬁ¶ﬁÇﬁ¶)
        row.push("");           // ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞ (ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞)

        // ﬁÉﬁØ ﬁÇﬁ®ﬁÇﬁ∞ﬁâﬁßﬁçﬁ™ﬁÇﬁ∞
        csv += row.join(",") + "\n";
    });

    // 5. ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    const dateStr = new Date().toISOString().split('T')[0];
    const fileName = `Rasfahi_Master_NEW_FORMAT_${dateStr}.csv`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    function getFilteredResults() {
        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;

        // Filter Data
        let list = state.judging.savedResults.filter(r => {
            // Check Branch (Flexible check)
            let branchMatch = (fBranch === "All") ? true : (r.branch && r.branch.includes(fBranch));
            // Manual fixes for Dhivehi naming if needed
            if(fBranch === "Balaiygen" && r.branch && r.branch.toLowerCase().includes("balai")) branchMatch = true;
            if(fBranch === "Nubalai" && r.branch && r.branch.toLowerCase().includes("nubalai")) branchMatch = true;

            // Check Group
            let groupMatch = (fGroup === "All") ? true : (r.group === fGroup);

            return branchMatch && groupMatch;
        });

        // Sort Highest to Lowest
        return list.sort((a, b) => b.finalScore - a.finalScore);
    }

    // ADVANCED REPORT WITH FARUUMA FONT
function generateAdvancedReport(mode) {
    let list = getFilteredResults();
    
    let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
    if(mode === 'top3') { list = list.slice(0, 3); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3)"; }
    if(mode === 'top5') { list = list.slice(0, 5); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5)"; }

    if(list.length === 0) { alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!"); return; }

    const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const chiefName = document.getElementById('rptChief').value || "__________________";
    const judgeCount = parseInt(document.getElementById('rptJudgeCount').value) || 3;
    
    const branchTxt = document.getElementById('rptFilterBranch').options[document.getElementById('rptFilterBranch').selectedIndex].text;
    const groupTxt = document.getElementById('rptFilterGroup').options[document.getElementById('rptFilterGroup').selectedIndex].text;

    let sigLines = '';
    for(let i=1; i<=judgeCount; i++) {
        sigLines += `<div class="sig-box"><div class="line"></div><div class="label">ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ ${i}</div></div>`;
    }

    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Result Report</title>
        <style>
            @font-face {
                font-family: 'Faruuma';
                src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
            }
            body { font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif; padding: 40px; direction: rtl; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 20px; }
            h1 { margin: 5px 0; font-size: 26px; font-weight:bold; }
            h2 { margin: 5px 0; font-size: 20px; color: #333; }
            h3 { margin: 5px 0; font-size: 18px; text-decoration: underline; }
            
            .report-info-box {
                border: 1px solid #000; padding: 15px; margin-bottom: 20px;
                display: flex; justify-content: space-between;
                background: #f9f9f9; font-weight: bold; font-size: 14px;
            }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
            th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
            th { background: #eee; font-weight: bold; font-size: 15px; }
            tr:nth-child(1) td { background: #fffbe6; font-weight:bold; } 

            .footer { margin-top: 50px; page-break-inside: avoid; }
            .chief-section { text-align: left; margin-bottom: 50px; margin-top:20px; } 
            .judges-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
            .sig-box { width: 30%; text-align: center; margin-bottom: 30px; }
            .line { border-bottom: 1px dotted #000; margin-bottom: 5px; height: 40px; }
            .label { font-size: 12px; color: #555; }
            @media print { button { display: none; } body { -webkit-print-color-adjust: exact; } }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="position:fixed; top:10px; left:10px; padding:10px 20px; background:blue; color:white; cursor:pointer;">üñ®Ô∏è PRINT</button>
        <div class="header">
            <h1>${instName}</h1>
            <h2>${compName}</h2>
            <h3>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞ ${titleSuffix}</h3>
        </div>
        <div class="report-info-box">
            <div>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</div>
            <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß: ${groupTxt}</div>
            <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                    <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                    <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                    <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                    <th width="25%">ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</th>
                    <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                    <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                </tr>
            </thead>
            <tbody>
                ${list.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.reg || "-"}</td>
                        <td style="text-align:right; padding-right:10px;">${s.name}</td>
                        <td>${s.id}</td>
                        <td style="text-align:right; font-size:11px;">${s.address || "-"}</td>
                        <td><b>${s.finalScore}</b></td>
                        <td></td>
                    </tr>`).join('')}
            </tbody>
        </table>
        <div class="footer">
            <div class="chief-section">
                <div>ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™:</div>
                <div style="margin-top:40px; border-bottom:1px solid #000; display:inline-block; width:250px;"></div>
                <div style="margin-top:5px;">${chiefName}</div>
            </div>
            <div class="judges-grid">${sigLines}</div>
        </div>
    </body>
    </html>`;

    const w = window.open("", "Report", "width=1100,height=800");
    w.document.write(html);
    w.document.close();
}
    // --- FILTERED CSV EXPORT (Separate file for specific category) ---
    function exportFilteredCSV() {
        let list = getFilteredResults();
        if(list.length === 0) { alert("No data found for this filter."); return; }

        let csv = "Rank,Name,ID,Group,Branch,FinalScore\n";
        
        list.forEach((s, i) => {
            csv += `${i+1},"${s.name}","${s.id}","${s.group}","${s.branch}",${s.finalScore}\n`;
        });

        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;
        const fileName = `Result_${fBranch}_${fGroup}.csv`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
   function getFilteredResults() {
    const fBranch = document.getElementById('rptFilterBranch').value;
    const fGroup = document.getElementById('rptFilterGroup').value;
    const fInst = document.getElementById('rptFilterInstType').value;

    let list = state.judging.savedResults.filter(r => {
        // Branch Check
        let branchMatch = (fBranch === "All") ? true : (r.branch && r.branch.includes(fBranch));
        
        // Group Check
        let groupMatch = (fGroup === "All") ? true : (r.group === fGroup);
        
        // Institution Check (New)
        let instMatch = (fInst === "All") ? true : (r.institution && r.institution.includes(fInst));
        if(fInst === "School" && r.institution && r.institution.toLowerCase().includes("school")) instMatch = true;

        return branchMatch && groupMatch && instMatch;
    });

    return list.sort((a, b) => b.finalScore - a.finalScore);
}
    // --- ADVANCED REPORT GENERATION (UPDATED WITH FULL DETAILS) ---
    function generateAdvancedReport(mode) {
        // 1. Get Data & Filter
        let list = getFilteredResults();
        
        // Handle Modes (Top 3, Top 5, or Full)
        let titleSuffix = "(ﬁâﬁ™ﬁÖﬁ® ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™)";
        if(mode === 'top3') { list = list.slice(0, 3); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 3)"; }
        if(mode === 'top5') { list = list.slice(0, 5); titleSuffix = "(ﬁéﬁ¶ﬁãﬁ¶ 5)"; }

        if(list.length === 0) { alert("ﬁâﬁ® ﬁÜﬁ¨ﬁìﬁ¶ﬁéﬁ¶ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨!"); return; }

        // 2. Get Header Info form Inputs
        const instName = document.getElementById('rptInstName').value || "ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞";
        const compName = document.getElementById('rptCompName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞ 2026";
        const chiefName = document.getElementById('rptChief').value || "__________________";
        const judgeCount = parseInt(document.getElementById('rptJudgeCount').value) || 3;
        
        // Get Category Details
        const branchTxt = document.getElementById('rptFilterBranch').options[document.getElementById('rptFilterBranch').selectedIndex].text;
        const groupTxt = document.getElementById('rptFilterGroup').options[document.getElementById('rptFilterGroup').selectedIndex].text;

        // 3. Generate Signature Lines
        let sigLines = '';
        for(let i=1; i<=judgeCount; i++) {
            sigLines += `
                <div class="sig-box">
                    <div class="line"></div>
                    <div class="label">ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™ ${i}</div>
                </div>`;
        }

        // 4. HTML Structure (Dhivehi / Thaana Friendly)
        const html = `
        <!DOCTYPE html>
        <html dir="rtl" lang="dv">
        <head>
            <title>Result Report</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                
                body { 
                    font-family: 'Noto Sans Thaana', 'Faruma', sans-serif; 
                    padding: 40px; 
                    direction: rtl;
                }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 3px double #000; padding-bottom: 20px; }
                h1 { margin: 5px 0; font-size: 26px; font-weight:bold; }
                h2 { margin: 5px 0; font-size: 20px; color: #333; }
                h3 { margin: 5px 0; font-size: 18px; text-decoration: underline; }
                
                .report-info-box {
                    border: 1px solid #000;
                    padding: 15px;
                    margin-bottom: 20px;
                    display: flex;
                    justify-content: space-between;
                    background: #f9f9f9;
                    font-weight: bold;
                    font-size: 14px;
                }

                table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
                th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
                th { background: #eee; font-weight: bold; font-size: 13px; }
                
                /* Rank 1 Highlight */
                tr:nth-child(1) td { background: #fffbe6; font-weight:bold; } 

                .footer { margin-top: 50px; page-break-inside: avoid; }
                .chief-section { text-align: left; margin-bottom: 50px; margin-top:20px; } 
                .judges-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
                .sig-box { width: 30%; text-align: center; margin-bottom: 30px; }
                .line { border-bottom: 1px dotted #000; margin-bottom: 5px; height: 40px; }
                .label { font-size: 12px; color: #555; }
                
                @media print {
                    button { display: none; }
                    body { -webkit-print-color-adjust: exact; }
                    @page { size: A4 landscape; margin: 10mm; } 
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" style="position:fixed; top:10px; left:10px; padding:10px 20px; font-size:20px; background:blue; color:white; cursor:pointer; border:none; border-radius:5px;">üñ®Ô∏è PRINT / SAVE PDF</button>

            <div class="header">
                <h1>${instName}</h1>
                <h2>${compName}</h2>
                <h3>ﬁÇﬁ¶ﬁåﬁ©ﬁñﬁß ﬁùﬁ©ﬁìﬁ∞ ${titleSuffix}</h3>
            </div>

            <div class="report-info-box">
                <div>ﬁéﬁÆﬁäﬁ®: ${branchTxt}</div>
                <div>ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™ﬁäﬁ™ﬁÉﬁß: ${groupTxt}</div>
                <div>ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}</div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="5%">ﬁàﬁ¶ﬁÇﬁ¶</th>
                        <th width="10%">ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©</th>
                        <th width="25%">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞</th>
                        <th width="10%">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ©</th>
                        <th width="25%">ﬁãﬁßﬁáﬁ®ﬁâﬁ© ﬁáﬁ¨ﬁëﬁ∞ﬁÉﬁ¨ﬁêﬁ∞</th>
                        <th width="10%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                        <th width="15%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${list.map((s, i) => `
                        <tr>
                            <td>${i+1}</td>
                            <td>${s.reg || "-"}</td>
                            <td style="text-align:right; padding-right:10px;">${s.name}</td>
                            <td>${s.id}</td>
                            <td style="text-align:right; font-size:11px;">${s.address || "-"}</td>
                            <td><b>${s.finalScore}</b></td>
                            <td></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="footer">
                <div class="chief-section">
                    <div>ﬁáﬁ®ﬁêﬁ∞ ﬁäﬁ¶ﬁÇﬁëﬁ®ﬁîﬁßﬁÉﬁ™:</div>
                    <div style="margin-top:40px; border-bottom:1px solid #000; display:inline-block; width:250px;"></div>
                    <div style="margin-top:5px;">${chiefName}</div>
                </div>

                <div class="judges-grid">
                    ${sigLines}
                </div>
            </div>
        </body>
        </html>`;

        const w = window.open("", "Report", "width=1100,height=800");
        w.document.write(html);
        w.document.close();
    }
    // --- FILTERED CSV EXPORT (Separate file for specific category) ---
    function exportFilteredCSV() {
        let list = getFilteredResults();
        if(list.length === 0) { alert("No data found for this filter."); return; }

        let csv = "Rank,Name,ID,Group,Branch,FinalScore\n";
        
        list.forEach((s, i) => {
            csv += `${i+1},"${s.name}","${s.id}","${s.group}","${s.branch}",${s.finalScore}\n`;
        });

        const fBranch = document.getElementById('rptFilterBranch').value;
        const fGroup = document.getElementById('rptFilterGroup').value;
        const fileName = `Result_${fBranch}_${fGroup}.csv`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    // --- NEW FUNCTION: PRINT BLANK MANUAL SCORE SHEET ---
function downloadManualScoreSheet() {
    // 1. Get Rubric & Settings
    const rubric = state.judging.rubric;
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "Official Score Sheet";
    
    // Calculate Total Marks
    let totalMax = 0;
    rubric.forEach(r => totalMax += r.max);

    // 2. Build Table Rows (Dynamic)
    let rows = "";
    rubric.forEach(r => {
        rows += `
        <tr>
            <td style="text-align:right; font-weight:bold; font-family:'Faruuma', serif; font-size:16px;">
                ${r.name}
            </td>
            <td style="font-weight:bold;">${r.max}</td>
            <td></td> <td style="color:#ccc;">___________</td> </tr>`;
    });

    // 3. HTML Layout (A4 Design)
    const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Judge Score Sheet</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
            
            body { 
                font-family: 'Noto Sans Thaana', 'Faruuma', sans-serif; 
                padding: 40px; 
                direction: rtl;
                -webkit-print-color-adjust: exact;
            }
            .sheet-container {
                border: 5px double #000;
                padding: 30px;
                height: 95vh;
                box-sizing: border-box;
                position: relative;
            }
            h1 { text-align: center; margin: 0; font-size: 24px; text-decoration: underline; }
            h2 { text-align: center; margin: 5px 0 30px 0; font-size: 18px; color: #444; }

            .info-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
                border: 1px solid #333;
                padding: 15px;
                background: #f9f9f9;
            }
            .input-line { margin-bottom: 15px; font-size: 14px; font-weight: bold; }
            .dotted { border-bottom: 2px dotted #000; display: inline-block; width: 60%; }

            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000; padding: 12px; text-align: center; vertical-align: middle; }
            th { background: #eee; font-size: 15px; font-weight: bold; }

            .total-row td { background: #333; color: #fff; font-weight: bold; font-size: 18px; }
            
            .footer-sig {
                margin-top: 50px;
                display: flex;
                justify-content: space-between;
            }
            .sig-box { text-align: center; width: 40%; }

            @media print {
                button { display: none; }
                @page { size: A4 portrait; margin: 10mm; }
            }
        </style>
    </head>
    <body>
        <button onclick="window.print()" style="width:100%; padding:20px; font-size:20px; background:#002200; color:#fff; cursor:pointer; margin-bottom:20px;">üñ®Ô∏è CLICK TO PRINT / SAVE PDF</button>

        <div class="sheet-container">
            <h1>${instName}</h1>
            <h2>${compName} - ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞</h2>

            <div class="info-grid">
                <div>
                    <div class="input-line">ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞: <span class="dotted"></span></div>
                    <div class="input-line">ﬁáﬁ¶ﬁáﬁ®.ﬁëﬁ© / ﬁÉﬁ¨ﬁñﬁ®ﬁêﬁ∞ﬁìﬁ∞ﬁÉﬁ©: <span class="dotted" style="width:50%"></span></div>
                    <div class="input-line">ﬁéﬁÆﬁäﬁ® / ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™: <span class="dotted"></span></div>
                </div>
                <div style="text-align:left;">
                    <div class="input-line" style="direction:ltr;">Date: __________________</div>
                    <div class="input-line" style="direction:ltr;">Judge Name: __________________</div>
                    <div class="input-line" style="direction:ltr;">Judge ID: _________</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="40%">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>
                        <th width="15%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                        <th width="20%">ﬁãﬁ≠ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                        <th width="25%">ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                    <tr class="total-row">
                        <td style="text-align:right;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (TOTAL)</td>
                        <td>${totalMax}</td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top:40px; border:1px dashed #777; padding:15px; height:80px;">
                <strong>ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁäﬁßﬁÄﬁ¶ﬁéﬁ¶ﬁåﬁ¶ﬁáﬁ∞ (General Remarks):</strong>
            </div>

            <div class="footer-sig">
                <div class="sig-box">
                    <br>_______________________<br>
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ® (Signature)
                </div>
                <div class="sig-box">
                     <div style="border:1px solid #000; height:50px; width:100px; margin:0 auto;"></div>
                     ﬁáﬁÆﬁäﬁ®ﬁùﬁ¶ﬁçﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁâﬁ¶ﬁÅﬁ∞
                </div>
            </div>
        </div>
    </body>
    </html>
    `;

    // 4. Open Window & Print
    const w = window.open("", "ManualSheet", "width=900,height=1000");
    w.document.write(html);
    w.document.close();
}
    // ... (ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ® ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ∞ ﬁÜﬁØﬁëﬁ™ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨) ...

    // ‚òÖ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ¶ﬁÅﬁ∞ ﬁåﬁ®ﬁÉﬁ©ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÜﬁØﬁëﬁ™ ﬁïﬁ≠ﬁêﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß ‚òÖ

    // C. ﬁäﬁ≠ﬁÜﬁ∞ ﬁëﬁ≠ﬁìﬁß ﬁñﬁ¨ﬁÇﬁ¨ﬁÉﬁ≠ﬁìﬁ¶ﬁÉ (Fake Master Data Generator)
    function generateDummyMasterSheet() {
        // 1. Headers (Matching your requested format)
        let csv = "Serial No,Reg No,Age Group,Branch,Institution,Full Name,Gender,Address,ID Card,Contact,Parent Name,Parent Phone,Email,";

        // Rubric Headers
        const dummyRubric = (state.judging && state.judging.rubric && state.judging.rubric.length > 0) ? state.judging.rubric : [
            {name:"Thilawa", max:30}, {name:"Tajweed", max:20}, {name:"Fasaha", max:10} // Fallback
        ];
        dummyRubric.forEach(r => csv += `${r.name} (Avg),`);

        // Judge Totals (Assume 3 Judges for testing)
        const judgeCount = 3;
        for(let i=1; i<=judgeCount; i++) csv += `Judge ${i} Total,`;

        csv += "FINAL AVERAGE,RANK,REMARKS\n";

        // 2. Helper Arrays for Random Data
        const names = ["Ahmed Ali", "Fathimath Zeena", "Mohamed Sinaan", "Aishath Yumna", "Ibrahim Rasheed", "Mariyam Naza", "Hassan Kinaan"];
        const islands = ["Male'", "Hulhumale'", "Addu City", "Fuvahmulah", "Kulhudhuffushi", "Thinadhoo"];
        const groups = ["Under 6", "Under 9", "Under 11", "Under 13", "General"];
        const branches = ["Balaiygen", "Nubalai"];
        const insts = ["Iskandhar School", "Arabiyya", "Majeedhiyya", "Villa College", "Private"];

        // 3. Generate 50 Dummy Students
        let students = [];
        for(let i=0; i<50; i++) {
            let scores = [];
            let total = 0;
            
            // Generate random scores for 3 judges
            for(let j=0; j<judgeCount; j++) {
                let s = (Math.random() * (100 - 60) + 60).toFixed(2); // Score between 60 and 100
                scores.push(parseFloat(s));
                total += parseFloat(s);
            }
            let finalAvg = (total / judgeCount).toFixed(2);

            students.push({
                reg: `REG-${1000+i}`,
                group: groups[Math.floor(Math.random()*groups.length)],
                branch: branches[Math.floor(Math.random()*branches.length)],
                inst: insts[Math.floor(Math.random()*insts.length)],
                name: names[Math.floor(Math.random()*names.length)] + " " + i,
                gender: Math.random() > 0.5 ? "Male" : "Female",
                addr: islands[Math.floor(Math.random()*islands.length)],
                id: `A${Math.floor(Math.random()*900000)+100000}`,
                scores: scores,
                finalScore: parseFloat(finalAvg)
            });
        }

        // 4. Sort by Final Score
        students.sort((a, b) => b.finalScore - a.finalScore);

        // 5. Build CSV Rows
        students.forEach((s, idx) => {
            let row = [];
            row.push(idx + 1); // Serial (Rank Based)
            row.push(s.reg, s.group, s.branch, s.inst, s.name, s.gender, s.addr, s.id, "7770000", "Parent Name", "7771111", "test@email.com");
            
            // Empty Rubric Avgs
            dummyRubric.forEach(() => row.push("-"));

            // Judge Scores
            s.scores.forEach(sc => row.push(sc));

            // Final
            row.push(s.finalScore);
            row.push(idx + 1); // Rank
            row.push("Generated");

            csv += row.join(",") + "\n";
        });

        // 6. Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Fake_Master_Data_For_Testing.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    // --- BULK JUDGE SHEET PRINTING (FARUUMA FONT) ---
function printBulkJudgeSheets() {
    const judgeKey = document.getElementById('bulkJudgeSelect').value; // e.g., "Judge_1"
    const savedData = state.judging.savedResults;

    if (!savedData || savedData.length === 0) {
        alert("ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁãﬁ©ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁàﬁ¨ﬁêﬁ∞ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¶ﬁÜﬁ™ ﬁÇﬁ¨ﬁåﬁ¨ﬁàﬁ¨.");
        return;
    }

    // Report Headers
    const instName = document.getElementById('rptInstName').value || "ﬁ§ﬁ™ﬁÉﬁ™ﬁáﬁßﬁÇﬁ∞ ﬁâﬁ™ﬁÑﬁßﬁÉﬁßﬁåﬁ∞";
    const compName = document.getElementById('rptCompName').value || "ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞ ﬁùﬁ©ﬁìﬁ∞";

    // Rubric Items
    const rubric = state.judging.rubric;
    
    // Generate Sheets HTML
    let sheetsHTML = "";

    savedData.forEach((student, index) => {
        // Calculate Marks given by THIS specific judge
        let judgeTotal = student.scores[judgeKey] || 0;
        let marksRows = "";
        
        // Note: Since we only save the Total Score per judge (to save memory), 
        // we can't show the breakdown per category unless we change the saving logic.
        // For now, we will show the Categories and leave marks blank or show Total.
        // If you want breakdown, we need to change how data is SAVED first.
        // Assuming user wants the "Total" shown and categories listed for signature.

        rubric.forEach(r => {
            marksRows += `
            <tr>
                <td style="text-align:right;">${r.name}</td>
                <td>${r.max}</td>
                <td>-</td> </tr>`;
        });

        // Add Page Break for all except last one
        const pageBreak = (index < savedData.length - 1) ? "page-break-after: always;" : "";

        sheetsHTML += `
        <div class="sheet-page" style="${pageBreak}">
            <div class="sheet-header">
                <h1>${instName}</h1>
                <h2>${compName}</h2>
                <div class="judge-badge">${judgeKey.replace('_', ' ')}</div>
            </div>

            <div class="student-info">
                <table class="info-table">
                    <tr>
                        <td class="label">ﬁÇﬁ¶ﬁÇﬁ∞:</td>
                        <td class="data">${student.name}</td>
                        <td class="label">ﬁáﬁ¶ﬁáﬁ®ﬁëﬁ©:</td>
                        <td class="data">${student.id}</td>
                    </tr>
                    <tr>
                        <td class="label">ﬁéﬁÆﬁäﬁ®:</td>
                        <td class="data">${student.branch}</td>
                        <td class="label">ﬁ¢ﬁ™ﬁâﬁ™ﬁÉﬁ™:</td>
                        <td class="data">${student.group}</td>
                    </tr>
                    <tr>
                        <td class="label">ﬁâﬁ™ﬁáﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁêﬁß:</td>
                        <td class="data" colspan="3">${student.institution || student.instType || '-'}</td>
                    </tr>
                </table>
            </div>

            <table class="marks-table">
                <thead>
                    <tr>
                        <th width="50%">ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (Criteria)</th>
                        <th width="20%">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶</th>
                        <th width="30%">ﬁãﬁ®ﬁÇﬁ∞ ﬁâﬁßﬁÜﬁ™ﬁêﬁ∞</th>
                    </tr>
                </thead>
                <tbody>
                    ${marksRows}
                    <tr class="total-row">
                        <td style="text-align:right; font-weight:bold;">ﬁñﬁ™ﬁâﬁ∞ﬁçﬁ¶ (TOTAL)</td>
                        <td></td>
                        <td style="font-size:24px;">${judgeTotal}</td>
                    </tr>
                </tbody>
            </table>

            <div class="remarks-box">
                <p>ﬁÉﬁ®ﬁâﬁßﬁÜﬁ∞ﬁêﬁ∞: __________________________________________________</p>
            </div>

            <div class="signature-area">
                <div>
                    ____________________<br>
                    ﬁñﬁ¶ﬁñﬁ™ﬁéﬁ¨ ﬁêﬁÆﬁáﬁ®
                </div>
                <div>
                    ﬁåﬁßﬁÉﬁ©ﬁöﬁ∞: ${new Date().toLocaleDateString()}
                </div>
            </div>
            
            <div class="footer-tiny">Serial: ${index + 1} | Reg: ${student.reg || '-'}</div>
        </div>
        `;
    });

    // Full HTML Document with Faruuma Font
    const fullHTML = `
    <!DOCTYPE html>
    <html dir="rtl" lang="dv">
    <head>
        <title>Bulk Judge Sheets</title>
        <style>
            /* Font Imports */
            @font-face {
                font-family: 'Faruuma';
                src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
            }
            
            body { 
                font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif; 
                margin: 0; padding: 20px; background: #ccc; 
            }
            
            .sheet-page {
                background: white;
                width: 210mm; /* A4 Width */
                min-height: 297mm; /* A4 Height */
                padding: 40px;
                margin: 0 auto 20px auto;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }

            h1, h2 { text-align: center; margin: 5px 0; }
            h1 { font-size: 28px; text-decoration: underline; }
            h2 { font-size: 20px; color: #444; }

            .judge-badge {
                position: absolute; top: 40px; left: 40px;
                border: 2px solid #000; padding: 5px 10px;
                font-weight: bold; font-size: 18px; text-transform: uppercase;
                direction: ltr;
            }

            .info-table { width: 100%; border-collapse: collapse; margin-top: 30px; margin-bottom: 20px; }
            .info-table td { padding: 8px; border: 1px solid #ddd; font-size: 16px; }
            .label { background: #f9f9f9; font-weight: bold; width: 15%; }
            .data { width: 35%; font-weight:bold; }

            .marks-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .marks-table th { background: #eee; padding: 10px; border: 1px solid #000; font-weight: bold; }
            .marks-table td { padding: 10px; border: 1px solid #000; text-align: center; font-size: 18px; }
            
            .total-row td { background: #333; color: white; border-color: #000; }

            .remarks-box { margin-top: 40px; border: 1px dashed #000; padding: 20px; height: 60px; }
            
            .signature-area { margin-top: 60px; display: flex; justify-content: space-between; padding: 0 50px; font-size: 18px; }
            
            .footer-tiny { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; font-size: 10px; color: #888; direction: ltr; }

            @media print {
                body { background: none; padding: 0; }
                .sheet-page { margin: 0; box-shadow: none; width: 100%; }
                button { display: none; }
            }
        </style>
    </head>
    <body>
        <div style="text-align:center; margin-bottom:20px;">
            <button onclick="window.print()" style="padding:15px 30px; font-size:20px; background:blue; color:white; border:none; cursor:pointer;">
                üñ®Ô∏è CLICK TO PRINT / SAVE AS PDF
            </button>
        </div>
        ${sheetsHTML}
    </body>
    </html>
    `;

    const w = window.open("", "BulkPrint", "width=900,height=1000");
    w.document.write(fullHTML);
    w.document.close();
}
    // --- NEW SEARCH LOGIC (DATALIST) ---

// 1. Update the Datalist when batch is loaded
function populateStudentSelector() {
    const dList = document.getElementById('studentDatalist');
    dList.innerHTML = ''; // Clear old
    
    state.allStudents.forEach((s, idx) => {
        const option = document.createElement('option');
        // Value contains the unique identifier to find it later
        option.value = `${s.name} (${s.id})`; 
        dList.appendChild(option);
    });
}

// 2. Handle Selection (When user picks from list or hits enter)
function onStudentSelected(val) {
    if(!val) return;
    
    // Find the index of the selected student string
    // We check if "Name (ID)" matches the input
    const index = state.allStudents.findIndex(s => `${s.name} (${s.id})` === val);
    
    if (index > -1) {
        populateStudentForm(index);
        // Optional: Clear input after selection if desired, or keep it
    } else {
        alert("Student not found! Please check the name.");
    }
}
</script>
</body>
</html>
