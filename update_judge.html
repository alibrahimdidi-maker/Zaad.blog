<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaad Royal V24 (Fixed Edition)</title>
    <style>
        /* --- FONTS --- */
        @font-face { font-family: 'Faruma'; src: url('fonts/af_faruma.ttf'); }
        @font-face { font-family: 'Madina'; src: url('fonts/MADDINA.ttf'); }
        
        :root {
            --gold: #FFD700;
            --blue: #001a33;
            --glass: rgba(0, 20, 40, 0.9);
        }

        body {
            background: radial-gradient(circle, #002244, #000);
            color: #fff; margin: 0; font-family: 'Faruma', sans-serif;
            height: 100vh; overflow: hidden;
        }

        /* --- LAYOUTS --- */
        .view { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; }
        .active { display: flex; }
        
        /* Login & Card Styles */
        .center-box { justify-content: center; align-items: center; background: #000; z-index: 100; }
        .card { 
            background: var(--glass); border: 2px solid var(--gold); padding: 40px; 
            border-radius: 15px; text-align: center; width: 400px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
        }

        input, select, textarea {
            width: 100%; padding: 10px; margin-top: 10px;
            background: rgba(0,0,0,0.5); border: 1px solid #555;
            color: #fff; text-align: center; border-radius: 5px;
            font-family: inherit; font-size: 16px;
        }

        button {
            width: 100%; padding: 12px; margin-top: 15px; cursor: pointer;
            border: none; border-radius: 5px; font-weight: bold; font-size: 16px;
            font-family: inherit; transition: 0.2s;
        }
        .btn-gold { background: linear-gradient(45deg, #B8860B, #FFD700); color: #000; }
        .btn-blue { background: #004080; color: #fff; border: 1px solid var(--gold); }
        .btn-red { background: #800000; color: #fff; }

        /* --- DASHBOARD GRIDS --- */
        .dashboard { display: grid; grid-template-columns: 250px 1fr 300px; width: 100%; height: 100%; }
        .sidebar { background: rgba(0,0,0,0.6); border-left: 1px solid #333; padding: 15px; overflow-y: auto; }
        .main-area { padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        
        .panel-box {
            background: rgba(255, 255, 255, 0.05); border: 1px solid #444;
            padding: 15px; border-radius: 10px; width: 100%; margin-bottom: 20px;
        }

        /* List Items */
        .list-item { 
            padding: 10px; border-bottom: 1px solid #333; cursor: pointer; 
            display: flex; justify-content: space-between; 
        }
        .list-item:hover { background: rgba(255, 215, 0, 0.2); }
        .list-item.selected { background: var(--gold); color: #000; font-weight: bold; }

        /* Judge Specific */
        .judge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; padding: 20px; }
        .score-input { font-size: 20px; font-weight: bold; color: var(--gold); }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #001a33; border: 2px solid var(--gold); padding: 30px; width: 600px; border-radius: 10px; }

    </style>
</head>
<body>

    <div id="v-login" class="view active center-box">
        <div class="card">
            <h1 style="color:var(--gold); margin:0;">ZAAD ROYAL V24</h1>
            <p>Ultimate Quran Competition System</p>
            
            <select id="roleSelect">
                <option value="admin">Admin (Controller)</option>
                <option value="judge">Judge (Scorer)</option>
            </select>
            
            <input type="password" id="passInput" placeholder="Password" style="direction:ltr;">
            <button onclick="login()" class="btn-gold">LOGIN</button>
        </div>
    </div>

    <div id="v-admin" class="view">
        <div class="dashboard">
            <div class="sidebar">
                <h3 style="color:var(--gold)">PARTICIPANTS</h3>
                <input type="text" placeholder="Search..." onkeyup="filterStudents(this.value)">
                <div id="adminStuList" style="margin-top:10px;"></div>
                <button onclick="openModal('dataModal')" class="btn-blue" style="font-size:12px;">üìÇ DATA MANAGER</button>
            </div>

            <div class="main-area">
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                    <h2>üéõÔ∏è CONTROL ROOM</h2>
                    <button onclick="location.reload()" class="btn-red" style="width:auto;">LOGOUT</button>
                </div>

                <div class="panel-box" style="text-align:center; border-color:var(--gold);">
                    <span style="color:#aaa; font-size:12px;">CURRENT STUDENT</span>
                    <h1 id="ctrlActiveName" style="margin:5px 0; color:var(--gold);">No Selection</h1>
                    <h3 id="ctrlActiveReg">---</h3>
                </div>

                <div class="panel-box">
                    <h4>üì° SCREENS & THEMES</h4>
                    <div style="display:flex; gap:10px;">
                        <button onclick="openScreen('STUDENT')" class="btn-gold">OPEN STUDENT SCREEN</button>
                        <button onclick="openScreen('AUDIENCE')" class="btn-blue">OPEN AUDIENCE</button>
                    </div>
                    
                    <div style="margin-top:15px; display:flex; align-items:center; gap:10px; background:#000; padding:10px; border-radius:5px;">
                        <button onclick="cycleTheme(-1)" style="width:40px; margin:0;">‚óÄ</button>
                        <div style="flex:1; text-align:center;">
                            <span id="themeDisplay" style="color:var(--gold); font-weight:bold;">Theme 1: Royal Gold</span>
                        </div>
                        <button onclick="cycleTheme(1)" style="width:40px; margin:0;">‚ñ∂</button>
                    </div>
                </div>

                <div class="panel-box">
                    <h4>üöÄ ACTIONS</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button onclick="setScreenMode('PROFILE')" class="btn-blue">SHOW PROFILE</button>
                        <button onclick="setScreenMode('LOTTERY')" class="btn-gold">START LOTTERY</button>
                    </div>
                    <div style="margin-top:10px;">
                        <label style="display:flex; align-items:center; justify-content:center; gap:10px;">
                            <input type="checkbox" id="chkThilawah" onchange="updateSettings()" style="width:20px; margin:0;">
                            Enable Full Text (Thilawah Mode)
                        </label>
                    </div>
                    <button onclick="resetSystem()" class="btn-red">üîÑ NEXT STUDENT (RESET)</button>
                </div>
            </div>

            <div class="sidebar">
                <h3 style="color:var(--gold)">QUESTIONS</h3>
                <div class="panel-box">
                    <label>Questions to Pick:</label>
                    <input type="number" id="pickLimit" value="3" style="direction:ltr;">
                </div>
                
                <h4>Selected:</h4>
                <div id="adminSelectedQ" style="font-size:12px;"></div>
            </div>
        </div>
    </div>

    <div id="v-judge" class="view">
        <div style="padding:20px; height:100%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
                <h2 style="margin:0; color:var(--gold);">‚öñÔ∏è JUDGE PANEL</h2>
                <button onclick="location.reload()" class="btn-red" style="width:auto;">LOGOUT</button>
            </div>

            <div class="judge-grid" style="flex:1;">
                <div class="panel-box">
                    <h3 style="color:#aaa;">Student Details</h3>
                    <div style="text-align:center; margin-top:30px;">
                        <div id="jProfilePic" style="width:100px; height:100px; background:#333; border-radius:50%; margin:0 auto; border:2px solid var(--gold);"></div>
                        <h1 id="jName" style="color:var(--gold);">Waiting...</h1>
                        <h2 id="jReg">---</h2>
                    </div>
                    
                    <hr style="margin:20px 0; border-color:#333;">
                    
                    <h4>Selected Questions:</h4>
                    <div id="jQuestions" style="height:200px; overflow-y:auto;"></div>
                </div>

                <div class="panel-box">
                    <h3 style="color:#aaa;">Scoring</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div>
                            <label>Hifz (40)</label>
                            <input type="number" class="score-input" id="sHifz" max="40" style="direction:ltr;">
                        </div>
                        <div>
                            <label>Tajweed (30)</label>
                            <input type="number" class="score-input" id="sTaj" max="30" style="direction:ltr;">
                        </div>
                        <div>
                            <label>Voice (20)</label>
                            <input type="number" class="score-input" id="sVoice" max="20" style="direction:ltr;">
                        </div>
                        <div>
                            <label>Makhraj (10)</label>
                            <input type="number" class="score-input" id="sMak" max="10" style="direction:ltr;">
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; text-align:center;">
                        <h1>TOTAL: <span id="sTotal" style="color:var(--gold)">0</span></h1>
                    </div>
                    
                    <button onclick="submitScore()" class="btn-gold">SUBMIT SCORE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold);">üìÇ DATA MANAGER</h2>
            
            <textarea id="csvInput" rows="5" placeholder="Format: ID, Surah, Ayah, Hint, FullText" style="font-family:monospace; text-align:left; font-size:12px;"></textarea>
            <button onclick="importQuestions()" class="btn-blue">üì• Import Questions CSV</button>
            
            <hr style="border-color:#444; margin:20px 0;">
            
            <div style="display:flex; gap:10px;">
                <input type="text" id="mReg" placeholder="Reg No">
                <input type="text" id="mName" placeholder="Name">
            </div>
            <button onclick="addStudent()" class="btn-gold">‚ûï Add Student</button>
            
            <button onclick="closeModal('dataModal')" class="btn-red" style="margin-top:20px;">CLOSE</button>
        </div>
    </div>

    <script>
        // ==========================================
        // üß† SYSTEM CORE (STATE MANAGEMENT)
        // ==========================================
        
        // Default State
        let systemState = {
            viewMode: 'STANDBY', // STANDBY, PROFILE, LOTTERY, QUESTIONS, SCORE
            themeID: 1,
            activeStudent: null,
            selectedQIDs: [],
            thilawahMode: false,
            usedQuestions: JSON.parse(localStorage.getItem('zaad_used') || "[]")
        };

        let students = JSON.parse(localStorage.getItem('zaad_students') || "[]");
        let qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");
        
        // --- AUTH ---
        function login() {
            const role = document.getElementById('roleSelect').value;
            const pass = document.getElementById('passInput').value;
            
            if (role === 'admin' && pass === 'admin123') {
                showView('v-admin');
                renderAdminList();
                broadcastState(); // Sync screens
            } else if (role === 'judge' && pass === 'judge123') {
                showView('v-judge');
                initJudgeListener();
                loadJudgeView(); // Load current state
            } else {
                alert("Incorrect Password!");
            }
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- ADMIN FUNCTIONS ---
        function renderAdminList(filter="") {
            const list = document.getElementById('adminStuList');
            list.innerHTML = students
                .filter(s => s.name.toLowerCase().includes(filter.toLowerCase()))
                .map(s => `
                    <div class="list-item ${systemState.activeStudent?.reg === s.reg ? 'selected' : ''}" 
                         onclick="selectStudent('${s.reg}')">
                        <span>${s.reg}</span>
                        <span>${s.name}</span>
                    </div>
                `).join('');
        }

        function selectStudent(reg) {
            systemState.activeStudent = students.find(s => s.reg === reg);
            systemState.viewMode = 'STANDBY'; // Reset view when changing student
            systemState.selectedQIDs = [];
            
            // UI Updates
            document.getElementById('ctrlActiveName').innerText = systemState.activeStudent.name;
            document.getElementById('ctrlActiveReg').innerText = systemState.activeStudent.reg;
            renderAdminList();
            
            broadcastState(); // Update screens & judge
        }

        function setScreenMode(mode) {
            if(!systemState.activeStudent) return alert("Select a student first!");
            systemState.viewMode = mode;
            broadcastState();
        }

        function updateSettings() {
            systemState.thilawahMode = document.getElementById('chkThilawah').checked;
            broadcastState();
        }

        function resetSystem() {
            if(systemState.selectedQIDs.length > 0) {
                systemState.usedQuestions.push(...systemState.selectedQIDs);
                localStorage.setItem('zaad_used', JSON.stringify(systemState.usedQuestions));
            }
            systemState.activeStudent = null;
            systemState.selectedQIDs = [];
            systemState.viewMode = 'STANDBY';
            
            document.getElementById('ctrlActiveName').innerText = "No Selection";
            document.getElementById('ctrlActiveReg').innerText = "---";
            document.getElementById('adminSelectedQ').innerHTML = "";
            renderAdminList();
            broadcastState();
        }

        // --- THEME ENGINE ---
        function cycleTheme(dir) {
            systemState.themeID += dir;
            if(systemState.themeID > 100) systemState.themeID = 1;
            if(systemState.themeID < 1) systemState.themeID = 100;
            
            document.getElementById('themeDisplay').innerText = `Theme ${systemState.themeID}`;
            broadcastState();
        }

        // --- LOTTERY LOGIC (ADMIN SIDE) ---
        // Listens for clicks from the Student Window via LocalStorage
        window.addEventListener('storage', (e) => {
            if(e.key === 'zaad_action_pick') {
                const qID = e.newValue;
                handlePick(qID);
            }
        });

        function handlePick(qID) {
            const limit = parseInt(document.getElementById('pickLimit').value);
            if(systemState.selectedQIDs.includes(qID)) return;
            if(systemState.selectedQIDs.length >= limit) return;

            systemState.selectedQIDs.push(qID);
            
            // Update Admin UI
            const q = qBank.find(x => x.id == qID);
            const disp = q ? `${q.surah}:${q.ayah}` : `Q${qID}`;
            document.getElementById('adminSelectedQ').innerHTML += `<div style="background:#333; padding:5px; margin:2px;">${qID} - ${disp}</div>`;

            if(systemState.selectedQIDs.length >= limit) {
                setTimeout(() => {
                    systemState.viewMode = 'QUESTIONS';
                    broadcastState();
                }, 1000);
            } else {
                broadcastState(); // Update grid on student screen
            }
        }

        // --- DATA MANAGER ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function addStudent() {
            const reg = document.getElementById('mReg').value;
            const name = document.getElementById('mName').value;
            if(reg && name) {
                students.push({reg, name});
                localStorage.setItem('zaad_students', JSON.stringify(students));
                renderAdminList();
                document.getElementById('mReg').value = "";
                document.getElementById('mName').value = "";
                alert("Added!");
            }
        }

        function importQuestions() {
            const txt = document.getElementById('csvInput').value;
            const lines = txt.split('\n');
            const newQ = [];
            lines.forEach(l => {
                const p = l.split(',');
                if(p.length >= 4) {
                    newQ.push({ id: p[0].trim(), surah: p[1].trim(), ayah: p[2].trim(), hint: p[3].trim(), full: p.slice(4).join(',').trim() });
                }
            });
            qBank = newQ;
            localStorage.setItem('zaad_qbank', JSON.stringify(qBank));
            alert(`Imported ${qBank.length} questions.`);
        }

        // --- BROADCASTING ---
        function broadcastState() {
            localStorage.setItem('zaad_state', JSON.stringify(systemState));
        }

        // ==========================================
        // ‚öñÔ∏è JUDGE LOGIC
        // ==========================================
        function initJudgeListener() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'zaad_state') {
                    systemState = JSON.parse(e.newValue);
                    loadJudgeView();
                }
            });
        }

        function loadJudgeView() {
            if(systemState.activeStudent) {
                document.getElementById('jName').innerText = systemState.activeStudent.name;
                document.getElementById('jReg').innerText = systemState.activeStudent.reg;
            } else {
                document.getElementById('jName').innerText = "Waiting for Admin...";
                document.getElementById('jReg').innerText = "---";
            }

            // Render Questions for Judge
            const qDiv = document.getElementById('jQuestions');
            qDiv.innerHTML = "";
            systemState.selectedQIDs.forEach(qid => {
                const q = qBank.find(x => x.id == qid);
                if(q) {
                    qDiv.innerHTML += `
                        <div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:5px; border-right:3px solid var(--gold);">
                            <span style="color:var(--gold); font-weight:bold;">${q.surah} (${q.ayah})</span><br>
                            <span style="color:#fff; font-family:'Madina'; font-size:18px;">${q.full}</span>
                        </div>
                    `;
                }
            });
        }

        // Auto Calc Total
        document.querySelectorAll('.score-input').forEach(i => {
            i.addEventListener('input', () => {
                const tot = 
                    (parseInt(document.getElementById('sHifz').value)||0) +
                    (parseInt(document.getElementById('sTaj').value)||0) +
                    (parseInt(document.getElementById('sVoice').value)||0) +
                    (parseInt(document.getElementById('sMak').value)||0);
                document.getElementById('sTotal').innerText = tot;
            });
        });

        function submitScore() {
            // Here you would save to localstorage or export
            alert("Score Saved Locally!");
            document.querySelectorAll('.score-input').forEach(i => i.value = "");
            document.getElementById('sTotal').innerText = "0";
        }

        // ==========================================
        // üñ•Ô∏è EXTERNAL SCREEN GENERATOR
        // ==========================================
        function openScreen(type) {
            const win = window.open("", type, "width=1200,height=800");
            if (!win) return alert("Popups Blocked!");
            
            const html = `
            <!DOCTYPE html>
            <html lang="dv" dir="rtl">
            <head>
                <style>
                    @font-face { font-family: 'Faruma'; src: url('fonts/af_faruma.ttf'); }
                    @font-face { font-family: 'Madina'; src: url('fonts/MADDINA.ttf'); }
                    body { margin:0; overflow:hidden; font-family:'Faruma'; transition: background 0.5s; display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; }
                    
                    /* Dynamic Theme Variables */
                    :root { --b-color: #FFD700; --bg: #000; }
                    
                    .frame {
                        border: 10px solid var(--b-color);
                        box-shadow: 0 0 50px var(--b-color);
                        background: rgba(0,0,0,0.8);
                        width: 90%; height: 90%;
                        border-radius: 20px;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        padding: 20px; text-align: center;
                    }
                    
                    /* Lottery Grid */
                    .grid { display:flex; flex-wrap:wrap; justify-content:center; gap:15px; max-width:1000px; }
                    .box { width:100px; height:100px; border:2px solid var(--b-color); display:flex; justify-content:center; align-items:center; font-size:40px; cursor:pointer; background:rgba(255,255,255,0.1); }
                    .box.picked { background:var(--b-color); color:#000; pointer-events:none; }
                    .box.disabled { opacity:0.2; pointer-events:none; }

                    /* Questions */
                    .q-card { 
                        display:none; 
                        font-family:'Madina'; font-size:40px; line-height:1.8; 
                        margin:20px; padding:20px; border-bottom:1px dashed #555; width:100%;
                    }
                    .q-card.active { display:block; animation: fadeIn 1s; }
                    
                    .blur-text { filter: blur(10px); cursor:pointer; transition:0.3s; }
                    .revealed { filter: blur(0); }

                    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
                </style>
            </head>
            <body>
                <div id="app" class="frame">
                    <h1>INITIALIZING...</h1>
                </div>

                <script>
                    let state = {};
                    let qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");

                    // 1. Listen for updates
                    window.addEventListener('storage', (e) => {
                        if(e.key === 'zaad_state') {
                            state = JSON.parse(e.newValue);
                            render();
                        }
                    });
                    
                    // Initial Load
                    const raw = localStorage.getItem('zaad_state');
                    if(raw) { state = JSON.parse(raw); render(); }

                    function render() {
                        applyTheme(state.themeID);
                        const app = document.getElementById('app');
                        
                        // VIEW: STANDBY
                        if(state.viewMode === 'STANDBY') {
                            app.innerHTML = '<h1>WAITING FOR STUDENT...</h1>';
                        }
                        
                        // VIEW: PROFILE
                        else if(state.viewMode === 'PROFILE') {
                            if(state.activeStudent) {
                                app.innerHTML = '<h1>'+state.activeStudent.name+'</h1><h2>'+state.activeStudent.reg+'</h2>';
                            }
                        }

                        // VIEW: LOTTERY
                        else if(state.viewMode === 'LOTTERY') {
                            let html = '<div class="grid">';
                            qBank.forEach(q => {
                                const isUsed = state.usedQuestions.includes(q.id);
                                const isPicked = state.selectedQIDs.includes(q.id);
                                let cls = 'box';
                                if(isUsed) cls += ' disabled';
                                if(isPicked) cls += ' picked';
                                
                                html += '<div class="'+cls+'" onclick="pick('+q.id+')">'+(isPicked ? '‚úî' : q.id)+'</div>';
                            });
                            html += '</div>';
                            app.innerHTML = html;
                        }

                        // VIEW: QUESTIONS
                        else if(state.viewMode === 'QUESTIONS') {
                            let html = '<div style="width:100%; height:100%; overflow-y:auto;">';
                            state.selectedQIDs.forEach(id => {
                                const q = qBank.find(x => x.id == id);
                                if(q) {
                                    // Hint Logic
                                    html += '<div class="q-card active">';
                                    html += '<div style="font-size:20px; color:#aaa; font-family:sans-serif;">'+q.surah+'</div>';
                                    
                                    // If Thilawah Mode -> Click to reveal full text. 
                                    // If Hifz Mode -> Only Hint shown.
                                    if(state.thilawahMode) {
                                        html += '<div class="blur-text" onclick="this.classList.add(\\'revealed\\')">'+q.full+'</div>';
                                    } else {
                                        html += '<div>'+q.hint+' ...</div>';
                                    }
                                    
                                    html += '<button onclick="this.parentElement.style.display=\\'none\\'" style="margin-top:20px; padding:10px;">DONE</button>';
                                    html += '</div>';
                                }
                            });
                            html += '</div>';
                            app.innerHTML = html;
                        }
                    }

                    // Theme Logic
                    function applyTheme(id) {
                        // Generate colors based on ID (Math magic)
                        const hue = (id * 137.5) % 360; 
                        const color = 'hsl(' + hue + ', 80%, 50%)';
                        const bg = 'radial-gradient(circle, hsl(' + hue + ', 80%, 10%), #000)';
                        
                        document.documentElement.style.setProperty('--b-color', color);
                        document.body.style.background = bg;
                    }

                    // Send Action back to Admin
                    window.pick = function(id) {
                        localStorage.setItem('zaad_action_pick', id);
                        // Reset key to allow same pick again if needed (rare)
                        setTimeout(() => localStorage.removeItem('zaad_action_pick'), 100);
                    }
                <\/script>
            </body>
            </html>`;
            
            win.document.write(html);
            win.document.close();
        }

    </script>
</body>
</html>
