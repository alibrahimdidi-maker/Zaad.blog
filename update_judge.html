<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaad Royal V24 (Ultimate Fixed)</title>
    <style>
        /* --- 1. FONTS SETUP --- */
        /* ﬁåﬁ®ﬁÑﬁ≠ﬁäﬁ™ﬁÖﬁßﬁéﬁ¨ ﬁÜﬁÆﬁâﬁ∞ﬁïﬁ®ﬁáﬁ™ﬁìﬁ¶ﬁÉﬁ™ﬁéﬁ¶ﬁáﬁ® 'fonts' ﬁäﬁØﬁçﬁ∞ﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÄﬁ¶ﬁáﬁ∞ﬁãﬁ¶ﬁàﬁ¶ﬁáﬁ® ﬁáﬁ≠ﬁéﬁ¨ ﬁåﬁ¨ﬁÉﬁ¨ﬁáﬁ¶ﬁÅﬁ∞ 'MADDINA.ttf' ﬁáﬁ¶ﬁãﬁ® 'af_faruma.ttf' ﬁáﬁ¶ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁß */
        @font-face { font-family: 'Faruma'; src: url('fonts/af_faruma.ttf'); }
        @font-face { font-family: 'Madina'; src: url('fonts/MADDINA.ttf'); }
        
        :root {
            --gold: #FFD700;
            --gold-dim: #B8860B;
            --blue: #001a33;
            --glass: rgba(0, 15, 30, 0.95);
            --neon: #00e676;
        }

        body {
            background: radial-gradient(circle at center, #002244 0%, #000 100%);
            color: #fff; margin: 0; font-family: 'Faruma', sans-serif;
            height: 100vh; overflow: hidden; user-select: none;
        }

        /* --- 2. LAYOUT ENGINE --- */
        .view { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; z-index:10; }
        .active { display: flex; z-index:20; }
        
        .center-box { justify-content: center; align-items: center; background: #000; }
        
        /* Glassmorphism Cards */
        .card { 
            background: var(--glass); border: 2px solid var(--gold); padding: 40px; 
            border-radius: 20px; text-align: center; width: 450px;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.15);
        }

        /* Inputs & Buttons */
        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 15px;
            background: rgba(0,0,0,0.6); border: 1px solid #444; border-bottom: 2px solid var(--gold);
            color: #fff; text-align: center; border-radius: 8px;
            font-family: inherit; font-size: 16px; outline: none;
        }

        button {
            width: 100%; padding: 14px; margin-top: 20px; cursor: pointer;
            border: none; border-radius: 8px; font-weight: bold; font-size: 16px;
            font-family: inherit; transition: 0.2s; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.98); }

        .btn-gold { background: linear-gradient(135deg, var(--gold-dim), var(--gold)); color: #000; }
        .btn-blue { background: linear-gradient(135deg, #003366, #0059b3); color: #fff; border: 1px solid var(--gold); }
        .btn-red { background: linear-gradient(135deg, #800000, #b30000); color: #fff; }
        .btn-green { background: linear-gradient(135deg, #004d00, #009900); color: #fff; }

        /* --- 3. DASHBOARD GRID --- */
        .dashboard { display: grid; grid-template-columns: 280px 1fr 320px; width: 100%; height: 100%; gap: 20px; padding: 20px; }
        
        .panel-box {
            background: rgba(255, 255, 255, 0.05); border: 1px solid #333;
            padding: 15px; border-radius: 12px; width: 100%; margin-bottom: 15px;
            display: flex; flex-direction: column;
        }

        /* List Items */
        .list-container { flex: 1; overflow-y: auto; padding-right: 5px; }
        .list-item { 
            padding: 12px; border-bottom: 1px solid #333; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; border-radius: 5px;
        }
        .list-item:hover { background: rgba(255, 215, 0, 0.1); }
        .list-item.selected { background: var(--gold); color: #000; font-weight: bold; box-shadow: 0 0 15px var(--gold); }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #001a33; border: 2px solid var(--gold); padding: 30px; width: 700px; border-radius: 15px; position:relative; }

        /* Judge Specific */
        .judge-layout { display: flex; width: 100%; height: 100%; }
        .judge-sidebar { width: 300px; background: rgba(0,0,0,0.5); border-left: 2px solid var(--gold); padding: 20px; }
        .judge-main { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        
        .q-display-box {
            background: #fff; color: #000; padding: 15px; margin-bottom: 10px; 
            border-radius: 8px; border-right: 5px solid var(--gold); width: 100%;
            font-family: 'Madina', serif; font-size: 20px; direction: rtl; text-align: right;
        }
        
    </style>
</head>
<body>

    <div id="v-login" class="view active center-box">
        <div class="card">
            <img src="https://academyzaad.com/photos/logo.png" width="100" style="margin-bottom:10px;">
            <h1 style="color:var(--gold); margin:0; font-size:32px;">ZAAD ROYAL V24</h1>
            <p style="color:#aaa;">Ultimate Quran System</p>
            
            <select id="roleSelect">
                <option value="admin">Admin (Controller)</option>
                <option value="judge">Judge (Scoring)</option>
            </select>
            
            <input type="password" id="passInput" placeholder="Password" style="direction:ltr;">
            <button onclick="login()" class="btn-gold">LOGIN SYSTEM</button>
        </div>
    </div>

    <div id="v-admin" class="view">
        <div class="dashboard">
            <div class="panel-box" style="border-color: var(--gold);">
                <h3 style="color:var(--gold); margin-top:0;">üë• PARTICIPANTS</h3>
                <input type="text" placeholder="Search..." onkeyup="filterStudents(this.value)" style="margin-top:0; margin-bottom:10px;">
                <div id="adminStuList" class="list-container"></div>
                <button onclick="openModal('dataModal')" class="btn-green" style="font-size:12px; margin-top:10px;">üìÇ IMPORT DATA / ADD STUDENTS</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:15px; overflow-y:auto;">
                <div class="panel-box" style="text-align:center; flex:0;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-weight:bold;">üéõÔ∏è CONTROL ROOM</span>
                        <button onclick="location.reload()" class="btn-red" style="width:auto; margin:0; padding:5px 15px; font-size:10px;">LOGOUT</button>
                    </div>
                </div>

                <div class="panel-box" style="text-align:center; border: 2px solid var(--gold); background: rgba(255,215,0,0.05);">
                    <span style="color:#aaa; font-size:12px; letter-spacing: 2px;">ACTIVE STUDENT</span>
                    <h1 id="ctrlActiveName" style="margin:5px 0; color:var(--gold); font-size:35px;">No Selection</h1>
                    <h3 id="ctrlActiveReg" style="margin:0; color:#fff;">---</h3>
                </div>

                <div class="panel-box">
                    <h4>üì° SCREEN & THEMES</h4>
                    <div style="display:flex; gap:10px;">
                        <button onclick="openScreen('STUDENT')" class="btn-gold">üñ•Ô∏è STUDENT SCREEN</button>
                        <button onclick="openScreen('AUDIENCE')" class="btn-blue">üì∫ AUDIENCE SCREEN</button>
                    </div>
                    
                    <div style="margin-top:15px; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; border:1px solid #444;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="cycleTheme(-1)" style="width:50px; margin:0;">‚óÄ</button>
                            <div style="flex:1; text-align:center;">
                                <span style="font-size:10px; color:#aaa;">CURRENT THEME</span><br>
                                <span id="themeDisplay" style="color:var(--gold); font-weight:bold; font-size:18px;">Royal Gold (1)</span>
                            </div>
                            <button onclick="cycleTheme(1)" style="width:50px; margin:0;">‚ñ∂</button>
                        </div>
                    </div>
                </div>

                <div class="panel-box">
                    <h4>üöÄ LIVE ACTIONS</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button onclick="setScreenMode('PROFILE')" class="btn-blue">üë§ PROFILE</button>
                        <button onclick="setScreenMode('LOTTERY')" class="btn-gold">üé≤ LOTTERY</button>
                    </div>
                    
                    <div style="margin-top:15px; padding:10px; border:1px dashed #666; border-radius:5px;">
                        <label style="display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="chkThilawah" onchange="updateSettings()" style="width:20px; margin:0;">
                            <span style="font-size:14px; font-weight:bold; color:var(--neon);">Enable Thilawah Mode (Reveal Text)</span>
                        </label>
                    </div>

                    <button onclick="resetSystem()" class="btn-red">üîÑ NEXT STUDENT (RESET)</button>
                </div>
            </div>

            <div class="panel-box">
                <h3 style="color:var(--gold); margin-top:0;">‚ùì QUESTIONS</h3>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <label>Pick Limit:</label>
                    <input type="number" id="pickLimit" value="3" style="width:60px; margin:0; direction:ltr;">
                </div>
                
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px; height:200px; overflow-y:auto;">
                    <h4 style="margin:0 0 5px 0; color:#aaa;">Selected IDs:</h4>
                    <div id="adminSelectedQ" style="display:flex; flex-direction:column; gap:5px;"></div>
                </div>
                <button onclick="fullReset()" class="btn-red" style="font-size:12px; margin-top:auto;">‚ö†Ô∏è CLEAR HISTORY</button>
            </div>
        </div>
    </div>

    <div id="v-judge" class="view">
        <div class="judge-layout">
            <div class="judge-main">
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 style="margin:0; color:var(--gold);">‚öñÔ∏è JUDGE PANEL</h1>
                    <button onclick="location.reload()" class="btn-red" style="width:auto; margin:0;">LOGOUT</button>
                </div>

                <div style="text-align:center; margin-bottom:30px;">
                    <h2 id="jName" style="font-size:40px; margin:0; color:#fff;">Waiting for Student...</h2>
                    <h3 id="jReg" style="color:var(--gold);">---</h3>
                </div>

                <div style="width:100%; max-width:800px; flex:1; display:flex; flex-direction:column;">
                    <h3 style="color:#aaa; border-bottom:1px solid #444;">Active Questions (Full Text)</h3>
                    <div id="jQuestions" style="flex:1; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.2); border-radius:10px;"></div>
                </div>

                <div style="width:100%; max-width:800px; background:rgba(255,215,0,0.1); padding:20px; border-radius:15px; border:1px solid var(--gold); margin-top:20px;">
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                        <input type="number" placeholder="Hifz (40)" class="j-score">
                        <input type="number" placeholder="Tajweed (30)" class="j-score">
                        <input type="number" placeholder="Voice (20)" class="j-score">
                        <input type="number" placeholder="Makhraj (10)" class="j-score">
                    </div>
                    <button onclick="alert('Score Saved!')" class="btn-gold">SUBMIT SCORE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold);">üìÇ DATA MANAGER</h2>
            
            <div style="text-align:left; background:rgba(0,0,0,0.5); padding:15px; border-radius:10px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px 0;">1. Import Questions (Excel Copy/Paste)</h4>
                <p style="font-size:12px; color:#aaa; margin-bottom:5px;">Format: ID, Surah Name, Ayah No, Hint Text, Full Text</p>
                <textarea id="csvInput" rows="5" placeholder="1, Al-Mulk, 1, Tabarakallazee..., Tabarakallazee biyadihil mulk..." style="font-family:monospace; font-size:12px; text-align:left;"></textarea>
                <button onclick="importQuestions()" class="btn-blue">üì• Import Questions</button>
            </div>

            <div style="text-align:left; background:rgba(0,0,0,0.5); padding:15px; border-radius:10px;">
                <h4 style="margin:0 0 10px 0;">2. Add Student</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="mReg" placeholder="Reg No" style="margin:0;">
                    <input type="text" id="mName" placeholder="Name" style="margin:0;">
                </div>
                <button onclick="addStudent()" class="btn-green">‚ûï Add Student</button>
            </div>
            
            <button onclick="document.getElementById('dataModal').style.display='none'" class="btn-red" style="margin-top:20px;">CLOSE</button>
        </div>
    </div>

    <script>
        // ==========================================
        // üß† SYSTEM CORE (STATE MANAGEMENT)
        // ==========================================
        
        let systemState = {
            viewMode: 'STANDBY', // STANDBY, PROFILE, LOTTERY, QUESTIONS
            themeID: 1,
            activeStudent: null,
            selectedQIDs: [],
            thilawahMode: false,
            usedQuestions: JSON.parse(localStorage.getItem('zaad_used') || "[]")
        };

        // Load Data
        let students = JSON.parse(localStorage.getItem('zaad_students') || "[]");
        let qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");
        
        // --- 1. AUTHENTICATION ---
        function login() {
            const role = document.getElementById('roleSelect').value;
            const pass = document.getElementById('passInput').value;
            
            if (role === 'admin' && pass === 'admin123') {
                showView('v-admin');
                renderAdminList();
                broadcastState();
            } else if (role === 'judge' && pass === 'judge123') {
                showView('v-judge');
                initJudgeListener();
                loadJudgeView();
            } else {
                alert("Incorrect Password!");
            }
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 2. ADMIN LOGIC ---
        function renderAdminList(filter="") {
            const list = document.getElementById('adminStuList');
            if(students.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#666;'>No Students Found. Please Import.</p>";
                return;
            }
            list.innerHTML = students
                .filter(s => s.name.toLowerCase().includes(filter.toLowerCase()))
                .map(s => `
                    <div class="list-item ${systemState.activeStudent?.reg === s.reg ? 'selected' : ''}" 
                         onclick="selectStudent('${s.reg}')">
                        <span style="font-weight:bold; font-family:monospace;">${s.reg}</span>
                        <span>${s.name}</span>
                    </div>
                `).join('');
        }

        function selectStudent(reg) {
            systemState.activeStudent = students.find(s => s.reg === reg);
            systemState.viewMode = 'STANDBY';
            systemState.selectedQIDs = [];
            
            // UI Updates
            document.getElementById('ctrlActiveName').innerText = systemState.activeStudent.name;
            document.getElementById('ctrlActiveReg').innerText = systemState.activeStudent.reg;
            renderAdminList();
            
            broadcastState();
        }

        function setScreenMode(mode) {
            if(!systemState.activeStudent) return alert("‚ö†Ô∏è Please select a student first!");
            systemState.viewMode = mode;
            broadcastState();
        }

        function updateSettings() {
            systemState.thilawahMode = document.getElementById('chkThilawah').checked;
            broadcastState();
        }

        function resetSystem() {
            // Save used questions
            if(systemState.selectedQIDs.length > 0) {
                systemState.usedQuestions.push(...systemState.selectedQIDs);
                localStorage.setItem('zaad_used', JSON.stringify(systemState.usedQuestions));
            }
            // Reset State
            systemState.activeStudent = null;
            systemState.selectedQIDs = [];
            systemState.viewMode = 'STANDBY';
            
            document.getElementById('ctrlActiveName').innerText = "No Selection";
            document.getElementById('ctrlActiveReg').innerText = "---";
            document.getElementById('adminSelectedQ').innerHTML = "";
            renderAdminList();
            broadcastState();
        }

        function fullReset() {
            if(confirm("Are you sure? This clears all used question history.")) {
                systemState.usedQuestions = [];
                localStorage.removeItem('zaad_used');
                alert("History Cleared.");
            }
        }

        // --- 3. THEME ENGINE (100 THEMES) ---
        function cycleTheme(dir) {
            systemState.themeID += dir;
            if(systemState.themeID > 100) systemState.themeID = 1;
            if(systemState.themeID < 1) systemState.themeID = 100;
            
            // Generate Name
            const names = ["Royal Gold", "Midnight Blue", "Emerald", "Ruby", "Amethyst"];
            const baseName = names[systemState.themeID % names.length];
            document.getElementById('themeDisplay').innerText = `${baseName} (#${systemState.themeID})`;
            
            broadcastState();
        }

        // --- 4. QUESTION HANDLING (CSV) ---
        function importQuestions() {
            const txt = document.getElementById('csvInput').value;
            if(!txt.trim()) return alert("Please paste CSV data.");
            
            const lines = txt.split('\n');
            const newQ = [];
            
            lines.forEach(l => {
                const p = l.split(',');
                if(p.length >= 4) {
                    newQ.push({ 
                        id: p[0].trim(), 
                        surah: p[1].trim(), 
                        ayah: p[2].trim(), 
                        hint: p[3].trim(), 
                        full: p.slice(4).join(',').trim() 
                    });
                }
            });
            
            qBank = newQ;
            localStorage.setItem('zaad_qbank', JSON.stringify(qBank));
            alert(`‚úÖ Successfully imported ${qBank.length} questions!`);
        }

        function addStudent() {
            const reg = document.getElementById('mReg').value;
            const name = document.getElementById('mName').value;
            if(reg && name) {
                students.push({reg, name});
                localStorage.setItem('zaad_students', JSON.stringify(students));
                renderAdminList();
                document.getElementById('mReg').value="";
                document.getElementById('mName').value="";
                alert("Student Added");
            }
        }

        // --- 5. LOTTERY LOGIC (LISTENER) ---
        // Listens for clicks from the Student Window via LocalStorage
        window.addEventListener('storage', (e) => {
            if(e.key === 'zaad_action_pick') {
                const qID = e.newValue;
                handlePick(qID);
            }
        });

        function handlePick(qID) {
            const limit = parseInt(document.getElementById('pickLimit').value);
            if(systemState.selectedQIDs.includes(qID)) return;
            if(systemState.selectedQIDs.length >= limit) return;

            systemState.selectedQIDs.push(qID);
            
            // Update Admin UI
            const q = qBank.find(x => x.id == qID);
            const disp = q ? `${q.surah}:${q.ayah}` : `ID: ${qID}`;
            
            const item = document.createElement('div');
            item.innerHTML = `<span style="background:var(--gold); color:#000; padding:2px 5px; border-radius:3px; font-weight:bold;">${qID}</span> <span style="color:#fff; font-size:12px;">${disp}</span>`;
            document.getElementById('adminSelectedQ').appendChild(item);

            // If limit reached, switch view automatically? (Optional, let's keep it manual or delayed)
            if(systemState.selectedQIDs.length >= limit) {
                setTimeout(() => {
                    systemState.viewMode = 'QUESTIONS';
                    broadcastState();
                }, 1000);
            } else {
                broadcastState(); // Update grid on student screen to show 'Picked'
            }
        }

        // --- 6. STATE BROADCASTER ---
        function broadcastState() {
            localStorage.setItem('zaad_state', JSON.stringify(systemState));
        }

        // --- 7. JUDGE LOGIC ---
        function initJudgeListener() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'zaad_state') {
                    systemState = JSON.parse(e.newValue);
                    loadJudgeView();
                }
            });
            // Initial Load
            const raw = localStorage.getItem('zaad_state');
            if(raw) { systemState = JSON.parse(raw); loadJudgeView(); }
        }

        function loadJudgeView() {
            if(systemState.activeStudent) {
                document.getElementById('jName').innerText = systemState.activeStudent.name;
                document.getElementById('jReg').innerText = systemState.activeStudent.reg;
            } else {
                document.getElementById('jName').innerText = "Waiting for Admin...";
                document.getElementById('jReg').innerText = "---";
            }

            // Render Full Text for Judge
            const qDiv = document.getElementById('jQuestions');
            qDiv.innerHTML = "";
            
            if(systemState.selectedQIDs.length === 0) {
                qDiv.innerHTML = "<p style='text-align:center; color:#aaa;'>No questions selected yet.</p>";
            }

            systemState.selectedQIDs.forEach(qid => {
                const q = qBank.find(x => x.id == qid);
                if(q) {
                    qDiv.innerHTML += `
                        <div class="q-display-box">
                            <div style="font-size:14px; color:#666; margin-bottom:5px; border-bottom:1px solid #eee;">
                                Question #${q.id} | ${q.surah} : ${q.ayah}
                            </div>
                            <span style="line-height:1.8;">${q.full}</span>
                        </div>
                    `;
                }
            });
        }

        // ==========================================
        // üñ•Ô∏è EXTERNAL SCREEN GENERATOR
        // ==========================================
        function openScreen(type) {
            const w = 1200; const h = 800;
            const win = window.open("", type, `width=${w},height=${h}`);
            if (!win) return alert("Popups Blocked! Allow popups for this site.");
            
            const html = `
            <!DOCTYPE html>
            <html lang="dv" dir="rtl">
            <head>
                <style>
                    @font-face { font-family: 'Faruma'; src: 'fonts/af_faruma.ttf'; }
                    @font-face { font-family: 'Madina'; src: 'fonts/MADDINA.ttf'; }
                    
                    /* Dynamic Variables updated via JS */
                    :root { 
                        --theme-color: #FFD700; 
                        --theme-bg: #000;
                        --theme-border: 10px solid #FFD700;
                    }

                    body { 
                        margin:0; overflow:hidden; font-family:'Faruma'; 
                        background: var(--theme-bg); background-size: cover;
                        transition: background 0.5s; 
                        display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; 
                        user-select: none;
                    }
                    
                    .royal-frame {
                        border: var(--theme-border);
                        box-shadow: 0 0 60px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.5);
                        background: rgba(0,0,0,0.8);
                        width: 90%; height: 90%;
                        border-radius: 20px;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        padding: 30px; text-align: center;
                        position: relative;
                        backdrop-filter: blur(10px);
                    }
                    
                    /* Lottery Grid */
                    .grid { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; max-width:1100px; padding:20px; }
                    .box { 
                        width:120px; height:120px; 
                        border: 2px solid var(--theme-color); 
                        color: var(--theme-color);
                        display:flex; justify-content:center; align-items:center; 
                        font-size:45px; cursor:pointer; 
                        background:rgba(255,255,255,0.05); border-radius:15px;
                        transition: 0.3s;
                    }
                    .box:hover { transform: scale(1.1); background: var(--theme-color); color: #000; }
                    .box.picked { background:var(--theme-color); color:#000; transform: scale(0); opacity:0; pointer-events:none; }
                    .box.disabled { opacity:0.1; pointer-events:none; filter: grayscale(1); }

                    /* Questions Cards */
                    .card-container {
                        display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; width: 100%;
                    }
                    .q-card { 
                        background: #fff; color: #000;
                        width: 400px; min-height: 500px;
                        border-radius: 15px;
                        padding: 30px;
                        border: 5px solid var(--theme-color);
                        display: flex; flex-direction: column; justify-content: space-between;
                        animation: slideUp 0.8s;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    }
                    
                    .q-text {
                        font-family: 'Madina', serif;
                        font-size: 38px; line-height: 1.8;
                        text-align: center; flex: 1;
                        display: flex; align-items: center; justify-content: center;
                    }

                    .blur-text { filter: blur(12px); cursor:pointer; user-select:none; }
                    .revealed { filter: blur(0); }

                    .btn-done {
                        background: #800000; color: #fff; border:none; padding:15px; font-size:18px;
                        width:100%; cursor:pointer; margin-top:10px; border-radius:5px;
                    }

                    @keyframes slideUp { from{transform:translateY(50px); opacity:0;} to{transform:translateY(0); opacity:1;} }
                </style>
            </head>
            <body>
                <div id="app" class="royal-frame">
                    <h1>INITIALIZING SYSTEM...</h1>
                </div>

                <script>
                    let state = {};
                    let qBank = JSON.parse(localStorage.getItem('zaad_qbank') || "[]");

                    // Listen for updates
                    window.addEventListener('storage', (e) => {
                        if(e.key === 'zaad_state') {
                            state = JSON.parse(e.newValue);
                            render();
                        }
                    });
                    
                    // Initial Render
                    const raw = localStorage.getItem('zaad_state');
                    if(raw) { state = JSON.parse(raw); render(); }

                    function render() {
                        applyTheme(state.themeID);
                        const app = document.getElementById('app');
                        
                        // 1. STANDBY
                        if(state.viewMode === 'STANDBY') {
                            app.innerHTML = '<img src="https://academyzaad.com/photos/logo.png" width="200"><h1 style="font-size:60px; margin:20px 0;">WAITING FOR NEXT STUDENT</h1><p style="color:var(--theme-color);">Academy Zaad Competition</p>';
                        }
                        
                        // 2. PROFILE
                        else if(state.viewMode === 'PROFILE') {
                            if(state.activeStudent) {
                                app.innerHTML = '<div style="text-align:center;"><h1 style="font-size:80px; margin:0;">'+state.activeStudent.name+'</h1><h2 style="font-size:40px; color:var(--theme-color);">'+state.activeStudent.reg+'</h2></div>';
                            }
                        }

                        // 3. LOTTERY (GRID)
                        else if(state.viewMode === 'LOTTERY') {
                            let html = '<h1 style="margin-bottom:20px;">CHOOSE YOUR QUESTIONS</h1><div class="grid">';
                            
                            // If no QBank loaded, show numbers 1-20 by default
                            const list = qBank.length > 0 ? qBank : Array.from({length:20}, (_, i) => ({id: i+1}));
                            
                            list.forEach(q => {
                                const isUsed = state.usedQuestions.includes(q.id);
                                const isPicked = state.selectedQIDs.includes(q.id);
                                let cls = 'box';
                                if(isUsed) cls += ' disabled';
                                if(isPicked) cls += ' picked';
                                
                                html += '<div class="'+cls+'" onclick="pick(\\''+q.id+'\\')">'+q.id+'</div>';
                            });
                            html += '</div>';
                            app.innerHTML = html;
                        }

                        // 4. QUESTIONS (CARDS)
                        else if(state.viewMode === 'QUESTIONS') {
                            let html = '<div class="card-container">';
                            state.selectedQIDs.forEach(id => {
                                const q = qBank.find(x => x.id == id);
                                if(q) {
                                    html += '<div class="q-card">';
                                    html += '<div style="font-size:20px; color:#888; border-bottom:1px solid #eee; padding-bottom:10px;">Surah '+q.surah+' : '+q.ayah+'</div>';
                                    
                                    // LOGIC: If Thilawah Mode is ON, text is blurred but revealable.
                                    // If OFF (Hifz), only Hint is shown.
                                    
                                    if(state.thilawahMode) {
                                        // Thilawah: Show full text but blurred
                                        html += '<div class="q-text blur-text" onclick="this.classList.toggle(\\'revealed\\')">'+q.full+'</div>';
                                        html += '<p style="font-size:12px; color:red; text-align:center;">(Thilawah Mode: Click text to reveal)</p>';
                                    } else {
                                        // Hifz: Show Hint only. No reveal.
                                        html += '<div class="q-text">'+q.hint+' ...</div>';
                                    }
                                    
                                    html += '<button class="btn-done" onclick="this.parentElement.style.opacity=\\'0\\'">DONE</button>';
                                    html += '</div>';
                                }
                            });
                            html += '</div>';
                            app.innerHTML = html;
                        }
                    }

                    // --- 100 THEMES GENERATOR ---
                    function applyTheme(id) {
                        // Procedural Color Generation
                        const hue = (id * 137.508) % 360; // Golden Angle for distribution
                        const color = 'hsl(' + hue + ', 85%, 60%)';
                        const bgCol1 = 'hsl(' + hue + ', 60%, 10%)';
                        const bgCol2 = '#000000';
                        
                        // Border Styles Rotation
                        const borders = ['solid', 'double', 'groove', 'ridge', 'dashed'];
                        const borderStyle = borders[id % borders.length];
                        
                        const root = document.documentElement;
                        root.style.setProperty('--theme-color', color);
                        root.style.setProperty('--theme-border', '10px ' + borderStyle + ' ' + color);
                        document.body.style.background = 'radial-gradient(circle at center, ' + bgCol1 + ', ' + bgCol2 + ')';
                    }

                    // Send Pick to Admin
                    window.pick = function(id) {
                        localStorage.setItem('zaad_action_pick', id);
                        setTimeout(() => localStorage.removeItem('zaad_action_pick'), 100);
                    }
                <\/script>
            </body>
            </html>`;
            
            win.document.write(html);
            win.document.close();
        }
    </script>
</body>
</html>
