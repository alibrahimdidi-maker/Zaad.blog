<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Rasfahi Royal Quran (V19.2 Ultimate Edition)</title>
    <style>
        /* --- FONTS & IMPORTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700;900&family=Cinzel:wght@700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap'); /* Arabic Font */

        /* Placeholder for Dynamic Font */
        @font-face {
            font-family: 'AppFont';
            src: local('Faruuma'), local('Waheed'), url('https://fonts.googleapis.com/earlyaccess/notosansthaana.css');
        }

        :root {
            --royal-blue: #001a33;
            --royal-blue-dark: #000d1a;
            --royal-green: #00331a; 
            --gold: #D4AF37;
            --gold-dim: #aa8c2c;
            --green: #006400;
            --green-bright: #00e676;
            --text-main: #ffffff;
            --panel-bg: #0b1016;
            --border-radius: 6px;
            --cream-bg: #fdfcf0;
        }

        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; outline: none; }
        
        /* APPLY FONT GLOBALLY */
        body, button, input, select, textarea, h1, h2, span, div, p, a, label { 
            font-family: 'AppFont', 'Noto Sans Thaana', 'Amiri', sans-serif !important; 
        }

        body { 
            margin: 0; 
            background: #000; 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 480px; 
            background: linear-gradient(180deg, var(--panel-bg) 0%, #000 100%); 
            border-left: 3px solid var(--gold);
            display: flex; flex-direction: column; height: 100vh; z-index: 100;
            box-shadow: 10px 0 40px rgba(0,0,0,0.8);
        }
        
        .header { 
            padding: 15px; text-align: center; 
            background: linear-gradient(to bottom, var(--royal-blue), var(--royal-blue-dark)); 
            border-bottom: 2px solid var(--gold); 
        }
        .app-title { 
            font-family: 'Cinzel', serif !important; color: var(--gold);
            font-size: 20px; margin: 0; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
        }

        .content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        .panel { 
            background: rgba(255,255,255,0.03); 
            border: 1px solid #334455; 
            border-radius: var(--border-radius); 
            padding: 12px; 
        }
        .panel-live {
            background: linear-gradient(135deg, rgba(0,26,51,0.6), rgba(0,0,0,0.8));
            border: 1px solid var(--gold-dim);
        }

        h2 { 
            color: var(--gold); margin: 0 0 8px 0; font-size: 16px; 
            border-bottom: 1px dashed #445566; padding-bottom: 4px; 
        }
        
        label { color: #aab; font-size: 13px; display: block; margin-top: 8px; }
        
        input, select, button { 
            width: 100%; padding: 8px; margin-top: 4px; 
            background: #1a222c; border: 1px solid #334455; 
            color: #fff; border-radius: 4px; 
            font-size: 14px; 
        }
        
        button { 
            cursor: pointer; font-weight: bold; border-color: #445566; 
            transition: all 0.2s; 
            background: linear-gradient(to bottom, #2a3b4c, #1a222c);
        }
        button:hover { filter: brightness(1.2); border-color: var(--gold); }
        
        .btn-green { background: linear-gradient(to bottom, #004d00, #003300) !important; border-color: #006400 !important; }
        .btn-red { background: linear-gradient(to bottom, #8b0000, #500000) !important; border-color: #b71c1c !important; }
        .btn-gold { background: linear-gradient(to bottom, var(--gold), var(--gold-dim)) !important; color: #000 !important; border-color: #fff !important; }
        .btn-blue { background: linear-gradient(to bottom, #004080, #002040) !important; border-color: #0059b3 !important; }
        .btn-purple { background: linear-gradient(to bottom, #4a148c, #311b92) !important; border-color: #7c4dff !important; }

        /* LANG SWITCHER */
        .lang-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .lang-btn { flex: 1; font-size: 12px; padding: 5px; background: #222; color: #777; border: 1px solid #444; }
        .lang-btn.active { background: var(--royal-blue); color: var(--gold); border-color: var(--gold); font-weight: bold; }

        /* MODE SWITCHER */
        .mode-switch { display: flex; background: #000; border: 1px solid #444; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: #222; color: #666; font-size: 12px; }
        .mode-btn.active { background: var(--royal-blue); color: var(--gold); font-weight: bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }

        /* READING MODE SWITCHER */
        .read-switch { display:flex; gap:5px; margin-bottom:10px; }
        .read-btn { flex:1; padding:8px; border:1px solid #444; background:#111; color:#888; font-size:12px; }
        .read-btn.active { background:#004d40; color:#fff; border-color:#00e676; font-weight:bold; }

        /* STATUS & SLOTS */
        #statusDisplay {
            background: #000; border: 2px solid var(--green-bright);
            color: var(--green-bright); text-align: center;
            font-family: 'Cinzel', serif !important; font-size: 18px; font-weight: bold;
            padding: 8px; margin-bottom: 10px; border-radius: 4px;
        }

        #slotGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
        .slot-box { 
            background: #222; padding: 10px; text-align: center; font-size: 14px; 
            color: #555; border: 1px solid #333; border-radius: 4px;
        }
        .slot-box.active { 
            background: var(--royal-blue); color: var(--gold); border-color: var(--gold); 
            font-weight: bold; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        /* MAIN PREVIEW AREA */
        .main-view { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #222; position: relative; }
        .mirror-header { background: #111; padding: 5px 15px; color: #666; font-size: 11px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        
        #adminMirror {
            flex: 1; overflow: hidden; position: relative;
            background: radial-gradient(circle, #001a33, #000);
            display: flex; justify-content: center; align-items: center;
        }
        
        .mirror-content { width: 98%; height: 98%; display: flex; gap: 10px; }
        .mirror-info { width: 30%; background: rgba(0,0,0,0.8); border-left: 3px double var(--gold); padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y:auto; }
        
        /* PREVIEW AREA */
        .mirror-img-area { 
            width: 70%; 
            background: var(--cream-bg);
            display: flex; justify-content: center; align-items: flex-start;
            border: 1px solid #333; position: relative; 
            overflow-y: auto;
        }
        .mirror-img-area img {
            width: 100%; height: auto; display: block;
        }

        .mirror-val { color: var(--gold); font-size: 16px; font-weight: bold; }
        
        #gridPreview { display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 60%; }
        .gp-box { background: #111; border: 1px solid #444; color: #666; text-align: center; padding: 10px; font-size: 12px; }
        .gp-box.taken { background: #330000; color: #555; border-color: #500; }
        .gp-box.selected { background: var(--gold); color: #000; border-color: #fff; font-weight:bold; }

        .hidden { display: none !important; }

        /* SECURITY */
        #securityOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .sec-box { border: 2px solid var(--gold); padding: 40px; text-align: center; background: #000d1a; border-radius: 10px; width: 400px; }

        /* ROYAL FULLSCREEN BUTTON */
        #royalFSBtn {
            position: absolute; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--gold), #8a6e15);
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(212,175,55, 0.6);
            cursor: pointer; z-index: 200;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #000; transition: all 0.3s;
        }
        #royalFSBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }

    </style>
</head>
<body oncontextmenu="return false;">

    <audio id="bellStart" src="start.mp3"></audio>
    <audio id="bellEnd" src="end.mp3"></audio>

    <div id="securityOverlay">
        <div class="sec-box">
            <h1 style="color:var(--gold); font-family:'Cinzel' !important; margin:0;">ROYAL ELITE V19</h1>
            <p style="color:#666; font-size:10px;">ULTIMATE PRO PLUS</p>
            <input type="password" id="secKey" style="text-align:center; font-size:18px; margin:15px 0; padding:10px; border-color:var(--gold);" placeholder="License Key">
            <button class="btn-green" onclick="unlockSystem()">UNLOCK SYSTEM</button>
            <p id="secMsg" style="color:#ff5252; margin-top:10px; font-size:12px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="header">
            <h1 class="app-title" data-translate="title">RASFAHI JUDGE V19.2</h1>
        </div>

        <div class="content">
            <div class="lang-bar">
                <button class="lang-btn active" onclick="setLang('dv')">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</button>
                <button class="lang-btn" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                <button class="lang-btn" onclick="setLang('en')">English</button>
            </div>
            
            <div class="panel panel-live">
                <h2 data-translate="liveCtrl">1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ (Live)</h2>
                
                <div id="statusDisplay">WAITING...</div>
                
                <div class="mode-switch">
                    <button id="modeJudge" class="mode-btn active" onclick="setMode('judge')" data-translate="mJudge">‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)</button>
                    <button id="modeStudent" class="mode-btn" onclick="setMode('student')" data-translate="mStudent">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)</button>
                </div>

                <div class="read-switch">
                    <button id="rmMushaf" class="read-btn active" onclick="setReadingMode('mushaf')" data-translate="rmMushaf">üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)</button>
                    <button id="rmMemory" class="read-btn" onclick="setReadingMode('memory')" data-translate="rmMemory">üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)</button>
                </div>

                <div id="judgeControls">
                    <button class="btn-gold" style="padding:12px;" onclick="pickRandomQuestion()" data-translate="btnPick">üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)</button>
                </div>

                <div id="studentControls" class="hidden">
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-blue" onclick="toggleGridScreen(true)" data-translate="btnShowGrid">1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß (Show Grid)</button>
                        <button class="btn-gold" onclick="reshuffleGrid()" data-translate="btnShuffle">üîÑ ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                    </div>
                    
                    <div id="selectionInfo" style="background:#000; padding:5px; border:1px solid #444; margin:5px 0; font-size:12px; text-align:center; color:var(--gold);">
                        No selection yet.
                    </div>

                    <button id="btnStartReading" class="btn-green hidden" onclick="startReadingSession()" data-translate="btnStartQ1">2. ﬁäﬁ¶ﬁÅﬁß (Start Question 1)</button>
                    <p style="font-size:11px; color:#aaa; text-align:center; margin:2px 0;">Student picks -> Grid Hides -> Judge Starts.</p>
                </div>

                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-gold" style="width:30%;" onclick="prevQuestion()" data-translate="btnPrev">‚óÄ Previous</button>
                    <button class="btn-gold" style="flex:1;" onclick="nextQuestion()" data-translate="btnNext">Next Question ‚è©</button>
                </div>

                <div id="slotGrid"></div>

                <hr style="border-color:#334455; margin:15px 0;">

                <div style="display:flex; gap:10px;">
                    <button class="btn-green" onclick="toggleBell(true)" data-translate="btnBellStart">üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                    <button class="btn-red" onclick="toggleBell(false)" data-translate="btnBellStop">üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)</button>
                </div>

                <button style="margin-top:10px; background:#442222; border:1px solid #aa3333;" onclick="resetStudentSession()" data-translate="btnReset">üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)</button>
            </div>

            <div class="panel">
                <h2 data-translate="screens">2. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞</h2>
                
                <label data-translate="lblStudent">1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:</label>
                <button onclick="openScreen('student')" data-translate="btnLaunchStudent">üñ•Ô∏è Student Screen (Launch)</button>

                <label data-translate="lblJudge">2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ (Multicast):</label>
                <div style="display:flex; gap:5px;">
                    <select id="judgeCount" style="width:40%;">
                        <option value="1">1 Judge</option>
                        <option value="2">2 Judges</option>
                        <option value="3" selected>3 Judges</option>
                        <option value="4">4 Judges</option>
                        <option value="5">5 Judges</option>
                        <option value="10">10 Judges</option>
                    </select>
                    <button onclick="openJudges()" class="btn-blue" data-translate="btnLaunchJudges">Open Judges üöÄ</button>
                </div>
            </div>
            
            <div class="panel hidden">
                 <label style="color:var(--gold);">Validity (Days):</label>
                 <input type="number" id="keyDays" value="30">
                 <button class="btn-green" onclick="generateLicense()">GENERATE KEY</button>
                 <textarea id="outKey" readonly></textarea>
            </div>

            <div class="panel">
                <h2 data-translate="settings">3. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞</h2>
                
                <label data-translate="lblFont">1. ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ (TTF) [Faruuma]:</label>
                <input type="file" id="fontF" accept=".ttf, .otf">

                <label data-translate="lblCSV">2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):</label>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="csvQ" accept=".csv">
                    <button onclick="downloadSampleCSV()" class="btn-purple" style="width:40%; font-size:10px;">Sample CSV ‚¨áÔ∏è</button>
                </div>
                
                <label data-translate="lblImg">3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ (Folder):</label>
                <input type="file" id="imgF" webkitdirectory directory multiple>
                <small id="imgStatus" style="color:#aaa; display:block;">No images loaded</small>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <div>
                        <label data-translate="lblBorder">ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:</label>
                        <select id="borderStyle" onchange="syncWindows()">
                            <option value="gold">Royal Gold</option>
                            <option value="silver">Silver</option>
                            <option value="pattern">Pattern</option>
                            <option value="custom">Custom Img</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div>
                        <label data-translate="lblQCount">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:</label>
                        <select id="qLimit" onchange="resetStudentSession()">
                            <script>
                                for(let i=1; i<=20; i++) document.write(`<option value="${i}" ${i===3?'selected':''}>${i}</option>`);
                            </script>
                        </select>
                    </div>
                </div>
                <input type="file" id="borderImg" accept="image/*" class="hidden" style="margin-top:5px;">
            </div>
        </div>
    </div>

    <div class="main-view">
        <div class="mirror-header">
            <span>LIVE VIEW (ADMIN MONITOR)</span>
            <span id="mirrorStatus" style="color:var(--gold);">IDLE</span>
        </div>
        
        <div id="adminMirror">
            <div id="gridPreview"></div>

            <div class="mirror-content" id="mirrorContainer" style="opacity:1;">
                <div class="mirror-info">
                    <span class="mirror-val" data-translate="qDetail">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ∞</span>
                    <div><span style="color:#666; font-size:12px;" data-translate="mBook">ﬁäﬁÆﬁåﬁ∞ / ﬁÑﬁ¶ﬁáﬁ®:</span> <span id="mBook" class="mirror-val">-</span></div>
                    <div><span style="color:#666; font-size:12px;" data-translate="mSurah">ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞:</span> <span id="mSurah" class="mirror-val">-</span></div>
                    <div><span style="color:#666; font-size:12px;" data-translate="mAyah">ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:</span> <span id="mAyah" class="mirror-val">-</span></div>
                    <div id="adminWarn" style="color:#ff5252; font-size:11px; margin-top:10px; display:none;">‚ö†Ô∏è STUDENT IS IN MEMORY MODE</div>
                </div>
                <div class="mirror-img-area">
                    <img id="mImg" src="" style="display:none;">
                    <h2 id="mReadyText" style="display:none; color:#00e676; text-align:center; width:100%;">READY TO START</h2>
                    <h1 id="mFinishText" style="display:none; color:#ff5252; text-align:center; width:100%; font-size:30px;">ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁâﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁßﬁéﬁ¨<br>ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁáﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ¨ﬁáﬁ∞ ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ©</h1>
                </div>
            </div>
            
            <div id="mirrorLight" style="position:absolute; bottom:20px; right:100px; width:30px; height:30px; background:#333; border-radius:50%; border:2px solid #555;"></div>

            <button id="royalFSBtn" onclick="toggleAppFullscreen()" title="Full Screen">‚õ∂</button>
        </div>
    </div>

<script>
    // --- TRANSLATION DICTIONARY ---
    const i18n = {
        title: { dv: "ﬁÉﬁ¶ﬁêﬁ∞ﬁäﬁ¶ﬁÄﬁ® ﬁñﬁ¶ﬁñﬁ∞ V19.2", ar: "ÿßŸÑŸÇÿßÿ∂Ÿä ÿ±ÿµŸÅŸáŸä V19.2", en: "Rasfahi Judge V19.2" },
        liveCtrl: { dv: "1. ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞", ar: "1. ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±", en: "1. Live Control" },
        mJudge: { dv: "‚öñÔ∏è ﬁñﬁ¶ﬁñﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁáﬁÆﬁìﬁØ)", ar: "‚öñÔ∏è Ÿàÿ∂ÿπ ÿßŸÑŸÇÿßÿ∂Ÿä (ÿ™ŸÑŸÇÿßÿ¶Ÿä)", en: "‚öñÔ∏è Judge Mode (Auto)" },
        mStudent: { dv: "üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁâﬁ¨ﬁåﬁ¶ﬁëﬁ∞ (ﬁâﬁ¨ﬁÇﬁ™ﬁáﬁ¶ﬁçﬁ∞)", ar: "üéì Ÿàÿ∂ÿπ ÿßŸÑÿ∑ÿßŸÑÿ® (ŸäÿØŸàŸä)", en: "üéì Student Mode (Manual)" },
        rmMushaf: { dv: "üìñ ﬁâﬁ™ﬁûﬁ∞ﬁôﬁ¶ﬁäﬁ™ (ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ﬁÇﬁ∞)", ar: "üìñ ÿßŸÑŸÖÿµÿ≠ŸÅ (ŸÜÿ∏ÿ±)", en: "üìñ Mushaf (Reading)" },
        rmMemory: { dv: "üß† ﬁÄﬁ®ﬁåﬁ™ﬁÇﬁ∞ (ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ®)", ar: "üß† ÿßŸÑÿ≠ŸÅÿ∏ (ÿ∫Ÿäÿ®)", en: "üß† Memory (Recital)" },
        btnPick: { dv: "üé≤ ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁéﬁß (ﬁÉﬁ¨ﬁÇﬁ∞ﬁëﬁ¶ﬁâﬁ∞)", ar: "üé≤ ÿßÿÆÿ™ÿ± ÿ≥ÿ§ÿßŸÑÿßŸã (ÿπÿ¥Ÿàÿßÿ¶Ÿä)", en: "üé≤ Pick Question (Random)" },
        btnShowGrid: { dv: "1. ﬁéﬁ∞ﬁÉﬁ®ﬁëﬁ∞ ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß", ar: "1. ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿ®ŸÉÿ©", en: "1. Show Grid" },
        btnShuffle: { dv: "üîÑ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠", ar: "üîÑ ÿÆŸÑÿ∑", en: "üîÑ Shuffle" },
        btnStartQ1: { dv: "2. ﬁäﬁ¶ﬁÅﬁß (Start Q1)", ar: "2. ÿßÿ®ÿØÿ£ (ÿ≥ÿ§ÿßŸÑ 1)", en: "2. Start (Q1)" },
        btnPrev: { dv: "‚óÄ ﬁÜﬁ™ﬁÉﬁ©ﬁéﬁ¨", ar: "‚óÄ ÿßŸÑÿ≥ÿßÿ®ŸÇ", en: "‚óÄ Prev" },
        btnNext: { dv: "ﬁÜﬁ™ﬁÉﬁ®ﬁáﬁ¶ﬁÅﬁ∞ ‚è©", ar: "ÿßŸÑÿ™ÿßŸÑŸä ‚è©", en: "Next ‚è©" },
        btnBellStart: { dv: "üîî ﬁäﬁ¶ﬁÅﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üîî ÿßÿ®ÿØÿ£ (ÿ¨ÿ±ÿ≥)", en: "üîî Start (Bell)" },
        btnBellStop: { dv: "üõë ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁß (ﬁÑﬁ¨ﬁçﬁ∞)", ar: "üõë ÿ™ŸàŸÇŸÅ (ÿ¨ÿ±ÿ≥)", en: "üõë Stop (Bell)" },
        btnReset: { dv: "üîÑ ﬁáﬁ¶ﬁáﬁ™ ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ (Reset)", ar: "üîÑ ÿ∑ÿßŸÑÿ® ÿ¨ÿØŸäÿØ (ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ)", en: "üîÑ New Student (Reset)" },
        screens: { dv: "2. ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞", ar: "2. ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™", en: "2. Screens" },
        lblStudent: { dv: "1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "1. ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:", en: "1. Student Screen:" },
        btnLaunchStudent: { dv: "üñ•Ô∏è ﬁçﬁØﬁÇﬁ∞ﬁóﬁ∞ (Student)", ar: "üñ•Ô∏è ŸÅÿ™ÿ≠ (ÿßŸÑÿ∑ÿßŸÑÿ®)", en: "üñ•Ô∏è Launch (Student)" },
        lblJudge: { dv: "2. ﬁñﬁ¶ﬁñﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞:", ar: "2. ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇÿßÿ∂Ÿä:", en: "2. Judge Screen:" },
        btnLaunchJudges: { dv: "Open Judges üöÄ", ar: "ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ∂ÿßÿ© üöÄ", en: "Open Judges üöÄ" },
        settings: { dv: "3. ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁêﬁ∞ & ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞", ar: "3. ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™", en: "3. Settings & Files" },
        lblFont: { dv: "1. ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ (TTF):", ar: "1. ÿßŸÑÿÆÿ∑ (TTF):", en: "1. Font (TTF):" },
        lblCSV: { dv: "2. ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁëﬁ≠ﬁìﬁß (CSV):", ar: "2. ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (CSV):", en: "2. Question Data (CSV):" },
        lblImg: { dv: "3. ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁäﬁÆﬁìﬁØ:", ar: "3. ÿµŸàÿ± ÿßŸÑÿ¢Ÿäÿßÿ™:", en: "3. Ayah Images:" },
        lblBorder: { dv: "ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™:", ar: "ÿßŸÑÿ•ÿ∑ÿßÿ±:", en: "Border:" },
        lblQCount: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ﬁéﬁ¨ ﬁ¢ﬁ¶ﬁãﬁ¶ﬁãﬁ™:", ar: "ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©:", en: "Question Count:" },
        qDetail: { dv: "ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁåﬁ¶ﬁäﬁ∞ﬁûﬁ©ﬁçﬁ∞", ar: "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≥ÿ§ÿßŸÑ", en: "Question Details" },
        mBook: { dv: "ﬁäﬁÆﬁåﬁ∞ / ﬁÑﬁ¶ﬁáﬁ®:", ar: "ÿßŸÑŸÉÿ™ÿßÿ® / ÿßŸÑÿ¨ÿ≤ÿ°:", en: "Book/Part:" },
        mSurah: { dv: "ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞:", ar: "ÿ≥Ÿàÿ±ÿ©:", en: "Surah:" },
        mAyah: { dv: "ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:", ar: "ÿ¢Ÿäÿ©:", en: "Ayah:" }
    };

    let currentLang = 'dv';

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'en') ? 'ltr' : 'rtl';
        document.querySelector('.sidebar').style.borderLeft = (lang === 'en') ? 'none' : '3px solid var(--gold)';
        document.querySelector('.sidebar').style.borderRight = (lang === 'en') ? '3px solid var(--gold)' : 'none';

        // Apply translations
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if(i18n[key] && i18n[key][lang]) {
                el.innerText = i18n[key][lang];
            }
        });
    }

    // --- FULLSCREEN LOGIC ---
    function toggleAppFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- SECURITY PROTOCOLS ---
    document.addEventListener('keydown', function(e) {
        if(e.keyCode == 123) { e.preventDefault(); return false; } // F12
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { e.preventDefault(); return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { e.preventDefault(); return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { e.preventDefault(); return false; }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; }
    });

    // --- STATE ---
    let state = {
        qPool: [], qUsed: [], qDataMap: {}, 
        pImages: {}, 
        fontData: null, borderData: null,
        windows: { student: null, judges: [] },
        session: { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false },
        mode: 'judge', readingMode: 'mushaf',
        grid: { map: {}, visible: false, taken: [] } 
    };

    // --- SYSTEM ---
    function unlockSystem() {
        const key = document.getElementById('secKey').value;
        if(key === "1234" || key.length > 5) {
            document.getElementById('securityOverlay').classList.add('hidden');
            renderSlots();
        }
    }

    function generateLicense() {
        const days = parseInt(document.getElementById('keyDays').value);
        const date = new Date();
        date.setDate(date.getDate() + days);
        const str = "ROYAL_EXP_" + date.toISOString().split('T')[0];
        document.getElementById('outKey').value = btoa(str);
    }

    // --- LOGIC ---
    function setMode(mode) {
        state.mode = mode;
        document.getElementById('modeJudge').classList.toggle('active', mode === 'judge');
        document.getElementById('modeStudent').classList.toggle('active', mode === 'student');
        document.getElementById('judgeControls').classList.toggle('hidden', mode !== 'judge');
        document.getElementById('studentControls').classList.toggle('hidden', mode !== 'student');
        if(mode === 'student') reshuffleGrid();
        else { state.grid.visible = false; syncWindows(); }
    }

    function setReadingMode(rm) {
        state.readingMode = rm;
        document.getElementById('rmMushaf').classList.toggle('active', rm === 'mushaf');
        document.getElementById('rmMemory').classList.toggle('active', rm === 'memory');
        updateMirror(); syncWindows();
    }

    function downloadSampleCSV() {
        const csvContent = "data:text/csv;charset=utf-8,ID,Image,Book,Surah,Page,StartAyah,EndAyah\n1,1.png,Juz 1,Al-Fatiha,1,1,7\n2,002.png,Juz 1,Al-Baqarah,2,1,5";
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "sample_questions.csv");
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function resolveImage(rawName) {
        if(!rawName) return null;
        rawName = rawName.toString().toLowerCase().trim();
        if(state.pImages[rawName]) return state.pImages[rawName];
        if(state.pImages[rawName + '.png']) return state.pImages[rawName + '.png'];
        if(state.pImages[rawName.padStart(3, '0') + '.png']) return state.pImages[rawName.padStart(3, '0') + '.png'];
        const intVal = parseInt(rawName);
        if(!isNaN(intVal) && state.pImages[intVal]) return state.pImages[intVal];
        return null;
    }

    function rebindAllImages() {
        Object.values(state.qDataMap).forEach(q => { q.src = resolveImage(q.imgRaw); });
        syncWindows();
    }

    // --- HANDLERS ---
    document.getElementById('imgF').onchange = e => {
        let count = 0; state.pImages = {}; 
        for(let f of e.target.files) {
            if(f.type.startsWith('image/')) {
                const url = URL.createObjectURL(f);
                const name = f.name.toLowerCase();
                state.pImages[name] = url; 
                state.pImages[name.split('.')[0]] = url; 
                const intVal = parseInt(name.split('.')[0]); 
                if(!isNaN(intVal)) state.pImages[intVal] = url; 
                count++;
            }
        }
        document.getElementById('imgStatus').innerText = count + " images loaded ready.";
        rebindAllImages();
    };

    document.getElementById('csvQ').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const rows = ev.target.result.split('\n');
            state.qPool = []; state.qUsed = [];
            rows.slice(1).forEach(r => {
                const c = r.split(',');
                if(c.length < 2) return;
                const id = c[0].trim();
                const imgRaw = c[1] ? c[1].trim() : "";
                state.qDataMap[id] = { 
                    id: id, imgRaw: imgRaw, src: null,      
                    book: c[2], surah: c[3], page: c[4], start: c[5], end: c[6] 
                };
                state.qPool.push(id);
            });
            rebindAllImages();
            alert("Questions Loaded: " + state.qPool.length);
        };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('fontF').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { 
            state.fontData = ev.target.result;
            const newStyle = document.createElement('style');
            newStyle.textContent = `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); } 
                body, button, input, select, textarea { font-family: 'AppFont', 'Noto Sans Thaana', sans-serif !important; }`;
            document.head.appendChild(newStyle);
            syncWindows(); 
        };
        r.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('borderStyle').onchange = function() {
        document.getElementById('borderImg').classList.toggle('hidden', this.value !== 'custom');
        syncWindows();
    };
    document.getElementById('borderImg').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { state.borderData = ev.target.result; syncWindows(); };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- GRID ---
    window.handleGridClick = function(boxID) {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.selectionIDs.length >= limit) return;

        const qID = state.grid.map[boxID];
        if(!qID || state.grid.taken.includes(boxID)) return;

        state.grid.taken.push(boxID);
        state.session.selectionIDs.push(qID);

        const idx = state.qPool.indexOf(qID);
        if(idx > -1) state.qPool.splice(idx, 1);
        state.qUsed.push(qID);

        updateSelectionUI();

        if(state.session.selectionIDs.length === limit) {
            state.grid.visible = false;
            state.session.phase = 'ready';
            prepareSlotsFromSelection();
            document.getElementById('btnStartReading').classList.remove('hidden');
        } else {
            state.session.phase = 'selection';
        }
        renderSlots(); updateGridPreview(); syncWindows();
    }

    function updateSelectionUI() {
        document.getElementById('selectionInfo').innerText = "Selected: " + state.session.selectionIDs.join(", ");
    }

    function prepareSlotsFromSelection() {
        state.session.slots = state.session.selectionIDs.map(id => {
            let q = state.qDataMap[id];
            if(!q.src) q.src = resolveImage(q.imgRaw);
            return q;
        });
        state.session.activeIndex = -1;
        updateStatus();
    }

    window.startReadingSession = function() {
        if(state.session.slots.length === 0) return;
        state.session.activeIndex = 0;
        state.session.phase = 'active';
        document.getElementById('btnStartReading').classList.add('hidden');
        updateStatus(); updateMirror(); syncWindows();
    }

    window.pickRandomQuestion = function() {
        const limit = parseInt(document.getElementById('qLimit').value);
        if(state.session.slots.length >= limit) return;
        
        const q = getRandomQ();
        if(!q) return;

        state.session.slots.push(q);
        state.session.activeIndex = state.session.slots.length - 1;
        state.session.phase = 'active';
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    };

    function getRandomQ() {
        if(state.qPool.length === 0) {
             if(state.qUsed.length === 0) { alert("No Data Loaded!"); return null; }
             state.qPool = [...state.qUsed]; state.qUsed = [];
             alert("Reshuffling Database...");
        }
        const rIdx = Math.floor(Math.random() * state.qPool.length);
        const qID = state.qPool[rIdx];
        state.qPool.splice(rIdx, 1);
        state.qUsed.push(qID);
        
        const qData = state.qDataMap[qID];
        if(!qData.src) qData.src = resolveImage(qData.imgRaw);
        return qData;
    }

    window.reshuffleGrid = function() {
        if(state.qPool.length === 0 && state.qUsed.length === 0) return;
        state.grid.map = {}; state.grid.taken = [];
        let tempPool = [...state.qPool];
        if(tempPool.length < 20 && state.qUsed.length > 0) tempPool = [...tempPool, ...state.qUsed];
        for(let i=1; i<=20; i++) {
            if(tempPool.length === 0) break;
            const rIdx = Math.floor(Math.random() * tempPool.length);
            state.grid.map[i] = tempPool[rIdx];
            tempPool.splice(rIdx, 1);
        }
        updateGridPreview(); syncWindows();
    }

    window.toggleGridScreen = function(show) {
        state.grid.visible = show;
        state.session.phase = 'selection';
        syncWindows(); updateGridPreview();
    }

    // --- NAVIGATION SAFEGUARDS & FEATURES ---
    
    // BACK BUTTON
    window.prevQuestion = function() {
        if(state.session.phase === 'finished') {
            state.session.phase = 'active';
            state.session.activeIndex = state.session.slots.length - 1;
        } else if (state.session.activeIndex > 0) {
            state.session.activeIndex--;
        } else {
            return; 
        }
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    // NEXT BUTTON
    window.nextQuestion = function() {
        if(state.session.phase === 'ready') {
            startReadingSession(); return;
        }

        if(state.session.phase === 'finished') return; 

        const nextIdx = state.session.activeIndex + 1;
        
        if(nextIdx >= state.session.slots.length) {
            state.session.phase = 'finished';
        } else {
            state.session.activeIndex = nextIdx;
        }
        
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    window.resetStudentSession = function() {
        state.session = { slots: [], selectionIDs: [], activeIndex: -1, phase: 'idle', light: false };
        state.grid.taken = []; state.grid.visible = false;
        document.getElementById('btnStartReading').classList.add('hidden');
        document.getElementById('selectionInfo').innerText = "No selection yet.";
        
        if(state.mode === 'student') reshuffleGrid();
        toggleBell(false);
        updateStatus(); renderSlots(); updateMirror(); syncWindows();
    }

    function toggleBell(on) {
        const bs = document.getElementById('bellStart');
        const be = document.getElementById('bellEnd');
        if(on) { bs.currentTime=0; bs.play().catch(()=>{}); }
        else { be.currentTime=0; be.play().catch(()=>{}); }
        state.session.light = on;
        updateMirror(); syncWindows();
    }

    // --- UI RENDER ---
    function renderSlots() {
        const limit = parseInt(document.getElementById('qLimit').value);
        const g = document.getElementById('slotGrid');
        g.style.gridTemplateColumns = `repeat(${limit}, 1fr)`;
        g.innerHTML = '';
        
        const source = (state.session.phase === 'selection' || state.session.phase === 'ready') 
                        ? state.session.selectionIDs 
                        : state.session.slots;

        for(let i=0; i<limit; i++) {
            let d = document.createElement('div');
            let content = `Slot ${i+1}`;
            if(source[i]) { content = source[i].id ? `Q: ${source[i].id}` : `Q: ${source[i]}`; }
            d.className = 'slot-box ' + (i === state.session.activeIndex ? 'active' : '');
            d.innerText = content;
            g.appendChild(d);
        }
    }

    function updateStatus() {
        const s = document.getElementById('statusDisplay');
        if(state.session.phase === 'idle') { s.innerText = "WAITING..."; s.style.color="#777"; }
        else if(state.session.phase === 'selection') { s.innerText = "SELECTING..."; s.style.color="#D4AF37"; }
        else if(state.session.phase === 'ready') { s.innerText = "READY"; s.style.color="#00e676"; }
        else if(state.session.phase === 'finished') { s.innerText = "FINISHED"; s.style.color="#ff5252"; }
        else { s.innerText = `Q-${state.session.slots[state.session.activeIndex]?.id || "?"}`; s.style.color = "#00e676"; }
    }

    function updateMirror() {
        const gp = document.getElementById('gridPreview');
        const mImg = document.getElementById('mImg');
        const mReady = document.getElementById('mReadyText');
        const mFin = document.getElementById('mFinishText');
        const wWarn = document.getElementById('adminWarn');
        
        document.getElementById('mirrorLight').style.background = state.session.light ? '#00e676' : '#333';

        if(state.grid.visible) {
            document.getElementById('mirrorContainer').style.display = 'none'; 
            gp.style.display = 'grid';
            updateGridPreview();
            return;
        } 
        
        gp.style.display = 'none'; 
        document.getElementById('mirrorContainer').style.display = 'flex';
        
        // Hide All
        mImg.style.display = 'none';
        mReady.style.display = 'none'; mFin.style.display = 'none'; wWarn.style.display = 'none';

        if(state.session.phase === 'ready') {
             mReady.style.display = 'block';
             document.getElementById('mirrorStatus').innerText = "WAITING";
             return;
        }

        if(state.session.phase === 'finished') {
            mFin.style.display = 'block';
            document.getElementById('mirrorStatus').innerText = "FINISHED";
            return;
        }

        const q = state.session.slots[state.session.activeIndex];

        if(q && state.session.phase === 'active') {
            document.getElementById('mBook').innerText = q.book;
            document.getElementById('mSurah').innerText = q.surah;
            document.getElementById('mAyah').innerText = q.start + '-' + q.end;
            
            // ADMIN ALWAYS SEES IMAGE
            if(q.src) { mImg.src = q.src; mImg.style.display = 'block'; }

            if(state.readingMode === 'memory') {
                wWarn.style.display = 'block'; // Warn admin that student is in memory mode
            }
            
            document.getElementById('mirrorStatus').innerText = "LIVE READING";
        } else {
            document.getElementById('mirrorStatus').innerText = "IDLE";
        }
    }

    function updateGridPreview() {
        const gp = document.getElementById('gridPreview');
        gp.innerHTML = '';
        for(let i=1; i<=20; i++) {
            let b = document.createElement('div');
            let isSelected = state.session.selectionIDs.includes(state.grid.map[i]);
            b.className = 'gp-box ' + (state.grid.taken.includes(i) ? 'taken' : '') + (isSelected ? ' selected' : '');
            b.innerText = i;
            gp.appendChild(b);
        }
    }

    // --- TEMPLATE ---
    function getTemplate() {
        const fontFace = state.fontData ? `@font-face { font-family: 'AppFont'; src: url('${state.fontData}'); }` : '';
        // FIX: Force Important to Ensure Child Window gets Font
        const fontFam = state.fontData ? 'AppFont, sans-serif !important' : "'Noto Sans Thaana', sans-serif !important";
        const bStyle = document.getElementById('borderStyle').value;
        let borderCSS = "border: 5px solid #333;"; 
        if(bStyle === 'gold') borderCSS = "border: 10px double #D4AF37; box-shadow: 0 0 30px rgba(212,175,55,0.5);";
        else if(bStyle === 'pattern') borderCSS = "border: 15px solid transparent; border-image: linear-gradient(to right, #D4AF37, #000, #D4AF37) 1;";
        else if(bStyle === 'custom' && state.borderData) borderCSS = `border: 20px solid transparent; border-image: url('${state.borderData}') 30 stretch;`;

        return `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                ${fontFace}
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                
                /* FIX 1: GLOBAL FONT FORCE */
                * { font-family: ${fontFam}; }

                body { margin:0; height:100vh; overflow:hidden; color:#fff; display:flex; background:#000; }
                
                #idleScreen { display:flex; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, #001a33, #000); }
                
                #gridScreen { display:none; width:100%; height:100%; align-items:center; justify-content:center; flex-direction:column; background:#050505; }
                #gridContainer { display:grid; grid-template-columns:repeat(5, 1fr); gap:20px; width:80%; }
                .grid-btn { 
                    aspect-ratio: 1; background: linear-gradient(135deg, #D4AF37, #8a6e15); border: 2px solid #fff; border-radius: 10px;
                    color: #000; font-size: 3vw; font-weight: bold; cursor: pointer; transition: 0.3s; display:flex; justify-content:center; align-items:center;
                    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
                }
                .grid-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
                .grid-btn.taken { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

                /* WAIT SCREEN */
                #waitScreen { display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center; background:#000; }
                
                /* FINISH SCREEN */
                #finishScreen { display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, #000d1a, #000); position:absolute; top:0; left:0; z-index:999; }

                #readScreen { display:none; width:100%; height:100%; flex-direction:column; }
                
                #topBar { 
                    height: 10%; width: 100%; 
                    background: linear-gradient(to bottom, #001a33, #000d1a); 
                    border-bottom: 2px solid #D4AF37;
                    display: flex; align-items: center; justify-content: center;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.8); z-index: 10;
                }
                #topStatusText { 
                    color: #D4AF37; font-size: 2.5em; font-weight: bold; 
                    text-shadow: 0 2px 10px rgba(0,0,0,1); letter-spacing: 1px;
                }

                #contentArea { display: flex; height: 90%; width: 100%; }

                #infoPanel { 
                    width: 25%; background: linear-gradient(180deg, #050505, #000); 
                    border-left: 4px solid #D4AF37; display: flex; flex-direction: column; 
                    box-shadow: -10px 0 30px rgba(0,0,0,0.8);
                }
                .current-details { padding: 20px; border-bottom: 1px solid #333; height: 40%; display:flex; flex-direction:column; justify-content:center; }
                .val { color: #fff; font-size: 2em; font-weight:bold; margin-bottom: 10px; display:block; line-height:1.2; }
                .lbl { color: #00e676; font-size: 1em; text-transform:uppercase; margin-bottom: 2px; display:block;}

                .questions-list { flex: 1; overflow-y: auto; padding: 15px; background: rgba(255,255,255,0.02); }
                .q-item { 
                    padding: 15px; margin-bottom: 10px; border-radius: 8px; 
                    border: 1px solid #333; background: #111; color: #888;
                    transition: 0.3s; display: flex; flex-direction: column;
                }
                .q-item.active { 
                    border-color: #D4AF37; background: linear-gradient(90deg, #222, #000); 
                    color: #fff; box-shadow: 0 0 10px rgba(212,175,55,0.2); transform: scale(1.02);
                }
                .q-item-num { font-size: 0.9em; color: #00e676; margin-bottom: 5px; font-weight:bold; }
                .q-item-detail { font-size: 1.1em; font-weight: bold; color:#fff; }
                .q-item-sub { font-size: 0.8em; color: #888; margin-top:3px; }
                
                #mainArea { width: 75%; display: flex; justify-content: center; align-items: center; background: #000; position: relative; transition: background 0.5s; }
                
                /* ROYAL GREEN BACKGROUND CLASS */
                .royal-green-bg { background: radial-gradient(circle, #00331a, #001a0d) !important; }

                .scroll-wrap { width: 90%; height: 90%; background: #fff; overflow-y: auto; ${borderCSS} display:block; }
                
                .scroll-wrap img { width: 100%; height: auto; display: block; }

                #memoryText { display:none; color: #D4AF37; font-size: 4vw; text-shadow: 0 0 20px #D4AF37; text-align:center; padding:20px; margin-top: 20%; }

                #greenLight { position:fixed; bottom:30px; left:30px; width:80px; height:80px; border-radius:50%; background:#222; border:4px solid #444; transition:0.3s; z-index: 100; }
                #greenLight.on { background:#00e676; border-color:#fff; box-shadow:0 0 80px #00e676; }

                /* FULLSCREEN OVERLAY */
                #fsOverlay {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.85); z-index: 9999;
                    display: flex; justify-content: center; align-items: center; cursor: pointer;
                }
                .fs-btn {
                    padding: 20px 40px; border: 3px solid #D4AF37;
                    color: #D4AF37; font-size: 2em; font-weight: bold;
                    background: rgba(0,0,0,0.8); border-radius: 10px;
                    box-shadow: 0 0 30px rgba(212,175,55,0.5);
                    transition: 0.2s;
                }
                .fs-btn:hover { background: #D4AF37; color: #000; }
            </style>
        </head>
        <body oncontextmenu="return false;">
            <div id="fsOverlay" onclick="goFullscreen()">
                <div class="fs-btn">CLICK TO FULLSCREEN</div>
            </div>

            <div id="idleScreen">
                <h1 style="font-size:5vw; color:#D4AF37; text-shadow:0 0 20px #D4AF37;">RASFAHI</h1>
            </div>

            <div id="gridScreen">
                <h1 style="color:#D4AF37; margin-bottom:20px;">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ ﬁÇﬁ¶ﬁÇﬁ∞ﬁÑﬁ¶ﬁÉﬁ™ ﬁÇﬁ¶ﬁéﬁß</h1>
                <div id="gridContainer"></div>
            </div>

            <div id="waitScreen">
                <h1 style="color:#00e676; font-size:3vw;">SELECTION COMPLETE</h1>
                <h2 style="color:#fff;">Waiting for Judge to Start...</h2>
                <div id="waitList" style="color:#D4AF37; margin-top:20px; font-size:2vw;"></div>
            </div>

            <div id="finishScreen">
                <h1 style="color:#D4AF37; font-size:4vw; text-shadow:0 0 30px #D4AF37; text-align:center; line-height:1.5;">ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁâﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁàﬁ¨ﬁÉﬁ®ﬁîﬁßﬁéﬁ¨<br>ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁ¶ﬁáﬁ® ﬁêﬁ™ﬁàﬁßﬁçﬁ¨ﬁáﬁ∞ ﬁÇﬁ®ﬁâﬁ™ﬁÇﬁ©</h1>
            </div>

            <div id="readScreen">
                <div id="topBar"><div id="topStatusText"></div></div>
                <div id="contentArea">
                    <div id="infoPanel">
                        <div class="current-details">
                            <span class="lbl">ﬁêﬁ´ﬁÉﬁ¶ﬁåﬁ∞:</span><span class="val" id="dSurah"></span>
                            <span class="lbl">ﬁáﬁßﬁîﬁ¶ﬁåﬁ∞:</span><span class="val" id="dAyah"></span>
                        </div>
                        <div class="questions-list" id="qListContainer"></div>
                    </div>
                    <div id="mainArea">
                        <div class="scroll-wrap" id="mainScroll">
                            <img id="qImg" src="" style="width:100%;">
                            <h1 id="memoryText">(ﬁÇﬁ™ﬁÑﬁ¶ﬁçﬁ¶ﬁáﬁ® ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁâﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÜﬁ®ﬁîﬁ¨ﬁàﬁ™ﬁÇﬁ∞)</h1>
                        </div>
                    </div>
                </div>
            </div>

            <div id="greenLight"></div>

            <script>
                function goFullscreen() {
                    document.documentElement.requestFullscreen();
                    document.getElementById('fsOverlay').style.display = 'none';
                }

                // CHILD SECURITY
                document.addEventListener('keydown', function(e) {
                    if(e.keyCode == 123) { e.preventDefault(); return false; } 
                    if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { e.preventDefault(); return false; }
                    if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; }
                });

                window.updateState = function(d) {
                    const isJudge = window.isJudge === true; // Set by parent
                    
                    const idle = document.getElementById('idleScreen');
                    const grid = document.getElementById('gridScreen');
                    const wait = document.getElementById('waitScreen');
                    const read = document.getElementById('readScreen');
                    const finish = document.getElementById('finishScreen');
                    const light = document.getElementById('greenLight');
                    const mainArea = document.getElementById('mainArea');
                    const mainScroll = document.getElementById('mainScroll');

                    // Reset all
                    idle.style.display = 'none'; grid.style.display = 'none'; 
                    wait.style.display = 'none'; read.style.display = 'none';
                    finish.style.display = 'none';
                    
                    // Reset Background
                    mainArea.classList.remove('royal-green-bg');
                    mainScroll.style.background = '#fff';

                    if(d.grid.visible) {
                        grid.style.display = 'flex';
                        const gc = document.getElementById('gridContainer');
                        gc.innerHTML = '';
                        for(let i=1; i<=20; i++) {
                            let b = document.createElement('div');
                            b.className = 'grid-btn ' + (d.grid.taken.includes(i) ? 'taken' : '');
                            b.innerText = i;
                            b.setAttribute('onclick', 'window.opener.handleGridClick('+i+')');
                            gc.appendChild(b);
                        }
                    } else if(d.phase === 'ready') {
                        wait.style.display = 'flex';
                        const sl = d.slots.map(s => s.id).join(', ');
                        document.getElementById('waitList').innerText = "Questions: " + sl;
                    } else if(d.phase === 'finished') {
                         finish.style.display = 'flex';
                    } else if(d.phase === 'active') {
                        read.style.display = 'flex';
                        const q = d.slots[d.activeIndex];
                        
                        // Top Text
                        const statusTxt = document.getElementById('topStatusText');
                        const currentNum = d.activeIndex + 1;
                        if(currentNum === 1) statusTxt.innerText = "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™";
                        else if(d.activeIndex === d.slots.length - 1 && d.slots.length > 1) statusTxt.innerText = "ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¨ﬁÇﬁ∞ﬁâﬁ¨ ﬁäﬁ¶ﬁÄﬁ™ ﬁêﬁ™ﬁàﬁßﬁçﬁ™";
                        else statusTxt.innerText = "ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁåﬁ®ﬁîﬁ¶ ﬁÜﬁ®ﬁîﬁ¶ﬁàﬁ¶ﬁÇﬁ© " + currentNum + " ﬁàﬁ¶ﬁÇﬁ¶ ﬁêﬁ™ﬁàﬁßﬁçﬁ™";

                        if(q) {
                            const img = document.getElementById('qImg');
                            const memTxt = document.getElementById('memoryText');
                            
                            // CORE LOGIC: 
                            if(d.readingMode === 'memory' && !isJudge) {
                                img.style.display = 'none';
                                memTxt.style.display = 'block';
                                mainArea.classList.add('royal-green-bg');
                                mainScroll.style.background = 'transparent'; 
                                mainScroll.style.border = 'none';
                                mainScroll.style.boxShadow = 'none';
                            } else {
                                memTxt.style.display = 'none';
                                if(q.src) { img.src = q.src; img.style.display = 'block'; }
                                else { img.style.display = 'none'; }
                                mainScroll.style.background = '#fff';
                            }
                            
                            document.getElementById('dSurah').innerText = q.surah;
                            document.getElementById('dAyah').innerText = q.start + ' - ' + q.end;
                        }

                        // FIX 2: GHOST SLOT REMOVAL
                        const listC = document.getElementById('qListContainer');
                        listC.innerHTML = '';
                        d.slots.forEach((slot, idx) => {
                            // Only append if slot is valid
                            if(!slot) return; 

                            let item = document.createElement('div');
                            item.className = 'q-item ' + (idx === d.activeIndex ? 'active' : '');
                            
                            item.innerHTML = \`
                                <div class="q-item-num">ﬁêﬁ™ﬁàﬁßﬁçﬁ™ \${idx+1}</div>
                                <div class="q-item-detail">\${slot.surah} (\${slot.start}-\${slot.end})</div>
                                <div class="q-item-sub">\${slot.book} | ﬁûﬁ¶ﬁäﬁ∞ﬁôﬁß: \${slot.page}</div>
                            \`;
                            listC.appendChild(item);
                        });
                    } else {
                        idle.style.display = 'flex';
                    }

                    light.className = d.light ? 'on' : '';
                }
            <\/script>
        </body>
        </html>`;
    }

    function openScreen(type) {
        const html = getTemplate();
        if(type === 'student') {
            if(state.windows.student) state.windows.student.close();
            state.windows.student = window.open("", "Student", "width=1280,height=720");
            state.windows.student.document.write(html);
            // MARK AS STUDENT
            state.windows.student.isJudge = false; 
        } else {
            // GENERIC SINGLE JUDGE
            let w = window.open("", "JudgeGeneric", "width=800,height=600");
            w.document.write(html);
            w.isJudge = true;
            state.windows.judges.push(w);
        }
        setTimeout(syncWindows, 500);
    }

    function openJudges() {
        const count = parseInt(document.getElementById('judgeCount').value);
        // Close existing
        state.windows.judges.forEach(w => w.close());
        state.windows.judges = [];
        // Open new with SPECIFIC NAMES (Judge 1, Judge 2...) to prevent overwriting
        for(let i=0; i<count; i++) {
            let w = window.open("", `Judge_${i+1}`, "width=800,height=600");
            w.document.write(getTemplate());
            w.isJudge = true; // MARK AS JUDGE
            state.windows.judges.push(w);
        }
        setTimeout(syncWindows, 500);
    }

    function syncWindows() {
        const packet = {
            slots: state.session.slots, activeIndex: state.session.activeIndex,
            phase: state.session.phase, light: state.session.light,
            grid: state.grid, readingMode: state.readingMode
        };
        const send = w => { if(w && !w.closed && w.updateState) w.updateState(packet); };
        send(state.windows.student);
        state.windows.judges.forEach(w => send(w));
    }
    
    setMode('judge');
    renderSlots();
</script>
</body>
</html>
